<!DOCTYPE html>
<html lang="fr">

<head>
    <!-- Lien vers le manifest -->
    <link rel="manifest" href="/manifest.json">
  
    <!-- iOS meta tags (très important pour iPhone) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Iron">
  
    <!-- Icône pour iOS -->
    <link rel="apple-touch-icon" href="icon-512.png">
  
    <!-- Couleur de la barre d'adresse -->
    <meta name="theme-color" content="#000000">
  
    <!-- Viewport pour mobile -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IronPlate - Votre Coach Personnel en Fitness et Alimentation</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
                /* ==================== VARIABLES ET RESET AVANCÉS ==================== */
        :root {
            --primary: #6366F1;
            --primary-light: #818CF8;
            --primary-dark: #4F46E5;
            --secondary: #F59E0B;
            --secondary-light: #FBBF24;
            --secondary-dark: #D97706;
            --success: #10B981;
            --success-light: #34D399;
            --success-dark: #059669;
            --danger: #EF4444;
            --danger-light: #FCA5A5;
            --danger-dark: #DC2626;
            --warning: #F59E0B;
            --info: #3B82F6;
            --background: linear-gradient(135deg, #F8FAFC 0%, #F1F5F9 100%);
            --card-bg: #FFFFFF;
            --text-primary: #1E293B;
            --text-secondary: #64748B;
            --text-tertiary: #94A3B8;
            --border: #E2E8F0;
            --border-light: rgba(226, 232, 240, 0.7);
            --shadow: 0 8px 25px -8px rgba(0, 0, 0, 0.15);
            --shadow-lg: 0 20px 40px -10px rgba(0, 0, 0, 0.2);
            --shadow-xl: 0 30px 60px -15px rgba(0, 0, 0, 0.3);
            --shadow-2xl: 0 40px 80px -20px rgba(0, 0, 0, 0.4);
            --gradient-primary: linear-gradient(135deg, var(--primary), var(--primary-light));
            --gradient-secondary: linear-gradient(135deg, var(--secondary), var(--secondary-light));
            --gradient-success: linear-gradient(135deg, var(--success), var(--success-light));
            --gradient-success-dark: linear-gradient(135deg, var(--success-dark), var(--success));
            --gradient-premium: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-nutrition: linear-gradient(135deg, var(--success-dark), var(--success));
            --gradient-danger: linear-gradient(135deg, var(--danger), var(--danger-light));
            --radius: 24px;
            --radius-sm: 16px;
            --radius-xs: 12px;
            --transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --transition-fast: all 0.2s ease;
            --font-size-xs: 11px;
            --font-size-sm: 13px;
            --font-size-base: 15px;
            --font-size-lg: 17px;
            --font-size-xl: 20px;
            --font-size-2xl: 24px;
            --font-size-3xl: 28px;
            --font-size-4xl: 32px;
        }

        /* ==================== THÈMES ==================== */
        .dark-mode {
            --background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%);
            --card-bg: #1E293B;
            --text-primary: #F1F5F9;
            --text-secondary: #CBD5E1;
            --text-tertiary: #64748B;
            --border: #334155;
            --border-light: rgba(51, 65, 85, 0.7);
            --shadow: 0 8px 25px -8px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 20px 40px -10px rgba(0, 0, 0, 0.5);
            --shadow-xl: 0 30px 60px -15px rgba(0, 0, 0, 0.6);
            --shadow-2xl: 0 40px 80px -20px rgba(0, 0, 0, 0.7);
            --success-dark: #047857;
        }

        .theme-blue {
            --primary: #3B82F6;
            --primary-light: #60A5FA;
            --primary-dark: #1D4ED8;
            --background: linear-gradient(135deg, #DBEAFE 0%, #EFF6FF 100%);
            --card-bg: #FFFFFF;
            --text-primary: #1E3A8A;
            --text-secondary: #4B5563;
            --border: #BFDBFE;
            --gradient-premium: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%);
        }

        .theme-green {
            --primary: #10B981;
            --primary-light: #34D399;
            --primary-dark: #047857;
            --background: linear-gradient(135deg, #D1FAE5 0%, #ECFDF5 100%);
            --card-bg: #FFFFFF;
            --text-primary: #064E3B;
            --text-secondary: #4B5563;
            --border: #A7F3D0;
            --gradient-premium: linear-gradient(135deg, #10B981 0%, #047857 100%);
        }

        .theme-purple {
            --primary: #8B5CF6;
            --primary-light: #A78BFA;
            --primary-dark: #7C3AED;
            --background: linear-gradient(135deg, #EDE9FE 0%, #F5F3FF 100%);
            --card-bg: #FFFFFF;
            --text-primary: #5B21B6;
            --text-secondary: #4B5563;
            --border: #DDD6FE;
            --gradient-premium: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
        }

        .theme-red {
            --primary: #EF4444;
            --primary-light: #FCA5A5;
            --primary-dark: #DC2626;
            --background: linear-gradient(135deg, #FEE2E2 0%, #FEF2F2 100%);
            --card-bg: #FFFFFF;
            --text-primary: #7F1D1D;
            --text-secondary: #4B5563;
            --border: #FECACA;
            --gradient-premium: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
        }

        .theme-sunset {
            --primary: #F59E0B;
            --primary-light: #FBBF24;
            --primary-dark: #D97706;
            --background: linear-gradient(135deg, #FEF3C7 0%, #FFFBEB 100%);
            --card-bg: #FFFFFF;
            --text-primary: #92400E;
            --text-secondary: #4B5563;
            --border: #FDE68A;
            --gradient-premium: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
        }

        /* Styles pour combiner dark-mode avec d'autres thèmes */
        .dark-mode.theme-blue {
            --background: linear-gradient(135deg, #1E3A8A 0%, #1E40AF 100%);
            --card-bg: #1E40AF;
            --text-primary: #DBEAFE;
            --border: #3B82F6;
        }

        .dark-mode.theme-green {
            --background: linear-gradient(135deg, #064E3B 0%, #047857 100%);
            --card-bg: #047857;
            --text-primary: #D1FAE5;
            --border: #10B981;
        }

        .dark-mode.theme-purple {
            --background: linear-gradient(135deg, #5B21B6 0%, #7C3AED 100%);
            --card-bg: #7C3AED;
            --text-primary: #EDE9FE;
            --border: #8B5CF6;
        }

        .dark-mode.theme-red {
            --background: linear-gradient(135deg, #7F1D1D 0%, #DC2626 100%);
            --card-bg: #DC2626;
            --text-primary: #FEE2E2;
            --border: #EF4444;
        }

        .dark-mode.theme-sunset {
            --background: linear-gradient(135deg, #92400E 0%, #D97706 100%);
            --card-bg: #D97706;
            --text-primary: #FEF3C7;
            --border: #F59E0B;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
            -webkit-tap-highlight-color: transparent;
            font-size: var(--font-size-base);
        }

        body, html {
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            min-height: 100vh;
            transition: var(--transition);
            font-weight: 400;
            position: relative;
            scroll-behavior: smooth;
        }

        /* ==================== ANIMATIONS AVANCÉES ==================== */
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(99, 102, 241, 0.3); }
            50% { box-shadow: 0 0 40px rgba(99, 102, 241, 0.6); }
        }

        @keyframes slideInFromTop {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes slideInFromBottom {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        @keyframes ripple {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(4); opacity: 0; }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

/* ==================== NOUVEAU STYLE ULTRA-COMPACT POUR LES SÉRIES ==================== */
.sets-container-compact {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.set-item-compact {
    background: var(--card-bg);
    padding: 10px 12px;
    border-radius: var(--radius-sm);
    margin-bottom: 0;
    border: 1px solid var(--border);
    transition: var(--transition);
    position: relative;
    overflow: hidden;
    display: grid;
    grid-template-columns: 60px 1fr 1fr auto;
    gap: 8px;
    align-items: center;
    min-height: 60px;
}

.set-item-compact.completed {
    background: var(--success);
    border-color: var(--success);
    color: white;
}

.set-number-compact {
    font-weight: 800;
    color: var(--text-primary);
    font-size: var(--font-size-sm);
    text-align: center;
    min-width: 50px;
}

.set-item-compact.completed .set-number-compact {
    color: white;
}

.set-input-group-compact {
    display: flex;
    flex-direction: column;
    gap: 3px;
}

.input-label-compact {
    font-size: 9px;
    color: var(--text-secondary);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    white-space: nowrap;
}

.set-item-compact.completed .input-label-compact {
    color: rgba(255,255,255,0.9);
}

.number-input-compact {
    background: var(--card-bg);
    color: var(--text-primary);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 8px 6px;
    font-size: var(--font-size-base);
    text-align: center;
    width: 100%;
    font-weight: 700;
    transition: var(--transition);
    height: 36px;
    min-width: 0;
}

.set-item-compact.completed .number-input-compact {
    background: rgba(0,0,0,0.2);
    color: white;
    border: 1px solid rgba(255,255,255,0.3);
}

.set-controls-compact {
    display: flex;
    gap: 5px;
    align-items: center;
    min-width: 100px;
}

.set-action-btn-compact {
    background: var(--card-bg);
    border: 1px solid var(--border);
    color: var(--text-secondary);
    width: 32px;
    height: 32px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: var(--transition);
    font-size: var(--font-size-sm);
    font-weight: bold;
    flex-shrink: 0;
}

.set-action-btn-compact:hover {
    background: var(--primary);
    color: white;
    transform: translateY(-2px);
}

.checkbox-compact {
    width: 20px;
    height: 20px;
    border: 2px solid var(--border);
    border-radius: 4px;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: var(--transition);
    cursor: pointer;
    background: var(--card-bg);
    position: relative;
    overflow: hidden;
    flex-shrink: 0;
}

.checkbox-compact.checked {
    border-color: var(--success);
    background: var(--success);
}

.checkmark-compact {
    color: white;
    font-size: 10px;
    font-weight: bold;
    opacity: 0;
    transition: var(--transition);
}

.checkbox-compact.checked .checkmark-compact {
    opacity: 1;
}

.previous-set-info-compact {
    font-size: 9px;
    color: var(--text-secondary);
    margin-top: 2px;
    font-style: italic;
    grid-column: 1 / -1;
    border-top: 1px dashed var(--border);
    padding-top: 4px;
    margin-top: 4px;
}

.superset-navigation-hint-compact {
    font-size: 9px;
    color: #8B5CF6;
    margin: 5px 0;
    padding: 6px 8px;
    background: rgba(139, 92, 246, 0.1);
    border-radius: 6px;
    border-left: 2px solid #8B5CF6;
    font-weight: 600;
    grid-column: 1 / -1;
}

        /* ==================== NOTIFICATIONS ==================== */
        .temp-notification {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--success);
            color: white;
            padding: 14px 28px;
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-xl);
            z-index: 10000;
            font-weight: 700;
            animation: fadeIn 0.3s ease, slideInFromTop 0.4s ease;
            max-width: 90%;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .temp-notification.hiding {
            animation: fadeOut 0.3s ease;
        }

        .temp-notification.error {
            background-color: var(--danger);
        }

        .temp-notification.warning {
            background-color: var(--warning);
        }

        .temp-notification.info {
            background-color: var(--info);
        }

        /* ==================== CONTAINER PRINCIPAL ==================== */
        .app-container {
            max-width: 414px;
            margin: 0 auto;
            min-height: 100vh;
            background: var(--background);
            position: relative;
            overflow-x: hidden;
            box-shadow: 0 0 80px rgba(0, 0, 0, 0.1);
            padding-bottom: 100px;
            isolation: isolate;
            z-index: 1;
        }

        /* ==================== HEADER ULTRA PREMIUM ==================== */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(40px);
            padding: 18px 20px;
            border-bottom: 1px solid var(--border);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            animation: slideInFromTop 0.6s ease;
            width: 100%;
            max-width: 414px;
            margin: 0 auto;
            border-radius: 0 0 var(--radius) var(--radius);
        }

        .dark-mode .header {
            background: rgba(30, 41, 59, 0.95);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .user-avatar {
            width: 46px;
            height: 46px;
            border-radius: 50%;
            background: var(--gradient-premium);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: var(--font-size-lg);
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .user-avatar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.3), rgba(255,255,255,0));
            opacity: 0;
            transition: var(--transition);
        }

        .user-avatar:hover::before {
            opacity: 1;
        }

        .user-avatar:hover {
            transform: scale(1.1) rotate(5deg);
            animation: glow 2s infinite;
        }

        .app-title {
    font-size: calc(var(--font-size-2xl) * 0.75); /* Réduction de 25% */
    font-weight: 900;
    color: #4F46E5; /* Nouvelle couleur violet */
    letter-spacing: -0.5px;
    text-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .icon-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: var(--font-size-base);
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .icon-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gradient-primary);
            opacity: 0;
            transition: var(--transition);
        }

        .icon-btn:hover::before {
            opacity: 0.1;
        }

        .icon-btn:hover {
            color: var(--primary);
            transform: translateY(-3px) scale(1.05);
            box-shadow: var(--shadow-lg);
        }

        .icon-btn.primary {
            background: var(--gradient-premium);
            color: white;
            border: none;
            animation: float 3s ease-in-out infinite;
        }

        .icon-btn.success {
            background: var(--gradient-success);
            color: white;
            border: none;
        }

        .icon-btn.danger {
            background: var(--gradient-danger);
            color: white;
            border: none;
        }

        /* ==================== CONTENU PRINCIPAL ==================== */
        .main-content {
            padding: 120px 0 80px;
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        .screen {
            display: none;
            animation: fadeIn 0.6s ease;
        }

        .screen.active {
            display: block;
        }

        /* ==================== SECTION TITRES ==================== */
        .section-title {
            font-size: var(--font-size-xl);
            font-weight: 900;
            margin: 0 20px 20px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
        }

        .section-title::after {
            content: '';
            flex: 1;
            height: 3px;
            background: var(--gradient-premium);
            border-radius: 2px;
            margin-left: 10px;
        }

        .section-subtitle {
            font-size: var(--font-size-lg);
            font-weight: 800;
            margin: 0 20px 16px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ==================== CARTES ULTRA PREMIUM ==================== */
        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 20px;
            margin: 0 20px 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-premium);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.6s ease;
        }

        .card:hover::before {
            transform: scaleX(1);
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }

        .card-no-hover {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 20px;
            margin: 0 20px 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        /* ==================== PROFIL UTILISATEUR ==================== */
        .profile-section {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 20px;
            margin: 0 20px 16px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .profile-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gradient-premium);
            opacity: 0.05;
            z-index: 0;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 18px;
            margin-bottom: 18px;
            position: relative;
            z-index: 1;
        }

        .profile-avatar {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            background: var(--gradient-premium);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: var(--font-size-2xl);
            box-shadow: var(--shadow-xl);
            position: relative;
            overflow: hidden;
            animation: float 4s ease-in-out infinite;
        }

        .profile-avatar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.4), rgba(255,255,255,0));
            opacity: 0;
            transition: var(--transition);
        }

        .profile-avatar:hover::before {
            opacity: 1;
        }

        .profile-info h2 {
            font-size: var(--font-size-xl);
            margin-bottom: 5px;
            font-weight: 800;
            background: var(--gradient-premium);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .profile-info p {
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
            font-weight: 600;
        }

        .profile-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
            margin-top: 18px;
            position: relative;
            z-index: 1;
        }

        .stat-item {
            text-align: center;
            padding: 18px;
            background: var(--card-bg);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .stat-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gradient-primary);
            opacity: 0;
            transition: var(--transition);
        }

        .stat-item:hover::before {
            opacity: 0.05;
        }

        .stat-item:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .stat-value {
            font-size: var(--font-size-xl);
            font-weight: 900;
            color: var(--primary);
            margin-bottom: 5px;
            position: relative;
            z-index: 1;
        }

        .stat-label {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            z-index: 1;
        }

        .nutrition-section {
            margin-top: 20px;
            position: relative;
            z-index: 1;
        }

        /* ==================== BOÎTE CALORIES PLUS PETITE POUR NUTRITION ==================== */
        .nutrition-calories-card {
            background: var(--gradient-success-dark);
            color: white;
            padding: 14px;
            border-radius: var(--radius-sm);
            text-align: center;
            margin: 0 20px 16px;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
            animation: pulse 3s ease-in-out infinite;
        }

        .dark-mode .nutrition-calories-card {
            background: var(--gradient-nutrition);
        }

        .nutrition-calories-value {
            font-size: var(--font-size-xl);
            font-weight: 900;
            margin-bottom: 5px;
        }

        .nutrition-calories-label {
            font-size: var(--font-size-sm);
            opacity: 0.9;
            font-weight: 600;
        }

        .macros-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
        }

        .macro-item {
            background: var(--card-bg);
            padding: 18px 10px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            text-align: center;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .macro-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gradient-primary);
            opacity: 0;
            transition: var(--transition);
        }

        .macro-item:hover::before {
            opacity: 0.05;
        }

        .macro-item:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
        }

        .macro-value {
            font-size: var(--font-size-lg);
            font-weight: 800;
            margin-bottom: 5px;
            position: relative;
            z-index: 1;
        }

        .macro-label {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            z-index: 1;
        }

        .protein {
            color: #EF4444;
        }

        .carbs {
            color: #10B981;
        }

        .fat {
            color: #F59E0B;
        }

        /* ==================== CARTES D'ENTRAÎNEMENT ==================== */
        .workout-card {
            background: var(--gradient-premium);
            color: white;
            border-radius: var(--radius);
            padding: 20px;
            margin: 0 20px 16px;
            box-shadow: var(--shadow-lg);
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .workout-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(0,0,0,0.1), rgba(0,0,0,0.2));
            opacity: 0;
            transition: var(--transition);
        }

        .workout-card:hover::before {
            opacity: 1;
        }

        .workout-card:hover {
            transform: translateY(-6px) scale(1.02);
            box-shadow: var(--shadow-xl);
            animation: glow 2s infinite;
        }

        .workout-card:active {
            transform: scale(0.98);
        }

        .workout-name {
            font-size: var(--font-size-lg);
            font-weight: 800;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
        }

        .workout-description {
            font-size: var(--font-size-sm);
            opacity: 0.9;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .workout-duration {
            font-size: var(--font-size-sm);
            font-weight: 700;
            opacity: 0.9;
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* ==================== WORKOUT CARD LUXURY ==================== */
        .workout-card-luxury {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-radius: var(--radius);
            padding: 25px;
            margin: 0 20px 20px;
            color: white;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-xl);
            transition: var(--transition);
            cursor: pointer;
        }

        .workout-card-luxury::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(0,0,0,0.1), rgba(0,0,0,0.2));
        }

        .workout-card-luxury:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-2xl);
        }

        .workout-card-luxury .workout-icon {
            font-size: 32px;
            margin-bottom: 15px;
            display: block;
        }

        .workout-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255,255,255,0.2);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: var(--font-size-xs);
            font-weight: 700;
        }

        /* ==================== GRID DES MUSCLES ==================== */
        .muscle-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
            margin: 0 20px 16px;
        }

        .muscle-card {
            border-radius: var(--radius);
            padding: 20px;
            height: 110px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .muscle-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(0,0,0,0.2), rgba(0,0,0,0.3));
            opacity: 0;
            transition: var(--transition);
        }

        .muscle-card:hover::before {
            opacity: 1;
        }

        .muscle-card:hover {
            transform: translateY(-6px) scale(1.03);
            box-shadow: var(--shadow-xl);
        }

        .muscle-card:active {
            transform: scale(0.98);
        }

        .muscle-name {
            font-size: var(--font-size-base);
            font-weight: 800;
            color: white;
            margin-bottom: 5px;
            position: relative;
            z-index: 2;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .exercise-count {
            font-size: var(--font-size-sm);
            color: white;
            opacity: 0.9;
            position: relative;
            z-index: 2;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        /* ==================== EXERCICE ITEM ==================== */
        .exercise-item {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 18px;
            margin: 0 20px 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--border);
            transition: var(--transition);
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .exercise-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gradient-primary);
            opacity: 0;
            transition: var(--transition);
        }

        .exercise-item:hover::before {
            opacity: 0.05;
        }

        .exercise-item:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .exercise-item:active {
            transform: scale(0.98);
        }

        .exercise-content {
            flex: 1;
            cursor: pointer;
            padding: 6px 0;
        }

        .exercise-name {
            font-size: var(--font-size-base);
            font-weight: 700;
            margin-bottom: 5px;
            position: relative;
            z-index: 1;
        }

        .exercise-muscle {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            font-weight: 600;
            position: relative;
            z-index: 1;
        }

        .exercise-equipment {
            font-size: var(--font-size-xs);
            color: var(--text-tertiary);
            font-weight: 600;
            background: var(--card-bg);
            padding: 5px 10px;
            border-radius: 14px;
            border: 1px solid var(--border);
            position: relative;
            z-index: 1;
        }

        .exercise-actions {
            display: flex;
            gap: 6px;
            align-items: center;
            z-index: 10;
            position: relative;
        }

        /* ==================== ÉCRAN ENTRAÎNEMENT ACTIF ==================== */
        .workout-container {
            padding-bottom: 30px; /* Réduit l'espace entre dernier exo et bouton */
        }

        .workout-header {
            padding: 20px;
            text-align: center;
        }

        .workout-header h2 {
            font-size: var(--font-size-2xl);
            font-weight: 900;
            background: var(--gradient-premium);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .workout-timer-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 14px;
            margin: 18px;
            flex-wrap: wrap;
        }

        .workout-stat-side {
            background: var(--text-primary);
            color: var(--card-bg);
            padding: 14px 18px;
            border-radius: var(--radius);
            text-align: center;
            min-width: 90px;
            flex: 1;
            box-shadow: var(--shadow-lg);
            transition: var(--transition);
        }

        .dark-mode .workout-stat-side {
            background: var(--card-bg);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .workout-stat-side-value {
            font-size: var(--font-size-xl);
            font-weight: 900;
            margin-bottom: 5px;
        }

        .workout-stat-side-label {
            font-size: var(--font-size-xs);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .workout-timer {
            text-align: center;
            background: var(--gradient-premium);
            color: white;
            padding: 18px 20px;
            border-radius: var(--radius);
            font-size: var(--font-size-base);
            font-weight: 800;
            font-feature-settings: "tnum";
            font-variant-numeric: tabular-nums;
            box-shadow: var(--shadow-lg);
            min-width: 110px;
            animation: pulse 2s ease-in-out infinite;
        }

        .workout-exercise {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 20px;
            margin: 0 18px 16px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .workout-exercise::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-premium);
        }

        .exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 18px;
        }

        .exercise-title {
            font-size: var(--font-size-base);
            font-weight: 800;
            flex: 1;
        }

/* ==================== SÉRIES D'EXERCICE ==================== */
.sets-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.set-item {
    background: var(--card-bg);
    padding: 20px;
    border-radius: var(--radius);
    margin-bottom: 0;
    border: 1px solid var(--border);
    transition: var(--transition);
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.set-item.completed {
    background: var(--success);
    border-color: var(--success);
    color: white;
    box-shadow: var(--shadow);
}

.set-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--border-light);
}

.set-item.completed .set-header {
    border-bottom: 1px solid rgba(255, 255, 255, 0.3);
}

.set-number {
    font-weight: 900;
    color: var(--text-primary);
    font-size: var(--font-size-lg);
    min-width: 60px;
    text-align: center;
    background: var(--gradient-primary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.set-item.completed .set-number {
    background: white;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.set-controls {
    display: flex;
    gap: 8px;
    align-items: center;
}

/* ==================== ORGANISATION DES CHAMPS DE SAISIE ==================== */
.set-inputs-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 16px;
}

.input-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.input-label {
    font-size: var(--font-size-xs);
    color: var(--text-secondary);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.set-item.completed .input-label {
    color: rgba(255, 255, 255, 0.9);
}

.number-input {
    background: var(--card-bg);
    color: var(--text-primary);
    border: 2px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 14px;
    font-size: var(--font-size-lg);
    text-align: center;
    width: 100%;
    font-weight: 800;
    transition: var(--transition);
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
}

.set-item.completed .number-input {
    background: rgba(0, 0, 0, 0.2);
    color: white;
    border: 2px solid rgba(255, 255, 255, 0.3);
}

.number-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
    transform: translateY(-2px);
}

/* ==================== BOUTONS DE CONTRÔLE DE SÉRIE ==================== */
.set-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid var(--border-light);
}

.set-item.completed .set-actions {
    border-top: 1px solid rgba(255, 255, 255, 0.3);
}

.set-status {
    display: flex;
    align-items: center;
    gap: 12px;
}

.set-complete-btn {
    background: var(--gradient-success);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: var(--radius-sm);
    font-weight: 700;
    font-size: var(--font-size-sm);
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 8px;
}

.set-complete-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.set-complete-btn.completed {
    background: var(--success-dark);
    opacity: 0.8;
}

.checkbox {
    width: 24px;
    height: 24px;
    border: 2px solid var(--border);
    border-radius: 6px;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: var(--transition);
    cursor: pointer;
    background: var(--card-bg);
    position: relative;
    overflow: hidden;
}

.checkbox.checked {
    border-color: var(--success);
    background: var(--success);
}

.checkmark {
    color: white;
    font-size: var(--font-size-sm);
    font-weight: bold;
    opacity: 0;
    transition: var(--transition);
    z-index: 1;
}

.checkbox.checked .checkmark {
    opacity: 1;
}

/* ==================== INFOS PRÉCÉDENTES ==================== */
.previous-set-info {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    margin-top: 12px;
    padding: 10px;
    background: var(--card-bg);
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    font-style: italic;
    text-align: center;
}

.set-item.completed .previous-set-info {
    background: rgba(0, 0, 0, 0.2);
    color: rgba(255, 255, 255, 0.8);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-label {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
            margin-bottom: 6px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .set-item.completed .input-label {
            color: rgba(255,255,255,0.9);
        }

        .number-input {
            background: var(--card-bg);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 12px;
            font-size: var(--font-size-base);
            text-align: center;
            width: 100%;
            font-weight: 700;
            transition: var(--transition);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .number-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
            transform: scale(1.02);
        }

        .set-item.completed .number-input {
            background: rgba(0,0,0,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        /* ==================== BOUTONS ==================== */
        .btn {
            background: var(--gradient-premium);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: var(--radius);
            font-size: var(--font-size-base);
            font-weight: 800;
            cursor: pointer;
            transition: var(--transition);
            width: 100%;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0));
            opacity: 0;
            transition: var(--transition);
        }

        .btn:hover::before {
            opacity: 1;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn:hover {
            box-shadow: var(--shadow-xl);
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--gradient-danger);
        }

        .btn-success {
            background: var(--gradient-success-dark);
        }

        .btn-warning {
            background: var(--gradient-secondary);
        }

        .btn-info {
            background: linear-gradient(135deg, #06B6D4, #3B82F6);
        }

        .btn-secondary {
            background: var(--card-bg);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .action-btn {
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 10px 12px;
            border-radius: var(--radius-sm);
            font-size: var(--font-size-sm);
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            z-index: 10;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .action-btn:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        /* ==================== BOUTON AJOUTER EXERCICE ==================== */
        .add-exercise-btn {
            display: block;
            margin: 0 auto 16px;
            background: var(--gradient-premium);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: var(--radius);
            font-size: var(--font-size-base);
            font-weight: 800;
            cursor: pointer;
            transition: var(--transition);
            width: calc(100% - 40px);
            max-width: 280px;
            box-shadow: var(--shadow-lg);
            text-align: center;
        }

        .add-exercise-btn:hover {
            box-shadow: var(--shadow-xl);
            transform: translateY(-2px);
        }

        /* ==================== TIMER ==================== */
        .timer-container {
            position: fixed;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(40px);
            padding: 20px 18px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            z-index: 1001;
            box-shadow: var(--shadow-xl);
            display: none;
            width: 90%;
            max-width: 340px;
        }

        .dark-mode .timer-container {
            background: rgba(30, 41, 59, 0.95);
        }

        .timer-container.active {
            display: block;
            animation: slideInFromBottom 0.4s ease;
        }

        .timer-display {
            text-align: center;
            font-size: var(--font-size-3xl);
            font-weight: 900;
            margin-bottom: 18px;
            color: var(--primary);
            font-feature-settings: "tnum";
            font-variant-numeric: tabular-nums;
            text-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* ==================== BARRE DE PROGRESSION ==================== */
        .timer-progress-container {
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 18px;
            position: relative;
        }

        .timer-progress-bar {
            height: 100%;
            background: var(--gradient-premium);
            border-radius: 2px;
            transition: width 1s linear;
            width: 0%;
        }

        .timer-controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 8px;
        }

        .timer-btn {
            padding: 12px 8px;
            border: none;
            border-radius: var(--radius-sm);
            font-weight: 700;
            font-size: var(--font-size-sm);
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .timer-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0));
            opacity: 0;
            transition: var(--transition);
        }

        .timer-btn:hover::before {
            opacity: 1;
        }

        .timer-btn:active {
            transform: scale(0.95);
        }

        .timer-start {
            background: var(--gradient-premium);
            color: white;
        }

        .timer-adjust {
            background: var(--card-bg);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .timer-close {
            background: var(--danger);
            color: white;
        }

        /* ==================== CHECKBOX ==================== */
        .checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border);
            border-radius: 6px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: var(--transition);
            cursor: pointer;
            background: var(--card-bg);
            position: relative;
            overflow: hidden;
        }

        .checkbox::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gradient-success);
            opacity: 0;
            transition: var(--transition);
        }

        .checkbox.checked::before {
            opacity: 1;
        }

        .checkbox.checked {
            border-color: var(--success);
        }

        .checkmark {
            color: white;
            font-size: var(--font-size-sm);
            font-weight: bold;
            opacity: 0;
            transition: var(--transition);
            z-index: 1;
        }

        .checkbox.checked .checkmark {
            opacity: 1;
        }

        /* ==================== MODALS ==================== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 14px;
            backdrop-filter: blur(20px);
        }

        .modal.active {
            display: flex;
            animation: fadeIn 0.4s ease;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 24px;
            padding: 20px;
            width: 100%;
            max-width: 360px;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: var(--shadow-xl);
            animation: modalSlideUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        @keyframes modalSlideUp {
            from { transform: translateY(40px) scale(0.9); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
            padding-bottom: 14px;
            border-bottom: 1px solid var(--border);
        }

        .modal-title {
            font-size: var(--font-size-lg);
            font-weight: 800;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: var(--font-size-xl);
            cursor: pointer;
            color: var(--text-secondary);
            padding: 5px;
            border-radius: 8px;
            transition: var(--transition);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: var(--card-bg);
            color: var(--text-primary);
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding-right: 8px;
            margin-right: -8px;
        }

        /* ==================== BARRE DE RECHERCHE ==================== */
        .search-container {
            background: var(--card-bg);
            padding: 18px;
            margin: 0;
            border-bottom: 1px solid var(--border);
        }

        .search-input {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 14px 18px;
            font-size: var(--font-size-base);
            width: 100%;
            color: var(--text-primary);
            font-weight: 600;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
            transform: scale(1.02);
        }

        .search-input::placeholder {
            color: var(--text-tertiary);
            font-weight: 600;
        }

        /* ==================== FILTRES DÉROULANTS ==================== */
        .filter-select {
            width: calc(100% - 40px);
            margin: 0 20px 16px;
            padding: 14px 18px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--card-bg);
            color: var(--text-primary);
            font-size: var(--font-size-base);
            font-weight: 600;
            box-shadow: var(--shadow);
            transition: var(--transition);
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 14px center;
            background-size: 16px;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
            transform: scale(1.02);
        }

        /* ==================== HISTORIQUE ==================== */
        .history-item {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 20px;
            margin: 0 20px 16px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .history-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-premium);
        }

        .history-item:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 18px;
        }

        .history-date {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            font-weight: 600;
        }

        .history-workout {
            font-size: var(--font-size-base);
            font-weight: 800;
            margin-bottom: 8px;
        }

        .history-duration {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .history-stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 6px;
            margin-bottom: 18px;
        }

        .history-stat {
            background: var(--card-bg);
            padding: 10px 6px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            text-align: center;
            min-width: 0;
        }

        .history-stat-value {
            font-size: var(--font-size-sm);
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 3px;
            word-break: break-word;
        }

        .history-stat-label {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            line-height: 1.2;
        }

        .history-actions {
            display: flex;
            gap: 6px;
            justify-content: center;
        }

        /* ==================== MODAL DÉTAIL HISTORIQUE ==================== */
        .history-detail-exercise {
            background: var(--card-bg);
            padding: 14px;
            border-radius: var(--radius-sm);
            margin-bottom: 10px;
            border: 1px solid var(--border);
        }

        .history-detail-exercise-name {
            font-weight: 700;
            margin-bottom: 6px;
            color: var(--text-primary);
        }

        .history-detail-sets {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .history-detail-set {
            background: var(--card-bg);
            padding: 6px 10px;
            border-radius: 10px;
            font-size: var(--font-size-xs);
            border: 1px solid var(--border);
        }

        /* ==================== STYLES POUR LE MODULE NUTRITION ==================== */
        .calories-progress {
            margin-top: 14px;
        }

        .progress-bar {
            background: rgba(255,255,255,0.3);
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            background: white;
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .macro-target {
            font-size: var(--font-size-xs);
            color: var(--text-tertiary);
            margin-top: 3px;
        }

        .nutrition-tabs {
            display: flex;
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 3px;
            margin: 0 20px 16px;
            border: 1px solid var(--border);
        }

        .nutrition-tab {
            flex: 1;
            text-align: center;
            padding: 10px 6px;
            border-radius: var(--radius-sm);
            font-weight: 700;
            font-size: var(--font-size-sm);
            cursor: pointer;
            transition: var(--transition);
        }

        .nutrition-tab.active {
            background: var(--gradient-success-dark);
            color: white;
            box-shadow: var(--shadow);
        }

        .food-search-results {
            max-height: 280px;
            overflow-y: auto;
            margin-top: 14px;
            padding-right: 8px;
        }

        .food-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 14px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: var(--transition);
            flex-wrap: wrap;
        }

        .food-item:hover {
            background: var(--card-bg);
        }

        .food-item:last-child {
            border-bottom: none;
        }

        .food-info {
            flex: 1;
            min-width: 200px;
        }

        .food-name {
            font-weight: 700;
            margin-bottom: 3px;
        }

        .food-details {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
        }

        .food-macros {
            display: flex;
            gap: 6px;
            font-size: var(--font-size-xs);
            margin-top: 5px;
        }

        .macro-badge {
            background: var(--card-bg);
            padding: 3px 6px;
            border-radius: 10px;
            font-weight: 700;
            border: 1px solid var(--border);
        }

        .protein-badge {
            color: #EF4444;
            border-color: rgba(239, 68, 68, 0.3);
        }

        .carbs-badge {
            color: #10B981;
            border-color: rgba(16, 185, 129, 0.3);
        }

        .fat-badge {
            color: #F59E0B;
            border-color: rgba(245, 158, 11, 0.3);
        }

        .meal-type-badge {
            background: var(--gradient-success-dark);
            color: white;
            padding: 3px 10px;
            border-radius: 18px;
            font-size: var(--font-size-xs);
            font-weight: 700;
        }

        .nutrition-history-item {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 18px;
            margin: 0 20px 14px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .nutrition-history-item:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .nutrition-history-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 14px;
        }

        .nutrition-history-title {
            font-weight: 800;
            font-size: var(--font-size-base);
        }

        .nutrition-history-date {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
        }

        .nutrition-history-foods {
            margin-bottom: 14px;
        }

        .nutrition-history-food {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid var(--border);
        }

        .nutrition-history-food:last-child {
            border-bottom: none;
        }

        .nutrition-history-totals {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 6px;
            padding-top: 14px;
            border-top: 1px solid var(--border);
        }

        .nutrition-history-total {
            text-align: center;
        }

        .nutrition-history-total-value {
            font-weight: 800;
            font-size: var(--font-size-base);
        }

        .nutrition-history-total-label {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            line-height: 1.2;
        }

        .empty-state {
            text-align: center;
            padding: 36px 18px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: var(--font-size-3xl);
            margin-bottom: 14px;
            opacity: 0.5;
        }

        /* ==================== UTILITAIRES ==================== */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mt-4 {
            margin-top: 14px;
        }

        .mb-4 {
            margin-bottom: 14px;
        }

        .flex {
            display: flex;
        }

        .flex-col {
            flex-direction: column;
        }

        .items-center {
            align-items: center;
        }

        .justify-center {
            justify-content: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .gap-2 {
            gap: 8px;
        }

        .gap-4 {
            gap: 16px;
        }

        .w-full {
            width: 100%;
        }

        /* ==================== BOUTON RADIO ==================== */
        .radio-tabs {
            display: flex;
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 3px;
            margin: 0 20px 16px;
            border: 1px solid var(--border);
        }

        .radio-tab {
            flex: 1;
            text-align: center;
            padding: 10px 6px;
            border-radius: var(--radius-sm);
            font-weight: 700;
            font-size: var(--font-size-sm);
            cursor: pointer;
            transition: var(--transition);
            background: none;
            border: none;
            color: var(--text-secondary);
        }

        .radio-tab.active {
            background: var(--gradient-premium);
            color: white;
            box-shadow: var(--shadow);
        }

        /* ==================== FORMULAIRE DE QUANTITÉ ==================== */
        .quantity-form {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 8px;
            flex-wrap: wrap;
        }
        
        .quantity-input {
            flex: 1;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 8px 12px;
            font-size: var(--font-size-base);
            color: var(--text-primary);
            text-align: center;
            min-width: 80px;
        }
        
        .add-with-quantity-btn {
            padding: 8px 12px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-weight: 700;
            font-size: var(--font-size-sm);
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
        }
        
        .add-with-quantity-btn:hover {
            background: var(--success-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        /* ==================== STYLES POUR LES ALIMENTS DANS LES REPAS ==================== */
        .meal-food-item {
            background: var(--card-bg);
            border-radius: var(--radius-sm);
            padding: 12px;
            margin-bottom: 8px;
            border: 1px solid var(--border);
            transition: var(--transition);
        }

        .meal-food-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        /* ==================== STYLES POUR LE BOUTON SAUVEGARDER LA SÉANCE ==================== */
        #workout-exercises-selection,
        #edit-workout-exercises-selection {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 10px;
            padding-right: 5px;
        }

        /* ==================== POUR ÉVITER L'ASCENSEUR HORIZONTAL DANS LES MODALS ==================== */
        .modal-scrollable {
            max-height: 60vh;
            overflow-y: auto;
            padding-right: 8px;
        }
        
        /* ==================== NOUVEAU: Styles pour les boutons Import/Export ==================== */
        .import-export-section {
            display: flex;
            gap: 10px;
            margin: 20px;
        }
        
        .import-export-btn {
            flex: 1;
            padding: 14px;
            border-radius: var(--radius);
            font-weight: 700;
            font-size: var(--font-size-sm);
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid var(--border);
            background: var(--card-bg);
            color: var(--text-primary);
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .import-export-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        .import-btn {
            background: var(--gradient-success-dark);
            color: white;
            border: none;
        }
        
        .export-btn {
            background: var(--gradient-premium);
            color: white;
            border: none;
        }
        
        /* ==================== Styles pour le bouton Dupliquer dans les séances ==================== */
        .duplicate-btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            font-size: var(--font-size-sm);
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .duplicate-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        /* ==================== Styles pour la recherche avancée ==================== */
        .advanced-search-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }

        .filter-option {
            background: var(--card-bg);
            border: 1px solid var(--border);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: var(--font-size-sm);
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
        }

        .filter-option.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .filter-option:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .difficulty-beginner {
    background: #10B981;
    color: white;
}

.difficulty-intermediate {
    background: #F59E0B;
    color: white;
}

.difficulty-advanced {
    background: #EF4444;
    color: white;
}

        .exercise-difficulty-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: var(--font-size-xs);
            font-weight: 700;
            display: inline-block;
        }

        /* ==================== Styles pour les paramètres ==================== */
        .settings-item {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 18px;
            margin: 0 20px 12px;
            border: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 54px;
            height: 28px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border);
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--success);
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        /* ==================== Styles pour la pause totale ==================== */
        .pause-total {
            background: var(--gradient-premium);
            color: white;
            padding: 12px;
            border-radius: var(--radius-sm);
            margin: 10px 20px;
            text-align: center;
            font-weight: 700;
        }
        
        .settings-list {
            padding: 10px 0;
        }

        /* ==================== NOUVEAUX STYLES POUR LES GRAPHIQUES ==================== */
        .chart-container {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 20px;
            margin: 0 20px 16px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .chart-title {
            font-size: var(--font-size-base);
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--text-primary);
            text-align: center;
        }

        .chart-placeholder {
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--card-bg);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-weight: 700;
            border: 1px dashed var(--border);
        }

        .history-tabs {
            display: flex;
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 3px;
            margin: 0 20px 16px;
            border: 1px solid var(--border);
        }

        .history-tab {
            flex: 1;
            text-align: center;
            padding: 10px 6px;
            border-radius: var(--radius-sm);
            font-weight: 700;
            font-size: var(--font-size-sm);
            cursor: pointer;
            transition: var(--transition);
        }

        .history-tab.active {
            background: var(--gradient-premium);
            color: white;
            box-shadow: var(--shadow);
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 15px;
            border-radius: var(--radius-sm);
            text-align: center;
            border: 1px solid var(--border);
        }

        .stat-card-value {
            font-size: var(--font-size-lg);
            font-weight: 900;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .stat-card-label {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
            font-weight: 700;
            text-transform: uppercase;
        }

        /* ==================== Styles pour les boutons de navigation dans l'historique ==================== */
        .history-nav-buttons {
            display: flex;
            gap: 10px;
            margin: 0 20px 16px;
            justify-content: center;
        }

        .history-nav-btn {
            flex: 1;
            padding: 12px;
            border-radius: var(--radius);
            font-weight: 700;
            font-size: var(--font-size-sm);
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid var(--border);
            background: var(--card-bg);
            color: var(--text-primary);
            text-align: center;
            max-width: 200px;
        }

        .history-nav-btn.active {
            background: var(--gradient-premium);
            color: white;
            border-color: var(--primary);
        }

        .history-nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        /* ==================== Styles pour les aliments enrichis ==================== */
        .meal-type-select {
            width: 100%;
            margin-bottom: 14px;
        }

        .meal-type-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .meal-type-option {
            padding: 8px 12px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: var(--font-size-sm);
            cursor: pointer;
            transition: var(--transition);
            flex: 1;
            text-align: center;
        }

        .meal-type-option.active {
            background: var(--gradient-success-dark);
            color: white;
            border-color: var(--success);
        }

        /* ==================== Correction pour les boutons modaux ==================== */
        .modal-backdrop {
            z-index: 1999;
        }

        .modal-active {
            z-index: 2001 !important;
        }

        /* ==================== STYLES POUR LES BOUTONS DE RÉORGANISATION ==================== */
        .reorder-buttons {
            display: flex;
            gap: 5px;
        }

        .reorder-btn {
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            font-size: var(--font-size-sm);
            font-weight: bold;
        }

        .reorder-btn:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        /* ==================== STYLES POUR LE BOUTON AFFICHER (RECHERCHE AVANCÉE) ==================== */
        .advanced-search-display-btn {
            background: var(--card-bg);
            border: 1px solid var(--border);
            padding: 10px 15px;
            border-radius: var(--radius-sm);
            font-size: var(--font-size-sm);
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
        }

        .advanced-search-display-btn:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .advanced-search-selected-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 10px 0;
        }

        .selected-filter {
            background: var(--primary);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: var(--font-size-xs);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .selected-filter-remove {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: var(--font-size-xs);
            padding: 0;
            margin: 0;
        }

        /* ==================== STYLES POUR LE BOUTON SUPPRIMER TOUS LES ALIMENTS ==================== */
        .delete-all-btn-container {
            display: flex;
            gap: 10px;
            margin: 0 20px 16px;
            justify-content: center;
        }

        /* ==================== STYLES AMÉLIORÉS POUR LE DÉTAIL HISTORIQUE ==================== */
        .history-detail-content {
            background: var(--card-bg);
            border-radius: var(--radius-sm);
            padding: 15px;
            margin-bottom: 10px;
        }

        .history-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }

        .history-detail-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        /* ==================== STYLES POUR LE BOUTON REFAIRE ==================== */
        .redo-btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: var(--radius-sm);
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .redo-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        /* ==================== NAVBAR FIXE ==================== */
        .navbar-container {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px 0;
            background: transparent;
            pointer-events: none;
        }

        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            display: flex;
            padding: 10px 18px;
            border-radius: 26px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-xl);
            animation: slideInFromBottom 0.6s ease 0.2s both;
            pointer-events: auto;
            width: 90%;
            max-width: 360px;
            margin: 0 auto;
        }

        .dark-mode .navbar {
            background: rgba(30, 41, 59, 0.95);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 6px 10px;
            border-radius: 18px;
            transition: var(--transition);
            cursor: pointer;
            position: relative;
            flex: 1;
            min-width: 0;
            margin: 0 3px;
            user-select: none;
        }

        .nav-item.active {
            background: var(--gradient-premium);
            transform: translateY(-6px);
            box-shadow: var(--shadow-lg);
        }

        .nav-item.active .nav-icon,
        .nav-item.active .nav-text {
            color: white;
        }

        .nav-icon {
            font-size: var(--font-size-base);
            margin-bottom: 3px;
            color: var(--text-secondary);
            transition: var(--transition);
        }

        .nav-text {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
            font-weight: 700;
            letter-spacing: -0.2px;
            transition: var(--transition);
            text-align: center;
            white-space: nowrap;
        }

        /* ==================== RESPONSIVE ==================== */
        @media (max-width: 380px) {
            .app-container {
                max-width: 100%;
            }
            
            .muscle-grid {
                grid-template-columns: 1fr;
            }
            
            .set-inputs-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .workout-timer-container {
                flex-direction: column;
                gap: 10px;
            }
            
            .workout-stat-side {
                min-width: 100%;
            }
            
            .history-stats {
                grid-template-columns: 1fr 1fr;
                gap: 6px;
            }
            
            .history-actions {
                flex-direction: column;
                gap: 6px;
            }
            
            .history-stat {
                padding: 8px 4px;
            }
            
            .history-stat-value {
                font-size: var(--font-size-sm);
            }
            
            .history-stat-label {
                font-size: var(--font-size-xs);
            }
            
            .quantity-form {
                flex-direction: column;
                gap: 8px;
                width: 100%;
            }
            
            .quantity-input {
                width: 100%;
            }
            
            .add-with-quantity-btn {
                width: 100%;
            }
            
            .food-item {
                flex-direction: column;
                gap: 10px;
            }
            
            .food-info {
                width: 100%;
            }

            .navbar {
                width: calc(100% - 28px);
                padding: 8px 14px;
                bottom: 8px;
            }
            
            .nav-item {
                padding: 5px 6px;
                min-width: 46px;
                margin: 0 1px;
            }
            
            .nav-icon {
                font-size: var(--font-size-base);
            }
            
            .nav-text {
                font-size: var(--font-size-xs);
            }
        }

        /* ==================== CALORIES BALANCE ==================== */
        .calories-balance {
            font-size: var(--font-size-sm);
            margin-top: 5px;
            font-weight: 700;
        }

        .calories-balance.positive {
            color: white;
            opacity: 0.9;
        }

        .calories-balance.negative {
            color: #FEE2E2;
        }

        .macro-remaining {
            font-size: var(--font-size-xs);
            color: var(--text-tertiary);
            margin-top: 2px;
        }

        .macro-remaining.positive {
            color: var(--success);
        }

        .macro-remaining.negative {
            color: var(--danger);
        }

        .history-calories-balance {
            font-size: var(--font-size-sm);
            font-weight: 700;
            margin-top: 3px;
        }

        .history-calories-balance.positive {
            color: var(--success);
        }

        .history-calories-balance.negative {
            color: var(--danger);
        }

        .nutrition-history-actions {
            display: flex;
            gap: 6px;
            margin-top: 14px;
        }

        .nutrition-history-btn {
            flex: 1;
            padding: 6px 3px;
            border: none;
            border-radius: var(--radius-sm);
            font-weight: 700;
            font-size: var(--font-size-xs);
            cursor: pointer;
            transition: var(--transition);
            min-width: 0;
        }

        /* ==================== OPTIMISATION DES BOUTONS DANS LE MODAL DE RECHERCHE D'ALIMENT ==================== */
        .food-search-btn-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            margin-top: 10px;
            gap: 8px;
        }

        .food-search-btn {
            flex: 1;
            padding: 10px 8px;
            font-size: var(--font-size-sm);
            white-space: nowrap;
            min-width: 0;
        }

        /* ==================== STYLES POUR LE MODAL AJOUTER REPAS - OPTIMISATION ==================== */
        .add-meal-modal-content {
            max-height: 80vh;
            overflow-y: auto;
            padding-right: 5px;
        }

        /* ==================== STYLES POUR LE WORKOUT EXERCISE ACTIONS ==================== */
        .workout-exercise-actions {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        /* ==================== NOUVEAU: COMPONENT BOX DESIGN ==================== */
        .component-box {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 20px;
            margin: 0 20px 16px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .component-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-premium);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.6s ease;
        }

        .component-box:hover::before {
            transform: scaleX(1);
        }

        .component-box-title {
            font-size: var(--font-size-base);
            font-weight: 800;
            margin-bottom: 15px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .component-box-content {
            position: relative;
            z-index: 1;
        }

        /* ==================== BETTER HISTORY ITEM DESIGN ==================== */
        .history-item-improved {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 20px;
            margin: 0 20px 16px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .history-item-improved::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-premium);
        }

        .history-item-improved:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .history-item-improved-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .history-item-improved-title {
            font-size: var(--font-size-base);
            font-weight: 800;
            color: var(--text-primary);
        }

        .history-item-improved-date {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
            font-weight: 600;
        }

        .history-item-improved-stats {
    display: grid;
    grid-template-areas:
        "exercice exercice"
        "series repetitions"
        "poids duree"
        "pause pause";
    gap: 8px;
    margin-bottom: 15px;
}

.history-item-improved-stat:nth-child(1) { grid-area: exercice; }
.history-item-improved-stat:nth-child(2) { grid-area: series; }
.history-item-improved-stat:nth-child(3) { grid-area: repetitions; }
.history-item-improved-stat:nth-child(4) { grid-area: poids; }
.history-item-improved-stat:nth-child(5) { grid-area: duree; }
.history-item-improved-stat:nth-child(6) { grid-area: pause; }

.history-item-improved-stat:nth-child(1) .history-item-improved-stat-label {
    text-align: left;
    margin-left: 5px;
}

.history-item-improved-stat:nth-child(1) .history-item-improved-stat-value {
    text-align: left;
    margin-left: 5px;
    font-size: var(--font-size-base);
}

        .history-item-improved-stat {
            background: var(--card-bg);
            padding: 10px 6px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            text-align: center;
        }

        .history-item-improved-stat-value {
            font-size: var(--font-size-sm);
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 3px;
        }

        .history-item-improved-stat-label {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .history-item-improved-actions {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        /* ==================== IMPROVED BUTTON DESIGN FOR GRAPHICAL/NON-GRAPHICAL ==================== */
        .history-view-toggle {
            display: flex;
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 3px;
            margin: 0 20px 16px;
            border: 1px solid var(--border);
        }

        .history-view-toggle-btn {
            flex: 1;
            text-align: center;
            padding: 10px 6px;
            border-radius: var(--radius-sm);
            font-weight: 700;
            font-size: var(--font-size-sm);
            cursor: pointer;
            transition: var(--transition);
            background: none;
            border: none;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .history-view-toggle-btn.active {
            background: var(--gradient-premium);
            color: white;
            box-shadow: var(--shadow);
        }

        /* ==================== DETAIL BUTTON FIX ==================== */
        .detail-btn {
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            font-size: var(--font-size-xs);
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 5px;
            text-decoration: none;
        }

        .detail-btn:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

/* ==================== MODAL FICHE EXERCICE DÉTAILLÉE ==================== */
.exercise-detail-modal-content {
    max-height: 80vh;
    overflow-y: auto;
    padding-right: 5px;
}

.exercise-detail-header {
    text-align: center;
    margin-bottom: 20px;
    position: relative;
}

.exercise-detail-icon {
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, var(--primary), var(--primary-light));
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 15px;
    color: white;
    font-size: var(--font-size-3xl);
    box-shadow: var(--shadow-xl);
}

.exercise-detail-title {
    font-size: var(--font-size-xl);
    font-weight: 900;
    margin-bottom: 10px;
    color: var(--text-primary);
}

.exercise-detail-subtitle {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    flex-wrap: wrap;
}

.exercise-detail-badge {
    padding: 4px 10px;
    border-radius: 20px;
    font-size: var(--font-size-xs);
    font-weight: 700;
    display: inline-block;
}

.exercise-detail-section {
    background: var(--card-bg);
    border-radius: var(--radius-sm);
    padding: 15px;
    margin-bottom: 15px;
    border: 1px solid var(--border);
}

.exercise-detail-section-title {
    font-size: var(--font-size-base);
    font-weight: 800;
    margin-bottom: 10px;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 8px;
}

.exercise-detail-description {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    line-height: 1.6;
}

.exercise-detail-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-top: 10px;
}

.exercise-detail-stat {
    text-align: center;
    padding: 12px;
    background: var(--card-bg);
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
}

.exercise-detail-stat-value {
    font-size: var(--font-size-base);
    font-weight: 900;
    margin-bottom: 5px;
}

.exercise-detail-stat-label {
    font-size: var(--font-size-xs);
    color: var(--text-secondary);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.exercise-detail-equipment-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 10px;
}

.exercise-detail-equipment-item {
    background: var(--card-bg);
    padding: 6px 12px;
    border-radius: 20px;
    font-size: var(--font-size-sm);
    border: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 6px;
}

.exercise-detail-video-btn {
    background: linear-gradient(135deg, #FF0000, #CC0000);
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: var(--radius);
    font-weight: 800;
    font-size: var(--font-size-base);
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    width: 100%;
    margin-top: 15px;
}

.exercise-detail-video-btn:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow);
}

.exercise-detail-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

.exercise-difficulty-badge {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: var(--font-size-xs);
    font-weight: 900;
    text-transform: uppercase;
}

.difficulty-beginner {
    background: linear-gradient(135deg, #10B981, #059669);
    color: white;
}

.difficulty-intermediate {
    background: linear-gradient(135deg, #F59E0B, #D97706);
    color: white;
}

.difficulty-advanced {
    background: linear-gradient(135deg, #EF4444, #DC2626);
    color: white;
}

.exercise-muscle-badge {
    background: linear-gradient(135deg, var(--primary), var(--primary-light));
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: var(--font-size-xs);
    font-weight: 900;
}

.exercise-category-badge {
    background: linear-gradient(135deg, #8B5CF6, #7C3AED);
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: var(--font-size-xs);
    font-weight: 900;
}

        /* ==================== FOOD ITEM IMPROVED ==================== */
        .food-item-improved {
            background: var(--card-bg);
            border-radius: var(--radius-sm);
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid var(--border);
            transition: var(--transition);
        }

        .food-item-improved:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .food-item-improved-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .food-item-improved-name {
            font-weight: 700;
            font-size: var(--font-size-base);
            color: var(--text-primary);
        }

        .food-item-improved-calories {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            font-weight: 600;
        }

        .food-item-improved-details {
            display: flex;
            gap: 10px;
            font-size: var(--font-size-xs);
            color: var(--text-tertiary);
            margin-bottom: 10px;
        }

        .food-item-improved-macros {
            display: flex;
            gap: 8px;
        }

        .food-item-improved-macro {
            background: var(--card-bg);
            padding: 4px 8px;
            border-radius: 10px;
            font-size: var(--font-size-xs);
            font-weight: 700;
            border: 1px solid var(--border);
        }

        /* ==================== DELETE ALL FOODS BUTTON ==================== */
        .delete-all-foods-btn {
            background: var(--gradient-danger);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: var(--radius);
            font-size: var(--font-size-sm);
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            max-width: 280px;
            margin: 0 auto 16px;
        }

        .delete-all-foods-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        /* ==================== IMPROVED SEARCH DISPLAY ==================== */
        .advanced-search-display {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 15px;
            margin: 0 20px 16px;
            border: 1px solid var(--border);
        }

        .advanced-search-display-title {
            font-size: var(--font-size-base);
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .advanced-search-display-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .advanced-search-display-filter {
            background: var(--primary);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: var(--font-size-xs);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .advanced-search-display-actions {
            display: flex;
            gap: 10px;
        }

        /* ==================== IMPROVED FILTER SELECTION ==================== */
        .filter-selection-container {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 15px;
            margin: 0 20px 16px;
            border: 1px solid var(--border);
        }

        .filter-selection-title {
            font-size: var(--font-size-base);
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .filter-selection-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .filter-selection-option {
            background: var(--card-bg);
            border: 1px solid var(--border);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: var(--font-size-sm);
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
        }

        .filter-selection-option.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .filter-selection-option:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        /* ==================== LOADING INDICATOR ==================== */
        .loading-indicator {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .loading-indicator.active {
            display: flex;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }

        /* ==================== CORRECTIONS SPÉCIFIQUES ==================== */
        /* 1. Accueil : émojis à droite du nombre d'exercices */
        .muscle-card .exercise-count {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* 2. Séances : amélioration de l'affichage des séries */
        .set-header {
            flex-direction: column;
            align-items: flex-start;
        }

        .previous-set-info {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
            margin-top: 5px;
            font-style: italic;
        }

        /* 3. Nutrition : meilleure organisation des repas */
        .meals-list-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-top: 15px;
        }

        .meal-box {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 16px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .meal-box:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        .meal-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-success);
        }

        .meal-box-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .meal-box-title {
            font-weight: 700;
            font-size: var(--font-size-base);
            color: var(--text-primary);
        }

        .meal-box-type {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
            background: var(--card-bg);
            padding: 3px 8px;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .meal-box-content {
            margin-bottom: 12px;
        }

        .meal-box-macros {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 10px;
        }

        .meal-box-macro {
            text-align: center;
        }

        .meal-box-macro-value {
            font-weight: 700;
            font-size: var(--font-size-sm);
            color: var(--text-primary);
        }

        .meal-box-macro-label {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
        }

        .meal-box-notes {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
        }

        /* 4. Historique séances : amélioration de l'affichage */
        .history-exercise-item {
            background: var(--card-bg);
            border-radius: var(--radius-sm);
            padding: 14px;
            margin-bottom: 10px;
            border: 1px solid var(--border);
        }

        .history-exercise-name {
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .history-exercise-stats {
            display: grid;
            grid-template-columns: 1fr;
            gap: 6px;
        }

        .history-exercise-stat {
            display: flex;
            justify-content: space-between;
            font-size: var(--font-size-sm);
        }

        .history-exercise-stat-label {
            color: var(--text-secondary);
        }

        .history-exercise-stat-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        /* 5. Graphique historique */
        .chart-wrapper {
            height: 200px;
            position: relative;
            margin-top: 15px;
        }

        .chart-bars {
            display: flex;
            align-items: flex-end;
            height: 150px;
            gap: 10px;
            padding: 0 10px;
            border-bottom: 1px solid var(--border);
        }

        .chart-bar {
            flex: 1;
            background: var(--gradient-primary);
            border-radius: 4px 4px 0 0;
            position: relative;
            transition: var(--transition);
            cursor: pointer;
        }

        .chart-bar:hover {
            opacity: 0.8;
            transform: translateY(-2px);
        }

        .chart-labels {
            display: flex;
            justify-content: space-between;
            padding: 5px 10px;
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
        }

        /* 6. Aliments favoris */
        .favorite-foods-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 15px;
        }

        .favorite-food-item {
            background: var(--card-bg);
            border-radius: var(--radius-sm);
            padding: 12px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .favorite-food-item:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
        }

        .favorite-food-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-secondary);
        }

        .favorite-food-name {
            font-weight: 700;
            font-size: var(--font-size-sm);
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .favorite-food-calories {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
        }

        .favorite-food-star {
            position: absolute;
            top: 8px;
            right: 8px;
            color: var(--warning);
            font-size: var(--font-size-sm);
        }

        /* 7. Recherche d'aliments dans repas */
        .food-search-simple-item {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: var(--transition);
        }

        .food-search-simple-item:hover {
            background: var(--card-bg);
        }

        .food-search-simple-item:last-child {
            border-bottom: none;
        }

        .food-search-simple-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 3px;
        }

        .food-search-simple-details {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
        }

        /* 8. Historique nutrition - amélioration de l'affichage */
        .nutrition-history-box {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 16px;
            margin: 0 20px 16px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .nutrition-history-date-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        .nutrition-history-totals-improved {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-top: 12px;
        }

        .nutrition-history-total-improved {
            text-align: center;
            padding: 8px;
            background: var(--card-bg);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
        }

        .nutrition-history-total-value-improved {
            font-size: var(--font-size-base);
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 3px;
        }

        .nutrition-history-total-label-improved {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* 9. Correction pour les boutons qui débordent */
        .exercise-actions {
            flex-wrap: nowrap;
            min-width: fit-content;
        }

        .history-item-improved-actions {
            flex-wrap: wrap;
        }

        /* 10. Amélioration de l'affichage des séries précédentes */
        .previous-sets-container {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 8px;
        }

        .previous-set-badge {
            background: var(--card-bg);
            padding: 3px 8px;
            border-radius: 10px;
            font-size: var(--font-size-xs);
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }

        
/* CORRECTION Historique - Réorganiser les boutons */
.history-stats-grid {
    display: grid;
    grid-template-areas:
        "exercice exercice"
        "series repetitions"
        "poids duree";
    gap: 8px;
    margin-bottom: 15px;
}

.history-stat-exercice { grid-area: exercice; }
.history-stat-series { grid-area: series; }
.history-stat-repetitions { grid-area: repetitions; }
.history-stat-poids { grid-area: poids; }
.history-stat-duree { grid-area: duree; }

.history-stat-exercice .history-stat-label {
    text-align: left;
    margin-left: 5px;
}

.history-stat-exercice .history-stat-value {
    text-align: left;
    margin-left: 5px;
    font-size: var(--font-size-base);
}

        /* CORRECTION 10: Notes qui vont à la ligne */
        .notes-wrap {
            white-space: pre-wrap;
            word-break: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
        
/* Styles pour les boutons d'exercice sur deux lignes */
.workout-exercise-actions > div {
    justify-content: center;
}

/* Styles pour les badges superset */
.superset-badge {
    font-size: 10px !important;
    font-weight: 700 !important;
    padding: 2px 8px !important;
    border-radius: 10px !important;
    margin-left: 8px !important;
    display: inline-block !important;
    border: 1px solid rgba(255, 255, 255, 0.3) !important;
}

/* Styles pour les supersets regroupés */
.superset-group {
    position: relative;
    margin: 15px 0;
    border: 2px solid #8B5CF6;
    border-radius: var(--radius);
    padding: 5px;
    background: rgba(139, 92, 246, 0.05);
}

.superset-group::before {
    content: 'SUPERSET';
    position: absolute;
    top: -10px;
    left: 15px;
    background: #8B5CF6;
    color: white;
    font-size: 9px;
    font-weight: 900;
    padding: 2px 10px;
    border-radius: 10px;
    letter-spacing: 1px;
}

.superset-group .workout-exercise {
    margin: 5px 0;
    border-radius: var(--radius-sm);
}

.superset-group .workout-exercise:first-child {
    border-radius: var(--radius-sm) var(--radius-sm) 0 0;
}

.superset-group .workout-exercise:last-child {
    border-radius: 0 0 var(--radius-sm) var(--radius-sm);
}

/* Styles pour les exercices en superset */
.workout-exercise[style*="border-left"] {
    transition: all 0.3s ease;
}

/* Animation pour la série suivante dans un superset */
@keyframes superset-highlight {
    0% { box-shadow: 0 0 0 0px rgba(139, 92, 246, 0.7); }
    50% { box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.7); }
    100% { box-shadow: 0 0 0 0px rgba(139, 92, 246, 0.7); }
}

.superset-highlight {
    animation: superset-highlight 1.5s ease-in-out infinite;
}

/* Styles pour les statistiques d'exercice */
.history-exercise-stats {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.history-exercise-stat-line {
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
}


/* Styles pour les supersets */
.superset-highlight {
    animation: superset-highlight 2s ease-in-out;
}

@keyframes superset-highlight {
    0% { box-shadow: 0 0 0 0px rgba(139, 92, 246, 0.7); }
    50% { box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.7); }
    100% { box-shadow: 0 0 0 0px rgba(139, 92, 246, 0.7); }
}

.superset-navigation-hint {
    font-size: var(--font-size-xs);
    color: #8B5CF6;
    margin: 10px 0 5px 0;
    padding: 8px 12px;
    background: rgba(139, 92, 246, 0.1);
    border-radius: var(--radius-sm);
    border-left: 3px solid #8B5CF6;
    font-weight: 600;
}

.superset-navigation-hint i {
    margin-right: 5px;
}

.set-item.superset-active {
    border-left: 3px solid #8B5CF6;
    background: rgba(139, 92, 246, 0.05);
}

	}

/* ==================== PICKER 3D AVEC DÉFILEMENT INFINI - OPTIMISÉ ==================== */
.time-picker-container {
    display: flex;
    justify-content: center;
    gap: 20px; /* Réduit de 40px à 20px */
    margin: 20px 0; /* Réduit de 40px à 20px */
    perspective: 1000px;
    position: relative;
}

.time-picker-column {
    flex: 1;
    position: relative;
    height: 180px; /* Réduit de 240px à 180px */
    max-width: 80px; /* Réduit de 100px à 80px */
    transform-style: preserve-3d;
}

.picker-column-label {
    text-align: center;
    font-size: 9px; /* Réduit */
    color: var(--text-secondary);
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: 1px; /* Réduit */
    margin-bottom: 10px; /* Réduit de 20px à 10px */
    position: relative;
    z-index: 10;
    background: var(--gradient-primary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.picker-wheel-3d {
    height: 180px; /* Réduit de 240px à 180px */
    position: relative;
    border-radius: 16px; /* Réduit de 20px à 16px */
    background: linear-gradient(145deg, 
        rgba(255, 255, 255, 0.1), 
        rgba(255, 255, 255, 0.05));
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 
        0 10px 25px rgba(0, 0, 0, 0.2), /* Réduit l'ombre */
        inset 0 1px 0 rgba(255, 255, 255, 0.1),
        inset 0 -1px 0 rgba(0, 0, 0, 0.2);
    overflow: hidden;
    backdrop-filter: blur(8px); /* Réduit */
    transform-style: preserve-3d;
}

.dark-mode .picker-wheel-3d {
    background: linear-gradient(145deg, 
        rgba(30, 41, 59, 0.8), 
        rgba(15, 23, 42, 0.9));
    border: 1px solid rgba(255, 255, 255, 0.08);
}

.picker-wheel-content-3d {
    position: relative;
    height: 100%;
    transform-style: preserve-3d;
    transition: transform 0.1s linear;
}

.picker-item-3d {
    position: absolute;
    width: 100%;
    height: 36px; /* Réduit de 48px à 36px */
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--font-size-lg); /* Réduit de var(--font-size-xl) */
    font-weight: 800;
    color: var(--text-secondary);
    opacity: 0.3;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
    user-select: none;
    transform-origin: center center;
    backface-visibility: hidden;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    border-radius: 8px; /* Réduit de 12px à 8px */
}

.picker-item-3d.selected {
    color: white;
    font-size: var(--font-size-2xl); /* Réduit de var(--font-size-3xl) */
    font-weight: 900;
    opacity: 1;
    transform: translateZ(20px) scale(1.15); /* Réduit translateZ de 30px à 20px */
    text-shadow: 
        0 0 12px var(--primary-light), /* Réduit */
        0 3px 8px rgba(0, 0, 0, 0.3); /* Réduit */
    background: linear-gradient(135deg, 
        rgba(99, 102, 241, 0.25), 
        rgba(129, 140, 248, 0.08));
    border: 1px solid rgba(99, 102, 241, 0.4); /* Réduit de 2px à 1px */
    box-shadow: 
        0 6px 15px rgba(99, 102, 241, 0.2), /* Réduit */
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    z-index: 10;
}

.picker-highlight-3d {
    position: absolute;
    top: 50%;
    left: 8%; /* Réduit de 10% */
    right: 8%; /* Réduit de 10% */
    height: 40px; /* Réduit de 52px à 40px */
    background: linear-gradient(90deg, 
        transparent, 
        rgba(99, 102, 241, 0.15), /* Réduit l'opacité */
        transparent);
    border-radius: 12px; /* Réduit de 16px à 12px */
    transform: translateY(-50%);
    pointer-events: none;
    z-index: 1;
    border: 1px solid rgba(99, 102, 241, 0.2); /* Réduit l'épaisseur et l'opacité */
    box-shadow: 
        0 0 20px rgba(99, 102, 241, 0.1), /* Réduit */
        inset 0 0 12px rgba(99, 102, 241, 0.08); /* Réduit */
}

.picker-glow {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 70%; /* Réduit de 80% */
    height: 45px; /* Réduit de 60px à 45px */
    background: radial-gradient(
        ellipse at center,
        rgba(99, 102, 241, 0.3) 0%, /* Réduit l'opacité */
        transparent 70%
    );
    transform: translate(-50%, -50%);
    filter: blur(12px); /* Réduit de 20px à 12px */
    pointer-events: none;
    z-index: 0;
}

/* Animation de pulsation plus subtile */
@keyframes pulse-glow {
    0%, 100% { 
        box-shadow: 
            0 6px 15px rgba(99, 102, 241, 0.2),
            inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }
    50% { 
        box-shadow: 
            0 8px 20px rgba(99, 102, 241, 0.3),
            inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }
}

.picker-item-3d.selected {
    animation: pulse-glow 2s ease-in-out infinite;
}

/* ==================== CONTENEUR MODAL PLUS COMPACT ==================== */
.modal-content[style*="max-width: 340px"] {
    max-width: 320px; /* Réduit de 340px à 320px */
    padding: 15px; /* Réduit de 20px à 15px */
    padding-bottom: 15px; /* Réduit de 25px à 15px */
}

/* Espacement réduit dans le modal de temps */
.modal-body {
    max-height: 70vh; /* Réduit pour éviter le scroll */
    overflow-y: auto;
    padding-right: 6px; /* Réduit de 8px */
}

/* Ajustement de l'affichage du temps sélectionné */
#selected-time-display {
    font-size: var(--font-size-2xl); /* Réduit de var(--font-size-3xl) */
    margin: 10px 0; /* Réduit */
}

#total-seconds-display {
    font-size: var(--font-size-sm); /* Réduit */
}

/* Boutons plus compacts */
.modal-content button {
    padding: 14px 12px; /* Réduit de 18px */
    margin-top: 15px; /* Réduit */
}

        /* ==================== STYLES POUR LE MODAL DE THÈME ==================== */
        .theme-options-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .theme-option {
            background: var(--card-bg);
            border-radius: var(--radius-sm);
            padding: 15px;
            border: 2px solid var(--border);
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            text-align: center;
        }

        .theme-option:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
            border-color: var(--primary);
        }

        .theme-option.selected {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }

        .theme-preview {
            width: 100%;
            height: 60px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: var(--shadow);
        }

        .theme-name {
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .theme-check {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 24px;
            height: 24px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            opacity: 0;
            transform: scale(0.8);
            transition: var(--transition);
        }

        .theme-option.selected .theme-check {
            opacity: 1;
            transform: scale(1);
        }

    </style>
</head>
<body>
    <div class="app-container">
        <!-- HEADER -->
        <div class="header">
            <div class="header-left">
                <div class="user-avatar" onclick="showScreen('profile-screen')" id="user-avatar">JD</div>
                <h1 class="app-title">IRON</h1>
            </div>
            <div class="header-actions">
                <button class="icon-btn" onclick="showSettingsModal()" title="Paramètres">
                    <i class="fas fa-cog"></i>
                </button>
                <button class="icon-btn primary" onclick="showCreateWorkoutModal()" title="Créer une séance">
                    <i class="fas fa-dumbbell"></i>
                </button>
                <button class="icon-btn success" onclick="showAddMealModal()" title="Ajouter un repas">
                    <i class="fas fa-utensils"></i>
                </button>
                <button class="icon-btn" onclick="toggleTheme()" title="Changer de thème">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </div>
        
        <!-- CONTENU PRINCIPAL -->
        <div class="main-content">
            <!-- ÉCRAN D'ACCUEIL -->
            <div id="home-screen" class="screen active">
                <!-- PROFIL UTILISATEUR -->
                <div class="profile-section">
                    <div class="profile-header">
                        <div class="profile-avatar" id="profile-avatar">JD</div>
                        <div class="profile-info">
                            <h2 id="profile-name">John Doe</h2>
                            <p id="profile-level">Intermédiaire • Maintien</p>
                        </div>
                    </div>
                    <div class="profile-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="profile-height">180cm</div>
                            <div class="stat-label">Taille</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="profile-weight">75kg</div>
                            <div class="stat-label">Poids</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="profile-bmi">23.1</div>
                            <div class="stat-label">IMC</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="profile-category">Normal</div>
                            <div class="stat-label">Catégorie</div>
                        </div>
                    </div>
                    <div class="nutrition-section">
                        <div class="nutrition-calories-card">
                            <div class="nutrition-calories-value" id="profile-calories">2500 kcal</div>
                            <div class="nutrition-calories-label">Besoins caloriques quotidiens</div>
                        </div>
                        <div class="macros-grid">
                            <div class="macro-item">
                                <div class="macro-value protein" id="profile-protein">150g</div>
                                <div class="macro-label">Protéines</div>
                            </div>
                            <div class="macro-item">
                                <div class="macro-value carbs" id="profile-carbs">300g</div>
                                <div class="macro-label">Glucides</div>
                            </div>
                            <div class="macro-item">
                                <div class="macro-value fat" id="profile-fat">70g</div>
                                <div class="macro-label">Lipides</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ENTRAÎNEMENTS RAPIDES -->
                <h2 class="section-title">
                    <i class="fas fa-bolt"></i>
                    Entraînements Rapides
                </h2>
                
                <div class="workout-card" onclick="startPredefinedWorkoutFromHome('fullbody_beginner')">
                    <div class="workout-name">Full Body Débutant</div>
                    <div class="workout-description">Circuit complet pour débutants</div>
                    <div class="workout-duration">
                        <i class="far fa-clock"></i>
                        60 min • 8 exercices
                    </div>
                </div>
                
                <div class="workout-card" style="background: var(--gradient-success);" onclick="startPredefinedWorkoutFromHome('push_day')">
                    <div class="workout-name">Push Day</div>
                    <div class="workout-description">Pectoraux, Épaules, Triceps</div>
                    <div class="workout-duration">
                        <i class="far fa-clock"></i>
                        75 min • 7 exercices
                    </div>
                </div>
                
                <div class="workout-card" style="background: var(--gradient-primary);" onclick="startPredefinedWorkoutFromHome('pull_day')">
                    <div class="workout-name">Pull Day</div>
                    <div class="workout-description">Dos, Biceps, Arrière épaules</div>
                    <div class="workout-duration">
                        <i class="far fa-clock"></i>
                        75 min • 6 exercices
                    </div>
                </div>

                <div class="workout-card" style="background: linear-gradient(135deg, #8B5CF6, #EC4899);" onclick="startPredefinedWorkoutFromHome('legs_day')">
                    <div class="workout-name">Leg Day</div>
                    <div class="workout-description">Jambes complètes</div>
                    <div class="workout-duration">
                        <i class="far fa-clock"></i>
                        80 min • 8 exercices
                    </div>
                </div>

                <!-- PROGRAMMES RECOMMANDÉS -->
                <div class="component-box">
                    <div class="component-box-title">
                        <i class="fas fa-star"></i>
                        Programmes Recommandés
                    </div>
                    <div class="component-box-content" id="recommended-programs">
                        <!-- Programmes générés dynamiquement -->
                    </div>
                </div>

                <!-- GROUPES MUSCULAIRES -->
                <h2 class="section-title">
                    <i class="fas fa-dumbbell"></i>
                    Groupes Musculaires
                </h2>
                
                <div class="muscle-grid" id="muscle-grid-container">
                    <!-- Généré dynamiquement par loadMuscleGroups() -->
                </div>
            </div>
            
            <!-- ÉCRAN DES EXERCICES -->
            <div id="exercises-screen" class="screen">
                <div class="radio-tabs">
                    <button class="radio-tab active" onclick="showExerciseTab('exercises')">🏋️‍♂️ Exercices</button>
                    <button class="radio-tab" onclick="showExerciseTab('foods')">🥦 Aliments</button>
                </div>
                
                <div id="exercise-tab">
                    <!-- Recherche Avancée Display -->
                    <div class="advanced-search-display" id="advanced-search-display-exercises" style="display: none;">
                        <div class="advanced-search-display-title">Filtres Actifs</div>
                        <div class="advanced-search-display-filters" id="advanced-search-active-filters">
                            <!-- Filtres actifs seront affichés ici -->
                        </div>
                        <div class="advanced-search-display-actions">
                            <button class="btn btn-info" onclick="showAdvancedSearchModal()">
                                <i class="fas fa-filter"></i> Modifier
                            </button>
                            <button class="btn btn-secondary" onclick="clearSearchFilters()">
                                <i class="fas fa-times"></i> Effacer
                            </button>
                        </div>
                    </div>
                    
                    <!-- Boutons d'action -->
                    <div class="delete-all-btn-container">
                        <button class="btn btn-info" onclick="showAdvancedSearchModal()" style="flex: 1;">
                            <i class="fas fa-filter"></i> Recherche Avancée
                        </button>
                        <button class="btn btn-danger" onclick="showDeleteAllExercisesModal()" style="flex: 1;">
                            <i class="fas fa-trash"></i> Tout supprimer
                        </button>
                    </div>
                    
                    <!-- Barre de recherche -->
                    <div class="search-container">
                        <input type="text" class="search-input" placeholder="🔍 Rechercher un exercice..." onkeyup="filterExercises()" id="search-input">
                    </div>
                    
                    <!-- Filtres -->
                    <select class="filter-select" onchange="setMuscleFilter(this.value)" id="muscle-filter">
    <option value="all">Tous les exercices</option>
    <option value="custom">Personnalisés</option>
    <option value="favorites">Favoris</option>
    <!-- Options générées dynamiquement -->
</select>
                    
                    <!-- Bouton créer exercice -->
                    <button class="add-exercise-btn" onclick="showCustomExerciseModal()">
                        <i class="fas fa-plus"></i> Créer un nouvel exercice
                    </button>
                    
                    <!-- Liste des exercices -->
                    <div id="exercises-list">
                        <!-- Liste générée dynamiquement -->
                    </div>
                </div>
                
                <div id="food-tab" class="hidden">
                    <!-- Recherche Avancée Display -->
                    <div class="advanced-search-display" id="advanced-search-display-foods" style="display: none;">
                        <div class="advanced-search-display-title">Filtres Actifs</div>
                        <div class="advanced-search-display-filters" id="advanced-search-active-filters-food">
                            <!-- Filtres actifs seront affichés ici -->
                        </div>
                        <div class="advanced-search-display-actions">
                            <button class="btn btn-info" onclick="showAdvancedSearchModalFood()">
                                <i class="fas fa-filter"></i> Modifier
                            </button>
                            <button class="btn btn-secondary" onclick="clearSearchFiltersFood()">
                                <i class="fas fa-times"></i> Effacer
                            </button>
                        </div>
                    </div>
                    
                    <!-- Boutons d'action -->
                    <div class="delete-all-btn-container">
                        <button class="btn btn-info" onclick="showAdvancedSearchModalFood()" style="flex: 1;">
                            <i class="fas fa-filter"></i> Recherche Avancée
                        </button>
                        <button class="btn btn-danger" onclick="showDeleteAllFoodsModal()" style="flex: 1;">
                            <i class="fas fa-trash"></i> Tout supprimer
                        </button>
                    </div>
                    
                    <!-- Barre de recherche -->
                    <div class="search-container">
                        <input type="text" class="search-input" placeholder="🔍 Rechercher un aliment..." onkeyup="filterFoods()" id="food-search-input">
                    </div>
                    
                    <!-- Filtres -->
                    <select class="filter-select" onchange="setFoodCategoryFilter(this.value)" id="food-category-filter">
    <option value="all">Toutes les catégories</option>
    <option value="personnalisé">Personnalisés</option>
    <option value="halal">Halal</option>
    <option value="favorites">Favoris</option>
    <!-- Options générées dynamiquement -->
</select>
                    
                    <!-- Bouton ajouter aliment -->
                    <button class="add-exercise-btn" onclick="showAddFoodModal()">
                        <i class="fas fa-plus"></i> Ajouter un aliment
                    </button>
                    
                    <!-- Liste des aliments -->
                    <div id="foods-list">
                        <!-- Liste générée dynamiquement -->
                    </div>
                </div>
            </div>
            
            <!-- ÉCRAN DES SÉANCES -->
            <div id="workouts-screen" class="screen">
                <h2 class="section-title">📋 Mes Séances</h2>
                <div id="custom-workouts-list">
                    <!-- Séances personnalisées générées dynamiquement -->
                </div>
                
                <h2 class="section-title" style="margin-top: 30px;">💪 Séances Prédéfinies</h2>
<!-- MODIFICATION: Section exercices favoris -->
<div class="card" style="margin-top: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 style="margin: 0;">⭐ Exercices Favoris</h3>
        <button class="action-btn" onclick="refreshFavoriteExercises()">
            <i class="fas fa-sync-alt"></i> Actualiser
        </button>
    </div>
    <div class="favorite-foods-grid" id="favorite-exercises-container">
        <!-- Exercices favoris générés dynamiquement -->
    </div>
</div>
                <div id="predefined-workouts-container">
                    <!-- Séances prédéfinies générées dynamiquement -->
                </div>
            </div>
            
            <!-- ÉCRAN PROFIL -->
            <div id="profile-screen" class="screen">
                <h2 class="section-title">👤 Mon Profil</h2>
                <div class="card">
                    <div class="input-group">
                        <div class="input-label">Prénom (pour initiales)</div>
                        <input type="text" class="number-input" id="profile-firstname" value="John" oninput="updateAvatarInitials(); calculateNutritionNeeds()">
                    </div>
                    <div class="input-group" style="margin-top: 14px;">
                        <div class="input-label">Nom (pour initiales)</div>
                        <input type="text" class="number-input" id="profile-lastname" value="Doe" oninput="updateAvatarInitials()">
                    </div>
                    <div class="input-group" style="margin-top: 14px;">
                        <div class="input-label">Taille (cm)</div>
                        <input type="number" class="number-input" id="profile-height-input" value="180" oninput="calculateNutritionNeeds()">
                    </div>
                    <div class="input-group" style="margin-top: 14px;">
                        <div class="input-label">Poids (kg)</div>
                        <input type="number" class="number-input" id="profile-weight-input" value="75" oninput="calculateNutritionNeeds()">
                    </div>
                    
                    <h3 style="margin: 18px 0 10px; color: var(--text-primary); font-size: var(--font-size-base);">⚙️ Paramètres d'entraînement par défaut</h3>
                    
                    <div class="input-group" style="margin-top: 14px;">
                        <div class="input-label">Répétitions par défaut</div>
                        <input type="text" class="number-input" id="profile-default-reps" value="10">
                    </div>
                    <div class="input-group" style="margin-top: 14px;">
                        <div class="input-label">Poids par défaut (kg)</div>
                        <input type="number" class="number-input" id="profile-default-weight" value="10">
                    </div>
                    <div class="input-group" style="margin-top: 14px;">
                        <div class="input-label">Temps de repos par défaut (secondes)</div>
                        <input type="number" class="number-input" id="profile-default-rest" value="60">
                    </div>
                    <div class="input-group" style="margin-top: 14px;">
                        <div class="input-label">Séries par défaut</div>
                        <input type="number" class="number-input" id="profile-default-sets" value="3">
                    </div>
                    
                    <div class="input-group" style="margin-top: 14px;">
                        <div class="input-label">Niveau</div>
                        <select class="filter-select" id="profile-level-input" onchange="calculateNutritionNeeds()">
                            <option value="Débutant complet">Débutant complet</option>
                            <option value="Débutant">Débutant</option>
                            <option value="Intermédiaire débutant">Intermédiaire débutant</option>
                            <option value="Intermédiaire" selected>Intermédiaire</option>
                            <option value="Intermédiaire avancé">Intermédiaire avancé</option>
                            <option value="Avancé">Avancé</option>
                            <option value="Expert">Expert</option>
                            <option value="Professionnel">Professionnel</option>
                        </select>
                    </div>
                    <div class="input-group" style="margin-top: 14px;">
                        <div class="input-label">Type d'entraînement</div>
                        <select class="filter-select" id="profile-type-input" onchange="calculateNutritionNeeds()">
                            <option value="Force pure">Force pure</option>
                            <option value="Force">Force</option>
                            <option value="Volume musculaire">Volume musculaire</option>
                            <option value="Hypertrophie">Hypertrophie</option>
                            <option value="Endurance musculaire">Endurance musculaire</option>
                            <option value="Cardio">Cardio</option>
                            <option value="Perte de poids">Perte de poids</option>
                            <option value="Maintien" selected>Maintien</option>
                            <option value="Récupération">Récupération</option>
                            <option value="Préparation physique">Préparation physique</option>
                        </select>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn btn-success" onclick="saveProfile()" style="flex: 1;">💾 Sauvegarder</button>
                        <button class="btn btn-danger" onclick="resetProfile()" style="flex: 1;">🔄 Réinitialiser</button>
                    </div>
                    
                    <!-- Import/Export -->
                    <div class="import-export-section" style="margin-top: 20px;">
                        <button class="import-export-btn import-btn" onclick="importData()">
                            <i class="fas fa-file-import"></i> Importer
                        </button>
                        <button class="import-export-btn export-btn" onclick="exportData()">
                            <i class="fas fa-file-export"></i> Exporter
                        </button>
                    </div>
                </div>
            </div>

            <!-- ÉCRAN HISTORIQUE -->
            <div id="history-screen" class="screen">
                <div class="history-tabs">
                    <div class="history-tab active" onclick="showHistoryTab('workouts')">🏋️‍♂️ Séances</div>
                    <div class="history-tab" onclick="showHistoryTab('nutrition')">🍽️ Nutrition</div>
                </div>
                
                <!-- Historique des séances -->
                <div id="workout-history-tab">
                    <!-- Boutons de vue -->
                    <div class="history-view-toggle">
                        <button class="history-view-toggle-btn active" onclick="showWorkoutHistoryView('list')">
                            <i class="fas fa-list"></i> Liste
                        </button>
                        <button class="history-view-toggle-btn" onclick="showWorkoutHistoryView('evolution')">
                            <i class="fas fa-chart-line"></i> Graphique
                        </button>
                        <button class="history-view-toggle-btn" onclick="showWorkoutHistoryView('exercises')">
                            <i class="fas fa-dumbbell"></i> Exercices
                        </button>
                    </div>
                    
                    <!-- Vue Liste -->
                    <div id="workout-history-list">
                        <div class="component-box">
                            <div class="component-box-title" style="justify-content: space-between;">
                                <span>Historique des Séances</span>
                                <button class="action-btn" onclick="showClearHistoryModal()">
                                    <i class="fas fa-trash"></i> Tout supprimer
                                </button>
                            </div>
                            <div class="component-box-content">
                                <div id="workout-history">
                                    <!-- Historique généré dynamiquement -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Vue Graphique -->
                    <div id="workout-history-evolution" class="hidden">
                        <div class="chart-container">
                            <div class="chart-title">Évolution des performances</div>
                            <div id="evolution-chart" class="chart-wrapper">
                                <!-- Graphique généré dynamiquement -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Vue Exercices -->
                    <div id="workout-history-exercises" class="hidden">
                        <div class="chart-container">
                            <div class="chart-title">Performances par type d'exercice</div>
                            <div id="exercises-chart" class="chart-wrapper">
                                <!-- Graphique généré dynamiquement -->
                            </div>
                        </div>
                        <div id="exercises-detailed-list" style="margin: 0 20px;">
                            <!-- Liste détaillée des exercices -->
                        </div>
                    </div>
                </div>
                
                <!-- Historique nutrition -->
                <div id="nutrition-history-tab" class="hidden">
                    <div class="history-nav-buttons">
                        <button class="history-nav-btn active" onclick="showNutritionHistoryView('day')">📅 Jour</button>
                        <button class="history-nav-btn" onclick="showNutritionHistoryView('week')">📅 Semaine</button>
                        <button class="history-nav-btn" onclick="showNutritionHistoryView('month')">📅 Mois</button>
                    </div>
                    
                    <div class="component-box">
                        <div class="component-box-title" style="justify-content: space-between;">
                            <span>Historique Nutrition</span>
                            <button class="action-btn" onclick="showClearNutritionHistoryModal()">
                                <i class="fas fa-trash"></i> Tout supprimer
                            </button>
                        </div>
                        <div class="component-box-content">
                            <div id="nutrition-history">
                                <!-- Historique nutrition généré dynamiquement -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ÉCRAN NUTRITION -->
            <div id="nutrition-screen" class="screen">
                <h2 class="section-title">
                    <i class="fas fa-apple-alt"></i>
                    Suivi Nutrition
                </h2>
                
                <!-- Carte des calories du jour -->
                <div class="nutrition-calories-card">
                    <div class="nutrition-calories-value" id="daily-calories">0/2500 kcal</div>
                    <div class="nutrition-calories-label">Apport calorique aujourd'hui</div>
                    <div id="calories-balance" class="calories-balance positive">+2500 kcal restantes</div>
                    <div class="calories-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="calories-progress" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- Statistiques macros -->
                <div class="card">
                    <h3>📊 Macronutriments du jour</h3>
                    <div class="macros-grid">
                        <div class="macro-item">
                            <div class="macro-value protein" id="daily-protein">0g</div>
                            <div class="macro-label">Protéines</div>
                            <div class="macro-target" id="protein-target">/150g</div>
                            <div id="protein-remaining" class="macro-remaining positive">+150g restants</div>
                        </div>
                        <div class="macro-item">
                            <div class="macro-value carbs" id="daily-carbs">0g</div>
                            <div class="macro-label">Glucides</div>
                            <div class="macro-target" id="carbs-target">/300g</div>
                            <div id="carbs-remaining" class="macro-remaining positive">+300g restants</div>
                        </div>
                        <div class="macro-item">
                            <div class="macro-value fat" id="daily-fat">0g</div>
                            <div class="macro-label">Lipides</div>
                            <div class="macro-target" id="fat-target">/70g</div>
                            <div id="fat-remaining" class="macro-remaining positive">+70g restants</div>
                        </div>
                    </div>
                </div>

                <!-- Repas de la journée -->
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px;">
                        <h3 style="margin: 0;">🍽️ Repas du jour</h3>
                        <button class="btn btn-success" onclick="showAddMealModal()">
                            <i class="fas fa-plus"></i> Ajouter repas
                        </button>
                    </div>
                    
                    <div class="meals-list-container" id="meals-list">
                        <!-- Repas générés dynamiquement -->
                    </div>
                </div>

                <!-- Aliments fréquents -->
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0;">⭐ Aliments Favoris</h3>
                        <button class="action-btn" onclick="refreshFavoriteFoods()">
                            <i class="fas fa-sync-alt"></i> Actualiser
                        </button>
                    </div>
                    <div class="favorite-foods-grid" id="favorite-foods-container">
                        <!-- Aliments favoris générés dynamiquement -->
                    </div>
                </div>
            </div>
            
            <!-- ÉCRAN D'ENTRAÎNEMENT ACTIF -->
            <div id="active-workout-screen" class="screen">
                <div class="workout-header">
                    <h2 id="active-workout-name">Full Body</h2>
                </div>
                
                <div class="workout-timer-container">
                    <div class="workout-stat-side">
                        <div class="workout-stat-side-value" id="completed-sets">0</div>
                        <div class="workout-stat-side-label">Séries</div>
                    </div>
                    <div class="workout-timer" id="workout-timer">00:00:00</div>
                    <div class="workout-stat-side">
                        <div class="workout-stat-side-value" id="total-weight">0kg</div>
                        <div class="workout-stat-side-label">Poids Total</div>
                    </div>
                </div>
                
                <div class="workout-container" id="workout-exercises-container">
                    <!-- Exercices générés dynamiquement -->
                </div>
                
                <div class="controls" style="padding: 0 20px;">
                    <button class="btn btn-success" onclick="showSaveDataModal()">Terminer l'entraînement</button>
                    <button class="add-exercise-btn mt-4" onclick="addExerciseToWorkout()">Ajouter un exercice</button>
                </div>
            </div>
        </div>

        <!-- TIMER -->
        <div class="timer-container" id="timer-container">
            <div class="timer-display" id="timer-display">01:30</div>
            <div class="timer-progress-container">
                <div class="timer-progress-bar" id="timer-progress-bar"></div>
            </div>
            <div class="timer-controls">
                <button class="timer-btn timer-start" id="timer-toggle-btn" onclick="toggleTimer()">Démarrer</button>
                <button class="timer-btn timer-adjust" onclick="adjustTimer(-15)">-15s</button>
                <button class="timer-btn timer-adjust" onclick="adjustTimer(15)">+15s</button>
                <button class="timer-btn timer-close" onclick="closeTimerWithSupersetCheck()">Fermer</button>
            </div>
        </div>
    </div>

    <!-- LOADING INDICATOR -->
    <div class="loading-indicator" id="loading-indicator">
        <div class="loading-spinner"></div>
    </div>

    <!-- NAVBAR -->
    <div class="navbar-container">
        <div class="navbar">
            <div class="nav-item active" onclick="showScreen('home-screen')">
                <div class="nav-icon"><i class="fas fa-home"></i></div>
                <div class="nav-text">Accueil</div>
            </div>
            <div class="nav-item" onclick="showScreen('workouts-screen')">
                <div class="nav-icon"><i class="fas fa-dumbbell"></i></div>
                <div class="nav-text">Séances</div>
            </div>
            <div class="nav-item" onclick="showScreen('exercises-screen')">
                <div class="nav-icon"><i class="fas fa-running"></i></div>
                <div class="nav-text">Exercices</div>
            </div>
            <div class="nav-item" onclick="showScreen('history-screen')">
                <div class="nav-icon"><i class="fas fa-chart-line"></i></div>
                <div class="nav-text">Historique</div>
            </div>
            <div class="nav-item" onclick="showScreen('nutrition-screen')">
                <div class="nav-icon"><i class="fas fa-apple-alt"></i></div>
                <div class="nav-text">Nutrition</div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <!-- MODAL CRÉATION SÉANCE - AMÉLIORÉ -->
    <div class="modal" id="create-workout-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Créer une séance</h3>
                <button class="modal-close" onclick="hideModal('create-workout-modal'); resetCreateWorkoutModal()">×</button>
            </div>
            <div class="modal-body">
                <input type="text" id="workout-name" placeholder="Nom de la séance" class="number-input" style="width: 100%; margin-bottom: 14px;">
                
                <div class="food-search-btn-container">
                    <button class="btn food-search-btn" onclick="showExerciseSelectionForCreate()">🏃 Choisir exercice</button>
                    <button class="btn food-search-btn btn-success" onclick="showCustomExerciseModalForCreate()">Créer exercice</button>
                </div>
                
                <div id="workout-exercises-selection">
                    <!-- Exercices à ajouter - Afficher l'ordre -->
                </div>
                
                <button class="btn btn-success" onclick="saveCustomWorkout()" style="width: 100%; margin-top: 14px; margin-bottom: 10px;">💾 Sauvegarder la séance</button>
            </div>
        </div>
    </div>

    <!-- MODAL MODIFICATION SÉANCE - AMÉLIORÉ -->
    <div class="modal" id="edit-workout-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">✏️ Modifier la séance</h3>
                <button class="modal-close" onclick="hideModal('edit-workout-modal')">×</button>
            </div>
            <div class="modal-body">
                <input type="text" id="edit-workout-name" placeholder="Nom de la séance" class="number-input" style="width: 100%; margin-bottom: 14px;">
                
                <div class="food-search-btn-container">
                    <button class="btn food-search-btn" onclick="showExerciseSelectionForEdit()">🏃 Choisir exercice</button>
                    <button class="btn food-search-btn btn-success" onclick="showCustomExerciseModalForEdit()">Créer exercice</button>
                </div>
                
                <div id="edit-workout-exercises-selection">
                    <!-- Exercices à modifier - Avec boutons de réorganisation -->
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 14px; margin-bottom: 10px;">
                    <button class="btn btn-success" onclick="saveEditedWorkout()" style="flex: 1;">💾 Sauvegarder</button>
                    <button class="btn btn-warning" onclick="duplicateWorkout()" style="flex: 1;">📋 Dupliquer</button>
                    <button class="btn btn-danger" onclick="deleteEditedWorkout()" style="flex: 1;">🗑️ Supprimer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL SÉLECTION EXERCICE -->
    <div class="modal" id="select-exercise-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">🏃 Choisir un exercice</h3>
                <button class="modal-close" onclick="hideModal('select-exercise-modal')">×</button>
            </div>
            <div class="modal-body">
                <input type="text" class="number-input" placeholder="🔍 Rechercher un exercice..." onkeyup="filterExerciseSelection(this.value)" style="width: 100%; margin-bottom: 14px;">
                <select class="filter-select" onchange="filterExerciseSelectionByMuscle(this.value)" id="exercise-filter">
                    <option value="all">Tous les groupes musculaires</option>
                    <!-- Options générées dynamiquement -->
                </select>
                <div id="exercise-selection-list" style="max-height: 300px; overflow-y: auto;">
                    <!-- Liste des exercices pour sélection -->
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL CRÉATION EXERCICE PERSONNALISÉ - AMÉLIORÉ -->
    <div class="modal" id="custom-exercise-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">➕ Créer un exercice</h3>
                <button class="modal-close" onclick="hideModal('custom-exercise-modal')">×</button>
            </div>
            <div class="modal-body">
                <div class="input-group" style="margin-bottom: 14px;">
                    <div class="input-label">Nom de l'exercice</div>
                    <input type="text" class="number-input" id="custom-exercise-name" placeholder="Ex: Développé couché maison">
                </div>
                <div class="input-group" style="margin-bottom: 14px;">
                    <div class="input-label">Groupe musculaire</div>
                    <select class="filter-select" id="custom-exercise-muscle">
                        <option value="">Sélectionner un groupe</option>
                        <!-- Options générées dynamiquement -->
                    </select>
                </div>
                <div class="input-group" style="margin-bottom: 14px;">
                    <div class="input-label">Catégorie</div>
                    <select class="filter-select" id="custom-exercise-category">
                        <option value="">Sélectionner une catégorie</option>
                        <option value="force">Force</option>
                        <option value="isolation">Isolation</option>
                        <option value="endurance">Endurance</option>
                        <option value="cardio">Cardio</option>
                        <option value="polyarticulaire">Polyarticulaire</option>
                        <option value="monoarticulaire">Monoarticulaire</option>
                        <option value="stabilisation">Stabilisation</option>
                        <option value="mobilité">Mobilité</option>
                    </select>
                </div>
                <div class="input-group" style="margin-bottom: 14px;">
                    <div class="input-label">Niveau</div>
                    <select class="filter-select" id="custom-exercise-difficulty">
                        <option value="Débutant">Débutant</option>
                        <option value="Intermédiaire">Intermédiaire</option>
                        <option value="Avancé">Avancé</option>
                    </select>
                </div>
                <div class="input-group" style="margin-bottom: 14px;">
                    <div class="input-label">Équipement (séparé par des virgules)</div>
                    <input type="text" class="number-input" id="custom-exercise-equipment" placeholder="Ex: Barre, Banc, Poids">
                </div>
                <div class="input-group" style="margin-bottom: 14px; display: flex; align-items: center; gap: 10px;">
                    <div class="input-label" style="margin: 0;">Favori</div>
                    <div class="checkbox" id="custom-exercise-favorite" onclick="toggleFavoriteCheckbox(this)">
                        <div class="checkmark">✓</div>
                    </div>
                </div>
                <button class="btn btn-success" onclick="addCustomExercise()" style="width: 100%; margin-bottom: 10px;">➕ Ajouter l'exercice</button>
            </div>
        </div>
    </div>

    <!-- MODAL SUPPRIMER HISTORIQUE -->
    <div class="modal" id="clear-history-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">🗑️ Supprimer l'historique</h3>
                <button class="modal-close" onclick="hideModal('clear-history-modal')">×</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 18px; color: var(--text-primary);">Êtes-vous sûr de vouloir supprimer TOUT l'historique ? Cette action est irréversible.</p>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-danger" onclick="clearAllHistory()" style="flex: 1;">Oui, tout supprimer</button>
                    <button class="btn btn-secondary" onclick="hideModal('clear-history-modal')" style="flex: 1;">Annuler</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL SUPPRIMER TOUS LES EXERCICES -->
    <div class="modal" id="delete-all-exercises-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">⚠️ Supprimer tous les exercices personnalisés</h3>
                <button class="modal-close" onclick="hideModal('delete-all-exercises-modal')">×</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 18px; color: var(--text-primary);">Cette action supprimera TOUS vos exercices personnalisés. Cette action est irréversible.</p>
                <p style="margin-bottom: 18px; color: var(--danger); font-weight: 700;">Voulez-vous vraiment continuer ?</p>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-danger" onclick="confirmDeleteAllExercises()" style="flex: 1;">Oui, tout supprimer</button>
                    <button class="btn btn-secondary" onclick="hideModal('delete-all-exercises-modal')" style="flex: 1;">Annuler</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL SUPPRIMER TOUS LES ALIMENTS -->
    <div class="modal" id="delete-all-foods-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">⚠️ Supprimer tous les aliments personnalisés</h3>
                <button class="modal-close" onclick="hideModal('delete-all-foods-modal')">×</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 18px; color: var(--text-primary);">Cette action supprimera TOUS vos aliments personnalisés. Cette action est irréversible.</p>
                <p style="margin-bottom: 18px; color: var(--danger); font-weight: 700;">Voulez-vous vraiment continuer ?</p>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-danger" onclick="confirmDeleteAllFoods()" style="flex: 1;">Oui, tout supprimer</button>
                    <button class="btn btn-secondary" onclick="hideModal('delete-all-foods-modal')" style="flex: 1;">Annuler</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL DÉTAIL HISTORIQUE - AMÉLIORÉ -->
    <div class="modal" id="history-detail-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="history-detail-title">📋 Détail de la séance</h3>
                <button class="modal-close" onclick="hideModal('history-detail-modal')">×</button>
            </div>
            <div class="modal-body">
                <div class="modal-scrollable" id="history-detail-content">
                    <!-- Contenu généré dynamiquement -->
                </div>
            </div>
        </div>
    </div>

<!-- MODAL FICHE EXERCICE DÉTAILLÉE PREMIUM -->
<div class="modal" id="exercise-detail-modal">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h3 class="modal-title" id="exercise-detail-title">📋 Fiche Exercice</h3>
            <button class="modal-close" onclick="hideModal('exercise-detail-modal')">×</button>
        </div>
        <div class="modal-body">
            <div class="exercise-detail-modal-content" id="exercise-detail-content">
                <!-- Contenu généré dynamiquement -->
            </div>
        </div>
    </div>
</div>

    <!-- MODAL SUPPRIMER EXERCICE PERSONNALISÉ -->
    <div class="modal" id="delete-custom-exercise-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">🗑️ Supprimer l'exercice</h3>
                <button class="modal-close" onclick="hideModal('delete-custom-exercise-modal')">×</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 18px; color: var(--text-primary);" id="delete-exercise-message">Êtes-vous sûr de vouloir supprimer cet exercice ? Cette action est irréversible et supprimera également cet exercice de toutes les séances où il est utilisé.</p>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-danger" onclick="confirmDeleteCustomExercise()" style="flex: 1;">Oui, supprimer</button>
                    <button class="btn btn-secondary" onclick="hideModal('delete-custom-exercise-modal')" style="flex: 1;">Annuler</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL MODIFIER EXERCICE PERSONNALISÉ - AMÉLIORÉ -->
    <div class="modal" id="edit-custom-exercise-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">✏️ Modifier l'exercice</h3>
                <button class="modal-close" onclick="hideModal('edit-custom-exercise-modal')">×</button>
            </div>
            <div class="modal-body">
                <div class="input-group" style="margin-bottom: 14px;">
                    <div class="input-label">Nom de l'exercice</div>
                    <input type="text" class="number-input" id="edit-exercise-name" placeholder="Ex: Développé couché maison">
                </div>
                <div class="input-group" style="margin-bottom: 14px;">
                    <div class="input-label">Groupe musculaire</div>
                    <select class="filter-select" id="edit-exercise-muscle">
                        <option value="">Sélectionner un groupe</option>
                        <!-- Options générées dynamiquement -->
                    </select>
                </div>
                <div class="input-group" style="margin-bottom: 14px;">
                    <div class="input-label">Catégorie</div>
                    <select class="filter-select" id="edit-exercise-category">
                        <option value="">Sélectionner une catégorie</option>
                        <option value="force">Force</option>
                        <option value="isolation">Isolation</option>
                        <option value="endurance">Endurance</option>
                        <option value="cardio">Cardio</option>
                        <option value="polyarticulaire">Polyarticulaire</option>
                        <option value="monoarticulaire">Monoarticulaire</option>
                        <option value="stabilisation">Stabilisation</option>
                        <option value="mobilité">Mobilité</option>
                    </select>
                </div>
                <div class="input-group" style="margin-bottom: 14px;">
                    <div class="input-label">Niveau</div>
                    <select class="filter-select" id="edit-exercise-difficulty">
                        <option value="Débutant">Débutant</option>
                        <option value="Intermédiaire">Intermédiaire</option>
                        <option value="Avancé">Avancé</option>
                    </select>
                </div>
                <div class="input-group" style="margin-bottom: 14px;">
                    <div class="input-label">Équipement (séparé par des virgules)</div>
                    <input type="text" class="number-input" id="edit-exercise-equipment" placeholder="Ex: Barre, Banc, Poids">
                </div>
                <div class="input-group" style="margin-bottom: 14px; display: flex; align-items: center; gap: 10px;">
                    <div class="input-label" style="margin: 0;">Favori</div>
                    <div class="checkbox" id="edit-exercise-favorite" onclick="toggleFavoriteCheckbox(this)">
                        <div class="checkmark">✓</div>
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-success" onclick="saveEditedExercise()" style="flex: 1;">💾 Sauvegarder</button>
                    <button class="btn btn-secondary" onclick="hideModal('edit-custom-exercise-modal')" style="flex: 1;">Annuler</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL AJOUTER REPAS - OPTIMISÉ -->
    <div class="modal" id="add-meal-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">🍽️ Ajouter un repas</h3>
                <button class="modal-close" onclick="hideModal('add-meal-modal'); resetMealForm()">×</button>
            </div>
            <div class="modal-body">
                <div class="add-meal-modal-content">
                    <div class="input-group" style="margin-bottom: 14px;">
                        <div class="input-label">Nom du repas</div>
                        <input type="text" class="number-input" id="meal-name" placeholder="Ex: Petit-déjeuner">
                    </div>
                    
                    <div class="input-group" style="margin-bottom: 14px;">
                        <div class="input-label">Type de repas</div>
                        <div class="meal-type-options">
    <div class="meal-type-option active" data-value="petit-dejeuner" onclick="selectMealType('petit-dejeuner')">Petit-déjeuner</div>
    <div class="meal-type-option" data-value="dejeuner" onclick="selectMealType('dejeuner')">Déjeuner</div>
    <div class="meal-type-option" data-value="diner" onclick="selectMealType('diner')">Dîner</div>
    <div class="meal-type-option" data-value="collation" onclick="selectMealType('collation')">Collation</div>
</div>
<input type="hidden" id="meal-type" value="petit-dejeuner">
                    </div>

                    <h4 style="margin: 18px 0 10px; color: var(--text-primary);">Aliments</h4>
                    <div id="meal-foods-list" style="max-height: 200px; overflow-y: auto;">
                        <!-- Aliments ajoutés -->
                    </div>
                    
                    <div class="food-search-btn-container">
                        <button class="btn food-search-btn" onclick="showFoodSearchModalForMeal()">
                            <i class="fas fa-search"></i> Rechercher
                        </button>
                        <button class="btn food-search-btn" onclick="showAddFoodFromMeal('add')">
                            <i class="fas fa-plus"></i> Nouvel aliment
                        </button>
                    </div>
                    
                    <textarea class="number-input notes-wrap" id="meal-notes" placeholder="Notes (optionnel)" style="height: 70px; resize: vertical; margin-top: 14px;"></textarea>
                    
                    <button class="btn btn-success" onclick="saveMeal()" style="width: 100%; margin-top: 14px; margin-bottom: 10px;">💾 Sauvegarder le repas</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL AJOUTER ALIMENT -->
    <div class="modal" id="add-food-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">🥦 Ajouter un aliment</h3>
                <button class="modal-close" onclick="hideModal('add-food-modal'); resetFoodForm()">×</button>
            </div>
            <div class="modal-body">
                <div class="input-group" style="margin-bottom: 14px;">
                    <div class="input-label">Nom de l'aliment</div>
                    <input type="text" class="number-input" id="food-name" placeholder="Ex: Poulet grillé">
                </div>
                
                <div class="input-group" style="margin-bottom: 14px;">
                    <div class="input-label">Quantité de référence (g)</div>
                    <input type="number" class="number-input" id="food-quantity" value="100">
                </div>
                
                <div class="set-inputs-grid">
                    <div class="input-group">
                        <div class="input-label">Calories</div>
                        <input type="number" class="number-input" id="food-calories" placeholder="kcal">
                    </div>
                    <div class="input-group">
                        <div class="input-label">Protéines (g)</div>
                        <input type="number" class="number-input" id="food-protein" placeholder="0">
                    </div>
                    <div class="input-group">
                        <div class="input-label">Glucides (g)</div>
                        <input type="number" class="number-input" id="food-carbs" placeholder="0">
                    </div>
                    <div class="input-group">
                        <div class="input-label">Lipides (g)</div>
                        <input type="number" class="number-input" id="food-fat" placeholder="0">
                    </div>
                </div>
                
                <div class="input-group" style="margin-top: 14px;">
                    <div class="input-label">Catégorie</div>
                    <select class="filter-select" id="food-category">
                        <option value="viande">Viande</option>
                        <option value="poisson">Poisson</option>
                        <option value="legume">Légume</option>
                        <option value="fruit">Fruit</option>
                        <option value="cereale">Céréale</option>
                        <option value="produit-laitier">Produit laitier</option>
                        <option value="personnalisé">Personnalisé</option>
                        <option value="autre">Autre</option>
                    </select>
                </div>
                
                <div class="input-group" style="margin-top: 14px;">
                    <div class="input-label">Halal</div>
                    <div class="checkbox" id="food-halal" onclick="toggleCheckbox(this)">
                        <div class="checkmark">✓</div>
                    </div>
                </div>
                
                <div class="input-group" style="margin-top: 14px;">
                    <div class="input-label">Favori</div>
                    <div class="checkbox" id="food-favorite" onclick="toggleCheckbox(this)">
                        <div class="checkmark">✓</div>
                    </div>
                </div>
                
                <div class="input-group" style="margin-top: 14px;">
                    <div class="input-label">Calcul automatique des calories</div>
                        <button type="button" class="btn btn-secondary" onclick="calculateCaloriesFromMacros()" style="width: 100%;">Calculer les calories</button>
                </div>
                
                <button class="btn btn-success" onclick="saveFood()" style="width: 100%; margin-top: 14px; margin-bottom: 10px;">
                    💾 Sauvegarder l'aliment
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL RECHERCHE ALIMENT -->
    <div class="modal" id="food-search-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">🔍 Rechercher un aliment</h3>
                <button class="modal-close" onclick="hideModal('food-search-modal')">×</button>
            </div>
            <div class="modal-body">
                <div class="input-group" style="margin-bottom: 14px;">
                    <div class="input-label">Nom de l'aliment</div>
                    <input type="text" class="number-input" id="food-search-input-simple" placeholder="Ex: Pomme, Poulet, Riz..." onkeyup="searchFoodsSimple(this.value)">
                </div>
                
                <div class="input-group" style="margin-bottom: 14px;">
                    <div class="input-label">Catégorie</div>
                    <select class="filter-select" id="food-search-category" onchange="searchFoodsSimple(document.getElementById('food-search-input-simple').value)">
                        <option value="all">Toutes les catégories</option>
                        <option value="personnalisé">Personnalisé</option>
                        <option value="halal">Halal</option>
                        <!-- Options générées dynamiquement -->
                    </select>
                </div>
                
                <div class="food-search-results" id="food-search-results-simple">
                    <!-- Résultats de recherche simplifiés générés dynamiquement -->
                </div>
                
                <div class="empty-state" id="food-search-empty-simple" style="display: none;">
                    <div class="empty-state-icon">🔍</div>
                    <p>Aucun aliment trouvé</p>
                    <p style="font-size: var(--font-size-sm); margin-top: 6px;">Essayez avec un autre terme ou créez un aliment personnalisé</p>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL SUPPRIMER HISTORIQUE NUTRITION -->
    <div class="modal" id="clear-nutrition-history-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">🗑️ Supprimer l'historique nutrition</h3>
                <button class="modal-close" onclick="hideModal('clear-nutrition-history-modal')">×</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 18px; color: var(--text-primary);">Êtes-vous sûr de vouloir supprimer TOUT l'historique nutrition ? Cette action est irréversible.</p>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-danger" onclick="clearAllNutritionHistory()" style="flex: 1;">Oui, tout supprimer</button>
                    <button class="btn btn-secondary" onclick="hideModal('clear-nutrition-history-modal')" style="flex: 1;">Annuler</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL MODIFIER REPAS - AMÉLIORÉ -->
    <div class="modal" id="edit-meal-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">✏️ Modifier un repas</h3>
                <button class="modal-close" onclick="hideModal('edit-meal-modal'); resetEditMealForm()">×</button>
            </div>
            <div class="modal-body">
                <div class="add-meal-modal-content">
                    <div class="input-group" style="margin-bottom: 14px;">
                        <div class="input-label">Nom du repas</div>
                        <input type="text" class="number-input" id="edit-meal-name" placeholder="Ex: Petit-déjeuner">
                    </div>
                    
                    <div class="input-group" style="margin-bottom: 14px;">
    <div class="input-label">Type de repas</div>
    <div class="meal-type-options" id="edit-meal-type-options">
        <div class="meal-type-option active" data-value="petit-dejeuner" onclick="selectEditMealType('petit-dejeuner')">Petit-déjeuner</div>
        <div class="meal-type-option" data-value="dejeuner" onclick="selectEditMealType('dejeuner')">Déjeuner</div>
        <div class="meal-type-option" data-value="diner" onclick="selectEditMealType('diner')">Dîner</div>
        <div class="meal-type-option" data-value="collation" onclick="selectEditMealType('collation')">Collation</div>
    </div>
    <input type="hidden" id="edit-meal-type" value="petit-dejeuner">
</div>

                    <h4 style="margin: 18px 0 10px; color: var(--text-primary);">Aliments</h4>
                    <div id="edit-meal-foods-list" style="max-height: 200px; overflow-y: auto;">
                        <!-- Aliments ajoutés -->
                    </div>
                    
                    <div class="food-search-btn-container">
                        <button class="btn food-search-btn" onclick="showFoodSearchModalForEdit()">
                            <i class="fas fa-search"></i> Rechercher
                        </button>
                        <button class="btn food-search-btn" onclick="showAddFoodFromMeal('edit')">
                            <i class="fas fa-plus"></i> Nouvel aliment
                        </button>
                    </div>
                    
                    <textarea class="number-input notes-wrap" id="edit-meal-notes" placeholder="Notes (optionnel)" style="height: 70px; resize: vertical; margin-top: 14px;"></textarea>
                    
                    <button class="btn btn-success" onclick="saveEditedMeal()" style="width: 100%; margin-top: 14px; margin-bottom: 10px;">💾 Sauvegarder les modifications</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL MODIFIER ALIMENT - AMÉLIORÉ -->
    <div class="modal" id="edit-custom-food-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">✏️ Modifier un aliment</h3>
                <button class="modal-close" onclick="hideModal('edit-custom-food-modal')">×</button>
            </div>
            <div class="modal-body">
                <div class="input-group" style="margin-bottom: 14px;">
                    <div class="input-label">Nom de l'aliment</div>
                    <input type="text" class="number-input" id="edit-food-name" placeholder="Ex: Poulet grillé maison">
                </div>
                
                <div class="input-group" style="margin-bottom: 14px;">
                    <div class="input-label">Quantité de référence (g)</div>
                    <input type="number" class="number-input" id="edit-food-quantity" value="100">
                </div>
                
                <div class="set-inputs-grid">
                    <div class="input-group">
                        <div class="input-label">Calories</div>
                        <input type="number" class="number-input" id="edit-food-calories" placeholder="kcal">
                    </div>
                    <div class="input-group">
                        <div class="input-label">Protéines (g)</div>
                        <input type="number" class="number-input" id="edit-food-protein" placeholder="0">
                    </div>
                    <div class="input-group">
                        <div class="input-label">Glucides (g)</div>
                        <input type="number" class="number-input" id="edit-food-carbs" placeholder="0">
                    </div>
                    <div class="input-group">
                        <div class="input-label">Lipides (g)</div>
                        <input type="number" class="number-input" id="edit-food-fat" placeholder="0">
                    </div>
                </div>
                
                <div class="input-group" style="margin-top: 14px;">
                    <div class="input-label">Catégorie</div>
                    <select class="filter-select" id="edit-food-category">
                        <option value="">Sélectionner une catégorie</option>
                        <option value="viande">Viande</option>
                        <option value="poisson">Poisson</option>
                        <option value="legume">Légume</option>
                        <option value="fruit">Fruit</option>
                        <option value="cereale">Céréale</option>
                        <option value="produit-laitier">Produit laitier</option>
                        <option value="personnalisé">Personnalisé</option>
                        <option value="halal">Halal</option>
                        <option value="autre">Autre</option>
                    </select>
                </div>
                
                <div class="input-group" style="margin-top: 14px; display: flex; align-items: center; gap: 10px;">
                    <div class="input-label" style="margin: 0;">Halal</div>
                    <div class="checkbox" id="edit-food-halal" onclick="toggleCheckbox(this)">
                        <div class="checkmark">✓</div>
                    </div>
                </div>
                
                <div class="input-group" style="margin-top: 14px; display: flex; align-items: center; gap: 10px;">
                    <div class="input-label" style="margin: 0;">Favori</div>
                    <div class="checkbox" id="edit-food-favorite" onclick="toggleCheckbox(this)">
                        <div class="checkmark">✓</div>
                    </div>
                </div>
                
                <div class="input-group" style="margin-top: 14px;">
                    <div class="input-label">Calcul automatique des calories</div>
                    <button type="button" class="btn btn-secondary" onclick="calculateEditCaloriesFromMacros()" style="width: 100%;">Calculer les calories</button>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 14px;">
                    <button class="btn btn-success" onclick="saveEditedFood()" style="flex: 1;">💾 Sauvegarder</button>
                    <button class="btn btn-danger" onclick="deleteFood()" style="flex: 1;">🗑️ Supprimer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL DÉTAIL REPAS HISTORIQUE -->
    <div class="modal" id="meal-detail-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="meal-detail-title">🍽️ Détail du repas</h3>
                <button class="modal-close" onclick="hideModal('meal-detail-modal')">×</button>
            </div>
            <div class="modal-body">
                <div class="modal-scrollable" id="meal-detail-content">
                    <!-- Contenu généré dynamiquement -->
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL MODIFIER QUANTITÉ ALIMENT DANS REPAS - AMÉLIORÉ -->
    <div class="modal" id="edit-food-quantity-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">✏️ Modifier la quantité</h3>
                <button class="modal-close" onclick="hideModal('edit-food-quantity-modal'); resetFoodEditModal()">×</button>
            </div>
            <div class="modal-body">
                <div id="edit-food-quantity-content">
                    <!-- Contenu généré dynamiquement -->
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL SAUVEGARDE DONNÉES SÉANCE -->
    <div class="modal" id="save-data-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">💾 Sauvegarder la séance</h3>
                <button class="modal-close" onclick="hideModal('save-data-modal')">×</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 18px; color: var(--text-primary);">
                    <p>Souhaitez-vous sauvegarder cette séance dans votre historique ?</p>
                </div>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <button class="btn btn-success" onclick="saveWorkoutData(true)">✅ Sauvegarder la séance</button>
                    <button class="btn btn-danger" onclick="completeWorkoutWithoutSaving()">❌ Abandonner la séance</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Recherche Avancée Exercices -->
    <div class="modal" id="advanced-search-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">🔍 Recherche Avancée Exercices</h3>
                <button class="modal-close" onclick="hideModal('advanced-search-modal')">×</button>
            </div>
            <div class="modal-body">
                <div class="filter-selection-container">
                    <div class="filter-selection-title">Groupe musculaire</div>
                    <div class="filter-selection-options" id="advanced-muscle-options">
                        <!-- Options générées dynamiquement -->
                    </div>
                </div>

                <div class="filter-selection-container">
                    <div class="filter-selection-title">Catégorie</div>
                    <div class="filter-selection-options" id="advanced-category-options">
                        <div class="filter-selection-option" data-value="all">Toutes</div>
                        <div class="filter-selection-option" data-value="force">Force</div>
                        <div class="filter-selection-option" data-value="isolation">Isolation</div>
                        <div class="filter-selection-option" data-value="endurance">Endurance</div>
                        <div class="filter-selection-option" data-value="cardio">Cardio</div>
                        <div class="filter-selection-option" data-value="polyarticulaire">Polyarticulaire</div>
                        <div class="filter-selection-option" data-value="monoarticulaire">Monoarticulaire</div>
                        <div class="filter-selection-option" data-value="stabilisation">Stabilisation</div>
                        <div class="filter-selection-option" data-value="mobilité">Mobilité</div>
                    </div>
                </div>

                <div class="filter-selection-container">
                    <div class="filter-selection-title">Niveau de difficulté</div>
                    <div class="filter-selection-options" id="advanced-difficulty-options">
                        <div class="filter-selection-option" data-value="all">Tous</div>
                        <div class="filter-selection-option" data-value="Débutant">Débutant</div>
                        <div class="filter-selection-option" data-value="Intermédiaire">Intermédiaire</div>
                        <div class="filter-selection-option" data-value="Avancé">Avancé</div>
                    </div>
                </div>

                <div class="filter-selection-container">
                    <div class="filter-selection-title">Équipement</div>
                    <div class="filter-selection-options" id="advanced-equipment-options">
                        <!-- Options générées dynamiquement -->
                    </div>
                </div>
                
                <div class="filter-selection-container">
    <div class="filter-selection-title">Filtres Spéciaux</div>
    <div class="filter-selection-options">
        <div class="filter-selection-option selected" data-value="all">Tous</div>
        <div class="filter-selection-option" data-value="personnalisé">Personnalisé</div>
        <div class="filter-selection-option" data-value="favoris">Favoris</div>
    </div>
</div>
                
                <div style="display: flex; gap: 10px; margin-top: 16px;">
                    <button class="btn btn-success" onclick="applyAdvancedFilters()" style="flex: 1;">🔍 Appliquer</button>
                    <button class="btn btn-secondary" onclick="resetAdvancedFilters()" style="flex: 1;">🗑️ Effacer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Recherche Avancée Aliments -->
    <div class="modal" id="advanced-search-modal-food">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">🔍 Recherche Avancée Aliments</h3>
                <button class="modal-close" onclick="hideModal('advanced-search-modal-food')">×</button>
            </div>
            <div class="modal-body">
                <div class="filter-selection-container">
                    <div class="filter-selection-title">Catégorie</div>
                    <div class="filter-selection-options" id="advanced-food-category-options">
                        <!-- Options générées dynamiquement -->
                    </div>
                </div>

                <div class="filter-selection-container">
                    <div class="filter-selection-title">Filtres spéciaux</div>
                    <div class="filter-selection-options">
                        <div class="filter-selection-option selected" data-value="all">Tous</div>
                        <div class="filter-selection-option" data-value="personnalisé">Personnalisé</div>
                        <div class="filter-selection-option" data-value="halal">Halal</div>
                        <div class="filter-selection-option" data-value="favoris">Favoris</div>
                    </div>
                </div>

                <div class="input-group" style="margin-top: 16px;">
                    <div class="input-label">Calories (max)</div>
                    <input type="number" class="number-input" id="advanced-calories-filter" placeholder="Ex: 200">
                </div>

                <div class="input-group" style="margin-top: 16px;">
                    <div class="input-label">Protéines (min)</div>
                    <input type="number" class="number-input" id="advanced-protein-filter" placeholder="Ex: 10">
                </div>

                <div class="input-group" style="margin-top: 16px;">
                    <div class="input-label">Recherche par nom</div>
                    <input type="text" class="number-input" id="advanced-food-name-filter" placeholder="Ex: Poulet, Riz...">
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 16px;">
                    <button class="btn btn-success" onclick="applyAdvancedFiltersFood()" style="flex: 1;">🔍 Appliquer</button>
                    <button class="btn btn-secondary" onclick="resetAdvancedFiltersFood()" style="flex: 1;">🗑️ Effacer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de confirmation de sortie -->
    <div class="modal" id="exit-confirm-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">⚠️ Quitter la séance ?</h3>
                <button class="modal-close" onclick="hideModal('exit-confirm-modal')">×</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 18px; color: var(--text-primary);">Vous avez une séance en cours. Voulez-vous vraiment quitter ?</p>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-danger" onclick="forceExitWorkout()" style="flex: 1;">Quitter</button>
                    <button class="btn btn-secondary" onclick="hideModal('exit-confirm-modal')" style="flex: 1;">Continuer</button>
                </div>
            </div>
        </div>
    </div>

        <!-- Modal Paramètres - AMÉLIORÉ -->
    <div class="modal" id="settings-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">⚙️ Paramètres</h3>
                <button class="modal-close" onclick="hideModal('settings-modal')">×</button>
            </div>
            <div class="modal-body">
                <div class="settings-list">
                    <!-- NOUVEAU : Bouton Thème -->
                    <div class="settings-item" onclick="showThemeSelection()" style="cursor: pointer;">
                        <div>
                            <div style="font-weight: 700; color: var(--text-primary);">🎨 Thème</div>
                            <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">Changer le thème de couleur</div>
                        </div>
                        <div style="color: var(--primary); font-weight: 700;">
                            <i class="fas fa-palette"></i>
                        </div>
                    </div>
                    
                    <div class="settings-item">
                        <div>
                            <div style="font-weight: 700; color: var(--text-primary);">🌙 Mode sombre</div>
                            <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">Activer/désactiver le thème sombre</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="dark-mode-toggle" onchange="toggleDarkModeSetting(this.checked)">
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="settings-item">
                        <div>
                            <div style="font-weight: 700; color: var(--text-primary);">🔊 Sons</div>
                            <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">Activer/désactiver les sons</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="sounds-toggle" checked onchange="toggleSounds(this.checked)">
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="settings-item">
                        <div>
                            <div style="font-weight: 700; color: var(--text-primary);">🔊 Sons</div>
                            <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">Activer/désactiver les sons</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="sounds-toggle" checked onchange="toggleSounds(this.checked)">
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="settings-item">
                        <div>
                            <div style="font-weight: 700; color: var(--text-primary);">📳 Vibrations</div>
                            <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">Activer/désactiver les vibrations</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="vibrations-toggle" checked onchange="toggleVibrations(this.checked)">
                            <span class="slider"></span>
                        </label>
                    </div>

                    
                    <div class="settings-item">
                        <div>
                            <div style="font-weight: 700; color: var(--text-primary);">🔒 Écran toujours actif</div>
                            <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">Garder l'écran allumé pendant les séances</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="keep-screen-on-toggle" onchange="toggleKeepScreenOn(this.checked)">
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="settings-item">
                        <div>
                            <div style="font-weight: 700; color: var(--text-primary);">⏱️ Timer auto</div>
                            <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">Démarrer le timer automatiquement</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="auto-timer-toggle" checked onchange="toggleAutoTimer(this.checked)">
                            <span class="slider"></span>
                        </label>
                    </div>
<div class="settings-item">
    <div>
        <div style="font-weight: 700; color: var(--text-primary);">📐 Mode compact</div>
        <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">Séries toujours compactes</div>
    </div>
    <label class="toggle-switch">
        <input type="checkbox" id="compact-mode-toggle" onchange="toggleCompactMode(this.checked)">
        <span class="slider"></span>
    </label>
</div>


<div class="settings-item">
    <div>
        <div style="font-weight: 700; color: var(--text-primary);">🎵 Test audio/vibration</div>
        <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">Tester les alertes sonores et vibrations</div>
    </div>
    <button class="btn btn-secondary" onclick="testAudioVibration()" style="padding: 8px 16px; font-size: var(--font-size-sm);">
        Tester
    </button>
</div>

    <!-- Modal Sélection Thème -->
    <div class="modal" id="theme-selection-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">🎨 Choisir un thème</h3>
                <button class="modal-close" onclick="hideModal('theme-selection-modal')">×</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 20px; color: var(--text-secondary); text-align: center;">
                    Sélectionnez un thème de couleur pour l'application
                </p>
                
                <div class="theme-options-grid">
                    <div class="theme-option" data-theme="default" onclick="selectTheme('default')">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #6366F1, #818CF8);"></div>
                        <div class="theme-name">Par défaut</div>
                        <div class="theme-check"><i class="fas fa-check"></i></div>
                    </div>
                    
                    <div class="theme-option" data-theme="blue" onclick="selectTheme('blue')">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #3B82F6, #60A5FA);"></div>
                        <div class="theme-name">Bleu</div>
                        <div class="theme-check"><i class="fas fa-check"></i></div>
                    </div>
                    
                    <div class="theme-option" data-theme="green" onclick="selectTheme('green')">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #10B981, #34D399);"></div>
                        <div class="theme-name">Vert</div>
                        <div class="theme-check"><i class="fas fa-check"></i></div>
                    </div>
                    
                    <div class="theme-option" data-theme="purple" onclick="selectTheme('purple')">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #8B5CF6, #A78BFA);"></div>
                        <div class="theme-name">Violet</div>
                        <div class="theme-check"><i class="fas fa-check"></i></div>
                    </div>
                    
                    <div class="theme-option" data-theme="red" onclick="selectTheme('red')">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #EF4444, #FCA5A5);"></div>
                        <div class="theme-name">Rouge</div>
                        <div class="theme-check"><i class="fas fa-check"></i></div>
                    </div>
                    
                    <div class="theme-option" data-theme="sunset" onclick="selectTheme('sunset')">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #F59E0B, #FBBF24);"></div>
                        <div class="theme-name">Soleil</div>
                        <div class="theme-check"><i class="fas fa-check"></i></div>
                    </div>
                </div>
                
                    <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--border); text-align: center;">
   			 <button class="btn btn-secondary" onclick="hideModal('theme-selection-modal')" style="width: 100%;">
       			 Retour aux paramètres
   			 </button>
		    </div>
                </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Aliment Favori -->
    <div class="modal" id="favorite-food-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">⭐ Ajouter un repas avec cet aliment</h3>
                <button class="modal-close" onclick="hideModal('favorite-food-modal')">×</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 18px; color: var(--text-primary);" id="favorite-food-message">Voulez-vous ajouter un repas avec cet aliment favori ?</p>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-success" onclick="addFavoriteFoodToMeal()" style="flex: 1;">Oui, ajouter un repas</button>
                    <button class="btn btn-secondary" onclick="hideModal('favorite-food-modal')" style="flex: 1;">Non, merci</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Notes Premium -->
<div class="modal" id="exercise-notes-modal">
    <div class="modal-content" style="max-width: 380px;">
        <div class="modal-header">
            <h3 class="modal-title">📝 Notes de l'exercice</h3>
            <button class="modal-close" onclick="hideModal('exercise-notes-modal')">×</button>
        </div>
        <div class="modal-body">
            <div style="margin-bottom: 20px; text-align: center;">
                <div class="profile-avatar" id="notes-exercise-icon" style="width: 60px; height: 60px; margin: 0 auto 15px; background: linear-gradient(135deg, #8B5CF6, #EC4899); font-size: 24px;">
                    <i class="fas fa-dumbbell"></i>
                </div>
                <h4 id="notes-exercise-name" style="margin: 0 0 10px 0; color: var(--text-primary);">Nom de l'exercice</h4>
                <div id="notes-exercise-details" style="font-size: var(--font-size-sm); color: var(--text-secondary);">
                    <!-- Détails de l'exercice -->
                </div>
            </div>
            
            <div class="input-group" style="margin-bottom: 20px;">
                <div class="input-label">
                    <i class="fas fa-edit"></i> Votre note
                </div>
                <textarea 
                    class="number-input notes-wrap" 
                    id="exercise-notes-text" 
                    placeholder="Ex: Technique à améliorer, sensation pendant l'exercice, objectif pour la prochaine fois..."
                    style="height: 150px; resize: vertical; width: 100%; padding: 15px; font-size: var(--font-size-base);"
                    oninput="autoSaveNotes()"
                ></textarea>
                <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                    <div style="font-size: var(--font-size-xs); color: var(--text-secondary);">
                        <i class="fas fa-history"></i> Sauvegarde automatique
                    </div>
                    <div style="font-size: var(--font-size-xs); color: var(--text-secondary);">
                        <span id="notes-char-count">0</span>/500 caractères
                    </div>
                </div>
            </div>
            
            <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(236, 72, 153, 0.05)); padding: 15px; border-radius: var(--radius); margin-bottom: 20px; border: 1px solid rgba(139, 92, 246, 0.2);">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <div style="width: 30px; height: 30px; background: linear-gradient(135deg, #8B5CF6, #EC4899); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white;">
                        <i class="fas fa-lightbulb"></i>
                    </div>
                    <div style="font-weight: 700; color: var(--text-primary);">Conseil</div>
                </div>
                <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">
                    Notez vos sensations, la technique utilisée, le niveau de difficulté ou vos objectifs pour la prochaine séance.
                </div>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-success" onclick="saveExerciseNotes()" style="flex: 1; background: linear-gradient(135deg, #8B5CF6, #EC4899);">
                    <i class="fas fa-save"></i> Enregistrer
                </button>
                <button class="btn btn-secondary" onclick="clearExerciseNotes()" style="flex: 1;">
                    <i class="fas fa-eraser"></i> Effacer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Inclure data.js avant le script principal -->
<script src="data.js"></script>
<script>
// ==================== VARIABLES GLOBALES ====================
let userProfile = {
    firstName: 'John',
    lastName: 'Doe',
    height: 180,
    weight: 75,
    level: 'Intermédiaire',
    trainingType: 'Maintien',
    defaultSets: 3,
    defaultReps: 10,
    defaultWeight: 10,
    defaultRest: 60
};

let customExercises = [];
let customFoods = [];
let customWorkouts = [];
let workoutHistory = [];
let nutritionHistory = [];
let dailyNutrition = { calories: 0, protein: 0, carbs: 0, fat: 0, meals: [] };
let activeWorkout = null;
let activeWorkoutTimer = null;
let activeWorkoutStartTime = null;
let timerInterval = null;
let currentTimerSeconds = 90;
let isTimerRunning = false;
let timerProgressInterval = null;
let currentScreen = 'home-screen';
let exerciseSearchFilter = 'all';
let foodSearchFilter = 'all';
let advancedExerciseFilters = {};
let advancedFoodFilters = {};
let theme = 'light';
let currentSupersetExerciseIndex = null;
let currentSupersetSetIndex = null;
let currentSupersetRoundInfo = null;
let settings = {
    sounds: true,
    vibrations: true,
    keepScreenOn: false,
    autoTimer: true,
    darkMode: false,
    compactMode: false  // AJOUTER CETTE LIGNE
};
let currentTheme = 'default'; // 'default', 'blue', 'green', 'purple', 'red', 'sunset'

// ==================== GESTION DU SON ET VIBRATIONS ====================
function playSound(type = 'beep') {
    if (!settings.sounds) return;
    
    try {
        // Créer un contexte audio
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        // Configurer le son selon le type
        switch(type) {
            case 'beep':
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime); // Fréquence du bip
                oscillator.type = 'sine';
                // Enveloppe ADSR pour un bip court
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.15);
                break;
                
            case 'timer_end':
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(400, audioContext.currentTime + 0.5);
                oscillator.type = 'sine';
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.4, audioContext.currentTime + 0.05);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.8);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.8);
                break;
                
            case 'success':
                // Bip de succès plus mélodieux
                oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // Do
                oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // Mi
                oscillator.type = 'sine';
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.05);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
                break;
        }
    } catch (error) {
        console.error('Erreur de son:', error);
    }
}

function vibrate(pattern = [100, 50, 100]) {
    if (!settings.vibrations || !navigator.vibrate) return;
    
    try {
        navigator.vibrate(pattern);
    } catch (error) {
        console.error('Erreur de vibration:', error);
    }
}

function playTimerEndAlert() {
    // Jouer le son de fin de timer
    playSound('timer_end');
    
    // Vibrer
    vibrate([200, 100, 200, 100, 200]);
    
    // Notification visuelle supplémentaire
    if (document.getElementById('timer-container').classList.contains('active')) {
        const timerDisplay = document.getElementById('timer-display');
        timerDisplay.style.color = '#EF4444';
        timerDisplay.style.animation = 'shake 0.5s ease-in-out';
        
        setTimeout(() => {
            timerDisplay.style.color = '';
            timerDisplay.style.animation = '';
        }, 500);
    }
}

function playSetCompleteAlert() {
    // Bip pour série terminée
    playSound('success');
    vibrate([100]);
    
    // Flash visuel
    if (document.querySelector('.set-item.completed:last-child')) {
        const lastCompletedSet = document.querySelector('.set-item.completed:last-child');
        lastCompletedSet.style.boxShadow = '0 0 20px rgba(16, 185, 129, 0.5)';
        
        setTimeout(() => {
            lastCompletedSet.style.boxShadow = '';
        }, 300);
    }
}

// ==================== FONCTIONS D'INITIALISATION ====================
function initApp() {
    loadFromLocalStorage();
    
    // ACTIVER LE MODE COMPACT PAR DÉFAUT SI CE N'EST PAS DÉJÀ DÉFINI
    if (settings.compactMode === undefined) {
        settings.compactMode = true;
    }
    
    calculateNutritionNeeds();
    updateDailyNutritionDisplay();
    loadMuscleGroups();
    loadExercises();
    loadFoods();
    loadCustomWorkouts();
    loadWorkoutHistory();
    loadNutritionHistory();
    updateFavoriteFoods();
    updateRecommendedPrograms();
    updateNavbar();
    checkAndApplyTheme();
    
    // Mettre à jour la case à cocher dans les paramètres
    updateCompactModeCheckbox();
}

function loadFromLocalStorage() {
    try {
        const savedProfile = localStorage.getItem('fitfuel_userProfile');
        if (savedProfile) userProfile = JSON.parse(savedProfile);
        
        const savedExercises = localStorage.getItem('fitfuel_customExercises');
        if (savedExercises) customExercises = JSON.parse(savedExercises);
        
        const savedFoods = localStorage.getItem('fitfuel_customFoods');
        if (savedFoods) customFoods = JSON.parse(savedFoods);
        
        const savedWorkouts = localStorage.getItem('fitfuel_customWorkouts');
        if (savedWorkouts) customWorkouts = JSON.parse(savedWorkouts);
        
        const savedHistory = localStorage.getItem('fitfuel_workoutHistory');
        if (savedHistory) workoutHistory = JSON.parse(savedHistory);
        
        const savedNutrition = localStorage.getItem('fitfuel_nutritionHistory');
        if (savedNutrition) nutritionHistory = JSON.parse(savedNutrition);
        
        const savedDailyNutrition = localStorage.getItem('fitfuel_dailyNutrition');
        if (savedDailyNutrition) dailyNutrition = JSON.parse(savedDailyNutrition);
        
        const savedSettings = localStorage.getItem('fitfuel_settings');
        if (savedSettings) settings = JSON.parse(savedSettings);
        
        const savedTheme = localStorage.getItem('fitfuel_theme');
        if (savedTheme) theme = savedTheme;

        const savedCompactMode = localStorage.getItem('fitfuel_compactMode');
	if (savedCompactMode !== null) {
    	settings.compactMode = JSON.parse(savedCompactMode);
	
	const savedCurrentTheme = localStorage.getItem('fitfuel_currentTheme');
        if (savedCurrentTheme) currentTheme = savedCurrentTheme;
} else {
            // Si non défini dans le localStorage, activer par défaut
            settings.compactMode = true;
        }
    } catch (e) {
        console.error('Erreur lors du chargement depuis localStorage:', e);
        // En cas d'erreur, activer le mode compact par défaut
        settings.compactMode = true;

	    }
}

function saveToLocalStorage() {
    try {
        localStorage.setItem('fitfuel_userProfile', JSON.stringify(userProfile));
        localStorage.setItem('fitfuel_customExercises', JSON.stringify(customExercises));
        localStorage.setItem('fitfuel_customFoods', JSON.stringify(customFoods));
        localStorage.setItem('fitfuel_customWorkouts', JSON.stringify(customWorkouts));
        localStorage.setItem('fitfuel_workoutHistory', JSON.stringify(workoutHistory));
        localStorage.setItem('fitfuel_nutritionHistory', JSON.stringify(nutritionHistory));
        localStorage.setItem('fitfuel_dailyNutrition', JSON.stringify(dailyNutrition));
        localStorage.setItem('fitfuel_settings', JSON.stringify(settings));
        localStorage.setItem('fitfuel_theme', theme);
        localStorage.setItem('fitfuel_compactMode', JSON.stringify(settings.compactMode));
	localStorage.setItem('fitfuel_currentTheme', currentTheme);
    } catch (e) {
        console.error('Erreur lors de la sauvegarde dans localStorage:', e);
	    }
}

// Nouvelle fonction pour mettre à jour la case à cocher
function updateCompactModeCheckbox() {
    const checkbox = document.getElementById('compact-mode-toggle');
    if (checkbox) {
        checkbox.checked = settings.compactMode;
    }
}

// ==================== GESTION DE L'INTERFACE ====================
function showScreen(screenId) {
    // Vérifier si une séance est en cours
    if (activeWorkout && screenId !== 'active-workout-screen' && currentScreen === 'active-workout-screen') {
        showModal('exit-confirm-modal');
        return;
    }
    
    // Masquer tous les écrans
    document.querySelectorAll('.screen').forEach(screen => {
        screen.classList.remove('active');
    });
    
    // Afficher l'écran demandé
    document.getElementById(screenId).classList.add('active');
    currentScreen = screenId;
    
    // Mettre à jour la navbar
    updateNavbar();
    
    // Actions spécifiques par écran
    switch(screenId) {
        case 'home-screen':
            loadMuscleGroups();
            updateRecommendedPrograms();
            break;
        case 'exercises-screen':
            loadExercises();
            loadFoods();
            updateAdvancedSearchDisplay();
            break;
        case 'workouts-screen':
    loadCustomWorkouts();
    loadPredefinedWorkouts();
    loadFavoriteExercises(); // MODIFICATION
    break;
        case 'history-screen':
            loadWorkoutHistory();
            loadNutritionHistory();
            break;
        case 'nutrition-screen':
            updateDailyNutritionDisplay();
            updateFavoriteFoods();
            break;
    }
}

function updateNavbar() {
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
    });
    
    let activeNavItem = null;
    switch(currentScreen) {
        case 'home-screen': activeNavItem = 0; break;
        case 'workouts-screen': activeNavItem = 1; break;
        case 'exercises-screen': activeNavItem = 2; break;
        case 'history-screen': activeNavItem = 3; break;
        case 'nutrition-screen': activeNavItem = 4; break;
        case 'active-workout-screen': activeNavItem = null; break;
        case 'profile-screen': activeNavItem = null; break;
    }
    
    if (activeNavItem !== null) {
        document.querySelectorAll('.nav-item')[activeNavItem].classList.add('active');
    }
}

function showModal(modalId) {
    const modal = document.getElementById(modalId);
    if (!modal) {
        console.error('Modal non trouvé:', modalId);
        return;
    }
    
    const openModals = document.querySelectorAll('.modal.active').length;
    modal.style.zIndex = 2000 + (openModals * 100);
    modal.classList.add('active');
}

function hideModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('active');
        modal.style.zIndex = '';
    }
}

function showNotification(message, type = 'success', duration = 3000) {
    const notification = document.createElement('div');
    notification.className = `temp-notification ${type}`;
    
    // Permettre le HTML dans les notifications
    notification.innerHTML = message;
    
    document.body.appendChild(notification);
    
    // Jouer un son selon le type de notification
    switch(type) {
        case 'success':
            playSound('success');
            vibrate([50]);
            break;
        case 'error':
            playSound('beep');
            vibrate([200, 100, 200]);
            break;
        case 'warning':
            playSound('beep');
            vibrate([300]);
            break;
        case 'info':
            playSound('beep');
            vibrate([100]);
            break;
    }
    
    setTimeout(() => {
        notification.classList.add('hiding');
        setTimeout(() => {
            if (document.body.contains(notification)) {
                document.body.removeChild(notification);
            }
        }, 300);
    }, duration);
}

// ==================== GESTION DU THÈME ====================
function checkAndApplyTheme() {
    // Appliquer le thème de couleur
    document.body.className = document.body.className.replace(/\btheme-\w+\b/g, '');
    if (currentTheme !== 'default') {
        document.body.classList.add(`theme-${currentTheme}`);
    }
    
    // Appliquer le mode sombre
    if (settings.darkMode) {
        document.body.classList.add('dark-mode');
        theme = 'dark';
        document.getElementById('dark-mode-toggle').checked = true;
    } else {
        document.body.classList.remove('dark-mode');
        theme = 'light';
        document.getElementById('dark-mode-toggle').checked = false;
    }
    
    // Cocher la case du mode compact si activé
    document.getElementById('compact-mode-toggle').checked = settings.compactMode;
    
    // S'assurer que la case du mode compact est à jour
    updateCompactModeCheckbox();
}

function toggleTheme() {
    settings.darkMode = !settings.darkMode;
    checkAndApplyTheme();
    saveToLocalStorage();
    showNotification(settings.darkMode ? 'Mode sombre activé' : 'Mode clair activé');
}

function toggleDarkModeSetting(checked) {
    settings.darkMode = checked;
    checkAndApplyTheme();
    saveToLocalStorage();
}

// ==================== GESTION DU PROFIL ====================
function updateAvatarInitials() {
    const firstName = document.getElementById('profile-firstname').value || 'J';
    const lastName = document.getElementById('profile-lastname').value || 'D';
    const initials = (firstName.charAt(0) + lastName.charAt(0)).toUpperCase();
    
    document.getElementById('user-avatar').textContent = initials;
    document.getElementById('profile-avatar').textContent = initials;
    document.getElementById('profile-name').textContent = `${firstName} ${lastName}`;
    
    userProfile.firstName = firstName;
    userProfile.lastName = lastName;
}

function calculateNutritionNeeds() {
    const height = parseFloat(document.getElementById('profile-height-input').value) || userProfile.height;
    const weight = parseFloat(document.getElementById('profile-weight-input').value) || userProfile.weight;
    const level = document.getElementById('profile-level-input').value;
    const trainingType = document.getElementById('profile-type-input').value;
    
    // Calcul IMC
    const heightInMeters = height / 100;
    const bmi = weight / (heightInMeters * heightInMeters);
    
    // Déterminer la catégorie IMC
    let category = '';
    if (bmi < 18.5) category = 'Maigreur';
    else if (bmi < 25) category = 'Normal';
    else if (bmi < 30) category = 'Surpoids';
    else category = 'Obésité';
    
    // Calcul des besoins caloriques basés sur la formule Harris-Benedict
    // BMR (Basal Metabolic Rate) pour hommes
    const bmr = 88.362 + (13.397 * weight) + (4.799 * height) - (5.677 * 30); // Âge fixe à 30 pour l'exemple
    
    // Facteur d'activité basé sur le niveau
    let activityFactor = 1.2;
    switch(level) {
        case 'Débutant complet': activityFactor = 1.2; break;
        case 'Débutant': activityFactor = 1.375; break;
        case 'Intermédiaire débutant': activityFactor = 1.55; break;
        case 'Intermédiaire': activityFactor = 1.725; break;
        case 'Intermédiaire avancé': activityFactor = 1.9; break;
        case 'Avancé': activityFactor = 2.0; break;
        case 'Expert': activityFactor = 2.1; break;
        case 'Professionnel': activityFactor = 2.3; break;
    }
    
        // Ajustement basé sur le type d'entraînement
    let trainingFactor = 1.0;
    switch(trainingType) {
        case 'Force pure': trainingFactor = 1.6; break;          // Augmenté de 1.3 à 1.6
        case 'Force': trainingFactor = 1.4; break;              // Augmenté de 1.2 à 1.4
        case 'Volume musculaire': trainingFactor = 1.5; break;  // Augmenté de 1.25 à 1.5
        case 'Hypertrophie': trainingFactor = 1.45; break;      // Augmenté de 1.2 à 1.45
        case 'Endurance musculaire': trainingFactor = 1.3; break; // Augmenté de 1.15 à 1.3
        case 'Cardio': trainingFactor = 1.25; break;            // Augmenté de 1.1 à 1.25
        case 'Perte de poids': trainingFactor = 0.8; break;     // Changé de 0.9 à 0.8
        case 'Maintien': trainingFactor = 1.0; break;           // Inchangé
        case 'Récupération': trainingFactor = 0.85; break;      // Changé de 0.95 à 0.85
        case 'Préparation physique': trainingFactor = 1.5; break; // Augmenté de 1.2 à 1.5
    }
    
    const dailyCalories = Math.round(bmr * activityFactor * trainingFactor);
    
    // Calcul des macros (40% protéines, 40% glucides, 20% lipides)
    const proteinGrams = Math.round((dailyCalories * 0.4) / 4); // 4 kcal par gramme de protéine
    const carbsGrams = Math.round((dailyCalories * 0.4) / 4); // 4 kcal par gramme de glucide
    const fatGrams = Math.round((dailyCalories * 0.2) / 9); // 9 kcal par gramme de lipide
    
    // Mise à jour de l'interface
    document.getElementById('profile-height').textContent = `${height}cm`;
    document.getElementById('profile-weight').textContent = `${weight}kg`;
    document.getElementById('profile-bmi').textContent = bmi.toFixed(1);
    document.getElementById('profile-category').textContent = category;
    document.getElementById('profile-level').textContent = `${level} • ${trainingType}`;
    document.getElementById('profile-calories').textContent = `${dailyCalories} kcal`;
    document.getElementById('profile-protein').textContent = `${proteinGrams}g`;
    document.getElementById('profile-carbs').textContent = `${carbsGrams}g`;
    document.getElementById('profile-fat').textContent = `${fatGrams}g`;
    
    // Mise à jour du profil
    userProfile.height = height;
    userProfile.weight = weight;
    userProfile.level = level;
    userProfile.trainingType = trainingType;
    
    // Mise à jour des besoins nutritionnels dans le localStorage
    userProfile.calorieNeeds = dailyCalories;
    userProfile.proteinNeeds = proteinGrams;
    userProfile.carbsNeeds = carbsGrams;
    userProfile.fatNeeds = fatGrams;
    
    // Mise à jour de l'affichage nutrition
    updateDailyNutritionDisplay();
    
    saveToLocalStorage();
}

function saveProfile() {
    // Récupérer les valeurs des champs par défaut
    userProfile.defaultSets = parseInt(document.getElementById('profile-default-sets').value) || 3;
    userProfile.defaultReps = document.getElementById('profile-default-reps').value || '10';
    userProfile.defaultWeight = parseFloat(document.getElementById('profile-default-weight').value) || 10;
    userProfile.defaultRest = parseInt(document.getElementById('profile-default-rest').value) || 60;
    
    // Calculer les besoins nutritionnels
    calculateNutritionNeeds();
    
    showNotification('Profil sauvegardé avec succès !');
    saveToLocalStorage();
}

function resetProfile() {
    if (confirm('Voulez-vous vraiment réinitialiser votre profil aux valeurs par défaut ?')) {
        userProfile = {
            firstName: 'John',
            lastName: 'Doe',
            height: 180,
            weight: 75,
            level: 'Intermédiaire',
            trainingType: 'Maintien',
            defaultSets: 3,
            defaultReps: '10',
            defaultWeight: 10,
            defaultRest: 60
        };
        
        document.getElementById('profile-firstname').value = userProfile.firstName;
        document.getElementById('profile-lastname').value = userProfile.lastName;
        document.getElementById('profile-height-input').value = userProfile.height;
        document.getElementById('profile-weight-input').value = userProfile.weight;
        document.getElementById('profile-level-input').value = userProfile.level;
        document.getElementById('profile-type-input').value = userProfile.trainingType;
        document.getElementById('profile-default-sets').value = userProfile.defaultSets;
        document.getElementById('profile-default-reps').value = userProfile.defaultReps;
        document.getElementById('profile-default-weight').value = userProfile.defaultWeight;
        document.getElementById('profile-default-rest').value = userProfile.defaultRest;
        
        calculateNutritionNeeds();
        showNotification('Profil réinitialisé');
        saveToLocalStorage();
    }
}

// ==================== GESTION DES EXERCICES ====================
function loadMuscleGroups() {
    const container = document.getElementById('muscle-grid-container');
    if (!container) return;
    
    container.innerHTML = '';
    
    muscleGroups.forEach(muscle => {
        // Compter le nombre d'exercices pour ce groupe musculaire
        const exerciseCount = getAllExercises().filter(ex => ex.muscleGroup === muscle.id).length;
        
        const muscleCard = document.createElement('div');
        muscleCard.className = 'muscle-card';
        muscleCard.style.background = `linear-gradient(135deg, ${muscle.color}, ${adjustColor(muscle.color, -20)})`;
        muscleCard.onclick = () => {
            showExerciseTab('exercises');
            document.getElementById('muscle-filter').value = muscle.id;
            filterExercises();
            showScreen('exercises-screen');
        };
        
        muscleCard.innerHTML = `
            <div class="muscle-name">${muscle.name}</div>
            <div class="exercise-count">
                <span>${exerciseCount} exercices</span>
                <span>${muscle.image}</span>
            </div>
        `;
        
        container.appendChild(muscleCard);
    });
}

function adjustColor(color, amount) {
    // Fonction simple pour ajuster la luminosité d'une couleur
    return '#' + color.replace(/^#/, '').replace(/../g, color => 
        ('0' + Math.min(255, Math.max(0, parseInt(color, 16) + amount)).toString(16)).substr(-2)
    );
}

function getAllExercises() {
    return [...exercises, ...customExercises];
}

function loadExercises() {
    const exerciseList = document.getElementById('exercises-list');
    const muscleFilter = document.getElementById('muscle-filter');
    const searchInput = document.getElementById('search-input');
    
    if (!exerciseList) return;
    
    // Mettre à jour le filtre des groupes musculaires
    if (muscleFilter) {
        muscleFilter.innerHTML = '<option value="all">Tous les exercices</option>';
        muscleGroups.forEach(muscle => {
            const option = document.createElement('option');
            option.value = muscle.id;
            option.textContent = muscle.name;
            muscleFilter.appendChild(option);
        });
    }
    
    // Filtrer les exercices
    let filteredExercises = getAllExercises();
    
    // Appliquer le filtre de groupe musculaire ou spéciaux
if (exerciseSearchFilter !== 'all') {
    if (exerciseSearchFilter === 'custom') {
        filteredExercises = filteredExercises.filter(ex => ex.custom);
    } else if (exerciseSearchFilter === 'favorites') {
        filteredExercises = filteredExercises.filter(ex => ex.favorite);
    } else {
        filteredExercises = filteredExercises.filter(ex => ex.muscleGroup === exerciseSearchFilter);
    }
}
    
    // Appliquer la recherche textuelle
    if (searchInput && searchInput.value) {
        const searchTerm = searchInput.value.toLowerCase();
        filteredExercises = filteredExercises.filter(ex => 
            ex.name.toLowerCase().includes(searchTerm) ||
            ex.muscleGroup.toLowerCase().includes(searchTerm) ||
            (ex.equipment && ex.equipment.some(eq => eq.toLowerCase().includes(searchTerm))) ||
            ex.difficulty.toLowerCase().includes(searchTerm)
        );
    }
    
    // Appliquer les filtres avancés
    filteredExercises = applyAdvancedExerciseFilters(filteredExercises);
    
    // Trier par nom
    filteredExercises.sort((a, b) => a.name.localeCompare(b.name));

// Trier pour montrer d'abord les favoris
filteredExercises.sort((a, b) => {
    if (a.favorite && !b.favorite) return -1;
    if (!a.favorite && b.favorite) return 1;
    return a.name.localeCompare(b.name);
});
    
    // Afficher les exercices
    exerciseList.innerHTML = '';
    
    if (filteredExercises.length === 0) {
        exerciseList.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">🏋️‍♂️</div>
                <p>Aucun exercice trouvé</p>
                <button class="btn btn-success mt-4" onclick="showCustomExerciseModal()">Créer un exercice</button>
            </div>
        `;
        return;
    }
    
    filteredExercises.forEach(exercise => {
        const muscle = muscleGroups.find(m => m.id === exercise.muscleGroup);
        const exerciseItem = document.createElement('div');
        exerciseItem.className = 'exercise-item';
        
        // Badge de difficulté avec couleur
        let difficultyClass = '';
        switch(exercise.difficulty) {
            case 'Débutant': difficultyClass = 'difficulty-beginner'; break;
            case 'Intermédiaire': difficultyClass = 'difficulty-intermediate'; break;
            case 'Avancé': difficultyClass = 'difficulty-advanced'; break;
        }
        
        exerciseItem.innerHTML = `
            <div class="exercise-content" onclick="showExerciseDetail('${exercise.id}', ${exercise.custom})">
                <div class="exercise-name">${exercise.name}</div>
                <div class="exercise-muscle">
                    <span style="color: ${muscle ? muscle.color : '#666'}">●</span>
                    ${muscle ? muscle.name : exercise.muscleGroup}
                    ${exercise.custom ? ' (Personnalisé)' : ''}
                </div>
            </div>
            <div class="exercise-actions">
    <span class="exercise-difficulty-badge ${difficultyClass}">${exercise.difficulty}</span>
    <button class="action-btn" onclick="toggleExerciseFavorite('${exercise.id}', ${exercise.custom})" title="${exercise.favorite ? 'Retirer des favoris' : 'Ajouter aux favoris'}">
        <i class="fas ${exercise.favorite ? 'fa-star' : 'fa-star'}"></i>
    </button>
    ${exercise.custom ? `
        <button class="action-btn" onclick="editCustomExercise('${exercise.id}')" title="Modifier">
            <i class="fas fa-edit"></i>
        </button>
        <button class="action-btn" onclick="deleteCustomExercise('${exercise.id}')" title="Supprimer">
            <i class="fas fa-trash"></i>
        </button>
    ` : ''}
    <button class="action-btn" onclick="addToWorkout('${exercise.id}')" title="Ajouter à une séance">
        <i class="fas fa-plus"></i>
    </button>
</div>
        `;
        
        exerciseList.appendChild(exerciseItem);
    });
}

// ==================== FICHE DÉTAILLÉE EXERCICE ====================
function showExerciseDetail(exerciseId, isCustom) {
    let exercise;
    
    if (isCustom) {
        exercise = customExercises.find(ex => ex.id === exerciseId);
    } else {
        // Chercher d'abord dans les exercices personnalisés (pour les favoris)
        exercise = customExercises.find(ex => ex.originalId === exerciseId);
        if (!exercise) {
            exercise = exercises.find(ex => ex.id === exerciseId);
        }
    }
    
    if (!exercise) {
        showNotification('Exercice non trouvé', 'error');
        return;
    }
    
    // Récupérer les données complètes depuis data.js si disponibles
    let fullExerciseData = null;
    if (!isCustom && exercise.originalId) {
        fullExerciseData = exercises.find(ex => ex.id === exercise.originalId);
    } else if (!isCustom) {
        fullExerciseData = exercise;
    }
    
    // Si on a des données complètes, les utiliser, sinon utiliser l'exercice de base
    const displayExercise = fullExerciseData || exercise;
    
    // Trouver le groupe musculaire
    const muscle = muscleGroups.find(m => m.id === displayExercise.muscleGroup);
    
    // Préparer le contenu HTML premium
    let contentHTML = `
        <div class="exercise-detail-header">
            <div class="exercise-detail-icon">
                <i class="fas fa-dumbbell"></i>
            </div>
            <div class="exercise-detail-title">${displayExercise.name}</div>
            <div class="exercise-detail-subtitle">
                <span class="exercise-muscle-badge">${muscle ? muscle.name : displayExercise.muscleGroup}</span>
                <span class="exercise-difficulty-badge ${displayExercise.difficulty.toLowerCase().includes('débutant') ? 'difficulty-beginner' : displayExercise.difficulty.toLowerCase().includes('intermédiaire') ? 'difficulty-intermediate' : 'difficulty-advanced'}">
                    ${displayExercise.difficulty}
                </span>
                ${displayExercise.category ? `<span class="exercise-category-badge">${displayExercise.category}</span>` : ''}
            </div>
        </div>
        
        ${displayExercise.description ? `
            <div class="exercise-detail-section">
                <div class="exercise-detail-section-title">
                    <i class="fas fa-align-left"></i> Description
                </div>
                <div class="exercise-detail-description">
                    ${displayExercise.description}
                </div>
            </div>
        ` : ''}
        
        <div class="exercise-detail-section">
            <div class="exercise-detail-section-title">
                <i class="fas fa-chart-bar"></i> Informations
            </div>
            <div class="exercise-detail-grid">
                <div class="exercise-detail-stat">
                    <div class="exercise-detail-stat-value">${muscle ? muscle.name : displayExercise.muscleGroup}</div>
                    <div class="exercise-detail-stat-label">Groupe Musculaire</div>
                </div>
                
                <div class="exercise-detail-stat">
                    <div class="exercise-detail-stat-value">${displayExercise.difficulty}</div>
                    <div class="exercise-detail-stat-label">Niveau</div>
                </div>
                
                ${displayExercise.category ? `
                    <div class="exercise-detail-stat">
                        <div class="exercise-detail-stat-value">${displayExercise.category}</div>
                        <div class="exercise-detail-stat-label">Catégorie</div>
                    </div>
                ` : ''}
                
                ${displayExercise.equipment && displayExercise.equipment.length > 0 ? `
                    <div class="exercise-detail-stat">
                        <div class="exercise-detail-stat-value">${displayExercise.equipment.length}</div>
                        <div class="exercise-detail-stat-label">Équipements</div>
                    </div>
                ` : ''}
            </div>
        </div>
        
        ${displayExercise.equipment && displayExercise.equipment.length > 0 ? `
            <div class="exercise-detail-section">
                <div class="exercise-detail-section-title">
                    <i class="fas fa-tools"></i> Équipement requis
                </div>
                <div class="exercise-detail-equipment-list">
                    ${displayExercise.equipment.map(eq => `
                        <div class="exercise-detail-equipment-item">
                            <i class="fas fa-dumbbell"></i> ${eq}
                        </div>
                    `).join('')}
                </div>
            </div>
        ` : ''}
        
        ${displayExercise.instructions ? `
            <div class="exercise-detail-section">
                <div class="exercise-detail-section-title">
                    <i class="fas fa-graduation-cap"></i> Instructions d'exécution
                </div>
                <div class="exercise-detail-description">
                    ${displayExercise.instructions}
                </div>
            </div>
        ` : ''}
        
        ${displayExercise.tips ? `
            <div class="exercise-detail-section">
                <div class="exercise-detail-section-title">
                    <i class="fas fa-lightbulb"></i> Conseils & Astuces
                </div>
                <div class="exercise-detail-description">
                    ${displayExercise.tips}
                </div>
            </div>
        ` : ''}
        
        ${displayExercise.commonMistakes ? `
            <div class="exercise-detail-section">
                <div class="exercise-detail-section-title">
                    <i class="fas fa-exclamation-triangle"></i> Erreurs courantes
                </div>
                <div class="exercise-detail-description">
                    ${displayExercise.commonMistakes}
                </div>
            </div>
        ` : ''}
        
        ${displayExercise.variations ? `
            <div class="exercise-detail-section">
                <div class="exercise-detail-section-title">
                    <i class="fas fa-exchange-alt"></i> Variations
                </div>
                <div class="exercise-detail-description">
                    ${displayExercise.variations}
                </div>
            </div>
        ` : ''}
    `;
    
    // Bouton vidéo si disponible
    if (displayExercise.videoUrl) {
        contentHTML += `
            <button class="exercise-detail-video-btn" onclick="window.open('${displayExercise.videoUrl}', '_blank')">
                <i class="fab fa-youtube"></i> Voir la vidéo démo
            </button>
        `;
    }
    
    // Actions
    contentHTML += `
        <div class="exercise-detail-actions">
            <button class="btn btn-success" onclick="addToWorkout('${exercise.id}')" style="flex: 2;">
                <i class="fas fa-plus"></i> Ajouter à une séance
            </button>
            <button class="btn ${exercise.favorite ? 'btn-warning' : 'btn-secondary'}" onclick="toggleExerciseFavorite('${exercise.id}', ${isCustom})" style="flex: 1;">
                <i class="fas ${exercise.favorite ? 'fa-star' : 'fa-star'}"></i>
            </button>
        </div>
        
        ${isCustom ? `
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button class="btn btn-secondary" onclick="editCustomExercise('${exercise.id}')" style="flex: 1;">
                    <i class="fas fa-edit"></i> Modifier
                </button>
                <button class="btn btn-danger" onclick="deleteCustomExercise('${exercise.id}')" style="flex: 1;">
                    <i class="fas fa-trash"></i> Supprimer
                </button>
            </div>
        ` : ''}
    `;
    
    // Afficher le modal
    document.getElementById('exercise-detail-content').innerHTML = contentHTML;
    document.getElementById('exercise-detail-title').textContent = '📋 Fiche Exercice';
    showModal('exercise-detail-modal');
}

function filterExercises() {
    const searchInput = document.getElementById('search-input');
    const muscleFilter = document.getElementById('muscle-filter');
    
    exerciseSearchFilter = muscleFilter ? muscleFilter.value : 'all';
    loadExercises();
}

function setMuscleFilter(value) {
    exerciseSearchFilter = value;
    // MODIFICATION
    if (value === 'custom' || value === 'favorites') {
        // Ce sont des filtres spéciaux, pas des groupes musculaires
        loadExercises();
    } else {
        filterExercises();
    }
}

function showExerciseTab(tab) {
    document.getElementById('exercise-tab').classList.toggle('hidden', tab !== 'exercises');
    document.getElementById('food-tab').classList.toggle('hidden', tab !== 'foods');
    
    document.querySelectorAll('#exercises-screen .radio-tab').forEach((btn, index) => {
        btn.classList.toggle('active', (tab === 'exercises' && index === 0) || (tab === 'foods' && index === 1));
    });
    
    if (tab === 'exercises') {
        loadExercises();
    } else if (tab === 'foods') {
        loadFoods();
    }
}

function showCustomExerciseModal() {
    const muscleSelect = document.getElementById('custom-exercise-muscle');
    muscleSelect.innerHTML = '<option value="">Sélectionner un groupe</option>';
    muscleGroups.forEach(muscle => {
        const option = document.createElement('option');
        option.value = muscle.id;
        option.textContent = muscle.name;
        muscleSelect.appendChild(option);
    });
    
    showModal('custom-exercise-modal');
}

function toggleFavoriteCheckbox(element) {
    element.classList.toggle('checked');
}

function addCustomExercise() {
    const name = document.getElementById('custom-exercise-name').value.trim();
    const muscleGroup = document.getElementById('custom-exercise-muscle').value;
    const category = document.getElementById('custom-exercise-category').value;
    const difficulty = document.getElementById('custom-exercise-difficulty').value;
    const equipment = document.getElementById('custom-exercise-equipment').value;
    const isFavorite = document.getElementById('custom-exercise-favorite').classList.contains('checked');
    
    if (!name || !muscleGroup || !category) {
        showNotification('Veuillez remplir tous les champs obligatoires', 'error');
        return;
    }
    
const newExercise = {
    id: Date.now().toString(),
    name: name,
    muscleGroup: muscleGroup,
    category: category,
    difficulty: difficulty,
    equipment: equipment ? equipment.split(',').map(e => e.trim()) : [],
    favorite: isFavorite, // MODIFICATION: Toujours ajouter aux favoris si checkbox cochée
    custom: true
};
    
    customExercises.push(newExercise);
    saveToLocalStorage();
    loadExercises();
    
    // MODIFICATION ICI
    const context = document.getElementById('custom-exercise-modal').dataset.context;
    if (context === 'create' || context === 'edit') {
        // Ajouter l'exercice à la séance en cours de création
        addExerciseToWorkoutSelection(newExercise.id);
    }
    
    hideModal('custom-exercise-modal');
    
    document.getElementById('custom-exercise-name').value = '';
    document.getElementById('custom-exercise-muscle').value = '';
    document.getElementById('custom-exercise-category').value = '';
    document.getElementById('custom-exercise-equipment').value = '';
    document.getElementById('custom-exercise-favorite').classList.remove('checked');
    
    showNotification('Exercice créé et ajouté à la séance !');
}

function editCustomExercise(exerciseId) {
    const exercise = customExercises.find(ex => ex.id === exerciseId);
    if (!exercise) return;
    
    document.getElementById('edit-exercise-name').value = exercise.name;
    
    const muscleSelect = document.getElementById('edit-exercise-muscle');
    muscleSelect.innerHTML = '<option value="">Sélectionner un groupe</option>';
    muscleGroups.forEach(muscle => {
        const option = document.createElement('option');
        option.value = muscle.id;
        option.textContent = muscle.name;
        if (muscle.id === exercise.muscleGroup) option.selected = true;
        muscleSelect.appendChild(option);
    });
    
    document.getElementById('edit-exercise-category').value = exercise.category;
    document.getElementById('edit-exercise-difficulty').value = exercise.difficulty;
    document.getElementById('edit-exercise-equipment').value = exercise.equipment ? exercise.equipment.join(', ') : '';
    
    const favoriteCheckbox = document.getElementById('edit-exercise-favorite');
    if (exercise.favorite) {
        favoriteCheckbox.classList.add('checked');
    } else {
        favoriteCheckbox.classList.remove('checked');
    }
    
    // Stocker l'ID de l'exercice à modifier
    document.getElementById('edit-custom-exercise-modal').dataset.exerciseId = exerciseId;
    showModal('edit-custom-exercise-modal');
}

function saveEditedExercise() {
    const exerciseId = document.getElementById('edit-custom-exercise-modal').dataset.exerciseId;
    const exerciseIndex = customExercises.findIndex(ex => ex.id === exerciseId);
    
    if (exerciseIndex === -1) return;
    
    const name = document.getElementById('edit-exercise-name').value.trim();
    const muscleGroup = document.getElementById('edit-exercise-muscle').value;
    const category = document.getElementById('edit-exercise-category').value;
    const difficulty = document.getElementById('edit-exercise-difficulty').value;
    const equipment = document.getElementById('edit-exercise-equipment').value;
    const isFavorite = document.getElementById('edit-exercise-favorite').classList.contains('checked');
    
    if (!name || !muscleGroup || !category) {
        showNotification('Veuillez remplir tous les champs obligatoires', 'error');
        return;
    }
    
    customExercises[exerciseIndex] = {
        ...customExercises[exerciseIndex],
        name: name,
        muscleGroup: muscleGroup,
        category: category,
        difficulty: difficulty,
        equipment: equipment ? equipment.split(',').map(e => e.trim()) : [],
        favorite: isFavorite
    };
    
    saveToLocalStorage();
    loadExercises();
    hideModal('edit-custom-exercise-modal');
    showNotification('Exercice modifié avec succès !');
}

function deleteCustomExercise(exerciseId) {
    const exercise = customExercises.find(ex => ex.id === exerciseId);
    if (!exercise) return;
    
    document.getElementById('delete-custom-exercise-modal').dataset.exerciseId = exerciseId;
    document.getElementById('delete-exercise-message').textContent = 
        `Êtes-vous sûr de vouloir supprimer l'exercice "${exercise.name}" ? Cette action est irréversible et supprimera également cet exercice de toutes les séances où il est utilisé.`;
    showModal('delete-custom-exercise-modal');
}

function confirmDeleteCustomExercise() {
    const exerciseId = document.getElementById('delete-custom-exercise-modal').dataset.exerciseId;
    
    // Supprimer l'exercice
    customExercises = customExercises.filter(ex => ex.id !== exerciseId);
    
    // Supprimer l'exercice des séances personnalisées
    customWorkouts.forEach(workout => {
        workout.exercises = workout.exercises.filter(exId => exId !== exerciseId);
    });
    
    saveToLocalStorage();
    loadExercises();
    loadCustomWorkouts();
    hideModal('delete-custom-exercise-modal');
    showNotification('Exercice supprimé avec succès !');
}

function toggleExerciseFavorite(exerciseId, isCustom) {
    let exercise;
    let wasFavorite = false;
    
    if (isCustom) {
        exercise = customExercises.find(ex => ex.id === exerciseId);
        if (exercise) {
            wasFavorite = exercise.favorite;
            exercise.favorite = !exercise.favorite;
        }
    } else {
        exercise = exercises.find(ex => ex.id === exerciseId);
        if (exercise) {
            // Pour les exercices prédéfinis, on crée une copie personnalisée
            const existingCustom = customExercises.find(ex => 
                ex.name === exercise.name && ex.muscleGroup === exercise.muscleGroup
            );
            
            if (existingCustom) {
                // Si une copie existe déjà, on modifie son statut favori
                wasFavorite = existingCustom.favorite;
                existingCustom.favorite = !existingCustom.favorite;
            } else {
                // Sinon on crée une copie personnalisée
                const customCopy = {
                    ...exercise,
                    id: `custom_${exerciseId}_${Date.now()}`,
                    custom: true,
                    favorite: true,
                    originalId: exerciseId
                };
                customExercises.push(customCopy);
                wasFavorite = false;
            }
        }
    }
    
    saveToLocalStorage();
    loadExercises();
    showNotification(wasFavorite ? 'Exercice retiré des favoris' : 'Exercice ajouté aux favoris');
}

function showDeleteAllExercisesModal() {
    showModal('delete-all-exercises-modal');
}

function showClearHistoryModal() {
    showModal('clear-history-modal');
}

function confirmDeleteAllExercises() {
    customExercises = [];
    
    // Nettoyer les séances personnalisées
    customWorkouts.forEach(workout => {
        workout.exercises = workout.exercises.filter(exId => {
            const exercise = getAllExercises().find(ex => ex.id === exId);
            return exercise && !exercise.custom;
        });
    });
    
    saveToLocalStorage();
    loadExercises();
    loadCustomWorkouts();
    hideModal('delete-all-exercises-modal');
    showNotification('Tous les exercices personnalisés ont été supprimés');
}

function clearAllHistory() {
    if (confirm('Êtes-vous vraiment sûr de vouloir supprimer TOUT l\'historique des séances ? Cette action est irréversible.')) {
        workoutHistory = [];
        saveToLocalStorage();
        loadWorkoutHistory();
        hideModal('clear-history-modal');
        showNotification('Historique des séances entièrement supprimé');
    }
}


// ==================== GESTION DES ALIMENTS ====================
function getAllFoods() {
    return [...foods, ...customFoods];
}

function loadFoods() {
    const foodList = document.getElementById('foods-list');
    const categoryFilter = document.getElementById('food-category-filter');
    const searchInput = document.getElementById('food-search-input');
    
    if (!foodList) return;
    
    // Mettre à jour le filtre des catégories
    if (categoryFilter) {
        const categories = [...new Set([...foods, ...customFoods].map(f => f.category))];
        categoryFilter.innerHTML = '<option value="all">Toutes les catégories</option>';
        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category.charAt(0).toUpperCase() + category.slice(1);
            categoryFilter.appendChild(option);
        });
    }
    
    // Filtrer les aliments
    let filteredFoods = getAllFoods();
    
    // Appliquer le filtre de catégorie ou spéciaux
if (foodSearchFilter !== 'all') {
    if (foodSearchFilter === 'personnalisé') {
        filteredFoods = filteredFoods.filter(food => food.custom);
    } else if (foodSearchFilter === 'halal') {
        filteredFoods = filteredFoods.filter(food => food.halal);
    } else if (foodSearchFilter === 'favorites') {
        filteredFoods = filteredFoods.filter(food => food.favorite);
    } else {
        filteredFoods = filteredFoods.filter(food => food.category === foodSearchFilter);
    }
}
    
    // Appliquer la recherche textuelle
    if (searchInput && searchInput.value) {
        const searchTerm = searchInput.value.toLowerCase();
        filteredFoods = filteredFoods.filter(food => 
            food.name.toLowerCase().includes(searchTerm) ||
            food.category.toLowerCase().includes(searchTerm)
        );
    }
    
    // Appliquer les filtres avancés
    filteredFoods = applyAdvancedFoodFilters(filteredFoods);
    
    // Trier par nom
    filteredFoods.sort((a, b) => a.name.localeCompare(b.name));
    
    // Afficher les aliments
    foodList.innerHTML = '';
    
    if (filteredFoods.length === 0) {
        foodList.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">🥦</div>
                <p>Aucun aliment trouvé</p>
                <button class="btn btn-success mt-4" onclick="showAddFoodModal()">Ajouter un aliment</button>
            </div>
        `;
        return;
    }
    
    filteredFoods.forEach(food => {
        const foodItem = document.createElement('div');
        foodItem.className = 'food-item-improved';
        
        foodItem.innerHTML = `
            <div class="food-item-improved-header">
                <div class="food-item-improved-name">${food.name}</div>
                <div class="food-item-improved-calories">${food.calories} kcal / ${food.quantity}g</div>
            </div>
            <div class="food-item-improved-details">
    <span>${food.category}</span>
    ${food.halal ? '<span>🕌 Halal</span>' : ''}
    ${food.custom ? '<span>🎨 Personnalisé</span>' : ''}
    ${food.custom ? `<span style="cursor: pointer;" onclick="toggleFoodHalal('${food.id}')">${food.halal ? '❌ Non-halal' : '🕌 Halal'}</span>` : ''}
</div>
            <div class="food-item-improved-macros">
                <div class="food-item-improved-macro protein">Protéines: ${food.protein}g</div>
                <div class="food-item-improved-macro carbs">Glucides: ${food.carbs}g</div>
                <div class="food-item-improved-macro fat">Lipides: ${food.fat}g</div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
    <button class="btn btn-warning" onclick="toggleFoodFavorite('${food.id}', ${food.custom})" style="flex: 1;">
        <i class="fas ${food.favorite ? 'fa-star' : 'fa-star'}"></i> ${food.favorite ? 'Favori' : 'Favori'}
    </button>
    ${food.custom ? `
        <button class="btn btn-secondary" onclick="editCustomFood('${food.id}')" style="flex: 1;">
            <i class="fas fa-edit"></i> Modifier
        </button>
    ` : ''}
    <button class="btn btn-success" onclick="addFoodToMeal('${food.id}')" style="flex: 1;">
        <i class="fas fa-plus"></i> Ajouter
    </button>
</div>
        `;
        
        foodList.appendChild(foodItem);
    });
}

function filterFoods() {
    const searchInput = document.getElementById('food-search-input');
    const categoryFilter = document.getElementById('food-category-filter');
    
    foodSearchFilter = categoryFilter ? categoryFilter.value : 'all';
    loadFoods();
}

function setFoodCategoryFilter(value) {
    foodSearchFilter = value;
    loadFoods();
}

function showAddFoodModal() {
    showModal('add-food-modal');
}

function toggleCheckbox(element) {
    element.classList.toggle('checked');
}

function saveFood() {
    const name = document.getElementById('food-name').value.trim();
    const quantity = parseInt(document.getElementById('food-quantity').value) || 100;
    const calories = parseInt(document.getElementById('food-calories').value) || 0;
    const protein = parseFloat(document.getElementById('food-protein').value) || 0;
    const carbs = parseFloat(document.getElementById('food-carbs').value) || 0;
    const fat = parseFloat(document.getElementById('food-fat').value) || 0;
    const category = document.getElementById('food-category').value;
    const isHalal = document.getElementById('food-halal').classList.contains('checked');
    const isFavorite = document.getElementById('food-favorite').classList.contains('checked');
    
    if (!name) {
        showNotification('Veuillez saisir un nom pour l\'aliment', 'error');
        return;
    }
    
    const newFood = {
        id: Date.now().toString(),
        name: name,
        quantity: quantity,
        calories: calories,
        protein: protein,
        carbs: carbs,
        fat: fat,
        category: category,
        halal: isHalal,
        favorite: isFavorite,
        custom: true
    };
    
    customFoods.push(newFood);
    saveToLocalStorage();
    loadFoods();
    
    // MODIFICATION ICI
    const context = document.getElementById('add-food-modal').dataset.context;
    if (context === 'add' || context === 'edit') {
        // Ajouter l'aliment au repas en cours de création
        addFoodToMealFromSearch(newFood.id);
    }
    
    hideModal('add-food-modal');
    
    document.getElementById('food-name').value = '';
    document.getElementById('food-quantity').value = '100';
    document.getElementById('food-calories').value = '';
    document.getElementById('food-protein').value = '';
    document.getElementById('food-carbs').value = '';
    document.getElementById('food-fat').value = '';
    document.getElementById('food-halal').classList.remove('checked');
    document.getElementById('food-favorite').classList.remove('checked');
    
    showNotification('Aliment créé et ajouté au repas !');
}

function calculateCaloriesFromMacros() {
    const protein = parseFloat(document.getElementById('food-protein').value) || 0;
    const carbs = parseFloat(document.getElementById('food-carbs').value) || 0;
    const fat = parseFloat(document.getElementById('food-fat').value) || 0;
    
    const calories = Math.round((protein * 4) + (carbs * 4) + (fat * 9));
    document.getElementById('food-calories').value = calories;
}

function calculateEditCaloriesFromMacros() {
    const protein = parseFloat(document.getElementById('edit-food-protein').value) || 0;
    const carbs = parseFloat(document.getElementById('edit-food-carbs').value) || 0;
    const fat = parseFloat(document.getElementById('edit-food-fat').value) || 0;
    
    const calories = Math.round((protein * 4) + (carbs * 4) + (fat * 9));
    document.getElementById('edit-food-calories').value = calories;
}

function editCustomFood(foodId) {
    const food = customFoods.find(f => f.id === foodId);
    if (!food) return;
    
    document.getElementById('edit-food-name').value = food.name;
    document.getElementById('edit-food-quantity').value = food.quantity;
    document.getElementById('edit-food-calories').value = food.calories;
    document.getElementById('edit-food-protein').value = food.protein;
    document.getElementById('edit-food-carbs').value = food.carbs;
    document.getElementById('edit-food-fat').value = food.fat;
    document.getElementById('edit-food-category').value = food.category;
    
    const halalCheckbox = document.getElementById('edit-food-halal');
    const favoriteCheckbox = document.getElementById('edit-food-favorite');
    
    if (food.halal) {
        halalCheckbox.classList.add('checked');
    } else {
        halalCheckbox.classList.remove('checked');
    }
    
    if (food.favorite) {
        favoriteCheckbox.classList.add('checked');
    } else {
        favoriteCheckbox.classList.remove('checked');
    }
    
    document.getElementById('edit-custom-food-modal').dataset.foodId = foodId;
    showModal('edit-custom-food-modal');
}

function saveEditedFood() {
    const foodId = document.getElementById('edit-custom-food-modal').dataset.foodId;
    const foodIndex = customFoods.findIndex(f => f.id === foodId);
    
    if (foodIndex === -1) return;
    
    const name = document.getElementById('edit-food-name').value.trim();
    const quantity = parseInt(document.getElementById('edit-food-quantity').value) || 100;
    const calories = parseInt(document.getElementById('edit-food-calories').value) || 0;
    const protein = parseFloat(document.getElementById('edit-food-protein').value) || 0;
    const carbs = parseFloat(document.getElementById('edit-food-carbs').value) || 0;
    const fat = parseFloat(document.getElementById('edit-food-fat').value) || 0;
    const category = document.getElementById('edit-food-category').value;
    const isHalal = document.getElementById('edit-food-halal').classList.contains('checked');
    const isFavorite = document.getElementById('edit-food-favorite').classList.contains('checked');
    
    if (!name) {
        showNotification('Veuillez saisir un nom pour l\'aliment', 'error');
        return;
    }
    
    customFoods[foodIndex] = {
        ...customFoods[foodIndex],
        name: name,
        quantity: quantity,
        calories: calories,
        protein: protein,
        carbs: carbs,
        fat: fat,
        category: category,
        halal: isHalal,
        favorite: isFavorite
    };
    
    saveToLocalStorage();
    loadFoods();
    hideModal('edit-custom-food-modal');
    showNotification('Aliment modifié avec succès !');
}

function deleteFood() {
    const foodId = document.getElementById('edit-custom-food-modal').dataset.foodId;
    
    customFoods = customFoods.filter(f => f.id !== foodId);
    saveToLocalStorage();
    loadFoods();
    hideModal('edit-custom-food-modal');
    showNotification('Aliment supprimé avec succès !');
}

function toggleFoodFavorite(foodId, isCustom) {
    let food;
    let wasFavorite = false;
    
    if (isCustom) {
        food = customFoods.find(f => f.id === foodId);
        if (food) {
            wasFavorite = food.favorite;
            food.favorite = !food.favorite;
        }
    } else {
        food = foods.find(f => f.id === foodId);
        if (food) {
            // Pour les aliments prédéfinis, on crée une copie personnalisée
            const existingCustom = customFoods.find(f => 
                f.name === food.name && f.category === food.category
            );
            
            if (existingCustom) {
                // Si une copie existe déjà, on modifie son statut favori
                wasFavorite = existingCustom.favorite;
                existingCustom.favorite = !existingCustom.favorite;
            } else {
                // Sinon on crée une copie personnalisée
                const customCopy = {
                    ...food,
                    id: `custom_${foodId}_${Date.now()}`,
                    custom: true,
                    favorite: true,
                    halal: false,
                    originalId: foodId
                };
                customFoods.push(customCopy);
                wasFavorite = false;
            }
        }
    }
    
    saveToLocalStorage();
    loadFoods();
    showNotification(wasFavorite ? 'Aliment retiré des favoris' : 'Aliment ajouté aux favoris');
}

function toggleFoodHalal(foodId) {
    let food = customFoods.find(f => f.id === foodId);
    
    if (!food) {
        // Si l'aliment n'est pas personnalisé, chercher dans les aliments prédéfinis
        const predefinedFood = foods.find(f => f.id === foodId);
        if (!predefinedFood) return;
        
        // Créer une copie personnalisée
        food = {
            ...predefinedFood,
            id: `custom_${foodId}_${Date.now()}`,
            custom: true,
            halal: true,
            favorite: false,
            originalId: foodId
        };
        customFoods.push(food);
    } else {
        food.halal = !food.halal;
    }
    
    saveToLocalStorage();
    loadFoods();
    showNotification(food.halal ? 'Aliment marqué comme halal' : 'Aliment marqué comme non-halal');
}

function showDeleteAllFoodsModal() {
    showModal('delete-all-foods-modal');
}

function confirmDeleteAllFoods() {
    customFoods = [];
    saveToLocalStorage();
    loadFoods();
    hideModal('delete-all-foods-modal');
    showNotification('Tous les aliments personnalisés ont été supprimés');
}

// ==================== GESTION DES SÉANCES ====================
function loadPredefinedWorkouts() {
    const container = document.getElementById('predefined-workouts-container');
    if (!container) return;
    
    container.innerHTML = '';
    
    // Vérifier que predefinedWorkouts existe et est un tableau
    if (!window.predefinedWorkouts) {
        // Si non défini, le définir depuis Workouts
        window.predefinedWorkouts = Workouts;
    }
    
    if (!window.predefinedWorkouts || typeof window.predefinedWorkouts !== 'object') {
        container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">Aucune séance prédéfinie disponible</p>';
        return;
    }
    
    // Convertir l'objet Workouts en tableau
    const workoutArray = Object.values(window.predefinedWorkouts);
    
    if (workoutArray.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">Aucune séance prédéfinie disponible</p>';
        return;
    }
    
    workoutArray.forEach(workout => {
        const exerciseCount = workout.exercises ? workout.exercises.length : 0;
        const workoutCard = document.createElement('div');
        workoutCard.className = 'workout-card-luxury';
        workoutCard.style.background = `linear-gradient(135deg, ${getWorkoutColor(workout.type)}, ${adjustColor(getWorkoutColor(workout.type), -20)})`;
        workoutCard.onclick = () => startPredefinedWorkout(workout);
        
        const difficulty = workout.difficulty || 'Intermédiaire';
let difficultyClass = '';
switch(difficulty) {
    case 'Débutant': difficultyClass = 'difficulty-beginner'; break;
    case 'Intermédiaire': difficultyClass = 'difficulty-intermediate'; break;
    case 'Avancé': difficultyClass = 'difficulty-advanced'; break;
    default: difficultyClass = 'difficulty-intermediate';
}

workoutCard.innerHTML = `
    <div class="workout-icon">🏋️‍♂️</div>
    <div class="workout-name">${workout.name || 'Séance sans nom'}</div>
    <div class="workout-description">${workout.description || 'Séance prédéfinie'}</div>
    <div class="workout-duration">
        <i class="far fa-clock"></i>
        ${workout.duration || 45} min • ${exerciseCount} exercices
    </div>
    <div class="workout-badge ${difficultyClass}">${difficulty}</div>
`;
        
        container.appendChild(workoutCard);
    });
}

function startPredefinedWorkoutFromHome(workoutId) {
    const workout = window.predefinedWorkouts ? window.predefinedWorkouts[workoutId] : Workouts[workoutId];
    if (!workout) {
        showNotification('Séance non trouvée', 'error');
        return;
    }
    startPredefinedWorkout(workout);
}

function getWorkoutColor(type) {
    switch(type) {
        case 'fullbody': return '#6366F1';
        case 'push': return '#EF4444';
        case 'pull': return '#10B981';
        case 'legs': return '#F59E0B';
        case 'abs': return '#8B5CF6';
        default: return '#6366F1';
    }
}

function loadCustomWorkouts() {
    const container = document.getElementById('custom-workouts-list');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (customWorkouts.length === 0) {
        container.innerHTML = `
            <div class="card">
                <p style="text-align: center; color: var(--text-secondary); margin-bottom: 14px;">
                    Aucune séance personnalisée. Créez votre première séance !
                </p>
            </div>
        `;
        return;
    }
    
    customWorkouts.forEach((workout, index) => {
        const exerciseCount = workout.exercises.length;
        const workoutCard = document.createElement('div');
        workoutCard.className = 'workout-card';
        workoutCard.onclick = () => startCustomWorkout(workout);
        
        workoutCard.innerHTML = `
            <div class="workout-name">${workout.name}</div>
            <div class="workout-description">${workout.description || 'Séance personnalisée'}</div>
            <div class="workout-duration">
                <i class="far fa-clock"></i>
                ${exerciseCount} exercices
            </div>
            <div style="position: absolute; top: 15px; right: 15px; display: flex; gap: 6px;">
                <button class="action-btn" onclick="event.stopPropagation(); editCustomWorkout(${index})">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="action-btn" onclick="event.stopPropagation(); deleteCustomWorkout(${index})">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        
        container.appendChild(workoutCard);
    });
}

function showCreateWorkoutModal() {
    showModal('create-workout-modal');
}

function showExerciseSelectionForCreate() {
    const muscleFilter = document.getElementById('exercise-filter');
    muscleFilter.innerHTML = '<option value="all">Tous les groupes musculaires</option>';
    muscleGroups.forEach(muscle => {
        const option = document.createElement('option');
        option.value = muscle.id;
        option.textContent = muscle.name;
        muscleFilter.appendChild(option);
    });
    
    loadExerciseSelection('all');
    showModal('select-exercise-modal');
    document.getElementById('select-exercise-modal').dataset.context = 'create';
}

function showCustomExerciseModalForCreate() {
    showCustomExerciseModal();
    document.getElementById('custom-exercise-modal').dataset.context = 'create';
    // MODIFICATION
    document.getElementById('custom-exercise-modal').dataset.workoutContext = 'create';
}

function loadExerciseSelection(filter = 'all') {
    const container = document.getElementById('exercise-selection-list');
    if (!container) return;
    
    let filteredExercises = getAllExercises();
    
    if (filter !== 'all') {
        filteredExercises = filteredExercises.filter(ex => ex.muscleGroup === filter);
    }
    
    container.innerHTML = '';
    
    if (filteredExercises.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">Aucun exercice trouvé</p>';
        return;
    }
    
    filteredExercises.forEach(exercise => {
        const muscle = muscleGroups.find(m => m.id === exercise.muscleGroup);
        const exerciseItem = document.createElement('div');
        exerciseItem.className = 'food-search-simple-item';
        exerciseItem.onclick = () => addExerciseToWorkoutSelection(exercise.id);
        
        exerciseItem.innerHTML = `
            <div class="food-search-simple-name">${exercise.name}</div>
            <div class="food-search-simple-details">
                ${muscle ? muscle.name : exercise.muscleGroup} • ${exercise.difficulty}
                ${exercise.custom ? ' (Personnalisé)' : ''}
            </div>
        `;
        
        container.appendChild(exerciseItem);
    });
}

function filterExerciseSelection(searchTerm) {
    const filterValue = document.getElementById('exercise-filter').value;
    loadExerciseSelection(filterValue === 'all' ? 'all' : filterValue);
    
    // Filtrer également par recherche textuelle
    if (searchTerm) {
        const items = document.querySelectorAll('#exercise-selection-list .food-search-simple-item');
        items.forEach(item => {
            const text = item.textContent.toLowerCase();
            item.style.display = text.includes(searchTerm.toLowerCase()) ? 'block' : 'none';
        });
    }
}

function filterExerciseSelectionByMuscle(value) {
    loadExerciseSelection(value === 'all' ? 'all' : value);
}

function addExerciseToWorkoutSelection(exerciseId) {
    const context = document.getElementById('select-exercise-modal').dataset.context;
    const containerId = context === 'create' ? 'workout-exercises-selection' : 'edit-workout-exercises-selection';
    const container = document.getElementById(containerId);
    
    const exercise = getAllExercises().find(ex => ex.id === exerciseId);
    if (!exercise) return;
    
    const exerciseElement = document.createElement('div');
    exerciseElement.className = 'meal-food-item';
    exerciseElement.dataset.exerciseId = exerciseId;
    
    exerciseElement.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <div style="font-weight: 700; margin-bottom: 3px;">${exercise.name}</div>
                <div style="font-size: var(--font-size-xs); color: var(--text-secondary);">
                    ${exercise.muscleGroup} • ${exercise.difficulty}
                </div>
            </div>
            <div class="reorder-buttons">
                <button class="reorder-btn" onclick="moveExerciseUp(this)" title="Monter">↑</button>
                <button class="reorder-btn" onclick="moveExerciseDown(this)" title="Descendre">↓</button>
                <button class="reorder-btn" onclick="removeExerciseFromSelection(this)" title="Supprimer">×</button>
            </div>
        </div>
    `;
    
    container.appendChild(exerciseElement);
    hideModal('select-exercise-modal');
}

function moveExerciseUp(button) {
    const item = button.closest('.meal-food-item');
    const prevItem = item.previousElementSibling;
    if (prevItem) {
        item.parentNode.insertBefore(item, prevItem);
    }
}

function moveExerciseDown(button) {
    const item = button.closest('.meal-food-item');
    const nextItem = item.nextElementSibling;
    if (nextItem) {
        item.parentNode.insertBefore(nextItem, item);
    }
}

function removeExerciseFromSelection(button) {
    const item = button.closest('.meal-food-item');
    item.remove();
}

function saveCustomWorkout() {
    const name = document.getElementById('workout-name').value.trim();
    const exercises = [];
    
    document.querySelectorAll('#workout-exercises-selection .meal-food-item').forEach(item => {
        exercises.push(item.dataset.exerciseId);
    });
    
    if (!name) {
        showNotification('Veuillez saisir un nom pour la séance', 'error');
        return;
    }
    
    if (exercises.length === 0) {
        showNotification('Veuillez ajouter au moins un exercice', 'error');
        return;
    }
    
    const newWorkout = {
        id: Date.now().toString(),
        name: name,
        exercises: exercises,
        description: 'Séance personnalisée',
        custom: true
    };
    
    customWorkouts.push(newWorkout);
    saveToLocalStorage();
    loadCustomWorkouts();
    
    // MODIFICATION ICI
    hideModal('create-workout-modal');
    
    document.getElementById('workout-name').value = '';
    document.getElementById('workout-exercises-selection').innerHTML = '';
    
    showNotification('Séance créée avec succès !');
}

function resetCreateWorkoutModal() {
    document.getElementById('workout-name').value = '';
    document.getElementById('workout-exercises-selection').innerHTML = '';
}

function editCustomWorkout(index) {
    const workout = customWorkouts[index];
    if (!workout) return;
    
    document.getElementById('edit-workout-name').value = workout.name;
    document.getElementById('edit-workout-modal').dataset.workoutIndex = index;
    
    const container = document.getElementById('edit-workout-exercises-selection');
    container.innerHTML = '';
    
    workout.exercises.forEach(exerciseId => {
        const exercise = getAllExercises().find(ex => ex.id === exerciseId);
        if (exercise) {
            const exerciseElement = document.createElement('div');
            exerciseElement.className = 'meal-food-item';
            exerciseElement.dataset.exerciseId = exerciseId;
            
            exerciseElement.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: 700; margin-bottom: 3px;">${exercise.name}</div>
                        <div style="font-size: var(--font-size-xs); color: var(--text-secondary);">
                            ${exercise.muscleGroup} • ${exercise.difficulty}
                        </div>
                    </div>
                    <div class="reorder-buttons">
                        <button class="reorder-btn" onclick="moveExerciseUp(this)" title="Monter">↑</button>
                        <button class="reorder-btn" onclick="moveExerciseDown(this)" title="Descendre">↓</button>
                        <button class="reorder-btn" onclick="removeExerciseFromSelection(this)" title="Supprimer">×</button>
                    </div>
                </div>
            `;
            
            container.appendChild(exerciseElement);
        }
    });
    
    showModal('edit-workout-modal');
}

function showExerciseSelectionForEdit() {
    showExerciseSelectionForCreate();
    document.getElementById('select-exercise-modal').dataset.context = 'edit';
}

function showCustomExerciseModalForEdit() {
    showCustomExerciseModal();
    document.getElementById('custom-exercise-modal').dataset.context = 'edit';
}

function saveEditedWorkout() {
    const index = parseInt(document.getElementById('edit-workout-modal').dataset.workoutIndex);
    if (isNaN(index) || !customWorkouts[index]) return;
    
    const name = document.getElementById('edit-workout-name').value.trim();
    const exercises = [];
    
    document.querySelectorAll('#edit-workout-exercises-selection .meal-food-item').forEach(item => {
        exercises.push(item.dataset.exerciseId);
    });
    
    if (!name) {
        showNotification('Veuillez saisir un nom pour la séance', 'error');
        return;
    }
    
    if (exercises.length === 0) {
        showNotification('Veuillez ajouter au moins un exercice', 'error');
        return;
    }
    
    customWorkouts[index] = {
        ...customWorkouts[index],
        name: name,
        exercises: exercises
    };
    
    saveToLocalStorage();
    loadCustomWorkouts();
    hideModal('edit-workout-modal');
    showNotification('Séance modifiée avec succès !');
}

function duplicateWorkout() {
    const index = parseInt(document.getElementById('edit-workout-modal').dataset.workoutIndex);
    if (isNaN(index) || !customWorkouts[index]) return;
    
    const originalWorkout = customWorkouts[index];
    const duplicatedWorkout = {
        ...originalWorkout,
        id: Date.now().toString(),
        name: `${originalWorkout.name} (Copie)`
    };
    
    customWorkouts.push(duplicatedWorkout);
    saveToLocalStorage();
    loadCustomWorkouts();
    hideModal('edit-workout-modal');
    showNotification('Séance dupliquée avec succès !');
}

function deleteEditedWorkout() {
    const index = parseInt(document.getElementById('edit-workout-modal').dataset.workoutIndex);
    if (isNaN(index) || !customWorkouts[index]) return;
    
    if (confirm('Êtes-vous sûr de vouloir supprimer cette séance ?')) {
        customWorkouts.splice(index, 1);
        saveToLocalStorage();
        loadCustomWorkouts();
        hideModal('edit-workout-modal');
        showNotification('Séance supprimée avec succès !');
    }
}

function deleteCustomWorkout(index) {
    if (confirm('Êtes-vous sûr de vouloir supprimer cette séance ?')) {
        customWorkouts.splice(index, 1);
        saveToLocalStorage();
        loadCustomWorkouts();
        showNotification('Séance supprimée avec succès !');
    }
}

// ==================== GESTION DES SÉANCES ACTIVES ====================
function startPredefinedWorkout(workout) {
    // Extraire les IDs d'exercices du tableau workout.exercises
    const exerciseIds = workout.exercises.map(ex => ex.exerciseId);
    startWorkoutWithExercises(workout.name, exerciseIds);
}

function startCustomWorkout(workout) {
    startWorkoutWithExercises(workout.name, workout.exercises);
}

function startWorkoutWithExercises(workoutName, exerciseIds) {
    activeWorkout = {
        name: workoutName,
        exercises: [],
        startTime: new Date(),
        completedSets: 0,
        totalWeight: 0
    };
    
    // Chercher la séance complète dans Workouts pour avoir les détails (sets, reps, weight, rest)
    let workoutDetails = null;
    
    // Chercher dans les séances prédéfinies
    Object.values(Workouts).forEach(workout => {
        if (workout.name === workoutName) {
            workoutDetails = workout;
        }
    });
    
    exerciseIds.forEach(exerciseId => {
        const exercise = getAllExercises().find(ex => ex.id === exerciseId);
        if (exercise) {
            // Chercher les détails spécifiques de cet exercice dans la séance
            let exerciseDetails = null;
            if (workoutDetails && workoutDetails.exercises) {
                exerciseDetails = workoutDetails.exercises.find(ex => ex.exerciseId === exerciseId);
            }
            
            // Utiliser les valeurs de data.js si disponibles, sinon les valeurs par défaut du profil
            const defaultSets = exerciseDetails ? exerciseDetails.sets : userProfile.defaultSets;
            const defaultReps = exerciseDetails ? exerciseDetails.reps : userProfile.defaultReps;
            const defaultWeight = exerciseDetails ? exerciseDetails.weight : userProfile.defaultWeight;
            const defaultRest = exerciseDetails ? exerciseDetails.rest : userProfile.defaultRest;
            const notes = exerciseDetails ? exerciseDetails.notes : '';
            
            activeWorkout.exercises.push({
                ...exercise,
                sets: Array(defaultSets).fill().map((_, i) => ({
                    number: i + 1,
                    reps: defaultReps,  // Utilise les reps de data.js
                    weight: defaultWeight,  // Utilise le poids de data.js
                    completed: false
                })),
                customRest: defaultRest,  // Utilise le temps de repos de data.js
                notes: notes  // Utilise les notes de data.js
            });
        }
    });
    
    activeWorkoutStartTime = new Date();
    activeWorkoutTimer = setInterval(updateWorkoutTimer, 1000);
    updateWorkoutDisplay();
    showScreen('active-workout-screen');
}

function updateWorkoutTimer() {
    if (!activeWorkoutStartTime) return;
    
    const now = new Date();
    const diff = Math.floor((now - activeWorkoutStartTime) / 1000);
    
    const hours = Math.floor(diff / 3600);
    const minutes = Math.floor((diff % 3600) / 60);
    const seconds = diff % 60;
    
    document.getElementById('workout-timer').textContent = 
        `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

function updateWorkoutDisplay() {
    if (!activeWorkout) return;
    
    document.getElementById('active-workout-name').textContent = activeWorkout.name;
    document.getElementById('completed-sets').textContent = activeWorkout.completedSets;
    document.getElementById('total-weight').textContent = `${activeWorkout.totalWeight}kg`;
    
    const container = document.getElementById('workout-exercises-container');
    container.innerHTML = '';
    
// Dans la boucle forEach des exercices, trouver la partie qui génère le HTML
activeWorkout.exercises.forEach((exercise, exerciseIndex) => {
    const exerciseElement = document.createElement('div');
    exerciseElement.className = 'workout-exercise';
    
    // Vérifier si c'est le premier exercice d'un superset
    const isFirstInSuperset = exercise.supersetId && 
        (exerciseIndex === 0 || activeWorkout.exercises[exerciseIndex - 1].supersetId !== exercise.supersetId);
    
    // Vérifier si c'est le dernier exercice d'un superset
    const isLastInSuperset = exercise.supersetId && 
        (exerciseIndex === activeWorkout.exercises.length - 1 || 
         activeWorkout.exercises[exerciseIndex + 1].supersetId !== exercise.supersetId);
    
    // Appliquer des styles spéciaux pour les supersets
    if (exercise.supersetId) {
        exerciseElement.style.borderLeft = `4px solid ${exercise.supersetColor || '#8B5CF6'}`;
        exerciseElement.style.marginTop = isFirstInSuperset ? '5px' : '2px';
        exerciseElement.style.marginBottom = isLastInSuperset ? '15px' : '2px';
    }
    
// Dans la boucle forEach des exercices (~ligne 1680), modifiez le innerHTML :
exerciseElement.innerHTML = `
    <div class="exercise-header">
        <div class="exercise-title" onclick="toggleExerciseCollapse(${exerciseIndex})" style="cursor: pointer; ${exercise.collapsed ? 'color: #3B82F6;' : ''}">
    ${exercise.name}
    ${exercise.supersetId ? `<span class="superset-badge" style="background: ${exercise.supersetColor || '#8B5CF6'}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: bold; margin-left: 8px;">Superset ${exercise.supersetOrder}</span>` : ''}
</div>
    </div>
    
    <div style="display: flex; justify-content: center; flex-wrap: wrap; gap: 5px; margin: 10px 0; padding: 10px; background: var(--card-bg); border-radius: var(--radius-sm); border: 1px solid var(--border);">
        <button class="action-btn" onclick="moveExerciseUpInWorkout(${exerciseIndex})" title="Monter l'exercice">
            <i class="fas fa-arrow-up"></i>
        </button>
        <button class="action-btn" onclick="moveExerciseDownInWorkout(${exerciseIndex})" title="Descendre l'exercice">
            <i class="fas fa-arrow-down"></i>
        </button>
        <button class="action-btn" onclick="resetExerciseToDefaults(${exerciseIndex})" title="Réinitialiser valeurs">
            <i class="fas fa-undo"></i>
        </button>
        <button class="action-btn" onclick="showCustomRestModal(${exerciseIndex})" title="Temps de repos">
            <i class="fas fa-clock"></i>
        </button>
        <button class="action-btn" onclick="addSet(${exerciseIndex})" title="Ajouter une série">
            <i class="fas fa-plus"></i>
        </button>
        <button class="action-btn" onclick="removeSet(${exerciseIndex})" title="Supprimer une série">
            <i class="fas fa-minus"></i>
        </button>
        ${exercise.supersetId ? `
            <button class="action-btn" onclick="removeSuperset(${exerciseIndex})" title="Quitter le superset" style="background: ${exercise.supersetColor || '#8B5CF6'}; color: white;">
                <i class="fas fa-unlink"></i>
            </button>
        ` : `
            <button class="action-btn" onclick="showSupersetModal(${exerciseIndex})" title="Créer superset">
                <i class="fas fa-link"></i>
            </button>
        `}
        
<!-- BOUTON NOTES (NOUVEAU) -->

<button class="action-btn" onclick="showExerciseNotesModal(${exerciseIndex})" 
        title="Notes de l'exercice" 
        style="background: ${exercise.notes ? 'linear-gradient(135deg, #3B82F6, #1D4ED8)' : 'linear-gradient(135deg, #8B5CF6, #EC4899)'}; color: white;">
    <i class="fas fa-sticky-note"></i>
</button>

<!-- NOUVEAU BOUTON VIDÉO -->
        ${exercise.videoUrl ? `
            <button class="action-btn" onclick="window.open('${exercise.videoUrl}', '_blank')" 
                    title="Voir la vidéo de l'exercice" 
                    style="background: linear-gradient(135deg, #FF0000, #CC0000); color: white;">
                <i class="fas fa-play"></i>
            </button>
        ` : ''}

<!-- NOUVEAU BOUTON MODE -->
    <button class="action-btn" onclick="toggleExerciseCompactMode(${exerciseIndex})" 
            title="${exercise.compactModeOverride === true ? 'Mode compact forcé' : exercise.compactModeOverride === false ? 'Mode normal forcé' : 'Utilise le paramètre global'}" 
            style="background: ${exercise.compactModeOverride === true ? 'var(--primary)' : exercise.compactModeOverride === false ? 'var(--warning)' : 'var(--secondary)'}; color: white;">
        <i class="fas fa-${exercise.compactModeOverride === true ? 'mobile-alt' : exercise.compactModeOverride === false ? 'file-alt' : 'cog'}"></i>
    </button>

<button class="action-btn" onclick="removeExerciseFromWorkout(${exerciseIndex})" title="Supprimer l'exercice">
            <i class="fas fa-trash"></i>
        </button>
    </div>
    
    ${exercise.collapsed ? '' : `
        <div style="margin: 10px 0; padding: 10px; background: var(--card-bg); border-radius: var(--radius-sm); border: 1px solid var(--border);">
            <div style="font-size: var(--font-size-sm); color: var(--text-secondary); margin-bottom: 5px;">
                <i class="fas fa-clock"></i> Temps de repos: ${exercise.customRest || userProfile.defaultRest} secondes
                ${exercise.supersetId ? ` • <span style="color: ${exercise.supersetColor || '#8B5CF6'};"><i class="fas fa-link"></i> ${exercise.supersetName || 'Superset'}</span>` : ''}
            </div>
        </div>
        <div class="sets-container" id="sets-container-${exerciseIndex}">
            <!-- Séries générées dynamiquement -->
        </div>
    `}
`;
        
        container.appendChild(exerciseElement);
        
        const setsContainer = document.getElementById(`sets-container-${exerciseIndex}`);
        exercise.sets.forEach((set, setIndex) => {
            const setElement = createSetElement(exerciseIndex, setIndex, set);
if (setElement) setsContainer.appendChild(setElement);
            setsContainer.appendChild(setElement);
        });
    });
}

function createSetElement(exerciseIndex, setIndex, set) {
    const exercise = activeWorkout.exercises[exerciseIndex];
    const isCollapsed = activeWorkout.exercises[exerciseIndex]?.collapsed || false;
    
    if (isCollapsed) return '';
    
// DÉTERMINER LE MODE D'AFFICHAGE POUR CET EXERCICE
    const useCompactMode = exercise.compactModeOverride !== undefined 
        ? exercise.compactModeOverride 
        : settings.compactMode;

    // NOUVELLE LOGIQUE: Vérifier si c'est une reprise de séance avec données historiques
    const isRedoWorkout = exercise.historicalSets && exercise.historicalSets.length > 0;
    const historicalSet = isRedoWorkout ? exercise.historicalSets[setIndex] : null;
    
    // Si c'est une reprise avec données historiques, utiliser les valeurs historiques
    if (isRedoWorkout && historicalSet) {
        // Appliquer les valeurs historiques exactes pour la série correspondante
        set.reps = historicalSet.reps !== undefined ? historicalSet.reps : userProfile.defaultReps;
        set.weight = historicalSet.weight !== undefined ? historicalSet.weight : userProfile.defaultWeight;
    }
    
    // Mode compact
    if (useCompactMode) {
        const setElement = document.createElement('div');
        setElement.className = `set-item-compact ${set.completed ? 'completed' : ''}`;
        setElement.id = `set-${exerciseIndex}-${setIndex}`;
        setElement.style.minHeight = '60px';
        setElement.style.padding = '10px 12px';
        setElement.style.display = 'grid';
        setElement.style.gridTemplateColumns = '60px 1fr 1fr auto';
        setElement.style.gap = '8px';
        setElement.style.alignItems = 'center';
        setElement.style.transition = 'none';
        
        // S'assurer que les valeurs ne soient pas undefined
        const repsValue = set.reps !== undefined ? set.reps : userProfile.defaultReps;
        const weightValue = set.weight !== undefined ? set.weight : userProfile.defaultWeight;
        
        // NOUVELLE LOGIQUE: Affichage des informations historiques
        let previousSetInfo = '';
        if (isRedoWorkout && historicalSet) {
            // Pour une reprise: montrer les valeurs exactes de la série historique correspondante
            previousSetInfo = `
                <div class="previous-set-info-compact" style="grid-column: 1 / -1; font-size: 9px; color: var(--text-secondary); margin-top: 4px; padding-top: 4px; border-top: 1px dashed var(--border); font-style: italic;">
                    <i class="fas fa-history" style="margin-right: 4px;"></i>Série précédente (historique): ${historicalSet.reps} reps × ${historicalSet.weight}kg
                </div>
            `;
        } else if (setIndex > 0) {
            // Pour une nouvelle séance sans historique: montrer la série précédente de CETTE séance
            const prevSet = activeWorkout.exercises[exerciseIndex].sets[setIndex - 1];
            if (prevSet) {
                const prevReps = prevSet.reps !== undefined ? prevSet.reps : userProfile.defaultReps;
                const prevWeight = prevSet.weight !== undefined ? prevSet.weight : userProfile.defaultWeight;
                
                previousSetInfo = `
                    <div class="previous-set-info-compact" style="grid-column: 1 / -1; font-size: 9px; color: var(--text-secondary); margin-top: 4px; padding-top: 4px; border-top: 1px dashed var(--border); font-style: italic;">
                        <i class="fas fa-arrow-up" style="margin-right: 4px;"></i>Série précédente: ${prevReps} reps × ${prevWeight}kg
                    </div>
                `;
            }
        } else if (!isRedoWorkout) {
            // Pour la première série d'une nouvelle séance sans historique: montrer la dernière performance globale
            const exerciseName = activeWorkout.exercises[exerciseIndex].name;
            const previousData = findPreviousExerciseData(exerciseName);
            if (previousData) {
                previousSetInfo = `
                    <div class="previous-set-info-compact" style="grid-column: 1 / -1; font-size: 9px; color: var(--text-secondary); margin-top: 4px; padding-top: 4px; border-top: 1px dashed var(--border); font-style: italic;">
                        <i class="fas fa-history" style="margin-right: 4px;"></i>Dernière performance (séance différente): ${previousData.reps} reps × ${previousData.weight}kg
                    </div>
                `;
            }
        }
        
        const isSuperset = exercise.supersetId;
        let isLastInSuperset = false;
        
        if (isSuperset) {
            const supersetExercises = activeWorkout.exercises.filter(ex => ex.supersetId === exercise.supersetId);
            isLastInSuperset = exercise.supersetOrder === supersetExercises.length;
        }
        
        setElement.innerHTML = `
            <div style="font-weight: 800; color: ${set.completed ? 'white' : 'var(--text-primary)'}; font-size: var(--font-size-sm); text-align: center; min-width: 50px;">
                S${set.number}
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 3px;">
                <div style="font-size: 9px; color: ${set.completed ? 'rgba(255,255,255,0.9)' : 'var(--text-secondary)'}; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap;">
                    Reps
                </div>
                <input type="text" 
                       style="background: ${set.completed ? 'rgba(0,0,0,0.2)' : 'var(--card-bg)'}; 
                              color: ${set.completed ? 'white' : 'var(--text-primary)'}; 
                              border: 1px solid ${set.completed ? 'rgba(255,255,255,0.3)' : 'var(--border)'}; 
                              border-radius: var(--radius-sm); 
                              padding: 8px 6px; 
                              font-size: var(--font-size-base); 
                              text-align: center; 
                              width: 100%; 
                              font-weight: 700; 
                              height: 36px;" 
                       value="${repsValue}" 
                       oninput="updateSet(${exerciseIndex}, ${setIndex}, 'reps', this.value)" 
                       ${set.completed ? 'disabled' : ''}>
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 3px;">
                <div style="font-size: 9px; color: ${set.completed ? 'rgba(255,255,255,0.9)' : 'var(--text-secondary)'}; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap;">
                    Kg
                </div>
                <input type="number" 
                       style="background: ${set.completed ? 'rgba(0,0,0,0.2)' : 'var(--card-bg)'}; 
                              color: ${set.completed ? 'white' : 'var(--text-primary)'}; 
                              border: 1px solid ${set.completed ? 'rgba(255,255,255,0.3)' : 'var(--border)'}; 
                              border-radius: var(--radius-sm); 
                              padding: 8px 6px; 
                              font-size: var(--font-size-base); 
                              text-align: center; 
                              width: 100%; 
                              font-weight: 700; 
                              height: 36px;" 
                       value="${weightValue}" 
                       oninput="updateSet(${exerciseIndex}, ${setIndex}, 'weight', this.value)" 
                       ${set.completed ? 'disabled' : ''}>
            </div>
            
            <div style="display: flex; gap: 5px; align-items: center; min-width: 100px;">
                ${isSuperset ? (
                    isLastInSuperset ? 
                        `<button style="background: ${set.completed ? 'rgba(255,255,255,0.2)' : 'var(--card-bg)'}; 
                                border: 1px solid ${set.completed ? 'rgba(255,255,255,0.3)' : 'var(--border)'}; 
                                color: ${set.completed ? 'white' : 'var(--text-secondary)'}; 
                                width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: var(--font-size-sm);" 
                         onclick="completeSet(${exerciseIndex}, ${setIndex})" ${set.completed ? 'disabled style="opacity:0.5"' : ''}>
                            <i class="fas fa-running"></i>
                        </button>` : 
                        `<button style="background: var(--warning); color: white; width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: var(--font-size-sm);" 
                         onclick="showSupersetButtonWarning()" ${set.completed ? 'disabled style="opacity:0.5"' : ''}>
                            <i class="fas fa-exclamation-triangle"></i>
                        </button>`
                ) : (
                    `<button style="background: ${set.completed ? 'rgba(255,255,255,0.2)' : 'var(--card-bg)'}; 
                            border: 1px solid ${set.completed ? 'rgba(255,255,255,0.3)' : 'var(--border)'}; 
                            color: ${set.completed ? 'white' : 'var(--text-secondary)'}; 
                            width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: var(--font-size-sm);" 
                     onclick="completeSet(${exerciseIndex}, ${setIndex})" ${set.completed ? 'disabled style="opacity:0.5"' : ''}>
                        <i class="fas fa-check"></i>
                    </button>`
                )}
                <div style="width: 20px; height: 20px; border: 2px solid ${set.completed ? 'var(--success)' : 'var(--border)'}; 
                      border-radius: 4px; display: flex; justify-content: center; align-items: center; cursor: pointer; 
                      background: ${set.completed ? 'var(--success)' : 'var(--card-bg)'};" 
                     onclick="toggleSetCompletion(${exerciseIndex}, ${setIndex})">
                    <div style="color: white; font-size: 10px; font-weight: bold; ${set.completed ? 'opacity: 1' : 'opacity: 0'}">✓</div>
                </div>
            </div>
            
            ${previousSetInfo}
            
            ${isSuperset ? `
                <div style="grid-column: 1 / -1; font-size: 9px; color: #8B5CF6; margin: 5px 0; padding: 6px 8px; background: rgba(139, 92, 246, 0.1); border-radius: 6px; border-left: 2px solid #8B5CF6; font-weight: 600;">
                    <i class="fas fa-link"></i> Superset "${exercise.supersetName || 'Sans nom'}" • Exercice ${exercise.supersetOrder}
                </div>
            ` : ''}
        `;
        
        if (set.completed) {
            setElement.style.background = 'var(--success)';
            setElement.style.borderColor = 'var(--success)';
            setElement.style.color = 'white';
        }
        
        return setElement;
    }
    
    // MODE NON-COMPACT
    const setElement = document.createElement('div');
    setElement.className = `set-item ${set.completed ? 'completed' : ''}`;
    setElement.id = `set-${exerciseIndex}-${setIndex}`;
    
    // S'assurer que les valeurs sont définies
    const repsValue = set.reps !== undefined ? set.reps : userProfile.defaultReps;
    const weightValue = set.weight !== undefined ? set.weight : userProfile.defaultWeight;
    
    // NOUVELLE LOGIQUE: Affichage des informations historiques
    let previousSetInfo = '';
    if (isRedoWorkout && historicalSet) {
        // Pour une reprise: montrer les valeurs exactes de la série historique correspondante
        previousSetInfo = `
            <div class="previous-set-info">
                <i class="fas fa-history"></i> Série précédente (historique): ${historicalSet.reps} reps × ${historicalSet.weight}kg
            </div>
        `;
    } else if (setIndex > 0) {
        // Pour une nouvelle séance sans historique: montrer la série précédente de CETTE séance
        const prevSet = activeWorkout.exercises[exerciseIndex].sets[setIndex-1];
        if (prevSet) {
            previousSetInfo = `
                <div class="previous-set-info">
                    <i class="fas fa-arrow-up"></i> Série précédente: ${prevSet.reps || userProfile.defaultReps} reps × ${prevSet.weight || userProfile.defaultWeight}kg
                </div>
            `;
        }
    } else if (!isRedoWorkout) {
        // Pour la première série d'une nouvelle séance sans historique: montrer la dernière performance globale
        const exerciseName = activeWorkout.exercises[exerciseIndex].name;
        const previousData = findPreviousExerciseData(exerciseName);
        if (previousData) {
            previousSetInfo = `
                <div class="previous-set-info">
                    <i class="fas fa-history"></i> Dernière performance (séance différente): ${previousData.reps} reps × ${previousData.weight}kg
                </div>
            `;
        }
    }
    
    const isSuperset = exercise.supersetId;
    const supersetInfo = isSuperset ? `
        <div class="superset-navigation-hint">
            <i class="fas fa-link"></i> Superset "${exercise.supersetName || 'Sans nom'}" • Exercice ${exercise.supersetOrder}
        </div>
    ` : '';
    
    setElement.innerHTML = `
        <div class="set-header">
            <div class="set-number">Série ${set.number}</div>
            <div class="set-controls">
                <button class="action-btn" onclick="completeSet(${exerciseIndex}, ${setIndex})" ${set.completed ? 'disabled' : ''}>
                    <i class="fas fa-check"></i> Terminer
                </button>
                <div class="checkbox ${set.completed ? 'checked' : ''}" onclick="toggleSetCompletion(${exerciseIndex}, ${setIndex})">
                    <div class="checkmark">✓</div>
                </div>
            </div>
        </div>
        
        <div class="set-inputs-grid">
            <div class="input-group">
                <div class="input-label">
                    <i class="fas fa-redo"></i> Répétitions
                </div>
                <input type="text" class="number-input" value="${repsValue}" 
                       oninput="updateSet(${exerciseIndex}, ${setIndex}, 'reps', this.value)" 
                       ${set.completed ? 'disabled' : ''}>
            </div>
            
            <div class="input-group">
                <div class="input-label">
                    <i class="fas fa-weight-hanging"></i> Poids (kg)
                </div>
                <input type="number" class="number-input" value="${weightValue}" 
                       oninput="updateSet(${exerciseIndex}, ${setIndex}, 'weight', this.value)" 
                       ${set.completed ? 'disabled' : ''}>
            </div>
        </div>
        
        ${supersetInfo}
        
        <div class="set-actions">
            <div class="set-status">
                <span style="font-size: var(--font-size-sm); color: ${set.completed ? 'rgba(255,255,255,0.8)' : 'var(--text-secondary)'};">
                    ${set.completed ? '<i class="fas fa-check-circle"></i> Terminée' : '<i class="far fa-clock"></i> En attente'}
                </span>
            </div>
            <button class="set-complete-btn ${set.completed ? 'completed' : ''}" onclick="completeSet(${exerciseIndex}, ${setIndex})" ${set.completed ? 'disabled' : ''}>
                <i class="fas fa-${set.completed ? 'check' : 'play'}"></i> ${set.completed ? 'Terminée' : 'Marquer comme terminée'}
            </button>
        </div>
        
        ${previousSetInfo}
    `;
    
    return setElement;
}

function findPreviousExerciseData(exerciseName) {
    if (!workoutHistory || workoutHistory.length === 0) {
        return null;
    }
    
    // Chercher la DERNIÈRE SÉANCE où cet exercice a été fait
    for (const session of workoutHistory) {
        for (const exercise of session.exercises) {
            if (exercise.name === exerciseName && exercise.sets && exercise.sets.length > 0) {
                // Calculer la MOYENNE des séries de la dernière séance
                let totalReps = 0;
                let totalWeight = 0;
                let setCount = 0;
                
                exercise.sets.forEach(set => {
                    const reps = parseInt(set.reps) || 0;
                    const weight = parseFloat(set.weight) || 0;
                    
                    if (reps > 0 && weight > 0) {
                        totalReps += reps;
                        totalWeight += weight;
                        setCount++;
                    }
                });
                
                if (setCount > 0) {
                    return {
                        reps: Math.round(totalReps / setCount),
                        weight: Math.round((totalWeight / setCount) * 10) / 10, // 1 décimale
                        sessionDate: session.date,
                        isAverage: true // Indiquer que c'est une moyenne
                    };
                }
            }
        }
    }
    
    return null;
}

function updateSet(exerciseIndex, setIndex, field, value) {
    if (!activeWorkout) return;
    
    // RÉPARATION: Nettoyer la valeur
    let cleanedValue = value;
    
    if (field === 'weight') {
        // Pour le poids: convertir en nombre, remplacer les virgules par des points
        cleanedValue = parseFloat(value.toString().replace(',', '.')) || 0;
    } else if (field === 'reps') {
        // Pour les reps: garder comme texte mais nettoyer
        cleanedValue = value.toString().trim();
        if (cleanedValue === '') {
            cleanedValue = userProfile.defaultReps;
        }
    }
    
    // Mettre à jour la valeur
    activeWorkout.exercises[exerciseIndex].sets[setIndex][field] = cleanedValue;
    
    // Recalculer le poids total
    recalculateTotalWeight();
}

function completeSet(exerciseIndex, setIndex) {
    if (!activeWorkout) return;
    
    const exercise = activeWorkout.exercises[exerciseIndex];
    const set = exercise.sets[setIndex];
    
    // RÉPARATION: S'assurer que les valeurs sont définies avant de compléter
    if (set.reps === undefined) {
        set.reps = userProfile.defaultReps;
    }
    if (set.weight === undefined) {
        set.weight = userProfile.defaultWeight;
    }
    
    // Vérifier si on est dans un superset
    if (exercise.supersetId) {
        const supersetExercises = activeWorkout.exercises.filter(ex => ex.supersetId === exercise.supersetId);
        const isLastExerciseInSuperset = exercise.supersetOrder === supersetExercises.length;
        
        if (!isLastExerciseInSuperset) {
            // Pas le dernier exercice du superset: empêcher d'utiliser le bouton Terminer
            showNotification('⚠️ Pour les supersets, utilisez la case ✓ pour passer au prochain exercice sans timer', 'warning');
            return; // Ne pas terminer la série
        }
        
        // C'est le dernier exercice d'un superset
        set.completed = true;
        activeWorkout.completedSets++;
        
        recalculateTotalWeight();
        updateSetDisplay(exerciseIndex, setIndex);
        
        // ALERTE SONORE ET VIBRATION POUR SÉRIE TERMINÉE
        playSetCompleteAlert();
        
        // Démarrer le timer pour le superset
        if (settings.autoTimer) {
            const restTime = exercise.customRest || userProfile.defaultRest;
            
            if (!document.getElementById('timer-container').classList.contains('active')) {
                currentTimerSeconds = restTime;
                updateTimerDisplay();
                document.getElementById('timer-container').classList.add('active');
                
                // Sauvegarder les informations du superset pour le timer
                currentSupersetExerciseIndex = exerciseIndex;
                currentSupersetSetIndex = setIndex;
                currentSupersetRoundInfo = {
                    supersetExercises: supersetExercises,
                    currentSetIndex: setIndex,
                    timerDuration: restTime
                };
                
                startTimer();
                showNotification(`Timer démarré (${restTime}s) - Repos avant prochain tour`, 'info');
            }
        }
        
        showNotification('Série terminée ! Timer démarré pour le superset');
        handleSupersetProgression(exerciseIndex, setIndex, 'complete');
        
    } else {
        // SÉANCE NORMALE (sans superset)
        set.completed = true;
        activeWorkout.completedSets++;
        
        recalculateTotalWeight();
        updateSetDisplay(exerciseIndex, setIndex);
        
        // ALERTE SONORE ET VIBRATION POUR SÉRIE TERMINÉE
        playSetCompleteAlert();
        
        // Gérer le timer automatique pour les séances normales
        if (settings.autoTimer) {
            const restTime = exercise.customRest || userProfile.defaultRest;
            
            if (!document.getElementById('timer-container').classList.contains('active')) {
                currentTimerSeconds = restTime;
                updateTimerDisplay();
                document.getElementById('timer-container').classList.add('active');
                startTimer();
            } else if (isTimerRunning) {
                if (currentTimerSeconds !== restTime) {
                    currentTimerSeconds = restTime;
                    updateTimerDisplay();
                    pauseTimer();
                    startTimer();
                    showNotification(`Timer ajusté à ${restTime} secondes`);
                }
            }
        }
        
        showNotification('Série terminée !');
        // Pas de progression automatique pour les séances normales
    }
}

function toggleSetCompletion(exerciseIndex, setIndex) {
    if (!activeWorkout) return;
    
    const exercise = activeWorkout.exercises[exerciseIndex];
    const set = exercise.sets[setIndex];
    
    // RÉPARATION: S'assurer que les valeurs sont définies avant de basculer
    if (set.reps === undefined) {
        set.reps = userProfile.defaultReps;
    }
    if (set.weight === undefined) {
        set.weight = userProfile.defaultWeight;
    }
    
    // Vérifier si on est dans un superset
    if (exercise.supersetId) {
        // SUPERSET : ne permettre que de cocher (pas de décocher)
        if (set.completed) {
            showNotification('Dans un superset, une série cochée ne peut pas être décochée', 'warning');
            return;
        }
        
        set.completed = true;
        activeWorkout.completedSets++;
        
        recalculateTotalWeight();
        updateSetDisplay(exerciseIndex, setIndex);
        
        showNotification('Série cochée ✓ (sans timer)');
        handleSupersetProgression(exerciseIndex, setIndex, 'check');
        
    } else {
        // SÉANCE NORMALE : permettre de cocher/décocher
        set.completed = !set.completed;
        
        // Mettre à jour le compteur de séries complétées
        activeWorkout.completedSets += set.completed ? 1 : -1;
        
        // Recalculer le poids total
        recalculateTotalWeight();
        
        // Mettre à jour l'affichage
        updateSetDisplay(exerciseIndex, setIndex);
        
        showNotification(set.completed ? 'Série cochée ✓' : 'Série décochée');
    }
}

function updateSetDisplay(exerciseIndex, setIndex) {
    const setElement = document.getElementById(`set-${exerciseIndex}-${setIndex}`);
    if (!setElement) return;
    
    const set = activeWorkout.exercises[exerciseIndex].sets[setIndex];
    const exercise = activeWorkout.exercises[exerciseIndex];
    
    // Vérifier si cette série doit être mise en évidence dans un superset
    const isSupersetActive = exercise.supersetId && !set.completed;
    
    setElement.className = `set-item ${set.completed ? 'completed' : ''} ${isSupersetActive ? 'superset-active' : ''}`;
    
    const inputs = setElement.querySelectorAll('.number-input');
    inputs.forEach(input => {
        input.disabled = set.completed;
    });
    
    const completeButton = setElement.querySelector('.action-btn');
    if (completeButton) {
        completeButton.disabled = set.completed;
        if (set.completed) {
            completeButton.style.opacity = '0.5';
        } else {
            completeButton.style.opacity = '1';
        }
    }
    
    const checkbox = setElement.querySelector('.checkbox');
    if (checkbox) {
        checkbox.className = `checkbox ${set.completed ? 'checked' : ''}`;
    }
    
    // Mettre à jour les statistiques globales
    document.getElementById('completed-sets').textContent = activeWorkout.completedSets;
}

function recalculateTotalWeight() {
    if (!activeWorkout) return;
    
    let totalWeight = 0;
    activeWorkout.exercises.forEach(exercise => {
        exercise.sets.forEach(set => {
            if (set.completed) {
                // RÉPARATION: S'assurer que les valeurs sont définies
                const reps = parseInt(set.reps) || 0;
                const weight = parseFloat(set.weight) || 0;
                totalWeight += weight * reps;
            }
        });
    });
    
    activeWorkout.totalWeight = totalWeight;
    document.getElementById('total-weight').textContent = `${totalWeight}kg`;
}

function addSet(exerciseIndex) {
    if (!activeWorkout) return;
    
    const exercise = activeWorkout.exercises[exerciseIndex];
    const newSetNumber = exercise.sets.length + 1;
    
    exercise.sets.push({
        number: newSetNumber,
        reps: userProfile.defaultReps,
        weight: userProfile.defaultWeight,
        completed: false
    });
    
    updateWorkoutDisplay();
}

function removeSet(exerciseIndex) {
    if (!activeWorkout) return;
    
    const exercise = activeWorkout.exercises[exerciseIndex];
    if (exercise.sets.length <= 1) {
        showNotification('Un exercice doit avoir au moins une série', 'warning');
        return;
    }
    
    if (confirm(`Supprimer la dernière série de "${exercise.name}" ?`)) {
        // Soustraire si la dernière série était complétée
        if (exercise.sets[exercise.sets.length - 1].completed) {
            activeWorkout.completedSets--;
        }
        
        exercise.sets.pop();
        recalculateTotalWeight();
        updateWorkoutDisplay();
        showNotification('Dernière série supprimée');
    }
}

// Fonction d'avertissement pour le bouton Terminer dans les supersets
function showSupersetButtonWarning() {
    showNotification('⚠️ Dans un superset, utilisez la case ✓ pour passer au prochain exercice sans timer.<br>Le bouton "Terminer (avec timer)" est uniquement pour le DERNIER exercice du superset.', 'warning', 5000);
}

function removeExerciseFromWorkout(exerciseIndex) {
    if (!activeWorkout) return;
    
    if (confirm('Êtes-vous sûr de vouloir supprimer cet exercice de la séance ?')) {
        // Soustraire les séries complétées de cet exercice du compteur total
        const completedSetsInExercise = activeWorkout.exercises[exerciseIndex].sets.filter(set => set.completed).length;
        activeWorkout.completedSets -= completedSetsInExercise;
        
        // Supprimer l'exercice
        activeWorkout.exercises.splice(exerciseIndex, 1);
        
        // Si plus d'exercices, terminer la séance
        if (activeWorkout.exercises.length === 0) {
            completeWorkout();
            return;
        }
        
        // Recalculer le poids total
        recalculateTotalWeight();
        
        // Mettre à jour l'affichage
        updateWorkoutDisplay();
        
        showNotification('Exercice supprimé de la séance');
    }
}

function resetExerciseToDefaults(exerciseIndex) {
    if (!activeWorkout || !activeWorkout.exercises[exerciseIndex]) return;
    
    if (confirm('Réinitialiser toutes les séries de cet exercice aux valeurs par défaut ?')) {
        const exercise = activeWorkout.exercises[exerciseIndex];
        
        exercise.sets.forEach(set => {
            if (!set.completed) {
                set.reps = userProfile.defaultReps;
                set.weight = userProfile.defaultWeight;
            }
        });
        
        updateWorkoutDisplay();
        showNotification('Exercice réinitialisé aux valeurs par défaut');
    }
}

function moveExerciseUpInWorkout(index) {
    if (!activeWorkout || index <= 0) return;
    
    // Vérifier si l'exercice fait partie d'un superset
    const exercise = activeWorkout.exercises[index];
    const prevExercise = activeWorkout.exercises[index - 1];
    
    // Si les deux exercices font partie du même superset, on ne peut pas les séparer
    if (exercise.supersetId && prevExercise.supersetId && exercise.supersetId === prevExercise.supersetId) {
        showNotification('Impossible de séparer les exercices d\'un superset', 'warning');
        return;
    }
    
    // Si on essaye de déplacer un exercice hors de son superset
    if (exercise.supersetId && (!prevExercise.supersetId || prevExercise.supersetId !== exercise.supersetId)) {
        if (!confirm('Déplacer cet exercice hors de son superset ?')) {
            return;
        }
        // Retirer l'exercice du superset
        exercise.supersetId = null;
        exercise.supersetOrder = null;
        exercise.supersetName = null;
        exercise.supersetColor = null;
    }
    
    const temp = activeWorkout.exercises[index];
    activeWorkout.exercises[index] = activeWorkout.exercises[index - 1];
    activeWorkout.exercises[index - 1] = temp;
    
    // Mettre à jour l'ordre des supersets si nécessaire
    updateSupersetOrders();
    
    updateWorkoutDisplay();
    showNotification('Exercice déplacé vers le haut');
}

// Fonction pour mettre à jour l'ordre des exercices dans les supersets
function updateSupersetOrders() {
    // Pour chaque superset, réorganiser l'ordre
    const supersetGroups = {};
    
    activeWorkout.exercises.forEach((ex, idx) => {
        if (ex.supersetId) {
            if (!supersetGroups[ex.supersetId]) {
                supersetGroups[ex.supersetId] = [];
            }
            supersetGroups[ex.supersetId].push({ exercise: ex, index: idx });
        }
    });
    
    // Pour chaque superset, trier par position et mettre à jour l'ordre
    Object.keys(supersetGroups).forEach(supersetId => {
        const exercises = supersetGroups[supersetId];
        // Trier par position dans la séance
        exercises.sort((a, b) => a.index - b.index);
        
        // Mettre à jour l'ordre du superset
        exercises.forEach((item, order) => {
            item.exercise.supersetOrder = order + 1;
        });
    });
}

function moveExerciseDownInWorkout(index) {
    if (!activeWorkout || index >= activeWorkout.exercises.length - 1) return;
    
    // Vérifier si l'exercice fait partie d'un superset
    const exercise = activeWorkout.exercises[index];
    const nextExercise = activeWorkout.exercises[index + 1];
    
    // Si les deux exercices font partie du même superset, on ne peut pas les séparer
    if (exercise.supersetId && nextExercise.supersetId && exercise.supersetId === nextExercise.supersetId) {
        showNotification('Impossible de séparer les exercices d\'un superset', 'warning');
        return;
    }
    
    // Si on essaye de déplacer un exercice hors de son superset
    if (exercise.supersetId && (!nextExercise.supersetId || nextExercise.supersetId !== exercise.supersetId)) {
        if (!confirm('Déplacer cet exercice hors de son superset ?')) {
            return;
        }
        // Retirer l'exercice du superset
        exercise.supersetId = null;
        exercise.supersetOrder = null;
        exercise.supersetName = null;
        exercise.supersetColor = null;
    }
    
    const temp = activeWorkout.exercises[index];
    activeWorkout.exercises[index] = activeWorkout.exercises[index + 1];
    activeWorkout.exercises[index + 1] = temp;
    
    // Mettre à jour l'ordre des supersets si nécessaire
    updateSupersetOrders();
    
    updateWorkoutDisplay();
    showNotification('Exercice déplacé vers le bas');
}

// Fonction pour réduire/développer un exercice
function toggleExerciseCollapse(exerciseIndex) {
    if (!activeWorkout || !activeWorkout.exercises[exerciseIndex]) return;
    
    // Basculer l'état de compression pour cet exercice seulement
    activeWorkout.exercises[exerciseIndex].collapsed = !activeWorkout.exercises[exerciseIndex].collapsed;
    
    // Mettre à jour l'affichage correctement en utilisant l'ID spécifique
    const setsContainer = document.getElementById(`sets-container-${exerciseIndex}`);
    const exerciseElement = document.getElementById(`sets-container-${exerciseIndex}`)?.closest('.workout-exercise');
    
    if (setsContainer && exerciseElement) {
        if (activeWorkout.exercises[exerciseIndex].collapsed) {
            setsContainer.style.display = 'none';
            // Mettre à jour le titre
            const title = exerciseElement.querySelector('.exercise-title');
            if (title) {
                title.style.color = '#3B82F6';
                title.innerHTML = `${activeWorkout.exercises[exerciseIndex].name} <i class="fas fa-chevron-down" style="font-size: 12px; margin-left: 5px;"></i>`;
            }
        } else {
            setsContainer.style.display = 'block';
            // Mettre à jour le titre
            const title = exerciseElement.querySelector('.exercise-title');
            if (title) {
                title.style.color = 'var(--text-primary)';
                title.innerHTML = `${activeWorkout.exercises[exerciseIndex].name} <i class="fas fa-chevron-up" style="font-size: 12px; margin-left: 5px;"></i>`;
            }
        }
    }
    
    showNotification(activeWorkout.exercises[exerciseIndex].collapsed ? 'Exercice réduit' : 'Exercice développé');
}

// Fonction pour modifier le temps de repos d'un exercice
function showCustomRestModal(exerciseIndex) {
    const exercise = activeWorkout.exercises[exerciseIndex];
    if (!exercise) return;
    
    // Récupérer le temps actuel en secondes
    const currentSeconds = exercise.customRest || userProfile.defaultRest;
    const minutes = Math.floor(currentSeconds / 60);
    const seconds = currentSeconds % 60;
    
    // Générer les options pour les pickers - boucle infinie
    const minutesOptions = Array.from({length: 10}, (_, i) => i); // 0-9 minutes
    const secondsOptions = Array.from({length: 60}, (_, i) => i); // 0-59 secondes
    
    const modalContent = `
        <div class="input-group">
            <div class="input-label">⏱️ Temps de repos pour "${exercise.name}"</div>
            <div style="font-size: var(--font-size-xs); color: var(--text-secondary); margin-bottom: 10px;">
                <i class="fas fa-clock"></i> Valeur par défaut: ${userProfile.defaultRest}s 
                (${Math.floor(userProfile.defaultRest/60)}:${(userProfile.defaultRest%60).toString().padStart(2, '0')})
            </div>
        </div>
        
        <div style="margin: 15px 0; text-align: center; background: linear-gradient(135deg, rgba(99,102,241,0.1), rgba(129,140,248,0.05)); padding: 15px; border-radius: var(--radius); border: 1px solid rgba(99,102,241,0.15);">
            <div style="font-size: var(--font-size-2xl); font-weight: 900; color: var(--primary); margin-bottom: 5px; letter-spacing: 2px; text-shadow: 0 2px 8px rgba(99,102,241,0.2);">
                <span id="selected-time-display">${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}</span>
            </div>
            <div style="font-size: var(--font-size-xs); color: var(--text-secondary); font-weight: 600;">
                Total: <span id="total-seconds-display" style="color: var(--primary);">${currentSeconds}</span> secondes
            </div>
        </div>
        
        <div class="time-picker-container">
            <!-- Picker pour les minutes -->
            <div class="time-picker-column">
                <div class="picker-column-label">MINUTES</div>
                <div class="picker-wheel-3d" id="minutes-picker"></div>
            </div>
            
            <div style="align-self: center; font-size: var(--font-size-xl); font-weight: 900; color: var(--primary); margin: 0 3px; text-shadow: 0 1px 4px rgba(99,102,241,0.2);">
                :
            </div>
            
            <!-- Picker pour les secondes -->
            <div class="time-picker-column">
                <div class="picker-column-label">SECONDES</div>
                <div class="picker-wheel-3d" id="seconds-picker"></div>
            </div>
        </div>
        
        <div style="margin-top: 20px; display: flex; gap: 15px;">
            <button class="btn btn-success" onclick="saveCustomRestFromPicker(${exerciseIndex})" style="flex: 1; padding: 14px; font-weight: 900; font-size: var(--font-size-base);">
                <i class="fas fa-check-circle"></i> CONFIRMER
            </button>
        </div>
        
        <input type="hidden" id="selected-time-seconds" value="${currentSeconds}">
        
        <div style="margin-top: 15px; text-align: center; font-size: 10px; color: var(--text-secondary);">
            <i class="fas fa-info-circle"></i> Glissez, tournez la molette ou cliquez pour ajuster
        </div>
    `;
    
    // Créer un modal temporaire
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 320px; padding-bottom: 15px;">
            <div class="modal-header">
                <h3 class="modal-title">⏱️ Temps de repos</h3>
                <button class="modal-close" onclick="this.closest('.modal').remove()">×</button>
            </div>
            <div class="modal-body">
                ${modalContent}
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Initialiser les pickers après l'ajout du DOM
    setTimeout(() => {
        initializeTimePickers();
        
        // Mettre à jour l'affichage en continu
        const updateInterval = setInterval(() => {
            if (document.querySelector('.modal.active')) {
                updateTimeDisplay();
            } else {
                clearInterval(updateInterval);
            }
        }, 100);
    }, 100);
    
    // Sauvegarder l'index de l'exercice dans le modal
    modal.dataset.exerciseIndex = exerciseIndex;
}

// Fonction pour basculer le mode compact par exercice
function toggleExerciseCompactMode(exerciseIndex) {
    if (!activeWorkout || !activeWorkout.exercises[exerciseIndex]) return;
    
    const exercise = activeWorkout.exercises[exerciseIndex];
    
    // Cycle: undefined → true → false → undefined
    if (exercise.compactModeOverride === undefined) {
        // Étape 1: Forcer mode compact
        exercise.compactModeOverride = true;
        showNotification(`Mode compact forcé pour "${exercise.name}"`, 'info');
    } else if (exercise.compactModeOverride === true) {
        // Étape 2: Forcer mode non-compact
        exercise.compactModeOverride = false;
        showNotification(`Mode normal forcé pour "${exercise.name}"`, 'info');
    } else {
        // Étape 3: Revenir au paramètre global
        exercise.compactModeOverride = undefined;
        showNotification(`Mode global utilisé pour "${exercise.name}"`, 'info');
    }
    
    // Recharger l'affichage de l'exercice
    updateWorkoutDisplay();
}

// ==================== PICKER 3D AVANCÉ ====================
class Infinite3DPicker {
    constructor(pickerId, values, initialValue) {
        this.picker = document.getElementById(pickerId);
        this.values = values;
        this.itemHeight = 36; // Réduit de 48
        this.visibleItems = 5;
        this.currentIndex = values.indexOf(initialValue);
        this.position = 0;
        this.velocity = 0;
        this.isDragging = false;
        this.lastY = 0;
        this.lastTime = 0;
        this.animationId = null;
        this.items = []; // Cache pour les éléments DOM
        this.totalItems = this.values.length * 5; // OPTIMISATION: 5 copies au lieu de 10
        this.isInitialized = false;
        
        this.init();
    }
    
    init() {
        // Créer le contenu 3D
        const content = document.createElement('div');
        content.className = 'picker-wheel-content-3d';
        content.style.height = `${this.itemHeight * this.visibleItems}px`;
        
        // Créer beaucoup d'items pour l'effet infini
        const totalItems = this.values.length * 10;
        
        for (let i = 0; i < totalItems; i++) {
            const valueIndex = i % this.values.length;
            const item = document.createElement('div');
            item.className = 'picker-item-3d';
            item.dataset.value = this.values[valueIndex];
            item.dataset.index = valueIndex;
            item.textContent = this.values[valueIndex].toString().padStart(2, '0');
            item.style.transform = `translateY(${(i - Math.floor(totalItems/2)) * this.itemHeight}px)`;
            content.appendChild(item);
        }
        
        // Ajouter le highlight et glow
        const highlight = document.createElement('div');
        highlight.className = 'picker-highlight-3d';
        
        const glow = document.createElement('div');
        glow.className = 'picker-glow';
        
        this.picker.innerHTML = '';
        this.picker.appendChild(highlight);
        this.picker.appendChild(glow);
        this.picker.appendChild(content);
        
        this.content = content;
        this.items = content.querySelectorAll('.picker-item-3d');
        
        // Centrer sur la valeur initiale
        this.centerOnIndex(this.currentIndex + Math.floor(totalItems/2));
        
        // Événements
        this.setupEvents();
        
        // Animation continue
        this.animate();
    }
    
    setupEvents() {
        let startY, startTime;
        
        // Touch events
        this.picker.addEventListener('touchstart', (e) => {
            e.preventDefault();
            this.isDragging = true;
            startY = e.touches[0].clientY;
            startTime = Date.now();
            this.velocity = 0;
            this.lastY = startY;
            this.lastTime = startTime;
            cancelAnimationFrame(this.animationId);
        });
        
        this.picker.addEventListener('touchmove', (e) => {
            if (!this.isDragging) return;
            e.preventDefault();
            
            const currentY = e.touches[0].clientY;
            const currentTime = Date.now();
            const deltaY = currentY - this.lastY;
            const deltaTime = currentTime - this.lastTime;
            
            if (deltaTime > 0) {
                this.velocity = deltaY / deltaTime;
                this.position += deltaY;
                this.updateItems();
                
                this.lastY = currentY;
                this.lastTime = currentTime;
            }
        });
        
        this.picker.addEventListener('touchend', (e) => {
            e.preventDefault();
            this.isDragging = false;
            this.applyMomentum();
        });
        
        // Mouse events
        this.picker.addEventListener('mousedown', (e) => {
            e.preventDefault();
            this.isDragging = true;
            startY = e.clientY;
            startTime = Date.now();
            this.velocity = 0;
            this.lastY = startY;
            this.lastTime = startTime;
            cancelAnimationFrame(this.animationId);
        });
        
        document.addEventListener('mousemove', (e) => {
            if (!this.isDragging) return;
            e.preventDefault();
            
            const currentY = e.clientY;
            const currentTime = Date.now();
            const deltaY = currentY - this.lastY;
            const deltaTime = currentTime - this.lastTime;
            
            if (deltaTime > 0) {
                this.velocity = deltaY / deltaTime;
                this.position += deltaY;
                this.updateItems();
                
                this.lastY = currentY;
                this.lastTime = currentTime;
            }
        });
        
        document.addEventListener('mouseup', (e) => {
            if (!this.isDragging) return;
            this.isDragging = false;
            this.applyMomentum();
        });
        
        // Wheel events
        this.picker.addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 1 : -1;
            this.position += delta * this.itemHeight * 0.5;
            this.updateItems();
            this.applyMomentum();
        });
    }
    
    updateItems() {
        const centerOffset = this.itemHeight * this.visibleItems / 2;
        
        // OPTIMISATION: Utiliser requestAnimationFrame pour les mises à jour
        for (let i = 0; i < this.items.length; i++) {
            const item = this.items[i];
            const y = (i - Math.floor(this.items.length/2)) * this.itemHeight + this.position;
            const distanceFromCenter = Math.abs(y);
            const scale = Math.max(0.3, 1 - distanceFromCenter / (centerOffset * 2));
            const opacity = Math.max(0.1, 1 - distanceFromCenter / (centerOffset * 1.5));
            const rotation = (y / centerOffset) * 30;
            
            // OPTIMISATION: Appliquer les styles en une seule opération
            item.style.transform = `translateY(${y}px) rotateX(${rotation}deg) scale(${scale})`;
            item.style.opacity = opacity;
            item.style.zIndex = Math.round(100 - distanceFromCenter);
            
            // Gérer la sélection
            const isSelected = Math.abs(y) < this.itemHeight * 0.5;
            if (isSelected) {
                item.classList.add('selected');
                this.currentIndex = parseInt(item.dataset.index);
            } else {
                item.classList.remove('selected');
            }
        }
        
        // Normalisation infinie
        if (Math.abs(this.position) > this.itemHeight * this.values.length * 2) {
            this.position %= (this.itemHeight * this.values.length);
        }
        
        // Mettre à jour l'affichage
        if (typeof window.updateTimeDisplay === 'function') {
            window.updateTimeDisplay();
        }
    }
    
    applyMomentum() {
        if (Math.abs(this.velocity) < 0.1) {
            this.snapToNearest();
            return;
        }
        
        const friction = 0.95;
        const apply = () => {
            this.velocity *= friction;
            this.position += this.velocity * 16;
            this.updateItems();
            
            if (Math.abs(this.velocity) > 0.1) {
                this.animationId = requestAnimationFrame(apply);
            } else {
                this.snapToNearest();
            }
        };
        
        this.animationId = requestAnimationFrame(apply);
    }
    
    snapToNearest() {
        const targetPosition = -this.currentIndex * this.itemHeight;
        const startPosition = this.position;
        const distance = targetPosition - startPosition;
        const duration = 300;
        const startTime = Date.now();
        
        const animate = () => {
            const elapsed = Date.now() - startTime;
            const progress = Math.min(elapsed / duration, 1);
            const ease = 1 - Math.pow(1 - progress, 3);
            
            this.position = startPosition + (distance * ease);
            this.updateItems();
            
            if (progress < 1) {
                this.animationId = requestAnimationFrame(animate);
            }
        };
        
        this.animationId = requestAnimationFrame(animate);
    }
    
    centerOnIndex(index) {
        this.position = -index * this.itemHeight;
        this.updateItems();
    }
    
    getSelectedValue() {
        return this.values[this.currentIndex];
    }
    
    animate() {
        // Animation continue subtile
        if (!this.isDragging && Math.abs(this.velocity) < 0.01) {
            this.position += Math.sin(Date.now() * 0.001) * 0.1;
            this.updateItems();
        }
        requestAnimationFrame(() => this.animate());
    }
}

// Gestionnaires globaux
let minutesPicker, secondsPicker;

// MODIFIEZ cette fonction dans la classe Infinite3DPicker ou globalement
function initializeTimePickers() {
    // Récupérer la valeur du champ caché qui contient le bon temps
    const hiddenInput = document.getElementById('selected-time-seconds');
    const currentSeconds = hiddenInput ? parseInt(hiddenInput.value) : (exercise.customRest || userProfile.defaultRest);
    
    const currentMinutes = Math.floor(currentSeconds / 60);
    const currentSecondsRemainder = currentSeconds % 60;
    
    const minutes = Array.from({length: 10}, (_, i) => i); // 0-9 minutes
    const seconds = Array.from({length: 60}, (_, i) => i); // 0-59 secondes
    
    // Réinitialiser les pickers s'ils existent déjà
    if (minutesPicker && typeof minutesPicker.destroy === 'function') {
        minutesPicker.destroy();
    }
    if (secondsPicker && typeof secondsPicker.destroy === 'function') {
        secondsPicker.destroy();
    }
    
    // Initialiser avec les bonnes valeurs
    minutesPicker = new Infinite3DPicker('minutes-picker', minutes, currentMinutes);
    secondsPicker = new Infinite3DPicker('seconds-picker', seconds, currentSecondsRemainder);
}

function updateTimeDisplay() {
    if (!minutesPicker || !secondsPicker) return;
    
    const selectedMinutes = minutesPicker.getSelectedValue();
    const selectedSeconds = secondsPicker.getSelectedValue();
    const totalSeconds = (selectedMinutes * 60) + selectedSeconds;
    
    const timeDisplay = document.getElementById('selected-time-display');
    const secondsDisplay = document.getElementById('total-seconds-display');
    const hiddenInput = document.getElementById('selected-time-seconds');
    
    if (timeDisplay) {
        timeDisplay.textContent = 
            `${selectedMinutes.toString().padStart(2, '0')}:${selectedSeconds.toString().padStart(2, '0')}`;
    }
    
    if (secondsDisplay) {
        secondsDisplay.textContent = totalSeconds;
    }
    
    if (hiddenInput) {
        hiddenInput.value = totalSeconds;
    }
}

function saveCustomRestFromPicker(exerciseIndex) {
    const modal = document.querySelector('.modal.active');
    if (!modal) return;
    
    // Utiliser votre fonction qui marche
    const timeValues = getSelectedTimeValues();
    const totalSeconds = (timeValues.minutes * 60) + timeValues.seconds;
    
    // Validation
    if (totalSeconds < 15) {
        showNotification('Le temps de repos minimum est de 15 secondes', 'error');
        return;
    }
    
    if (totalSeconds > 600) {
        showNotification('Le temps de repos maximum est de 10 minutes', 'error');
        return;
    }
    
    // Mettre à jour l'exercice
    if (activeWorkout && activeWorkout.exercises[exerciseIndex]) {
        activeWorkout.exercises[exerciseIndex].customRest = totalSeconds;
    }
    
    // Fermer le modal
    modal.remove();
    
    // Mettre à jour l'affichage
    if (activeWorkout) {
        updateWorkoutDisplay();
    }
    
    // Notification
    const formattedTime = `${timeValues.minutes.toString().padStart(2, '0')}:${timeValues.seconds.toString().padStart(2, '0')}`;
    showNotification(`⏱️ Temps de repos défini à ${formattedTime} (${totalSeconds}s)`);
}

// REMPLACER la fonction getSelectedTimeValues() par cette nouvelle version :
function getSelectedTimeValues() {
    const minutesPicker = document.getElementById('minutes-picker');
    const secondsPicker = document.getElementById('seconds-picker');
    
    if (!minutesPicker || !secondsPicker) return { minutes: 0, seconds: 0 };
    
    let selectedMinutes = 0;
    let selectedSeconds = 0;
    
    // Chercher les items sélectionnés dans les nouveaux pickers 3D
    const minutesSelected = minutesPicker.querySelector('.picker-item-3d.selected');
    const secondsSelected = secondsPicker.querySelector('.picker-item-3d.selected');
    
    if (minutesSelected) {
        selectedMinutes = parseInt(minutesSelected.dataset.value) || 0;
    }
    
    if (secondsSelected) {
        selectedSeconds = parseInt(secondsSelected.dataset.value) || 0;
    }
    
    return { minutes: selectedMinutes, seconds: selectedSeconds };
}



// ET MODIFIER la fonction saveCustomRestFromPicker pour utiliser la bonne méthode :
function saveCustomRestFromPicker(exerciseIndex) {
    const modal = document.querySelector('.modal.active');
    if (!modal) return;
    
    // Récupérer les valeurs - utiliser la nouvelle méthode
    let timeValues;
    if (minutesPicker && secondsPicker && typeof minutesPicker.getSelectedValue === 'function') {
        // Si les pickers 3D sont disponibles
        timeValues = {
            minutes: minutesPicker.getSelectedValue() || 0,
            seconds: secondsPicker.getSelectedValue() || 0
        };
    } else {
        // Sinon utiliser la méthode par sélection CSS
        timeValues = getSelectedTimeValues();
    }
    
    const totalSeconds = (timeValues.minutes * 60) + timeValues.seconds;
    
    console.log('Temps sélectionné:', timeValues, 'Total secondes:', totalSeconds); // Debug
    
    // Validation
    if (totalSeconds < 15) {
        showNotification('Le temps de repos minimum est de 15 secondes', 'error');
        return;
    }
    
    if (totalSeconds > 600) { // 10 minutes max
        showNotification('Le temps de repos maximum est de 10 minutes', 'error');
        return;
    }
    
    // Mettre à jour l'exercice
    if (activeWorkout && activeWorkout.exercises[exerciseIndex]) {
        activeWorkout.exercises[exerciseIndex].customRest = totalSeconds;
    }
    
    // Fermer le modal
    modal.remove();
    
    // Mettre à jour l'affichage
    if (activeWorkout) {
        updateWorkoutDisplay();
    }
    
    // Notification avec format MM:SS
    const formattedTime = `${timeValues.minutes.toString().padStart(2, '0')}:${timeValues.seconds.toString().padStart(2, '0')}`;
    
    showNotification(`⏱️ Temps de repos défini à ${formattedTime} (${totalSeconds}s)`);
}

// Nouvelle fonction pour sauvegarder depuis le picker
function saveCustomRestFromPicker(exerciseIndex) {
    const modal = document.querySelector('.modal.active');
    if (!modal) return;
    
    // Récupérer les valeurs via la nouvelle fonction
    const timeValues = getSelectedTimeValues();
    const totalSeconds = (timeValues.minutes * 60) + timeValues.seconds;
    
    // Validation
    if (totalSeconds < 15) {
        showNotification('Le temps de repos minimum est de 15 secondes', 'error');
        return;
    }
    
    if (totalSeconds > 600) { // 10 minutes max
        showNotification('Le temps de repos maximum est de 10 minutes', 'error');
        return;
    }
    
    // Mettre à jour l'exercice
    if (activeWorkout && activeWorkout.exercises[exerciseIndex]) {
        activeWorkout.exercises[exerciseIndex].customRest = totalSeconds;
    }
    
    // Fermer le modal
    modal.remove();
    
    // Mettre à jour l'affichage
    if (activeWorkout) {
        updateWorkoutDisplay();
    }
    
    // Notification avec format MM:SS
    const formattedTime = `${timeValues.minutes.toString().padStart(2, '0')}:${timeValues.seconds.toString().padStart(2, '0')}`;
    
    showNotification(`Temps de repos défini à ${formattedTime} (${totalSeconds}s)`);
}

// Remplacer l'ancienne fonction saveCustomRest


// Fonction pour créer un superset
function showSupersetModal(exerciseIndex) {
    if (!activeWorkout) return;
    
    // Générer un nom de superset par défaut
    const existingSupersetCount = activeWorkout.exercises.filter(ex => ex.supersetId).length;
    const defaultSupersetName = `Superset ${Math.floor(existingSupersetCount / 2) + 1}`;
    
    // Dans le HTML généré pour le modal, ajouter une prévisualisation
let modalContent = `
    <div class="input-group">
        <div class="input-label">Nom du superset</div>
        <input type="text" class="number-input" id="superset-name-input" value="${defaultSupersetName}" placeholder="Nom du superset" oninput="updateSupersetPreview()">
    </div>
    <div class="input-group">
        <div class="input-label">⚠️ Les exercices seront regroupés automatiquement</div>
        <div style="font-size: var(--font-size-xs); color: var(--text-secondary); margin-top: 5px;">
            Le premier exercice sélectionné déterminera la position du groupe
        </div>
    </div>
    <div class="input-group">
        <div class="input-label">Prévisualisation de l'ordre :</div>
        <div id="superset-preview" style="font-size: var(--font-size-sm); color: var(--text-secondary); padding: 10px; background: var(--card-bg); border-radius: var(--radius-sm); margin: 10px 0; min-height: 50px;">
            Sélectionnez des exercices pour voir la prévisualisation...
        </div>
    </div>
    <div class="input-group">
        <div class="input-label">Sélectionnez les exercices pour le superset</div>
    </div>
    <div style="max-height: 300px; overflow-y: auto; margin: 15px 0;">
    `;
    
    activeWorkout.exercises.forEach((ex, idx) => {
        const isSelected = ex.supersetId === activeWorkout.exercises[exerciseIndex].supersetId && ex.supersetId;
        const supersetName = ex.supersetId ? `Superset: ${ex.supersetName || 'Sans nom'}` : 'Non lié';
        
        modalContent += `
            <div style="padding: 10px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px;">
                <div class="checkbox ${isSelected ? 'checked' : ''}" onclick="toggleSupersetSelection(this, ${idx})">
                    <div class="checkmark">✓</div>
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 700;">${ex.name}</div>
                    <div style="font-size: var(--font-size-xs); color: ${ex.supersetId ? '#8B5CF6' : 'var(--text-secondary)'};">
                        ${supersetName}
                    </div>
                </div>
            </div>
        `;
    });
    
    modalContent += `
        </div>
        <button class="btn btn-success" onclick="createSuperset(${exerciseIndex})" style="width: 100%;">
            Créer le superset
        </button>
        <button class="btn btn-danger" onclick="removeSuperset(${exerciseIndex})" style="width: 100%; margin-top: 10px;">
            Supprimer le superset
        </button>
    `;
    
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">🔗 Créer un superset</h3>
                <button class="modal-close" onclick="this.closest('.modal').remove()">×</button>
            </div>
            <div class="modal-body">
                ${modalContent}
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function toggleSupersetSelection(checkbox, exerciseIndex) {
    checkbox.classList.toggle('checked');
}

function createSuperset(startExerciseIndex) {
    const selectedExercises = [];
    const checkboxes = document.querySelectorAll('.modal.active .checkbox.checked');
    
    checkboxes.forEach((cb, idx) => {
        const onclickAttr = cb.getAttribute('onclick');
        if (onclickAttr) {
            const match = onclickAttr.match(/toggleSupersetSelection\(this, (\d+)\)/);
            if (match && match[1]) {
                const exerciseIndex = parseInt(match[1]);
                selectedExercises.push(exerciseIndex);
            }
        }
    });
    
    if (selectedExercises.length < 2) {
        showNotification('Sélectionnez au moins 2 exercices', 'error');
        return;
    }
    
    // Récupérer le nom du superset
    const supersetName = document.getElementById('superset-name-input').value || `Superset ${Date.now()}`;
    
    // Générer un ID unique pour le superset
    const supersetId = `superset_${Date.now()}`;
    
    // Trier les exercices sélectionnés par leur position actuelle
    selectedExercises.sort((a, b) => a - b);
    
    // Identifier l'exercice de départ (premier de la sélection)
    const firstExerciseIndex = selectedExercises[0];
    
    // Créer un tableau temporaire pour les exercices du superset
    const supersetExercises = [];
    
    // Extraire les exercices sélectionnés de leur position actuelle
    selectedExercises.forEach((index, order) => {
        const exercise = activeWorkout.exercises[index];
        exercise.supersetId = supersetId;
        exercise.supersetName = supersetName;
        exercise.supersetOrder = order + 1;
        exercise.supersetColor = getSupersetColor(order);
        supersetExercises.push(exercise);
    });
    
    // Retirer les exercices sélectionnés de leur position actuelle
    for (let i = selectedExercises.length - 1; i >= 0; i--) {
        activeWorkout.exercises.splice(selectedExercises[i], 1);
    }
    
    // Insérer tous les exercices du superset à la position du premier exercice
    activeWorkout.exercises.splice(firstExerciseIndex, 0, ...supersetExercises);
    
    // Réorganiser l'ordre du superset pour qu'il soit correct
    activeWorkout.exercises.forEach((ex, idx) => {
        if (ex.supersetId === supersetId) {
            ex.supersetOrder = supersetExercises.findIndex(e => e === ex) + 1;
        }
    });
    
        document.querySelector('.modal.active').remove();
    updateWorkoutDisplay();
    
    // Notification détaillée
    const firstExercise = activeWorkout.exercises[firstExerciseIndex];
    const exerciseNames = supersetExercises.map(ex => ex.name).join(', ');
    showNotification(
        `Superset "${supersetName}" créé !<br>` +
        `Exercices: ${exerciseNames}<br>` +
        `Position: après ${firstExerciseIndex > 0 ? activeWorkout.exercises[firstExerciseIndex - 1]?.name || 'début' : 'début de séance'}`,
        'success'
    );
    
    // Marquer visuellement les exercices en superset
    highlightSupersetExercises(supersetId);
}

// Fonction pour mettre à jour la prévisualisation du superset
function updateSupersetPreview() {
    const checkboxes = document.querySelectorAll('.modal.active .checkbox.checked');
    const selectedExercises = [];
    
    checkboxes.forEach((cb, idx) => {
        const onclickAttr = cb.getAttribute('onclick');
        if (onclickAttr) {
            const match = onclickAttr.match(/toggleSupersetSelection\(this, (\d+)\)/);
            if (match && match[1]) {
                const exerciseIndex = parseInt(match[1]);
                selectedExercises.push({
                    index: exerciseIndex,
                    name: activeWorkout.exercises[exerciseIndex].name,
                    element: cb
                });
            }
        }
    });
    
    const previewElement = document.getElementById('superset-preview');
    const supersetName = document.getElementById('superset-name-input')?.value || 'Superset';
    
    if (selectedExercises.length === 0) {
        previewElement.innerHTML = 'Sélectionnez des exercices pour voir la prévisualisation...';
        return;
    }
    
    // Trier par position actuelle
    selectedExercises.sort((a, b) => a.index - b.index);
    
    let previewHTML = `<strong>${supersetName}</strong> sera placé après :<br>`;
    
    // Trouver quelle position aura le superset (position du premier exercice sélectionné)
    const firstExerciseIndex = Math.min(...selectedExercises.map(e => e.index));
    const exercisesBefore = activeWorkout.exercises.slice(0, firstExerciseIndex);
    
    if (exercisesBefore.length > 0) {
        const lastBefore = exercisesBefore[exercisesBefore.length - 1];
        previewHTML += `→ <strong>${lastBefore.name}</strong><br>`;
    } else {
        previewHTML += `→ <strong>Début de la séance</strong><br>`;
    }
    
    previewHTML += `<br><strong>Ordre dans le superset :</strong><br>`;
    
    selectedExercises.forEach((ex, idx) => {
        previewHTML += `${idx + 1}. ${ex.name}<br>`;
    });
    
    // Montrer ce qui suivra
    const exercisesAfter = activeWorkout.exercises.slice(firstExerciseIndex + selectedExercises.length);
    if (exercisesAfter.length > 0) {
        const firstAfter = exercisesAfter[0];
        previewHTML += `<br><strong>Suivi par :</strong> ${firstAfter.name}`;
    }
    
    previewElement.innerHTML = previewHTML;
}

// Fonction pour mettre à jour la prévisualisation quand on clique sur une case
function toggleSupersetSelection(checkbox, exerciseIndex) {
    checkbox.classList.toggle('checked');
    // Mettre à jour la prévisualisation
    setTimeout(updateSupersetPreview, 10);
}

// Fonction pour générer une couleur pour le superset
function getSupersetColor(index) {
    const colors = ['#8B5CF6', '#EC4899', '#06B6D4', '#10B981', '#F59E0B'];
    return colors[index % colors.length];
}

// Fonction pour mettre en évidence les exercices d'un superset et les regrouper visuellement
function highlightSupersetExercises(supersetId) {
    // Trouver tous les exercices du superset
    const supersetExercises = activeWorkout.exercises.filter(ex => ex.supersetId === supersetId);
    const firstExerciseIndex = activeWorkout.exercises.findIndex(ex => ex.supersetId === supersetId);
    
    // Appliquer un style spécial pour regrouper visuellement
    supersetExercises.forEach((ex, idx) => {
        const exerciseIndex = activeWorkout.exercises.findIndex(e => e === ex);
        const exerciseElement = document.querySelector(`#workout-exercises-container .workout-exercise:nth-child(${exerciseIndex + 1})`);
        
        if (exerciseElement) {
            // Style de bordure pour montrer le regroupement
            exerciseElement.style.borderLeft = `4px solid ${ex.supersetColor || '#8B5CF6'}`;
            exerciseElement.style.marginTop = idx === 0 ? '10px' : '0';
            exerciseElement.style.marginBottom = idx === supersetExercises.length - 1 ? '20px' : '5px';
            exerciseElement.style.borderRadius = idx === 0 ? 'var(--radius) var(--radius) 0 0' : 
                                              idx === supersetExercises.length - 1 ? '0 0 var(--radius) var(--radius)' : '0';
            
            // Ajouter un badge superset avec le numéro d'ordre
            const titleElement = exerciseElement.querySelector('.exercise-title');
            if (titleElement) {
                // Supprimer les anciens badges
                const oldBadge = titleElement.querySelector('.superset-badge');
                if (oldBadge) oldBadge.remove();
                
                // Ajouter le nouveau badge avec numéro
                titleElement.innerHTML += ` <span class="superset-badge" style="background: ${ex.supersetColor || '#8B5CF6'}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: bold;">
                    Superset ${ex.supersetOrder}/${supersetExercises.length}
                </span>`;
            }
            
            // Ajouter une indication visuelle de regroupement
            if (idx === 0) {
                exerciseElement.style.boxShadow = 'var(--shadow-lg)';
            }
        }
    });
    
    // Ajouter un conteneur visuel autour du superset si possible
    setTimeout(() => {
        const supersetContainer = document.createElement('div');
        supersetContainer.className = 'superset-group';
        supersetContainer.style.border = `2px solid ${supersetExercises[0]?.supersetColor || '#8B5CF6'}`;
        supersetContainer.style.borderRadius = 'var(--radius)';
        supersetContainer.style.margin = '10px 0 20px 0';
        supersetContainer.style.padding = '5px';
        supersetContainer.style.background = 'rgba(139, 92, 246, 0.05)';
        
        // Déplacer les exercices dans le conteneur (approche simplifiée)
        supersetExercises.forEach((ex, idx) => {
            const exerciseIndex = activeWorkout.exercises.findIndex(e => e === ex);
            const exerciseElement = document.querySelector(`#workout-exercises-container .workout-exercise:nth-child(${exerciseIndex + 1})`);
            if (exerciseElement && idx === 0) {
                // Insérer le conteneur avant le premier exercice
                exerciseElement.parentNode.insertBefore(supersetContainer, exerciseElement);
                // Déplacer les exercices dans le conteneur
                supersetExercises.forEach((ex2, idx2) => {
                    const exElement = document.querySelector(`#workout-exercises-container .workout-exercise:nth-child(${exerciseIndex + 1 + idx2})`);
                    if (exElement) {
                        supersetContainer.appendChild(exElement.cloneNode(true));
                        exElement.remove();
                    }
                });
            }
        });
    }, 100);
}

// Fonction pour gérer la progression dans un superset
function handleSupersetProgression(exerciseIndex, setIndex, actionType) {
    const exercise = activeWorkout.exercises[exerciseIndex];
    if (!exercise || !exercise.supersetId) return;
    
    // Trouver tous les exercices du même superset
    const supersetExercises = activeWorkout.exercises.filter(ex => ex.supersetId === exercise.supersetId);
    const currentOrder = exercise.supersetOrder;
    
    // Si ce n'est pas le dernier exercice du superset
    if (currentOrder < supersetExercises.length) {
        // Aller au prochain exercice du superset
        
        const nextExercise = supersetExercises.find(ex => ex.supersetOrder === currentOrder + 1);
        if (nextExercise) {
            const nextExerciseIndex = activeWorkout.exercises.findIndex(ex => ex === nextExercise);
            
            // Trouver la série correspondante dans le prochain exercice
            const nextSetIndex = setIndex; // Même numéro de série
            
            // Mettre en évidence et défiler vers la série suivante
            setTimeout(() => {
                highlightAndScrollToSet(nextExerciseIndex, nextSetIndex);
                showNotification(`✓ Passé à l'exercice ${currentOrder + 1}/${supersetExercises.length}`);
            }, 300);
        }
    } else {
        // C'est le dernier exercice du superset
        
        if (actionType === 'complete') {
            // Bouton "Terminer (avec timer)" sur le DERNIER exercice
            // Le timer a déjà été démarré dans completeSet()
            // Après le repos, revenir au premier exercice, série suivante
            
            showNotification('Tour de superset terminé ! Timer démarré', 'success');
            
            // Mettre à jour les informations du superset pour le timer
            updateSupersetTimerInfo(exerciseIndex, setIndex);
            
            // Attendre la fin du timer pour passer à la série suivante
            // Utiliser currentTimerSeconds qui peut avoir été modifié par l'utilisateur
            const timerDuration = currentSupersetRoundInfo ? currentSupersetRoundInfo.timerDuration : (exercise.customRest || userProfile.defaultRest);
            setTimeout(() => {
                goToNextRoundFirstExercise(setIndex, supersetExercises);
            }, (timerDuration * 1000) + 500);
            
        } else if (actionType === 'check') {
            // Case à cocher sur le dernier exercice: revenir au premier SANS timer
            setTimeout(() => {
                goToNextRoundFirstExercise(setIndex, supersetExercises);
                showNotification('Tour complet! Retour au premier exercice (sans timer)');
            }, 300);
        }
    }
}

// Fonction pour aller à la série suivante du premier exercice
function goToNextRoundFirstExercise(currentSetIndex, supersetExercises) {
    const firstExercise = supersetExercises.find(ex => ex.supersetOrder === 1);
    if (!firstExercise) return;
    
    const firstExerciseIndex = activeWorkout.exercises.findIndex(ex => ex === firstExercise);
    const nextSetIndex = currentSetIndex + 1;
    
    // Vérifier si la série suivante existe
    if (nextSetIndex < firstExercise.sets.length) {
        highlightAndScrollToSet(firstExerciseIndex, nextSetIndex);
    } else {
        showNotification('✅ Superset terminé ! Toutes les séries sont complétées', 'success');
    }
}

// Fonction pour mettre en évidence et défiler vers une série
function highlightAndScrollToSet(exerciseIndex, setIndex) {
    const setElement = document.getElementById(`set-${exerciseIndex}-${setIndex}`);
    if (!setElement) return;
    
    // Mettre en évidence
    setElement.style.transform = 'scale(1.03)';
    setElement.style.boxShadow = '0 0 0 4px #8B5CF6, 0 8px 20px rgba(139, 92, 246, 0.4)';
    setElement.style.transition = 'all 0.4s ease';
    setElement.style.zIndex = '10';
    setElement.style.position = 'relative';
    
    // Ajouter une classe temporaire
    setElement.classList.add('superset-highlight');
    
    // Faire défiler l'exercice parent en vue
    const exerciseElement = setElement.closest('.workout-exercise');
    if (exerciseElement) {
        exerciseElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    
    // Retirer l'effet après 3 secondes
    setTimeout(() => {
        setElement.style.transform = '';
        setElement.style.boxShadow = '';
        setElement.style.zIndex = '';
        setElement.classList.remove('superset-highlight');
    }, 3000);
    
    // Mettre le focus sur l'input des répétitions
    setTimeout(() => {
        const repsInput = setElement.querySelector('input[type="text"]');
        if (repsInput && !repsInput.disabled) {
            repsInput.focus();
            repsInput.select();
        }
    }, 600);
}

// Fonction pour mettre en évidence la série suivante dans un superset
function highlightNextSetInSuperset(exerciseIndex, setIndex) {
    const setElement = document.getElementById(`set-${exerciseIndex}-${setIndex}`);
    if (setElement) {
        // Ajouter un effet visuel
        setElement.style.transform = 'scale(1.02)';
        setElement.style.boxShadow = '0 0 0 3px #8B5CF6';
        setElement.style.transition = 'all 0.3s ease';
        
        // Retirer l'effet après 3 secondes
        setTimeout(() => {
            setElement.style.transform = '';
            setElement.style.boxShadow = '';
        }, 3000);
    }
}

function removeSuperset(exerciseIndex) {
    const supersetId = activeWorkout.exercises[exerciseIndex].supersetId;
    if (!supersetId) {
        showNotification('Cet exercice ne fait pas partie d\'un superset', 'error');
        return;
    }
    
    if (confirm('Quitter ce superset ? Les exercices resteront groupés mais sans lien de superset.')) {
        // Retirer le superset de tous les exercices concernés
        activeWorkout.exercises.forEach(ex => {
            if (ex.supersetId === supersetId) {
                delete ex.supersetId;
                delete ex.supersetOrder;
                delete ex.supersetName;
                delete ex.supersetColor;
            }
        });
        
        // RÉPARATION: Mettre à jour aussi la structure supersets si elle existe
        if (activeWorkout.supersets && activeWorkout.supersets[supersetId]) {
            delete activeWorkout.supersets[supersetId];
        }
        
        updateWorkoutDisplay();
        showNotification(`Superset supprimé`);
    }
}

function addExerciseToWorkout() {
    showExerciseSelectionForCreate();
    document.getElementById('select-exercise-modal').dataset.context = 'active-workout';
    
    // Charger tous les exercices
    setTimeout(() => {
        const container = document.getElementById('exercise-selection-list');
        if (!container) return;
        
        container.innerHTML = '';
        
        let filteredExercises = getAllExercises();
        
        filteredExercises.forEach(exercise => {
            const muscle = muscleGroups.find(m => m.id === exercise.muscleGroup);
            const exerciseItem = document.createElement('div');
            exerciseItem.className = 'food-search-simple-item';
            exerciseItem.onclick = () => {
                if (activeWorkout) {
                    activeWorkout.exercises.push({
                        ...exercise,
                        sets: Array(userProfile.defaultSets).fill().map((_, i) => ({
                            number: i + 1,
                            reps: userProfile.defaultReps,
                            weight: userProfile.defaultWeight,
                            completed: false
                        }))
                    });
                    updateWorkoutDisplay();
                    hideModal('select-exercise-modal');
                    showNotification('Exercice ajouté à la séance !');
                }
            };
            
            exerciseItem.innerHTML = `
                <div class="food-search-simple-name">${exercise.name}</div>
                <div class="food-search-simple-details">
                    ${muscle ? muscle.name : exercise.muscleGroup} • ${exercise.difficulty}
                    ${exercise.custom ? ' (Personnalisé)' : ''}
                </div>
            `;
            
            container.appendChild(exerciseItem);
        });
    }, 100);
}

function addToWorkout(exerciseId) {
    const exercise = getAllExercises().find(ex => ex.id === exerciseId);
    if (!exercise) return;
    
    if (!activeWorkout) {
        // Créer une nouvelle séance avec cet exercice
        activeWorkout = {
            name: 'Séance rapide',
            exercises: [],
            startTime: new Date(),
            completedSets: 0,
            totalWeight: 0
        };
        
        activeWorkoutStartTime = new Date();
        activeWorkoutTimer = setInterval(updateWorkoutTimer, 1000);
        showScreen('active-workout-screen');
    }
    
    // Ajouter l'exercice à la séance active
    activeWorkout.exercises.push({
        ...exercise,
        sets: Array(userProfile.defaultSets).fill().map((_, i) => ({
            number: i + 1,
            reps: userProfile.defaultReps,
            weight: userProfile.defaultWeight,
            completed: false
        }))
    });
    
    updateWorkoutDisplay();
    showNotification('Exercice ajouté à la séance !');
}

function showSaveDataModal() {
    showModal('save-data-modal');
}

function saveWorkoutData(saveToHistory = true) {
    if (!activeWorkout) return;
    
    const endTime = new Date();
    const duration = Math.floor((endTime - activeWorkoutStartTime) / 1000);
    
    if (saveToHistory) {
        // SAUVEGARDE DES SUPERSETS POUR CETTE SÉANCE UNIQUEMENT
const supersetInfo = {};

// Collecter les supersets avec leur ORDRE ORIGINAL dans la séance
activeWorkout.exercises.forEach((exercise, index) => {
    if (exercise.supersetId) {
        if (!supersetInfo[exercise.supersetId]) {
            supersetInfo[exercise.supersetId] = {
                id: exercise.supersetId,
                name: exercise.supersetName || `Superset`,
                color: exercise.supersetColor || '#8B5CF6',
                exercises: [],
                // NOUVEAU: Sauvegarder l'index original pour maintenir l'ordre
                originalOrder: []
            };
        }
        
        // Sauvegarder l'exercice avec son index ORIGINAL dans la séance
        supersetInfo[exercise.supersetId].exercises.push({
            originalIndex: index, // Index dans la séance active
            exerciseIndex: index, // Garder pour compatibilité
            name: exercise.name,
            order: exercise.supersetOrder || 1,
            notes: exercise.notes || '' // Sauvegarder les notes aussi
        });
        
        // Garder la trace de l'ordre
        supersetInfo[exercise.supersetId].originalOrder.push(index);
    }
});

// Trier les supersets par leur premier exercice pour maintenir l'ordre
const sortedSupersetInfo = Object.values(supersetInfo).sort((a, b) => {
    const firstA = Math.min(...a.originalOrder);
    const firstB = Math.min(...b.originalOrder);
    return firstA - firstB;
});
        
        // Sauvegarder dans l'historique
        const historyEntry = {
            id: Date.now().toString(),
            name: activeWorkout.name,
            date: new Date().toISOString(),
            duration: duration,
exercises: activeWorkout.exercises.map(exercise => ({
    name: exercise.name,
    muscleGroup: exercise.muscleGroup,
    sets: exercise.sets.filter(set => set.completed).map(set => ({
        reps: set.reps,
        weight: set.weight
    })),
    // CORRECTION: Sauvegarder les infos de superset
    supersetId: exercise.supersetId,
    supersetName: exercise.supersetName,
    supersetColor: exercise.supersetColor,
    supersetOrder: exercise.supersetOrder,
    customRest: exercise.customRest || userProfile.defaultRest,
    // CORRECTION: BIEN sauvegarder les notes
                notes: exercise.notes || '',  // S'assurer que c'est sauvegardé
// SAUVEGARDER LE MODE COMPACT POUR CET EXERCICE
    compactModeOverride: exercise.compactModeOverride
            })),
            stats: {
                totalSets: activeWorkout.completedSets,
                totalWeight: activeWorkout.totalWeight,
                totalExercises: activeWorkout.exercises.length
            },
            // CORRECTION: Sauvegarder les supersets TRIÉS par ordre original
supersets: sortedSupersetInfo
        };
        
        workoutHistory.unshift(historyEntry);
        saveToLocalStorage();
        showNotification('Séance sauvegardée dans l\'historique avec supersets !');
    }
    
    // Fermer le modal
    hideModal('save-data-modal');
    
    // Réinitialiser la séance active
    completeWorkout();
}

function completeWorkoutWithoutSaving() {
    if (confirm('Êtes-vous sûr de vouloir abandonner cette séance sans la sauvegarder ?')) {
        completeWorkout();
    hideModal('save-data-modal');
    showNotification('Séance abandonnée');
}
}

function completeWorkout() {
    if (activeWorkoutTimer) {
        clearInterval(activeWorkoutTimer);
        activeWorkoutTimer = null;
    }
    
    activeWorkout = null;
    activeWorkoutStartTime = null;
    
    showScreen('home-screen');
}

function forceExitWorkout() {
    completeWorkout();
    hideModal('exit-confirm-modal');
}

// ==================== GESTION DU TIMER ====================
function startRestTimer() {
    // currentTimerSeconds est déjà défini par l'appelant (completeSet)
    updateTimerDisplay();
    document.getElementById('timer-container').classList.add('active');
    startTimer();
}

function toggleTimer() {
    if (isTimerRunning) {
        pauseTimer();
    } else {
        startTimer();
    }
}

function startTimer() {
    if (isTimerRunning) return;
    
    isTimerRunning = true;
    document.getElementById('timer-toggle-btn').textContent = 'Pause';
    
    // Bip de démarrage
    playSound('beep');
    vibrate([50]);
    
    const startTime = Date.now();
    const totalSeconds = currentTimerSeconds;
    
    // Si c'est un timer de superset, mettre à jour la durée dans les informations
    if (currentSupersetExerciseIndex !== null && currentSupersetSetIndex !== null && currentSupersetRoundInfo) {
        currentSupersetRoundInfo.timerDuration = totalSeconds;
    }
    
    timerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const remaining = totalSeconds - elapsed;
        
        // Bip d'avertissement à 10 secondes avant la fin
        if (remaining === 10) {
            playSound('beep');
            vibrate([100]);
        }
        
        // Bip d'avertissement à 5 secondes avant la fin
        if (remaining === 5) {
            playSound('beep');
            vibrate([100]);
        }
        
        // Bip d'avertissement à 3 secondes avant la fin
        if (remaining === 3) {
            playSound('beep');
            vibrate([100]);
        }
        
        // Bip d'avertissement à 2 secondes avant la fin
        if (remaining === 2) {
            playSound('beep');
            vibrate([100]);
        }
        
        // Bip d'avertissement à 1 seconde avant la fin
        if (remaining === 1) {
            playSound('beep');
            vibrate([100]);
        }
        
        if (remaining <= 0) {
            clearInterval(timerInterval);
            if (timerProgressInterval) {
                clearInterval(timerProgressInterval);
                timerProgressInterval = null;
            }
            currentTimerSeconds = 0;
            updateTimerDisplay();
            isTimerRunning = false;
            document.getElementById('timer-toggle-btn').textContent = 'Démarrer';
            
            // ALERTE SONORE ET VIBRATION À LA FIN DU TIMER
            playTimerEndAlert();
            
            // Gérer la fin du timer pour les supersets
            if (currentSupersetExerciseIndex !== null && currentSupersetSetIndex !== null && currentSupersetRoundInfo) {
                setTimeout(() => {
                    document.getElementById('timer-container').classList.remove('active');
                    // Exécuter la progression après la fin du timer
                    executeSupersetAfterTimer();
                }, 1000);
            } else {
                // Timer normal
                setTimeout(() => {
                    document.getElementById('timer-container').classList.remove('active');
                }, 2000);
            }
            
            // Message de notification
            showNotification('⏱️ Temps écoulé ! Bip et vibration activés.');
            
            updateTimerProgress(100);
        } else {
            currentTimerSeconds = remaining;
            updateTimerDisplay();
            
            // Mettre à jour la barre de progression
            const progress = ((totalSeconds - remaining) / totalSeconds) * 100;
            updateTimerProgress(progress);
        }
    }, 100);
    
    // Démarrer la barre de progression
    startProgressBar(totalSeconds);
}

// Fonction pour exécuter la progression superset après la fin du timer
// Fonction pour exécuter la progression superset après la fin du timer
function executeSupersetAfterTimer() {
    if (currentSupersetExerciseIndex === null || currentSupersetSetIndex === null || !currentSupersetRoundInfo) {
        return;
    }
    
    const { supersetExercises, currentSetIndex } = currentSupersetRoundInfo;
    
    // Aller à la série suivante du premier exercice
    goToNextRoundFirstExercise(currentSetIndex, supersetExercises);
    
    // Réinitialiser les variables
    currentSupersetExerciseIndex = null;
    currentSupersetSetIndex = null;
    currentSupersetRoundInfo = null;
}

// Fonction pour gérer la fermeture manuelle du timer pendant un superset
function handleManualTimerCloseDuringSuperset() {
    if (currentSupersetExerciseIndex === null || currentSupersetSetIndex === null || !currentSupersetRoundInfo) {
        return;
    }
    
    // Si le timer était en cours, considérer que l'utilisateur veut passer au tour suivant
    if (isTimerRunning) {
        executeSupersetAfterTimer();
        showNotification('Timer fermé - Passage au prochain tour du superset');
    }
}

// Fonction pour mettre à jour les informations du superset quand le timer est modifié
function updateSupersetTimerInfo(exerciseIndex, setIndex) {
    const exercise = activeWorkout.exercises[exerciseIndex];
    if (!exercise || !exercise.supersetId) return;
    
    const supersetExercises = activeWorkout.exercises.filter(ex => ex.supersetId === exercise.supersetId);
    
    // Sauvegarder les informations du superset pour le timer
    currentSupersetExerciseIndex = exerciseIndex;
    currentSupersetSetIndex = setIndex;
    currentSupersetRoundInfo = {
        supersetExercises: supersetExercises,
        currentSetIndex: setIndex,
        timerDuration: currentTimerSeconds
    };
}

function pauseTimer() {
    if (!isTimerRunning) return;
    
    clearInterval(timerInterval);
    if (timerProgressInterval) {
        clearInterval(timerProgressInterval);
        timerProgressInterval = null;
    }
    
    isTimerRunning = false;
    document.getElementById('timer-toggle-btn').textContent = 'Démarrer';
}

// Fonction pour vérifier si on doit exécuter la progression du superset
function checkSupersetProgressionOnTimerClose() {
    if (currentSupersetExerciseIndex !== null && currentSupersetSetIndex !== null && currentSupersetRoundInfo) {
        // Demander confirmation à l'utilisateur
        if (confirm('Fermer le timer maintenant déclenchera la progression au tour suivant du superset. Continuer ?')) {
            executeSupersetAfterTimer();
            return true;
        } else {
            // Annuler, réinitialiser simplement les variables
            currentSupersetExerciseIndex = null;
            currentSupersetSetIndex = null;
            currentSupersetRoundInfo = null;
            return false;
        }
    }
    return true;
}

function adjustTimer(seconds) {
    currentTimerSeconds = Math.max(5, currentTimerSeconds + seconds);
    updateTimerDisplay();
    
    // Si c'est un timer de superset, mettre à jour les informations sauvegardées
    if (currentSupersetExerciseIndex !== null && currentSupersetSetIndex !== null && currentSupersetRoundInfo) {
        // Sauvegarder les informations du superset pour la nouvelle durée
        currentSupersetRoundInfo.timerDuration = currentTimerSeconds;
    }
    
    // Réinitialiser la barre de progression
    if (isTimerRunning) {
        pauseTimer();
        startTimer();
    }
}

function updateTimerDisplay() {
    const minutes = Math.floor(currentTimerSeconds / 60);
    const seconds = currentTimerSeconds % 60;
    document.getElementById('timer-display').textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

function updateTimerProgress(percentage) {
    document.getElementById('timer-progress-bar').style.width = `${percentage}%`;
}

function startProgressBar(totalSeconds) {
    if (timerProgressInterval) {
        clearInterval(timerProgressInterval);
    }
    
    let progress = 0;
    const increment = 100 / totalSeconds;
    
    timerProgressInterval = setInterval(() => {
        if (!isTimerRunning) {
            clearInterval(timerProgressInterval);
            return;
        }
        
        progress += increment;
        if (progress > 100) progress = 100;
        
        updateTimerProgress(progress);
    }, 1000);
}

function hideTimer() {
    const wasTimerRunning = isTimerRunning;
    const wasSupersetTimer = (currentSupersetExerciseIndex !== null);
    
    document.getElementById('timer-container').classList.remove('active');
    pauseTimer();
    
    // Si c'était un timer de superset et qu'il était en cours
    if (wasSupersetTimer && wasTimerRunning) {
        // L'utilisateur a fermé le timer manuellement, exécuter la progression du superset
        setTimeout(() => {
            executeSupersetAfterTimer();
            showNotification('Timer fermé manuellement - Passage au tour suivant du superset');
        }, 300);
    }
    // Si c'était un timer de superset mais qu'il n'était pas en cours
    else if (wasSupersetTimer) {
        // Réinitialiser simplement les variables sans exécuter la progression
        currentSupersetExerciseIndex = null;
        currentSupersetSetIndex = null;
        currentSupersetRoundInfo = null;
    }
}

// Nouvelle fonction pour fermer le timer avec vérification des supersets
function closeTimerWithSupersetCheck() {
    const wasSupersetTimer = (currentSupersetExerciseIndex !== null);
    const wasTimerRunning = isTimerRunning;
    
    // Fermer le timer normalement
    hideTimer();
    
    // Si c'était un timer de superset en cours, demander confirmation
    if (wasSupersetTimer && wasTimerRunning) {
        // Afficher une notification d'information
        showNotification('Superset: progression au tour suivant déclenchée');
    }
}

// ==================== GESTION DE LA NUTRITION ====================
function updateDailyNutritionDisplay() {
    const calorieNeeds = userProfile.calorieNeeds || 2500;
    const proteinNeeds = userProfile.proteinNeeds || 150;
    const carbsNeeds = userProfile.carbsNeeds || 300;
    const fatNeeds = userProfile.fatNeeds || 70;
    
    const calories = dailyNutrition.calories || 0;
    const protein = dailyNutrition.protein || 0;
    const carbs = dailyNutrition.carbs || 0;
    const fat = dailyNutrition.fat || 0;
    
    // Mettre à jour les valeurs
    document.getElementById('daily-calories').textContent = `${calories}/${calorieNeeds} kcal`;
    document.getElementById('daily-protein').textContent = `${protein}g`;
    document.getElementById('daily-carbs').textContent = `${carbs}g`;
    document.getElementById('daily-fat').textContent = `${fat}g`;
    
    // Mettre à jour les cibles
    document.getElementById('protein-target').textContent = `/${proteinNeeds}g`;
    document.getElementById('carbs-target').textContent = `/${carbsNeeds}g`;
    document.getElementById('fat-target').textContent = `/${fatNeeds}g`;
    
    // Calculer les restants
    const caloriesRemaining = calorieNeeds - calories;
    const proteinRemaining = proteinNeeds - protein;
    const carbsRemaining = carbsNeeds - carbs;
    const fatRemaining = fatNeeds - fat;
    
    // Mettre à jour les affichages des restants
    const caloriesBalance = document.getElementById('calories-balance');
    caloriesBalance.textContent = `${caloriesRemaining >= 0 ? '+' : ''}${caloriesRemaining} kcal ${caloriesRemaining >= 0 ? 'restantes' : 'en excès'}`;
    caloriesBalance.className = `calories-balance ${caloriesRemaining >= 0 ? 'positive' : 'negative'}`;
    
    document.getElementById('protein-remaining').textContent = `${proteinRemaining >= 0 ? '+' : ''}${proteinRemaining}g ${proteinRemaining >= 0 ? 'restants' : 'en excès'}`;
    document.getElementById('protein-remaining').className = `macro-remaining ${proteinRemaining >= 0 ? 'positive' : 'negative'}`;
    
    document.getElementById('carbs-remaining').textContent = `${carbsRemaining >= 0 ? '+' : ''}${carbsRemaining}g ${carbsRemaining >= 0 ? 'restants' : 'en excès'}`;
    document.getElementById('carbs-remaining').className = `macro-remaining ${carbsRemaining >= 0 ? 'positive' : 'negative'}`;
    
    document.getElementById('fat-remaining').textContent = `${fatRemaining >= 0 ? '+' : ''}${fatRemaining}g ${fatRemaining >= 0 ? 'restants' : 'en excès'}`;
    document.getElementById('fat-remaining').className = `macro-remaining ${fatRemaining >= 0 ? 'positive' : 'negative'}`;
    
    // Mettre à jour la barre de progression des calories
    const caloriesProgress = Math.min(100, (calories / calorieNeeds) * 100);
    document.getElementById('calories-progress').style.width = `${caloriesProgress}%`;
    
    // Mettre à jour la liste des repas
    updateMealsList();
}

function updateMealsList() {
    const container = document.getElementById('meals-list');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (dailyNutrition.meals.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">🍽️</div>
                <p>Aucun repas aujourd'hui</p>
                <p style="font-size: var(--font-size-sm); margin-top: 6px;">Ajoutez votre premier repas !</p>
            </div>
        `;
        return;
    }
    
    dailyNutrition.meals.forEach((meal, index) => {
        const mealBox = document.createElement('div');
        mealBox.className = 'meal-box';
        
        // Calculer les totaux du repas
        let mealCalories = 0;
        let mealProtein = 0;
        let mealCarbs = 0;
        let mealFat = 0;
        
        meal.foods.forEach(foodItem => {
            const food = getAllFoods().find(f => f.id === foodItem.foodId);
            if (food) {
                const ratio = foodItem.quantity / food.quantity;
                mealCalories += food.calories * ratio;
                mealProtein += food.protein * ratio;
                mealCarbs += food.carbs * ratio;
                mealFat += food.fat * ratio;
            }
        });
        
        mealBox.innerHTML = `
            <div class="meal-box-header">
                <div class="meal-box-title">${meal.name}</div>
                <div class="meal-box-type">${getMealTypeLabel(meal.type)}</div>
            </div>
            <div class="meal-box-content">
                <div style="font-size: var(--font-size-sm); color: var(--text-secondary); margin-bottom: 8px;">
                    ${meal.foods.length} aliment(s) • ${Math.round(mealCalories)} kcal
                </div>
                <div class="meal-box-macros">
                    <div class="meal-box-macro">
                        <div class="meal-box-macro-value protein">${Math.round(mealProtein)}g</div>
                        <div class="meal-box-macro-label">Protéines</div>
                    </div>
                    <div class="meal-box-macro">
                        <div class="meal-box-macro-value carbs">${Math.round(mealCarbs)}g</div>
                        <div class="meal-box-macro-label">Glucides</div>
                    </div>
                    <div class="meal-box-macro">
                        <div class="meal-box-macro-value fat">${Math.round(mealFat)}g</div>
                        <div class="meal-box-macro-label">Lipides</div>
                    </div>
                </div>
                ${meal.notes ? `
                    <div class="meal-box-notes">
                        <strong>Notes:</strong> ${meal.notes}
                    </div>
                ` : ''}
            </div>
            <div style="display: flex; gap: 8px; margin-top: 12px;">
    <button class="detail-btn" onclick="showMealDetailCurrent(${index})" style="flex: 1;">
        <i class="fas fa-eye"></i> Détail
    </button>
    <button class="btn btn-secondary edit-meal-btn" data-meal-index="${index}" style="flex: 1;">
    <i class="fas fa-edit"></i> Modifier
</button>
    <button class="btn btn-danger" onclick="deleteMeal(${index})" style="flex: 1;">
        <i class="fas fa-trash"></i> Supprimer
    </button>
</div>
        `;
        
        container.appendChild(mealBox);
    });
}

function editMealFromNutritionScreen(index) {
    console.log('editMealFromNutritionScreen appelé avec index:', index);
    
    // Vérifier que l'index est valide
    if (index < 0 || index >= dailyNutrition.meals.length) {
        console.error('Index invalide:', index);
        showNotification('Erreur: repas non trouvé', 'error');
        return;
    }
    
    const meal = dailyNutrition.meals[index];
    console.log('Repas à éditer:', meal);
    
    // Ouvrir directement le modal sans passer par editMeal si ça échoue
    try {
        editMeal(index);
        console.log('editMeal exécuté avec succès');
    } catch (error) {
        console.error('Erreur dans editMeal:', error);
        // Essayer d'ouvrir le modal quand même
    }
    
    // Ouvrir le modal
    const modal = document.getElementById('edit-meal-modal');
    if (modal) {
        modal.classList.add('active');
        console.log('Modal ouvert');
    } else {
        console.error('Modal edit-meal-modal non trouvé');
    }
}

function getMealTypeLabel(type) {
    switch(type) {
        case 'petit-dejeuner': return 'Petit-déjeuner';
        case 'dejeuner': return 'Déjeuner';
        case 'diner': return 'Dîner';
        case 'collation': return 'Collation';
        default: return type;
    }
}

function showAddMealModal() {
    showModal('add-meal-modal');
}

function selectMealType(type) {
    document.getElementById('meal-type').value = type;
    
    // MODIFICATION: Meilleure détection
    document.querySelectorAll('.meal-type-option').forEach(option => {
        option.classList.remove('active');
        if (option.getAttribute('data-value') === type) {
            option.classList.add('active');
        }
    });
}

function selectEditMealType(type) {
    document.getElementById('edit-meal-type').value = type;
    
    document.querySelectorAll('#edit-meal-type-options .meal-type-option').forEach(option => {
        option.classList.remove('active');
        if (option.getAttribute('data-value') === type) {
            option.classList.add('active');
        }
    });
}

function editMeal(index) {
    console.log('editMeal appelé avec index:', index);
    const meal = dailyNutrition.meals[index];
    console.log('Repas trouvé:', meal);
    
    if (!meal) {
        console.error('Aucun repas trouvé');
        showNotification('Erreur: repas non trouvé', 'error');
        return;
    }
    
    console.log('Remplissage du formulaire...');
    document.getElementById('edit-meal-name').value = meal.name;
    document.getElementById('edit-meal-type').value = meal.type;
    document.getElementById('edit-meal-notes').value = meal.notes || '';
    
    console.log('Valeurs du formulaire:', {
        name: document.getElementById('edit-meal-name').value,
        type: document.getElementById('edit-meal-type').value,
        notes: document.getElementById('edit-meal-notes').value
    });
    
    // Mettre à jour les boutons de type de repas
    const typeOptions = document.querySelectorAll('#edit-meal-type-options .meal-type-option');
    console.log('Nombre de boutons type:', typeOptions.length);
    
    typeOptions.forEach(option => {
        option.classList.remove('active');
        const optionValue = option.getAttribute('data-value');
        console.log('Option:', option.textContent, 'valeur:', optionValue, 'type repas:', meal.type);
        if (optionValue === meal.type) {
            option.classList.add('active');
            document.getElementById('edit-meal-type').value = meal.type;
        }
    });
    
    // Ajouter les aliments
    const foodsList = document.getElementById('edit-meal-foods-list');
    console.log('Conteneur aliments trouvé:', !!foodsList);
    foodsList.innerHTML = '';
    
    console.log('Nombre d\'aliments dans le repas:', meal.foods.length);
    meal.foods.forEach((foodItem, i) => {
        const food = getAllFoods().find(f => f.id === foodItem.foodId);
        console.log(`Aliment ${i}:`, food ? food.name : 'Non trouvé', 'ID:', foodItem.foodId);
        
        if (food) {
            const foodElement = document.createElement('div');
            foodElement.className = 'meal-food-item';
            foodElement.dataset.foodId = foodItem.foodId;
            foodElement.dataset.quantity = foodItem.quantity;
            
            foodElement.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: 700; margin-bottom: 3px;">${food.name}</div>
                        <div class="food-calories-display" style="font-size: var(--font-size-xs); color: var(--text-secondary);">
                            ${Math.round(food.calories * (foodItem.quantity / food.quantity))} kcal (P:${Math.round(food.protein * (foodItem.quantity / food.quantity))}g C:${Math.round(food.carbs * (foodItem.quantity / food.quantity))}g L:${Math.round(food.fat * (foodItem.quantity / food.quantity))}g)
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="number" class="quantity-input" value="${foodItem.quantity}" style="width: 70px;" oninput="updateFoodQuantityAndCalories(this, '${food.id}')">
                        <button class="action-btn" onclick="removeFoodFromMeal(this)" title="Supprimer">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            
            foodsList.appendChild(foodElement);
        }
    });
    
    document.getElementById('edit-meal-modal').dataset.mealIndex = index;
    console.log('editMeal terminé');
}

function showFoodSearchModalForMeal() {
    showModal('food-search-modal');
}

function searchFoodsSimple(searchTerm) {
    const container = document.getElementById('food-search-results-simple');
    const emptyState = document.getElementById('food-search-empty-simple');
    const categoryFilter = document.getElementById('food-search-category').value;
    
    if (!container) return;
    
    let filteredFoods = getAllFoods();
    
    // Filtrer par recherche textuelle
    if (searchTerm) {
        filteredFoods = filteredFoods.filter(food => 
            food.name.toLowerCase().includes(searchTerm.toLowerCase())
        );
    }
    
    // Filtrer par catégorie
    if (categoryFilter !== 'all') {
        if (categoryFilter === 'halal') {
            filteredFoods = filteredFoods.filter(food => food.halal);
        } else if (categoryFilter === 'personnalisé') {
            filteredFoods = filteredFoods.filter(food => food.custom);
        } else {
            filteredFoods = filteredFoods.filter(food => food.category === categoryFilter);
        }
    }
    
    container.innerHTML = '';
    
    if (filteredFoods.length === 0) {
        emptyState.style.display = 'block';
        return;
    }
    
    emptyState.style.display = 'none';
    
    filteredFoods.forEach(food => {
        const foodItem = document.createElement('div');
        foodItem.className = 'food-search-simple-item';
        foodItem.onclick = () => addFoodToMealFromSearch(food.id);
        
        foodItem.innerHTML = `
            <div class="food-search-simple-name">${food.name}</div>
            <div class="food-search-simple-details">
                ${food.calories} kcal / ${food.quantity}g • ${food.category}
                ${food.halal ? ' • 🕌 Halal' : ''}
                ${food.custom ? ' • 🎨 Personnalisé' : ''}
            </div>
        `;
        
        container.appendChild(foodItem);
    });
}

function addFoodToMealFromSearch(foodId) {
    const food = getAllFoods().find(f => f.id === foodId);
    if (!food) return;
    
    // Déterminer dans quel modal nous sommes
    let listId = 'meal-foods-list';
    
    if (document.getElementById('edit-meal-modal').classList.contains('active')) {
        listId = 'edit-meal-foods-list';
    } else if (document.getElementById('add-meal-modal').classList.contains('active')) {
        listId = 'meal-foods-list';
    }
    
    // Créer un élément d'aliment
    const foodItem = document.createElement('div');
    foodItem.className = 'meal-food-item';
    foodItem.dataset.foodId = foodId;
    foodItem.dataset.quantity = food.quantity;
    
    foodItem.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <div style="font-weight: 700; margin-bottom: 3px;">${food.name}</div>
                <div style="font-size: var(--font-size-xs); color: var(--text-secondary);">
                    ${food.calories} kcal / ${food.quantity}g
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <input type="number" class="quantity-input" value="${food.quantity}" style="width: 70px;" oninput="updateFoodQuantity(this, '${foodId}')">
                <button class="action-btn" onclick="removeFoodFromMeal(this)" title="Supprimer">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;
    
    const list = document.getElementById(listId);
    if (list) {
        list.appendChild(foodItem);
        showNotification('Aliment ajouté au repas');
    }
    
    hideModal('food-search-modal');
}

function updateFoodQuantity(input, foodId) {
    const foodItem = input.closest('.meal-food-item');
    if (foodItem) {
        foodItem.dataset.quantity = input.value;
    }
}

// MODIFICATION: Fonction pour mettre à jour les calories quand on change la quantité
function updateFoodQuantityAndCalories(input, foodId) {
    const foodItem = input.closest('.meal-food-item');
    if (foodItem) {
        foodItem.dataset.quantity = input.value;
        
        // Calculer et afficher les nouvelles calories
        const food = getAllFoods().find(f => f.id === foodId);
        if (food) {
            const ratio = input.value / food.quantity;
            const calories = Math.round(food.calories * ratio);
            const protein = Math.round(food.protein * ratio);
            const carbs = Math.round(food.carbs * ratio);
            const fat = Math.round(food.fat * ratio);
            
            // Mettre à jour l'affichage si un élément d'affichage existe
            const display = foodItem.querySelector('.food-calories-display');
            if (display) {
                display.textContent = `${calories} kcal (P:${protein}g C:${carbs}g L:${fat}g)`;
            }
        }
    }
}


function removeFoodFromMeal(button) {
    const foodItem = button.closest('.meal-food-item');
    foodItem.remove();
}

function showAddFoodFromMeal(context) {
    showAddFoodModal();
    document.getElementById('add-food-modal').dataset.context = context;
    // MODIFICATION
    document.getElementById('add-food-modal').dataset.mealContext = context;
}

function saveMeal() {
    const name = document.getElementById('meal-name').value.trim();
    const type = document.getElementById('meal-type').value;
    const notes = document.getElementById('meal-notes').value.trim();
    
    if (!name) {
        showNotification('Veuillez saisir un nom pour le repas', 'error');
        return;
    }
    
    // Récupérer les aliments
    const foods = [];
    document.querySelectorAll('#meal-foods-list .meal-food-item').forEach(item => {
        foods.push({
            foodId: item.dataset.foodId,
            quantity: parseFloat(item.dataset.quantity) || 100
        });
    });
    
    if (foods.length === 0) {
        showNotification('Veuillez ajouter au moins un aliment', 'error');
        return;
    }
    
    // Créer le repas
    const newMeal = {
        id: Date.now().toString(),
        name: name,
        type: type,
        foods: foods,
        notes: notes,
        date: new Date().toISOString()
    };
    
    // Ajouter au journal du jour
    dailyNutrition.meals.push(newMeal);
    nutritionHistory.push(newMeal);

    // Recalculer les totaux nutritionnels
    updateNutritionTotals();
    
    // Sauvegarder
    saveToLocalStorage();
    
    // Mettre à jour l'affichage
    updateDailyNutritionDisplay();
    
    // Réinitialiser le formulaire
    resetMealForm();
    
    hideModal('add-meal-modal');
    showNotification('Repas ajouté avec succès !');
}

function resetMealForm() {
    document.getElementById('meal-name').value = '';
    document.getElementById('meal-type').value = 'petit-dejeuner';
    document.getElementById('meal-foods-list').innerHTML = '';
    document.getElementById('meal-notes').value = '';
    
    // Réinitialiser les boutons de type de repas
    document.querySelectorAll('.meal-type-option').forEach((option, index) => {
        option.classList.toggle('active', index === 0);
    });
}

function updateNutritionTotals() {
    let totalCalories = 0;
    let totalProtein = 0;
    let totalCarbs = 0;
    let totalFat = 0;
    
    dailyNutrition.meals.forEach(meal => {
        meal.foods.forEach(foodItem => {
            const food = getAllFoods().find(f => f.id === foodItem.foodId);
            if (food) {
                const ratio = foodItem.quantity / food.quantity;
                totalCalories += food.calories * ratio;
                totalProtein += food.protein * ratio;
                totalCarbs += food.carbs * ratio;
                totalFat += food.fat * ratio;
            }
        });
    });
    
    dailyNutrition.calories = Math.round(totalCalories);
    dailyNutrition.protein = Math.round(totalProtein);
    dailyNutrition.carbs = Math.round(totalCarbs);
    dailyNutrition.fat = Math.round(totalFat);
}

function editMeal(index) {
    console.log('editMeal appelé avec index:', index);
    const meal = dailyNutrition.meals[index];
    
    if (!meal) {
        console.error('Aucun repas trouvé');
        showNotification('Erreur: repas non trouvé', 'error');
        return;
    }
    
    // Remplir le formulaire
    document.getElementById('edit-meal-name').value = meal.name;
    document.getElementById('edit-meal-type').value = meal.type;
    document.getElementById('edit-meal-notes').value = meal.notes || '';
    
    // Mettre à jour les boutons de type de repas
    document.querySelectorAll('#edit-meal-type-options .meal-type-option').forEach(option => {
        option.classList.remove('active');
        const optionValue = option.getAttribute('data-value');
        if (optionValue === meal.type) {
            option.classList.add('active');
            document.getElementById('edit-meal-type').value = meal.type;
        }
    });
    
    // Ajouter les aliments
    const foodsList = document.getElementById('edit-meal-foods-list');
    foodsList.innerHTML = '';
    
    meal.foods.forEach(foodItem => {
        const food = getAllFoods().find(f => f.id === foodItem.foodId);
        if (food) {
            const foodElement = document.createElement('div');
            foodElement.className = 'meal-food-item';
            foodElement.dataset.foodId = foodItem.foodId;
            foodElement.dataset.quantity = foodItem.quantity;
            
            foodElement.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: 700; margin-bottom: 3px;">${food.name}</div>
                        <div class="food-calories-display" style="font-size: var(--font-size-xs); color: var(--text-secondary);">
                            ${Math.round(food.calories * (foodItem.quantity / food.quantity))} kcal (P:${Math.round(food.protein * (foodItem.quantity / food.quantity))}g C:${Math.round(food.carbs * (foodItem.quantity / food.quantity))}g L:${Math.round(food.fat * (foodItem.quantity / food.quantity))}g)
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="number" class="quantity-input" value="${foodItem.quantity}" style="width: 70px;" oninput="updateFoodQuantityAndCalories(this, '${food.id}')">
                        <button class="action-btn" onclick="removeFoodFromMeal(this)" title="Supprimer">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            
            foodsList.appendChild(foodElement);
        }
    });
    
    document.getElementById('edit-meal-modal').dataset.mealIndex = index;
}

function showFoodSearchModalForEdit() {
    showModal('food-search-modal');
    document.activeModal = 'edit-meal-modal';
}

function saveEditedMeal() {
    const index = parseInt(document.getElementById('edit-meal-modal').dataset.mealIndex);
    if (isNaN(index) || !dailyNutrition.meals[index]) return;
    
    const name = document.getElementById('edit-meal-name').value.trim();
    const type = document.getElementById('edit-meal-type').value;
    const notes = document.getElementById('edit-meal-notes').value.trim();
    
    if (!name) {
        showNotification('Veuillez saisir un nom pour le repas', 'error');
        return;
    }
    
    // Récupérer les aliments
    const foods = [];
    document.querySelectorAll('#edit-meal-foods-list .meal-food-item').forEach(item => {
        foods.push({
            foodId: item.dataset.foodId,
            quantity: parseFloat(item.dataset.quantity) || 100
        });
    });
    
    if (foods.length === 0) {
        showNotification('Veuillez ajouter au moins un aliment', 'error');
        return;
    }
    
    // Mettre à jour le repas
    dailyNutrition.meals[index] = {
        ...dailyNutrition.meals[index],
        name: name,
        type: type,
        foods: foods,
        notes: notes
    };
    
// Mettre à jour également dans nutritionHistory si le repas y existe
const mealIndexInHistory = nutritionHistory.findIndex(m => m.id === dailyNutrition.meals[index].id);
if (mealIndexInHistory !== -1) {
    nutritionHistory[mealIndexInHistory] = dailyNutrition.meals[index];
} else {
    nutritionHistory.push(dailyNutrition.meals[index]);
}

    // Recalculer les totaux nutritionnels
    updateNutritionTotals();
    
    // Sauvegarder
    saveToLocalStorage();
    
    // Mettre à jour l'affichage
    updateDailyNutritionDisplay();
    
    // Réinitialiser le formulaire
    resetEditMealForm();
    
    hideModal('edit-meal-modal');
    showNotification('Repas modifié avec succès !');
}

function editFoodQuantity(foodId, currentQuantity) {
    const food = getAllFoods().find(f => f.id === foodId);
    if (!food) return;
    
    const modalContent = document.getElementById('edit-food-quantity-content');
    modalContent.innerHTML = `
        <div class="input-group">
            <div class="input-label">Nom de l'aliment</div>
            <div style="padding: 10px; background: var(--card-bg); border-radius: var(--radius-sm); margin-bottom: 15px;">
                ${food.name}
            </div>
        </div>
        <div class="input-group">
            <div class="input-label">Quantité actuelle (g)</div>
            <input type="number" class="number-input" id="edit-quantity-value" value="${currentQuantity}" min="1" max="1000">
        </div>
        <div class="input-group">
            <div class="input-label">Calcul des valeurs</div>
            <div style="padding: 10px; background: var(--card-bg); border-radius: var(--radius-sm); margin-bottom: 15px;">
                <div>Calories: <span id="calc-calories">${Math.round(food.calories * (currentQuantity / food.quantity))}</span> kcal</div>
                <div>Protéines: <span id="calc-protein">${Math.round(food.protein * (currentQuantity / food.quantity))}</span>g</div>
                <div>Glucides: <span id="calc-carbs">${Math.round(food.carbs * (currentQuantity / food.quantity))}</span>g</div>
                <div>Lipides: <span id="calc-fat">${Math.round(food.fat * (currentQuantity / food.quantity))}</span>g</div>
            </div>
        </div>
        <button class="btn btn-success" onclick="updateFoodQuantityInEdit('${foodId}')" style="width: 100%; margin-top: 15px;">
            Mettre à jour
        </button>
    `;
    
    document.getElementById('edit-quantity-value').oninput = function() {
        const newQty = parseInt(this.value) || 0;
        const ratio = newQty / food.quantity;
        
        document.getElementById('calc-calories').textContent = Math.round(food.calories * ratio);
        document.getElementById('calc-protein').textContent = Math.round(food.protein * ratio);
        document.getElementById('calc-carbs').textContent = Math.round(food.carbs * ratio);
        document.getElementById('calc-fat').textContent = Math.round(food.fat * ratio);
    };
    
    document.getElementById('edit-food-quantity-modal').dataset.foodId = foodId;
    showModal('edit-food-quantity-modal');
}

function updateFoodQuantityInEdit(foodId) {
    const newQuantity = parseInt(document.getElementById('edit-quantity-value').value) || 100;
    const modalId = document.activeModal || 'edit-meal-modal';
    
    // Trouver l'élément d'aliment dans la liste d'édition
    const foodItem = document.querySelector(`#edit-meal-foods-list .meal-food-item[data-food-id="${foodId}"]`);
    if (foodItem) {
        foodItem.dataset.quantity = newQuantity;
        
        // Mettre à jour l'affichage des calories
        const food = getAllFoods().find(f => f.id === foodId);
        if (food) {
            const ratio = newQuantity / food.quantity;
            const calories = Math.round(food.calories * ratio);
            const protein = Math.round(food.protein * ratio);
            const carbs = Math.round(food.carbs * ratio);
            const fat = Math.round(food.fat * ratio);
            
            const display = foodItem.querySelector('.food-calories-display');
            if (display) {
                display.textContent = `${calories} kcal (P:${protein}g C:${carbs}g L:${fat}g)`;
            }
        }
        
        hideModal('edit-food-quantity-modal');
        showNotification('Quantité mise à jour');
    }
}

function resetEditMealForm() {
    document.getElementById('edit-meal-name').value = '';
    document.getElementById('edit-meal-type').value = 'petit-dejeuner';
    document.getElementById('edit-meal-foods-list').innerHTML = '';
    document.getElementById('edit-meal-notes').value = '';
    
    // Réinitialiser les boutons de type de repas
    document.querySelectorAll('#edit-meal-type-options .meal-type-option').forEach((option, index) => {
        option.classList.toggle('active', index === 0);
    });
}

function deleteMeal(index) {
    if (confirm('Êtes-vous sûr de vouloir supprimer ce repas ?')) {
        dailyNutrition.meals.splice(index, 1);
        
        // Recalculer les totaux nutritionnels
        updateNutritionTotals();
        
        // Sauvegarder
        saveToLocalStorage();
        
        // Mettre à jour l'affichage
        updateDailyNutritionDisplay();
        
        showNotification('Repas supprimé avec succès !');
    }
}

// MODIFICATION: Fonction pour voir le détail d'un repas du jour
function showMealDetailCurrent(index) {
    const meal = dailyNutrition.meals[index];
    if (!meal) return;
    
    // Calculer les totaux
    let mealCalories = 0;
    let mealProtein = 0;
    let mealCarbs = 0;
    let mealFat = 0;
    
    meal.foods.forEach(foodItem => {
        const food = getAllFoods().find(f => f.id === foodItem.foodId);
        if (food) {
            const ratio = foodItem.quantity / food.quantity;
            mealCalories += food.calories * ratio;
            mealProtein += food.protein * ratio;
            mealCarbs += food.carbs * ratio;
            mealFat += food.fat * ratio;
        }
    });
    
    let detailHTML = `
        <div class="history-detail-content">
            <div class="history-detail-header">
                <div>
                    <h4 style="margin: 0 0 5px 0; color: var(--text-primary);">${meal.name}</h4>
                    <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">
                        ${getMealTypeLabel(meal.type)} • ${meal.foods.length} aliments
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">Total</div>
                    <div style="font-weight: 700; color: var(--primary); font-size: var(--font-size-lg);">
                        ${Math.round(mealCalories)} kcal
                    </div>
                </div>
            </div>
            
            <div style="margin: 20px 0;">
                <div style="margin-bottom: 20px;">
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
        <!-- Première ligne : Calories et Protéines -->
        <div style="text-align: center; padding: 10px; background: var(--card-bg); border-radius: var(--radius-sm); border: 1px solid var(--border);">
            <div style="font-size: var(--font-size-lg); font-weight: 900; color: var(--primary);">${Math.round(mealCalories)}</div>
            <div style="font-size: var(--font-size-xs); color: var(--text-secondary);">CALORIES</div>
        </div>
        <div style="text-align: center; padding: 10px; background: var(--card-bg); border-radius: var(--radius-sm); border: 1px solid var(--border);">
            <div style="font-size: var(--font-size-lg); font-weight: 900; color: #EF4444;">${Math.round(mealProtein)}g</div>
            <div style="font-size: var(--font-size-xs); color: var(--text-secondary);">PROTÉINES</div>
        </div>
    </div>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <!-- Deuxième ligne : Glucides et Lipides -->
        <div style="text-align: center; padding: 10px; background: var(--card-bg); border-radius: var(--radius-sm); border: 1px solid var(--border);">
            <div style="font-size: var(--font-size-lg); font-weight: 900; color: #10B981;">${Math.round(mealCarbs)}g</div>
            <div style="font-size: var(--font-size-xs); color: var(--text-secondary);">GLUCIDES</div>
        </div>
        <div style="text-align: center; padding: 10px; background: var(--card-bg); border-radius: var(--radius-sm); border: 1px solid var(--border);">
            <div style="font-size: var(--font-size-lg); font-weight: 900; color: #F59E0B;">${Math.round(mealFat)}g</div>
            <div style="font-size: var(--font-size-xs); color: var(--text-secondary);">LIPIDES</div>
        </div>
    </div>
</div>
                
                <h4 style="margin: 0 0 15px 0; color: var(--text-primary);">Aliments (${meal.foods.length})</h4>
    `;
    
    meal.foods.forEach(foodItem => {
        const food = getAllFoods().find(f => f.id === foodItem.foodId);
        if (food) {
            const ratio = foodItem.quantity / food.quantity;
            const foodCalories = Math.round(food.calories * ratio);
            
            detailHTML += `
                <div class="history-detail-exercise" style="margin-bottom: 10px;">
                    <div class="history-detail-exercise-name">${food.name}</div>
                    <div style="font-size: var(--font-size-xs); color: var(--text-secondary); margin-bottom: 10px;">
                        ${foodItem.quantity}g • ${foodCalories} kcal
                    </div>
                </div>
            `;
        }
    });
    
    if (meal.notes) {
        detailHTML += `
            <div style="margin-top: 20px; padding: 15px; background: var(--card-bg); border-radius: var(--radius-sm); border: 1px solid var(--border);">
                <div style="font-weight: 700; color: var(--text-primary); margin-bottom: 8px;">📝 Notes</div>
                <div style="color: var(--text-secondary); font-size: var(--font-size-sm); white-space: pre-wrap;">${meal.notes}</div>
            </div>
        `;
    }
    
    detailHTML += `
            </div>
        </div>
    `;
    
    document.getElementById('meal-detail-title').textContent = 'Détail du repas';
    document.getElementById('meal-detail-content').innerHTML = detailHTML;
    showModal('meal-detail-modal');
}


function addFoodToMeal(foodId) {
    const food = getAllFoods().find(f => f.id === foodId);
    if (!food) return;
    
    if (food.favorite) {
        // Si l'aliment est un favori, demander confirmation
        document.getElementById('favorite-food-modal').dataset.foodId = foodId;
        document.getElementById('favorite-food-message').textContent = 
            `"${food.name}" est dans vos favoris. Voulez-vous ajouter un repas avec cet aliment ?`;
        showModal('favorite-food-modal');
    } else {
        // Ajouter directement à un nouveau repas
        showAddMealModal();
        setTimeout(() => {
            addFoodToMealFromSearch(foodId);
        }, 300);
    }
}

function addFavoriteFoodToMeal() {
    const foodId = document.getElementById('favorite-food-modal').dataset.foodId;
    hideModal('favorite-food-modal');
    
    showAddMealModal();
    setTimeout(() => {
        addFoodToMealFromSearch(foodId);
    }, 300);
}

function updateFavoriteFoods() {
    const container = document.getElementById('favorite-foods-container');
    if (!container) return;
    
    const favoriteFoods = getAllFoods().filter(food => food.favorite).slice(0, 10);
    
    container.innerHTML = '';
    
    if (favoriteFoods.length === 0) {
        container.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 20px; color: var(--text-secondary);">
                <div style="font-size: 24px; margin-bottom: 10px;">⭐</div>
                <p>Aucun aliment favori</p>
                <p style="font-size: var(--font-size-sm); margin-top: 6px;">Marquez des aliments comme favoris pour les voir ici</p>
            </div>
        `;
        return;
    }
    
    favoriteFoods.forEach(food => {
        const foodItem = document.createElement('div');
        foodItem.className = 'favorite-food-item';
        foodItem.onclick = () => addFoodToMeal(food.id);
        
        foodItem.innerHTML = `
            <div class="favorite-food-star">⭐</div>
            <div class="favorite-food-name">${food.name}</div>
            <div class="favorite-food-calories">${food.calories} kcal</div>
        `;
        
        container.appendChild(foodItem);
    });
}

function refreshFavoriteFoods() {
    updateFavoriteFoods();
    showNotification('Favoris actualisés');
}
// MODIFICATION: Fonction pour les exercices favoris
function loadFavoriteExercises() {
    const container = document.getElementById('favorite-exercises-container');
    if (!container) return;
    
    const favoriteExercises = getAllExercises().filter(ex => ex.favorite).slice(0, 10);
    
    container.innerHTML = '';
    
    if (favoriteExercises.length === 0) {
        container.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 20px; color: var(--text-secondary);">
                <div style="font-size: 24px; margin-bottom: 10px;">⭐</div>
                <p>Aucun exercice favori</p>
                <p style="font-size: var(--font-size-sm); margin-top: 6px;">Marquez des exercices comme favoris pour les voir ici</p>
            </div>
        `;
        return;
    }
    
    favoriteExercises.forEach(exercise => {
        const muscle = muscleGroups.find(m => m.id === exercise.muscleGroup);
        const exerciseItem = document.createElement('div');
        exerciseItem.className = 'favorite-food-item';
        exerciseItem.onclick = () => addToWorkout(exercise.id);
        
        exerciseItem.innerHTML = `
            <div class="favorite-food-star">⭐</div>
            <div class="favorite-food-name">${exercise.name}</div>
            <div class="favorite-food-calories">${muscle ? muscle.name : exercise.muscleGroup}</div>
        `;
        
        container.appendChild(exerciseItem);
    });
}

function refreshFavoriteExercises() {
    loadFavoriteExercises();
    showNotification('Exercices favoris actualisés');
}

// ==================== GESTION DE L'HISTORIQUE ====================
function showHistoryTab(tab) {
    document.getElementById('workout-history-tab').classList.toggle('hidden', tab !== 'workouts');
    document.getElementById('nutrition-history-tab').classList.toggle('hidden', tab !== 'nutrition');
    
    document.querySelectorAll('#history-screen .history-tab').forEach((btn, index) => {
        btn.classList.toggle('active', (tab === 'workouts' && index === 0) || (tab === 'nutrition' && index === 1));
    });
    
    if (tab === 'workouts') {
        loadWorkoutHistory();
    } else if (tab === 'nutrition') {
        loadNutritionHistory();
    }
}

function loadWorkoutHistory() {
    const container = document.getElementById('workout-history');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (workoutHistory.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">📊</div>
                <p>Aucune séance enregistrée</p>
                <p style="font-size: var(--font-size-sm); margin-top: 6px;">Terminez une séance pour la voir ici</p>
            </div>
        `;
        return;
    }
    
    workoutHistory.forEach((entry, index) => {
        const historyItem = document.createElement('div');
        historyItem.className = 'history-item-improved';
        
        const date = new Date(entry.date);
        const formattedDate = date.toLocaleDateString('fr-FR', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        const durationHours = Math.floor(entry.duration / 3600);
        const durationMinutes = Math.floor((entry.duration % 3600) / 60);
        const durationSeconds = entry.duration % 60;
        const formattedDuration = durationHours > 0 ? 
            `${durationHours}h ${durationMinutes.toString().padStart(2, '0')}min` : 
            `${durationMinutes}min ${durationSeconds.toString().padStart(2, '0')}s`;
        
        // Calculer le total des répétitions et des pauses
const totalReps = calculateTotalReps(entry);
const totalPauseSeconds = calculateTotalPause(entry);
const pauseMinutes = Math.floor(totalPauseSeconds / 60);
const formattedPause = `${pauseMinutes}min`;

// Dans le HTML, ajouter une nouvelle stat
historyItem.innerHTML = `
    <div class="history-item-improved-header">
        <div class="history-item-improved-title">${entry.name}</div>
        <div class="history-item-improved-date">${formattedDate}</div>
    </div>
    <div class="history-item-improved-stats">
        <div class="history-item-improved-stat">
            <div class="history-item-improved-stat-value">${entry.stats.totalExercises}</div>
            <div class="history-item-improved-stat-label">Exercices</div>
        </div>
        <div class="history-item-improved-stat">
            <div class="history-item-improved-stat-value">${entry.stats.totalSets}</div>
            <div class="history-item-improved-stat-label">Séries</div>
        </div>
        <div class="history-item-improved-stat">
            <div class="history-item-improved-stat-value">${totalReps}</div>
            <div class="history-item-improved-stat-label">Répétitions</div>
        </div>
        <div class="history-item-improved-stat">
            <div class="history-item-improved-stat-value">${entry.stats.totalWeight}kg</div>
            <div class="history-item-improved-stat-label">Poids</div>
        </div>
        <div class="history-item-improved-stat">
            <div class="history-item-improved-stat-value">${formattedDuration}</div>
            <div class="history-item-improved-stat-label">Durée</div>
        </div>
        <div class="history-item-improved-stat">
            <div class="history-item-improved-stat-value">${formattedPause}</div>
            <div class="history-item-improved-stat-label">Pause</div>
        </div>
    </div>
            <div class="history-item-improved-actions">
    <button class="detail-btn" onclick="showWorkoutHistoryDetail(${index})">
        <i class="fas fa-eye"></i> Détails
    </button>
    <button class="redo-btn" onclick="redoWorkout(${index})">
        <i class="fas fa-redo"></i> Refaire
    </button>
    <button class="btn btn-danger" onclick="deleteWorkoutHistory(${index})" style="padding: 8px 12px; font-size: var(--font-size-xs);">
        <i class="fas fa-trash"></i> Supprimer
    </button>
</div>
        `;
        
        container.appendChild(historyItem);
    });
}

function showWorkoutHistoryView(view) {
    document.getElementById('workout-history-list').classList.toggle('hidden', view !== 'list');
    document.getElementById('workout-history-evolution').classList.toggle('hidden', view !== 'evolution');
    document.getElementById('workout-history-exercises').classList.toggle('hidden', view !== 'exercises');
    
    document.querySelectorAll('.history-view-toggle-btn').forEach((btn, index) => {
        const views = ['list', 'evolution', 'exercises'];
        btn.classList.toggle('active', views[index] === view);
    });
    
    if (view === 'evolution') {
        loadEvolutionChart();
    } else if (view === 'exercises') {
        loadExercisesChart();
    }
}

// MODIFICATION: Graphique d'évolution
function loadEvolutionChart() {
    const container = document.getElementById('evolution-chart');
    if (!container) return;
    
    if (workoutHistory.length === 0) {
        container.innerHTML = `
            <div class="chart-placeholder">
                <div style="text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 10px;">📊</div>
                    <p>Aucune donnée à afficher</p>
                    <p style="font-size: var(--font-size-sm);">Terminez des séances pour voir votre évolution</p>
                </div>
            </div>
        `;
        return;
    }
    
    // Prendre les 10 dernières séances
    const recentWorkouts = workoutHistory.slice(0, 10).reverse();
    const dates = recentWorkouts.map(w => {
        const date = new Date(w.date);
        return date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' });
    });
    
    const weights = recentWorkouts.map(w => w.stats.totalWeight);
    const maxWeight = Math.max(...weights, 100);
    
    // Définir des couleurs pour les barres
const colors = [
    'linear-gradient(to top, #6366F1, #818CF8)',
    'linear-gradient(to top, #10B981, #34D399)',
    'linear-gradient(to top, #F59E0B, #FBBF24)',
    'linear-gradient(to top, #EF4444, #FCA5A5)',
    'linear-gradient(to top, #8B5CF6, #A78BFA)',
    'linear-gradient(to top, #06B6D4, #22D3EE)',
    'linear-gradient(to top, #EC4899, #F472B6)',
    'linear-gradient(to top, #84CC16, #A3E635)',
    'linear-gradient(to top, #F97316, #FB923C)',
    'linear-gradient(to top, #64748B, #94A3B8)'
];

        container.innerHTML = `
            <div style="height: 200px; display: flex; align-items: flex-end; gap: 8px; padding: 20px 15px; border-bottom: 1px solid var(--border); background: var(--card-bg); border-radius: var(--radius-sm); margin-bottom: 10px;">
                ${weights.map((weight, index) => `
                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center; height: 100%;">
                        <div style="width: 35px; height: ${(weight / maxWeight) * 100}%; 
                              background: ${colors[index % colors.length]}; 
                              border-radius: 6px 6px 0 0; position: relative; cursor: pointer;
                              box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: all 0.3s ease;
                              border: 2px solid rgba(255,255,255,0.3);" 
                             onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.25)'" 
                             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'"
                             title="${recentWorkouts[index].name}: ${weight}kg">
                            <div style="position: absolute; top: -35px; left: 50%; transform: translateX(-50%); 
                                  font-size: var(--font-size-sm); font-weight: 800; white-space: nowrap;
                                  background: var(--primary); color: white; padding: 4px 10px; border-radius: 12px; 
                                  border: 2px solid white; box-shadow: var(--shadow);">
                                ${weight}kg
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
            <div style="display: flex; justify-content: space-between; padding: 10px 15px; font-size: var(--font-size-sm); color: var(--text-primary); font-weight: 600; background: var(--card-bg); border-radius: var(--radius-sm);">
                ${dates.map(date => `<div style="transform: rotate(-45deg); transform-origin: left center; white-space: nowrap;">${date}</div>`).join('')}
            </div>
        `;
}

function loadExercisesChart() {
    const container = document.getElementById('exercises-chart');
    const listContainer = document.getElementById('exercises-detailed-list');
    if (!container || !listContainer) return;
    
    if (workoutHistory.length === 0) {
        container.innerHTML = `
            <div class="chart-placeholder">
                <div style="text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 10px;">🏋️‍♂️</div>
                    <p>Aucun exercice à analyser</p>
                </div>
            </div>
        `;
        listContainer.innerHTML = '';
        return;
    }
    
    // Analyser les exercices les plus fréquents
    const exerciseStats = {};
    
    workoutHistory.forEach(session => {
        session.exercises.forEach(exercise => {
            if (!exerciseStats[exercise.name]) {
                exerciseStats[exercise.name] = {
                    count: 0,
                    totalWeight: 0,
                    totalReps: 0,
                    maxWeight: 0,
                    avgWeight: 0,
                    muscleGroup: exercise.muscleGroup
                };
            }
            exerciseStats[exercise.name].count++;
            
            exercise.sets.forEach(set => {
                const weight = set.weight || 0;
                const reps = parseInt(set.reps) || 0;
                exerciseStats[exercise.name].totalWeight += weight * reps;
                exerciseStats[exercise.name].totalReps += reps;
                if (weight > exerciseStats[exercise.name].maxWeight) {
                    exerciseStats[exercise.name].maxWeight = weight;
                }
            });
            
            // Calculer la moyenne après chaque session
            if (exerciseStats[exercise.name].totalReps > 0) {
                exerciseStats[exercise.name].avgWeight = Math.round(exerciseStats[exercise.name].totalWeight / exerciseStats[exercise.name].totalReps);
            }
        });
    });
    
    const sortedExercises = Object.entries(exerciseStats)
        .sort(([, a], [, b]) => b.count - a.count)
        .slice(0, 8);
    
    const maxCount = Math.max(...sortedExercises.map(([, stats]) => stats.count), 1);
    
            container.innerHTML = `
        <div style="height: 200px; display: flex; align-items: flex-end; gap: 12px; padding: 20px 15px; border-bottom: 1px solid var(--border); background: var(--card-bg); border-radius: var(--radius-sm); margin-bottom: 10px;">
            ${sortedExercises.map(([name, stats], index) => `
                <div style="flex: 1; display: flex; flex-direction: column; align-items: center; height: 100%;">
                    <div style="width: 40px; height: ${(stats.count / maxCount) * 100}%; 
                          background: linear-gradient(to top, ${getMuscleColor(stats.muscleGroup)}, ${adjustColor(getMuscleColor(stats.muscleGroup), 40)}); 
                          border-radius: 8px 8px 0 0; position: relative; cursor: pointer;
                          box-shadow: 0 6px 16px rgba(0,0,0,0.2); transition: all 0.3s ease;
                          border: 3px solid rgba(255,255,255,0.4);" 
                         onmouseover="this.style.transform='translateY(-8px) scale(1.05)'; this.style.boxShadow='0 12px 24px rgba(0,0,0,0.3)'" 
                         onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 6px 16px rgba(0,0,0,0.2)'"
                         title="${name}: ${stats.count} séances">
                        <div style="position: absolute; top: -40px; left: 50%; transform: translateX(-50%); 
                              font-size: var(--font-size-sm); font-weight: 800; white-space: nowrap;
                              background: var(--card-bg); color: var(--text-primary); padding: 5px 12px; border-radius: 14px; 
                              border: 2px solid ${getMuscleColor(stats.muscleGroup)}; box-shadow: var(--shadow);">
                            ${stats.count}
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
        <div style="display: flex; justify-content: space-between; padding: 10px 15px; font-size: var(--font-size-sm); color: var(--text-primary); font-weight: 600; background: var(--card-bg); border-radius: var(--radius-sm);">
            ${sortedExercises.map(([name], index) => `<div style="text-align: center; width: 40px; overflow: hidden; text-overflow: ellipsis;" title="${name}">${index + 1}</div>`).join('')}
        </div>
    `;
    
    // Liste détaillée
    listContainer.innerHTML = `
        <div class="card" style="margin-top: 15px;">
            <h4 style="margin: 0 0 15px 0;">Exercices les plus réalisés</h4>
            ${sortedExercises.map(([name, stats]) => `
                <div style="padding: 10px; border-bottom: 1px solid var(--border);">
                    <div style="font-weight: 700; color: var(--text-primary);">${name}</div>
                    <div style="display: flex; flex-direction: column; gap: 8px; font-size: var(--font-size-sm); color: var(--text-secondary); margin-top: 5px;">
    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
        <span>${stats.count} séances</span>
        <span>${stats.totalReps} répétitions</span>
        <span>${stats.totalWeight}kg total</span>
    </div>
    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
        <span style="color: #EF4444;">Max: ${stats.maxWeight}kg</span>
        <span>Moy: ${stats.avgWeight}kg/rep</span>
    </div>
</div>
                </div>
            `).join('')}
        </div>
    `;
}

function getMuscleColor(muscleGroupId) {
    const muscle = muscleGroups.find(m => m.id === muscleGroupId);
    return muscle ? muscle.color : '#6366F1';
}


function showWorkoutHistoryDetail(index) {
    const entry = workoutHistory[index];
    if (!entry) return;
    
    const date = new Date(entry.date);
    const formattedDate = date.toLocaleDateString('fr-FR', {
        weekday: 'long',
        day: '2-digit',
        month: 'long',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
    
    const durationHours = Math.floor(entry.duration / 3600);
    const durationMinutes = Math.floor((entry.duration % 3600) / 60);
    const durationSeconds = entry.duration % 60;
    const formattedDuration = durationHours > 0 ? 
        `${durationHours}h ${durationMinutes.toString().padStart(2, '0')}min ${durationSeconds.toString().padStart(2, '0')}s` : 
        `${durationMinutes}min ${durationSeconds.toString().padStart(2, '0')}s`;
    
    let contentHTML = `
        <div class="history-detail-content">
            <div class="history-detail-header">
                <div>
                    <h4 style="margin: 0 0 5px 0; color: var(--text-primary);">${entry.name}</h4>
                    <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">${formattedDate}</div>
                </div>
            </div>
            
            <div style="margin: 20px 0;">
                <div class="history-stats-grid" style="margin-bottom: 20px;">
                    <div class="history-stat-exercice" style="padding: 10px; background: var(--card-bg); border-radius: var(--radius-sm); border: 1px solid var(--border);">
    <div class="history-stat-value">${entry.stats.totalExercises} exercices</div>
    <div class="history-stat-label">EXERCICES</div>
</div>
<div class="history-stat-series" style="text-align: center; padding: 10px; background: var(--card-bg); border-radius: var(--radius-sm); border: 1px solid var(--border);">
    <div style="font-size: var(--font-size-lg); font-weight: 900; color: var(--primary);">${entry.stats.totalSets}</div>
    <div style="font-size: var(--font-size-xs); color: var(--text-secondary);">SÉRIES</div>
</div>
<div class="history-stat-repetitions" style="text-align: center; padding: 10px; background: var(--card-bg); border-radius: var(--radius-sm); border: 1px solid var(--border);">
    <div style="font-size: var(--font-size-lg); font-weight: 900; color: var(--primary);">${calculateTotalReps(entry)}</div>
    <div style="font-size: var(--font-size-xs); color: var(--text-secondary);">RÉPÉTITIONS</div>
</div>
<div class="history-stat-poids" style="text-align: center; padding: 10px; background: var(--card-bg); border-radius: var(--radius-sm); border: 1px solid var(--border);">
    <div style="font-size: var(--font-size-lg); font-weight: 900; color: var(--primary);">${entry.stats.totalWeight}</div>
    <div style="font-size: var(--font-size-xs); color: var(--text-secondary);">KG TOTAL</div>
</div>
<div class="history-stat-duree" style="text-align: center; padding: 10px; background: var(--card-bg); border-radius: var(--radius-sm); border: 1px solid var(--border);">
    <div style="font-size: var(--font-size-lg); font-weight: 900; color: var(--primary);">${formattedDuration}</div>
    <div style="font-size: var(--font-size-xs); color: var(--text-secondary);">DURÉE</div>
</div>
                </div>
                
                <!-- RÉPARATION: Afficher les supersets s'ils existent -->
                ${entry.supersets && entry.supersets.length > 0 ? `
                    <div style="margin-bottom: 20px; padding: 15px; background: var(--card-bg); border-radius: var(--radius-sm); border: 1px solid var(--border);">
                        <div style="font-weight: 700; color: var(--text-primary); margin-bottom: 10px;">
                            <i class="fas fa-link"></i> Supsets (${entry.supersets.length})
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                            ${entry.supersets.map(superset => `
                                <div style="padding: 8px 12px; background: ${superset.color || '#8B5CF6'}; color: white; border-radius: var(--radius-sm); font-size: var(--font-size-sm); font-weight: 600;">
                                    ${superset.name} (${superset.exercises ? superset.exercises.length : 0} ex.)
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <h4 style="margin: 0 0 15px 0; color: var(--text-primary);">Exercices détaillés</h4>
    `;
    
    // Group exercises by superset for better display
    const exercisesBySuperset = {};
    const standaloneExercises = [];
    
    entry.exercises.forEach((exercise, index) => {
        if (exercise.supersetId) {
            if (!exercisesBySuperset[exercise.supersetId]) {
                exercisesBySuperset[exercise.supersetId] = [];
            }
            exercisesBySuperset[exercise.supersetId].push({...exercise, originalIndex: index});
        } else {
            standaloneExercises.push({...exercise, originalIndex: index});
        }
    });
    
    // Display standalone exercises first
    standaloneExercises.forEach(item => {
        const exercise = item;
        const muscle = muscleGroups.find(m => m.id === exercise.muscleGroup);
        const muscleName = muscle ? muscle.name : exercise.muscleGroup;
        
        contentHTML += `
            <div class="history-detail-exercise">
                <div class="history-detail-exercise-name">${exercise.name}</div>
                <div style="font-size: var(--font-size-xs); color: var(--text-secondary); margin-bottom: 10px;">
                    <span style="color: ${muscle ? muscle.color : '#666'}">●</span> ${muscleName}
                </div>
                <div class="history-detail-sets">
        `;
        
        exercise.sets.forEach((set, setIndex) => {
            contentHTML += `
                <div class="history-detail-set" style="background: ${setIndex % 2 === 0 ? 'var(--card-bg)' : '#f0f9ff'}; border: 1px solid ${setIndex % 2 === 0 ? 'var(--border)' : '#bae6fd'};">
    S${setIndex + 1}: ${set.reps} × ${set.weight}kg
</div>
            `;
        });
        
        // Calculer les totaux pour cet exercice
        const totalReps = exercise.sets.reduce((sum, set) => sum + (parseInt(set.reps) || 0), 0);
        const totalWeight = exercise.sets.reduce((sum, set) => sum + (set.weight || 0) * (parseInt(set.reps) || 0), 0);
        const avgWeight = exercise.sets.length > 0 ? Math.round(totalWeight / totalReps) : 0;
        const maxWeight = Math.max(...exercise.sets.map(set => set.weight || 0));

        contentHTML += `
                </div>
                <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px; font-size: var(--font-size-xs);">
                    <div style="padding: 4px 8px; background: var(--card-bg); border-radius: 10px; border: 1px solid var(--border);">
                        Total: ${totalReps} reps
                    </div>
                    <div style="padding: 4px 8px; background: var(--card-bg); border-radius: 10px; border: 1px solid var(--border);">
                        Poids: ${totalWeight}kg
                    </div>
                </div>
                <div style="display: flex; gap: 5px; margin-top: 5px; font-size: var(--font-size-xs);">
                    <div style="padding: 4px 8px; background: var(--card-bg); border-radius: 10px; border: 1px solid var(--border);">
                        Moyenne: ${avgWeight}kg/rep
                    </div>
                    <div style="padding: 4px 8px; background: var(--card-bg); border-radius: 10px; border: 1px solid var(--border); color: #EF4444;">
                        Max: ${maxWeight}kg
                    </div>
                </div>
                
                <!-- SECTION NOTES DE L'EXERCICE (NOUVEAU) -->
                ${exercise.notes ? `
                    <div style="margin-top: 15px; padding: 12px; background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(236, 72, 153, 0.05)); border-radius: var(--radius-sm); border-left: 3px solid #8B5CF6;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <div style="width: 24px; height: 24px; background: linear-gradient(135deg, #8B5CF6, #EC4899); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px;">
                                <i class="fas fa-sticky-note"></i>
                            </div>
                            <div style="font-weight: 700; color: #8B5CF6;">Notes</div>
                        </div>
                        <div style="color: var(--text-primary); font-size: var(--font-size-sm); white-space: pre-wrap; line-height: 1.5; padding: 0 4px;">
                            ${exercise.notes}
                        </div>
                    </div>
                ` : ''}
                
            </div>
        `;
    });
    
    // Display exercises by superset
    Object.values(exercisesBySuperset).forEach(supersetGroup => {
        if (supersetGroup.length > 0) {
            const firstExercise = supersetGroup[0];
            const supersetName = firstExercise.supersetName || `Superset`;
            const supersetColor = firstExercise.supersetColor || '#8B5CF6';
            
            contentHTML += `
                <div style="margin: 20px 0 10px 0; padding: 10px; background: ${supersetColor}20; border-radius: var(--radius-sm); border-left: 4px solid ${supersetColor};">
                    <div style="font-weight: 700; color: ${supersetColor}; margin-bottom: 10px;">
                        <i class="fas fa-link"></i> ${supersetName}
                    </div>
            `;
            
            // Sort by superset order
            supersetGroup.sort((a, b) => (a.supersetOrder || 0) - (b.supersetOrder || 0));
            
            supersetGroup.forEach((exercise, idx) => {
                const muscle = muscleGroups.find(m => m.id === exercise.muscleGroup);
                const muscleName = muscle ? muscle.name : exercise.muscleGroup;
                
                contentHTML += `
                    <div class="history-detail-exercise" style="margin-bottom: ${idx === supersetGroup.length - 1 ? '0' : '15px'};">
                        <div class="history-detail-exercise-name">
                            ${exercise.supersetOrder ? `<span style="color: ${supersetColor}; font-weight: 800; margin-right: 8px;">${exercise.supersetOrder}.</span>` : ''}
                            ${exercise.name}
                        </div>
                        <div style="font-size: var(--font-size-xs); color: var(--text-secondary); margin-bottom: 10px;">
                            <span style="color: ${muscle ? muscle.color : '#666'}">●</span> ${muscleName}
                        </div>
                        <div class="history-detail-sets">
                `;
                
                exercise.sets.forEach((set, setIndex) => {
                    contentHTML += `
                        <div class="history-detail-set" style="background: ${setIndex % 2 === 0 ? 'var(--card-bg)' : '#f0f9ff'}; border: 1px solid ${setIndex % 2 === 0 ? 'var(--border)' : '#bae6fd'};">
                            S${setIndex + 1}: ${set.reps} × ${set.weight}kg
                        </div>
                    `;
                });
                
                const totalReps = exercise.sets.reduce((sum, set) => sum + (parseInt(set.reps) || 0), 0);
                const totalWeight = exercise.sets.reduce((sum, set) => sum + (set.weight || 0) * (parseInt(set.reps) || 0), 0);
                
                contentHTML += `
                        </div>
                        <div style="display: flex; gap: 5px; margin-top: 10px; font-size: var(--font-size-xs);">
                            <div style="padding: 4px 8px; background: var(--card-bg); border-radius: 10px; border: 1px solid var(--border);">
                                Total: ${totalReps} reps
                            </div>
                            <div style="padding: 4px 8px; background: var(--card-bg); border-radius: 10px; border: 1px solid var(--border);">
                                Poids: ${totalWeight}kg
                            </div>
                        </div>
                        
                        <!-- SECTION NOTES POUR EXERCICES EN SUPERSET (NOUVEAU) -->
                        ${exercise.notes ? `
                            <div style="margin-top: 15px; padding: 12px; background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(236, 72, 153, 0.05)); border-radius: var(--radius-sm); border-left: 3px solid ${supersetColor};">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <div style="width: 24px; height: 24px; background: linear-gradient(135deg, ${supersetColor}, ${adjustColor(supersetColor, 40)}); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px;">
                                        <i class="fas fa-sticky-note"></i>
                                    </div>
                                    <div style="font-weight: 700; color: ${supersetColor};">Notes</div>
                                </div>
                                <div style="color: var(--text-primary); font-size: var(--font-size-sm); white-space: pre-wrap; line-height: 1.5; padding: 0 4px;">
                                    ${exercise.notes}
                                </div>
                            </div>
                        ` : ''}
                        
                    </div>
                `;
            });
            
            contentHTML += `</div>`;
        }
    });
    
    contentHTML += `
            </div>
            
            <div class="history-detail-actions">
                <button class="btn btn-success" onclick="redoWorkout(${index})" style="flex: 1;">
                    <i class="fas fa-redo"></i> Refaire
                </button>
                <button class="btn btn-danger" onclick="deleteWorkoutHistory(${index})" style="flex: 1;">
                    <i class="fas fa-trash"></i> Supprimer
                </button>
            </div>
        </div>
    `;
    
    document.getElementById('history-detail-title').textContent = 'Détail de la séance';
    document.getElementById('history-detail-content').innerHTML = contentHTML;
    showModal('history-detail-modal');
}

// MODIFICATION: Fonction pour calculer le total des répétitions
function calculateTotalReps(workoutEntry) {
    let totalReps = 0;
    workoutEntry.exercises.forEach(exercise => {
        exercise.sets.forEach(set => {
            totalReps += parseInt(set.reps) || 0;
        });
    });
    return totalReps;
}

function calculateTotalPause(workoutEntry) {
    // Estimation : 90 secondes de pause entre chaque série
    return workoutEntry.stats.totalSets * 90;
}

function redoWorkout(index) {
    const entry = workoutHistory[index];
    if (!entry) return;
    
    const workoutData = {
        name: entry.name,
        exercises: [],
        supersets: entry.supersets || []
    };
    
    // CORRECTION CRITIQUE: Restaurer l'ordre EXACT de la séance originale
    const exercisesByOriginalOrder = [];
    const exercisesBySuperset = {};
    
    // 1. Organiser tous les exercices avec leur position ORIGINALE
    entry.exercises.forEach((exercise, exIndex) => {
        const matchingExercise = getAllExercises().find(ex => 
            ex.name.toLowerCase() === exercise.name.toLowerCase()
        );
        
        if (matchingExercise) {
            const exerciseData = {
                ...exercise,
                matchingExercise: matchingExercise,
                historicalSets: exercise.sets || [],
                originalIndex: exIndex,
                notes: exercise.notes || '',
                customRest: exercise.customRest || userProfile.defaultRest
            };
            
            // Organiser par superset ou standalone
            if (exercise.supersetId) {
                if (!exercisesBySuperset[exercise.supersetId]) {
                    exercisesBySuperset[exercise.supersetId] = [];
                }
                exercisesBySuperset[exercise.supersetId].push(exerciseData);
            } else {
                // Exercice standalone - garder sa position exacte
                exercisesByOriginalOrder[exIndex] = exerciseData;
            }
        }
    });
    
    // 2. Si nous avons des supersets sauvegardés, les utiliser pour reconstruire l'ordre
    if (workoutData.supersets && workoutData.supersets.length > 0) {
        // Trier les supersets par leur PREMIER exercice dans l'ordre original
        const sortedSupersets = workoutData.supersets.sort((a, b) => {
            const firstA = a.exercises && a.exercises.length > 0 ? 
                Math.min(...a.exercises.map(e => e.exerciseIndex)) : Infinity;
            const firstB = b.exercises && b.exercises.length > 0 ? 
                Math.min(...b.exercises.map(e => e.exerciseIndex)) : Infinity;
            return firstA - firstB;
        });
        
        // 3. Reconstruire la séance EXACTEMENT comme elle était
        const reorderedExercises = [];
        
        // Pour chaque position dans la séance originale
        for (let i = 0; i < entry.exercises.length; i++) {
            // Vérifier si cette position est occupée par un exercice standalone
            if (exercisesByOriginalOrder[i]) {
                reorderedExercises.push(exercisesByOriginalOrder[i]);
            } else {
                // Sinon, vérifier si c'est la position d'un superset
                const supersetAtThisPosition = sortedSupersets.find(superset => {
                    return superset.exercises && superset.exercises.some(e => e.exerciseIndex === i);
                });
                
                if (supersetAtThisPosition && exercisesBySuperset[supersetAtThisPosition.id]) {
                    // Ajouter TOUS les exercices de ce superset
                    const supersetExercises = exercisesBySuperset[supersetAtThisPosition.id]
                        .sort((a, b) => (a.supersetOrder || 0) - (b.supersetOrder || 0));
                    
                    supersetExercises.forEach(ex => {
                        reorderedExercises.push(ex);
                    });
                    
                    // Avancer l'index pour sauter les autres exercices de ce superset
                    i += supersetExercises.length - 1;
                }
            }
        }
        
        workoutData.exercises = reorderedExercises;
    } else {
        // Sans supersets, garder simplement l'ordre original
        workoutData.exercises = exercisesByOriginalOrder.filter(ex => ex);
    }
    
    if (workoutData.exercises.length > 0) {
        // Démarrer la séance avec toutes les données historiques
        startRedoWorkout(workoutData);
        hideModal('history-detail-modal');
        showNotification('Séance reprise avec supersets et valeurs historiques');
    } else {
        showNotification('Impossible de retrouver les exercices de cette séance', 'error');
    }
}

// MODIFICATION: Fonction pour redémarrer une séance avec les dernières charges
function startRedoWorkout(workoutData) {
    activeWorkout = {
        name: workoutData.name,
        exercises: [],
        startTime: new Date(),
        completedSets: 0,
        totalWeight: 0,
        // RÉPARATION: Sauvegarder la structure complète des supersets
        supersets: workoutData.supersets || {}
    };
    
    // RÉPARATION: Créer un mapping pour organiser les exercices par superset
    const exercisesBySuperset = {};
    const standaloneExercises = [];
    
    workoutData.exercises.forEach(exercise => {
        // Créer les sets avec les valeurs historiques si disponibles
        const sets = [];
        const numSets = Math.max(userProfile.defaultSets, exercise.historicalSets?.length || 0);
        
        for (let i = 0; i < numSets; i++) {
            const historicalSet = exercise.historicalSets?.[i];
            
            // S'assurer que les valeurs ne soient jamais undefined
            let repsValue = userProfile.defaultReps;
            let weightValue = userProfile.defaultWeight;
            
            if (historicalSet) {
                repsValue = historicalSet.reps !== undefined ? historicalSet.reps : userProfile.defaultReps;
                weightValue = historicalSet.weight !== undefined ? historicalSet.weight : userProfile.defaultWeight;
            }
            
            sets.push({
                number: i + 1,
                reps: repsValue,
                weight: weightValue,
                completed: false,
                isHistorical: !!historicalSet
            });
        }
        
        // CORRECTION: Charger les notes de l'exercice
        const exerciseData = {
            ...exercise.matchingExercise,
    sets: sets,
    customRest: exercise.customRest || userProfile.defaultRest,
    // CORRECTION: Restaurer toutes les infos de superset
    supersetId: exercise.supersetId,
    supersetName: exercise.supersetName,
    supersetColor: exercise.supersetColor,
    supersetOrder: exercise.supersetOrder,
    supersetInfo: exercise.supersetInfo,
// Restaurer le mode compact si sauvegardé
compactModeOverride: exercise.compactModeOverride,
    // CORRECTION: Bien charger les notes sauvegardées
            notes: exercise.notes || '',  // Charger depuis les données de reprise
        // Garder les données historiques pour référence
            historicalSets: exercise.historicalSets || []
        };
        // Organiser les exercices par superset
        if (exercise.supersetId) {
            if (!exercisesBySuperset[exercise.supersetId]) {
                exercisesBySuperset[exercise.supersetId] = [];
            }
            exercisesBySuperset[exercise.supersetId].push(exerciseData);
        } else {
            standaloneExercises.push(exerciseData);
        }
    });
    
    // RÉPARATION: Reconstruire l'ordre correct des exercices
    const allExercises = [...standaloneExercises];
    

    // Ajouter les supersets dans l'ordre original
    if (workoutData.supersets && typeof workoutData.supersets === 'object') {
        Object.values(workoutData.supersets).forEach(superset => {
            if (exercisesBySuperset[superset.id]) {
                // Trier les exercices du superset par ordre
                const supersetExercises = exercisesBySuperset[superset.id];
                supersetExercises.sort((a, b) => {
                    // Utiliser l'ordre sauvegardé ou calculer l'ordre
                    const orderA = a.supersetOrder || 
                        superset.exercises.findIndex(e => e.name === a.name) + 1;
                    const orderB = b.supersetOrder || 
                        superset.exercises.findIndex(e => e.name === b.name) + 1;
                    return orderA - orderB;
                });
                
                // Mettre à jour l'ordre dans chaque exercice
                supersetExercises.forEach((ex, index) => {
                    ex.supersetOrder = index + 1;
                    ex.supersetName = superset.name;
                    ex.supersetColor = superset.color;
                });
                
                allExercises.push(...supersetExercises);
            }
        });
    }
    
    // Assigner les exercises organisés
    activeWorkout.exercises = allExercises;
    
    activeWorkoutStartTime = new Date();
    activeWorkoutTimer = setInterval(updateWorkoutTimer, 1000);
    updateWorkoutDisplay();
    showScreen('active-workout-screen');
}

// Fonction pour réorganiser les supersets dans une séance reprise
function reorganizeSupersetsInRedo() {
    if (!activeWorkout.supersets || Object.keys(activeWorkout.supersets).length === 0) return;
    
    const supersetExercises = [];
    const standaloneExercises = [];
    
    // Séparer les exercices en supersets et standalone
    activeWorkout.exercises.forEach(exercise => {
        if (exercise.supersetId) {
            supersetExercises.push(exercise);
        } else {
            standaloneExercises.push(exercise);
        }
    });
    
    // Regrouper les supersets par ID
    const supersetGroups = {};
    supersetExercises.forEach(exercise => {
        if (!supersetGroups[exercise.supersetId]) {
            supersetGroups[exercise.supersetId] = [];
        }
        supersetGroups[exercise.supersetId].push(exercise);
    });
    
    // Trier les exercices dans chaque superset par ordre
    Object.values(supersetGroups).forEach(group => {
        group.sort((a, b) => (a.supersetOrder || 0) - (b.supersetOrder || 0));
    });
    
    // Recréer la liste des exercices dans l'ordre correct
    const reorganizedExercises = [...standaloneExercises];
    
    // Ajouter les supersets groupés
    Object.values(supersetGroups).forEach(group => {
        reorganizedExercises.push(...group);
    });
    
    activeWorkout.exercises = reorganizedExercises;
}

function deleteWorkoutHistory(index) {
    if (confirm('Êtes-vous sûr de vouloir supprimer cette entrée de l\'historique ?')) {
        workoutHistory.splice(index, 1);
        saveToLocalStorage();
        loadWorkoutHistory();
        hideModal('history-detail-modal');
        showNotification('Entrée supprimée de l\'historique');
    }
}

function loadNutritionHistory() {
    const container = document.getElementById('nutrition-history');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (nutritionHistory.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">🍽️</div>
                <p>Aucun historique nutritionnel</p>
                <p style="font-size: var(--font-size-sm); margin-top: 6px;">Votre historique nutritionnel apparaîtra ici</p>
            </div>
        `;
        return;
    }
    
    // Grouper les repas par date
    const mealsByDate = {};
    
    nutritionHistory.forEach(meal => {
        const date = new Date(meal.date);
        const dateKey = date.toLocaleDateString('fr-FR', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
        });
        
        if (!mealsByDate[dateKey]) {
            mealsByDate[dateKey] = [];
        }
        
        mealsByDate[dateKey].push(meal);
    });
    
    // Afficher par date (les plus récentes en premier)
    Object.entries(mealsByDate).sort(([dateA], [dateB]) => {
        return new Date(dateB.split('/').reverse().join('-')) - new Date(dateA.split('/').reverse().join('-'));
    }).forEach(([date, meals]) => {
        const dateElement = document.createElement('div');
        dateElement.className = 'nutrition-history-box';
        
        // Calculer les totaux pour cette date
        let totalCalories = 0;
        let totalProtein = 0;
        let totalCarbs = 0;
        let totalFat = 0;
        
        meals.forEach(meal => {
            meal.foods.forEach(foodItem => {
                const food = getAllFoods().find(f => f.id === foodItem.foodId);
                if (food) {
                    const ratio = foodItem.quantity / food.quantity;
                    totalCalories += food.calories * ratio;
                    totalProtein += food.protein * ratio;
                    totalCarbs += food.carbs * ratio;
                    totalFat += food.fat * ratio;
                }
            });
        });
        
        const calorieNeeds = userProfile.calorieNeeds || 2500;
        const calorieBalance = totalCalories - calorieNeeds;
        
        dateElement.innerHTML = `
            <div class="nutrition-history-date-header">
                <div style="font-weight: 700; color: var(--text-primary);">📅 ${date}</div>
                <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">${meals.length} repas</div>
            </div>
            
            <div class="nutrition-history-totals-improved">
                <div class="nutrition-history-total-improved">
                    <div class="nutrition-history-total-value-improved">${Math.round(totalCalories)}</div>
                    <div class="nutrition-history-total-label-improved">kcal</div>
                    <div class="history-calories-balance ${calorieBalance <= 0 ? 'positive' : 'negative'}">
                        ${calorieBalance >= 0 ? '+' : ''}${Math.round(calorieBalance)} kcal
                    </div>
                </div>
                <div class="nutrition-history-total-improved">
                    <div class="nutrition-history-total-value-improved protein">${Math.round(totalProtein)}g</div>
                    <div class="nutrition-history-total-label-improved">Protéines</div>
                </div>
                <div class="nutrition-history-total-improved">
                    <div class="nutrition-history-total-value-improved carbs">${Math.round(totalCarbs)}g</div>
                    <div class="nutrition-history-total-label-improved">Glucides</div>
                </div>
            </div>
            
            <div style="margin-top: 15px;">
                ${meals.map(meal => {
                    const mealDate = new Date(meal.date);
                    return `
                    <div class="food-item-improved" style="margin-bottom: 10px; cursor: pointer;" onclick="showMealDetail('${meal.id}')">
                        <div class="food-item-improved-header">
                            <div class="food-item-improved-name">${meal.name}</div>
                            <div class="meal-type-badge">${getMealTypeLabel(meal.type)}</div>
                        </div>
                        <div class="food-item-improved-details">
                            <span>${meal.foods.length} aliments</span>
                            <span>${mealDate.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})}</span>
                        </div>
                        ${meal.notes ? `
                            <div style="font-size: var(--font-size-sm); color: var(--text-secondary); margin-top: 8px; font-style: italic;">
                                "${meal.notes}"
                            </div>
                        ` : ''}
                    </div>
                `}).join('')}
            </div>
        `;
        
        container.appendChild(dateElement);
    });
}

function showMealDetail(mealId) {
    const meal = nutritionHistory.find(m => m.id === mealId);
    if (!meal) return;
    
    const date = new Date(meal.date);
    const formattedDate = date.toLocaleDateString('fr-FR', {
        weekday: 'long',
        day: '2-digit',
        month: 'long',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
    
    // Calculer les totaux du repas
    let mealCalories = 0;
    let mealProtein = 0;
    let mealCarbs = 0;
    let mealFat = 0;
    
    meal.foods.forEach(foodItem => {
        const food = getAllFoods().find(f => f.id === foodItem.foodId);
        if (food) {
            const ratio = foodItem.quantity / food.quantity;
            mealCalories += food.calories * ratio;
            mealProtein += food.protein * ratio;
            mealCarbs += food.carbs * ratio;
            mealFat += food.fat * ratio;
        }
    });
    
    let contentHTML = `
        <div class="history-detail-content">
            <div class="history-detail-header">
                <div>
                    <h4 style="margin: 0 0 5px 0; color: var(--text-primary);">${meal.name}</h4>
                    <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">${formattedDate}</div>
                    <div style="font-size: var(--font-size-sm); color: var(--text-secondary); margin-top: 3px;">
                        ${getMealTypeLabel(meal.type)}
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">Total</div>
                    <div style="font-weight: 700; color: var(--primary); font-size: var(--font-size-lg);">
                        ${Math.round(mealCalories)} kcal
                    </div>
                </div>
            </div>
            
            <div style="margin: 20px 0;">
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px;">
                    <div style="text-align: center; padding: 10px; background: var(--card-bg); border-radius: var(--radius-sm); border: 1px solid var(--border);">
                        <div style="font-size: var(--font-size-lg); font-weight: 900; color: #EF4444;">${Math.round(mealProtein)}g</div>
                        <div style="font-size: var(--font-size-xs); color: var(--text-secondary);">PROTÉINES</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: var(--card-bg); border-radius: var(--radius-sm); border: 1px solid var(--border);">
                        <div style="font-size: var(--font-size-lg); font-weight: 900; color: #10B981;">${Math.round(mealCarbs)}g</div>
                        <div style="font-size: var(--font-size-xs); color: var(--text-secondary);">GLUCIDES</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: var(--card-bg); border-radius: var(--radius-sm); border: 1px solid var(--border);">
                        <div style="font-size: var(--font-size-lg); font-weight: 900; color: #F59E0B;">${Math.round(mealFat)}g</div>
                        <div style="font-size: var(--font-size-xs); color: var(--text-secondary);">LIPIDES</div>
                    </div>
                </div>
                
                <h4 style="margin: 0 0 15px 0; color: var(--text-primary);">Aliments (${meal.foods.length})</h4>
    `;
    
    meal.foods.forEach(foodItem => {
        const food = getAllFoods().find(f => f.id === foodItem.foodId);
        if (food) {
            const ratio = foodItem.quantity / food.quantity;
            const foodCalories = Math.round(food.calories * ratio);
            const foodProtein = Math.round(food.protein * ratio);
            const foodCarbs = Math.round(food.carbs * ratio);
            const foodFat = Math.round(food.fat * ratio);
            
            contentHTML += `
                <div class="history-detail-exercise" style="margin-bottom: 10px;">
                    <div class="history-detail-exercise-name">${food.name}</div>
                    <div style="font-size: var(--font-size-xs); color: var(--text-secondary); margin-bottom: 10px;">
                        ${foodItem.quantity}g • ${food.category}
                        ${food.halal ? ' • 🕌 Halal' : ''}
                        ${food.custom ? ' • 🎨 Personnalisé' : ''}
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 5px; font-size: var(--font-size-xs);">
    <div style="display: flex; justify-content: space-between; gap: 10px; font-size: var(--font-size-xs);">
    <div style="display: flex; justify-content: space-between; gap: 10px; font-size: var(--font-size-xs);">
    <div style="display: flex; flex-direction: column; gap: 5px; flex: 1;">
        <div style="padding: 4px 8px; background: linear-gradient(135deg, #F59E0B, #FBBF24); border-radius: 10px; border: 1px solid rgba(245, 158, 11, 0.3); color: white; font-weight: bold;">
            Calories: ${foodCalories}
        </div>
        <div style="padding: 4px 8px; background: linear-gradient(135deg, #EF4444, #FCA5A5); border-radius: 10px; border: 1px solid rgba(239, 68, 68, 0.3); color: white; font-weight: bold;">
            Protéines: ${foodProtein}g
        </div>
    </div>
    <div style="display: flex; flex-direction: column; gap: 5px; flex: 1;">
        <div style="padding: 4px 8px; background: linear-gradient(135deg, #10B981, #34D399); border-radius: 10px; border: 1px solid rgba(16, 185, 129, 0.3); color: white; font-weight: bold;">
            Glucides: ${foodCarbs}g
        </div>
        <div style="padding: 4px 8px; background: linear-gradient(135deg, #6366F1, #818CF8); border-radius: 10px; border: 1px solid rgba(99, 102, 241, 0.3); color: white; font-weight: bold;">
            Lipides: ${foodFat}g
        </div>
    </div>
</div>
</div>
            `;
        }
    });
    
    if (meal.notes) {
        contentHTML += `
            <div style="margin-top: 20px; padding: 15px; background: var(--card-bg); border-radius: var(--radius-sm); border: 1px solid var(--border);">
                <div style="font-weight: 700; color: var(--text-primary); margin-bottom: 8px;">📝 Notes</div>
                <div style="color: var(--text-secondary); font-size: var(--font-size-sm); white-space: pre-wrap;">${meal.notes}</div>
            </div>
        `;
    }
    
    contentHTML += `
            </div>
            
            <div class="history-detail-actions">
                <button class="btn btn-danger" onclick="deleteMealHistory('${mealId}')" style="flex: 1;">
                    <i class="fas fa-trash"></i> Supprimer
                </button>
            </div>
        </div>
    `;
    
    document.getElementById('meal-detail-title').textContent = 'Détail du repas';
    document.getElementById('meal-detail-content').innerHTML = contentHTML;
    showModal('meal-detail-modal');
}

function deleteMealHistory(mealId) {
    if (confirm('Êtes-vous sûr de vouloir supprimer ce repas de l\'historique ?')) {
        const index = nutritionHistory.findIndex(m => m.id === mealId);
        if (index !== -1) {
            nutritionHistory.splice(index, 1);
            saveToLocalStorage();
            loadNutritionHistory();
            hideModal('meal-detail-modal');
            showNotification('Repas supprimé de l\'historique');
        }
    }
}

function showNutritionHistoryView(period) {
    // MODIFICATION: Filtrer par période
    filterNutritionHistoryByPeriod(period);
    
    document.querySelectorAll('.history-nav-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    const activeBtn = document.querySelector(`.history-nav-btn[onclick*="${period}"]`);
    if (activeBtn) {
        activeBtn.classList.add('active');
    }
}

// MODIFICATION: Filtrer l'historique nutrition par période

function filterNutritionHistoryByPeriod(period) {
    const container = document.getElementById('nutrition-history');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (nutritionHistory.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">🍽️</div>
                <p>Aucun historique nutritionnel</p>
                <p style="font-size: var(--font-size-sm); margin-top: 6px;">Ajoutez des repas pour voir l'historique</p>
            </div>
        `;
        return;
    }
    
    const now = new Date();
    let filteredMeals = [...nutritionHistory];
    
    // Filtrer par période
    if (period === 'day') {
        const today = now.toISOString().split('T')[0];
        filteredMeals = nutritionHistory.filter(meal => {
            const mealDate = new Date(meal.date).toISOString().split('T')[0];
            return mealDate === today;
        });
    } else if (period === 'week') {
        const oneWeekAgo = new Date(now);
        oneWeekAgo.setDate(now.getDate() - 7);
        filteredMeals = nutritionHistory.filter(meal => {
            const mealDate = new Date(meal.date);
            return mealDate >= oneWeekAgo;
        });
    } else if (period === 'month') {
        const oneMonthAgo = new Date(now);
        oneMonthAgo.setMonth(now.getMonth() - 1);
        filteredMeals = nutritionHistory.filter(meal => {
            const mealDate = new Date(meal.date);
            return mealDate >= oneMonthAgo;
        });
    }
    
    // Grouper par date
    const mealsByDate = {};
    
    filteredMeals.forEach(meal => {
        const date = new Date(meal.date);
        const dateKey = date.toLocaleDateString('fr-FR', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
        });
        
        if (!mealsByDate[dateKey]) {
            mealsByDate[dateKey] = [];
        }
        
        mealsByDate[dateKey].push(meal);
    });
    
    // Si pas de repas pour cette période
    if (Object.keys(mealsByDate).length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">📅</div>
                <p>Aucun repas pour cette période</p>
                <p style="font-size: var(--font-size-sm); margin-top: 6px;">Ajoutez des repas pour les voir ici</p>
            </div>
        `;
        return;
    }
    
    // Afficher par date (les plus récentes en premier)
    Object.entries(mealsByDate).sort(([dateA], [dateB]) => {
        return new Date(dateB.split('/').reverse().join('-')) - new Date(dateA.split('/').reverse().join('-'));
    }).forEach(([date, meals]) => {
        const dateElement = document.createElement('div');
        dateElement.className = 'nutrition-history-box';
        
        // Calculer les totaux pour cette date
        let totalCalories = 0;
        let totalProtein = 0;
        let totalCarbs = 0;
        let totalFat = 0;
        
        meals.forEach(meal => {
            meal.foods.forEach(foodItem => {
                const food = getAllFoods().find(f => f.id === foodItem.foodId);
                if (food) {
                    const ratio = foodItem.quantity / food.quantity;
                    totalCalories += food.calories * ratio;
                    totalProtein += food.protein * ratio;
                    totalCarbs += food.carbs * ratio;
                    totalFat += food.fat * ratio;
                }
            });
        });
        
        const calorieNeeds = userProfile.calorieNeeds || 2500;
        const calorieBalance = totalCalories - calorieNeeds;
        
        dateElement.innerHTML = `
            <div class="nutrition-history-date-header">
                <div style="font-weight: 700; color: var(--text-primary);">📅 ${date}</div>
                <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">${meals.length} repas</div>
            </div>
            
            <div class="nutrition-history-totals-improved">
                <div class="nutrition-history-total-improved">
                    <div class="nutrition-history-total-value-improved">${Math.round(totalCalories)}</div>
                    <div class="nutrition-history-total-label-improved">kcal</div>
                    <div class="history-calories-balance ${calorieBalance <= 0 ? 'positive' : 'negative'}">
                        ${calorieBalance >= 0 ? '+' : ''}${Math.round(calorieBalance)} kcal
                    </div>
                </div>
                <div class="nutrition-history-total-improved">
                    <div class="nutrition-history-total-value-improved protein">${Math.round(totalProtein)}g</div>
                    <div class="nutrition-history-total-label-improved">Protéines</div>
                </div>
                <div class="nutrition-history-total-improved">
                    <div class="nutrition-history-total-value-improved carbs">${Math.round(totalCarbs)}g</div>
                    <div class="nutrition-history-total-label-improved">Glucides</div>
                </div>
            </div>
            
            <div style="margin-top: 15px;">
                ${meals.map(meal => {
                    const mealDate = new Date(meal.date);
                    return `
                    <div class="food-item-improved" style="margin-bottom: 10px; cursor: pointer;" onclick="showMealDetail('${meal.id}')">
                        <div class="food-item-improved-header">
                            <div class="food-item-improved-name">${meal.name}</div>
                            <div class="meal-type-badge">${getMealTypeLabel(meal.type)}</div>
                        </div>
                        <div class="food-item-improved-details">
                            <span>${meal.foods.length} aliments</span>
                            <span>${mealDate.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})}</span>
                        </div>
                        ${meal.notes ? `
                            <div style="font-size: var(--font-size-sm); color: var(--text-secondary); margin-top: 8px; font-style: italic;">
                                "${meal.notes}"
                            </div>
                        ` : ''}
                    </div>
                `}).join('')}
            </div>
        `;
        
        container.appendChild(dateElement);
    });
}

function showNutritionHistoryView(period) {
    // Filtrer par période
    filterNutritionHistoryByPeriod(period);
    
    // Mettre à jour les boutons actifs
    document.querySelectorAll('.history-nav-btn').forEach(btn => {
        btn.classList.remove('active');
        const onclickAttr = btn.getAttribute('onclick');
        if (onclickAttr && onclickAttr.includes(`'${period}'`)) {
            btn.classList.add('active');
        }
    });
}

function getMonthNumber(monthName) {
    const months = {
        'janvier': 0, 'février': 1, 'mars': 2, 'avril': 3,
        'mai': 4, 'juin': 5, 'juillet': 6, 'août': 7,
        'septembre': 8, 'octobre': 9, 'novembre': 10, 'décembre': 11
    };
    return months[monthName.toLowerCase()] || 0;
}

function showClearNutritionHistoryModal() {
    showModal('clear-nutrition-history-modal');
}

function clearAllNutritionHistory() {
    if (confirm('Êtes-vous vraiment sûr de vouloir supprimer TOUT l\'historique nutritionnel ? Cette action est irréversible.')) {
        nutritionHistory = [];
        saveToLocalStorage();
        loadNutritionHistory();
        hideModal('clear-nutrition-history-modal');
        showNotification('Historique nutritionnel entièrement supprimé');
    }
}

// ==================== RECHERCHE AVANCÉE ====================
function showAdvancedSearchModal() {
    // Remplir les options des groupes musculaires
    const muscleOptions = document.getElementById('advanced-muscle-options');
    muscleOptions.innerHTML = '<div class="filter-selection-option selected" data-value="all">Tous</div>';
    muscleGroups.forEach(muscle => {
        const option = document.createElement('div');
        option.className = 'filter-selection-option';
        option.dataset.value = muscle.id;
        option.textContent = muscle.name;
        muscleOptions.appendChild(option);
    });
    
    // Remplir les options d'équipement
    const equipmentOptions = document.getElementById('advanced-equipment-options');
    const allEquipment = new Set();
    getAllExercises().forEach(ex => {
        if (ex.equipment) {
            ex.equipment.forEach(eq => allEquipment.add(eq));
        }
    });
    
    equipmentOptions.innerHTML = '<div class="filter-selection-option selected" data-value="all">Tous</div>';
    allEquipment.forEach(equipment => {
        const option = document.createElement('div');
        option.className = 'filter-selection-option';
        option.dataset.value = equipment;
        option.textContent = equipment;
        equipmentOptions.appendChild(option);
    });
    
    // Réinitialiser les sélections
    document.querySelectorAll('#advanced-search-modal .filter-selection-option').forEach(option => {
        option.classList.remove('selected');
    });

// MODIFICATION: S'assurer qu'on peut cliquer sur les options
document.querySelectorAll('#advanced-search-modal .filter-selection-option').forEach(option => {
    option.onclick = function() {
        // Désélectionner tous les autres dans le même groupe
        const parent = this.parentElement;
        parent.querySelectorAll('.filter-selection-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        // Sélectionner celui-ci
        this.classList.add('selected');
    };
});

    document.querySelectorAll('#advanced-search-modal .filter-selection-option[data-value="all"]').forEach(option => {
        option.classList.add('selected');
    });
    
    // Pré-sélectionner les filtres actifs
    Object.entries(advancedExerciseFilters).forEach(([key, value]) => {
        if (key === 'favorites') {
            const option = document.querySelector('#advanced-search-modal .filter-selection-option[data-value="favoris"]');
            if (option) option.classList.add('selected');
        } else if (key === 'muscleGroup' || key === 'category' || key === 'difficulty' || key === 'equipment') {
            const option = document.querySelector(`#advanced-search-modal .filter-selection-option[data-value="${value}"]`);
            if (option) {
                option.classList.add('selected');
                // Désélectionner "Tous" dans ce groupe
                const allOption = option.parentElement.querySelector('.filter-selection-option[data-value="all"]');
                if (allOption) allOption.classList.remove('selected');
            }
        }
    });
    
    showModal('advanced-search-modal');
}

function applyAdvancedFilters() {
    // Collecter les filtres sélectionnés
    const filters = {};
    
    // Groupe musculaire
    const selectedMuscle = document.querySelector('#advanced-muscle-options .filter-selection-option.selected');
    if (selectedMuscle && selectedMuscle.dataset.value !== 'all') {
        filters.muscleGroup = selectedMuscle.dataset.value;
    }
    
    // Catégorie
    const selectedCategory = document.querySelector('#advanced-category-options .filter-selection-option.selected');
    if (selectedCategory && selectedCategory.dataset.value !== 'all') {
        filters.category = selectedCategory.dataset.value;
    }
    
    // Difficulté
    const selectedDifficulty = document.querySelector('#advanced-difficulty-options .filter-selection-option.selected');
    if (selectedDifficulty && selectedDifficulty.dataset.value !== 'all') {
        filters.difficulty = selectedDifficulty.dataset.value;
    }
    
    // Équipement
    const selectedEquipment = document.querySelector('#advanced-equipment-options .filter-selection-option.selected');
    if (selectedEquipment && selectedEquipment.dataset.value !== 'all') {
        filters.equipment = selectedEquipment.dataset.value;
    }
    
    // Filtres spéciaux
    const selectedSpecial = document.querySelector('#advanced-search-modal .filter-selection-option[data-value="personnalisé"].selected');
    if (selectedSpecial) {
        filters.custom = true;
    }
    
    const selectedFavorites = document.querySelector('#advanced-search-modal .filter-selection-option[data-value="favoris"].selected');
    if (selectedFavorites) {
        filters.favorites = true;
    }
    
    advancedExerciseFilters = filters;
    hideModal('advanced-search-modal');
    loadExercises();
    updateAdvancedSearchDisplay();
    showNotification('Filtres appliqués');
}

function applyAdvancedExerciseFilters(exercises) {
    if (Object.keys(advancedExerciseFilters).length === 0) {
        return exercises;
    }
    
    return exercises.filter(exercise => {
        // Filtre par groupe musculaire
        if (advancedExerciseFilters.muscleGroup && exercise.muscleGroup !== advancedExerciseFilters.muscleGroup) {
            return false;
        }
        
        // Filtre par catégorie
        if (advancedExerciseFilters.category && exercise.category !== advancedExerciseFilters.category) {
            return false;
        }
        
        // Filtre par difficulté
        if (advancedExerciseFilters.difficulty && exercise.difficulty !== advancedExerciseFilters.difficulty) {
            return false;
        }
        
        // Filtre par équipement
        if (advancedExerciseFilters.equipment && (!exercise.equipment || !exercise.equipment.includes(advancedExerciseFilters.equipment))) {
            return false;
        }
        
        // Filtre par favoris
        if (advancedExerciseFilters.favorites && !exercise.favorite) {
            return false;
        }
        
        return true;
    });
}

function resetAdvancedFilters() {
    advancedExerciseFilters = {};
    document.querySelectorAll('#advanced-search-modal .filter-selection-option').forEach(option => {
        option.classList.remove('selected');
    });
    document.querySelectorAll('#advanced-search-modal .filter-selection-option[data-value="all"]').forEach(option => {
        option.classList.add('selected');
    });
    
    hideModal('advanced-search-modal');
    loadExercises();
    updateAdvancedSearchDisplay();
    showNotification('Filtres réinitialisés');
}

function updateAdvancedSearchDisplay() {
    const displayContainer = document.getElementById('advanced-search-display-exercises');
    const filtersContainer = document.getElementById('advanced-search-active-filters');
    
    if (Object.keys(advancedExerciseFilters).length === 0) {
        displayContainer.style.display = 'none';
        return;
    }
    
    displayContainer.style.display = 'block';
    filtersContainer.innerHTML = '';
    
    if (advancedExerciseFilters.muscleGroup) {
        const muscle = muscleGroups.find(m => m.id === advancedExerciseFilters.muscleGroup);
        addFilterBadge(filtersContainer, muscle ? muscle.name : advancedExerciseFilters.muscleGroup, 'muscleGroup');
    }
    
    if (advancedExerciseFilters.category) {
        addFilterBadge(filtersContainer, advancedExerciseFilters.category, 'category');
    }
    
    if (advancedExerciseFilters.difficulty) {
        addFilterBadge(filtersContainer, advancedExerciseFilters.difficulty, 'difficulty');
    }
    
    if (advancedExerciseFilters.equipment) {
        addFilterBadge(filtersContainer, advancedExerciseFilters.equipment, 'equipment');
    }
    
    if (advancedExerciseFilters.favorites) {
        addFilterBadge(filtersContainer, 'Favoris uniquement', 'favorites');
    }
}

function addFilterBadge(container, label, type) {
    const badge = document.createElement('div');
    badge.className = 'selected-filter';
    badge.innerHTML = `
        ${label}
        <button class="selected-filter-remove" onclick="removeAdvancedFilter('${type}')">×</button>
    `;
    container.appendChild(badge);
}

function removeAdvancedFilter(type) {
    if (advancedExerciseFilters[type]) {
        delete advancedExerciseFilters[type];
        loadExercises();
        updateAdvancedSearchDisplay();
        showNotification('Filtre supprimé');
    }
}

function clearSearchFilters() {
    advancedExerciseFilters = {};
    loadExercises();
    updateAdvancedSearchDisplay();
    showNotification('Tous les filtres ont été effacés');
}

// RECHERCHE AVANCÉE ALIMENTS
function showAdvancedSearchModalFood() {
    // Remplir les options des catégories
    const categoryOptions = document.getElementById('advanced-food-category-options');
    const categories = [...new Set(getAllFoods().map(f => f.category))];
    
    categoryOptions.innerHTML = '<div class="filter-selection-option selected" data-value="all">Toutes</div>';
    categories.forEach(category => {
        const option = document.createElement('div');
        option.className = 'filter-selection-option';
        option.dataset.value = category;
        option.textContent = category.charAt(0).toUpperCase() + category.slice(1);
        categoryOptions.appendChild(option);
    });
    
    // Réinitialiser les sélections
    document.querySelectorAll('#advanced-search-modal-food .filter-selection-option').forEach(option => {
        option.classList.remove('selected');
    });

    // CORRECTION : Ajouter les gestionnaires d'événements AU BON MODAL
    document.querySelectorAll('#advanced-search-modal-food .filter-selection-option').forEach(option => {
        option.onclick = function() {
            // Désélectionner tous les autres dans le même groupe
            const parent = this.parentElement;
            parent.querySelectorAll('.filter-selection-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            // Sélectionner celui-ci
            this.classList.add('selected');
        };
    });
    
    document.querySelectorAll('#advanced-search-modal-food .filter-selection-option[data-value="all"]').forEach(option => {
        option.classList.add('selected');
    });
    
    // Réinitialiser les champs de saisie
    document.getElementById('advanced-calories-filter').value = '';
    document.getElementById('advanced-protein-filter').value = '';
    document.getElementById('advanced-food-name-filter').value = '';
    
    // Pré-sélectionner les filtres actifs
    Object.entries(advancedFoodFilters).forEach(([key, value]) => {
        if (key === 'custom' || key === 'halal' || key === 'favorite') {
            const option = document.querySelector(`#advanced-search-modal-food .filter-selection-option[data-value="${key === 'favorite' ? 'favoris' : key}"]`);
            if (option) {
                option.classList.add('selected');
                // Désélectionner "Tous" dans ce groupe
                const allOption = option.parentElement.querySelector('.filter-selection-option[data-value="all"]');
                if (allOption) allOption.classList.remove('selected');
            }
        } else if (key === 'category') {
            const option = document.querySelector(`#advanced-food-category-options .filter-selection-option[data-value="${value}"]`);
            if (option) {
                option.classList.add('selected');
                // Désélectionner "Tous" dans ce groupe
                const allOption = option.parentElement.querySelector('.filter-selection-option[data-value="all"]');
                if (allOption) allOption.classList.remove('selected');
            }
        } else if (key === 'maxCalories') {
            document.getElementById('advanced-calories-filter').value = value;
        } else if (key === 'minProtein') {
            document.getElementById('advanced-protein-filter').value = value;
        } else if (key === 'name') {
            document.getElementById('advanced-food-name-filter').value = value;
        }
    });
    
    showModal('advanced-search-modal-food');
}

function applyAdvancedFiltersFood() {
    // Collecter les filtres sélectionnés
    const filters = {};
    
    // Catégorie
    const selectedCategory = document.querySelector('#advanced-food-category-options .filter-selection-option.selected');
    if (selectedCategory && selectedCategory.dataset.value !== 'all') {
        filters.category = selectedCategory.dataset.value;
    }
    
    // Filtres spéciaux - Gestion multiple
    document.querySelectorAll('#advanced-search-modal-food .filter-selection-option.selected').forEach(option => {
        const value = option.dataset.value;
        if (value === 'personnalisé') {
            filters.custom = true;
        } else if (value === 'halal') {
            filters.halal = true;
        } else if (value === 'favoris') {
            filters.favorite = true;
        }
    });
    
    // Calories max
    const caloriesFilter = document.getElementById('advanced-calories-filter').value;
    if (caloriesFilter) {
        filters.maxCalories = parseInt(caloriesFilter);
    }
    
    // Protéines min
    const proteinFilter = document.getElementById('advanced-protein-filter').value;
    if (proteinFilter) {
        filters.minProtein = parseInt(proteinFilter);
    }
    
    // Recherche par nom
    const nameFilter = document.getElementById('advanced-food-name-filter').value;
    if (nameFilter) {
        filters.name = nameFilter;
    }
    
    advancedFoodFilters = filters;
    hideModal('advanced-search-modal-food');
    loadFoods();
    updateAdvancedSearchDisplayFood();
    showNotification('Filtres appliqués');
}

function applyAdvancedFoodFilters(foods) {
    if (Object.keys(advancedFoodFilters).length === 0) {
        return foods;
    }
    
    return foods.filter(food => {
        // Filtre par catégorie
        if (advancedFoodFilters.category && food.category !== advancedFoodFilters.category) {
            return false;
        }
        
        // Filtre par personnalisé
        if (advancedFoodFilters.custom && !food.custom) {
            return false;
        }
        
        // Filtre par halal
        if (advancedFoodFilters.halal && !food.halal) {
            return false;
        }
        
        // Filtre par favoris
        if (advancedFoodFilters.favorite && !food.favorite) {
            return false;
        }
        
        // Filtre par calories max
        if (advancedFoodFilters.maxCalories && food.calories > advancedFoodFilters.maxCalories) {
            return false;
        }
        
        // Filtre par protéines min
        if (advancedFoodFilters.minProtein && food.protein < advancedFoodFilters.minProtein) {
            return false;
        }
        
        // Filtre par nom
        if (advancedFoodFilters.name && !food.name.toLowerCase().includes(advancedFoodFilters.name.toLowerCase())) {
            return false;
        }
        
        return true;
    });
}

function resetAdvancedFiltersFood() {
    advancedFoodFilters = {};
    document.querySelectorAll('#advanced-search-modal-food .filter-selection-option').forEach(option => {
        option.classList.remove('selected');
    });
    document.querySelectorAll('#advanced-search-modal-food .filter-selection-option[data-value="all"]').forEach(option => {
        option.classList.add('selected');
    });
    
    document.getElementById('advanced-calories-filter').value = '';
    document.getElementById('advanced-protein-filter').value = '';
    document.getElementById('advanced-food-name-filter').value = '';
    
    hideModal('advanced-search-modal-food');
    loadFoods();
    updateAdvancedSearchDisplayFood();
    showNotification('Filtres réinitialisés');
}

function updateAdvancedSearchDisplayFood() {
    const displayContainer = document.getElementById('advanced-search-display-foods');
    const filtersContainer = document.getElementById('advanced-search-active-filters-food');
    
    if (Object.keys(advancedFoodFilters).length === 0) {
        displayContainer.style.display = 'none';
        return;
    }
    
    displayContainer.style.display = 'block';
    filtersContainer.innerHTML = '';
    
    if (advancedFoodFilters.category) {
        addFoodFilterBadge(filtersContainer, advancedFoodFilters.category, 'category');
    }
    
    if (advancedFoodFilters.custom) {
        addFoodFilterBadge(filtersContainer, 'Personnalisé', 'custom');
    }
    
    if (advancedFoodFilters.halal) {
        addFoodFilterBadge(filtersContainer, 'Halal', 'halal');
    }
    
    if (advancedFoodFilters.favorite) {
        addFoodFilterBadge(filtersContainer, 'Favoris', 'favorite');
    }
    
    if (advancedFoodFilters.maxCalories) {
        addFoodFilterBadge(filtersContainer, `Max ${advancedFoodFilters.maxCalories} kcal`, 'maxCalories');
    }
    
    if (advancedFoodFilters.minProtein) {
        addFoodFilterBadge(filtersContainer, `Min ${advancedFoodFilters.minProtein}g protéines`, 'minProtein');
    }
    
    if (advancedFoodFilters.name) {
        addFoodFilterBadge(filtersContainer, `Nom: ${advancedFoodFilters.name}`, 'name');
    }
}

function addFoodFilterBadge(container, label, type) {
    const badge = document.createElement('div');
    badge.className = 'selected-filter';
    badge.innerHTML = `
        ${label}
        <button class="selected-filter-remove" onclick="removeAdvancedFilterFood('${type}')">×</button>
    `;
    container.appendChild(badge);
}

function removeAdvancedFilterFood(type) {
    if (advancedFoodFilters[type]) {
        delete advancedFoodFilters[type];
        loadFoods();
        updateAdvancedSearchDisplayFood();
        showNotification('Filtre supprimé');
    }
}

function clearSearchFiltersFood() {
    advancedFoodFilters = {};
    loadFoods();
    updateAdvancedSearchDisplayFood();
    showNotification('Tous les filtres ont été effacés');
}

// ==================== IMPORT/EXPORT ====================
function exportData() {
    const data = {
        userProfile: userProfile,
        customExercises: customExercises,
        customFoods: customFoods,
        customWorkouts: customWorkouts,
        workoutHistory: workoutHistory,
        nutritionHistory: nutritionHistory,
        dailyNutrition: dailyNutrition,
        exportDate: new Date().toISOString(),
        version: '1.0'
    };
    
    const dataStr = JSON.stringify(data, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    
    const exportFileDefaultName = `fitfuel-backup-${new Date().toISOString().slice(0, 10)}.json`;
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
    
    showNotification('Données exportées avec succès !');
}

function importData() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                
                if (!confirm(`Voulez-vous importer ${data.customExercises?.length || 0} exercices, ${data.customFoods?.length || 0} aliments, ${data.customWorkouts?.length || 0} séances, ${data.workoutHistory?.length || 0} séances d'historique et ${data.nutritionHistory?.length || 0} repas d'historique ? Les données existantes seront remplacées.`)) {
                    return;
                }
                
                // Importer les données
                if (data.userProfile) userProfile = data.userProfile;
                if (data.customExercises) customExercises = data.customExercises;
                if (data.customFoods) customFoods = data.customFoods;
                if (data.customWorkouts) customWorkouts = data.customWorkouts;
                if (data.workoutHistory) workoutHistory = data.workoutHistory;
                if (data.nutritionHistory) nutritionHistory = data.nutritionHistory;
                if (data.dailyNutrition) dailyNutrition = data.dailyNutrition;
                
                saveToLocalStorage();
                
                // Recharger l'interface
                initApp();
                showNotification('Données importées avec succès !');
                
            } catch (error) {
                showNotification('Erreur lors de l\'importation du fichier', 'error');
                console.error('Erreur d\'importation:', error);
            }
        };
        reader.readAsText(file);
    };
    
    input.click();
}

// ==================== PROGRAMMES RECOMMANDÉS ====================
function updateRecommendedPrograms() {
    const container = document.getElementById('recommended-programs');
    if (!container) return;
    
    container.innerHTML = '';
    
    const basePrograms = [
        { 
            id: 'fullbody_beginner',
            name: 'Débutant Complet', 
            description: '3 séances/semaine pour commencer', 
            duration: '4 semaines', 
            type: 'fullbody',
            icon: '🚀',
            color: '#6366F1'
        },
        { 
            id: 'push_day',
            name: 'Push Day', 
            description: 'Pectoraux, Épaules, Triceps', 
            duration: '12 semaines', 
            type: 'push',
            icon: '💪',
            color: '#EF4444'
        },
        { 
            id: 'pull_day',
            name: 'Pull Day', 
            description: 'Dos, Biceps, Arrière épaules', 
            duration: '8 semaines', 
            type: 'pull',
            icon: '🎯',
            color: '#10B981'
        },
        { 
            id: 'legs_day',
            name: 'Leg Day', 
            description: 'Jambes complètes', 
            duration: '12 semaines', 
            type: 'legs',
            icon: '🏋️‍♂️',
            color: '#F59E0B'
        }
    ];
    
    basePrograms.forEach(program => {
        const programElement = document.createElement('div');
        programElement.className = 'workout-card';
        programElement.style.cursor = 'pointer';
        programElement.style.background = `linear-gradient(135deg, ${program.color}, ${adjustColor(program.color, -20)})`;
        programElement.onclick = () => startPredefinedWorkoutFromHome(program.id);
        
        programElement.innerHTML = `
            <div class="workout-name">${program.name}</div>
            <div class="workout-description">${program.description}</div>
            <div class="workout-duration">
                <i class="far fa-clock"></i>
                ${program.duration} • Programme structuré
            </div>
            <div style="position: absolute; top: 15px; right: 15px; font-size: 24px;">
                ${program.icon}
            </div>
        `;
        
        container.appendChild(programElement);
    });
}

function startRecommendedProgram(program) {
    showNotification(`Programme "${program.name}" démarré !`, 'success');
    if (program.type === 'fullbody') {
        startWorkout('fullbody_beginner');
    } else {
        const workoutName = `Programme: ${program.name}`;
        const defaultExercises = ['squat', 'bench_press', 'pull_up', 'shoulder_press'];
        startWorkoutWithExercises(workoutName, defaultExercises);
    }
}

function showProgramDetail(program) {
    showNotification(`Programme "${program.name}" - Fonctionnalité en développement`, 'info');
}

// ==================== PARAMÈTRES ====================
function showSettingsModal() {
    // Charger les paramètres actuels
    document.getElementById('sounds-toggle').checked = settings.sounds;
    document.getElementById('vibrations-toggle').checked = settings.vibrations;
    document.getElementById('keep-screen-on-toggle').checked = settings.keepScreenOn;
    document.getElementById('auto-timer-toggle').checked = settings.autoTimer;
    document.getElementById('dark-mode-toggle').checked = settings.darkMode;
    
    showModal('settings-modal');
}

function toggleSounds(checked) {
    settings.sounds = checked;
    saveToLocalStorage();
    showNotification(checked ? 'Sons activés' : 'Sons désactivés');
}

function toggleVibrations(checked) {
    settings.vibrations = checked;
    saveToLocalStorage();
    showNotification(checked ? 'Vibrations activées' : 'Vibrations désactivées');
}

// Puis ajoutez la fonction de test :
function testAudioVibration() {
    if (settings.sounds) {
        playSound('timer_end');
        showNotification('Test audio : vous devriez entendre un bip');
    }
    
    if (settings.vibrations) {
        vibrate([200, 100, 200]);
        showNotification('Test vibration : votre téléphone devrait vibrer');
    }
    
    if (!settings.sounds && !settings.vibrations) {
        showNotification('Activez les sons ou vibrations d\'abord', 'warning');
    }
}

function toggleKeepScreenOn(checked) {
    settings.keepScreenOn = checked;
    saveToLocalStorage();
    
    if (checked && activeWorkout) {
        showNotification('Fonctionnalité expérimentale activée');
    } else if (checked) {
        showNotification('Écran toujours actif activé');
    }
}

function toggleAutoTimer(checked) {
    settings.autoTimer = checked;
    saveToLocalStorage();
    showNotification(checked ? 'Timer automatique activé' : 'Timer automatique désactivé');
}

function toggleCompactMode(checked) {
    settings.compactMode = checked;
    saveToLocalStorage();
    
    // Ne mettre à jour que les exercices qui utilisent le paramètre global
    if (activeWorkout) {
        activeWorkout.exercises.forEach((exercise, index) => {
            if (exercise.compactModeOverride === undefined) {
                // Cet exercice utilise le paramètre global, on peut le mettre à jour
                // L'affichage sera mis à jour lors du prochain updateWorkoutDisplay()
            }
        });
        updateWorkoutDisplay();
    }
    
    showNotification(checked ? 'Mode compact activé' : 'Mode compact désactivé');
}

// ==================== GESTION DES NOTES D'EXERCICE ====================

function showExerciseNotesModal(exerciseIndex) {
    if (!activeWorkout || !activeWorkout.exercises[exerciseIndex]) return;
    
    const exercise = activeWorkout.exercises[exerciseIndex];
    
    // Mettre à jour les informations de l'exercice
    document.getElementById('notes-exercise-name').textContent = exercise.name;
    
    const muscle = muscleGroups.find(m => m.id === exercise.muscleGroup);
    const muscleName = muscle ? muscle.name : exercise.muscleGroup;
    
    document.getElementById('notes-exercise-details').innerHTML = `
        <div>${muscleName} • ${exercise.difficulty}</div>
        ${exercise.supersetId ? `<div style="color: ${exercise.supersetColor || '#8B5CF6'};">Superset "${exercise.supersetName || 'Sans nom'}"</div>` : ''}
    `;
    
    // Charger les notes existantes
    const notesTextarea = document.getElementById('exercise-notes-text');
    notesTextarea.value = exercise.notes || '';
    
    // Mettre à jour le compteur de caractères
    updateNotesCharCount();
    
    // Sauvegarder l'index de l'exercice
    document.getElementById('exercise-notes-modal').dataset.exerciseIndex = exerciseIndex;
    
    showModal('exercise-notes-modal');
}

function autoSaveNotes() {
    const exerciseIndex = parseInt(document.getElementById('exercise-notes-modal').dataset.exerciseIndex);
    if (isNaN(exerciseIndex) || !activeWorkout || !activeWorkout.exercises[exerciseIndex]) return;
    
    const notes = document.getElementById('exercise-notes-text').value;
    activeWorkout.exercises[exerciseIndex].notes = notes;
    
    // Mettre à jour le compteur de caractères
    updateNotesCharCount();
}

function updateNotesCharCount() {
    const textarea = document.getElementById('exercise-notes-text');
    const charCount = textarea.value.length;
    document.getElementById('notes-char-count').textContent = charCount;
    
    // Changer la couleur si on approche de la limite
    if (charCount > 450) {
        document.getElementById('notes-char-count').style.color = '#EF4444';
    } else if (charCount > 400) {
        document.getElementById('notes-char-count').style.color = '#F59E0B';
    } else {
        document.getElementById('notes-char-count').style.color = 'var(--text-secondary)';
    }
}

function saveExerciseNotes() {
    const exerciseIndex = parseInt(document.getElementById('exercise-notes-modal').dataset.exerciseIndex);
    if (isNaN(exerciseIndex) || !activeWorkout || !activeWorkout.exercises[exerciseIndex]) return;
    
    const notes = document.getElementById('exercise-notes-text').value;
    activeWorkout.exercises[exerciseIndex].notes = notes;
    
    hideModal('exercise-notes-modal');
    showNotification('📝 Notes enregistrées pour cet exercice');
}

function clearExerciseNotes() {
    if (confirm('Voulez-vous vraiment effacer toutes les notes de cet exercice ?')) {
        const exerciseIndex = parseInt(document.getElementById('exercise-notes-modal').dataset.exerciseIndex);
        if (!isNaN(exerciseIndex) && activeWorkout && activeWorkout.exercises[exerciseIndex]) {
            activeWorkout.exercises[exerciseIndex].notes = '';
            document.getElementById('exercise-notes-text').value = '';
            updateNotesCharCount();
            showNotification('Notes effacées');
        }
    }
}

// ==================== INITIALISATION ====================
document.addEventListener('DOMContentLoaded', function() {
    initApp();
    
// Gestionnaire pour les boutons Modifier des repas (délégation d'événements)
document.addEventListener('click', function(e) {
    // Vérifier si le clic est sur un bouton Modifier de repas
    const editButton = e.target.closest('.edit-meal-btn');
    if (editButton) {
        const index = parseInt(editButton.getAttribute('data-meal-index'));
        if (!isNaN(index)) {
            console.log('Bouton Modifier cliqué, index:', index);
            editMealFromNutritionScreen(index);
        }
    }
});

    // Ajouter un gestionnaire pour empêcher le rechargement accidentel
    window.addEventListener('beforeunload', function(e) {
        if (activeWorkout) {
            e.preventDefault();
            e.returnValue = 'Vous avez une séance en cours. Voulez-vous vraiment quitter ?';
        }
    });
});

// ==================== FONCTIONS UTILITAIRES ====================
function resetFoodForm() {
    document.getElementById('food-name').value = '';
    document.getElementById('food-quantity').value = '100';
    document.getElementById('food-calories').value = '';
    document.getElementById('food-protein').value = '';
    document.getElementById('food-carbs').value = '';
    document.getElementById('food-fat').value = '';
    document.getElementById('food-category').value = 'viande';
    document.getElementById('food-halal').classList.remove('checked');
    document.getElementById('food-favorite').classList.remove('checked');
}

function resetFoodEditModal() {
    // Cette fonction peut être étendue si nécessaire
}

// ==================== LOADING INDICATOR ====================
function showLoading() {
    document.getElementById('loading-indicator').classList.add('active');
}

function hideLoading() {
    document.getElementById('loading-indicator').classList.remove('active');
}

// Initialisation automatique du thème au chargement
window.onload = function() {
    checkAndApplyTheme();
};

// Gestionnaire global pour les boutons dans les modals de repas
document.addEventListener('click', function(e) {
    const target = e.target;
    
    // Bouton "Rechercher" dans les modals de repas
    if (target.closest('.btn') && target.closest('.btn').textContent.includes('Rechercher')) {
        const modal = target.closest('.modal');
        if (modal && modal.id === 'add-meal-modal') {
            showFoodSearchModalForMeal();
            e.preventDefault();
            e.stopPropagation();
        } else if (modal && modal.id === 'edit-meal-modal') {
            showFoodSearchModalForEdit();
            e.preventDefault();
            e.stopPropagation();
        }
    }
    
    // Bouton "Nouvel aliment" dans les modals de repas
    if (target.closest('.btn') && target.closest('.btn').textContent.includes('Nouvel aliment')) {
        const modal = target.closest('.modal');
        if (modal && modal.id === 'add-meal-modal') {
            showAddFoodFromMeal('add');
            e.preventDefault();
            e.stopPropagation();
        } else if (modal && modal.id === 'edit-meal-modal') {
            showAddFoodFromMeal('edit');
            e.preventDefault();
            e.stopPropagation();
        }
    }
});

// Gestionnaire pour les boutons Modifier des repas
document.addEventListener('click', function(e) {
    const editButton = e.target.closest('.edit-meal-btn');
    if (editButton) {
        const index = parseInt(editButton.getAttribute('data-meal-index'));
        if (!isNaN(index)) {
            editMealFromNutritionScreen(index);
        }
    }
});

// ==================== GESTION DES THÈMES ====================
function showThemeSelection() {
    // NE PAS fermer le modal des paramètres
    // hideModal('settings-modal');
    
    // Mettre à jour la sélection actuelle
    document.querySelectorAll('.theme-option').forEach(option => {
        option.classList.remove('selected');
        if (option.dataset.theme === currentTheme) {
            option.classList.add('selected');
        }
    });
    
    showModal('theme-selection-modal');
}

function selectTheme(themeName) {
    currentTheme = themeName;
    
    // Appliquer le thème immédiatement
    checkAndApplyTheme();
    
    // Sauvegarder
    saveToLocalStorage();
    
    // Mettre à jour la sélection visuelle
    document.querySelectorAll('.theme-option').forEach(option => {
        option.classList.remove('selected');
        if (option.dataset.theme === themeName) {
            option.classList.add('selected');
        }
    });
    
    // Afficher une notification
    const themeNames = {
        'default': 'Par défaut',
        'blue': 'Bleu',
        'green': 'Vert',
        'purple': 'Violet',
        'red': 'Rouge',
        'sunset': 'Soleil'
    };
    
    showNotification(`Thème "${themeNames[themeName]}" appliqué !`);
    
    // Fermer le modal des thèmes et revenir aux paramètres
    setTimeout(() => {
        hideModal('theme-selection-modal');
        // Le modal des paramètres reste ouvert en arrière-plan
    }, 800);
}

// Modifier la fonction toggleDarkModeSetting pour prendre en compte les thèmes
function toggleDarkModeSetting(checked) {
    settings.darkMode = checked;
    checkAndApplyTheme();
    saveToLocalStorage();
    showNotification(settings.darkMode ? 'Mode sombre activé' : 'Mode clair activé');
}

</script>
</body>
</html>