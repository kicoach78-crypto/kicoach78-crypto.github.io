<!DOCTYPE html>
<html lang="fr">

<head>
    <!-- Lien vers le manifest -->
    <link rel="manifest" href="/manifest.json">
  
    <!-- iOS meta tags (très important pour iPhone) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Iron">
  
    <!-- Icône pour iOS -->
    <link rel="apple-touch-icon" href="icon-512.png">
  
    <!-- Couleur de la barre d'adresse -->
    <meta name="theme-color" content="#000000">
  
    <!-- Viewport pour mobile -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IronPlate - Votre Coach Personnel en Fitness et Alimentation</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
/* ==================== VARIABLES ET RESET AVANCÉS ==================== */
:root {
    /* PALETTE PREMIUM - THÈME PROFESSIONNEL FITNESS - AMÉLIORÉ */
    --primary: #2563EB; /* Bleu vif professionnel - plus riche */
    --primary-light: #3B82F6;
    --primary-dark: #1D4ED8;
    --primary-glow: rgba(37, 99, 235, 0.15);
    --secondary: #DC2626; /* Rouge énergie */
    --secondary-light: #EF4444;
    --secondary-dark: #B91C1C;
    --secondary-glow: rgba(220, 38, 38, 0.15);
    --success: #059669; /* Vert succès - plus profond */
    --success-light: #10B981;
    --success-dark: #047857;
    --success-glow: rgba(5, 150, 105, 0.15);
    --danger: #DC2626;
    --danger-light: #EF4444;
    --danger-dark: #B91C1C;
    --warning: #D97706; /* Orange warning */
    --warning-light: #F59E0B;
    --warning-dark: #B45309;
    --info: #0EA5E9; /* Bleu info */
    --info-light: #38BDF8;
    --info-dark: #0284C7;
    
    /* FONDS - CLAIR PROFESSIONNEL AMÉLIORÉ */
    --background: linear-gradient(135deg, #F8FAFC 0%, #F1F5F9 100%);
    --card-bg: #FFFFFF;
    --card-bg-hover: #FFFFFF;
    --text-primary: #1E293B; /* Gris très foncé */
    --text-secondary: #475569; /* Gris foncé */
    --text-tertiary: #64748B; /* Gris moyen */
    --text-disabled: #94A3B8;
    --border: #E2E8F0; /* Bordure très légère */
    --border-light: rgba(226, 232, 240, 0.5);
    --border-hover: rgba(37, 99, 235, 0.3);
    
    /* OMBRES PROFESSIONNELLES AMÉLIORÉES */
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.08), 0 2px 4px -1px rgba(0, 0, 0, 0.04);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.03);
    --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
    --shadow-primary: 0 8px 24px rgba(37, 99, 235, 0.15);
    --shadow-success: 0 8px 24px rgba(5, 150, 105, 0.15);
    --shadow-card: 0 8px 32px rgba(0, 0, 0, 0.08);
    
    /* DÉGRADÉS PROFESSIONNELS AMÉLIORÉS */
    --gradient-primary: linear-gradient(135deg, var(--primary), var(--primary-dark));
    --gradient-secondary: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
    --gradient-success: linear-gradient(135deg, var(--success), var(--success-dark));
    --gradient-success-dark: linear-gradient(135deg, var(--success-dark), var(--success));
    --gradient-premium: linear-gradient(135deg, #2563EB 0%, #7C3AED 100%);
    --gradient-nutrition: linear-gradient(135deg, var(--success-dark), var(--success));
    --gradient-danger: linear-gradient(135deg, var(--danger), var(--danger-dark));
    --gradient-background: linear-gradient(135deg, #F8FAFC 0%, #F1F5F9 100%);
    --gradient-card: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.98));
    
    /* BORDS ARRONDIS MODERNES */
    --radius: 16px;
    --radius-sm: 10px;
    --radius-xs: 8px;
    --radius-lg: 20px;
    --radius-xl: 24px;
    --radius-full: 9999px;
    
    /* TYPOGRAPHIE PROFESSIONNELLE */
    --font-size-xs: 12px;
    --font-size-sm: 14px;
    --font-size-base: 16px;
    --font-size-lg: 18px;
    --font-size-xl: 20px;
    --font-size-2xl: 24px;
    --font-size-3xl: 28px;
    --font-size-4xl: 32px;
    --font-size-5xl: 36px;
    
    /* TRANSITIONS LISSES AMÉLIORÉES */
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    --transition-fast: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
    --transition-slow: all 0.45s cubic-bezier(0.4, 0, 0.2, 1);
    --transition-bounce: all 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    
    /* ESPACEMENT COHÉRENT */
    --space-1: 4px;
    --space-2: 8px;
    --space-3: 12px;
    --space-4: 16px;
    --space-5: 20px;
    --space-6: 24px;
    --space-8: 32px;
    --space-10: 40px;
    --space-12: 48px;
}

/* ==================== THÈMES AMÉLIORÉS ==================== */
.dark-mode {
    /* DARK MODE PROFESSIONNEL AMÉLIORÉ */
    --background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%);
    --card-bg: #1E293B;
    --card-bg-hover: #2D3748;
    --text-primary: #F1F5F9;
    --text-secondary: #E2E8F0;
    --text-tertiary: #94A3B8;
    --text-disabled: #64748B;
    --border: #334155;
    --border-light: rgba(51, 65, 85, 0.5);
    --border-hover: rgba(59, 130, 246, 0.3);
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.1);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.25), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
    --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.35), 0 10px 10px -5px rgba(0, 0, 0, 0.15);
    --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.4);
    --shadow-card: 0 8px 32px rgba(0, 0, 0, 0.25);
    --gradient-background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%);
    --gradient-card: linear-gradient(135deg, rgba(30, 41, 59, 0.95), rgba(30, 41, 59, 0.98));
}

.theme-blue {
    --primary: #2563EB;
    --primary-light: #3B82F6;
    --primary-dark: #1D4ED8;
    --primary-glow: rgba(37, 99, 235, 0.15);
    --background: linear-gradient(135deg, #EFF6FF 0%, #DBEAFE 100%);
    --card-bg: #FFFFFF;
    --text-primary: #1E40AF;
    --text-secondary: #475569;
    --border: #BFDBFE;
    --gradient-premium: linear-gradient(135deg, #2563EB 0%, #1D4ED8 100%);
}

.theme-green {
    --primary: #059669;
    --primary-light: #10B981;
    --primary-dark: #047857;
    --primary-glow: rgba(5, 150, 105, 0.15);
    --background: linear-gradient(135deg, #F0FDF4 0%, #DCFCE7 100%);
    --card-bg: #FFFFFF;
    --text-primary: #065F46;
    --text-secondary: #475569;
    --border: #BBF7D0;
    --gradient-premium: linear-gradient(135deg, #059669 0%, #047857 100%);
}

.theme-purple {
    --primary: #7C3AED;
    --primary-light: #8B5CF6;
    --primary-dark: #6D28D9;
    --primary-glow: rgba(124, 58, 237, 0.15);
    --background: linear-gradient(135deg, #F5F3FF 0%, #EDE9FE 100%);
    --card-bg: #FFFFFF;
    --text-primary: #5B21B6;
    --text-secondary: #475569;
    --border: #DDD6FE;
    --gradient-premium: linear-gradient(135deg, #7C3AED 0%, #6D28D9 100%);
}

.theme-red {
    --primary: #DC2626;
    --primary-light: #EF4444;
    --primary-dark: #B91C1C;
    --primary-glow: rgba(220, 38, 38, 0.15);
    --background: linear-gradient(135deg, #FEF2F2 0%, #FEE2E2 100%);
    --card-bg: #FFFFFF;
    --text-primary: #991B1B;
    --text-secondary: #475569;
    --border: #FECACA;
    --gradient-premium: linear-gradient(135deg, #DC2626 0%, #B91C1C 100%);
}

.theme-sunset {
    --primary: #EA580C;
    --primary-light: #F97316;
    --primary-dark: #C2410C;
    --primary-glow: rgba(234, 88, 12, 0.15);
    --background: linear-gradient(135deg, #FFF7ED 0%, #FFEDD5 100%);
    --card-bg: #FFFFFF;
    --text-primary: #9A3412;
    --text-secondary: #475569;
    --border: #FED7AA;
    --gradient-premium: linear-gradient(135deg, #EA580C 0%, #C2410C 100%);
}

/* Styles pour combiner dark-mode avec d'autres thèmes */
.dark-mode.theme-blue {
    --background: linear-gradient(135deg, #1E3A8A 0%, #1E40AF 100%);
    --card-bg: #1E40AF;
    --card-bg-hover: #2D4FD1;
    --text-primary: #DBEAFE;
    --border: #3B82F6;
    --gradient-card: linear-gradient(135deg, rgba(30, 64, 175, 0.95), rgba(30, 64, 175, 0.98));
}

.dark-mode.theme-green {
    --background: linear-gradient(135deg, #064E3B 0%, #047857 100%);
    --card-bg: #047857;
    --card-bg-hover: #059669;
    --text-primary: #D1FAE5;
    --border: #10B981;
    --gradient-card: linear-gradient(135deg, rgba(4, 120, 87, 0.95), rgba(4, 120, 87, 0.98));
}

.dark-mode.theme-purple {
    --background: linear-gradient(135deg, #5B21B6 0%, #7C3AED 100%);
    --card-bg: #7C3AED;
    --card-bg-hover: #8B5CF6;
    --text-primary: #EDE9FE;
    --border: #8B5CF6;
    --gradient-card: linear-gradient(135deg, rgba(124, 58, 237, 0.95), rgba(124, 58, 237, 0.98));
}

.dark-mode.theme-red {
    --background: linear-gradient(135deg, #7F1D1D 0%, #DC2626 100%);
    --card-bg: #DC2626;
    --card-bg-hover: #EF4444;
    --text-primary: #FEE2E2;
    --border: #EF4444;
    --gradient-card: linear-gradient(135deg, rgba(220, 38, 38, 0.95), rgba(220, 38, 38, 0.98));
}

.dark-mode.theme-sunset {
    --background: linear-gradient(135deg, #7C2D12 0%, #EA580C 100%);
    --card-bg: #EA580C;
    --card-bg-hover: #F97316;
    --text-primary: #FFEDD5;
    --border: #F97316;
    --gradient-card: linear-gradient(135deg, rgba(234, 88, 12, 0.95), rgba(234, 88, 12, 0.98));
}

/* ==================== ANIMATIONS AVANCÉES AMÉLIORÉES ==================== */
@keyframes float {
    0%, 100% { 
        transform: translateY(0); 
    }
    50% { 
        transform: translateY(-6px); 
    }
}

@keyframes subtle-pulse {
    0%, 100% { 
        opacity: 1;
        transform: scale(1);
    }
    50% { 
        opacity: 0.8;
        transform: scale(0.98);
    }
}

@keyframes glow {
    0%, 100% { 
        box-shadow: 0 0 20px var(--primary-glow); 
    }
    50% { 
        box-shadow: 0 0 30px var(--primary-glow); 
    }
}

@keyframes slideInFromTop {
    from { 
        transform: translateY(-20px); 
        opacity: 0; 
    }
    to { 
        transform: translateY(0); 
        opacity: 1; 
    }
}

@keyframes slideInFromBottom {
    from { 
        transform: translateY(20px); 
        opacity: 0; 
    }
    to { 
        transform: translateY(0); 
        opacity: 1; 
    }
}

@keyframes fadeIn {
    from { 
        opacity: 0; 
        transform: translateY(10px); 
    }
    to { 
        opacity: 1; 
        transform: translateY(0); 
    }
}

@keyframes fadeOut {
    from { 
        opacity: 1; 
    }
    to { 
        opacity: 0; 
    }
}

@keyframes shake {
    0%, 100% { 
        transform: translateX(0); 
    }
    10%, 30%, 50%, 70%, 90% { 
        transform: translateX(-5px); 
    }
    20%, 40%, 60%, 80% { 
        transform: translateX(5px); 
    }
}

@keyframes ripple {
    0% { 
        transform: scale(0); 
        opacity: 1; 
    }
    100% { 
        transform: scale(4); 
        opacity: 0; 
    }
}

@keyframes spin {
    from { 
        transform: rotate(0deg); 
    }
    to { 
        transform: rotate(360deg); 
    }
}

@keyframes shimmer {
    0% { 
        background-position: -200% center; 
    }
    100% { 
        background-position: 200% center; 
    }
}

@keyframes gradient-shift {
    0% { 
        background-position: 0% 50%; 
    }
    50% { 
        background-position: 100% 50%; 
    }
    100% { 
        background-position: 0% 50%; 
    }
}

/* ==================== RESET AMÉLIORÉ ==================== */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
    -webkit-tap-highlight-color: transparent;
    font-size: var(--font-size-base);
}

body, html {
    background: var(--background);
    color: var(--text-primary);
    line-height: 1.5;
    overflow-x: hidden;
    min-height: 100vh;
    transition: var(--transition);
    font-weight: 400;
    position: relative;
    scroll-behavior: smooth;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

/* Amélioration des états focus pour accessibilité */
*:focus-visible {
    outline: 2px solid var(--primary);
    outline-offset: 2px;
    border-radius: var(--radius-xs);
}

/* ==================== SCROLLBAR STYLISÉE ==================== */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: var(--border);
    border-radius: var(--radius-full);
}

::-webkit-scrollbar-thumb {
    background: var(--primary);
    border-radius: var(--radius-full);
    transition: var(--transition);
}

::-webkit-scrollbar-thumb:hover {
    background: var(--primary-dark);
}

/* ==================== CONTAINER PRINCIPAL AMÉLIORÉ ==================== */
.app-container {
    max-width: 100%;
    margin: 0 auto;
    min-height: 100vh;
    background: var(--background);
    position: relative;
    overflow-x: hidden;
    padding-bottom: 100px;
    isolation: isolate;
    z-index: 1;
}

/* Effet de fond subtil */
.app-container::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image: 
        radial-gradient(circle at 15% 50%, rgba(37, 99, 235, 0.03) 0%, transparent 50%),
        radial-gradient(circle at 85% 30%, rgba(5, 150, 105, 0.03) 0%, transparent 50%);
    pointer-events: none;
    z-index: -1;
}

.dark-mode .app-container::before {
    background-image: 
        radial-gradient(circle at 15% 50%, rgba(37, 99, 235, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 85% 30%, rgba(5, 150, 105, 0.05) 0%, transparent 50%);
}

/* ==================== HEADER PREMIUM AMÉLIORÉ ==================== */
.header {
    background: var(--card-bg);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: var(--shadow);
    animation: slideInFromTop 0.4s ease;
    width: 100%;
    max-width: 100%;
    margin: 0 auto;
    transition: var(--transition);
}

.dark-mode .header {
    background: rgba(30, 41, 59, 0.9);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
}

.header-left {
    display: flex;
    align-items: center;
    gap: 12px;
}

.user-avatar {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: var(--gradient-primary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: var(--font-size-base);
    cursor: pointer;
    transition: var(--transition);
    position: relative;
    overflow: hidden;
    box-shadow: var(--shadow-primary);
}

.user-avatar:hover {
    transform: translateY(-2px) scale(1.05);
    box-shadow: 0 8px 25px var(--primary-glow);
}

.user-avatar::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), transparent);
    opacity: 0;
    transition: var(--transition);
}

.user-avatar:hover::after {
    opacity: 1;
}

.app-title {
    font-size: var(--font-size-lg);
    font-weight: 700;
    color: var(--text-primary);
    letter-spacing: -0.3px;
    position: relative;
}

.app-title::after {
    content: '';
    position: absolute;
    bottom: -4px;
    left: 0;
    width: 24px;
    height: 3px;
    background: var(--gradient-primary);
    border-radius: 2px;
}

.header-actions {
    display: flex;
    gap: 8px;
    align-items: center;
}

.icon-btn {
    width: 44px;
    height: 44px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--card-bg);
    border: 1px solid var(--border);
    color: var(--text-secondary);
    font-size: var(--font-size-base);
    cursor: pointer;
    transition: var(--transition);
    position: relative;
    overflow: hidden;
    box-shadow: var(--shadow);
}

.icon-btn:hover {
    background: var(--primary);
    color: white;
    transform: translateY(-2px);
    border-color: var(--primary);
    box-shadow: var(--shadow-primary);
}

.icon-btn.primary {
    background: var(--gradient-primary);
    color: white;
    border: none;
}

.icon-btn.primary:hover {
    transform: translateY(-2px) scale(1.05);
    animation: subtle-pulse 2s infinite;
}

.icon-btn.success {
    background: var(--gradient-success);
    color: white;
    border: none;
}

.icon-btn.danger {
    background: var(--gradient-danger);
    color: white;
    border: none;
}

/* ==================== CONTENU PRINCIPAL ==================== */
.main-content {
    padding: 100px 0 80px;
    min-height: 100vh;
    position: relative;
    z-index: 1;
    animation: fadeIn 0.6s ease;
}

.screen {
    display: none;
    animation: fadeIn 0.4s ease;
}

.screen.active {
    display: block;
}

/* ==================== SECTION TITRES AMÉLIORÉS ==================== */
.section-title {
    font-size: var(--font-size-2xl);
    font-weight: 700;
    margin: 0 20px 20px;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 12px;
    position: relative;
    padding-bottom: 12px;
}

.section-title::after {
    content: '';
    flex: 1;
    height: 3px;
    background: var(--gradient-primary);
    border-radius: 2px;
    margin-left: 12px;
}

.section-title::before {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 1px;
    background: var(--border);
}

.section-subtitle {
    font-size: var(--font-size-lg);
    font-weight: 600;
    margin: 0 20px 16px;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 8px;
}

/* ==================== CARTES PREMIUM AMÉLIORÉES ==================== */
.card {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 20px;
    margin: 0 20px 16px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
    transition: var(--transition);
    position: relative;
    overflow: hidden;
    animation: fadeIn 0.4s ease;
}

.card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-xl);
    border-color: var(--border-hover);
}

.card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--gradient-primary);
    transform: scaleX(0);
    transform-origin: left;
    transition: transform 0.3s ease;
}

.card:hover::before {
    transform: scaleX(1);
}

.card-no-hover {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 20px;
    margin: 0 20px 16px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
}

/* ==================== PROFIL UTILISATEUR AMÉLIORÉ ==================== */
.profile-section {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 20px;
    margin: 0 20px 16px;
    border: 1px solid var(--border);
    box-shadow: var(--shadow);
    position: relative;
    overflow: hidden;
    animation: fadeIn 0.5s ease;
}

.profile-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--gradient-primary);
}

.profile-header {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 20px;
    position: relative;
    z-index: 1;
}

.profile-avatar {
    width: 72px;
    height: 72px;
    border-radius: 50%;
    background: var(--gradient-primary);
    color: white;
    display: none;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: var(--font-size-2xl);
    box-shadow: var(--shadow-primary);
    position: relative;
    overflow: hidden;
    transition: var(--transition);
}

.profile-avatar:hover {
    transform: rotate(5deg) scale(1.05);
}

.profile-info h2 {
    font-size: var(--font-size-xl);
    margin-bottom: 4px;
    font-weight: 700;
    color: var(--text-primary);
}

.profile-info p {
    color: var(--text-secondary);
    font-size: var(--font-size-sm);
    font-weight: 500;
}

.profile-stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-top: 20px;
    position: relative;
    z-index: 1;
}

.stat-item {
    text-align: center;
    padding: 16px;
    background: var(--card-bg);
    border-radius: var(--radius);
    border: 1px solid var(--border);
    transition: var(--transition);
    position: relative;
    overflow: hidden;
}

.stat-item:hover {
    transform: translateY(-2px);
    border-color: var(--primary);
    box-shadow: var(--shadow-primary);
}

.stat-value {
    font-size: var(--font-size-xl);
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 4px;
    position: relative;
    z-index: 1;
}

.stat-label {
    font-size: var(--font-size-xs);
    color: var(--text-secondary);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    position: relative;
    z-index: 1;
}

/* ==================== NUTRITION AMÉLIORÉE ==================== */
.nutrition-calories-card {
    background: var(--gradient-success);
    color: white;
    padding: 20px;
    border-radius: var(--radius);
    text-align: center;
    margin: 0 20px 16px;
    box-shadow: var(--shadow-success);
    position: relative;
    overflow: hidden;
    animation: subtle-pulse 3s infinite;
}

.nutrition-calories-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), transparent);
}

.nutrition-calories-value {
    font-size: var(--font-size-3xl);
    font-weight: 800;
    margin-bottom: 4px;
    position: relative;
    z-index: 1;
}

.nutrition-calories-label {
    font-size: var(--font-size-sm);
    opacity: 0.9;
    font-weight: 500;
    position: relative;
    z-index: 1;
}

.macros-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 12px;
    margin-top: 16px;
}

.macro-item {
    background: var(--card-bg);
    padding: 16px 12px;
    border-radius: var(--radius);
    border: 1px solid var(--border);
    text-align: center;
    transition: var(--transition);
    position: relative;
    overflow: hidden;
}

.macro-item:hover {
    transform: translateY(-2px);
    border-color: var(--primary);
    box-shadow: var(--shadow);
}

.macro-value {
    font-size: var(--font-size-lg);
    font-weight: 700;
    margin-bottom: 4px;
    position: relative;
    z-index: 1;
}

.macro-label {
    font-size: var(--font-size-xs);
    color: var(--text-secondary);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    position: relative;
    z-index: 1;
}

.protein {
    color: var(--danger);
}

.carbs {
    color: var(--success);
}

.fat {
    color: var(--warning);
}

/* ==================== WORKOUT CARDS AMÉLIORÉES ==================== */
.workout-card {
    background: var(--card-bg);
    color: var(--text-primary);
    border-radius: var(--radius);
    padding: 20px;
    margin: 0 20px 16px;
    box-shadow: var(--shadow);
    cursor: pointer;
    transition: var(--transition);
    position: relative;
    overflow: hidden;
    border: 1px solid var(--border);
}

.workout-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-xl);
    border-color: var(--primary);
}

.workout-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--gradient-primary);
    transform: scaleX(0);
    transform-origin: left;
    transition: transform 0.3s ease;
}

.workout-card:hover::before {
    transform: scaleX(1);
}

.workout-name {
    font-size: var(--font-size-lg);
    font-weight: 700;
    margin-bottom: 8px;
    position: relative;
    z-index: 1;
}

.workout-description {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    margin-bottom: 12px;
    position: relative;
    z-index: 1;
}

.workout-duration {
    font-size: var(--font-size-sm);
    font-weight: 600;
    color: var(--text-tertiary);
    position: relative;
    z-index: 1;
    display: flex;
    align-items: center;
    gap: 6px;
}

/* WORKOUT CARD LUXURY AMÉLIORÉE */
.workout-card-luxury {
    background: var(--gradient-primary);
    border-radius: var(--radius);
    padding: 24px;
    margin: 0 20px 20px;
    color: white;
    position: relative;
    overflow: hidden;
    box-shadow: var(--shadow-lg);
    transition: var(--transition);
    cursor: pointer;
}

.workout-card-luxury:hover {
    transform: translateY(-6px);
    box-shadow: var(--shadow-2xl);
    animation: float 3s ease-in-out infinite;
}

.workout-card-luxury::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), transparent);
    opacity: 0;
    transition: var(--transition);
}

.workout-card-luxury:hover::after {
    opacity: 1;
}

.workout-card-luxury .workout-icon {
    font-size: 28px;
    margin-bottom: 12px;
    display: block;
}

.workout-badge {
    position: absolute;
    top: 12px;
    right: 12px;
    background: rgba(255, 255, 255, 0.2);
    padding: 4px 10px;
    border-radius: 20px;
    font-size: var(--font-size-xs);
    font-weight: 600;
    backdrop-filter: blur(10px);
}

/* ==================== MUSCLE GRID AMÉLIORÉ ==================== */
.muscle-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin: 0 20px 16px;
}

.muscle-card {
    border-radius: var(--radius);
    padding: 20px;
    height: 120px;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    position: relative;
    overflow: hidden;
    cursor: pointer;
    transition: var(--transition);
    box-shadow: var(--shadow);
}

.muscle-card:hover {
    transform: translateY(-4px) scale(1.02);
    box-shadow: var(--shadow-lg);
}

.muscle-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(to top, rgba(0, 0, 0, 0.3), transparent);
    opacity: 0.6;
}

.muscle-name {
    font-size: var(--font-size-base);
    font-weight: 700;
    color: white;
    margin-bottom: 4px;
    position: relative;
    z-index: 2;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.exercise-count {
    font-size: var(--font-size-sm);
    color: white;
    opacity: 0.9;
    position: relative;
    z-index: 2;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
}

/* ==================== EXERCICE ITEM AMÉLIORÉ ==================== */
.exercise-item {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 16px;
    margin: 0 20px 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid var(--border);
    transition: var(--transition);
    box-shadow: var(--shadow);
    position: relative;
    overflow: hidden;
}

.exercise-item:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-lg);
    border-color: var(--primary);
}

.exercise-content {
    flex: 1;
    cursor: pointer;
    padding: 4px 0;
}

.exercise-name {
    font-size: var(--font-size-base);
    font-weight: 600;
    margin-bottom: 4px;
    position: relative;
    z-index: 1;
    color: var(--text-primary);
}

.exercise-muscle {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    font-weight: 500;
    position: relative;
    z-index: 1;
}

.exercise-equipment {
    font-size: var(--font-size-xs);
    color: var(--text-tertiary);
    font-weight: 500;
    background: var(--border);
    padding: 4px 8px;
    border-radius: 12px;
    border: 1px solid var(--border);
    position: relative;
    z-index: 1;
}

.exercise-actions {
    display: flex;
    gap: 8px;
    align-items: center;
    z-index: 10;
    position: relative;
}

/* ==================== ÉCRAN ENTRAÎNEMENT ACTIF AMÉLIORÉ ==================== */
.workout-container {
    padding-bottom: 30px;
}

.workout-header {
    padding: 20px;
    text-align: center;
}

.workout-header h2 {
    font-size: var(--font-size-2xl);
    font-weight: 800;
    color: var(--text-primary);
    margin-bottom: 16px;
}

.workout-timer-container {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 16px;
    margin: 16px;
    flex-wrap: wrap;
}

.workout-stat-side {
    background: var(--card-bg);
    color: var(--text-primary);
    padding: 14px 16px;
    border-radius: var(--radius);
    text-align: center;
    min-width: 100px;
    flex: 1;
    box-shadow: var(--shadow);
    transition: var(--transition);
    border: 1px solid var(--border);
}

.workout-stat-side:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
    border-color: var(--primary);
}

.workout-stat-side-value {
    font-size: var(--font-size-xl);
    font-weight: 800;
    margin-bottom: 4px;
    color: var(--primary);
}

.workout-stat-side-label {
    font-size: var(--font-size-xs);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    color: var(--text-secondary);
}

.workout-timer {
    text-align: center;
    background: var(--gradient-primary);
    color: white;
    padding: 16px 24px;
    border-radius: var(--radius);
    font-size: var(--font-size-lg);
    font-weight: 700;
    font-feature-settings: "tnum";
    font-variant-numeric: tabular-nums;
    box-shadow: var(--shadow-lg);
    min-width: 120px;
    animation: subtle-pulse 2s infinite;
}

.workout-exercise {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 20px;
    margin: 0 16px 16px;
    border: 1px solid var(--border);
    box-shadow: var(--shadow);
    position: relative;
    overflow: hidden;
    animation: fadeIn 0.4s ease;
}

.workout-exercise::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--gradient-primary);
}

.exercise-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 16px;
}

.exercise-title {
    font-size: var(--font-size-base);
    font-weight: 700;
    flex: 1;
    color: var(--text-primary);
}

/* ==================== SÉRIES D'EXERCICE AMÉLIORÉES ==================== */
.sets-container {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.set-item {
    background: var(--card-bg);
    padding: 16px;
    border-radius: var(--radius);
    margin-bottom: 0;
    border: 1px solid var(--border);
    transition: var(--transition);
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.set-item.completed {
    background: rgba(5, 150, 105, 0.08);
    border-color: var(--success);
}

.set-item.completed::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--gradient-success);
}

.set-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--border-light);
}

.set-item.completed .set-header {
    border-bottom: 1px solid var(--success-light);
}

.set-number {
    font-weight: 800;
    color: var(--text-primary);
    font-size: var(--font-size-lg);
    min-width: 60px;
    text-align: center;
}

.set-item.completed .set-number {
    color: var(--success-dark);
}

.set-controls {
    display: flex;
    gap: 8px;
    align-items: center;
}

/* ==================== ORGANISATION DES CHAMPS DE SAISIE ==================== */
.set-inputs-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 12px;
}

.input-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.input-label {
    font-size: var(--font-size-xs);
    color: var(--text-secondary);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.set-item.completed .input-label {
    color: var(--success-dark);
}

.number-input {
    background: var(--card-bg);
    color: var(--text-primary);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 12px;
    font-size: var(--font-size-base);
    text-align: center;
    width: 100%;
    font-weight: 600;
    transition: var(--transition);
    box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
}

.number-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px var(--primary-glow);
}

.set-item.completed .number-input {
    background: rgba(5, 150, 105, 0.05);
    color: var(--success-dark);
    border: 1px solid var(--success);
}

/* ==================== BOUTONS DE CONTRÔLE AMÉLIORÉS ==================== */
.set-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid var(--border-light);
}

.set-item.completed .set-actions {
    border-top: 1px solid var(--success-light);
}

.set-status {
    display: flex;
    align-items: center;
    gap: 12px;
}

.set-complete-btn {
    background: var(--gradient-success);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: var(--radius-sm);
    font-weight: 600;
    font-size: var(--font-size-sm);
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 8px;
    position: relative;
    overflow: hidden;
}

.set-complete-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-success);
}

.set-complete-btn::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), transparent);
    opacity: 0;
    transition: var(--transition);
}

.set-complete-btn:hover::after {
    opacity: 1;
}

.set-complete-btn.completed {
    background: var(--success-dark);
    opacity: 0.9;
}

.checkbox {
    width: 20px;
    height: 20px;
    border: 2px solid var(--border);
    border-radius: 5px;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: var(--transition);
    cursor: pointer;
    background: var(--card-bg);
    position: relative;
    overflow: hidden;
}

.checkbox.checked {
    border-color: var(--success);
    background: var(--success);
}

.checkmark {
    color: white;
    font-size: var(--font-size-xs);
    font-weight: bold;
    opacity: 0;
    transition: var(--transition);
    z-index: 1;
}

.checkbox.checked .checkmark {
    opacity: 1;
}

/* ==================== BOUTONS PRINCIPAUX AMÉLIORÉS ==================== */
.btn {
    background: var(--gradient-primary);
    color: white;
    border: none;
    padding: 14px 24px;
    border-radius: var(--radius);
    font-size: var(--font-size-base);
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    width: 100%;
    box-shadow: var(--shadow);
    position: relative;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.btn:hover {
    box-shadow: var(--shadow-xl);
    transform: translateY(-3px);
}

.btn:active {
    transform: scale(0.98);
}

.btn::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), transparent);
    opacity: 0;
    transition: var(--transition);
}

.btn:hover::after {
    opacity: 1;
}

.btn-danger {
    background: var(--gradient-danger);
}

.btn-success {
    background: var(--gradient-success);
}

.btn-warning {
    background: linear-gradient(135deg, #D97706, #F59E0B);
}

.btn-info {
    background: linear-gradient(135deg, #0EA5E9, #3B82F6);
}

.btn-secondary {
    background: var(--card-bg);
    color: var(--text-primary);
    border: 1px solid var(--border);
}

.btn-secondary:hover {
    border-color: var(--primary);
}

.action-btn {
    background: var(--card-bg);
    border: 1px solid var(--border);
    color: var(--text-secondary);
    padding: 8px 16px;
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    z-index: 10;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}

.action-btn:hover {
    background: var(--primary);
    color: white;
    transform: translateY(-2px);
    box-shadow: var(--shadow);
    border-color: var(--primary);
}

/* ==================== BOUTON AJOUTER EXERCICE AMÉLIORÉ ==================== */
.add-exercise-btn {
    display: block;
    margin: 0 auto 16px;
    background: var(--gradient-primary);
    color: white;
    border: none;
    padding: 14px 24px;
    border-radius: var(--radius);
    font-size: var(--font-size-base);
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    width: calc(100% - 40px);
    max-width: 280px;
    box-shadow: var(--shadow);
    text-align: center;
    position: relative;
    overflow: hidden;
}

.add-exercise-btn:hover {
    box-shadow: var(--shadow-xl);
    transform: translateY(-3px);
}

.add-exercise-btn::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), transparent);
    opacity: 0;
    transition: var(--transition);
}

.add-exercise-btn:hover::after {
    opacity: 1;
}

/* ==================== TIMER AMÉLIORÉ ==================== */
.timer-container {
    position: fixed;
    bottom: 120px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--card-bg);
    padding: 20px;
    border-radius: var(--radius);
    border: 1px solid var(--border);
    z-index: 1001;
    box-shadow: var(--shadow-xl);
    display: none;
    width: 90%;
    max-width: 340px;
    backdrop-filter: blur(10px);
}

.timer-container.active {
    display: block;
    animation: slideInFromBottom 0.3s ease;
}

.timer-display {
    text-align: center;
    font-size: var(--font-size-3xl);
    font-weight: 800;
    margin-bottom: 16px;
    color: var(--primary);
    font-feature-settings: "tnum";
    font-variant-numeric: tabular-nums;
    animation: subtle-pulse 2s infinite;
}

/* ==================== BARRE DE PROGRESSION AMÉLIORÉE ==================== */
.timer-progress-container {
    height: 6px;
    background: var(--border);
    border-radius: 3px;
    overflow: hidden;
    margin-bottom: 16px;
    position: relative;
}

.timer-progress-bar {
    height: 100%;
    background: var(--gradient-primary);
    border-radius: 3px;
    transition: width 1s linear;
    width: 0%;
    position: relative;
    overflow: hidden;
}

.timer-progress-bar::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
    animation: shimmer 2s infinite;
}

.timer-controls {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr 1fr;
    gap: 8px;
}

.timer-btn {
    padding: 10px 8px;
    border: none;
    border-radius: var(--radius-sm);
    font-weight: 600;
    font-size: var(--font-size-sm);
    cursor: pointer;
    transition: var(--transition);
    position: relative;
    overflow: hidden;
}

.timer-btn:active {
    transform: scale(0.95);
}

.timer-btn::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), transparent);
    opacity: 0;
    transition: var(--transition);
}

.timer-btn:hover::after {
    opacity: 1;
}

.timer-start {
    background: var(--gradient-primary);
    color: white;
}

.timer-adjust {
    background: var(--card-bg);
    color: var(--text-primary);
    border: 1px solid var(--border);
}

.timer-close {
    background: var(--danger);
    color: white;
}

/* ==================== MODALS AMÉLIORÉES ==================== */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 2000;
    align-items: center;
    justify-content: center;
    padding: 14px;
    backdrop-filter: blur(5px);
}

.modal.active {
    display: flex !important;
    animation: fadeIn 0.3s ease;
}

#exercise-notes-modal.active {
    display: flex !important;
    visibility: visible !important;
    opacity: 1 !important;
    z-index: 999999 !important;
}

.modal-content {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 24px;
    width: 100%;
    max-width: 360px;
    max-height: 85vh;
    overflow: hidden;
    box-shadow: var(--shadow-2xl);
    animation: modalSlideUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    border: 1px solid var(--border);
    display: flex;
    flex-direction: column;
}

@keyframes modalSlideUp {
    from { 
        transform: translateY(20px) scale(0.95); 
        opacity: 0; 
    }
    to { 
        transform: translateY(0) scale(1); 
        opacity: 1; 
    }
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--border);
}

.modal-title {
    font-size: var(--font-size-lg);
    font-weight: 700;
    color: var(--text-primary);
}

.modal-close {
    background: none;
    border: none;
    font-size: var(--font-size-xl);
    cursor: pointer;
    color: var(--text-secondary);
    padding: 4px;
    border-radius: 6px;
    transition: var(--transition);
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-close:hover {
    background: var(--border);
    color: var(--text-primary);
}

.modal-body {
    flex: 1;
    overflow-y: auto;
    padding-right: 8px;
    margin-right: -8px;
}

/* ==================== BARRE DE RECHERCHE AMÉLIORÉE - DESIGN ÉPURÉ ==================== */
.search-container {
    background: transparent !important;
    padding: 16px 20px 8px 20px !important;
    margin: 0 !important;
    border: none !important;
}

.search-input {
    background: transparent !important;
    border: none !important;
    border-bottom: 1px solid var(--border) !important;
    border-radius: 0 !important;
    padding: 12px 0 !important;
    font-size: var(--font-size-base);
    width: 100%;
    color: var(--text-primary);
    font-weight: 500;
    transition: var(--transition);
    box-shadow: none !important;
}

.search-input:focus {
    outline: none;
    border-bottom-color: var(--primary) !important;
    box-shadow: 0 1px 0 0 var(--primary) !important;
    background: transparent !important;
}

.search-input::placeholder {
    color: var(--text-tertiary);
    font-weight: 500;
}

/* Pour le mode sombre */
.dark-mode .search-input {
    border-bottom-color: rgba(255, 255, 255, 0.2) !important;
}

.dark-mode .search-input:focus {
    border-bottom-color: var(--primary) !important;
    box-shadow: 0 1px 0 0 var(--primary) !important;
}

/* S'assurer que ça s'applique aux deux onglets (exercices et aliments) */
#exercise-tab .search-container,
#food-tab .search-container {
    background: transparent !important;
    border-bottom: none !important;
}

#exercise-tab .search-input,
#food-tab .search-input {
    background: transparent !important;
}

/* ==================== FILTRES DÉROULANTS AMÉLIORÉS ==================== */
.filter-select {
    width: calc(100% - 40px);
    margin: 0 20px 16px;
    padding: 12px 16px;
    padding-right: 40px; /* Ajoutez ce padding pour l'icône */
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--card-bg) url("data:image/svg+xml;charset=UTF8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e") no-repeat right 14px center/16px;
    background-color: var(--card-bg); /* Important: spécifier explicitement */
    color: var(--text-primary);
    font-size: var(--font-size-base);
    font-weight: 500;
    box-shadow: var(--shadow);
    transition: var(--transition);
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    cursor: pointer;
}

.filter-select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px var(--primary-glow);
    background-color: var(--card-bg); /* Garder le fond au focus */
}

/* Correction pour Firefox */
@-moz-document url-prefix() {
    .filter-select {
        text-indent: 0.01px;
        text-overflow: '';
    }
}

/* Pour les options */
.filter-select option {
    background: var(--card-bg);
    color: var(--text-primary);
    padding: 12px;
}

/* Quand une option est sélectionnée */
.filter-select option:checked,
.filter-select option[selected] {
    background: var(--primary);
    color: white;
}

/* ==================== HISTORIQUE AMÉLIORÉ ==================== */
.history-item {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 20px;
    margin: 0 20px 16px;
    border: 1px solid var(--border);
    box-shadow: var(--shadow);
    transition: var(--transition);
    position: relative;
    overflow: hidden;
}

.history-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--gradient-primary);
}

.history-item:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-lg);
}

.history-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 16px;
}

.history-date {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    font-weight: 500;
}

.history-workout {
    font-size: var(--font-size-base);
    font-weight: 700;
    margin-bottom: 8px;
}

.history-duration {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    font-weight: 500;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.history-stats {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr 1fr;
    gap: 8px;
    margin-bottom: 16px;
}

.history-stat {
    background: var(--card-bg);
    padding: 8px 6px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    text-align: center;
    min-width: 0;
    transition: var(--transition);
}

.history-stat:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
}

.history-stat-value {
    font-size: var(--font-size-sm);
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 3px;
    word-break: break-word;
}

.history-stat-label {
    font-size: var(--font-size-xs);
    color: var(--text-secondary);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    line-height: 1.2;
}

.history-actions {
    display: flex;
    gap: 8px;
    justify-content: center;
}

/* ==================== MODAL DÉTAIL HISTORIQUE AMÉLIORÉ ==================== */
.history-detail-exercise {
    background: var(--card-bg);
    padding: 12px;
    border-radius: var(--radius-sm);
    margin-bottom: 8px;
    border: 1px solid var(--border);
    transition: var(--transition);
}

.history-detail-exercise:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
}

.history-detail-exercise-name {
    font-weight: 600;
    margin-bottom: 6px;
    color: var(--text-primary);
}

.history-detail-sets {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
}

.history-detail-set {
    background: var(--card-bg);
    padding: 4px 8px;
    border-radius: 10px;
    font-size: var(--font-size-xs);
    border: 1px solid var(--border);
    transition: var(--transition);
}

.history-detail-set:hover {
    border-color: var(--primary);
    transform: translateY(-1px);
}

/* ==================== STYLES POUR LE MODULE NUTRITION AMÉLIORÉS ==================== */
.calories-progress {
    margin-top: 12px;
}

.progress-bar {
    background: rgba(255, 255, 255, 0.2);
    height: 6px;
    border-radius: 3px;
    overflow: hidden;
}

.progress-fill {
    background: white;
    height: 100%;
    border-radius: 3px;
    transition: width 0.3s ease;
    position: relative;
    overflow: hidden;
}

.progress-fill::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
    animation: shimmer 2s infinite;
}

.macro-target {
    font-size: var(--font-size-xs);
    color: var(--text-tertiary);
    margin-top: 3px;
}

.nutrition-tabs {
    display: flex;
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 3px;
    margin: 0 20px 16px;
    border: 1px solid var(--border);
}

.nutrition-tab {
    flex: 1;
    text-align: center;
    padding: 10px 6px;
    border-radius: var(--radius-sm);
    font-weight: 600;
    font-size: var(--font-size-sm);
    cursor: pointer;
    transition: var(--transition);
}

.nutrition-tab.active {
    background: var(--gradient-success);
    color: white;
    box-shadow: var(--shadow);
}

.food-search-results {
    max-height: 280px;
    overflow-y: auto;
    margin-top: 12px;
    padding-right: 8px;
}

.food-item {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 12px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: var(--transition);
    flex-wrap: wrap;
}

.food-item:hover {
    background: var(--border);
}

.food-item:last-child {
    border-bottom: none;
}

.food-info {
    flex: 1;
    min-width: 200px;
}

.food-name {
    font-weight: 600;
    margin-bottom: 3px;
}

.food-details {
    font-size: var(--font-size-xs);
    color: var(--text-secondary);
}

.food-macros {
    display: flex;
    gap: 6px;
    font-size: var(--font-size-xs);
    margin-top: 4px;
}

/* ==================== ORGANISATION PAR CATÉGORIE DANS LA RECHERCHE D'ALIMENTS ==================== */
.food-category-header {
    margin-top: 20px;
    margin-bottom: 10px;
    font-size: var(--font-size-sm);
    font-weight: 700;
    color: var(--text-primary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding-bottom: 8px;
    border-bottom: 2px solid var(--primary);
}

.food-category-header:first-child {
    margin-top: 0;
}

.food-search-simple-item {
    background: var(--card-bg);
    border-radius: var(--radius-sm);
    padding: 12px;
    margin-bottom: 8px;
    border: 1px solid var(--border);
    transition: var(--transition);
    cursor: pointer;
}

.food-search-simple-item:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
    border-color: var(--primary);
}

.food-search-simple-name {
    font-weight: 700;
    font-size: var(--font-size-base);
    color: var(--text-primary);
    margin-bottom: 6px;
}

.food-search-simple-details {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
}

/* Indicateurs visuels pour les types d'aliments */
.food-type-indicator {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: var(--font-size-xs);
    font-weight: 600;
}

.food-type-halal {
    background: rgba(5, 150, 105, 0.1);
    color: var(--success);
    border: 1px solid rgba(5, 150, 105, 0.2);
}

.food-type-custom {
    background: rgba(139, 92, 246, 0.1);
    color: var(--primary);
    border: 1px solid rgba(139, 92, 246, 0.2);
}

.food-type-default {
    background: rgba(107, 114, 128, 0.1);
    color: var(--text-secondary);
    border: 1px solid rgba(107, 114, 128, 0.2);
}

/* Pour les résultats de recherche simple (modal) */
#food-search-results-simple .food-search-simple-item {
    margin: 0 0 8px 0;
}

#food-search-results-simple .food-search-simple-item:last-child {
    margin-bottom: 0;
}


.macro-badge {
    background: var(--card-bg);
    padding: 3px 6px;
    border-radius: 10px;
    font-weight: 600;
    border: 1px solid var(--border);
    transition: var(--transition);
}

.macro-badge:hover {
    transform: translateY(-1px);
    border-color: var(--primary);
}

.protein-badge {
    color: #DC2626;
    border-color: rgba(220, 38, 38, 0.2);
}

.carbs-badge {
    color: #059669;
    border-color: rgba(5, 150, 105, 0.2);
}

.fat-badge {
    color: #D97706;
    border-color: rgba(217, 119, 6, 0.2);
}

.meal-type-badge {
    background: var(--gradient-success);
    color: white;
    padding: 3px 8px;
    border-radius: 16px;
    font-size: var(--font-size-xs);
    font-weight: 600;
}

/* Nouveau design pour historique nutrition */
.nutrition-history-item {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 20px;
    margin: 0 20px 16px;
    border: 1px solid var(--border);
    box-shadow: var(--shadow);
    transition: var(--transition);
    position: relative;
    overflow: hidden;
}

.nutrition-history-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--gradient-success);
}

.nutrition-history-item:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
    border-color: var(--success);
}

.nutrition-history-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 16px;
}

.nutrition-history-title {
    font-weight: 700;
    font-size: var(--font-size-base);
    color: var(--text-primary);
}

.nutrition-history-date {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    font-weight: 500;
}

.nutrition-history-totals {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    margin-bottom: 16px;
}

.nutrition-history-total {
    text-align: center;
    padding: 12px 8px;
    background: var(--card-bg);
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    transition: var(--transition);
}

.nutrition-history-total:hover {
    border-color: var(--success);
    transform: translateY(-2px);
}

.nutrition-history-total-value {
    font-weight: 700;
    font-size: var(--font-size-lg);
    color: var(--success);
    margin-bottom: 4px;
}

.nutrition-history-total-label {
    font-size: var(--font-size-xs);
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.3px;
    line-height: 1.2;
}

.nutrition-history-actions {
    display: flex;
    gap: 10px;
    margin-top: 16px;
}

.nutrition-history-actions .action-btn {
    flex: 1;
    padding: 10px 12px;
    font-size: var(--font-size-sm);
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    font-weight: 600;
}

.nutrition-history-actions .action-btn:nth-child(1) {
    background: var(--success);
    color: white;
    border: none;
}

.nutrition-history-actions .action-btn:nth-child(2) {
    background: var(--danger);
    color: white;
    border: none;
}

.nutrition-history-actions .action-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.nutrition-history-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 12px;
}

.nutrition-history-title {
    font-weight: 700;
    font-size: var(--font-size-base);
}

.nutrition-history-date {
    font-size: var(--font-size-xs);
    color: var(--text-secondary);
}

.nutrition-history-foods {
    margin-bottom: 12px;
}

.nutrition-history-food {
    display: flex;
    justify-content: space-between;
    padding: 6px 0;
    border-bottom: 1px solid var(--border);
}

.nutrition-history-food:last-child {
    border-bottom: none;
}

.nutrition-history-totals {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 6px;
    padding-top: 12px;
    border-top: 1px solid var(--border);
}

.nutrition-history-total {
    text-align: center;
}

.nutrition-history-total-value {
    font-weight: 700;
    font-size: var(--font-size-base);
}

.nutrition-history-total-label {
    font-size: var(--font-size-xs);
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.3px;
    line-height: 1.2;
}

.empty-state {
    text-align: center;
    padding: 32px 16px;
    color: var(--text-secondary);
}

.empty-state-icon {
    font-size: var(--font-size-3xl);
    margin-bottom: 12px;
    opacity: 0.3;
}

/* ==================== UTILITAIRES ==================== */
.hidden {
    display: none !important;
}

.text-center {
    text-align: center;
}

.mt-4 {
    margin-top: 16px;
}

.mb-4 {
    margin-bottom: 16px;
}

.flex {
    display: flex;
}

.flex-col {
    flex-direction: column;
}

.items-center {
    align-items: center;
}

.justify-center {
    justify-content: center;
}

.justify-between {
    justify-content: space-between;
}

.gap-2 {
    gap: 8px;
}

.gap-4 {
    gap: 16px;
}

.w-full {
    width: 100%;
}

/* ==================== BOUTON RADIO ==================== */
.radio-tabs {
    display: flex;
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 3px;
    margin: 0 20px 16px;
    border: 1px solid var(--border);
}

.radio-tab {
    flex: 1;
    text-align: center;
    padding: 10px 6px;
    border-radius: var(--radius-sm);
    font-weight: 600;
    font-size: var(--font-size-sm);
    cursor: pointer;
    transition: var(--transition);
    background: none;
    border: none;
    color: var(--text-secondary);
}

.radio-tab.active {
    background: var(--gradient-primary);
    color: white;
    box-shadow: var(--shadow);
}

/* ==================== FORMULAIRE DE QUANTITÉ ==================== */
.quantity-form {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-top: 8px;
    flex-wrap: wrap;
}

.quantity-input {
    flex: 1;
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 8px 12px;
    font-size: var(--font-size-base);
    color: var(--text-primary);
    text-align: center;
    min-width: 80px;
    transition: var(--transition);
}

.quantity-input:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px var(--primary-glow);
}

.add-with-quantity-btn {
    padding: 8px 16px;
    background: var(--success);
    color: white;
    border: none;
    border-radius: var(--radius-sm);
    font-weight: 600;
    font-size: var(--font-size-sm);
    cursor: pointer;
    transition: var(--transition);
    white-space: nowrap;
    position: relative;
    overflow: hidden;
}

.add-with-quantity-btn:hover {
    background: var(--success-dark);
    transform: translateY(-2px);
    box-shadow: var(--shadow-success);
}

.add-with-quantity-btn::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), transparent);
    opacity: 0;
    transition: var(--transition);
}

.add-with-quantity-btn:hover::after {
    opacity: 1;
}

/* ==================== STYLES POUR LES ALIMENTS DANS LES REPAS ==================== */
.meal-food-item {
    background: var(--card-bg);
    border-radius: var(--radius-sm);
    padding: 12px;
    margin-bottom: 8px;
    border: 1px solid var(--border);
    transition: var(--transition);
}

.meal-food-item:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
    border-color: var(--primary);
}

/* ==================== STYLES POUR LE BOUTON SAUVEGARDER LA SÉANCE ==================== */
#workout-exercises-selection,
#edit-workout-exercises-selection {
    max-height: 200px;
    overflow-y: auto;
    margin-bottom: 10px;
    padding-right: 5px;
}

/* ==================== POUR ÉVITER L'ASCENSEUR HORIZONTAL DANS LES MODALS ==================== */
.modal-scrollable {
    max-height: 60vh;
    overflow-y: auto;
    padding-right: 8px;
}

/* ==================== NOUVEAU: Styles pour les boutons Import/Export ==================== */
.import-export-section {
    display: flex;
    gap: 10px;
    margin: 20px;
}

.import-export-btn {
    flex: 1;
    padding: 12px;
    border-radius: var(--radius);
    font-weight: 600;
    font-size: var(--font-size-sm);
    cursor: pointer;
    transition: var(--transition);
    border: 1px solid var(--border);
    background: var(--card-bg);
    color: var(--text-primary);
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    position: relative;
    overflow: hidden;
}

.import-export-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
    border-color: var(--primary);
}

.import-export-btn::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), transparent);
    opacity: 0;
    transition: var(--transition);
}

.import-export-btn:hover::after {
    opacity: 1;
}

.import-btn {
    background: var(--gradient-success);
    color: white;
    border: none;
}

.export-btn {
    background: var(--gradient-primary);
    color: white;
    border: none;
}

/* ==================== Styles pour le bouton Dupliquer dans les séances ==================== */
.duplicate-btn {
    background: var(--gradient-primary);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    position: relative;
    overflow: hidden;
}

.duplicate-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-primary);
}

.duplicate-btn::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), transparent);
    opacity: 0;
    transition: var(--transition);
}

.duplicate-btn:hover::after {
    opacity: 1;
}

/* ==================== Styles pour la recherche avancée ==================== */
.advanced-search-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 16px;
}

.filter-option {
    background: var(--card-bg);
    border: 1px solid var(--border);
    padding: 8px 12px;
    border-radius: 20px;
    font-size: var(--font-size-sm);
    cursor: pointer;
    transition: var(--transition);
    white-space: nowrap;
}

.filter-option.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.filter-option:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
    border-color: var(--primary);
}

.difficulty-beginner {
    background: #059669;
    color: white;
}

.difficulty-intermediate {
    background: #D97706;
    color: white;
}

.difficulty-advanced {
    background: #DC2626;
    color: white;
}

.exercise-difficulty-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: var(--font-size-xs);
    font-weight: 600;
    display: inline-block;
}

/* ==================== Styles pour les paramètres ==================== */
.settings-item {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 16px;
    margin: 0 20px 12px;
    border: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: var(--transition);
}

.settings-item:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.toggle-switch {
    position: relative;
    display: inline-block;
    width: 52px;
    height: 26px;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--border);
    transition: .3s;
    border-radius: 34px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .3s;
    border-radius: 50%;
}

input:checked + .slider {
    background-color: var(--success);
}

input:checked + .slider:before {
    transform: translateX(26px);
}

/* ==================== Styles pour la pause totale ==================== */
.pause-total {
    background: var(--gradient-primary);
    color: white;
    padding: 12px;
    border-radius: var(--radius-sm);
    margin: 10px 20px;
    text-align: center;
    font-weight: 600;
    position: relative;
    overflow: hidden;
}

.pause-total::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), transparent);
}

.settings-list {
    padding: 10px 0;
}

/* ==================== NOUVEAUX STYLES POUR LES GRAPHIQUES ==================== */
.chart-container {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 20px;
    margin: 0 20px 16px;
    border: 1px solid var(--border);
    box-shadow: var(--shadow);
    transition: var(--transition);
}

.chart-container:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.chart-title {
    font-size: var(--font-size-base);
    font-weight: 700;
    margin-bottom: 16px;
    color: var(--text-primary);
    text-align: center;
}

/* Graphiques premium */
.chart-wrapper {
    height: 250px;
    position: relative;
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 20px;
    border: 1px solid var(--border);
    box-shadow: var(--shadow);
}

.chart-container-premium {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 24px;
    margin: 0 20px 16px;
    border: 1px solid var(--border);
    box-shadow: var(--shadow-lg);
    transition: var(--transition);
}

.chart-container-premium:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-xl);
    border-color: var(--primary);
}

.chart-title-premium {
    font-size: var(--font-size-lg);
    font-weight: 700;
    margin-bottom: 20px;
    color: var(--text-primary);
    text-align: center;
    position: relative;
    padding-bottom: 10px;
}

.chart-title-premium::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 60px;
    height: 3px;
    background: var(--gradient-primary);
    border-radius: 2px;
}

/* Graphique de courbe */
.line-chart {
    position: relative;
    width: 100%;
    height: 100%;
}

.chart-grid {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: grid;
    grid-template-columns: repeat(10, 1fr);
    grid-template-rows: repeat(5, 1fr);
    border-top: 1px solid var(--border);
    border-right: 1px solid var(--border);
}

.chart-grid-line {
    border-left: 1px solid var(--border);
    border-bottom: 1px solid var(--border);
}

.chart-line {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    stroke: var(--primary);
    stroke-width: 3;
    fill: none;
    filter: drop-shadow(0 2px 4px rgba(37, 99, 235, 0.3));
}

.chart-point {
    position: absolute;
    width: 10px;
    height: 10px;
    background: var(--primary);
    border-radius: 50%;
    border: 2px solid white;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    transform: translate(-50%, -50%);
    transition: var(--transition);
    cursor: pointer;
}

.chart-point:hover {
    transform: translate(-50%, -50%) scale(1.5);
    background: var(--primary-dark);
}

.chart-axis {
    position: absolute;
    color: var(--text-secondary);
    font-size: var(--font-size-xs);
    font-weight: 600;
}

.chart-axis-x {
    bottom: -25px;
    text-align: center;
}

.chart-axis-y {
    left: -40px;
    text-align: right;
    transform: translateY(-50%);
}

/* Graphique à barres pour exercices */
.bar-chart {
    display: flex;
    align-items: flex-end;
    height: 100%;
    gap: 12px;
    padding: 20px 0;
}

.bar-container {
    flex: 1;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.bar {
    width: 100%;
    background: var(--gradient-primary);
    border-radius: 6px 6px 0 0;
    transition: var(--transition);
    position: relative;
    overflow: hidden;
}

.bar:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(37, 99, 235, 0.3);
}

.bar::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(transparent, rgba(255, 255, 255, 0.2));
    opacity: 0;
    transition: var(--transition);
}

.bar:hover::after {
    opacity: 1;
}

.bar-label {
    margin-top: 8px;
    font-size: var(--font-size-xs);
    color: var(--text-secondary);
    font-weight: 600;
    text-align: center;
    word-break: break-word;
}

.bar-value {
    position: absolute;
    top: -25px;
    left: 50%;
    transform: translateX(-50%);
    font-size: var(--font-size-xs);
    color: var(--primary);
    font-weight: 700;
    white-space: nowrap;
}

.history-tabs {
    display: flex;
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 3px;
    margin: 0 20px 16px;
    border: 1px solid var(--border);
}

.history-tab {
    flex: 1;
    text-align: center;
    padding: 10px 6px;
    border-radius: var(--radius-sm);
    font-weight: 600;
    font-size: var(--font-size-sm);
    cursor: pointer;
    transition: var(--transition);
}

.history-tab.active {
    background: var(--gradient-primary);
    color: white;
    box-shadow: var(--shadow);
}

.stat-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 10px;
    margin: 16px 0;
}

.stat-card {
    background: var(--card-bg);
    padding: 16px;
    border-radius: var(--radius-sm);
    text-align: center;
    border: 1px solid var(--border);
    transition: var(--transition);
}

.stat-card:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.stat-card-value {
    font-size: var(--font-size-lg);
    font-weight: 800;
    color: var(--primary);
    margin-bottom: 4px;
}

.stat-card-label {
    font-size: var(--font-size-xs);
    color: var(--text-secondary);
    font-weight: 600;
    text-transform: uppercase;
}

/* ==================== Styles pour les boutons de navigation dans l'historique ==================== */
.history-nav-buttons {
    display: flex;
    gap: 10px;
    margin: 0 20px 16px;
    justify-content: center;
}

.history-nav-btn {
    flex: 1;
    padding: 12px;
    border-radius: var(--radius);
    font-weight: 600;
    font-size: var(--font-size-sm);
    cursor: pointer;
    transition: var(--transition);
    border: 1px solid var(--border);
    background: var(--card-bg);
    color: var(--text-primary);
    text-align: center;
    max-width: 200px;
}

.history-nav-btn.active {
    background: var(--gradient-primary);
    color: white;
    border-color: var(--primary);
}

.history-nav-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
    border-color: var(--primary);
}

/* ==================== Styles pour les aliments enrichis ==================== */
.meal-type-select {
    width: 100%;
    margin-bottom: 16px;
}

.meal-type-options {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 10px;
}

.meal-type-option {
    padding: 8px 12px;
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 20px;
    font-size: var(--font-size-sm);
    cursor: pointer;
    transition: var(--transition);
    flex: 1;
    text-align: center;
}

.meal-type-option.active {
    background: var(--gradient-success);
    color: white;
    border-color: var(--success);
}

.meal-type-option:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
    border-color: var(--primary);
}

/* ==================== Correction pour les boutons modaux ==================== */
.modal-backdrop {
    z-index: 1999;
}

.modal-active {
    z-index: 2001 !important;
}

/* ==================== STYLES POUR LES BOUTONS DE RÉORGANISATION ==================== */
.reorder-buttons {
    display: flex;
    gap: 5px;
}

.reorder-btn {
    background: var(--card-bg);
    border: 1px solid var(--border);
    color: var(--text-secondary);
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: var(--transition);
    font-size: var(--font-size-sm);
    font-weight: bold;
}

.reorder-btn:hover {
    background: var(--primary);
    color: white;
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

/* ==================== STYLES POUR LE BOUTON AFFICHER (RECHERCHE AVANCÉE) ==================== */
.advanced-search-display-btn {
    background: var(--card-bg);
    border: 1px solid var(--border);
    padding: 10px 15px;
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    width: 100%;
    position: relative;
    overflow: hidden;
}

.advanced-search-display-btn:hover {
    background: var(--primary);
    color: white;
    transform: translateY(-2px);
    box-shadow: var(--shadow);
    border-color: var(--primary);
}

.advanced-search-display-btn::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), transparent);
    opacity: 0;
    transition: var(--transition);
}

.advanced-search-display-btn:hover::after {
    opacity: 1;
}

.advanced-search-selected-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin: 10px 0;
}

.selected-filter {
    background: var(--primary);
    color: white;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: var(--font-size-xs);
    display: flex;
    align-items: center;
    gap: 5px;
}

.selected-filter-remove {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    font-size: var(--font-size-xs);
    padding: 0;
    margin: 0;
}

/* ==================== STYLES POUR LE BOUTON SUPPRIMER TOUS LES ALIMENTS ==================== */
.delete-all-btn-container {
    display: flex;
    gap: 10px;
    margin: 0 20px 16px;
    justify-content: center;
}

/* ==================== STYLES AMÉLIORÉS POUR LE DÉTAIL HISTORIQUE ==================== */
.history-detail-content {
    background: var(--card-bg);
    border-radius: var(--radius-sm);
    padding: 16px;
    margin-bottom: 10px;
    border: 1px solid var(--border);
    transition: var(--transition);
}

.history-detail-content:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.history-detail-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border);
}

.history-detail-actions {
    display: flex;
    gap: 10px;
    margin-top: 16px;
}

/* ==================== STYLES POUR LE BOUTON REFAIRE ==================== */
.redo-btn {
    background: var(--gradient-primary);
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: var(--radius-sm);
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 8px;
    position: relative;
    overflow: hidden;
}

.redo-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-primary);
}

.redo-btn::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), transparent);
    opacity: 0;
    transition: var(--transition);
}

.redo-btn:hover::after {
    opacity: 1;
}

/* ==================== NAVBAR FIXE AMÉLIORÉE ==================== */
.navbar-container {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    z-index: 900;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 10px 0;
    background: transparent;
    pointer-events: none;
}

.navbar {
    background: var(--card-bg);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    display: flex;
    padding: 10px 16px;
    border-radius: 24px;
    border: 1px solid var(--border);
    box-shadow: var(--shadow-xl);
    animation: slideInFromBottom 0.4s ease 0.2s both;
    pointer-events: auto;
    width: 90%;
    max-width: 360px;
    margin: 0 auto;
}

.nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 6px 10px;
    border-radius: 16px;
    transition: var(--transition);
    cursor: pointer;
    position: relative;
    flex: 1;
    min-width: 0;
    margin: 0 3px;
    user-select: none;
    color: var(--text-secondary);
}

.nav-item.active {
    background: var(--gradient-primary);
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
    color: white;
}

.nav-item.active::after {
    content: '';
    position: absolute;
    top: -2px;
    left: -2px;
    right: -2px;
    bottom: -2px;
    background: var(--gradient-primary);
    border-radius: 18px;
    z-index: -1;
    opacity: 0.5;
    animation: glow 2s infinite;
}

.nav-icon {
    font-size: var(--font-size-base);
    margin-bottom: 3px;
    transition: var(--transition);
}

.nav-text {
    font-size: var(--font-size-xs);
    font-weight: 600;
    letter-spacing: -0.2px;
    transition: var(--transition);
    text-align: center;
    white-space: nowrap;
}

/* ==================== CALORIES BALANCE ==================== */
.calories-balance {
    font-size: var(--font-size-sm);
    margin-top: 4px;
    font-weight: 600;
}

.calories-balance.positive {
    color: var(--success);
    opacity: 0.9;
}

.calories-balance.negative {
    color: var(--danger);
}

.macro-remaining {
    font-size: var(--font-size-xs);
    color: var(--text-tertiary);
    margin-top: 2px;
}

.macro-remaining.positive {
    color: var(--success);
}

.macro-remaining.negative {
    color: var(--danger);
}

.history-calories-balance {
    font-size: var(--font-size-sm);
    font-weight: 600;
    margin-top: 3px;
}

.history-calories-balance.positive {
    color: var(--success);
}

.history-calories-balance.negative {
    color: var(--danger);
}

.nutrition-history-actions {
    display: flex;
    gap: 6px;
    margin-top: 12px;
}

.nutrition-history-btn {
    flex: 1;
    padding: 6px 3px;
    border: none;
    border-radius: var(--radius-sm);
    font-weight: 600;
    font-size: var(--font-size-xs);
    cursor: pointer;
    transition: var(--transition);
    min-width: 0;
}

/* ==================== OPTIMISATION DES BOUTONS DANS LE MODAL DE RECHERCHE D'ALIMENT ==================== */
.food-search-btn-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    margin-top: 10px;
    gap: 8px;
}

.food-search-btn {
    flex: 1;
    padding: 10px 8px;
    font-size: var(--font-size-sm);
    white-space: nowrap;
    min-width: 0;
}

/* ==================== STYLES POUR LE MODAL AJOUTER REPAS - OPTIMISATION ==================== */
.add-meal-modal-content {
    max-height: 80vh;
    overflow-y: auto;
    padding-right: 5px;
}

/* ==================== STYLES POUR LE WORKOUT EXERCISE ACTIONS ==================== */
.workout-exercise-actions {
    display: flex;
    gap: 6px;
    align-items: center;
}

/* ==================== COMPONENT BOX DESIGN ==================== */
.component-box {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 20px;
    margin: 0 20px 16px;
    border: 1px solid var(--border);
    box-shadow: var(--shadow);
    position: relative;
    overflow: hidden;
    transition: var(--transition);
}

.component-box::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--gradient-primary);
    transform: scaleX(0);
    transform-origin: left;
    transition: transform 0.3s ease;
}

.component-box:hover::before {
    transform: scaleX(1);
}

.component-box:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.component-box-title {
    font-size: var(--font-size-base);
    font-weight: 700;
    margin-bottom: 16px;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 10px;
}

.component-box-content {
    position: relative;
    z-index: 1;
}

/* ==================== BETTER HISTORY ITEM DESIGN ==================== */
.history-item-improved {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 20px;
    margin: 0 20px 16px;
    border: 1px solid var(--border);
    box-shadow: var(--shadow);
    transition: var(--transition);
    position: relative;
    overflow: hidden;
}

.history-item-improved::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--gradient-primary);
}

.history-item-improved:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.history-item-improved-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 16px;
}

.history-item-improved-title {
    font-size: var(--font-size-base);
    font-weight: 700;
    color: var(--text-primary);
}

.history-item-improved-date {
    font-size: var(--font-size-xs);
    color: var(--text-secondary);
    font-weight: 500;
}

.history-item-improved-stats {
    display: grid;
    grid-template-areas:
        "exercice exercice"
        "series repetitions"
        "poids duree"
        "pause pause";
    gap: 8px;
    margin-bottom: 16px;
}

.history-item-improved-stat:nth-child(1) { grid-area: exercice; }
.history-item-improved-stat:nth-child(2) { grid-area: series; }
.history-item-improved-stat:nth-child(3) { grid-area: repetitions; }
.history-item-improved-stat:nth-child(4) { grid-area: poids; }
.history-item-improved-stat:nth-child(5) { grid-area: duree; }
.history-item-improved-stat:nth-child(6) { grid-area: pause; }

.history-item-improved-stat:nth-child(1) .history-item-improved-stat-label {
    text-align: left;
    margin-left: 5px;
}

.history-item-improved-stat:nth-child(1) .history-item-improved-stat-value {
    text-align: left;
    margin-left: 5px;
    font-size: var(--font-size-base);
}

.history-item-improved-stat {
    background: var(--card-bg);
    padding: 8px 6px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    text-align: center;
    transition: var(--transition);
}

.history-item-improved-stat:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
}

.history-item-improved-stat-value {
    font-size: var(--font-size-sm);
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 3px;
}

.history-item-improved-stat-label {
    font-size: var(--font-size-xs);
    color: var(--text-secondary);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.history-item-improved-actions {
    display: flex;
    gap: 10px;
    margin-top: 16px;
}

.history-item-improved-actions .action-btn {
    flex: 1;
    padding: 10px 12px;
    font-size: var(--font-size-sm);
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    font-weight: 600;
}

.history-item-improved-actions .action-btn:nth-child(1) {
    background: var(--primary);
    color: white;
    border: none;
}

.history-item-improved-actions .action-btn:nth-child(2) {
    background: var(--success);
    color: white;
    border: none;
}

.history-item-improved-actions .action-btn:nth-child(3) {
    background: var(--danger);
    color: white;
    border: none;
}

.history-item-improved-actions .action-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

/* ==================== IMPROVED BUTTON DESIGN FOR GRAPHICAL/NON-GRAPHICAL ==================== */
.history-view-toggle {
    display: flex;
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 3px;
    margin: 0 20px 16px;
    border: 1px solid var(--border);
}

.history-view-toggle-btn {
    flex: 1;
    text-align: center;
    padding: 10px 6px;
    border-radius: var(--radius-sm);
    font-weight: 600;
    font-size: var(--font-size-sm);
    cursor: pointer;
    transition: var(--transition);
    background: none;
    border: none;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}

.history-view-toggle-btn.active {
    background: var(--gradient-primary);
    color: white;
    box-shadow: var(--shadow);
}

/* ==================== DETAIL BUTTON FIX ==================== */
.detail-btn {
    background: var(--card-bg);
    border: 1px solid var(--border);
    color: var(--text-secondary);
    padding: 8px 12px;
    border-radius: var(--radius-sm);
    font-size: var(--font-size-xs);
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 5px;
    text-decoration: none;
    position: relative;
    overflow: hidden;
}

.detail-btn:hover {
    background: var(--primary);
    color: white;
    transform: translateY(-2px);
    box-shadow: var(--shadow);
    border-color: var(--primary);
}

.detail-btn::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), transparent);
    opacity: 0;
    transition: var(--transition);
}

.detail-btn:hover::after {
    opacity: 1;
}

/* ==================== MODAL FICHE EXERCICE DÉTAILLÉE ==================== */
.exercise-detail-modal-content {
    max-height: 80vh;
    overflow-y: auto;
    padding-right: 5px;
}

.exercise-detail-header {
    text-align: center;
    margin-bottom: 20px;
    position: relative;
}

.exercise-detail-icon {
    width: 70px;
    height: 70px;
    background: var(--gradient-primary);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 12px;
    color: white;
    font-size: var(--font-size-2xl);
    box-shadow: var(--shadow-lg);
    transition: var(--transition);
}

.exercise-detail-icon:hover {
    transform: rotate(10deg) scale(1.1);
}

.exercise-detail-title {
    font-size: var(--font-size-xl);
    font-weight: 800;
    margin-bottom: 8px;
    color: var(--text-primary);
}

.exercise-detail-subtitle {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    flex-wrap: wrap;
}

.exercise-detail-badge {
    padding: 4px 10px;
    border-radius: 16px;
    font-size: var(--font-size-xs);
    font-weight: 600;
    display: inline-block;
}

.exercise-detail-section {
    background: var(--card-bg);
    border-radius: var(--radius-sm);
    padding: 16px;
    margin-bottom: 16px;
    border: 1px solid var(--border);
    transition: var(--transition);
}

.exercise-detail-section:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.exercise-detail-section-title {
    font-size: var(--font-size-base);
    font-weight: 700;
    margin-bottom: 8px;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 8px;
}

.exercise-detail-description {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    line-height: 1.5;
}

.exercise-detail-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-top: 10px;
}

.exercise-detail-stat {
    text-align: center;
    padding: 12px;
    background: var(--card-bg);
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    transition: var(--transition);
}

.exercise-detail-stat:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.exercise-detail-stat-value {
    font-size: var(--font-size-base);
    font-weight: 800;
    margin-bottom: 4px;
}

.exercise-detail-stat-label {
    font-size: var(--font-size-xs);
    color: var(--text-secondary);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.exercise-detail-equipment-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 10px;
}

.exercise-detail-equipment-item {
    background: var(--card-bg);
    padding: 6px 12px;
    border-radius: 16px;
    font-size: var(--font-size-sm);
    border: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 6px;
    transition: var(--transition);
}

.exercise-detail-equipment-item:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.exercise-detail-video-btn {
    background: linear-gradient(135deg, #DC2626, #EF4444);
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: var(--radius);
    font-weight: 700;
    font-size: var(--font-size-base);
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    width: 100%;
    margin-top: 16px;
    position: relative;
    overflow: hidden;
}

.exercise-detail-video-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.exercise-detail-video-btn::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), transparent);
    opacity: 0;
    transition: var(--transition);
}

.exercise-detail-video-btn:hover::after {
    opacity: 1;
}

.exercise-detail-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

.exercise-difficulty-badge {
    padding: 4px 12px;
    border-radius: 16px;
    font-size: var(--font-size-xs);
    font-weight: 800;
    text-transform: uppercase;
}

.difficulty-beginner {
    background: linear-gradient(135deg, #059669, #10B981);
    color: white;
}

.difficulty-intermediate {
    background: linear-gradient(135deg, #D97706, #F59E0B);
    color: white;
}

.difficulty-advanced {
    background: linear-gradient(135deg, #DC2626, #EF4444);
    color: white;
}

.exercise-muscle-badge {
    background: var(--gradient-primary);
    color: white;
    padding: 4px 12px;
    border-radius: 16px;
    font-size: var(--font-size-xs);
    font-weight: 800;
}

.exercise-category-badge {
    background: var(--gradient-premium);
    color: white;
    padding: 4px 12px;
    border-radius: 16px;
    font-size: var(--font-size-xs);
    font-weight: 800;
}

/* ==================== FOOD ITEM IMPROVED ==================== */
.food-item-improved {
    background: var(--card-bg);
    border-radius: var(--radius-sm);
    padding: 16px;
    margin-bottom: 10px;
    border: 1px solid var(--border);
    transition: var(--transition);
}

.food-item-improved:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
    border-color: var(--primary);
}

.food-item-improved-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 10px;
}

.food-item-improved-name {
    font-weight: 600;
    font-size: var(--font-size-base);
    color: var(--text-primary);
}

.food-item-improved-calories {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    font-weight: 500;
}

.food-item-improved-details {
    display: flex;
    gap: 10px;
    font-size: var(--font-size-xs);
    color: var(--text-tertiary);
    margin-bottom: 10px;
}

.food-item-improved-macros {
    display: flex;
    gap: 8px;
}

.food-item-improved-macro {
    background: var(--card-bg);
    padding: 4px 8px;
    border-radius: 10px;
    font-size: var(--font-size-xs);
    font-weight: 600;
    border: 1px solid var(--border);
    transition: var(--transition);
}

.food-item-improved-macro:hover {
    transform: translateY(-1px);
    border-color: var(--primary);
}

/* ==================== DELETE ALL FOODS BUTTON ==================== */
.delete-all-foods-btn {
    background: var(--gradient-danger);
    color: white;
    border: none;
    padding: 12px 16px;
    border-radius: var(--radius);
    font-size: var(--font-size-sm);
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    width: 100%;
    max-width: 280px;
    margin: 0 auto 16px;
    position: relative;
    overflow: hidden;
}

.delete-all-foods-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.delete-all-foods-btn::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), transparent);
    opacity: 0;
    transition: var(--transition);
}

.delete-all-foods-btn:hover::after {
    opacity: 1;
}

/* ==================== IMPROVED SEARCH DISPLAY ==================== */
.advanced-search-display {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 16px;
    margin: 0 20px 16px;
    border: 1px solid var(--border);
    transition: var(--transition);
}

.advanced-search-display:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.advanced-search-display-title {
    font-size: var(--font-size-base);
    font-weight: 700;
    margin-bottom: 10px;
    color: var(--text-primary);
}

.advanced-search-display-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 16px;
}

.advanced-search-display-filter {
    background: var(--primary);
    color: white;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: var(--font-size-xs);
    display: flex;
    align-items: center;
    gap: 5px;
    transition: var(--transition);
}

.advanced-search-display-filter:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.advanced-search-display-actions {
    display: flex;
    gap: 10px;
}

/* ==================== IMPROVED FILTER SELECTION ==================== */
.filter-selection-container {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 16px;
    margin: 0 20px 16px;
    border: 1px solid var(--border);
    transition: var(--transition);
}

.filter-selection-container:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.filter-selection-title {
    font-size: var(--font-size-base);
    font-weight: 700;
    margin-bottom: 10px;
    color: var(--text-primary);
}

.filter-selection-options {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.filter-selection-option {
    background: var(--card-bg);
    border: 1px solid var(--border);
    padding: 8px 12px;
    border-radius: 20px;
    font-size: var(--font-size-sm);
    cursor: pointer;
    transition: var(--transition);
    white-space: nowrap;
}

.filter-selection-option.selected {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.filter-selection-option:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
    border-color: var(--primary);
}

/* ==================== LOADING INDICATOR ==================== */
.loading-indicator {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 9999;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(5px);
}

.loading-indicator.active {
    display: flex;
}

.loading-spinner {
    width: 48px;
    height: 48px;
    border: 4px solid rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    border-top-color: var(--primary);
    animation: spin 1s ease-in-out infinite;
}

/* ==================== NOUVEAU STYLE ULTRA-COMPACT POUR LES SÉRIES ==================== */
.sets-container-compact {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.set-item-compact {
    background: var(--card-bg);
    padding: 12px;
    border-radius: var(--radius-sm);
    margin-bottom: 0;
    border: 1px solid var(--border);
    transition: var(--transition);
    position: relative;
    overflow: hidden;
    display: grid;
    grid-template-columns: 60px 1fr 1fr auto;
    gap: 10px;
    align-items: center;
    min-height: 60px;
}

.set-item-compact.completed {
    background: rgba(5, 150, 105, 0.1);
    border-color: var(--success);
    color: var(--success-dark);
}

.set-item-compact.completed::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: var(--gradient-success);
}

.set-number-compact {
    font-weight: 700;
    color: var(--text-primary);
    font-size: var(--font-size-sm);
    text-align: center;
    min-width: 50px;
}

.set-item-compact.completed .set-number-compact {
    color: var(--success-dark);
}

.set-input-group-compact {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.input-label-compact {
    font-size: 11px;
    color: var(--text-secondary);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    white-space: nowrap;
}

.set-item-compact.completed .input-label-compact {
    color: var(--success-dark);
}

.number-input-compact {
    background: var(--card-bg);
    color: var(--text-primary);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 8px;
    font-size: var(--font-size-sm);
    text-align: center;
    width: 100%;
    font-weight: 600;
    transition: var(--transition);
    height: 36px;
    min-width: 0;
}

.set-item-compact.completed .number-input-compact {
    background: rgba(5, 150, 105, 0.05);
    color: var(--success-dark);
    border: 1px solid var(--success);
}

.set-controls-compact {
    display: flex;
    gap: 6px;
    align-items: center;
    min-width: 100px;
}

.set-action-btn-compact {
    background: var(--card-bg);
    border: 1px solid var(--border);
    color: var(--text-secondary);
    width: 32px;
    height: 32px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: var(--transition);
    font-size: var(--font-size-sm);
    font-weight: bold;
    flex-shrink: 0;
}

.set-action-btn-compact:hover {
    background: var(--primary);
    color: white;
    transform: translateY(-1px);
    border-color: var(--primary);
}

.checkbox-compact {
    width: 20px;
    height: 20px;
    border: 2px solid var(--border);
    border-radius: 5px;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: var(--transition);
    cursor: pointer;
    background: var(--card-bg);
    position: relative;
    overflow: hidden;
    flex-shrink: 0;
}

.checkbox-compact.checked {
    border-color: var(--success);
    background: var(--success);
}

.checkmark-compact {
    color: white;
    font-size: 10px;
    font-weight: bold;
    opacity: 0;
    transition: var(--transition);
}

.checkbox-compact.checked .checkmark-compact {
    opacity: 1;
}

.previous-set-info-compact {
    font-size: 11px;
    color: var(--text-secondary);
    margin-top: 4px;
    font-style: italic;
    grid-column: 1 / -1;
    border-top: 1px dashed var(--border);
    padding-top: 6px;
    margin-top: 6px;
}

.superset-navigation-hint-compact {
    font-size: 11px;
    color: #7C3AED;
    margin: 6px 0;
    padding: 8px;
    background: rgba(124, 58, 237, 0.08);
    border-radius: 8px;
    border-left: 3px solid #7C3AED;
    font-weight: 600;
    grid-column: 1 / -1;
}

/* ==================== PICKER 3D AVEC DÉFILEMENT INFINI - OPTIMISÉ ==================== */
.time-picker-container {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin: 20px 0;
    perspective: 1000px;
    position: relative;
}

.time-picker-column {
    flex: 1;
    position: relative;
    height: 180px;
    max-width: 80px;
    transform-style: preserve-3d;
}

.picker-column-label {
    text-align: center;
    font-size: 11px;
    color: var(--text-secondary);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 10px;
    position: relative;
    z-index: 10;
}

.picker-wheel-3d {
    height: 180px;
    position: relative;
    border-radius: 16px;
    background: var(--border);
    border: 1px solid var(--border);
    overflow: hidden;
    transform-style: preserve-3d;
}

.picker-wheel-content-3d {
    position: relative;
    height: 100%;
    transform-style: preserve-3d;
    transition: transform 0.1s linear;
}

.picker-item-3d {
    position: absolute;
    width: 100%;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--font-size-base);
    font-weight: 600;
    color: var(--text-secondary);
    opacity: 0.5;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
    user-select: none;
    transform-origin: center center;
    backface-visibility: hidden;
}

.picker-item-3d.selected {
    color: var(--text-primary);
    font-size: var(--font-size-lg);
    font-weight: 700;
    opacity: 1;
    transform: translateZ(20px);
    background: var(--primary-glow);
    border-radius: 8px;
}

.picker-highlight-3d {
    position: absolute;
    top: 50%;
    left: 8%;
    right: 8%;
    height: 40px;
    background: var(--primary-glow);
    border-radius: 12px;
    transform: translateY(-50%);
    pointer-events: none;
    z-index: 1;
    border: 1px solid var(--primary);
    opacity: 0.2;
}

.picker-glow {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 70%;
    height: 45px;
    background: radial-gradient(
        ellipse at center,
        var(--primary-glow) 0%,
        transparent 70%
    );
    transform: translate(-50%, -50%);
    filter: blur(12px);
    pointer-events: none;
    z-index: 0;
}

/* Animation de pulsation plus subtile */
@keyframes pulse-glow {
    0%, 100% { 
        box-shadow: 0 6px 15px var(--primary-glow);
    }
    50% { 
        box-shadow: 0 8px 20px var(--primary-glow);
    }
}

.picker-item-3d.selected {
    animation: pulse-glow 2s ease-in-out infinite;
}

/* ==================== CONTENEUR MODAL PLUS COMPACT ==================== */
.modal-content[style*="max-width: 340px"] {
    max-width: 320px;
    padding: 16px;
}

/* Ajustement de l'affichage du temps sélectionné */
#selected-time-display {
    font-size: var(--font-size-2xl);
    margin: 10px 0;
    color: var(--text-primary);
    font-weight: 700;
    text-align: center;
}

#total-seconds-display {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    text-align: center;
}

/* ==================== STYLES POUR LE MODAL DE THÈME ==================== */
.theme-options-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin: 20px 0;
}

.theme-option {
    background: var(--card-bg);
    border-radius: var(--radius-sm);
    padding: 16px;
    border: 2px solid var(--border);
    cursor: pointer;
    transition: var(--transition);
    position: relative;
    text-align: center;
}

.theme-option:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
    border-color: var(--primary);
}

.theme-option.selected {
    border-color: var(--primary);
    background: var(--primary-glow);
}

.theme-preview {
    width: 100%;
    height: 60px;
    border-radius: 10px;
    margin-bottom: 8px;
    box-shadow: var(--shadow);
}

.theme-name {
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 4px;
}

.theme-check {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 20px;
    height: 20px;
    background: var(--primary);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    opacity: 0;
    transform: scale(0.8);
    transition: var(--transition);
}

.theme-option.selected .theme-check {
    opacity: 1;
    transform: scale(1);
}

/* ==================== NOTIFICATIONS AMÉLIORÉES ==================== */
.temp-notification {
    position: fixed;
    top: 100px;
    left: 50%;
    transform: translateX(-50%);
    background-color: var(--card-bg);
    color: var(--text-primary);
    padding: 14px 24px;
    border-radius: var(--radius-sm);
    box-shadow: var(--shadow-xl);
    z-index: 10000;
    font-weight: 600;
    animation: fadeIn 0.3s ease, slideInFromTop 0.4s ease;
    max-width: 90%;
    text-align: center;
    backdrop-filter: blur(10px);
    border: 1px solid var(--border);
}

.temp-notification.hiding {
    animation: fadeOut 0.3s ease;
}

.temp-notification.error {
    background-color: rgba(220, 38, 38, 0.1);
    color: var(--danger);
    border-color: var(--danger);
}

.temp-notification.warning {
    background-color: rgba(217, 119, 6, 0.1);
    color: var(--warning);
    border-color: var(--warning);
}

.temp-notification.info {
    background-color: rgba(14, 165, 233, 0.1);
    color: var(--info);
    border-color: var(--info);
}

/* ==================== RESPONSIVE ==================== */
@media (max-width: 380px) {
    .app-container {
        max-width: 100%;
    }
    
    .muscle-grid {
        grid-template-columns: 1fr;
    }
    
    .set-inputs-grid {
        grid-template-columns: 1fr;
        gap: 10px;
    }
    
    .workout-timer-container {
        flex-direction: column;
        gap: 10px;
    }
    
    .workout-stat-side {
        min-width: 100%;
    }
    
    .history-stats {
        grid-template-columns: 1fr 1fr;
        gap: 6px;
    }
    
    .history-actions {
        flex-direction: column;
        gap: 6px;
    }
    
    .history-stat {
        padding: 8px 4px;
    }
    
    .history-stat-value {
        font-size: var(--font-size-sm);
    }
    
    .history-stat-label {
        font-size: var(--font-size-xs);
    }
    
    .quantity-form {
        flex-direction: column;
        gap: 8px;
        width: 100%;
    }
    
    .quantity-input {
        width: 100%;
    }
    
    .add-with-quantity-btn {
        width: 100%;
    }
    
    .food-item {
        flex-direction: column;
        gap: 10px;
    }
    
    .food-info {
        width: 100%;
    }

    .navbar {
        width: calc(100% - 24px);
        padding: 8px 12px;
        bottom: 8px;
    }
    
    .nav-item {
        padding: 5px 6px;
        min-width: 46px;
        margin: 0 1px;
    }
    
    .nav-icon {
        font-size: var(--font-size-base);
    }
    
    .nav-text {
        font-size: var(--font-size-xs);
    }
    
    .section-title {
        font-size: var(--font-size-xl);
        margin: 0 16px 16px;
    }
    
    .card, .profile-section, .workout-card, .history-item {
        margin: 0 16px 12px;
        padding: 16px;
    }
}

@media (min-width: 768px) {
    .app-container {
        max-width: 768px;
        margin: 0 auto;
        box-shadow: var(--shadow-2xl);
    }
    
    .main-content {
        padding: 120px 0 100px;
    }
    
    .section-title {
        margin: 0 32px 24px;
        font-size: var(--font-size-3xl);
    }
    
    .card, .profile-section, .workout-card, .history-item {
        margin: 0 32px 20px;
        padding: 24px;
    }
    
    .muscle-grid {
        grid-template-columns: repeat(3, 1fr);
        margin: 0 32px 20px;
        gap: 16px;
    }
    
    .macros-grid {
        gap: 16px;
    }
    
    .workout-timer-container {
        gap: 24px;
    }
    
    .workout-stat-side {
        min-width: 120px;
    }
    
    .navbar {
        max-width: 400px;
        padding: 12px 20px;
    }
}

/* Correction couleur des selects en mode sombre */
.dark-mode .filter-select {
    color: #ffffff !important;
    background-color: var(--card-bg) !important;
    /* NE PAS dupliquer la flèche, utiliser celle existante */
}

.dark-mode .filter-select option {
    color: #ffffff !important;
    background-color: var(--card-bg) !important;
}

/* Pour les options sélectionnées */
.dark-mode .filter-select option:checked,
.dark-mode .filter-select option[selected] {
    background-color: var(--primary) !important;
    color: white !important;
}

/* Corriger l'icône de flèche en mode sombre */
.dark-mode .filter-select {
    /* Garder UNE SEULE flèche */
    background-image: url("data:image/svg+xml;charset=UTF8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ffffff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e") !important;
    background-repeat: no-repeat !important;
    background-position: right 14px center !important;
    background-size: 16px !important;
}


/* ==================== PRINT STYLES ==================== */
@media print {
    .header,
    .navbar-container,
    .timer-container,
    .modal,
    .icon-btn {
        display: none !important;
    }
    
    .app-container {
        max-width: none;
        box-shadow: none;
    }
    
    .main-content {
        padding: 0;
    }
    
    .card,
    .profile-section,
    .history-item {
        break-inside: avoid;
        box-shadow: none;
        border: 1px solid #ddd;
    }
}

/* ==================== ACCESSIBILITÉ ==================== */
@media (prefers-reduced-motion: reduce) {
    * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
}

/* ==================== TOUCH OPTIMIZATION ==================== */
@media (hover: none) and (pointer: coarse) {
    .btn, .icon-btn, .nav-item {
        min-height: 44px;
        min-width: 44px;
    }
    
    .number-input, .search-input {
        min-height: 44px;
    }
    
    .card:hover, 
    .workout-card:hover, 
    .history-item:hover,
    .set-item:hover,
    .exercise-item:hover {
        transform: none;
    }
}

/* ==================== DARK MODE IMPROVEMENTS ==================== */
.dark-mode .card,
.dark-mode .profile-section,
.dark-mode .workout-card,
.dark-mode .history-item,
.dark-mode .exercise-item,
.dark-mode .set-item {
    background: var(--card-bg);
    border-color: var(--border);
}

.dark-mode .btn-secondary {
    background: var(--card-bg);
    color: var(--text-primary);
    border-color: var(--border);
}

.dark-mode .action-btn {
    background: var(--card-bg);
    border-color: var(--border);
    color: var(--text-secondary);
}

.dark-mode .icon-btn {
    background: var(--card-bg);
    border-color: var(--border);
    color: var(--text-secondary);
}

.dark-mode .icon-btn:hover {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.dark-mode .search-input,
.dark-mode .filter-select,
.dark-mode .number-input {
    background: var(--card-bg);
    border-color: var(--border);
    color: var(--text-primary);
}

.dark-mode .search-input:focus,
.dark-mode .filter-select:focus,
.dark-mode .number-input:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px var(--primary-glow);
}

/* ==================== FINAL TOUCHES ==================== */
*::selection {
    background-color: var(--primary);
    color: white;
}

/* Smooth scrolling for anchor links */
html {
    scroll-behavior: smooth;
}

/* Improve contrast for better readability */
.card, .profile-section, .workout-card, .history-item {
    background: var(--gradient-card);
}

/* Better focus styles for interactive elements */
button:focus,
input:focus,
select:focus,
textarea:focus {
    outline: 2px solid var(--primary);
    outline-offset: 2px;
}

/* Improved button active states */
.btn:active,
.icon-btn:active,
.action-btn:active {
    transform: scale(0.98);
}

/* Better loading states */
.loading {
    opacity: 0.6;
    pointer-events: none;
}

/* Improved disabled states */
.btn:disabled,
.icon-btn:disabled,
.action-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none !important;
}

/* Better text selection */
::selection {
    background: var(--primary);
    color: white;
}

::-moz-selection {
    background: var(--primary);
    color: white;
}

/* ==================== ORGANISATION INTERNE DES MODALS - SECTION MANQUANTE ==================== */
.modal-body-inner {
    padding: 16px 0;
    margin: 0 -16px;
}

.modal-section {
    padding: 0 16px;
    margin-bottom: 20px;
}

.modal-section-title {
    font-size: var(--font-size-sm);
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 10px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.modal-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-bottom: 16px;
}

.modal-grid-item {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 12px;
    text-align: center;
    cursor: pointer;
    transition: var(--transition);
}

.modal-grid-item:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.modal-grid-item.selected {
    background: var(--primary-glow);
    border-color: var(--primary);
    color: var(--primary);
    font-weight: 600;
}

.modal-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.modal-list-item {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: var(--transition);
}

.modal-list-item:last-child {
    border-bottom: none;
}

.modal-list-item:hover {
    background: var(--border);
    transform: translateX(4px);
}

.modal-list-item.selected {
    background: var(--primary-glow);
    border-left: 3px solid var(--primary);
    font-weight: 600;
}

.modal-input-group {
    margin-bottom: 16px;
}

.modal-label {
    display: block;
    font-size: var(--font-size-sm);
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 8px;
}

.modal-input {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    background: var(--card-bg);
    color: var(--text-primary);
    font-size: var(--font-size-base);
    transition: var(--transition);
}

.modal-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px var(--primary-glow);
}

.modal-textarea {
    width: 100%;
    min-height: 120px;
    padding: 12px 16px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    background: var(--card-bg);
    color: var(--text-primary);
    font-size: var(--font-size-base);
    resize: vertical;
    transition: var(--transition);
    font-family: inherit;
}

.modal-textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px var(--primary-glow);
}

.modal-select {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    background: var(--card-bg);
    color: var(--text-primary);
    font-size: var(--font-size-base);
    appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 16px;
    transition: var(--transition);
}

.modal-select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px var(--primary-glow);
}

.modal-checkbox-group {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
    cursor: pointer;
}

.modal-checkbox {
    width: 20px;
    height: 20px;
    border: 2px solid var(--border);
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: var(--transition);
}

.modal-checkbox.checked {
    background: var(--primary);
    border-color: var(--primary);
}

.modal-checkbox.checked::after {
    content: '✓';
    color: white;
    font-size: 12px;
    font-weight: bold;
}

.modal-checkbox-label {
    font-size: var(--font-size-sm);
    color: var(--text-primary);
    font-weight: 500;
}

.modal-radio-group {
    display: flex;
    gap: 16px;
    margin-bottom: 16px;
}

.modal-radio {
    flex: 1;
    position: relative;
}

.modal-radio input {
    position: absolute;
    opacity: 0;
    cursor: pointer;
}

.modal-radio-label {
    display: block;
    padding: 12px 16px;
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    text-align: center;
    font-size: var(--font-size-sm);
    font-weight: 500;
    color: var(--text-primary);
    cursor: pointer;
    transition: var(--transition);
}

.modal-radio input:checked + .modal-radio-label {
    background: var(--primary-glow);
    border-color: var(--primary);
    color: var(--primary);
    font-weight: 600;
}

.modal-radio-label:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.modal-slider {
    width: 100%;
    height: 4px;
    background: var(--border);
    border-radius: 2px;
    outline: none;
    -webkit-appearance: none;
    margin: 16px 0;
}

.modal-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 20px;
    height: 20px;
    background: var(--primary);
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid white;
    box-shadow: var(--shadow);
}

.modal-slider::-moz-range-thumb {
    width: 20px;
    height: 20px;
    background: var(--primary);
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid white;
    box-shadow: var(--shadow);
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    margin-top: 24px;
    padding-top: 16px;
    border-top: 1px solid var(--border);
}

.modal-footer-btn {
    padding: 10px 20px;
    border: none;
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
}

.modal-footer-btn.primary {
    background: var(--gradient-primary);
    color: white;
}

.modal-footer-btn.secondary {
    background: var(--card-bg);
    color: var(--text-primary);
    border: 1px solid var(--border);
}

.modal-footer-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.modal-footer-btn.primary:hover {
    box-shadow: var(--shadow-primary);
}

.modal-footer-btn.secondary:hover {
    border-color: var(--primary);
}

/* ==================== MODAL EXERCICE DETAILS - SECTION MANQUANTE ==================== */
.exercise-detail-content {
    max-height: 70vh;
    overflow-y: auto;
    padding-right: 8px;
    margin-right: -8px;
}

.exercise-detail-info-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-bottom: 20px;
}

.exercise-detail-info-item {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 12px;
    text-align: center;
}

.exercise-detail-info-value {
    font-size: var(--font-size-lg);
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 4px;
}

.exercise-detail-info-label {
    font-size: var(--font-size-xs);
    color: var(--text-secondary);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.exercise-detail-description-box {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 16px;
    margin-bottom: 20px;
    line-height: 1.6;
}

.exercise-detail-instructions {
    list-style: none;
    padding: 0;
    margin: 0 0 20px 0;
}

.exercise-detail-instruction {
    display: flex;
    gap: 12px;
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
}

.exercise-detail-instruction:last-child {
    border-bottom: none;
}

.exercise-detail-instruction-number {
    width: 24px;
    height: 24px;
    background: var(--primary);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--font-size-xs);
    font-weight: 700;
    flex-shrink: 0;
}

.exercise-detail-instruction-text {
    flex: 1;
    font-size: var(--font-size-sm);
    color: var(--text-primary);
    line-height: 1.5;
}

.exercise-detail-tips {
    background: rgba(255, 209, 102, 0.1);
    border: 1px solid var(--warning);
    border-radius: var(--radius-sm);
    padding: 16px;
    margin-bottom: 20px;
}

.exercise-detail-tips-title {
    font-size: var(--font-size-sm);
    font-weight: 700;
    color: var(--warning);
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.exercise-detail-tips-content {
    font-size: var(--font-size-sm);
    color: var(--text-primary);
    line-height: 1.5;
}

.exercise-detail-warnings {
    background: rgba(239, 71, 111, 0.1);
    border: 1px solid var(--danger);
    border-radius: var(--radius-sm);
    padding: 16px;
    margin-bottom: 20px;
}

.exercise-detail-warnings-title {
    font-size: var(--font-size-sm);
    font-weight: 700;
    color: var(--danger);
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.exercise-detail-warnings-content {
    font-size: var(--font-size-sm);
    color: var(--text-primary);
    line-height: 1.5;
}

/* ==================== MODAL NUTRITION - SECTION MANQUANTE ==================== */
.nutrition-modal-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-bottom: 20px;
}

.nutrition-modal-input-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.nutrition-modal-label {
    font-size: var(--font-size-xs);
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.nutrition-modal-input {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    background: var(--card-bg);
    color: var(--text-primary);
    font-size: var(--font-size-base);
    font-weight: 600;
    text-align: center;
    transition: var(--transition);
}

.nutrition-modal-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px var(--primary-glow);
}

.nutrition-modal-macros {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-bottom: 20px;
}

.nutrition-modal-macro {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 12px;
    text-align: center;
    transition: var(--transition);
}

.nutrition-modal-macro:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.nutrition-modal-macro-value {
    font-size: var(--font-size-lg);
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 4px;
}

.nutrition-modal-macro-label {
    font-size: var(--font-size-xs);
    color: var(--text-secondary);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.nutrition-modal-total {
    background: var(--gradient-success);
    color: white;
    border-radius: var(--radius-sm);
    padding: 16px;
    text-align: center;
    margin-bottom: 20px;
}

.nutrition-modal-total-value {
    font-size: var(--font-size-2xl);
    font-weight: 800;
    margin-bottom: 4px;
}

.nutrition-modal-total-label {
    font-size: var(--font-size-sm);
    opacity: 0.9;
    font-weight: 500;
}

.nutrition-modal-notes {
    margin-top: 20px;
}

.nutrition-modal-notes-label {
    font-size: var(--font-size-sm);
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 8px;
}

.nutrition-modal-notes-input {
    width: 100%;
    min-height: 80px;
    padding: 12px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    background: var(--card-bg);
    color: var(--text-primary);
    font-size: var(--font-size-base);
    resize: vertical;
    transition: var(--transition);
    font-family: inherit;
}

.nutrition-modal-notes-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px var(--primary-glow);
}

/* ==================== MODAL WORKOUT CREATION - SECTION MANQUANTE ==================== */
.workout-modal-steps {
    display: flex;
    gap: 8px;
    margin-bottom: 24px;
    position: relative;
}

.workout-modal-steps::before {
    content: '';
    position: absolute;
    top: 12px;
    left: 20px;
    right: 20px;
    height: 2px;
    background: var(--border);
    z-index: 1;
}

.workout-modal-step {
    flex: 1;
    position: relative;
    z-index: 2;
}

.workout-modal-step-circle {
    width: 24px;
    height: 24px;
    background: var(--card-bg);
    border: 2px solid var(--border);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 8px;
    font-size: var(--font-size-xs);
    font-weight: 600;
    color: var(--text-secondary);
    transition: var(--transition);
}

.workout-modal-step.active .workout-modal-step-circle {
    background: var(--primary);
    border-color: var(--primary);
    color: white;
}

.workout-modal-step.completed .workout-modal-step-circle {
    background: var(--success);
    border-color: var(--success);
    color: white;
}

.workout-modal-step-label {
    font-size: var(--font-size-xs);
    color: var(--text-secondary);
    text-align: center;
    font-weight: 500;
    transition: var(--transition);
}

.workout-modal-step.active .workout-modal-step-label {
    color: var(--primary);
    font-weight: 600;
}

.workout-modal-step.completed .workout-modal-step-label {
    color: var(--success);
}

.workout-modal-form-section {
    margin-bottom: 24px;
}

.workout-modal-form-title {
    font-size: var(--font-size-base);
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 16px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border);
}

.workout-modal-exercises-list {
    max-height: 300px;
    overflow-y: auto;
    margin-bottom: 20px;
    padding-right: 8px;
}

.workout-modal-exercise-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    margin-bottom: 8px;
    cursor: move;
    transition: var(--transition);
}

.workout-modal-exercise-item:hover {
    border-color: var(--primary);
    transform: translateX(4px);
    box-shadow: var(--shadow);
}

.workout-modal-exercise-drag {
    color: var(--text-tertiary);
    cursor: grab;
}

.workout-modal-exercise-drag:active {
    cursor: grabbing;
}

.workout-modal-exercise-info {
    flex: 1;
}

.workout-modal-exercise-name {
    font-size: var(--font-size-sm);
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 2px;
}

.workout-modal-exercise-muscle {
    font-size: var(--font-size-xs);
    color: var(--text-secondary);
}

.workout-modal-exercise-remove {
    background: none;
    border: none;
    color: var(--danger);
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    transition: var(--transition);
}

.workout-modal-exercise-remove:hover {
    background: rgba(220, 38, 38, 0.1);
    transform: scale(1.1);
}

.workout-modal-exercise-sets {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 8px;
}

.workout-modal-set-input {
    width: 60px;
    padding: 6px 8px;
    border: 1px solid var(--border);
    border-radius: var(--radius-xs);
    background: var(--card-bg);
    color: var(--text-primary);
    font-size: var(--font-size-sm);
    font-weight: 600;
    text-align: center;
    transition: var(--transition);
}

.workout-modal-set-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 2px var(--primary-glow);
}

.workout-modal-set-label {
    font-size: var(--font-size-xs);
    color: var(--text-secondary);
    font-weight: 500;
}

.workout-modal-rest-input {
    width: 80px;
    padding: 6px 8px;
    border: 1px solid var(--border);
    border-radius: var(--radius-xs);
    background: var(--card-bg);
    color: var(--text-primary);
    font-size: var(--font-size-sm);
    font-weight: 600;
    text-align: center;
    transition: var(--transition);
}

.workout-modal-rest-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 2px var(--primary-glow);
}

.workout-modal-empty-state {
    text-align: center;
    padding: 32px 16px;
    color: var(--text-secondary);
}

.workout-modal-empty-icon {
    font-size: var(--font-size-3xl);
    margin-bottom: 12px;
    opacity: 0.3;
}

.workout-modal-empty-text {
    font-size: var(--font-size-sm);
    margin-bottom: 16px;
}

.workout-modal-navigation {
    display: flex;
    justify-content: space-between;
    margin-top: 24px;
    padding-top: 16px;
    border-top: 1px solid var(--border);
}

.workout-modal-nav-btn {
    padding: 10px 20px;
    border: none;
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
}

.workout-modal-nav-btn.prev {
    background: var(--card-bg);
    color: var(--text-primary);
    border: 1px solid var(--border);
}

.workout-modal-nav-btn.next {
    background: var(--gradient-primary);
    color: white;
}

.workout-modal-nav-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.workout-modal-nav-btn.prev:hover {
    border-color: var(--primary);
}

.workout-modal-nav-btn.next:hover {
    box-shadow: var(--shadow-primary);
}

/* ==================== MODAL SETTINGS - SECTION MANQUANTE ==================== */
.settings-modal-section {
    margin-bottom: 24px;
}

.settings-modal-section-title {
    font-size: var(--font-size-base);
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 16px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border);
}

.settings-modal-option {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid var(--border);
}

.settings-modal-option:last-child {
    border-bottom: none;
}

.settings-modal-option-label {
    font-size: var(--font-size-base);
    color: var(--text-primary);
    font-weight: 500;
}

.settings-modal-option-description {
    font-size: var(--font-size-xs);
    color: var(--text-secondary);
    margin-top: 2px;
}

.settings-modal-select {
    min-width: 120px;
    padding: 8px 12px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    background: var(--card-bg);
    color: var(--text-primary);
    font-size: var(--font-size-sm);
    appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 8px center;
    background-size: 14px;
    transition: var(--transition);
}

.settings-modal-select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px var(--primary-glow);
}

.settings-modal-number-input {
    width: 80px;
    padding: 8px 12px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    background: var(--card-bg);
    color: var(--text-primary);
    font-size: var(--font-size-sm);
    text-align: center;
    transition: var(--transition);
}

.settings-modal-number-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px var(--primary-glow);
}

.settings-modal-color-picker {
    display: flex;
    gap: 8px;
}

.settings-modal-color-option {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid transparent;
    transition: var(--transition);
}

.settings-modal-color-option:hover {
    transform: scale(1.1);
}

.settings-modal-color-option.selected {
    border-color: var(--text-primary);
    box-shadow: var(--shadow);
}

.settings-modal-backup-section {
    background: var(--border);
    border-radius: var(--radius);
    padding: 16px;
    margin-bottom: 20px;
}

.settings-modal-backup-actions {
    display: flex;
    gap: 12px;
    margin-top: 12px;
}

.settings-modal-backup-btn {
    flex: 1;
    padding: 10px 12px;
    border: none;
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
}

.settings-modal-backup-btn.export {
    background: var(--gradient-primary);
    color: white;
}

.settings-modal-backup-btn.import {
    background: var(--card-bg);
    color: var(--text-primary);
    border: 1px solid var(--border);
}

.settings-modal-backup-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.settings-modal-backup-btn.export:hover {
    box-shadow: var(--shadow-primary);
}

.settings-modal-backup-btn.import:hover {
    border-color: var(--primary);
}

.settings-modal-danger-section {
    background: rgba(220, 38, 38, 0.1);
    border: 1px solid var(--danger);
    border-radius: var(--radius);
    padding: 16px;
    margin-bottom: 20px;
}

.settings-modal-danger-title {
    font-size: var(--font-size-sm);
    font-weight: 700;
    color: var(--danger);
    margin-bottom: 8px;
}

.settings-modal-danger-description {
    font-size: var(--font-size-xs);
    color: var(--text-secondary);
    margin-bottom: 12px;
    line-height: 1.4;
}

.settings-modal-danger-btn {
    padding: 10px 20px;
    background: var(--gradient-danger);
    color: white;
    border: none;
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
}

.settings-modal-danger-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-danger);
}

/* ==================== MODAL CONFIRMATION - SECTION MANQUANTE ==================== */
.confirmation-modal-content {
    text-align: center;
    padding: 8px 0;
}

.confirmation-modal-icon {
    width: 64px;
    height: 64px;
    background: var(--gradient-primary);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 16px;
    font-size: var(--font-size-2xl);
}

.confirmation-modal-title {
    font-size: var(--font-size-xl);
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 8px;
}

.confirmation-modal-message {
    font-size: var(--font-size-base);
    color: var(--text-secondary);
    margin-bottom: 24px;
    line-height: 1.5;
}

.confirmation-modal-actions {
    display: flex;
    gap: 12px;
    justify-content: center;
}

.confirmation-modal-btn {
    padding: 12px 24px;
    border: none;
    border-radius: var(--radius);
    font-size: var(--font-size-base);
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    min-width: 120px;
}

.confirmation-modal-btn.cancel {
    background: var(--card-bg);
    color: var(--text-primary);
    border: 1px solid var(--border);
}

.confirmation-modal-btn.confirm {
    background: var(--gradient-primary);
    color: white;
}

.confirmation-modal-btn.danger {
    background: var(--gradient-danger);
    color: white;
}

.confirmation-modal-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.confirmation-modal-btn.cancel:hover {
    border-color: var(--primary);
}

.confirmation-modal-btn.confirm:hover {
    box-shadow: var(--shadow-primary);
}

.confirmation-modal-btn.danger:hover {
    box-shadow: var(--shadow-danger);
}

/* ==================== MODAL NOTES - SECTION MANQUANTE ==================== */
.notes-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--border);
}

.notes-modal-title {
    font-size: var(--font-size-lg);
    font-weight: 700;
    color: var(--text-primary);
}

.notes-modal-date {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
}

.notes-modal-textarea {
    width: 100%;
    min-height: 200px;
    padding: 16px;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--card-bg);
    color: var(--text-primary);
    font-size: var(--font-size-base);
    resize: vertical;
    transition: var(--transition);
    font-family: inherit;
    line-height: 1.5;
}

.notes-modal-textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px var(--primary-glow);
}

.notes-modal-toolbar {
    display: flex;
    gap: 8px;
    margin-top: 12px;
    padding: 12px;
    background: var(--border);
    border-radius: var(--radius-sm);
}

.notes-modal-toolbar-btn {
    background: var(--card-bg);
    border: 1px solid var(--border);
    color: var(--text-secondary);
    width: 36px;
    height: 36px;
    border-radius: var(--radius-xs);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: var(--transition);
    font-size: var(--font-size-base);
}

.notes-modal-toolbar-btn:hover {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.notes-modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    margin-top: 20px;
    padding-top: 16px;
    border-top: 1px solid var(--border);
}

/* ==================== MODAL STATISTICS - SECTION MANQUANTE ==================== */
.stats-modal-period-selector {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
}

.stats-modal-period-btn {
    flex: 1;
    padding: 10px;
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text-primary);
    font-size: var(--font-size-sm);
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    text-align: center;
}

.stats-modal-period-btn.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.stats-modal-period-btn:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
}

.stats-modal-chart-container {
    height: 250px;
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    margin-bottom: 20px;
    position: relative;
    overflow: hidden;
}

.stats-modal-metrics {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-bottom: 20px;
}

.stats-modal-metric {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 16px;
    text-align: center;
}

.stats-modal-metric-value {
    font-size: var(--font-size-2xl);
    font-weight: 800;
    color: var(--primary);
    margin-bottom: 4px;
}

.stats-modal-metric-label {
    font-size: var(--font-size-xs);
    color: var(--text-secondary);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.stats-modal-trend {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: var(--font-size-xs);
    font-weight: 600;
    margin-top: 4px;
}

.stats-modal-trend.positive {
    color: var(--success);
}

.stats-modal-trend.negative {
    color: var(--danger);
}

/* ==================== MODAL PROFILE EDIT - SECTION MANQUANTE ==================== */
.profile-modal-avatar-section {
    text-align: center;
    margin-bottom: 24px;
}

.profile-modal-avatar-preview {
    width: 80px;
    height: 80px;
    background: var(--gradient-primary);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: var(--font-size-2xl);
    margin: 0 auto 12px;
    cursor: pointer;
    transition: var(--transition);
    position: relative;
    overflow: hidden;
}

.profile-modal-avatar-preview:hover {
    transform: scale(1.05);
}

.profile-modal-avatar-edit {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: var(--transition);
}

.profile-modal-avatar-preview:hover .profile-modal-avatar-edit {
    opacity: 1;
}

.profile-modal-form-row {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-bottom: 16px;
}

.profile-modal-input-wrapper {
    margin-bottom: 16px;
}

.profile-modal-label {
    display: block;
    font-size: var(--font-size-sm);
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 8px;
}

.profile-modal-input {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    background: var(--card-bg);
    color: var(--text-primary);
    font-size: var(--font-size-base);
    transition: var(--transition);
}

.profile-modal-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px var(--primary-glow);
}

.profile-modal-select-wrapper {
    position: relative;
}

.profile-modal-select {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    background: var(--card-bg);
    color: var(--text-primary);
    font-size: var(--font-size-base);
    appearance: none;
    transition: var(--transition);
}

.profile-modal-select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px var(--primary-glow);
}

.profile-modal-goals-section {
    margin-bottom: 24px;
}

.profile-modal-goals-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
}

.profile-modal-goal {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 12px;
    text-align: center;
    cursor: pointer;
    transition: var(--transition);
}

.profile-modal-goal:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.profile-modal-goal.selected {
    background: var(--primary-glow);
    border-color: var(--primary);
    color: var(--primary);
    font-weight: 600;
}

.profile-modal-goal-icon {
    font-size: var(--font-size-lg);
    margin-bottom: 8px;
}

.profile-modal-goal-label {
    font-size: var(--font-size-sm);
    font-weight: 500;
}

/* ==================== RESPONSIVE MODALS ==================== */
@media (max-width: 480px) {
    .modal-content {
        width: 95%;
        padding: 20px;
        margin: 10px;
    }
    
    .modal-grid {
        grid-template-columns: 1fr;
    }
    
    .workout-modal-steps {
        flex-direction: column;
        gap: 16px;
    }
    
    .workout-modal-steps::before {
        display: none;
    }
    
    .workout-modal-step {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .workout-modal-step-circle {
        margin: 0;
        flex-shrink: 0;
    }
    
    .workout-modal-step-label {
        text-align: left;
        flex: 1;
    }
    
    .profile-modal-form-row {
        grid-template-columns: 1fr;
        gap: 16px;
    }
    
    .stats-modal-metrics {
        grid-template-columns: 1fr;
    }
    
    .confirmation-modal-actions {
        flex-direction: column;
        gap: 8px;
    }
    
    .confirmation-modal-btn {
        width: 100%;
        min-width: auto;
    }
    
    .modal-footer {
        flex-direction: column;
        gap: 8px;
    }
    
    .modal-footer-btn {
        width: 100%;
    }
}

/* ==================== DARK MODE MODALS ==================== */
.dark-mode .modal-content {
    background: var(--card-bg);
    border-color: var(--border);
}

.dark-mode .modal-header {
    border-bottom-color: var(--border);
}

.dark-mode .modal-section-title {
    color: var(--text-secondary);
}

.dark-mode .modal-grid-item,
.dark-mode .modal-list-item,
.dark-mode .modal-input,
.dark-mode .modal-textarea,
.dark-mode .modal-select,
.dark-mode .modal-radio-label,
.dark-mode .workout-modal-exercise-item,
.dark-mode .workout-modal-set-input,
.dark-mode .workout-modal-rest-input,
.dark-mode .settings-modal-select,
.dark-mode .settings-modal-number-input,
.dark-mode .profile-modal-input,
.dark-mode .profile-modal-select,
.dark-mode .notes-modal-textarea {
    background: var(--bg-secondary);
    border-color: var(--border);
    color: var(--text-primary);
}

.dark-mode .modal-grid-item:hover,
.dark-mode .modal-list-item:hover,
.dark-mode .modal-radio-label:hover,
.dark-mode .workout-modal-exercise-item:hover,
.dark-mode .profile-modal-goal:hover {
    border-color: var(--primary);
}

.dark-mode .modal-list-item.selected {
    background: var(--primary-glow);
}

.dark-mode .modal-footer,
.dark-mode .workout-modal-navigation,
.dark-mode .notes-modal-footer {
    border-top-color: var(--border);
}

.dark-mode .settings-modal-backup-section {
    background: var(--bg-tertiary);
}

.dark-mode .notes-modal-toolbar {
    background: var(--bg-tertiary);
}

.dark-mode .notes-modal-toolbar-btn {
    background: var(--bg-secondary);
}

/* ==================== ANIMATIONS POUR MODALS ==================== */
@keyframes modalScaleIn {
    from {
        opacity: 0;
        transform: scale(0.9) translateY(20px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

.modal-content {
    animation: modalScaleIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* ==================== Z-INDEX GÉRANCE POUR MODALS EMPILÉS ==================== */
.modal.modal-overlay {
    z-index: 2000;
}

.modal.modal-overlay + .modal.modal-overlay {
    z-index: 2001;
}

.modal.modal-overlay + .modal.modal-overlay + .modal.modal-overlay {
    z-index: 2002;
}

/* ==================== MODAL OVERLAY STYLES ==================== */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
}

.modal-overlay .modal-content {
    position: relative;
    z-index: 2003;
    max-height: calc(100vh - 40px);
    overflow-y: auto;
}

/* ==================== MODAL CLOSE BUTTON ENHANCEMENTS ==================== */
.modal-close-btn {
    position: absolute;
    top: 16px;
    right: 16px;
    width: 32px;
    height: 32px;
    border: none;
    background: var(--card-bg);
    color: var(--text-secondary);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: var(--transition);
    font-size: var(--font-size-lg);
    font-weight: bold;
    z-index: 10;
}

.modal-close-btn:hover {
    background: var(--primary);
    color: white;
    transform: rotate(90deg);
}

/* ==================== MODAL LOADING STATES ==================== */
.modal-loading {
    position: relative;
    pointer-events: none;
    opacity: 0.7;
}

.modal-loading::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.5);
    z-index: 100;
    border-radius: var(--radius);
}

.dark-mode .modal-loading::after {
    background: rgba(0, 0, 0, 0.5);
}

.modal-loading-spinner {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 40px;
    height: 40px;
    border: 3px solid var(--border);
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    z-index: 101;
}

/* ==================== MODAL SUCCESS/ERROR STATES ==================== */
.modal-success-message {
    background: rgba(5, 150, 105, 0.1);
    border: 1px solid var(--success);
    border-radius: var(--radius-sm);
    padding: 12px 16px;
    margin-bottom: 20px;
    color: var(--success);
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
}

.modal-error-message {
    background: rgba(220, 38, 38, 0.1);
    border: 1px solid var(--danger);
    border-radius: var(--radius-sm);
    padding: 12px 16px;
    margin-bottom: 20px;
    color: var(--danger);
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
}

/* Styles pour les cartes de programmes recommandés */
.program-card {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 16px;
    margin-bottom: 12px;
    border: 1px solid var(--border);
    box-shadow: var(--shadow);
    transition: var(--transition);
}

.program-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
    border-color: var(--primary);
}

.program-card h4 {
    font-size: var(--font-size-base);
    font-weight: 700;
    margin-bottom: 8px;
    color: var(--text-primary);
}

.program-card p {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    margin-bottom: 8px;
}

.program-card .program-duration {
    font-size: var(--font-size-xs);
    color: var(--text-tertiary);
    display: flex;
    align-items: center;
    gap: 6px;
}

/* Grille pour exercices favoris */
.favorite-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
}

/* Contour premium pour exercices favoris */
.favorite-item-premium {
    background: var(--card-bg);
    border: 2px solid var(--primary);
    border-radius: var(--radius);
    padding: 12px;
    text-align: center;
    transition: var(--transition);
    position: relative;
    overflow: hidden;
}

.favorite-item-premium:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(37, 99, 235, 0.2);
    border-color: var(--primary-dark);
}

.favorite-item-premium::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(37, 99, 235, 0.1), transparent);
    opacity: 0;
    transition: var(--transition);
}

.favorite-item-premium:hover::before {
    opacity: 1;
}

.favorite-item-name {
    font-weight: 600;
    font-size: var(--font-size-sm);
    color: var(--text-primary);
    margin-bottom: 4px;
    line-height: 1.3;
}

.favorite-item-muscle {
    font-size: var(--font-size-xs);
    color: var(--text-secondary);
    font-weight: 500;
}

/* Classe pour le contour premium */
.premium-border {
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    background: var(--card-bg);
}

.dark-mode .premium-border {
    border-color: var(--border);
    background: var(--card-bg);
}

/* Styles spécifiques pour aliments favoris */
.favorite-food-item {
    background: var(--card-bg);
    border: 2px solid var(--success);
    border-radius: var(--radius);
    padding: 12px;
    text-align: center;
    transition: var(--transition);
    position: relative;
    overflow: hidden;
}

.favorite-food-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(5, 150, 105, 0.2);
    border-color: var(--success-dark);
}

.favorite-food-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(5, 150, 105, 0.1), transparent);
    opacity: 0;
    transition: var(--transition);
}

.favorite-food-item:hover::before {
    opacity: 1;
}

.favorite-food-name {
    font-weight: 600;
    font-size: var(--font-size-sm);
    color: var(--text-primary);
    margin-bottom: 4px;
    line-height: 1.3;
}

.favorite-food-calories {
    font-size: var(--font-size-xs);
    color: var(--text-secondary);
    font-weight: 500;
}

/* Correction pour le détail des séries dans le modal historique */
.history-detail-set {
    background: transparent !important;
    border: 1px solid var(--primary) !important;
    color: var(--text-primary) !important;
}

.dark-mode .history-detail-set {
    background: transparent !important;
    border: 1px solid var(--primary) !important;
    color: var(--text-primary) !important;
}

/* Nouveau design pour repas du jour */
.meal-item-improved {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 16px;
    border: 1px solid var(--border);
    box-shadow: var(--shadow);
    transition: var(--transition);
    position: relative;
    overflow: hidden;
}

.meal-item-improved::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--gradient-success);
}

.meal-item-improved:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
    border-color: var(--success);
}

.meal-header-improved {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 16px;
}

.meal-title-improved {
    font-weight: 700;
    font-size: var(--font-size-base);
    color: var(--text-primary);
}

.meal-type-badge-improved {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: var(--font-size-xs);
    font-weight: 600;
    background: var(--gradient-success);
    color: white;
}

.meal-calories-improved {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    font-weight: 500;
    margin-bottom: 16px;
}

.meal-macros-improved {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    margin-bottom: 16px;
}

.meal-macro-improved {
    text-align: center;
    padding: 12px 8px;
    background: var(--card-bg);
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    transition: var(--transition);
}

.meal-macro-improved:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
}

.meal-macro-value-improved {
    font-weight: 700;
    font-size: var(--font-size-base);
    margin-bottom: 4px;
}

.meal-macro-label-improved {
    font-size: var(--font-size-xs);
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.protein-macro .meal-macro-value-improved {
    color: var(--danger);
}

.carbs-macro .meal-macro-value-improved {
    color: var(--success);
}

.fat-macro .meal-macro-value-improved {
    color: var(--warning);
}

.calories-macro .meal-macro-value-improved {
    color: var(--primary);
}

.meal-actions-improved {
    display: flex;
    gap: 10px;
    margin-top: 16px;
}

.meal-actions-improved .action-btn {
    flex: 1;
    padding: 10px 12px;
    font-size: var(--font-size-sm);
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    font-weight: 600;
}

.meal-actions-improved .action-btn:nth-child(1) {
    background: var(--primary);
    color: white;
    border: none;
}

.meal-actions-improved .action-btn:nth-child(2) {
    background: var(--danger);
    color: white;
    border: none;
}

.meal-actions-improved .action-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

/* Forcer les couleurs de texte identiques en mode clair et sombre pour cartes prédéfinies */
.workout-card-luxury .workout-name,
.workout-card-luxury .workout-description,
.workout-card-luxury .workout-duration,
.workout-card-luxury .workout-icon {
    color: white !important;
}

/* Pour les différentes nuances de blanc */
.workout-card-luxury .workout-name {
    color: white !important; /* Blanc pur */
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
}

.workout-card-luxury .workout-description {
    color: rgba(255, 255, 255, 0.9) !important; /* Blanc légèrement transparent */
}

.workout-card-luxury .workout-duration {
    color: rgba(255, 255, 255, 0.8) !important; /* Blanc plus transparent */
}

.workout-card-luxury .workout-duration i {
    color: rgba(255, 255, 255, 0.8) !important; /* Icônes aussi */
}

/* S'assurer que c'est appliqué dans les deux modes */
.dark-mode .workout-card-luxury .workout-name,
.dark-mode .workout-card-luxury .workout-description,
.dark-mode .workout-card-luxury .workout-duration,
.dark-mode .workout-card-luxury .workout-icon {
    color: white !important;
}

.dark-mode .workout-card-luxury .workout-name {
    color: white !important;
}

.dark-mode .workout-card-luxury .workout-description {
    color: rgba(255, 255, 255, 0.9) !important;
}

.dark-mode .workout-card-luxury .workout-duration {
    color: rgba(255, 255, 255, 0.8) !important;
}

/* Bouton ajouter repas réduit */
.btn-add-meal {
    padding: 10px 16px !important;
    font-size: var(--font-size-sm) !important;
    height: 44px !important;
    min-height: 44px !important;
    max-height: 44px !important;
}

/* ==================== NOUVEAUX STYLES POUR HISTORIQUE NUTRITION ==================== */
.nutrition-period {
    display: none;
    animation: fadeIn 0.4s ease;
}

.nutrition-period.active {
    display: block;
}

/* Assurer que toutes les périodes ont la même architecture */
#nutrition-history-day .nutrition-history-item,
#nutrition-history-week .nutrition-history-item,
#nutrition-history-month .nutrition-history-item {
    /* Styles identiques pour toutes les périodes */
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 20px;
    margin: 0 20px 16px;
    border: 1px solid var(--border);
    box-shadow: var(--shadow);
    transition: var(--transition);
    position: relative;
    overflow: hidden;
}

#nutrition-history-day .nutrition-history-item::before,
#nutrition-history-week .nutrition-history-item::before,
#nutrition-history-month .nutrition-history-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--gradient-success);
}

/* Style des boutons de période */
.history-nav-btn {
    transition: all 0.3s ease;
}

.history-nav-btn.active {
    background: var(--gradient-primary);
    color: white;
    border-color: var(--primary);
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

/* ==================== ANIMATIONS POUR RETOUR NUTRITION ==================== */
@keyframes modalSlideOutToLeft {
    0% {
        transform: translateX(0) scale(1);
        opacity: 1;
    }
    50% {
        transform: translateX(-20px) scale(0.95);
        opacity: 0.7;
    }
    100% {
        transform: translateX(-100%) scale(0.9);
        opacity: 0;
    }
}

@keyframes nutritionPageSlideIn {
    0% {
        opacity: 0;
        transform: translateX(100%);
    }
    70% {
        opacity: 0.8;
        transform: translateX(-10px);
    }
    100% {
        opacity: 1;
        transform: translateX(0);
    }
}

@keyframes buttonLoadingPulse {
    0%, 100% {
        opacity: 1;
        transform: scale(1);
    }
    50% {
        opacity: 0.8;
        transform: scale(0.98);
    }
}

/* Classes d'animation */
.modal-exit-to-nutrition {
    animation: modalSlideOutToLeft 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards !important;
}

.nutrition-screen-enter {
    animation: nutritionPageSlideIn 0.6s cubic-bezier(0.4, 0, 0.2, 1) 0.3s both !important;
}

.save-button-loading {
    animation: buttonLoadingPulse 1.5s ease-in-out infinite;
}

/* Styles pour le bouton de sauvegarde avec état */
#save-meal-button {
    position: relative;
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

#save-meal-button:active {
    transform: scale(0.97);
}

#save-meal-button:disabled {
    opacity: 0.7;
    cursor: not-allowed;
}

.save-button-text, .save-button-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.3s ease;
}

.save-button-loading i {
    font-size: 14px;
}

/* État de chargement du bouton */
#save-meal-button.loading {
    background: linear-gradient(135deg, #047857, #059669) !important;
}

/* Overlay pour modal pendant l'animation de sortie */
#add-meal-modal.modal-exit-to-nutrition .modal-content {
    position: relative;
    z-index: 2002;
}

/* Assurer que la page Nutrition soit visible */
#nutrition-screen.nutrition-screen-enter {
    position: relative;
    z-index: 1;
}

/* ==================== ANIMATIONS POUR RETOUR SÉANCES ==================== */
@keyframes modalSlideOutToWorkouts {
    0% {
        transform: translateX(0) scale(1);
        opacity: 1;
    }
    50% {
        transform: translateX(-15px) scale(0.96);
        opacity: 0.8;
    }
    100% {
        transform: translateX(-100%) scale(0.92);
        opacity: 0;
    }
}

@keyframes workoutsPageSlideIn {
    0% {
        opacity: 0;
        transform: translateX(80%) scale(0.95);
    }
    60% {
        opacity: 0.9;
        transform: translateX(-5px) scale(1.02);
    }
    100% {
        opacity: 1;
        transform: translateX(0) scale(1);
    }
}

@keyframes workoutButtonSuccess {
    0% {
        background: linear-gradient(135deg, #059669, #047857);
        transform: scale(1);
    }
    50% {
        background: linear-gradient(135deg, #047857, #10B981);
        transform: scale(0.98);
        box-shadow: 0 0 20px rgba(5, 150, 105, 0.3);
    }
    100% {
        background: linear-gradient(135deg, #059669, #047857);
        transform: scale(1);
    }
}

/* Classes d'animation spécifiques aux séances */
.modal-exit-to-workouts {
    animation: modalSlideOutToWorkouts 0.55s cubic-bezier(0.34, 1.56, 0.64, 1) forwards !important;
}

.workouts-screen-enter {
    animation: workoutsPageSlideIn 0.65s cubic-bezier(0.34, 1.56, 0.64, 1) 0.25s both !important;
}

.save-workout-loading {
    animation: buttonLoadingPulse 1.4s ease-in-out infinite;
}

/* Styles pour le bouton de sauvegarde de séance */
#save-workout-button {
    position: relative;
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
}

#save-workout-button:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(37, 99, 235, 0.25);
}

#save-workout-button:active:not(:disabled) {
    transform: scale(0.97);
}

#save-workout-button:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none !important;
}

#save-workout-button.success-animation {
    animation: workoutButtonSuccess 0.8s ease-in-out;
}

.save-workout-text, .save-workout-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.3s ease;
    font-weight: 600;
}

.save-workout-loading i {
    font-size: 14px;
    color: rgba(255, 255, 255, 0.9);
}

/* Effet de brillance sur le bouton pendant le chargement */
#save-workout-button.loading::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 255, 255, 0.2),
        transparent
    );
    animation: shimmer 1.5s infinite;
}

/* Overlay pour modal de séance pendant l'animation */
#create-workout-modal.modal-exit-to-workouts .modal-content {
    position: relative;
    z-index: 2002;
    transform-origin: center center;
}

/* Style pour la page Séances quand elle apparaît */
#workouts-screen.workouts-screen-enter {
    position: relative;
    z-index: 1;
    transform-origin: center center;
}

/* Badge de nouvelle séance (optionnel) */
.new-workout-badge {
    position: absolute;
    top: -8px;
    right: -8px;
    background: linear-gradient(135deg, #DC2626, #EF4444);
    color: white;
    font-size: 10px;
    font-weight: 800;
    padding: 4px 8px;
    border-radius: 12px;
    animation: pulse-glow 1.5s infinite;
    z-index: 10;
}

/* ==================== CONTROLES ENTRAÎNEMENT ACTIF - NOUVEAU DESIGN ==================== */
.workout-controls-container {
    display: flex;
    flex-direction: column;
    gap: 14px;
    padding: 20px;
    margin: 20px 20px 90px; /* 90px pour laisser de la place à la navbar */
    background: var(--card-bg);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border);
    box-shadow: var(--shadow-xl);
    position: relative;
}

/* Style commun pour les deux boutons */
.workout-action-btn {
    width: 100%;
    padding: 18px 24px;
    border-radius: var(--radius);
    font-size: var(--font-size-base);
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    position: relative;
    overflow: hidden;
    border: none;
    min-height: 58px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Bouton Ajouter un exercice - Style spécifique */
.add-exercise-action-btn {
    background: var(--gradient-primary);
    color: white;
    box-shadow: 0 6px 20px rgba(37, 99, 235, 0.25);
    order: 1;
}

.add-exercise-action-btn:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 30px rgba(37, 99, 235, 0.35);
    background: linear-gradient(135deg, var(--primary-light), var(--primary));
}

.add-exercise-action-btn:active {
    transform: translateY(-1px) scale(0.99);
    box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
}

/* Bouton Terminer l'entraînement - Style spécifique */
.finish-workout-action-btn {
    background: var(--gradient-success);
    color: white;
    box-shadow: 0 6px 20px rgba(5, 150, 105, 0.25);
    order: 2;
    position: relative;
}

.finish-workout-action-btn:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 30px rgba(5, 150, 105, 0.35);
    background: linear-gradient(135deg, var(--success-light), var(--success));
}

.finish-workout-action-btn:active {
    transform: translateY(-1px) scale(0.99);
    box-shadow: 0 4px 15px rgba(5, 150, 105, 0.3);
}

/* Animation de pulsation pour Terminer l'entraînement */
@keyframes finishButtonGlow {
    0%, 100% {
        box-shadow: 0 6px 20px rgba(5, 150, 105, 0.25);
    }
    50% {
        box-shadow: 0 6px 25px rgba(5, 150, 105, 0.4), 0 0 15px rgba(5, 150, 105, 0.2);
    }
}

.finish-workout-action-btn {
    animation: finishButtonGlow 3s ease-in-out infinite;
}

/* Effet de brillance au survol */
.workout-action-btn::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 255, 255, 0.15),
        transparent
    );
    transition: 0.6s ease;
}

.workout-action-btn:hover::after {
    left: 100%;
}

/* Styles pour le texte et icônes */
.workout-action-btn i {
    font-size: 18px;
    transition: transform 0.3s ease;
}

.workout-action-btn:hover i {
    transform: scale(1.1);
}

.add-exercise-text, .complete-workout-text {
    font-weight: 700;
}

.complete-workout-loading {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
}

/* États désactivés */
.workout-action-btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none !important;
    box-shadow: none !important;
    animation: none !important;
}

/* Animation quand on termine */
.finish-workout-action-btn.ending {
    animation: workoutEndingSuccess 1s ease-in-out;
}

@keyframes workoutEndingSuccess {
    0% {
        transform: scale(1);
        background: var(--gradient-success);
    }
    25% {
        transform: scale(1.05);
        background: linear-gradient(135deg, #10B981, #059669);
    }
    50% {
        transform: scale(0.98);
        background: linear-gradient(135deg, #059669, #047857);
    }
    75% {
        transform: scale(1.02);
        background: linear-gradient(135deg, #047857, #10B981);
    }
    100% {
        transform: scale(1);
        background: var(--gradient-success);
    }
}

/* Responsive pour petits écrans */
@media (max-width: 380px) {
    .workout-controls-container {
        padding: 16px;
        margin: 16px 16px 85px;
        border-radius: var(--radius);
        gap: 12px;
    }
    
    .workout-action-btn {
        padding: 16px 20px;
        font-size: var(--font-size-sm);
        min-height: 52px;
        letter-spacing: 0.3px;
    }
    
    .workout-action-btn i {
        font-size: 16px;
    }
    
    .add-exercise-text, .complete-workout-text {
        font-size: var(--font-size-sm);
    }
}

/* Pour les écrans moyens et grands */
@media (min-width: 768px) {
    .workout-controls-container {
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
        border-radius: var(--radius-xl);
    }
}

/* S'assurer que les textes sont bien alignés */
.workout-action-btn span {
    display: flex;
    align-items: center;
    gap: 8px;
}

/* Correction pour éviter que le bouton existant n'interfère */
#complete-workout-button.btn {
    display: none; /* Cache l'ancien style */
}

#complete-workout-button.workout-action-btn {
    display: flex; /* Affiche le nouveau style */
}

/* Style pour le texte de chargement */
.complete-workout-loading i {
    animation: spin 1s linear infinite;
}

/* ==================== STYLES POUR BOUTON AJOUTER REPAS ==================== */
.btn-add-meal {
    background: linear-gradient(135deg, #059669, #047857) !important;
    color: white !important;
    border: none !important;
    padding: 10px 16px !important;
    border-radius: 16px !important;
    font-size: 14px !important;
    font-weight: 600 !important;
    cursor: pointer !important;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06) !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    gap: 8px !important;
    transition: all 0.2s ease !important;
    height: 44px !important;
    min-width: 140px !important;
    letter-spacing: 0.3px !important;
    margin: 0 !important;
}

.btn-add-meal:hover {
    transform: translateY(-2px) !important;
    box-shadow: 0 8px 15px rgba(5, 150, 105, 0.3) !important;
    background: linear-gradient(135deg, #10B981, #059669) !important;
}

.btn-add-meal:active {
    transform: translateY(0) !important;
}

/* ==================== STYLES POUR LES ACTIONS DES REPAS ==================== */
.meal-actions-improved {
    display: flex;
    gap: 8px;
    margin-top: 16px;
}

.meal-actions-improved .action-btn {
    flex: 1;
    padding: 10px 8px;
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    transition: var(--transition);
    border: none;
}

.meal-actions-improved .action-btn i {
    font-size: 12px;
}

.meal-actions-improved .action-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

/* Style spécifique pour le bouton modifier */
.meal-actions-improved .action-btn.modifier-btn {
    background: var(--gradient-primary);
    color: white;
}

.meal-notes {
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px dashed var(--border);
    font-size: 13px;
    color: var(--text-secondary);
    line-height: 1.5;
}

/* Responsive pour petits écrans */
@media (max-width: 380px) {
    .meal-actions-improved {
        flex-direction: column;
        gap: 6px;
    }
    
    .btn-add-meal {
        min-width: 120px;
        padding: 8px 12px !important;
        font-size: 13px !important;
    }
}

/* ==================== BOUTON AJOUTER REPAS COMPACT ==================== */
.btn-add-meal-compact {
    background: linear-gradient(135deg, #059669, #047857) !important;
    color: white !important;
    border: none !important;
    padding: 6px 14px !important;
    border-radius: 30px !important;
    font-size: 13px !important;
    font-weight: 600 !important;
    cursor: pointer !important;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05) !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    gap: 6px !important;
    transition: all 0.2s ease !important;
    height: 32px !important;
    width: auto !important;
    min-width: 0 !important;
    letter-spacing: 0.2px !important;
    white-space: nowrap !important;
}

.btn-add-meal-compact:hover {
    transform: translateY(-1px) !important;
    box-shadow: 0 4px 8px rgba(5, 150, 105, 0.2) !important;
}

.btn-add-meal-compact i {
    font-size: 11px !important;
}

    </style>
</head>
<body>
    <div class="app-container">
        <!-- HEADER -->
        <div class="header">
            <div class="header-left">
                <div class="user-avatar" onclick="showScreen('profile-screen')" id="user-avatar">JD</div>
                <h1 class="app-title">IRON</h1>
            </div>
            <div class="header-actions">
                <button class="icon-btn" onclick="showSettingsModal()" title="Paramètres">
                    <i class="fas fa-cog"></i>
                </button>
                <button class="icon-btn primary" onclick="showCreateWorkoutModal(true)" title="Créer une séance">
                    <i class="fas fa-dumbbell"></i>
                </button>
                <button class="icon-btn success" onclick="showAddMealModal(true)" title="Ajouter un repas">
    		    <i class="fas fa-utensils"></i>
		</button>
                <button class="icon-btn" onclick="toggleTheme()" title="Changer de thème">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </div>
        
        <!-- CONTENU PRINCIPAL -->
        <div class="main-content">
            <!-- ÉCRAN D'ACCUEIL -->
            <div id="home-screen" class="screen active">
                <!-- PROFIL UTILISATEUR - SANS NOM AFFICHÉ -->
<div class="profile-section">
    <div class="profile-header">
        <div class="profile-avatar" id="profile-avatar">JD</div>
        <div class="profile-info">
            <!-- LE NOM N'EST PLUS AFFICHÉ ICI -->
            <p id="profile-level" style="margin-top: 8px; font-size: 15px; color: var(--text-secondary);">Intermédiaire • Maintien</p>
        </div>
    </div>
    <div class="profile-stats">
        <div class="stat-item">
            <div class="stat-value" id="profile-height">180cm</div>
            <div class="stat-label">Taille</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="profile-weight">75kg</div>
            <div class="stat-label">Poids</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="profile-bmi">23.1</div>
            <div class="stat-label">IMC</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="profile-category">Normal</div>
            <div class="stat-label">Catégorie</div>
        </div>
    </div>
    <div class="nutrition-section">
        <div class="nutrition-calories-card">
            <div class="nutrition-calories-value" id="profile-calories">2500 kcal</div>
            <div class="nutrition-calories-label">Besoins caloriques quotidiens</div>
        </div>
        <div class="macros-grid">
            <div class="macro-item">
                <div class="macro-value protein" id="profile-protein">150g</div>
                <div class="macro-label">Protéines</div>
            </div>
            <div class="macro-item">
                <div class="macro-value carbs" id="profile-carbs">300g</div>
                <div class="macro-label">Glucides</div>
            </div>
            <div class="macro-item">
                <div class="macro-value fat" id="profile-fat">70g</div>
                <div class="macro-label">Lipides</div>
            </div>
        </div>
    </div>
</div>
                
                <!-- ENTRAÎNEMENTS RAPIDES -->
                <h2 class="section-title">
                    <i class="fas fa-bolt"></i>
                    Entraînements Rapides
                </h2>
                
                <div class="workout-card" onclick="startPredefinedWorkoutFromHome('fullbody_beginner')">
                    <div class="workout-name">Full Body Débutant</div>
                    <div class="workout-description">Circuit complet pour débutants</div>
                    <div class="workout-duration">
                        <i class="far fa-clock"></i>
                        60 min • 8 exercices
                    </div>
                </div>
                
                <div class="workout-card" onclick="startPredefinedWorkoutFromHome('push_day')">
                    <div class="workout-name">Push Day</div>
                    <div class="workout-description">Pectoraux, Épaules, Triceps</div>
                    <div class="workout-duration">
                        <i class="far fa-clock"></i>
                        75 min • 7 exercices
                    </div>
                </div>
                
                <div class="workout-card" onclick="startPredefinedWorkoutFromHome('pull_day')">
                    <div class="workout-name">Pull Day</div>
                    <div class="workout-description">Dos, Biceps, Arrière épaules</div>
                    <div class="workout-duration">
                        <i class="far fa-clock"></i>
                        75 min • 6 exercices
                    </div>
                </div>

                <div class="workout-card" onclick="startPredefinedWorkoutFromHome('legs_day')">
                    <div class="workout-name">Leg Day</div>
                    <div class="workout-description">Jambes complètes</div>
                    <div class="workout-duration">
                        <i class="far fa-clock"></i>
                        80 min • 8 exercices
                    </div>
                </div>

                <!-- PROGRAMMES RECOMMANDÉS (MASQUÉ) -->
<div style="display: none;">
    <div id="recommended-programs">
        <!-- Programmes générés dynamiquement -->
    </div>
</div>

                <!-- GROUPES MUSCULAIRES -->
                <h2 class="section-title">
                    <i class="fas fa-dumbbell"></i>
                    Groupes Musculaires
                </h2>
                
                <div class="muscle-grid" id="muscle-grid-container">
                    <!-- Généré dynamiquement par loadMuscleGroups() -->
                </div>
            </div>
            
            <!-- ÉCRAN DES EXERCICES -->
            <div id="exercises-screen" class="screen">
                <div class="radio-tabs">
                    <button class="radio-tab active" onclick="showExerciseTab('exercises')">🏋️‍♂️ Exercices</button>
                    <button class="radio-tab" onclick="showExerciseTab('foods')">🥦 Aliments</button>
                </div>
                
                <div id="exercise-tab">
                    <!-- Recherche Avancée Display -->
                    <div class="advanced-search-display" id="advanced-search-display-exercises" style="display: none;">
                        <div class="advanced-search-display-title">Filtres Actifs</div>
                        <div class="advanced-search-display-filters" id="advanced-search-active-filters">
                            <!-- Filtres actifs seront affichés ici -->
                        </div>
                        <div class="advanced-search-display-actions">
                            <button class="btn btn-info" onclick="showAdvancedSearchModal()">
                                <i class="fas fa-filter"></i> Modifier
                            </button>
                            <button class="btn btn-secondary" onclick="clearSearchFilters()">
                                <i class="fas fa-times"></i> Effacer
                            </button>
                        </div>
                    </div>
                    
                    <!-- Boutons d'action -->
                    <div class="delete-all-btn-container">
                        <button class="btn btn-info" onclick="showAdvancedSearchModal()" style="flex: 1;">
                            <i class="fas fa-filter"></i> Recherche Avancée
                        </button>
                        <button class="btn btn-danger" onclick="showDeleteAllExercisesModal()" style="flex: 1;">
                            <i class="fas fa-trash"></i> Tout supprimer
                        </button>
                    </div>
                    
                    <!-- Barre de recherche -->
                    <div class="search-container">
                        <input type="text" class="search-input" placeholder="🔍 Rechercher un exercice..." onkeyup="filterExercises()" id="search-input">
                    </div>
                    
                    <!-- Filtres -->
                    <select class="filter-select" onchange="setMuscleFilter(this.value)" id="muscle-filter">
    <option value="all">Tous les exercices</option>
    <option value="custom">Personnalisés</option>
    <option value="favorites">Favoris</option>
    <!-- Options générées dynamiquement -->
</select>
                    
                    <!-- Bouton créer exercice -->
                    <button class="add-exercise-btn" onclick="showCustomExerciseModal()">
                        <i class="fas fa-plus"></i> Créer un nouvel exercice
                    </button>
                    
                    <!-- Liste des exercices -->
                    <div id="exercises-list">
                        <!-- Liste générée dynamiquement -->
                    </div>
                </div>
                
                <div id="food-tab" class="hidden">
                    <!-- Recherche Avancée Display -->
                    <div class="advanced-search-display" id="advanced-search-display-foods" style="display: none;">
                        <div class="advanced-search-display-title">Filtres Actifs</div>
                        <div class="advanced-search-display-filters" id="advanced-search-active-filters-food">
                            <!-- Filtres actifs seront affichés ici -->
                        </div>
                        <div class="advanced-search-display-actions">
                            <button class="btn btn-info" onclick="showAdvancedSearchModalFood()">
                                <i class="fas fa-filter"></i> Modifier
                            </button>
                            <button class="btn btn-secondary" onclick="clearSearchFiltersFood()">
                                <i class="fas fa-times"></i> Effacer
                            </button>
                        </div>
                    </div>
                    
                    <!-- Boutons d'action -->
                    <div class="delete-all-btn-container">
                        <button class="btn btn-info" onclick="showAdvancedSearchModalFood()" style="flex: 1;">
                            <i class="fas fa-filter"></i> Recherche Avancée
                        </button>
                        <button class="btn btn-danger" onclick="showDeleteAllFoodsModal()" style="flex: 1;">
                            <i class="fas fa-trash"></i> Tout supprimer
                        </button>
                    </div>
                    
                    <!-- Barre de recherche -->
                    <div class="search-container">
                        <input type="text" class="search-input" placeholder="🔍 Rechercher un aliment..." onkeyup="filterFoods()" id="food-search-input">
                    </div>
                    
                    <!-- Filtres -->
                    <select class="filter-select" onchange="setFoodCategoryFilter(this.value)" id="food-category-filter">
    <option value="all">Toutes les catégories</option>
    <option value="personnalisé">Personnalisés</option>
    <option value="halal">Halal</option>
    <option value="favorites">Favoris</option>
    <!-- Options générées dynamiquement -->
</select>
                    
                    <!-- Bouton ajouter aliment -->
                    <button class="add-exercise-btn" onclick="showAddFoodModal()">
                        <i class="fas fa-plus"></i> Ajouter un aliment
                    </button>
                    
                    <!-- Liste des aliments -->
                    <div id="foods-list">
                        <!-- Liste générée dynamiquement -->
                    </div>
                </div>
            </div>
            
            <!-- ÉCRAN DES SÉANCES -->
            <div id="workouts-screen" class="screen">
                <h2 class="section-title">Mes Séances</h2>
                <div id="custom-workouts-list">
                    <!-- Séances personnalisées générées dynamiquement -->
                </div>
                
                <h2 class="section-title" style="margin-top: 30px;">Séances Prédéfinies</h2>
<!-- MODIFICATION: Section exercices favoris -->
<div class="card" style="margin-top: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 style="margin: 0;">⭐ Exercices Favoris</h3>
        <button class="action-btn" onclick="refreshFavoriteExercises()">
            <i class="fas fa-sync-alt"></i> Actualiser
        </button>
    </div>
    <div class="favorite-grid premium-border" id="favorite-exercises-container">
        <!-- Exercices favoris générés dynamiquement -->
    </div>
</div>
                <div id="predefined-workouts-container">
                    <!-- Séances prédéfinies générées dynamiquement -->
                </div>
            </div>
            
            <!-- ÉCRAN PROFIL -->
<div id="profile-screen" class="screen">
    <h2 class="section-title">👤 Mon Profil</h2>
    <div class="card">
        <div class="input-group">
            <div class="input-label">Prénom (pour initiales)</div>
            <input type="text" class="number-input" id="profile-firstname" value="John" oninput="updateAvatarInitials(); calculateNutritionNeeds()">
        </div>
        <div class="input-group" style="margin-top: 14px;">
            <div class="input-label">Nom (pour initiales)</div>
            <input type="text" class="number-input" id="profile-lastname" value="Doe" oninput="updateAvatarInitials()">
        </div>
        
        <!-- NOUVEAUX CHAMPS AJOUTÉS -->
        <div class="input-group" style="margin-top: 14px;">
            <div class="input-label">Sexe</div>
            <select id="profile-gender-input" class="filter-select" onchange="calculateNutritionNeeds()">
                <option value="male">Homme</option>
                <option value="female">Femme</option>
            </select>
        </div>
        
        <div class="input-group" style="margin-top: 14px;">
            <div class="input-label">Âge</div>
            <input type="number" id="profile-age-input" class="number-input" min="15" max="80" value="30" oninput="calculateNutritionNeeds()">
        </div>
        
        <div class="input-group" style="margin-top: 14px;">
            <div class="input-label">Taille (cm)</div>
            <input type="number" class="number-input" id="profile-height-input" value="180" oninput="calculateNutritionNeeds()">
        </div>
        <div class="input-group" style="margin-top: 14px;">
            <div class="input-label">Poids (kg)</div>
            <input type="number" class="number-input" id="profile-weight-input" value="75" oninput="calculateNutritionNeeds()">
        </div>
        
        <div class="input-group" style="margin-top: 14px;">
            <div class="input-label">Bodyfat (%)</div>
            <input type="number" id="profile-bodyfat-input" class="number-input" min="5" max="50" step="0.5" value="20" oninput="calculateNutritionNeeds()">
            <div style="font-size: var(--font-size-xs); color: var(--text-tertiary); margin-top: 4px;">Estimation du pourcentage de graisse corporelle</div>
        </div>
        
        <div class="input-group" style="margin-top: 14px;">
            <div class="input-label">Objectif poids/semaine (kg)</div>
            <input type="number" id="profile-weekly-change-input" class="number-input" min="-1" max="1" step="0.1" value="0" oninput="calculateNutritionNeeds()">
            <div style="font-size: var(--font-size-xs); color: var(--text-tertiary); margin-top: 4px;">Négatif = perte, Positif = prise, 0 = maintien</div>
        </div>
        
        <!-- MASSE MAIGRE CALCULÉE -->
        <div id="profile-lean-mass" class="input-group" style="margin-top: 14px; display: none;">
            <div class="input-label">Masse maigre (kg)</div>
            <div class="number-input" style="background: var(--primary-glow); color: var(--primary); font-weight: 700; cursor: default;" id="lean-mass-value">
                Calcul en cours...
            </div>
            <div style="font-size: var(--font-size-xs); color: var(--text-tertiary); margin-top: 4px;">Poids total moins masse graisseuse</div>
        </div>
        
        <h3 style="margin: 18px 0 10px; color: var(--text-primary); font-size: var(--font-size-base);">⚙️ Paramètres d'entraînement par défaut</h3>
        
        <div class="input-group" style="margin-top: 14px;">
            <div class="input-label">Répétitions par défaut</div>
            <input type="text" class="number-input" id="profile-default-reps" value="10">
        </div>
        <div class="input-group" style="margin-top: 14px;">
            <div class="input-label">Poids par défaut (kg)</div>
            <input type="number" class="number-input" id="profile-default-weight" value="10">
        </div>
        <div class="input-group" style="margin-top: 14px;">
            <div class="input-label">Temps de repos par défaut (secondes)</div>
            <input type="number" class="number-input" id="profile-default-rest" value="60">
        </div>
        <div class="input-group" style="margin-top: 14px;">
            <div class="input-label">Séries par défaut</div>
            <input type="number" class="number-input" id="profile-default-sets" value="3">
        </div>
        
        <div class="input-group" style="margin-top: 14px;">
            <div class="input-label">Niveau</div>
            <select class="filter-select" id="profile-level-input" onchange="calculateNutritionNeeds()">
                <option value="Débutant complet">Débutant complet</option>
                <option value="Débutant">Débutant</option>
                <option value="Intermédiaire débutant">Intermédiaire débutant</option>
                <option value="Intermédiaire" selected>Intermédiaire</option>
                <option value="Intermédiaire avancé">Intermédiaire avancé</option>
                <option value="Avancé">Avancé</option>
                <option value="Expert">Expert</option>
                <option value="Professionnel">Professionnel</option>
            </select>
        </div>
        <div class="input-group" style="margin-top: 14px;">
            <div class="input-label">Type d'entraînement</div>
            <select class="filter-select" id="profile-type-input" onchange="calculateNutritionNeeds()">
                <option value="Force pure">Force pure</option>
                <option value="Force">Force</option>
                <option value="Volume musculaire">Volume musculaire</option>
                <option value="Hypertrophie">Hypertrophie</option>
                <option value="Endurance musculaire">Endurance musculaire</option>
                <option value="Cardio">Cardio</option>
                <option value="Perte de poids">Perte de poids</option>
                <option value="Maintien" selected>Maintien</option>
                <option value="Récupération">Récupération</option>
                <option value="Préparation physique">Préparation physique</option>
            </select>
        </div>
        
        <!-- BOÎTE DE RECOMMANDATIONS -->
        <div id="profile-recommendations" class="recommendations-box" style="display: none; margin-top: 15px; padding: 12px; background: var(--card-bg); border-radius: var(--radius-sm); border-left: 4px solid var(--primary);">
            <div style="display: flex; align-items: flex-start; gap: 10px; margin-bottom: 8px;">
                <div style="color: var(--primary); font-size: var(--font-size-base);">
                    <i class="fas fa-lightbulb"></i>
                </div>
                <div style="font-weight: 700; color: var(--text-primary);">Recommandations</div>
            </div>
            <div id="recommendations-content" style="font-size: var(--font-size-sm); color: var(--text-secondary); line-height: 1.4;">
                <!-- Contenu dynamique des recommandations -->
            </div>
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn btn-success" onclick="saveProfile()" style="flex: 1;">💾 Sauvegarder</button>
            <button class="btn btn-danger" onclick="resetProfile()" style="flex: 1;">🔄 Réinitialiser</button>
        </div>
        
        <!-- Import/Export -->
        <div class="import-export-section" style="margin-top: 20px;">
            <button class="import-export-btn import-btn" onclick="importData()">
                <i class="fas fa-file-import"></i> Importer
            </button>
            <button class="import-export-btn export-btn" onclick="exportData()">
                <i class="fas fa-file-export"></i> Exporter
            </button>
        </div>
    </div>
</div>

            <!-- ÉCRAN HISTORIQUE -->
            <div id="history-screen" class="screen">
                <div class="history-tabs">
                    <div class="history-tab active" onclick="showHistoryTab('workouts')">🏋️‍♂️ Séances</div>
                    <div class="history-tab" onclick="showHistoryTab('nutrition')">🍽️ Nutrition</div>
                </div>
                
                <!-- Historique des séances -->
                <div id="workout-history-tab">
                    <!-- Boutons de vue -->
                    <div class="history-view-toggle">
                        <button class="history-view-toggle-btn active" onclick="showWorkoutHistoryView('list')">
                            <i class="fas fa-list"></i> Liste
                        </button>
                        <button class="history-view-toggle-btn" onclick="showWorkoutHistoryView('evolution')">
                            <i class="fas fa-chart-line"></i> Graphique
                        </button>
                        <button class="history-view-toggle-btn" onclick="showWorkoutHistoryView('exercises')">
                            <i class="fas fa-dumbbell"></i> Exercices
                        </button>
                    </div>
                    
                    <!-- Vue Liste -->
                    <div id="workout-history-list">
                        <div class="component-box">
                            <div class="component-box-title" style="justify-content: space-between;">
                                <span>Historique des Séances</span>
                                <button class="action-btn" onclick="showClearHistoryModal()">
                                    <i class="fas fa-trash"></i> Tout supprimer
                                </button>
                            </div>
                            <div class="component-box-content">
                                <div id="workout-history">
                                    <!-- Historique généré dynamiquement -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Vue Graphique -->
                    <div id="workout-history-evolution" class="hidden">
    <div class="chart-container-premium">
        <div class="chart-title-premium">Évolution des performances</div>
        <div id="evolution-chart" class="chart-wrapper">
            <!-- Graphique généré dynamiquement -->
        </div>
    </div>
</div>

<div id="workout-history-exercises" class="hidden">
    <div class="chart-container-premium">
        <div class="chart-title-premium">Performances par type d'exercice</div>
        <div id="exercises-chart" class="chart-wrapper">
            <!-- Graphique généré dynamiquement -->
        </div>
    </div>
    <div id="exercises-detailed-list" style="margin: 0 20px;">
        <!-- Liste détaillée des exercices -->
    </div>
</div>
                </div>
                
                <!-- Historique nutrition -->
                <div id="nutrition-history-tab" class="hidden">
                    <div class="history-nav-buttons">
                        <button class="history-nav-btn" onclick="showNutritionHistoryView('day', this)">Jour</button>
<button class="history-nav-btn" onclick="showNutritionHistoryView('week', this)">Semaine</button>
<button class="history-nav-btn" onclick="showNutritionHistoryView('month', this)">Mois</button>
                    </div>
                    
                    <div class="component-box">
                        <div class="component-box-title" style="justify-content: space-between;">
                            <span>Historique Nutrition</span>
                            <button class="action-btn" onclick="showClearNutritionHistoryModal()">
                                <i class="fas fa-trash"></i> Tout supprimer
                            </button>
                        </div>
                        <div class="component-box-content">
                            <div id="nutrition-history">
    <!-- Structure initiale VISIBLE pour "jour" -->
    <div id="nutrition-history-day" class="nutrition-period active">
        <!-- L'architecture "jour" sera ici -->
    </div>
    
    <!-- Structure pour "semaine" (cachée initialement) -->
    <div id="nutrition-history-week" class="nutrition-period hidden">
        <!-- Même architecture que "jour" -->
    </div>
    
    <!-- Structure pour "mois" (cachée initialement) -->
    <div id="nutrition-history-month" class="nutrition-period hidden">
        <!-- Même architecture que "jour" -->
    </div>
</div>
                        </div>
                    </div>
                </div>
            </div>
            
<!-- ÉCRAN NUTRITION -->
<div id="nutrition-screen" class="screen">
    <h2 class="section-title">
        <i class="fas fa-apple-alt"></i>
        Suivi Nutrition
    </h2>
    
    <!-- Carte des calories du jour -->
    <div class="nutrition-calories-card">
        <div class="nutrition-calories-value" id="daily-calories">0/2500 kcal</div>
        <div class="nutrition-calories-label">Apport calorique aujourd'hui</div>
        <div id="calories-balance" class="calories-balance positive">+2500 kcal restantes</div>
        <div class="calories-progress">
            <div class="progress-bar">
                <div class="progress-fill" id="calories-progress" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <!-- Statistiques macros - AVEC barres de progression et pourcentages -->
<div class="card">
    <h3>Macronutriments du jour</h3>
    <div class="macros-grid">
        <div class="macro-item">
            <div class="macro-value protein" id="daily-protein">0g</div>
            <div class="macro-label">Protéines</div>
            <div class="macro-target" id="protein-target">/150g</div>
            <div id="protein-remaining" class="macro-remaining positive">+150g restants</div>
        </div>
        <div class="macro-item">
            <div class="macro-value carbs" id="daily-carbs">0g</div>
            <div class="macro-label">Glucides</div>
            <div class="macro-target" id="carbs-target">/300g</div>
            <div id="carbs-remaining" class="macro-remaining positive">+300g restants</div>
        </div>
        <div class="macro-item">
            <div class="macro-value fat" id="daily-fat">0g</div>
            <div class="macro-label">Lipides</div>
            <div class="macro-target" id="fat-target">/70g</div>
            <div id="fat-remaining" class="macro-remaining positive">+70g restants</div>
        </div>
    </div>
    
    <!-- AJOUT: Barres de progression individuelles pour les macros -->
    <div style="margin-top: 20px; display: flex; flex-direction: column; gap: 12px;">
        <!-- Protéines -->
        <div>
            <div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px;">
                <span style="color: #EF4444; font-weight: 600;">Protéines</span>
                <span style="color: var(--text-secondary);" id="protein-percentage">0%</span>
            </div>
            <div style="height: 4px; background: var(--border); border-radius: 2px; overflow: hidden;">
                <div id="protein-progress" style="width: 0%; height: 100%; background: #EF4444; border-radius: 2px; transition: width 0.3s ease;"></div>
            </div>
        </div>
        
        <!-- Glucides -->
        <div>
            <div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px;">
                <span style="color: #10B981; font-weight: 600;">Glucides</span>
                <span style="color: var(--text-secondary);" id="carbs-percentage">0%</span>
            </div>
            <div style="height: 4px; background: var(--border); border-radius: 2px; overflow: hidden;">
                <div id="carbs-progress" style="width: 0%; height: 100%; background: #10B981; border-radius: 2px; transition: width 0.3s ease;"></div>
            </div>
        </div>
        
        <!-- Lipides -->
        <div>
            <div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px;">
                <span style="color: #F59E0B; font-weight: 600;">Lipides</span>
                <span style="color: var(--text-secondary);" id="fat-percentage">0%</span>
            </div>
            <div style="height: 4px; background: var(--border); border-radius: 2px; overflow: hidden;">
                <div id="fat-progress" style="width: 0%; height: 100%; background: #F59E0B; border-radius: 2px; transition: width 0.3s ease;"></div>
            </div>
        </div>
    </div>
</div>

    <!-- Repas de la journée -->
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px;">
    <h3 style="margin: 0; font-size: 18px;">🍽️ Repas du jour</h3>
    <button onclick="showAddMealModal(false)" class="btn-add-meal-compact">
        <i class="fas fa-plus"></i>
        Ajouter repas
    </button>
</div>
        <div class="meals-list-container" id="meals-list">
            <!-- Repas générés dynamiquement -->
        </div>
    </div>

    <!-- Aliments fréquents -->
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin: 0;">⭐ Aliments Favoris</h3>
            <button class="action-btn" onclick="refreshFavoriteFoods()">
                <i class="fas fa-sync-alt"></i> Actualiser
            </button>
        </div>
        <div class="favorite-grid premium-border" id="favorite-foods-container">
            <!-- Aliments favoris générés dynamiquement -->
        </div>
    </div>
</div>
            
            <!-- ÉCRAN D'ENTRAÎNEMENT ACTIF -->
            <div id="active-workout-screen" class="screen">
                <div class="workout-header">
                    <h2 id="active-workout-name">Full Body</h2>
                </div>
                
                <div class="workout-timer-container">
                    <div class="workout-stat-side">
                        <div class="workout-stat-side-value" id="completed-sets">0</div>
                        <div class="workout-stat-side-label">Séries</div>
                    </div>
                    <div class="workout-timer" id="workout-timer">00:00:00</div>
                    <div class="workout-stat-side">
                        <div class="workout-stat-side-value" id="total-weight">0kg</div>
                        <div class="workout-stat-side-label">Poids Total</div>
                    </div>
                </div>
                
                <div class="workout-container" id="workout-exercises-container">
                    <!-- Exercices générés dynamiquement -->
                </div>
                
                <div class="workout-controls-container">
    <!-- 1. BOUTON AJOUTER UN EXERCICE (EN HAUT) -->
    <button class="workout-action-btn add-exercise-action-btn" onclick="addExerciseToWorkout()" id="add-exercise-workout-btn">
        <i class="fas fa-plus"></i>
        <span class="add-exercise-text">Ajouter un exercice</span>
    </button>
    
    <!-- 2. BOUTON TERMINER L'ENTRAÎNEMENT (EN BAS - AVEC FONCTION EXISTANTE) -->
    <button class="workout-action-btn finish-workout-action-btn" onclick="showSaveDataModal()" id="finish-workout-btn">
        <i class="fas fa-flag-checkered"></i>
        <span class="finish-workout-text">Terminer l'entraînement</span>
    </button>
</div>
            </div>
        </div>

        <!-- TIMER -->
        <div class="timer-container" id="timer-container">
            <div class="timer-display" id="timer-display">01:30</div>
            <div class="timer-progress-container">
                <div class="timer-progress-bar" id="timer-progress-bar"></div>
            </div>
            <div class="timer-controls">
                <button class="timer-btn timer-start" id="timer-toggle-btn" onclick="toggleTimer()">Démarrer</button>
                <button class="timer-btn timer-adjust" onclick="adjustTimer(-15)">-15s</button>
                <button class="timer-btn timer-adjust" onclick="adjustTimer(15)">+15s</button>
                <button class="timer-btn timer-close" onclick="closeTimerWithSupersetCheck()">Fermer</button>
            </div>
        </div>
    </div>

    <!-- LOADING INDICATOR -->
    <div class="loading-indicator" id="loading-indicator">
        <div class="loading-spinner"></div>
    </div>

    <!-- NAVBAR -->
    <div class="navbar-container">
        <div class="navbar">
            <div class="nav-item active" onclick="showScreen('home-screen')">
                <div class="nav-icon"><i class="fas fa-home"></i></div>
                <div class="nav-text">Accueil</div>
            </div>
            <div class="nav-item" onclick="showScreen('workouts-screen')">
                <div class="nav-icon"><i class="fas fa-dumbbell"></i></div>
                <div class="nav-text">Séances</div>
            </div>
            <div class="nav-item" onclick="showScreen('exercises-screen')">
                <div class="nav-icon"><i class="fas fa-running"></i></div>
                <div class="nav-text">Exercices</div>
            </div>
                <div class="nav-item" onclick="showScreen('nutrition-screen')">
                <div class="nav-icon"><i class="fas fa-apple-alt"></i></div>
                <div class="nav-text">Nutrition</div>
            </div>
		<div class="nav-item" onclick="showScreen('history-screen')">
                <div class="nav-icon"><i class="fas fa-chart-line"></i></div>
                <div class="nav-text">Historique</div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <!-- MODAL CRÉATION SÉANCE - AMÉLIORÉ -->
    <div class="modal" id="create-workout-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Créer une séance</h3>
                <button class="modal-close" onclick="hideModal('create-workout-modal'); resetCreateWorkoutModal()">×</button>
            </div>
            <div class="modal-body">
                <input type="text" id="workout-name" placeholder="Nom de la séance" class="number-input" style="width: 100%; margin-bottom: 14px;">
                
                <div class="food-search-btn-container">
                    <button class="btn food-search-btn" onclick="showExerciseSelectionForCreate()">🏃 Choisir exercice</button>
                    <button class="btn food-search-btn btn-success" onclick="showCustomExerciseModalForCreate()">Créer exercice</button>
                </div>
                
                <div id="workout-exercises-selection">
                    <!-- Exercices à ajouter - Afficher l'ordre -->
                </div>
                
                <button class="btn btn-success" onclick="saveCustomWorkoutAndReturnToWorkouts()" 
        style="width: 100%; margin-top: 14px; margin-bottom: 10px;"
        id="save-workout-button">
    <span class="save-workout-text">💾 Sauvegarder la séance</span>
    <span class="save-workout-loading" style="display: none;">
        <i class="fas fa-spinner fa-spin"></i> Création en cours...
    </span>
</button>
            </div>
        </div>
    </div>

    <!-- MODAL MODIFICATION SÉANCE - AMÉLIORÉ -->
    <div class="modal" id="edit-workout-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">✏️ Modifier la séance</h3>
                <button class="modal-close" onclick="hideModal('edit-workout-modal')">×</button>
            </div>
            <div class="modal-body">
                <input type="text" id="edit-workout-name" placeholder="Nom de la séance" class="number-input" style="width: 100%; margin-bottom: 14px;">
                
                <div class="food-search-btn-container">
                    <button class="btn food-search-btn" onclick="showExerciseSelectionForEdit()">🏃 Choisir exercice</button>
                    <button class="btn food-search-btn btn-success" onclick="showCustomExerciseModalForEdit()">Créer exercice</button>
                </div>
                
                <div id="edit-workout-exercises-selection">
                    <!-- Exercices à modifier - Avec boutons de réorganisation -->
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 14px; margin-bottom: 10px;">
                    <button class="btn btn-success" onclick="saveEditedWorkout()" style="flex: 1;">💾 Sauvegarder</button>
                    <button class="btn btn-warning" onclick="duplicateWorkout()" style="flex: 1;">📋 Dupliquer</button>
                    <button class="btn btn-danger" onclick="deleteEditedWorkout()" style="flex: 1;">🗑️ Supprimer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL SÉLECTION EXERCICE -->
    <div class="modal" id="select-exercise-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">🏃 Choisir un exercice</h3>
                <button class="modal-close" onclick="hideModal('select-exercise-modal')">×</button>
            </div>
            <div class="modal-body">
                <input type="text" class="number-input" placeholder="🔍 Rechercher un exercice..." onkeyup="filterExerciseSelection(this.value)" style="width: 100%; margin-bottom: 14px;">
                <select class="filter-select" onchange="filterExerciseSelectionByMuscle(this.value)" id="exercise-filter">
                    <option value="all">Tous les groupes musculaires</option>
                    <!-- Options générées dynamiquement -->
                </select>
                <div id="exercise-selection-list" style="max-height: 300px; overflow-y: auto;">
                    <!-- Liste des exercices pour sélection -->
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL CRÉATION EXERCICE PERSONNALISÉ - AMÉLIORÉ -->
    <div class="modal" id="custom-exercise-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">➕ Créer un exercice</h3>
                <button class="modal-close" onclick="hideModal('custom-exercise-modal')">×</button>
            </div>
            <div class="modal-body">
                <div class="input-group" style="margin-bottom: 14px;">
                    <div class="input-label">Nom de l'exercice</div>
                    <input type="text" class="number-input" id="custom-exercise-name" placeholder="Ex: Développé couché maison">
                </div>
                <div class="input-group" style="margin-bottom: 14px;">
                    <div class="input-label">Groupe musculaire</div>
                    <select class="filter-select" id="custom-exercise-muscle">
                        <option value="">Sélectionner un groupe</option>
                        <!-- Options générées dynamiquement -->
                    </select>
                </div>
                <div class="input-group" style="margin-bottom: 14px;">
                    <div class="input-label">Catégorie</div>
                    <select class="filter-select" id="custom-exercise-category">
                        <option value="">Sélectionner une catégorie</option>
                        <option value="force">Force</option>
                        <option value="isolation">Isolation</option>
                        <option value="endurance">Endurance</option>
                        <option value="cardio">Cardio</option>
                        <option value="polyarticulaire">Polyarticulaire</option>
                        <option value="monoarticulaire">Monoarticulaire</option>
                        <option value="stabilisation">Stabilisation</option>
                        <option value="mobilité">Mobilité</option>
                    </select>
                </div>
                <div class="input-group" style="margin-bottom: 14px;">
                    <div class="input-label">Niveau</div>
                    <select class="filter-select" id="custom-exercise-difficulty">
                        <option value="Débutant">Débutant</option>
                        <option value="Intermédiaire">Intermédiaire</option>
                        <option value="Avancé">Avancé</option>
                    </select>
                </div>
                <div class="input-group" style="margin-bottom: 14px;">
                    <div class="input-label">Équipement (séparé par des virgules)</div>
                    <input type="text" class="number-input" id="custom-exercise-equipment" placeholder="Ex: Barre, Banc, Poids">
                </div>
                <div class="input-group" style="margin-bottom: 14px; display: flex; align-items: center; gap: 10px;">
                    <div class="input-label" style="margin: 0;">Favori</div>
                    <div class="checkbox" id="custom-exercise-favorite" onclick="toggleFavoriteCheckbox(this)">
                        <div class="checkmark">✓</div>
                    </div>
                </div>
                <button class="btn btn-success" onclick="addCustomExercise()" style="width: 100%; margin-bottom: 10px;">➕ Ajouter l'exercice</button>
            </div>
        </div>
    </div>

    <!-- MODAL SUPPRIMER HISTORIQUE -->
    <div class="modal" id="clear-history-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">🗑️ Supprimer l'historique</h3>
                <button class="modal-close" onclick="hideModal('clear-history-modal')">×</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 18px; color: var(--text-primary);">Êtes-vous sûr de vouloir supprimer TOUT l'historique ? Cette action est irréversible.</p>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-danger" onclick="clearAllHistory()" style="flex: 1;">Oui, tout supprimer</button>
                    <button class="btn btn-secondary" onclick="hideModal('clear-history-modal')" style="flex: 1;">Annuler</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL SUPPRIMER TOUS LES EXERCICES -->
    <div class="modal" id="delete-all-exercises-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">⚠️ Supprimer tous les exercices personnalisés</h3>
                <button class="modal-close" onclick="hideModal('delete-all-exercises-modal')">×</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 18px; color: var(--text-primary);">Cette action supprimera TOUS vos exercices personnalisés. Cette action est irréversible.</p>
                <p style="margin-bottom: 18px; color: var(--danger); font-weight: 700;">Voulez-vous vraiment continuer ?</p>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-danger" onclick="confirmDeleteAllExercises()" style="flex: 1;">Oui, tout supprimer</button>
                    <button class="btn btn-secondary" onclick="hideModal('delete-all-exercises-modal')" style="flex: 1;">Annuler</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL SUPPRIMER TOUS LES ALIMENTS -->
    <div class="modal" id="delete-all-foods-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">⚠️ Supprimer tous les aliments personnalisés</h3>
                <button class="modal-close" onclick="hideModal('delete-all-foods-modal')">×</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 18px; color: var(--text-primary);">Cette action supprimera TOUS vos aliments personnalisés. Cette action est irréversible.</p>
                <p style="margin-bottom: 18px; color: var(--danger); font-weight: 700;">Voulez-vous vraiment continuer ?</p>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-danger" onclick="confirmDeleteAllFoods()" style="flex: 1;">Oui, tout supprimer</button>
                    <button class="btn btn-secondary" onclick="hideModal('delete-all-foods-modal')" style="flex: 1;">Annuler</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL DÉTAIL HISTORIQUE - AMÉLIORÉ -->
    <div class="modal" id="history-detail-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="history-detail-title">📋 Détail de la séance</h3>
                <button class="modal-close" onclick="hideModal('history-detail-modal')">×</button>
            </div>
            <div class="modal-body">
                <div class="modal-scrollable" id="history-detail-content">
                    <!-- Contenu généré dynamiquement -->
                </div>
            </div>
        </div>
    </div>

<!-- MODAL FICHE EXERCICE DÉTAILLÉE PREMIUM -->
<div class="modal" id="exercise-detail-modal">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h3 class="modal-title" id="exercise-detail-title">📋 Fiche Exercice</h3>
            <button class="modal-close" onclick="hideModal('exercise-detail-modal')">×</button>
        </div>
        <div class="modal-body">
            <div class="exercise-detail-modal-content" id="exercise-detail-content">
                <!-- Contenu généré dynamiquement -->
            </div>
        </div>
    </div>
</div>

    <!-- MODAL SUPPRIMER EXERCICE PERSONNALISÉ -->
    <div class="modal" id="delete-custom-exercise-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">🗑️ Supprimer l'exercice</h3>
                <button class="modal-close" onclick="hideModal('delete-custom-exercise-modal')">×</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 18px; color: var(--text-primary);" id="delete-exercise-message">Êtes-vous sûr de vouloir supprimer cet exercice ? Cette action est irréversible et supprimera également cet exercice de toutes les séances où il est utilisé.</p>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-danger" onclick="confirmDeleteCustomExercise()" style="flex: 1;">Oui, supprimer</button>
                    <button class="btn btn-secondary" onclick="hideModal('delete-custom-exercise-modal')" style="flex: 1;">Annuler</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL MODIFIER EXERCICE PERSONNALISÉ - AMÉLIORÉ -->
    <div class="modal" id="edit-custom-exercise-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">✏️ Modifier l'exercice</h3>
                <button class="modal-close" onclick="hideModal('edit-custom-exercise-modal')">×</button>
            </div>
            <div class="modal-body">
                <div class="input-group" style="margin-bottom: 14px;">
                    <div class="input-label">Nom de l'exercice</div>
                    <input type="text" class="number-input" id="edit-exercise-name" placeholder="Ex: Développé couché maison">
                </div>
                <div class="input-group" style="margin-bottom: 14px;">
                    <div class="input-label">Groupe musculaire</div>
                    <select class="filter-select" id="edit-exercise-muscle">
                        <option value="">Sélectionner un groupe</option>
                        <!-- Options générées dynamiquement -->
                    </select>
                </div>
                <div class="input-group" style="margin-bottom: 14px;">
                    <div class="input-label">Catégorie</div>
                    <select class="filter-select" id="edit-exercise-category">
                        <option value="">Sélectionner une catégorie</option>
                        <option value="force">Force</option>
                        <option value="isolation">Isolation</option>
                        <option value="endurance">Endurance</option>
                        <option value="cardio">Cardio</option>
                        <option value="polyarticulaire">Polyarticulaire</option>
                        <option value="monoarticulaire">Monoarticulaire</option>
                        <option value="stabilisation">Stabilisation</option>
                        <option value="mobilité">Mobilité</option>
                    </select>
                </div>
                <div class="input-group" style="margin-bottom: 14px;">
                    <div class="input-label">Niveau</div>
                    <select class="filter-select" id="edit-exercise-difficulty">
                        <option value="Débutant">Débutant</option>
                        <option value="Intermédiaire">Intermédiaire</option>
                        <option value="Avancé">Avancé</option>
                    </select>
                </div>
                <div class="input-group" style="margin-bottom: 14px;">
                    <div class="input-label">Équipement (séparé par des virgules)</div>
                    <input type="text" class="number-input" id="edit-exercise-equipment" placeholder="Ex: Barre, Banc, Poids">
                </div>
                <div class="input-group" style="margin-bottom: 14px; display: flex; align-items: center; gap: 10px;">
                    <div class="input-label" style="margin: 0;">Favori</div>
                    <div class="checkbox" id="edit-exercise-favorite" onclick="toggleFavoriteCheckbox(this)">
                        <div class="checkmark">✓</div>
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-success" onclick="saveEditedExercise()" style="flex: 1;">💾 Sauvegarder</button>
                    <button class="btn btn-secondary" onclick="hideModal('edit-custom-exercise-modal')" style="flex: 1;">Annuler</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL AJOUTER REPAS - OPTIMISÉ -->
    <div class="modal" id="add-meal-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">🍽️ Ajouter un repas</h3>
                <button class="modal-close" onclick="hideModal('add-meal-modal'); resetMealForm()">×</button>
            </div>
            <div class="modal-body">
                <div class="add-meal-modal-content">
                    <div class="input-group" style="margin-bottom: 14px;">
                        <div class="input-label">Nom du repas</div>
                        <input type="text" class="number-input" id="meal-name" placeholder="Ex: Petit-déjeuner">
                    </div>
                    
                    <div class="input-group" style="margin-bottom: 14px;">
                        <div class="input-label">Type de repas</div>
                        <div class="meal-type-options">
    <div class="meal-type-option active" data-value="petit-dejeuner" onclick="selectMealType('petit-dejeuner')">Petit-déjeuner</div>
    <div class="meal-type-option" data-value="dejeuner" onclick="selectMealType('dejeuner')">Déjeuner</div>
    <div class="meal-type-option" data-value="diner" onclick="selectMealType('diner')">Dîner</div>
    <div class="meal-type-option" data-value="collation" onclick="selectMealType('collation')">Collation</div>
</div>
<input type="hidden" id="meal-type" value="petit-dejeuner">
                    </div>

                    <h4 style="margin: 18px 0 10px; color: var(--text-primary);">Aliments</h4>
                    <div id="meal-foods-list" style="max-height: 200px; overflow-y: auto;">
                        <!-- Aliments ajoutés -->
                    </div>
                    
                    <div class="food-search-btn-container">
                        <button class="btn food-search-btn" onclick="showFoodSearchModalForMeal()">
                            <i class="fas fa-search"></i> Rechercher
                        </button>
                        <button class="btn food-search-btn" onclick="showAddFoodFromMeal('add')">
                            <i class="fas fa-plus"></i> Nouvel aliment
                        </button>
                    </div>
                    
                    <textarea class="number-input notes-wrap" id="meal-notes" placeholder="Notes (optionnel)" style="height: 70px; resize: vertical; margin-top: 14px;"></textarea>
                    
                    <button class="btn btn-success" onclick="saveMealAndReturnToNutrition()" 
       			 style="width: 100%; margin-top: 14px; margin-bottom: 10px;"
       			 id="save-meal-button">
    			<span class="save-button-text">💾 Sauvegarder le repas</span>
    			<span class="save-button-loading" style="display: none;">
     			   <i class="fas fa-spinner fa-spin"></i> Sauvegarde en cours...
   			 </span>
		    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL AJOUTER ALIMENT -->
    <div class="modal" id="add-food-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">🥦 Ajouter un aliment</h3>
                <button class="modal-close" onclick="hideModal('add-food-modal'); resetFoodForm()">×</button>
            </div>
            <div class="modal-body">
                <div class="input-group" style="margin-bottom: 14px;">
                    <div class="input-label">Nom de l'aliment</div>
                    <input type="text" class="number-input" id="food-name" placeholder="Ex: Poulet grillé">
                </div>
                
                <div class="input-group" style="margin-bottom: 14px;">
                    <div class="input-label">Quantité de référence (g)</div>
                    <input type="number" class="number-input" id="food-quantity" value="100">
                </div>
                
                <div class="set-inputs-grid">
                    <div class="input-group">
                        <div class="input-label">Calories</div>
                        <input type="number" class="number-input" id="food-calories" placeholder="kcal">
                    </div>
                    <div class="input-group">
                        <div class="input-label">Protéines (g)</div>
                        <input type="number" class="number-input" id="food-protein" placeholder="0">
                    </div>
                    <div class="input-group">
                        <div class="input-label">Glucides (g)</div>
                        <input type="number" class="number-input" id="food-carbs" placeholder="0">
                    </div>
                    <div class="input-group">
                        <div class="input-label">Lipides (g)</div>
                        <input type="number" class="number-input" id="food-fat" placeholder="0">
                    </div>
                </div>
                
                <div class="input-group" style="margin-top: 14px;">
                    <div class="input-label">Catégorie</div>
                    <select class="filter-select" id="food-category">
                        <option value="viande">Viande</option>
                        <option value="poisson">Poisson</option>
                        <option value="legume">Légume</option>
                        <option value="fruit">Fruit</option>
                        <option value="cereale">Céréale</option>
                        <option value="produit-laitier">Produit laitier</option>
                        <option value="personnalisé">Personnalisé</option>
                        <option value="autre">Autre</option>
                    </select>
                </div>
                
                <div class="input-group" style="margin-top: 14px;">
                    <div class="input-label">Halal</div>
                    <div class="checkbox" id="food-halal" onclick="toggleCheckbox(this)">
                        <div class="checkmark">✓</div>
                    </div>
                </div>
                
                <div class="input-group" style="margin-top: 14px;">
                    <div class="input-label">Favori</div>
                    <div class="checkbox" id="food-favorite" onclick="toggleCheckbox(this)">
                        <div class="checkmark">✓</div>
                    </div>
                </div>
                
                <div class="input-group" style="margin-top: 14px;">
                    <div class="input-label">Calcul automatique des calories</div>
                        <button type="button" class="btn btn-secondary" onclick="calculateCaloriesFromMacros()" style="width: 100%;">Calculer les calories</button>
                </div>
                
                <button class="btn btn-success" onclick="saveFood()" style="width: 100%; margin-top: 14px; margin-bottom: 10px;">
                    💾 Sauvegarder l'aliment
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL RECHERCHE ALIMENT -->
<div class="modal" id="food-search-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">🔍 Rechercher un aliment</h3>
            <button class="modal-close" onclick="hideModal('food-search-modal')">×</button>
        </div>
        <div class="modal-body">
            <div class="input-group" style="margin-bottom: 14px;">
                <div class="input-label">Nom de l'aliment</div>
                <input type="text" class="number-input" id="food-search-input" 
                       placeholder="Rechercher un aliment..." 
                       onkeyup="searchFoodsSimple(this.value)">
            </div>
            
            <div class="input-group" style="margin-bottom: 14px;">
                <div class="input-label">Catégorie</div>
                <!-- CORRECTION : Supprimer "-simple" -->
                <select class="filter-select" id="food-search-category" 
                        onchange="searchFoodsSimple(document.getElementById('food-search-input').value)">
                    <option value="all">Toutes les catégories</option>
                    <option value="personnalisé">Personnalisé</option>
                    <option value="halal">Halal</option>
                    <!-- Options générées dynamiquement -->
                </select>
            </div>
            
            <div class="food-search-results" id="food-search-results-simple">
                <!-- Résultats de recherche simplifiés générés dynamiquement -->
            </div>
            
            <div class="empty-state" id="food-search-empty-simple" style="display: none;">
                <div class="empty-state-icon">🔍</div>
                <p>Aucun aliment trouvé</p>
                <p style="font-size: var(--font-size-sm); margin-top: 6px;">Essayez avec un autre terme ou créez un aliment personnalisé</p>
            </div>
        </div>
    </div>
</div>

    <!-- MODAL SUPPRIMER HISTORIQUE NUTRITION -->
    <div class="modal" id="clear-nutrition-history-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">🗑️ Supprimer l'historique nutrition</h3>
                <button class="modal-close" onclick="hideModal('clear-nutrition-history-modal')">×</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 18px; color: var(--text-primary);">Êtes-vous sûr de vouloir supprimer TOUT l'historique nutrition ? Cette action est irréversible.</p>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-danger" onclick="clearAllNutritionHistory()" style="flex: 1;">Oui, tout supprimer</button>
                    <button class="btn btn-secondary" onclick="hideModal('clear-nutrition-history-modal')" style="flex: 1;">Annuler</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL MODIFIER REPAS - AMÉLIORÉ -->
    <div class="modal" id="edit-meal-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">✏️ Modifier un repas</h3>
                <button class="modal-close" onclick="hideModal('edit-meal-modal'); resetEditMealForm()">×</button>
            </div>
            <div class="modal-body">
                <div class="add-meal-modal-content">
                    <div class="input-group" style="margin-bottom: 14px;">
                        <div class="input-label">Nom du repas</div>
                        <input type="text" class="number-input" id="edit-meal-name" placeholder="Ex: Petit-déjeuner">
                    </div>
                    
                    <div class="input-group" style="margin-bottom: 14px;">
    <div class="input-label">Type de repas</div>
    <div class="meal-type-options" id="edit-meal-type-options">
        <div class="meal-type-option active" data-value="petit-dejeuner" onclick="selectEditMealType('petit-dejeuner')">Petit-déjeuner</div>
        <div class="meal-type-option" data-value="dejeuner" onclick="selectEditMealType('dejeuner')">Déjeuner</div>
        <div class="meal-type-option" data-value="diner" onclick="selectEditMealType('diner')">Dîner</div>
        <div class="meal-type-option" data-value="collation" onclick="selectEditMealType('collation')">Collation</div>
    </div>
    <input type="hidden" id="edit-meal-type" value="petit-dejeuner">
</div>

                    <h4 style="margin: 18px 0 10px; color: var(--text-primary);">Aliments</h4>
                    <div id="edit-meal-foods-list" style="max-height: 200px; overflow-y: auto;">
                        <!-- Aliments ajoutés -->
                    </div>
                    
                    <div class="food-search-btn-container">
                        <button class="btn food-search-btn" onclick="showFoodSearchModalForEdit()">
                            <i class="fas fa-search"></i> Rechercher
                        </button>
                        <button class="btn food-search-btn" onclick="showAddFoodFromMeal('edit')">
                            <i class="fas fa-plus"></i> Nouvel aliment
                        </button>
                    </div>
                    
                    <textarea class="number-input notes-wrap" id="edit-meal-notes" placeholder="Notes (optionnel)" style="height: 70px; resize: vertical; margin-top: 14px;"></textarea>
                    
                    <button class="btn btn-success" onclick="saveEditedMeal()" style="width: 100%; margin-top: 14px; margin-bottom: 10px;">💾 Sauvegarder les modifications</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL MODIFIER ALIMENT - AMÉLIORÉ -->
    <div class="modal" id="edit-custom-food-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">✏️ Modifier un aliment</h3>
                <button class="modal-close" onclick="hideModal('edit-custom-food-modal')">×</button>
            </div>
            <div class="modal-body">
                <div class="input-group" style="margin-bottom: 14px;">
                    <div class="input-label">Nom de l'aliment</div>
                    <input type="text" class="number-input" id="edit-food-name" placeholder="Ex: Poulet grillé maison">
                </div>
                
                <div class="input-group" style="margin-bottom: 14px;">
                    <div class="input-label">Quantité de référence (g)</div>
                    <input type="number" class="number-input" id="edit-food-quantity" value="100">
                </div>
                
                <div class="set-inputs-grid">
                    <div class="input-group">
                        <div class="input-label">Calories</div>
                        <input type="number" class="number-input" id="edit-food-calories" placeholder="kcal">
                    </div>
                    <div class="input-group">
                        <div class="input-label">Protéines (g)</div>
                        <input type="number" class="number-input" id="edit-food-protein" placeholder="0">
                    </div>
                    <div class="input-group">
                        <div class="input-label">Glucides (g)</div>
                        <input type="number" class="number-input" id="edit-food-carbs" placeholder="0">
                    </div>
                    <div class="input-group">
                        <div class="input-label">Lipides (g)</div>
                        <input type="number" class="number-input" id="edit-food-fat" placeholder="0">
                    </div>
                </div>
                
                <div class="input-group" style="margin-top: 14px;">
                    <div class="input-label">Catégorie</div>
                    <select class="filter-select" id="edit-food-category">
                        <option value="">Sélectionner une catégorie</option>
                        <option value="viande">Viande</option>
                        <option value="poisson">Poisson</option>
                        <option value="legume">Légume</option>
                        <option value="fruit">Fruit</option>
                        <option value="cereale">Céréale</option>
                        <option value="produit-laitier">Produit laitier</option>
                        <option value="personnalisé">Personnalisé</option>
                        <option value="halal">Halal</option>
                        <option value="autre">Autre</option>
                    </select>
                </div>
                
                <div class="input-group" style="margin-top: 14px; display: flex; align-items: center; gap: 10px;">
                    <div class="input-label" style="margin: 0;">Halal</div>
                    <div class="checkbox" id="edit-food-halal" onclick="toggleCheckbox(this)">
                        <div class="checkmark">✓</div>
                    </div>
                </div>
                
                <div class="input-group" style="margin-top: 14px; display: flex; align-items: center; gap: 10px;">
                    <div class="input-label" style="margin: 0;">Favori</div>
                    <div class="checkbox" id="edit-food-favorite" onclick="toggleCheckbox(this)">
                        <div class="checkmark">✓</div>
                    </div>
                </div>
                
                <div class="input-group" style="margin-top: 14px;">
                    <div class="input-label">Calcul automatique des calories</div>
                    <button type="button" class="btn btn-secondary" onclick="calculateEditCaloriesFromMacros()" style="width: 100%;">Calculer les calories</button>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 14px;">
                    <button class="btn btn-success" onclick="saveEditedFood()" style="flex: 1;">💾 Sauvegarder</button>
                    <button class="btn btn-danger" onclick="deleteFood()" style="flex: 1;">🗑️ Supprimer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL DÉTAIL REPAS HISTORIQUE -->
    <div class="modal" id="meal-detail-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="meal-detail-title">🍽️ Détail du repas</h3>
                <button class="modal-close" onclick="hideModal('meal-detail-modal')">×</button>
            </div>
            <div class="modal-body">
                <div class="modal-scrollable" id="meal-detail-content">
                    <!-- Contenu généré dynamiquement -->
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL MODIFIER QUANTITÉ ALIMENT DANS REPAS - AMÉLIORÉ -->
    <div class="modal" id="edit-food-quantity-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">✏️ Modifier la quantité</h3>
                <button class="modal-close" onclick="hideModal('edit-food-quantity-modal'); resetFoodEditModal()">×</button>
            </div>
            <div class="modal-body">
                <div id="edit-food-quantity-content">
                    <!-- Contenu généré dynamiquement -->
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL SAUVEGARDE DONNÉES SÉANCE -->
    <div class="modal" id="save-data-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">💾 Sauvegarder la séance</h3>
                <button class="modal-close" onclick="hideModal('save-data-modal')">×</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 18px; color: var(--text-primary);">
                    <p>Souhaitez-vous sauvegarder cette séance dans votre historique ?</p>
                </div>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <button class="btn btn-success" onclick="saveWorkoutData(true)">✅ Sauvegarder la séance</button>
                    <button class="btn btn-danger" onclick="completeWorkoutWithoutSaving()">❌ Abandonner la séance</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Recherche Avancée Exercices -->
    <div class="modal" id="advanced-search-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">🔍 Recherche Avancée Exercices</h3>
                <button class="modal-close" onclick="hideModal('advanced-search-modal')">×</button>
            </div>
            <div class="modal-body">
                <div class="filter-selection-container">
                    <div class="filter-selection-title">Groupe musculaire</div>
                    <div class="filter-selection-options" id="advanced-muscle-options">
                        <!-- Options générées dynamiquement -->
                    </div>
                </div>

                <div class="filter-selection-container">
                    <div class="filter-selection-title">Catégorie</div>
                    <div class="filter-selection-options" id="advanced-category-options">
                        <div class="filter-selection-option" data-value="all">Toutes</div>
                        <div class="filter-selection-option" data-value="force">Force</div>
                        <div class="filter-selection-option" data-value="isolation">Isolation</div>
                        <div class="filter-selection-option" data-value="endurance">Endurance</div>
                        <div class="filter-selection-option" data-value="cardio">Cardio</div>
                        <div class="filter-selection-option" data-value="polyarticulaire">Polyarticulaire</div>
                        <div class="filter-selection-option" data-value="monoarticulaire">Monoarticulaire</div>
                        <div class="filter-selection-option" data-value="stabilisation">Stabilisation</div>
                        <div class="filter-selection-option" data-value="mobilité">Mobilité</div>
                    </div>
                </div>

                <div class="filter-selection-container">
                    <div class="filter-selection-title">Niveau de difficulté</div>
                    <div class="filter-selection-options" id="advanced-difficulty-options">
                        <div class="filter-selection-option" data-value="all">Tous</div>
                        <div class="filter-selection-option" data-value="Débutant">Débutant</div>
                        <div class="filter-selection-option" data-value="Intermédiaire">Intermédiaire</div>
                        <div class="filter-selection-option" data-value="Avancé">Avancé</div>
                    </div>
                </div>

                <div class="filter-selection-container">
                    <div class="filter-selection-title">Équipement</div>
                    <div class="filter-selection-options" id="advanced-equipment-options">
                        <!-- Options générées dynamiquement -->
                    </div>
                </div>
                
                <div class="filter-selection-container">
    <div class="filter-selection-title">Filtres Spéciaux</div>
    <div class="filter-selection-options">
        <div class="filter-selection-option selected" data-value="all">Tous</div>
        <div class="filter-selection-option" data-value="personnalisé">Personnalisé</div>
        <div class="filter-selection-option" data-value="favoris">Favoris</div>
    </div>
</div>
                
                <div style="display: flex; gap: 10px; margin-top: 16px;">
                    <button class="btn btn-success" onclick="applyAdvancedFilters()" style="flex: 1;">🔍 Appliquer</button>
                    <button class="btn btn-secondary" onclick="resetAdvancedFilters()" style="flex: 1;">🗑️ Effacer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Recherche Avancée Aliments -->
    <div class="modal" id="advanced-search-modal-food">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">🔍 Recherche Avancée Aliments</h3>
                <button class="modal-close" onclick="hideModal('advanced-search-modal-food')">×</button>
            </div>
            <div class="modal-body">
                <div class="filter-selection-container">
                    <div class="filter-selection-title">Catégorie</div>
                    <div class="filter-selection-options" id="advanced-food-category-options">
                        <!-- Options générées dynamiquement -->
                    </div>
                </div>

                <div class="filter-selection-container">
                    <div class="filter-selection-title">Filtres spéciaux</div>
                    <div class="filter-selection-options">
                        <div class="filter-selection-option selected" data-value="all">Tous</div>
                        <div class="filter-selection-option" data-value="personnalisé">Personnalisé</div>
                        <div class="filter-selection-option" data-value="halal">Halal</div>
                        <div class="filter-selection-option" data-value="favoris">Favoris</div>
                    </div>
                </div>

                <div class="input-group" style="margin-top: 16px;">
                    <div class="input-label">Calories (max)</div>
                    <input type="number" class="number-input" id="advanced-calories-filter" placeholder="Ex: 200">
                </div>

                <div class="input-group" style="margin-top: 16px;">
                    <div class="input-label">Protéines (min)</div>
                    <input type="number" class="number-input" id="advanced-protein-filter" placeholder="Ex: 10">
                </div>

                <div class="input-group" style="margin-top: 16px;">
                    <div class="input-label">Recherche par nom</div>
                    <input type="text" class="number-input" id="advanced-food-name-filter" placeholder="Ex: Poulet, Riz...">
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 16px;">
                    <button class="btn btn-success" onclick="applyAdvancedFiltersFood()" style="flex: 1;">🔍 Appliquer</button>
                    <button class="btn btn-secondary" onclick="resetAdvancedFiltersFood()" style="flex: 1;">🗑️ Effacer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de confirmation de sortie -->
    <div class="modal" id="exit-confirm-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">⚠️ Quitter la séance ?</h3>
                <button class="modal-close" onclick="hideModal('exit-confirm-modal')">×</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 18px; color: var(--text-primary);">Vous avez une séance en cours. Voulez-vous vraiment quitter ?</p>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-danger" onclick="forceExitWorkout()" style="flex: 1;">Quitter</button>
                    <button class="btn btn-secondary" onclick="hideModal('exit-confirm-modal')" style="flex: 1;">Continuer</button>
                </div>
            </div>
        </div>
    </div>

<!-- Modal Paramètres - AMÉLIORÉ -->
<div class="modal" id="settings-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">⚙️ Paramètres</h3>
            <button class="modal-close" onclick="hideModal('settings-modal')">×</button>
        </div>
        <div class="modal-body">
            <div class="settings-list">
                <!-- NOUVEAU : Bouton Thème -->
                <div class="settings-item" onclick="showThemeSelection()" style="cursor: pointer;">
                    <div>
                        <div style="font-weight: 700; color: var(--text-primary);">🎨 Thème</div>
                        <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">Changer le thème de couleur</div>
                    </div>
                    <div style="color: var(--primary); font-weight: 700;">
                        <i class="fas fa-palette"></i>
                    </div>
                </div>
                
                <div class="settings-item">
                    <div>
                        <div style="font-weight: 700; color: var(--text-primary);">🌙 Mode sombre</div>
                        <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">Activer/désactiver le thème sombre</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="dark-mode-toggle" onchange="toggleDarkModeSetting(this.checked)">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="settings-item">
                    <div>
                        <div style="font-weight: 700; color: var(--text-primary);">🔊 Sons</div>
                        <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">Activer/désactiver les sons</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="sounds-toggle" checked onchange="toggleSounds(this.checked)">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="settings-item">
                    <div>
                        <div style="font-weight: 700; color: var(--text-primary);">📳 Vibrations</div>
                        <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">Activer/désactiver les vibrations</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="vibrations-toggle" checked onchange="toggleVibrations(this.checked)">
                        <span class="slider"></span>
                    </label>
                </div>

                
                <div class="settings-item">
                    <div>
                        <div style="font-weight: 700; color: var(--text-primary);">🔒 Écran toujours actif</div>
                        <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">Garder l'écran allumé pendant les séances</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="keep-screen-on-toggle" onchange="toggleKeepScreenOn(this.checked)">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="settings-item">
                    <div>
                        <div style="font-weight: 700; color: var(--text-primary);">⏱️ Timer auto</div>
                        <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">Démarrer le timer automatiquement</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="auto-timer-toggle" checked onchange="toggleAutoTimer(this.checked)">
                        <span class="slider"></span>
                    </label>
                </div>
<div class="settings-item">
    <div>
        <div style="font-weight: 700; color: var(--text-primary);">📐 Mode compact</div>
        <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">Séries toujours compactes</div>
    </div>
    <label class="toggle-switch">
        <input type="checkbox" id="compact-mode-toggle" onchange="toggleCompactMode(this.checked)">
        <span class="slider"></span>
    </label>
</div>


<div class="settings-item">
    <div>
        <div style="font-weight: 700; color: var(--text-primary);">🎵 Test audio/vibration</div>
        <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">Tester les alertes sonores et vibrations</div>
    </div>
    <button class="btn btn-secondary" onclick="testAudioVibration()" style="padding: 8px 16px; font-size: var(--font-size-sm);">
        Tester
    </button>
</div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL DE SÉLECTION DE THÈME - DÉPLACÉ ICI -->
<div class="modal" id="theme-selection-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">🎨 Choisir un thème</h3>
            <button class="modal-close" onclick="hideModal('theme-selection-modal')">×</button>
        </div>
        <div class="modal-body">
            <p style="margin-bottom: 20px; color: var(--text-secondary); text-align: center;">
                Sélectionnez un thème de couleur pour l'application
            </p>
            
            <div class="theme-options-grid">
                <div class="theme-option" data-theme="default" onclick="selectTheme('default')">
                    <div class="theme-preview" style="background: linear-gradient(135deg, #6366F1, #818CF8);"></div>
                    <div class="theme-name">Par défaut</div>
                    <div class="theme-check"><i class="fas fa-check"></i></div>
                </div>
                
                <div class="theme-option" data-theme="blue" onclick="selectTheme('blue')">
                    <div class="theme-preview" style="background: linear-gradient(135deg, #3B82F6, #60A5FA);"></div>
                    <div class="theme-name">Bleu</div>
                    <div class="theme-check"><i class="fas fa-check"></i></div>
                </div>
                
                <div class="theme-option" data-theme="green" onclick="selectTheme('green')">
                    <div class="theme-preview" style="background: linear-gradient(135deg, #10B981, #34D399);"></div>
                    <div class="theme-name">Vert</div>
                    <div class="theme-check"><i class="fas fa-check"></i></div>
                </div>
                
                <div class="theme-option" data-theme="purple" onclick="selectTheme('purple')">
                    <div class="theme-preview" style="background: linear-gradient(135deg, #8B5CF6, #A78BFA);"></div>
                    <div class="theme-name">Violet</div>
                    <div class="theme-check"><i class="fas fa-check"></i></div>
                </div>
                
                <div class="theme-option" data-theme="red" onclick="selectTheme('red')">
                    <div class="theme-preview" style="background: linear-gradient(135deg, #EF4444, #FCA5A5);"></div>
                    <div class="theme-name">Rouge</div>
                    <div class="theme-check"><i class="fas fa-check"></i></div>
                </div>
                
                <div class="theme-option" data-theme="sunset" onclick="selectTheme('sunset')">
                    <div class="theme-preview" style="background: linear-gradient(135deg, #F59E0B, #FBBF24);"></div>
                    <div class="theme-name">Soleil</div>
                    <div class="theme-check"><i class="fas fa-check"></i></div>
                </div>
            </div>
            
            <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--border); text-align: center;">
                <button class="btn btn-secondary" onclick="hideModal('theme-selection-modal')" style="width: 100%;">
                    Retour aux paramètres
                </button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL NOTES PREMIUM - DÉPLACÉ ICI (PLUS À L'EXTÉRIEUR) -->
<div class="modal" id="exercise-notes-modal">
    <div class="modal-content" style="max-width: 380px;">
        <div class="modal-header">
            <h3 class="modal-title">📝 Notes de l'exercice</h3>
            <button class="modal-close" onclick="hideModal('exercise-notes-modal')">×</button>
        </div>
        <div class="modal-body">
            <div style="margin-bottom: 20px; text-align: center;">
                <div class="profile-avatar" id="notes-exercise-icon" style="width: 60px; height: 60px; margin: 0 auto 15px; background: linear-gradient(135deg, #8B5CF6, #EC4899); font-size: 24px;">
                    <i class="fas fa-dumbbell"></i>
                </div>
                <h4 id="notes-exercise-name" style="margin: 0 0 10px 0; color: var(--text-primary);">Nom de l'exercice</h4>
                <div id="notes-exercise-details" style="font-size: var(--font-size-sm); color: var(--text-secondary);">
                    <!-- Détails de l'exercice -->
                </div>
            </div>
            
            <div class="input-group" style="margin-bottom: 20px;">
                <div class="input-label">
                    <i class="fas fa-edit"></i> Votre note
                </div>
                <textarea 
                    class="number-input notes-wrap" 
                    id="exercise-notes-text" 
                    placeholder="Ex: Technique à améliorer, sensation pendant l'exercice, objectif pour la prochaine fois..."
                    style="height: 150px; resize: vertical; width: 100%; padding: 15px; font-size: var(--font-size-base);"
                    oninput="autoSaveNotes()"
                ></textarea>
                <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                    <div style="font-size: var(--font-size-xs); color: var(--text-secondary);">
                        <i class="fas fa-history"></i> Sauvegarde automatique
                    </div>
                    <div style="font-size: var(--font-size-xs); color: var(--text-secondary);">
                        <span id="notes-char-count">0</span>/500 caractères
                    </div>
                </div>
            </div>
            
            <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(236, 72, 153, 0.05)); padding: 15px; border-radius: var(--radius); margin-bottom: 20px; border: 1px solid rgba(139, 92, 246, 0.2);">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <div style="width: 30px; height: 30px; background: linear-gradient(135deg, #8B5CF6, #EC4899); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white;">
                        <i class="fas fa-lightbulb"></i>
                    </div>
                    <div style="font-weight: 700; color: var(--text-primary);">Conseil</div>
                </div>
                <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">
                    Notez vos sensations, la technique utilisée, le niveau de difficulté ou vos objectifs pour la prochaine séance.
                </div>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-success" onclick="saveExerciseNotes()" style="flex: 1; background: linear-gradient(135deg, #8B5CF6, #EC4899);">
                    <i class="fas fa-save"></i> Enregistrer
                </button>
                <button class="btn btn-secondary" onclick="clearExerciseNotes()" style="flex: 1;">
                    <i class="fas fa-eraser"></i> Effacer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL ALIMENT FAVORI -->
<div class="modal" id="favorite-food-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">⭐ Ajouter un repas avec cet aliment</h3>
            <button class="modal-close" onclick="hideModal('favorite-food-modal')">×</button>
        </div>
        <div class="modal-body">
            <p style="margin-bottom: 18px; color: var(--text-primary);" id="favorite-food-message">Voulez-vous ajouter un repas avec cet aliment favori ?</p>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-success" onclick="addFavoriteFoodToMeal()" style="flex: 1;">Oui, ajouter un repas</button>
                <button class="btn btn-secondary" onclick="hideModal('favorite-food-modal')" style="flex: 1;">Non, merci</button>
            </div>
        </div>
    </div>
</div>

<!-- Inclure data.js avant le script principal -->
<script src="data.js"></script>
<script>
// ==================== VARIABLES GLOBALES ====================
let userProfile = {
    firstName: 'John',
    lastName: 'Doe',
    height: 180,
    weight: 75,
    level: 'Intermédiaire',
    trainingType: 'Maintien',
    defaultSets: 3,
    defaultReps: 10,
    defaultWeight: 10,
    defaultRest: 60
};

let customExercises = [];
let customFoods = [];
let customWorkouts = [];
let workoutHistory = [];
let nutritionHistory = [];
let dailyNutrition = { calories: 0, protein: 0, carbs: 0, fat: 0, meals: [] };
let activeWorkout = null;
let activeWorkoutTimer = null;
let activeWorkoutStartTime = null;
let timerInterval = null;
let currentTimerSeconds = 90;
let isTimerRunning = false;
let timerProgressInterval = null;
let currentScreen = 'home-screen';
let exerciseSearchFilter = 'all';
let foodSearchFilter = 'all';
let advancedExerciseFilters = {};
let advancedFoodFilters = {};
let theme = 'light';
let currentSupersetExerciseIndex = null;
let currentSupersetSetIndex = null;
let currentSupersetRoundInfo = null;
let settings = {
    sounds: true,
    vibrations: true,
    keepScreenOn: false,
    autoTimer: true,
    darkMode: false,
    compactMode: false  // AJOUTER CETTE LIGNE
};
let currentTheme = 'default'; // 'default', 'blue', 'green', 'purple', 'red', 'sunset'

// ==================== GESTION DU SON ET VIBRATIONS ====================
function playSound(type = 'beep') {
    if (!settings.sounds) return;
    
    try {
        // Créer un contexte audio
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        // Configurer le son selon le type
        switch(type) {
            case 'beep':
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime); // Fréquence du bip
                oscillator.type = 'sine';
                // Enveloppe ADSR pour un bip court
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.15);
                break;
                
            case 'timer_end':
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(400, audioContext.currentTime + 0.5);
                oscillator.type = 'sine';
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.4, audioContext.currentTime + 0.05);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.8);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.8);
                break;
                
            case 'success':
                // Bip de succès plus mélodieux
                oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // Do
                oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // Mi
                oscillator.type = 'sine';
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.05);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
                break;
        }
    } catch (error) {
        console.error('Erreur de son:', error);
    }
}

function vibrate(pattern = [100, 50, 100]) {
    if (!settings.vibrations || !navigator.vibrate) return;
    
    try {
        navigator.vibrate(pattern);
    } catch (error) {
        console.error('Erreur de vibration:', error);
    }
}

function playTimerEndAlert() {
    // Jouer le son de fin de timer
    playSound('timer_end');
    
    // Vibrer
    vibrate([200, 100, 200, 100, 200]);
    
    // Notification visuelle supplémentaire
    if (document.getElementById('timer-container').classList.contains('active')) {
        const timerDisplay = document.getElementById('timer-display');
        timerDisplay.style.color = '#EF4444';
        timerDisplay.style.animation = 'shake 0.5s ease-in-out';
        
        setTimeout(() => {
            timerDisplay.style.color = '';
            timerDisplay.style.animation = '';
        }, 500);
    }
}

function playSetCompleteAlert() {
    // Bip pour série terminée
    playSound('success');
    vibrate([100]);
    
    // Flash visuel
    if (document.querySelector('.set-item.completed:last-child')) {
        const lastCompletedSet = document.querySelector('.set-item.completed:last-child');
        lastCompletedSet.style.boxShadow = '0 0 20px rgba(16, 185, 129, 0.5)';
        
        setTimeout(() => {
            lastCompletedSet.style.boxShadow = '';
        }, 300);
    }
}

// ==================== FONCTIONS D'INITIALISATION ====================
function initApp() {
    loadFromLocalStorage();
    
    // ACTIVER LE MODE COMPACT PAR DÉFAUT SI CE N'EST PAS DÉJÀ DÉFINI
    if (settings.compactMode === undefined) {
        settings.compactMode = true;
    }
    
    calculateNutritionNeeds();
    updateDailyNutritionDisplay();
    loadMuscleGroups();
    loadExercises();
    loadFoods();
    loadCustomWorkouts();
    loadPredefinedWorkouts();
    loadWorkoutHistory();
    // loadNutritionHistory(); // ← SUPPRIMÉ
    updateFavoriteFoods();
    updateRecommendedPrograms();
    updateNavbar();
    checkAndApplyTheme();
    
    // Mettre à jour la case à cocher dans les paramètres
    updateCompactModeCheckbox();
    
    // Supprimer cette ligne complètement
// setTimeout(updateSelectDisplay, 1000);

    // AJOUTER CETTE LIGNE : Mettre à jour le compteur de repas
    setTimeout(() => {
        const today = new Date().toISOString().split('T')[0];
        const todaysMeals = dailyNutrition.meals.filter(meal => {
            const mealDate = new Date(meal.date).toISOString().split('T')[0];
            return mealDate === today;
        });
        updateTodaysMealCount(todaysMeals.length);
    }, 500);
    
    // Initialiser l'historique nutritionnel avec la nouvelle structure
    initializeNutritionHistory();
}

function initializeNutritionHistory() {
    // Initialiser les 3 périodes
    loadNutritionHistoryData('day');
    loadNutritionHistoryData('week');
    loadNutritionHistoryData('month');
    
    // S'assurer que le jour est actif
    document.querySelectorAll('.nutrition-period').forEach(el => {
        el.classList.remove('active');
        el.classList.add('hidden');
    });
    
    const dayElement = document.getElementById('nutrition-history-day');
    if (dayElement) {
        dayElement.classList.remove('hidden');
        dayElement.classList.add('active');
    }
    
    // Activer le bouton "Jour"
    document.querySelectorAll('.history-nav-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    const dayBtn = document.querySelector('.history-nav-btn[onclick*="day"]');
    if (dayBtn) {
        dayBtn.classList.add('active');
    }
}

function loadFromLocalStorage() {
    try {
        const savedProfile = localStorage.getItem('fitfuel_userProfile');
        if (savedProfile) {
            userProfile = JSON.parse(savedProfile);
            
            // --- AJOUT: VALEURS PAR DÉFAUT POUR NOUVEAUX CHAMPS ---
            if (!userProfile.gender) userProfile.gender = 'male';
            if (!userProfile.age) userProfile.age = 30;
            if (!userProfile.bodyFat) userProfile.bodyFat = 20;
            if (!userProfile.weeklyWeightChange) userProfile.weeklyWeightChange = 0;
            if (!userProfile.lastTrainingType) userProfile.lastTrainingType = 'Maintien';
            
            // Calcul de la masse maigre si poids et bodyfat existent
            if (userProfile.weight && userProfile.bodyFat) {
                userProfile.leanMass = userProfile.weight * (1 - (userProfile.bodyFat / 100));
            } else {
                userProfile.leanMass = userProfile.weight * 0.8; // Estimation par défaut (80% de masse maigre)
            }
            
            // Macros par défaut si non définis
            if (!userProfile.macroPercentages) {
                userProfile.macroPercentages = {
                    protein: 30,
                    carbs: 40,
                    fat: 30
                };
            }
            
            // Si pas de besoins nutritionnels, calculer
            if (!userProfile.calorieNeeds) {
                setTimeout(calculateNutritionNeeds, 500);
            }
            // --- FIN AJOUT ---
        }
        
        const savedExercises = localStorage.getItem('fitfuel_customExercises');
        if (savedExercises) customExercises = JSON.parse(savedExercises);
        
        const savedFoods = localStorage.getItem('fitfuel_customFoods');
        if (savedFoods) customFoods = JSON.parse(savedFoods);
        
        const savedWorkouts = localStorage.getItem('fitfuel_customWorkouts');
        if (savedWorkouts) customWorkouts = JSON.parse(savedWorkouts);
        
        const savedHistory = localStorage.getItem('fitfuel_workoutHistory');
        if (savedHistory) workoutHistory = JSON.parse(savedHistory);
        
        const savedNutrition = localStorage.getItem('fitfuel_nutritionHistory');
        if (savedNutrition) nutritionHistory = JSON.parse(savedNutrition);
        
        const savedDailyNutrition = localStorage.getItem('fitfuel_dailyNutrition');
        if (savedDailyNutrition) dailyNutrition = JSON.parse(savedDailyNutrition);
        
        const savedSettings = localStorage.getItem('fitfuel_settings');
        if (savedSettings) {
            settings = JSON.parse(savedSettings);
            
            // Valeur par défaut pour compactMode si non définie
            if (settings.compactMode === undefined) {
                settings.compactMode = true;
            }
        }
        
        const savedTheme = localStorage.getItem('fitfuel_theme');
        if (savedTheme) theme = savedTheme;
        
        const savedCompactMode = localStorage.getItem('fitfuel_compactMode');
        if (savedCompactMode !== null) {
            settings.compactMode = JSON.parse(savedCompactMode);
        } else {
            // Si non défini dans le localStorage, activer par défaut
            settings.compactMode = true;
        }
        
        const savedCurrentTheme = localStorage.getItem('fitfuel_currentTheme');
        if (savedCurrentTheme) currentTheme = savedCurrentTheme;
        
	// Initialiser les valeurs par défaut après chargement
        initializeUserProfile();

    } catch (e) {
        console.error('Erreur lors du chargement depuis localStorage:', e);
        
        // En cas d'erreur, définir les valeurs par défaut pour le profil
        userProfile = {
            firstName: 'John',
            lastName: 'Doe',
            height: 180,
            weight: 75,
            level: 'Intermédiaire',
            trainingType: 'Maintien',
            defaultSets: 3,
            defaultReps: '10',
            defaultWeight: 10,
            defaultRest: 60,
            // --- NOUVEAUX CHAMPS PAR DÉFAUT ---
            gender: 'male',
            age: 30,
            bodyFat: 20,
            weeklyWeightChange: 0,
            lastTrainingType: 'Maintien',
            leanMass: 60, // 80% de 75kg
            macroPercentages: {
                protein: 30,
                carbs: 40,
                fat: 30
            }
            // --- FIN NOUVEAUX CHAMPS ---
        };
        
        // Activer le mode compact par défaut en cas d'erreur
        settings.compactMode = true;
        
        // Initialiser les autres tableaux vides
        customExercises = [];
        customFoods = [];
        customWorkouts = [];
        workoutHistory = [];
        nutritionHistory = [];
        dailyNutrition = { calories: 0, protein: 0, carbs: 0, fat: 0, meals: [] };
        
        // Afficher une notification d'erreur
        setTimeout(() => {
            showNotification('Erreur de chargement des données. Profil réinitialisé.', 'error');
        }, 1000);
    }
    
    // Log de débogage pour vérifier le chargement
    console.log('📦 Données chargées:', {
        profil: {
            nom: `${userProfile.firstName} ${userProfile.lastName}`,
            poids: userProfile.weight,
            bodyFat: userProfile.bodyFat,
            masseMaigre: userProfile.leanMass
        },
        exercices: customExercises.length,
        aliments: customFoods.length,
        séances: customWorkouts.length,
        historiqueSéances: workoutHistory.length,
        historiqueNutrition: nutritionHistory.length,
        repasDuJour: dailyNutrition.meals.length,
        modeCompact: settings.compactMode
    });
}

function initializeUserProfile() {
    // Valeurs par défaut COMPLÈTES et SCIENTIFIQUES
    const defaultProfile = {
        firstName: 'John',
        lastName: 'Doe',
        height: 180,
        weight: 75,
        level: 'Intermédiaire',
        trainingType: 'Maintien',
        defaultSets: 3,
        defaultReps: '10',
        defaultWeight: 10,
        defaultRest: 60,
        gender: 'male',
        age: 30,
        bodyFat: 20,
        weeklyWeightChange: 0,
        lastTrainingType: 'Maintien',
        lastTrainingPhase: 'Maintien',
        
        // Calculs BMR/Maintenance
        bmr: 1746,
        pal: 1.55,
        maintenanceCalories: 2706,
        
        // Masse maigre
        leanMass: 60,
        
        // Objectifs nutritionnels (homme 30 ans, 75kg, 20% BF, Intermédiaire, Maintien)
        calorieNeeds: 2706,
        proteinNeeds: 158,  // 2.2g/kg LBM × 60kg × 1.2 (marge)
        carbsNeeds: 339,    // ~50% des calories
        fatNeeds: 75,      // ~25% des calories
        
        // Pourcentages macros
        macroPercentages: {
            protein: 23,
            carbs: 50,
            fat: 27
        }
    };
    
    // Fusionner avec le profil existant
    userProfile = { ...defaultProfile, ...userProfile };
    
    // Recalculer la masse maigre si nécessaire
    if (!userProfile.leanMass || isNaN(userProfile.leanMass) || userProfile.leanMass === 0) {
        if (userProfile.weight && userProfile.bodyFat) {
            userProfile.leanMass = Math.round((userProfile.weight * (1 - (userProfile.bodyFat / 100))) * 10) / 10;
        } else {
            userProfile.leanMass = userProfile.weight * 0.8;
        }
    }
    
    // S'assurer que tous les champs numériques sont des nombres
    userProfile.calorieNeeds = Number(userProfile.calorieNeeds) || defaultProfile.calorieNeeds;
    userProfile.proteinNeeds = Number(userProfile.proteinNeeds) || defaultProfile.proteinNeeds;
    userProfile.carbsNeeds = Number(userProfile.carbsNeeds) || defaultProfile.carbsNeeds;
    userProfile.fatNeeds = Number(userProfile.fatNeeds) || defaultProfile.fatNeeds;
    userProfile.bmr = Number(userProfile.bmr) || defaultProfile.bmr;
    userProfile.pal = Number(userProfile.pal) || defaultProfile.pal;
    userProfile.maintenanceCalories = Number(userProfile.maintenanceCalories) || defaultProfile.maintenanceCalories;
    
    // S'assurer que les pourcentages de macros existent
    if (!userProfile.macroPercentages) {
        userProfile.macroPercentages = { ...defaultProfile.macroPercentages };
    }
    
    // S'assurer que chaque pourcentage est défini
    if (!userProfile.macroPercentages.protein) userProfile.macroPercentages.protein = defaultProfile.macroPercentages.protein;
    if (!userProfile.macroPercentages.carbs) userProfile.macroPercentages.carbs = defaultProfile.macroPercentages.carbs;
    if (!userProfile.macroPercentages.fat) userProfile.macroPercentages.fat = defaultProfile.macroPercentages.fat;
}

function saveToLocalStorage() {
    try {
        localStorage.setItem('fitfuel_userProfile', JSON.stringify(userProfile));
        localStorage.setItem('fitfuel_customExercises', JSON.stringify(customExercises));
        localStorage.setItem('fitfuel_customFoods', JSON.stringify(customFoods));
        localStorage.setItem('fitfuel_customWorkouts', JSON.stringify(customWorkouts));
        localStorage.setItem('fitfuel_workoutHistory', JSON.stringify(workoutHistory));
        localStorage.setItem('fitfuel_nutritionHistory', JSON.stringify(nutritionHistory));
        localStorage.setItem('fitfuel_dailyNutrition', JSON.stringify(dailyNutrition));
        localStorage.setItem('fitfuel_settings', JSON.stringify(settings));
        localStorage.setItem('fitfuel_theme', theme);
        localStorage.setItem('fitfuel_compactMode', JSON.stringify(settings.compactMode));
	localStorage.setItem('fitfuel_currentTheme', currentTheme);
    } catch (e) {
        console.error('Erreur lors de la sauvegarde dans localStorage:', e);
	    }
}

// Nouvelle fonction pour mettre à jour la case à cocher
function updateCompactModeCheckbox() {
    const checkbox = document.getElementById('compact-mode-toggle');
    if (checkbox) {
        checkbox.checked = settings.compactMode;
    }
}

// ==================== GESTION DE L'INTERFACE ====================
function showScreen(screenId) {
    // Vérifier si une séance est en cours
    if (activeWorkout && screenId !== 'active-workout-screen' && currentScreen === 'active-workout-screen') {
        // AJOUTER UNE EXCEPTION POUR L'HISTORIQUE
        if (screenId === 'history-screen') {
            // Demander confirmation pour quitter la séance
            if (confirm('Quitter la séance en cours pour aller à l\'historique ?')) {
                completeWorkout();
                // Continuer pour afficher l'historique
            } else {
                return; // Annuler le changement
            }
        } else {
            showModal('exit-confirm-modal');
            return;
        }
    }
    
    // Masquer tous les écrans
    document.querySelectorAll('.screen').forEach(screen => {
        screen.classList.remove('active');
    });
    
    // Afficher l'écran demandé
    document.getElementById(screenId).classList.add('active');
    currentScreen = screenId;
    
    // Mettre à jour la navbar
    updateNavbar();
    
    // Actions spécifiques par écran
    switch(screenId) {
        case 'home-screen':
            loadMuscleGroups();
            updateRecommendedPrograms();
            break;
        case 'exercises-screen':
            loadExercises();
            loadFoods();
            updateAdvancedSearchDisplay();
            break;
        case 'workouts-screen':
            loadCustomWorkouts();
            loadPredefinedWorkouts();
            loadFavoriteExercises();
            break;
        case 'history-screen':
            loadWorkoutHistory();
            // loadNutritionHistory(); // ← SUPPRIMÉ
            // À la place, s'assurer que l'historique nutritionnel est initialisé
            if (!document.getElementById('nutrition-history-day').innerHTML) {
                loadNutritionHistoryData('day');
            }
            break;
        case 'nutrition-screen':
            updateDailyNutritionDisplay();
            updateFavoriteFoods();
            break;
    }
}

function updateNavbar() {
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
    });
    
    let activeNavItem = null;
    switch(currentScreen) {
        case 'home-screen': activeNavItem = 0; break;
        case 'workouts-screen': activeNavItem = 1; break;
        case 'exercises-screen': activeNavItem = 2; break;
        case 'nutrition-screen': activeNavItem = 3; break;  // Nutrition = 3ème position
        case 'history-screen': activeNavItem = 4; break;    // Historique = 4ème position
        case 'active-workout-screen': activeNavItem = null; break;
        case 'profile-screen': activeNavItem = null; break;
    }
    
    if (activeNavItem !== null) {
        document.querySelectorAll('.nav-item')[activeNavItem].classList.add('active');
    }
}

function showModal(modalId) {
    const modal = document.getElementById(modalId);
    if (!modal) {
        console.error('Modal non trouvé:', modalId);
        return;
    }
    
    const openModals = document.querySelectorAll('.modal.active').length;
    modal.style.zIndex = 2000 + (openModals * 100);
    modal.classList.add('active');
}

function hideModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('active');
        
        // Retirer les classes d'animation spécifiques
        modal.classList.remove('nutrition-return-transition');
        modal.classList.remove('nutrition-page-enter');
        modal.classList.remove('modal-exit-to-workouts'); // AJOUTER CETTE LIGNE
        modal.classList.remove('workouts-screen-enter');  // AJOUTER CETTE LIGNE

        // Réinitialiser le z-index pour éviter l'accumulation
        modal.style.zIndex = '';
    }
}

function showNotification(message, type = 'success', duration = 3000) {
    const notification = document.createElement('div');
    notification.className = `temp-notification ${type}`;
    
    // Permettre le HTML dans les notifications
    notification.innerHTML = message;
    
    document.body.appendChild(notification);
    
    // Jouer un son selon le type de notification
    switch(type) {
        case 'success':
            playSound('success');
            vibrate([50]);
            break;
        case 'error':
            playSound('beep');
            vibrate([200, 100, 200]);
            break;
        case 'warning':
            playSound('beep');
            vibrate([300]);
            break;
        case 'info':
            playSound('beep');
            vibrate([100]);
            break;
    }
    
    setTimeout(() => {
        notification.classList.add('hiding');
        setTimeout(() => {
            if (document.body.contains(notification)) {
                document.body.removeChild(notification);
            }
        }, 300);
    }, duration);
}

// ==================== GESTION DU THÈME ====================
function checkAndApplyTheme() {
    // Appliquer le thème de couleur
    document.body.className = document.body.className.replace(/\btheme-\w+\b/g, '');
    if (currentTheme !== 'default') {
        document.body.classList.add(`theme-${currentTheme}`);
    }
    
    // Appliquer le mode sombre
    if (settings.darkMode) {
        document.body.classList.add('dark-mode');
        theme = 'dark';
        document.getElementById('dark-mode-toggle').checked = true;
    } else {
        document.body.classList.remove('dark-mode');
        theme = 'light';
        document.getElementById('dark-mode-toggle').checked = false;
    }
    
    // Cocher la case du mode compact si activé
    document.getElementById('compact-mode-toggle').checked = settings.compactMode;
    
    // S'assurer que la case du mode compact est à jour
    updateCompactModeCheckbox();
    
    // CORRECTION : Mettre à jour immédiatement la couleur des selects
    setTimeout(() => {
        updateSelectsForDarkMode();
    }, 50);
}

// Fonction pour mettre à jour la couleur des selects selon le mode
function updateSelectsForDarkMode() {
    const selects = document.querySelectorAll('.filter-select');
    selects.forEach(select => {
        if (settings.darkMode) {
            // Mode sombre : texte blanc, flèche blanche
            select.style.color = '#ffffff';
            
            // Ne PAS toucher au background-image depuis JavaScript
            // Laisser le CSS s'en occuper
        } else {
            // Mode clair : texte noir
            select.style.color = '#000000';
            
            // Réinitialiser l'icône en mode clair
            select.style.backgroundImage = '';
        }
        
        // Forcer l'affichage
        select.style.setProperty('color', settings.darkMode ? '#ffffff' : '#000000', 'important');
    });
}

function toggleTheme() {
    settings.darkMode = !settings.darkMode;
    checkAndApplyTheme();
    saveToLocalStorage();
    showNotification(settings.darkMode ? 'Mode sombre activé' : 'Mode clair activé');
}

function toggleDarkModeSetting(checked) {
    settings.darkMode = checked;
    checkAndApplyTheme();
    saveToLocalStorage();
    
    // Mettre à jour les selects après changement de mode
    setTimeout(() => {
        updateSelectsForDarkMode();
    }, 100);
    
    showNotification(settings.darkMode ? 'Mode sombre activé' : 'Mode clair activé');
}

// ==================== GESTION DU PROFIL ====================
function updateAvatarInitials() {
    const firstName = document.getElementById('profile-firstname').value || 'J';
    const lastName = document.getElementById('profile-lastname').value || 'D';
    const initials = (firstName.charAt(0) + lastName.charAt(0)).toUpperCase();
    
    document.getElementById('user-avatar').textContent = initials;
    document.getElementById('profile-avatar').textContent = initials;
    document.getElementById('profile-name').textContent = `${firstName} ${lastName}`;
    
    userProfile.firstName = firstName;
    userProfile.lastName = lastName;
}

// ==================== CALCUL NUTRITIONNEL SCIENTIFIQUE ====================
function calculateNutritionNeeds() {
    // -----------------------
    // 1. RÉCUPÉRATION DES DONNÉES
    // -----------------------
    const height = parseFloat(document.getElementById('profile-height-input').value) || userProfile.height || 180;
    const weight = parseFloat(document.getElementById('profile-weight-input').value) || userProfile.weight || 75;
    const age = parseInt(document.getElementById('profile-age-input')?.value) || userProfile.age || 30;
    const gender = document.getElementById('profile-gender-input')?.value || userProfile.gender || 'male';
    const bodyFat = parseFloat(document.getElementById('profile-bodyfat-input')?.value) || userProfile.bodyFat || 20;
    const weeklyWeightChange = parseFloat(document.getElementById('profile-weekly-change-input')?.value) || userProfile.weeklyWeightChange || 0;
    const level = document.getElementById('profile-level-input').value;
    const trainingType = document.getElementById('profile-type-input').value;
    
    // -----------------------
    // 2. SAUVEGARDE DES VALEURS BRUTES
    // -----------------------
    userProfile.height = height;
    userProfile.weight = weight;
    userProfile.age = age;
    userProfile.gender = gender;
    userProfile.bodyFat = bodyFat;
    userProfile.weeklyWeightChange = weeklyWeightChange;
    userProfile.level = level;
    userProfile.trainingType = trainingType;
    
    // -----------------------
    // 3. CALCUL DE LA MASSE MAIGRE (LEAN BODY MASS)
    // -----------------------
    const lbm = weight * (1 - (bodyFat / 100));
    userProfile.leanMass = Math.round(lbm * 10) / 10;
    
    // -----------------------
    // 4. IMC (affichage uniquement)
    // -----------------------
    const heightInMeters = height / 100;
    const bmi = weight / (heightInMeters * heightInMeters);
    let category = '';
    if (bmi < 18.5) category = 'Maigreur';
    else if (bmi < 25) category = 'Normal';
    else if (bmi < 30) category = 'Surpoids';
    else category = 'Obésité';
    
    // -----------------------
    // 5. BMR - MÉTHODE ADAPTÉE AU PROFIL
    // -----------------------
    let bmr = 0;
    
    // SI BODYFAT DISPONIBLE → Katch-McArdle (précision ±200 kcal)
    if (bodyFat > 0 && bodyFat < 50) {
        bmr = 370 + (21.6 * lbm);
        
        // Correction pour les femmes : -5% à masse maigre égale
        if (gender === 'female') {
            bmr = bmr * 0.95;
        }
    } 
    // SINON → Mifflin-St Jeor (formule générale)
    else {
        if (gender === 'male') {
            bmr = (10 * weight) + (6.25 * height) - (5 * age) + 5;
        } else {
            bmr = (10 * weight) + (6.25 * height) - (5 * age) - 161;
        }
    }
    
    // -----------------------
    // 6. FACTEUR D'ACTIVITÉ PHYSIQUE (PAL) - PRÉCIS
    // -----------------------
    let pal = 1.2; // Sédentaire par défaut
    
    switch(level) {
        case 'Débutant complet': pal = 1.2; break;      // 0-1 séance/semaine
        case 'Débutant': pal = 1.375; break;           // 1-2 séances/semaine
        case 'Intermédiaire débutant': pal = 1.475; break; // 2-3 séances
        case 'Intermédiaire': pal = 1.55; break;       // 3-4 séances
        case 'Intermédiaire avancé': pal = 1.675; break; // 4-5 séances
        case 'Avancé': pal = 1.725; break;             // 5-6 séances
        case 'Expert': pal = 1.85; break;              // 6-7 séances INTENSES
        case 'Professionnel': pal = 2.0; break;        // 2 séances/JOUR
    }
    
    const maintenanceCalories = Math.round(bmr * pal);
    
    // -----------------------
    // 7. AJUSTEMENT SELON OBJECTIF (SANS progression hebdo)
    // -----------------------
    let calorieTarget = maintenanceCalories;
    let deficitSurplus = 0;
    let phase = '';
    
    switch(trainingType) {
        case 'Perte de poids':
            // Déficit PROGRESSIF selon le bodyfat
            if (bodyFat > 30) {
                deficitSurplus = -0.30; // -30% (obésité)
                phase = 'Déficit agressif';
            } else if (bodyFat > 25) {
                deficitSurplus = -0.25; // -25% (surpoids)
                phase = 'Déficit modéré';
            } else if (bodyFat > 20) {
                deficitSurplus = -0.20; // -20% (normal-haut)
                phase = 'Déficit standard';
            } else if (bodyFat > 15) {
                deficitSurplus = -0.15; // -15% (normal-bas)
                phase = 'Déficit léger';
            } else if (bodyFat > 12) {
                deficitSurplus = -0.10; // -10% (sec)
                phase = 'Déficit conservateur';
            } else {
                deficitSurplus = -0.05; // -5% (très sec)
                phase = 'Déficit minimal';
            }
            calorieTarget = Math.round(maintenanceCalories * (1 + deficitSurplus));
            break;
            
        case 'Force pure':
        case 'Force':
            deficitSurplus = 0.05; // +5% surplus modéré
            phase = 'Surplus léger (force)';
            calorieTarget = Math.round(maintenanceCalories * (1 + deficitSurplus));
            break;
            
        case 'Hypertrophie':
        case 'Volume musculaire':
            // LEAN BULK : surplus contrôlé selon bodyfat
            if (bodyFat > 20) {
                deficitSurplus = 0.05; // +5% (prise propre)
                phase = 'Lean bulk conservateur';
            } else if (bodyFat > 15) {
                deficitSurplus = 0.08; // +8% (lean bulk standard)
                phase = 'Lean bulk standard';
            } else if (bodyFat > 12) {
                deficitSurplus = 0.10; // +10% (lean bulk agressif)
                phase = 'Lean bulk agressif';
            } else {
                deficitSurplus = 0.12; // +12% (bulk)
                phase = 'Bulk contrôlé';
            }
            calorieTarget = Math.round(maintenanceCalories * (1 + deficitSurplus));
            break;
            
        case 'Maintien':
            phase = 'Maintien';
            calorieTarget = maintenanceCalories;
            break;
            
        case 'Cardio':
        case 'Endurance musculaire':
            deficitSurplus = 0.02; // +2% pour endurance
            phase = 'Surplus léger (endurance)';
            calorieTarget = Math.round(maintenanceCalories * (1 + deficitSurplus));
            break;
            
        case 'Récupération':
            deficitSurplus = -0.10; // -10% en récupération
            phase = 'Déficit récupération';
            calorieTarget = Math.round(maintenanceCalories * (1 + deficitSurplus));
            break;
            
        case 'Préparation physique':
            deficitSurplus = 0.10; // +10%
            phase = 'Surplus (prépa)';
            calorieTarget = Math.round(maintenanceCalories * (1 + deficitSurplus));
            break;
            
        default:
            calorieTarget = maintenanceCalories;
            phase = 'Maintien';
    }
    
    // Enregistrer la phase pour les recommandations
    userProfile.lastTrainingPhase = phase;
    userProfile.lastTrainingType = trainingType;
    
    // -----------------------
    // 8. APPLICATION DE LA PROGRESSION HEBDOMADAIRE (7700 kcal/kg)
    // -----------------------
    let finalCalories = calorieTarget;
    let progressionMessage = '';
    
    if (weeklyWeightChange !== 0) {
        // 1 kg de masse grasse ≈ 7700 kcal
        const caloriesPerDayAdjustment = (weeklyWeightChange * 7700) / 7;
        
        finalCalories = Math.round(calorieTarget + caloriesPerDayAdjustment);
        
        if (weeklyWeightChange > 0) {
            progressionMessage = `Prise de ${weeklyWeightChange}kg/semaine (+${Math.round(caloriesPerDayAdjustment)} kcal/j)`;
        } else {
            progressionMessage = `Perte de ${Math.abs(weeklyWeightChange)}kg/semaine (${Math.round(caloriesPerDayAdjustment)} kcal/j)`;
        }
    }
    
    // Validation : ne jamais descendre sous 1400 kcal (hommes) / 1200 kcal (femmes)
    const minCalories = gender === 'male' ? 1400 : 1200;
    if (finalCalories < minCalories) {
        finalCalories = minCalories;
        progressionMessage += ' (minimum atteint)';
    }
    
    // -----------------------
    // 9. CALCUL DES PROTÉINES (basé sur MASSE MAIGRE + FACTEUR)
    // -----------------------
    let proteinFactor = 2.2; // Base
    
    // Ajustement selon objectif
    if (trainingType === 'Perte de poids') {
        if (bodyFat > 25) proteinFactor = 2.4; // Préservation musculaire en obésité
        else if (bodyFat > 20) proteinFactor = 2.6; // Sèche modérée
        else proteinFactor = 2.8; // Sèche avancée
    } else if (trainingType === 'Hypertrophie' || trainingType === 'Volume musculaire') {
        proteinFactor = 2.0; // Léger surplus = moins de protéines nécessaires
    } else if (trainingType === 'Force pure' || trainingType === 'Force') {
        proteinFactor = 2.3; // Force nécessite plus de protéines
    } else if (trainingType === 'Maintien') {
        proteinFactor = 1.8; // Maintien
    }
    
    // Ajustement selon âge (+0.1g/kg tous les 10 ans après 40 ans)
    if (age > 40) {
        proteinFactor += Math.floor((age - 40) / 10) * 0.1;
    }
    
    // Ajustement selon sexe (femmes légèrement moins)
    if (gender === 'female') {
        proteinFactor = proteinFactor * 0.95;
    }
    
    const proteinGrams = Math.round(lbm * proteinFactor);
    const caloriesFromProtein = proteinGrams * 4;
    
    // -----------------------
    // 10. CALCUL DES LIPIDES (basé sur POIDS CORPOREL)
    // -----------------------
    let fatPerKg = 0.9; // Base
    
    if (gender === 'female') {
        fatPerKg = 1.0; // Les femmes ont besoin de plus de lipides
    }
    
    if (trainingType === 'Perte de poids') {
        fatPerKg = 0.8; // Légèrement moins en sèche
    } else if (trainingType === 'Hypertrophie') {
        fatPerKg = 0.9; // Standard
    }
    
    // Minimum 20% des calories
    const minFatCalories = finalCalories * 0.20;
    const fatGrams = Math.max(Math.round(lbm * fatPerKg), Math.round(minFatCalories / 9));
    const caloriesFromFat = fatGrams * 9;
    
    // -----------------------
    // 11. GLUCIDES = RESTE DES CALORIES
    // -----------------------
    const caloriesFromCarbs = finalCalories - caloriesFromProtein - caloriesFromFat;
    const carbsGrams = Math.max(0, Math.round(caloriesFromCarbs / 4));
    
    // Recalcul final (ajustement si glucides négatifs)
    const finalCarbsGrams = carbsGrams;
    const finalCaloriesRecalc = caloriesFromProtein + caloriesFromFat + (finalCarbsGrams * 4);
    const finalCaloriesRounded = Math.round(finalCaloriesRecalc);
    
    // -----------------------
    // 12. POURCENTAGES MACROS
    // -----------------------
    const proteinPercentage = Math.round((caloriesFromProtein / finalCaloriesRecalc) * 100);
    const fatPercentage = Math.round((caloriesFromFat / finalCaloriesRecalc) * 100);
    const carbsPercentage = Math.round(((finalCarbsGrams * 4) / finalCaloriesRecalc) * 100);
    
    // -----------------------
    // 13. RECOMMANDATIONS SPÉCIFIQUES
    // -----------------------
    const recommendations = [];
    
    if (trainingType === 'Perte de poids') {
        if (bodyFat > 25) {
            recommendations.push('• Priorité à la préservation musculaire');
            recommendations.push('• Protéines élevées : ' + proteinGrams + 'g/j');
        } else if (bodyFat < 12) {
            recommendations.push('• Phase de sèche avancée : surveiller la faim');
            recommendations.push('• Pause diète recommandée après 8-10 semaines');
        }
        recommendations.push('• Répartition des glucides autour des entraînements');
    }
    
    if (trainingType === 'Hypertrophie' || trainingType === 'Volume musculaire') {
        if (bodyFat > 20) {
            recommendations.push('• Lean bulk : limiter la prise de gras');
            recommendations.push('• Augmentation max 0.3-0.5kg/semaine');
        } else {
            recommendations.push('• Bulk contrôlé : 0.5-0.8kg/semaine');
        }
    }
    
    if (weeklyWeightChange < -0.7) {
        recommendations.push('⚠️ Perte trop rapide (>0.7kg/sem) : risque de fonte musculaire');
    } else if (weeklyWeightChange < -0.5) {
        recommendations.push('• Perte modérée : maintenir protéines élevées');
    } else if (weeklyWeightChange > 0.8) {
        recommendations.push('⚠️ Prise trop rapide (>0.8kg/sem) : risque de gras excessif');
    }
    
    if (gender === 'female' && age > 50) {
        recommendations.push('• Augmenter calcium et vitamine D');
        recommendations.push('• Répartition des protéines sur 3-4 repas');
    }
    
    if (age > 60) {
        recommendations.push('• Protéines : ' + proteinGrams + 'g minimum');
        recommendations.push('• Fractionner en 4 repas pour meilleure assimilation');
    }
    
    // -----------------------
    // 14. MISE À JOUR UI PROFIL
    // -----------------------
    document.getElementById('profile-height').textContent = `${height}cm`;
    document.getElementById('profile-weight').textContent = `${weight}kg`;
    document.getElementById('profile-bmi').textContent = bmi.toFixed(1);
    document.getElementById('profile-category').textContent = category;
    document.getElementById('profile-level').textContent = `${level} • ${trainingType}`;
    document.getElementById('profile-calories').textContent = `${finalCaloriesRounded} kcal`;
    document.getElementById('profile-protein').textContent = `${proteinGrams}g (${proteinPercentage}%)`;
    document.getElementById('profile-carbs').textContent = `${finalCarbsGrams}g (${carbsPercentage}%)`;
    document.getElementById('profile-fat').textContent = `${fatGrams}g (${fatPercentage}%)`;
    
    // Affichage masse maigre
    const leanMassElement = document.getElementById('profile-lean-mass');
    if (leanMassElement) {
        leanMassElement.textContent = `Masse maigre: ${userProfile.leanMass}kg (${(100 - bodyFat).toFixed(1)}%)`;
    }
    
    // Affichage des recommandations
    const recommendationsElement = document.getElementById('profile-recommendations');
    if (recommendationsElement) {
        if (recommendations.length > 0) {
            let headerHTML = `<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                <div style="width: 24px; height: 24px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px;">
                    <i class="fas fa-check"></i>
                </div>
                <div style="font-weight: 700; color: var(--primary);">RECOMMANDATIONS</div>
            </div>`;
            
            if (progressionMessage) {
                recommendationsElement.innerHTML = headerHTML + recommendations.join('<br>') + 
                    `<br><span style="color: var(--success);">• ${progressionMessage}</span>`;
            } else {
                recommendationsElement.innerHTML = headerHTML + recommendations.join('<br>');
            }
            
            recommendationsElement.style.display = 'block';
        } else {
            if (progressionMessage) {
                recommendationsElement.innerHTML = `<span style="color: var(--success);">${progressionMessage}</span>`;
                recommendationsElement.style.display = 'block';
            } else {
                recommendationsElement.style.display = 'none';
            }
        }
    }
    
    // -----------------------
    // 15. SAUVEGARDE PROFIL UTILISATEUR
    // -----------------------
    userProfile.calorieNeeds = finalCaloriesRounded;
    userProfile.proteinNeeds = proteinGrams;
    userProfile.carbsNeeds = finalCarbsGrams;
    userProfile.fatNeeds = fatGrams;
    
    userProfile.macroPercentages = {
        protein: proteinPercentage,
        carbs: carbsPercentage,
        fat: fatPercentage
    };
    
    userProfile.bmr = Math.round(bmr);
    userProfile.pal = pal;
    userProfile.maintenanceCalories = maintenanceCalories;
    
    // -----------------------
    // 16. LOGS DE DÉBOGAGE
    // -----------------------
    console.log('📊 CALCUL NUTRITIONNEL SCIENTIFIQUE');
    console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
    console.log(`👤 Profil: ${gender === 'male' ? 'Homme' : 'Femme'}, ${age} ans, ${weight}kg, ${bodyFat}% BF, LBM: ${userProfile.leanMass}kg`);
    console.log(`🧮 BMR: ${Math.round(bmr)} kcal (${bodyFat ? 'Katch-McArdle' : 'Mifflin-St Jeor'})`);
    console.log(`🏋️ PAL: ${pal} (${level})`);
    console.log(`⚖️ Maintenance: ${maintenanceCalories} kcal`);
    console.log(`🎯 Objectif: ${trainingType} | Phase: ${phase}`);
    console.log(`📉 Progression: ${weeklyWeightChange}kg/semaine → ${progressionMessage || 'Aucune'}`);
    console.log(`🔥 Calories finales: ${finalCaloriesRounded} kcal`);
    console.log(`🥩 Protéines: ${proteinGrams}g (${proteinPercentage}%) - ${proteinFactor.toFixed(1)}g/kg LBM`);
    console.log(`🧈 Lipides: ${fatGrams}g (${fatPercentage}%)`);
    console.log(`🍚 Glucides: ${finalCarbsGrams}g (${carbsPercentage}%)`);
    console.log(`📋 Recommandations: ${recommendations.length || 'Aucune'}`);
    
    // -----------------------
    // 17. MISE À JOUR INTERFACE NUTRITION
    // -----------------------
    updateDailyNutritionDisplay();
    saveToLocalStorage();
}

function saveProfile() {
    // Récupérer les valeurs des champs par défaut
    userProfile.defaultSets = parseInt(document.getElementById('profile-default-sets').value) || 3;
    userProfile.defaultReps = document.getElementById('profile-default-reps').value || '10';
    userProfile.defaultWeight = parseFloat(document.getElementById('profile-default-weight').value) || 10;
    userProfile.defaultRest = parseInt(document.getElementById('profile-default-rest').value) || 60;
    
    // Mettre à jour le nom complet pour l'avatar
    userProfile.firstName = document.getElementById('profile-firstname').value || userProfile.firstName;
    userProfile.lastName = document.getElementById('profile-lastname').value || userProfile.lastName;
    
    // Calculer les besoins nutritionnels
    calculateNutritionNeeds();
    
    showNotification('Profil sauvegardé avec succès !');
    saveToLocalStorage();
    
    // AJOUTER CETTE LIGNE : Revenir à l'écran d'accueil
    showScreen('home-screen');
}

function resetProfile() {
    if (confirm('Voulez-vous vraiment réinitialiser votre profil aux valeurs par défaut ?')) {
        userProfile = {
            firstName: 'John',
            lastName: 'Doe',
            height: 180,
            weight: 75,
            level: 'Intermédiaire',
            trainingType: 'Maintien',
            defaultSets: 3,
            defaultReps: '10',
            defaultWeight: 10,
            defaultRest: 60
        };
        
        document.getElementById('profile-firstname').value = userProfile.firstName;
        document.getElementById('profile-lastname').value = userProfile.lastName;
        document.getElementById('profile-height-input').value = userProfile.height;
        document.getElementById('profile-weight-input').value = userProfile.weight;
        document.getElementById('profile-level-input').value = userProfile.level;
        document.getElementById('profile-type-input').value = userProfile.trainingType;
        document.getElementById('profile-default-sets').value = userProfile.defaultSets;
        document.getElementById('profile-default-reps').value = userProfile.defaultReps;
        document.getElementById('profile-default-weight').value = userProfile.defaultWeight;
        document.getElementById('profile-default-rest').value = userProfile.defaultRest;
        
        calculateNutritionNeeds();
        showNotification('Profil réinitialisé');
        saveToLocalStorage();
        
        // AJOUTER CETTE LIGNE : Revenir à l'écran d'accueil
        showScreen('home-screen');
    }
}

// ==================== GESTION DES EXERCICES ====================
function loadMuscleGroups() {
    const container = document.getElementById('muscle-grid-container');
    if (!container) return;
    
    container.innerHTML = '';
    
    muscleGroups.forEach(muscle => {
        // Compter le nombre d'exercices pour ce groupe musculaire
        const exerciseCount = getAllExercises().filter(ex => ex.muscleGroup === muscle.id).length;
        
        const muscleCard = document.createElement('div');
        muscleCard.className = 'muscle-card';
        muscleCard.style.background = `linear-gradient(135deg, ${muscle.color}, ${adjustColor(muscle.color, -20)})`;
        muscleCard.onclick = () => {
            showExerciseTab('exercises');
            document.getElementById('muscle-filter').value = muscle.id;
            filterExercises();
            showScreen('exercises-screen');
        };
        
        muscleCard.innerHTML = `
            <div class="muscle-name">${muscle.name}</div>
            <div class="exercise-count">
                <span>${exerciseCount} exercices</span>
                <span>${muscle.image}</span>
            </div>
        `;
        
        container.appendChild(muscleCard);
    });
}

function adjustColor(color, amount) {
    // Fonction simple pour ajuster la luminosité d'une couleur
    return '#' + color.replace(/^#/, '').replace(/../g, color => 
        ('0' + Math.min(255, Math.max(0, parseInt(color, 16) + amount)).toString(16)).substr(-2)
    );
}

function getAllExercises() {
    return [...exercises, ...customExercises];
}

function loadExercises() {
    const exerciseList = document.getElementById('exercises-list');
    const muscleFilter = document.getElementById('muscle-filter');
    const searchInput = document.getElementById('search-input');
    
    if (!exerciseList) return;
    
    // Mettre à jour le filtre des groupes musculaires
    if (muscleFilter) {
        muscleFilter.innerHTML = '<option value="all">Tous les exercices</option>';
        muscleGroups.forEach(muscle => {
            const option = document.createElement('option');
            option.value = muscle.id;
            option.textContent = muscle.name;
            muscleFilter.appendChild(option);
        });
        
        // Mettre la valeur sélectionnée si un filtre est actif
        if (exerciseSearchFilter !== 'all') {
            muscleFilter.value = exerciseSearchFilter;
        }
    }
    
    // Filtrer les exercices
    let filteredExercises = getAllExercises();
    
    // Appliquer le filtre de groupe musculaire ou spéciaux
    if (exerciseSearchFilter !== 'all') {
        if (exerciseSearchFilter === 'custom') {
            filteredExercises = filteredExercises.filter(ex => ex.custom);
        } else if (exerciseSearchFilter === 'favorites') {
            filteredExercises = filteredExercises.filter(ex => ex.favorite);
        } else {
            filteredExercises = filteredExercises.filter(ex => ex.muscleGroup === exerciseSearchFilter);
        }
    }
    
    // Appliquer la recherche textuelle
    if (searchInput && searchInput.value) {
        const searchTerm = searchInput.value.toLowerCase();
        filteredExercises = filteredExercises.filter(ex => 
            ex.name.toLowerCase().includes(searchTerm) ||
            ex.muscleGroup.toLowerCase().includes(searchTerm) ||
            (ex.equipment && ex.equipment.some(eq => eq.toLowerCase().includes(searchTerm))) ||
            ex.difficulty.toLowerCase().includes(searchTerm)
        );
    }
    
    // Appliquer les filtres avancés
    filteredExercises = applyAdvancedExerciseFilters(filteredExercises);
    
    // Trier par nom
    filteredExercises.sort((a, b) => a.name.localeCompare(b.name));

    // Trier pour montrer d'abord les favoris
    filteredExercises.sort((a, b) => {
        if (a.favorite && !b.favorite) return -1;
        if (!a.favorite && b.favorite) return 1;
        return a.name.localeCompare(b.name);
    });
    
    // Afficher les exercices
    exerciseList.innerHTML = '';
    
    if (filteredExercises.length === 0) {
        exerciseList.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">🏋️‍♂️</div>
                <p>Aucun exercice trouvé</p>
                <button class="btn btn-success mt-4" onclick="showCustomExerciseModal()">Créer un exercice</button>
            </div>
        `;
        return;
    }
    
    filteredExercises.forEach(exercise => {
        const muscle = muscleGroups.find(m => m.id === exercise.muscleGroup);
        const exerciseItem = document.createElement('div');
        exerciseItem.className = 'exercise-item';
        
        // Badge de difficulté avec couleur
        let difficultyClass = '';
        switch(exercise.difficulty) {
            case 'Débutant': difficultyClass = 'difficulty-beginner'; break;
            case 'Intermédiaire': difficultyClass = 'difficulty-intermediate'; break;
            case 'Avancé': difficultyClass = 'difficulty-advanced'; break;
        }
        
        exerciseItem.innerHTML = `
            <div class="exercise-content" onclick="showExerciseDetail('${exercise.id}', ${exercise.custom})">
                <div class="exercise-name">${exercise.name}</div>
                <div class="exercise-muscle">
                    <span style="color: ${muscle ? muscle.color : '#666'}">●</span>
                    ${muscle ? muscle.name : exercise.muscleGroup}
                    ${exercise.custom ? ' (Personnalisé)' : ''}
                </div>
            </div>
            <div class="exercise-actions">
                <span class="exercise-difficulty-badge ${difficultyClass}">${exercise.difficulty}</span>
                <button class="action-btn" onclick="toggleExerciseFavorite('${exercise.id}', ${exercise.custom})" title="${exercise.favorite ? 'Retirer des favoris' : 'Ajouter aux favoris'}">
                    <i class="fas ${exercise.favorite ? 'fa-star' : 'fa-star'}"></i>
                </button>
                ${exercise.custom ? `
                    <button class="action-btn" onclick="editCustomExercise('${exercise.id}')" title="Modifier">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="action-btn" onclick="deleteCustomExercise('${exercise.id}')" title="Supprimer">
                        <i class="fas fa-trash"></i>
                    </button>
                ` : ''}
                <button class="action-btn" onclick="addToWorkout('${exercise.id}')" title="Ajouter à une séance">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        `;
        
        exerciseList.appendChild(exerciseItem);
    });
}

// ==================== FICHE DÉTAILLÉE EXERCICE ====================
function showExerciseDetail(exerciseId, isCustom) {
    let exercise;
    
    if (isCustom) {
        exercise = customExercises.find(ex => ex.id === exerciseId);
    } else {
        // Chercher d'abord dans les exercices personnalisés (pour les favoris)
        exercise = customExercises.find(ex => ex.originalId === exerciseId);
        if (!exercise) {
            exercise = exercises.find(ex => ex.id === exerciseId);
        }
    }
    
    if (!exercise) {
        showNotification('Exercice non trouvé', 'error');
        return;
    }
    
    // Récupérer les données complètes depuis data.js si disponibles
    let fullExerciseData = null;
    if (!isCustom && exercise.originalId) {
        fullExerciseData = exercises.find(ex => ex.id === exercise.originalId);
    } else if (!isCustom) {
        fullExerciseData = exercise;
    }
    
    // Si on a des données complètes, les utiliser, sinon utiliser l'exercice de base
    const displayExercise = fullExerciseData || exercise;
    
    // Trouver le groupe musculaire
    const muscle = muscleGroups.find(m => m.id === displayExercise.muscleGroup);
    
    // Préparer le contenu HTML premium
    let contentHTML = `
        <div class="exercise-detail-header">
            <div class="exercise-detail-icon">
                <i class="fas fa-dumbbell"></i>
            </div>
            <div class="exercise-detail-title">${displayExercise.name}</div>
            <div class="exercise-detail-subtitle">
                <span class="exercise-muscle-badge">${muscle ? muscle.name : displayExercise.muscleGroup}</span>
                <span class="exercise-difficulty-badge ${displayExercise.difficulty.toLowerCase().includes('débutant') ? 'difficulty-beginner' : displayExercise.difficulty.toLowerCase().includes('intermédiaire') ? 'difficulty-intermediate' : 'difficulty-advanced'}">
                    ${displayExercise.difficulty}
                </span>
                ${displayExercise.category ? `<span class="exercise-category-badge">${displayExercise.category}</span>` : ''}
            </div>
        </div>
        
        ${displayExercise.description ? `
            <div class="exercise-detail-section">
                <div class="exercise-detail-section-title">
                    <i class="fas fa-align-left"></i> Description
                </div>
                <div class="exercise-detail-description">
                    ${displayExercise.description}
                </div>
            </div>
        ` : ''}
        
        <div class="exercise-detail-section">
            <div class="exercise-detail-section-title">
                <i class="fas fa-chart-bar"></i> Informations
            </div>
            <div class="exercise-detail-grid">
                <div class="exercise-detail-stat">
                    <div class="exercise-detail-stat-value">${muscle ? muscle.name : displayExercise.muscleGroup}</div>
                    <div class="exercise-detail-stat-label">Groupe Musculaire</div>
                </div>
                
                <div class="exercise-detail-stat">
                    <div class="exercise-detail-stat-value">${displayExercise.difficulty}</div>
                    <div class="exercise-detail-stat-label">Niveau</div>
                </div>
                
                ${displayExercise.category ? `
                    <div class="exercise-detail-stat">
                        <div class="exercise-detail-stat-value">${displayExercise.category}</div>
                        <div class="exercise-detail-stat-label">Catégorie</div>
                    </div>
                ` : ''}
                
                ${displayExercise.equipment && displayExercise.equipment.length > 0 ? `
                    <div class="exercise-detail-stat">
                        <div class="exercise-detail-stat-value">${displayExercise.equipment.length}</div>
                        <div class="exercise-detail-stat-label">Équipements</div>
                    </div>
                ` : ''}
            </div>
        </div>
        
        ${displayExercise.equipment && displayExercise.equipment.length > 0 ? `
            <div class="exercise-detail-section">
                <div class="exercise-detail-section-title">
                    <i class="fas fa-tools"></i> Équipement requis
                </div>
                <div class="exercise-detail-equipment-list">
                    ${displayExercise.equipment.map(eq => `
                        <div class="exercise-detail-equipment-item">
                            <i class="fas fa-dumbbell"></i> ${eq}
                        </div>
                    `).join('')}
                </div>
            </div>
        ` : ''}
        
        ${displayExercise.instructions ? `
            <div class="exercise-detail-section">
                <div class="exercise-detail-section-title">
                    <i class="fas fa-graduation-cap"></i> Instructions d'exécution
                </div>
                <div class="exercise-detail-description">
                    ${displayExercise.instructions}
                </div>
            </div>
        ` : ''}
        
        ${displayExercise.tips ? `
            <div class="exercise-detail-section">
                <div class="exercise-detail-section-title">
                    <i class="fas fa-lightbulb"></i> Conseils & Astuces
                </div>
                <div class="exercise-detail-description">
                    ${displayExercise.tips}
                </div>
            </div>
        ` : ''}
        
        ${displayExercise.commonMistakes ? `
            <div class="exercise-detail-section">
                <div class="exercise-detail-section-title">
                    <i class="fas fa-exclamation-triangle"></i> Erreurs courantes
                </div>
                <div class="exercise-detail-description">
                    ${displayExercise.commonMistakes}
                </div>
            </div>
        ` : ''}
        
        ${displayExercise.variations ? `
            <div class="exercise-detail-section">
                <div class="exercise-detail-section-title">
                    <i class="fas fa-exchange-alt"></i> Variations
                </div>
                <div class="exercise-detail-description">
                    ${displayExercise.variations}
                </div>
            </div>
        ` : ''}
    `;
    
    // Bouton vidéo si disponible
    if (displayExercise.videoUrl) {
        contentHTML += `
            <button class="exercise-detail-video-btn" onclick="window.open('${displayExercise.videoUrl}', '_blank')">
                <i class="fab fa-youtube"></i> Voir la vidéo démo
            </button>
        `;
    }
    
    // Actions
    contentHTML += `
        <div class="exercise-detail-actions">
            <button class="btn btn-success" onclick="addToWorkout('${exercise.id}')" style="flex: 2;">
                <i class="fas fa-plus"></i> Ajouter à une séance
            </button>
            <button class="btn ${exercise.favorite ? 'btn-warning' : 'btn-secondary'}" onclick="toggleExerciseFavorite('${exercise.id}', ${isCustom})" style="flex: 1;">
                <i class="fas ${exercise.favorite ? 'fa-star' : 'fa-star'}"></i>
            </button>
        </div>
        
        ${isCustom ? `
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button class="btn btn-secondary" onclick="editCustomExercise('${exercise.id}')" style="flex: 1;">
                    <i class="fas fa-edit"></i> Modifier
                </button>
                <button class="btn btn-danger" onclick="deleteCustomExercise('${exercise.id}')" style="flex: 1;">
                    <i class="fas fa-trash"></i> Supprimer
                </button>
            </div>
        ` : ''}
    `;
    
    // Afficher le modal
    document.getElementById('exercise-detail-content').innerHTML = contentHTML;
    document.getElementById('exercise-detail-title').textContent = '📋 Fiche Exercice';
    showModal('exercise-detail-modal');
}

function filterExercises() {
    const searchInput = document.getElementById('search-input');
    const muscleFilter = document.getElementById('muscle-filter');
    
    exerciseSearchFilter = muscleFilter ? muscleFilter.value : 'all';
    loadExercises();
}

function setMuscleFilter(value) {
    exerciseSearchFilter = value;
    // MODIFICATION
    if (value === 'custom' || value === 'favorites') {
        // Ce sont des filtres spéciaux, pas des groupes musculaires
        loadExercises();
    } else {
        filterExercises();
    }
}

function showExerciseTab(tab) {
    document.getElementById('exercise-tab').classList.toggle('hidden', tab !== 'exercises');
    document.getElementById('food-tab').classList.toggle('hidden', tab !== 'foods');
    
    document.querySelectorAll('#exercises-screen .radio-tab').forEach((btn, index) => {
        btn.classList.toggle('active', (tab === 'exercises' && index === 0) || (tab === 'foods' && index === 1));
    });
    
    if (tab === 'exercises') {
        loadExercises();
    } else if (tab === 'foods') {
        loadFoods();
    }
}

function showCustomExerciseModal() {
    const muscleSelect = document.getElementById('custom-exercise-muscle');
    muscleSelect.innerHTML = '<option value="">Sélectionner un groupe</option>';
    muscleGroups.forEach(muscle => {
        const option = document.createElement('option');
        option.value = muscle.id;
        option.textContent = muscle.name;
        muscleSelect.appendChild(option);
    });
    
    showModal('custom-exercise-modal');
}

function toggleFavoriteCheckbox(element) {
    element.classList.toggle('checked');
}

function addCustomExercise() {
    const name = document.getElementById('custom-exercise-name').value.trim();
    const muscleGroup = document.getElementById('custom-exercise-muscle').value;
    const category = document.getElementById('custom-exercise-category').value;
    const difficulty = document.getElementById('custom-exercise-difficulty').value;
    const equipment = document.getElementById('custom-exercise-equipment').value;
    const isFavorite = document.getElementById('custom-exercise-favorite').classList.contains('checked');
    
    if (!name || !muscleGroup || !category) {
        showNotification('Veuillez remplir tous les champs obligatoires', 'error');
        return;
    }
    
const newExercise = {
    id: Date.now().toString(),
    name: name,
    muscleGroup: muscleGroup,
    category: category,
    difficulty: difficulty,
    equipment: equipment ? equipment.split(',').map(e => e.trim()) : [],
    favorite: isFavorite, // MODIFICATION: Toujours ajouter aux favoris si checkbox cochée
    custom: true
};
    
    customExercises.push(newExercise);
    saveToLocalStorage();
    loadExercises();
    
    // MODIFICATION ICI
    const context = document.getElementById('custom-exercise-modal').dataset.context;
    if (context === 'create' || context === 'edit') {
        // Ajouter l'exercice à la séance en cours de création
        addExerciseToWorkoutSelection(newExercise.id);
    }
    
    hideModal('custom-exercise-modal');
    
    document.getElementById('custom-exercise-name').value = '';
    document.getElementById('custom-exercise-muscle').value = '';
    document.getElementById('custom-exercise-category').value = '';
    document.getElementById('custom-exercise-equipment').value = '';
    document.getElementById('custom-exercise-favorite').classList.remove('checked');
    
    showNotification('Exercice créé et ajouté à la séance !');
}

function editCustomExercise(exerciseId) {
    const exercise = customExercises.find(ex => ex.id === exerciseId);
    if (!exercise) return;
    
    document.getElementById('edit-exercise-name').value = exercise.name;
    
    const muscleSelect = document.getElementById('edit-exercise-muscle');
    muscleSelect.innerHTML = '<option value="">Sélectionner un groupe</option>';
    muscleGroups.forEach(muscle => {
        const option = document.createElement('option');
        option.value = muscle.id;
        option.textContent = muscle.name;
        if (muscle.id === exercise.muscleGroup) option.selected = true;
        muscleSelect.appendChild(option);
    });
    
    document.getElementById('edit-exercise-category').value = exercise.category;
    document.getElementById('edit-exercise-difficulty').value = exercise.difficulty;
    document.getElementById('edit-exercise-equipment').value = exercise.equipment ? exercise.equipment.join(', ') : '';
    
    const favoriteCheckbox = document.getElementById('edit-exercise-favorite');
    if (exercise.favorite) {
        favoriteCheckbox.classList.add('checked');
    } else {
        favoriteCheckbox.classList.remove('checked');
    }
    
    // Stocker l'ID de l'exercice à modifier
    document.getElementById('edit-custom-exercise-modal').dataset.exerciseId = exerciseId;
    showModal('edit-custom-exercise-modal');
}

function saveEditedExercise() {
    const exerciseId = document.getElementById('edit-custom-exercise-modal').dataset.exerciseId;
    const exerciseIndex = customExercises.findIndex(ex => ex.id === exerciseId);
    
    if (exerciseIndex === -1) return;
    
    const name = document.getElementById('edit-exercise-name').value.trim();
    const muscleGroup = document.getElementById('edit-exercise-muscle').value;
    const category = document.getElementById('edit-exercise-category').value;
    const difficulty = document.getElementById('edit-exercise-difficulty').value;
    const equipment = document.getElementById('edit-exercise-equipment').value;
    const isFavorite = document.getElementById('edit-exercise-favorite').classList.contains('checked');
    
    if (!name || !muscleGroup || !category) {
        showNotification('Veuillez remplir tous les champs obligatoires', 'error');
        return;
    }
    
    customExercises[exerciseIndex] = {
        ...customExercises[exerciseIndex],
        name: name,
        muscleGroup: muscleGroup,
        category: category,
        difficulty: difficulty,
        equipment: equipment ? equipment.split(',').map(e => e.trim()) : [],
        favorite: isFavorite
    };
    
    saveToLocalStorage();
    loadExercises();
    hideModal('edit-custom-exercise-modal');
    showNotification('Exercice modifié avec succès !');
}

function deleteCustomExercise(exerciseId) {
    const exercise = customExercises.find(ex => ex.id === exerciseId);
    if (!exercise) return;
    
    document.getElementById('delete-custom-exercise-modal').dataset.exerciseId = exerciseId;
    document.getElementById('delete-exercise-message').textContent = 
        `Êtes-vous sûr de vouloir supprimer l'exercice "${exercise.name}" ? Cette action est irréversible et supprimera également cet exercice de toutes les séances où il est utilisé.`;
    showModal('delete-custom-exercise-modal');
}

function confirmDeleteCustomExercise() {
    const exerciseId = document.getElementById('delete-custom-exercise-modal').dataset.exerciseId;
    
    // Supprimer l'exercice
    customExercises = customExercises.filter(ex => ex.id !== exerciseId);
    
    // Supprimer l'exercice des séances personnalisées
    customWorkouts.forEach(workout => {
        workout.exercises = workout.exercises.filter(exId => exId !== exerciseId);
    });
    
    saveToLocalStorage();
    loadExercises();
    loadCustomWorkouts();
    hideModal('delete-custom-exercise-modal');
    showNotification('Exercice supprimé avec succès !');
}

function toggleExerciseFavorite(exerciseId, isCustom) {
    let exercise;
    let wasFavorite = false;
    
    if (isCustom) {
        exercise = customExercises.find(ex => ex.id === exerciseId);
        if (exercise) {
            wasFavorite = exercise.favorite;
            exercise.favorite = !exercise.favorite;
        }
    } else {
        exercise = exercises.find(ex => ex.id === exerciseId);
        if (exercise) {
            // Pour les exercices prédéfinis, on crée une copie personnalisée
            const existingCustom = customExercises.find(ex => 
                ex.name === exercise.name && ex.muscleGroup === exercise.muscleGroup
            );
            
            if (existingCustom) {
                // Si une copie existe déjà, on modifie son statut favori
                wasFavorite = existingCustom.favorite;
                existingCustom.favorite = !existingCustom.favorite;
            } else {
                // Sinon on crée une copie personnalisée
                const customCopy = {
                    ...exercise,
                    id: `custom_${exerciseId}_${Date.now()}`,
                    custom: true,
                    favorite: true,
                    originalId: exerciseId
                };
                customExercises.push(customCopy);
                wasFavorite = false;
            }
        }
    }
    
    saveToLocalStorage();
    loadExercises();
    showNotification(wasFavorite ? 'Exercice retiré des favoris' : 'Exercice ajouté aux favoris');
}

function showDeleteAllExercisesModal() {
    showModal('delete-all-exercises-modal');
}

function showClearHistoryModal() {
    showModal('clear-history-modal');
}

function confirmDeleteAllExercises() {
    customExercises = [];
    
    // Nettoyer les séances personnalisées
    customWorkouts.forEach(workout => {
        workout.exercises = workout.exercises.filter(exId => {
            const exercise = getAllExercises().find(ex => ex.id === exId);
            return exercise && !exercise.custom;
        });
    });
    
    saveToLocalStorage();
    loadExercises();
    loadCustomWorkouts();
    hideModal('delete-all-exercises-modal');
    showNotification('Tous les exercices personnalisés ont été supprimés');
}

function clearAllHistory() {
    if (confirm('Êtes-vous vraiment sûr de vouloir supprimer TOUT l\'historique des séances ? Cette action est irréversible.')) {
        workoutHistory = [];
        saveToLocalStorage();
        loadWorkoutHistory();
        hideModal('clear-history-modal');
        showNotification('Historique des séances entièrement supprimé');
    }
}


// ==================== GESTION DES ALIMENTS ====================
function getAllFoods() {
    return [...foods, ...customFoods];
}

function loadFoods() {
    const foodList = document.getElementById('foods-list');
    const categoryFilter = document.getElementById('food-category-filter');
    const searchInput = document.getElementById('food-search-input');
    
    if (!foodList) return;
    
    // Mettre à jour le filtre des catégories
    if (categoryFilter) {
        const categories = [...new Set([...foods, ...customFoods].map(f => f.category))];
        categoryFilter.innerHTML = '<option value="all">Toutes les catégories</option>';
        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category.charAt(0).toUpperCase() + category.slice(1);
            categoryFilter.appendChild(option);
        });
        
        // Mettre la valeur sélectionnée si un filtre est actif
        if (foodSearchFilter !== 'all') {
            categoryFilter.value = foodSearchFilter;
        }
    }
    
    // Filtrer les aliments
    let filteredFoods = getAllFoods();
    
    // Appliquer le filtre de catégorie ou spéciaux
    if (foodSearchFilter !== 'all') {
        if (foodSearchFilter === 'personnalisé') {
            filteredFoods = filteredFoods.filter(food => food.custom);
        } else if (foodSearchFilter === 'halal') {
            filteredFoods = filteredFoods.filter(food => food.halal);
        } else if (foodSearchFilter === 'favorites') {
            filteredFoods = filteredFoods.filter(food => food.favorite);
        } else {
            filteredFoods = filteredFoods.filter(food => food.category === foodSearchFilter);
        }
    }
    
    // Appliquer la recherche textuelle
    if (searchInput && searchInput.value) {
        const searchTerm = searchInput.value.toLowerCase();
        filteredFoods = filteredFoods.filter(food => 
            food.name.toLowerCase().includes(searchTerm) ||
            food.category.toLowerCase().includes(searchTerm)
        );
    }
    
    // Appliquer les filtres avancés
    filteredFoods = applyAdvancedFoodFilters(filteredFoods);
    
    // Trier par nom
    filteredFoods.sort((a, b) => a.name.localeCompare(b.name));
    
    // Afficher les aliments
    foodList.innerHTML = '';
    
    if (filteredFoods.length === 0) {
        foodList.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">🥦</div>
                <p>Aucun aliment trouvé</p>
                <button class="btn btn-success mt-4" onclick="showAddFoodModal()">Ajouter un aliment</button>
            </div>
        `;
        return;
    }
    
    filteredFoods.forEach(food => {
        const foodItem = document.createElement('div');
        foodItem.className = 'food-item-improved';
        
        foodItem.innerHTML = `
            <div class="food-item-improved-header">
                <div class="food-item-improved-name">${food.name}</div>
                <div class="food-item-improved-calories">${food.calories} kcal / ${food.quantity}g</div>
            </div>
            <div class="food-item-improved-details">
                <span>${food.category}</span>
                ${food.halal ? '<span>🕌 Halal</span>' : ''}
                ${food.custom ? '<span>🎨 Personnalisé</span>' : ''}
                ${food.custom ? `<span style="cursor: pointer;" onclick="toggleFoodHalal('${food.id}')">${food.halal ? '❌ Non-halal' : '🕌 Halal'}</span>` : ''}
            </div>
            <div class="food-item-improved-macros">
                <div class="food-item-improved-macro protein">Protéines: ${food.protein}g</div>
                <div class="food-item-improved-macro carbs">Glucides: ${food.carbs}g</div>
                <div class="food-item-improved-macro fat">Lipides: ${food.fat}g</div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button class="btn btn-warning" onclick="toggleFoodFavorite('${food.id}', ${food.custom})" style="flex: 1;">
                    <i class="fas ${food.favorite ? 'fa-star' : 'fa-star'}"></i> ${food.favorite ? 'Favori' : 'Favori'}
                </button>
                ${food.custom ? `
                    <button class="btn btn-secondary" onclick="editCustomFood('${food.id}')" style="flex: 1;">
                        <i class="fas fa-edit"></i> Modifier
                    </button>
                ` : ''}
                <button class="btn btn-success" onclick="addFoodToMeal('${food.id}')" style="flex: 1;">
                    <i class="fas fa-plus"></i> Ajouter
                </button>
            </div>
        `;
        
        foodList.appendChild(foodItem);
    });
}

function filterFoods() {
    const searchInput = document.getElementById('food-search-input');
    const categoryFilter = document.getElementById('food-category-filter');
    
    foodSearchFilter = categoryFilter ? categoryFilter.value : 'all';
    loadFoods();
}

function setFoodCategoryFilter(value) {
    foodSearchFilter = value;
    loadFoods();
}

function showAddFoodModal() {
    showModal('add-food-modal');
}

function toggleCheckbox(element) {
    element.classList.toggle('checked');
}

function saveFood() {
    const name = document.getElementById('food-name').value.trim();
    const quantity = parseInt(document.getElementById('food-quantity').value) || 100;
    const calories = parseInt(document.getElementById('food-calories').value) || 0;
    const protein = parseFloat(document.getElementById('food-protein').value) || 0;
    const carbs = parseFloat(document.getElementById('food-carbs').value) || 0;
    const fat = parseFloat(document.getElementById('food-fat').value) || 0;
    const category = document.getElementById('food-category').value;
    const isHalal = document.getElementById('food-halal').classList.contains('checked');
    const isFavorite = document.getElementById('food-favorite').classList.contains('checked');
    
    if (!name) {
        showNotification('Veuillez saisir un nom pour l\'aliment', 'error');
        return;
    }
    
    const newFood = {
        id: Date.now().toString(),
        name: name,
        quantity: quantity,
        calories: calories,
        protein: protein,
        carbs: carbs,
        fat: fat,
        category: category,
        halal: isHalal,
        favorite: isFavorite,
        custom: true
    };
    
    customFoods.push(newFood);
    saveToLocalStorage();
    loadFoods();
    
    // MODIFICATION ICI
    const context = document.getElementById('add-food-modal').dataset.context;
    if (context === 'add' || context === 'edit') {
        // Ajouter l'aliment au repas en cours de création
        addFoodToMealFromSearch(newFood.id);
    }
    
    hideModal('add-food-modal');
    
    document.getElementById('food-name').value = '';
    document.getElementById('food-quantity').value = '100';
    document.getElementById('food-calories').value = '';
    document.getElementById('food-protein').value = '';
    document.getElementById('food-carbs').value = '';
    document.getElementById('food-fat').value = '';
    document.getElementById('food-halal').classList.remove('checked');
    document.getElementById('food-favorite').classList.remove('checked');
    
    showNotification('Aliment créé et ajouté au repas !');
}

function calculateCaloriesFromMacros() {
    const protein = parseFloat(document.getElementById('food-protein').value) || 0;
    const carbs = parseFloat(document.getElementById('food-carbs').value) || 0;
    const fat = parseFloat(document.getElementById('food-fat').value) || 0;
    
    const calories = Math.round((protein * 4) + (carbs * 4) + (fat * 9));
    document.getElementById('food-calories').value = calories;
}

function calculateEditCaloriesFromMacros() {
    const protein = parseFloat(document.getElementById('edit-food-protein').value) || 0;
    const carbs = parseFloat(document.getElementById('edit-food-carbs').value) || 0;
    const fat = parseFloat(document.getElementById('edit-food-fat').value) || 0;
    
    const calories = Math.round((protein * 4) + (carbs * 4) + (fat * 9));
    document.getElementById('edit-food-calories').value = calories;
}

function editCustomFood(foodId) {
    const food = customFoods.find(f => f.id === foodId);
    if (!food) return;
    
    document.getElementById('edit-food-name').value = food.name;
    document.getElementById('edit-food-quantity').value = food.quantity;
    document.getElementById('edit-food-calories').value = food.calories;
    document.getElementById('edit-food-protein').value = food.protein;
    document.getElementById('edit-food-carbs').value = food.carbs;
    document.getElementById('edit-food-fat').value = food.fat;
    document.getElementById('edit-food-category').value = food.category;
    
    const halalCheckbox = document.getElementById('edit-food-halal');
    const favoriteCheckbox = document.getElementById('edit-food-favorite');
    
    if (food.halal) {
        halalCheckbox.classList.add('checked');
    } else {
        halalCheckbox.classList.remove('checked');
    }
    
    if (food.favorite) {
        favoriteCheckbox.classList.add('checked');
    } else {
        favoriteCheckbox.classList.remove('checked');
    }
    
    document.getElementById('edit-custom-food-modal').dataset.foodId = foodId;
    showModal('edit-custom-food-modal');
}

function saveEditedFood() {
    const foodId = document.getElementById('edit-custom-food-modal').dataset.foodId;
    const foodIndex = customFoods.findIndex(f => f.id === foodId);
    
    if (foodIndex === -1) return;
    
    const name = document.getElementById('edit-food-name').value.trim();
    const quantity = parseInt(document.getElementById('edit-food-quantity').value) || 100;
    const calories = parseInt(document.getElementById('edit-food-calories').value) || 0;
    const protein = parseFloat(document.getElementById('edit-food-protein').value) || 0;
    const carbs = parseFloat(document.getElementById('edit-food-carbs').value) || 0;
    const fat = parseFloat(document.getElementById('edit-food-fat').value) || 0;
    const category = document.getElementById('edit-food-category').value;
    const isHalal = document.getElementById('edit-food-halal').classList.contains('checked');
    const isFavorite = document.getElementById('edit-food-favorite').classList.contains('checked');
    
    if (!name) {
        showNotification('Veuillez saisir un nom pour l\'aliment', 'error');
        return;
    }
    
    customFoods[foodIndex] = {
        ...customFoods[foodIndex],
        name: name,
        quantity: quantity,
        calories: calories,
        protein: protein,
        carbs: carbs,
        fat: fat,
        category: category,
        halal: isHalal,
        favorite: isFavorite
    };
    
    saveToLocalStorage();
    loadFoods();
    hideModal('edit-custom-food-modal');
    showNotification('Aliment modifié avec succès !');
}

function deleteFood() {
    const foodId = document.getElementById('edit-custom-food-modal').dataset.foodId;
    
    customFoods = customFoods.filter(f => f.id !== foodId);
    saveToLocalStorage();
    loadFoods();
    hideModal('edit-custom-food-modal');
    showNotification('Aliment supprimé avec succès !');
}

function toggleFoodFavorite(foodId, isCustom) {
    let food;
    let wasFavorite = false;
    
    if (isCustom) {
        food = customFoods.find(f => f.id === foodId);
        if (food) {
            wasFavorite = food.favorite;
            food.favorite = !food.favorite;
        }
    } else {
        food = foods.find(f => f.id === foodId);
        if (food) {
            // Pour les aliments prédéfinis, on crée une copie personnalisée
            const existingCustom = customFoods.find(f => 
                f.name === food.name && f.category === food.category
            );
            
            if (existingCustom) {
                // Si une copie existe déjà, on modifie son statut favori
                wasFavorite = existingCustom.favorite;
                existingCustom.favorite = !existingCustom.favorite;
            } else {
                // Sinon on crée une copie personnalisée
                const customCopy = {
                    ...food,
                    id: `custom_${foodId}_${Date.now()}`,
                    custom: true,
                    favorite: true,
                    halal: false,
                    originalId: foodId
                };
                customFoods.push(customCopy);
                wasFavorite = false;
            }
        }
    }
    
    saveToLocalStorage();
    loadFoods();
    showNotification(wasFavorite ? 'Aliment retiré des favoris' : 'Aliment ajouté aux favoris');
}

function toggleFoodHalal(foodId) {
    let food = customFoods.find(f => f.id === foodId);
    
    if (!food) {
        // Si l'aliment n'est pas personnalisé, chercher dans les aliments prédéfinis
        const predefinedFood = foods.find(f => f.id === foodId);
        if (!predefinedFood) return;
        
        // Créer une copie personnalisée
        food = {
            ...predefinedFood,
            id: `custom_${foodId}_${Date.now()}`,
            custom: true,
            halal: true,
            favorite: false,
            originalId: foodId
        };
        customFoods.push(food);
    } else {
        food.halal = !food.halal;
    }
    
    saveToLocalStorage();
    loadFoods();
    showNotification(food.halal ? 'Aliment marqué comme halal' : 'Aliment marqué comme non-halal');
}

function showDeleteAllFoodsModal() {
    showModal('delete-all-foods-modal');
}

function confirmDeleteAllFoods() {
    customFoods = [];
    saveToLocalStorage();
    loadFoods();
    hideModal('delete-all-foods-modal');
    showNotification('Tous les aliments personnalisés ont été supprimés');
}

// ==================== GESTION DES SÉANCES ====================
function loadPredefinedWorkouts() {
    const container = document.getElementById('predefined-workouts-container');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (!window.predefinedWorkouts) {
        window.predefinedWorkouts = Workouts;
    }
    
    if (!window.predefinedWorkouts || typeof window.predefinedWorkouts !== 'object') {
        container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">Aucune séance prédéfinie disponible</p>';
        return;
    }
    
    const workoutArray = Object.values(window.predefinedWorkouts);
    
    if (workoutArray.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">Aucune séance prédéfinie disponible</p>';
        return;
    }
    
    workoutArray.forEach(workout => {
        const exerciseCount = workout.exercises ? workout.exercises.length : 0;
        const workoutCard = document.createElement('div');
        workoutCard.className = 'workout-card-luxury';
        // SUPPRIMER la ligne de style background: 
        // workoutCard.style.background = `linear-gradient(135deg, ${getWorkoutColor(workout.type)}, ${adjustColor(getWorkoutColor(workout.type), -20)})`;
        workoutCard.onclick = () => startPredefinedWorkout(workout);
        
        const difficulty = workout.difficulty || 'Intermédiaire';
        let difficultyClass = '';
        switch(difficulty) {
            case 'Débutant': difficultyClass = 'difficulty-beginner'; break;
            case 'Intermédiaire': difficultyClass = 'difficulty-intermediate'; break;
            case 'Avancé': difficultyClass = 'difficulty-advanced'; break;
            default: difficultyClass = 'difficulty-intermediate';
        }

        workoutCard.innerHTML = `
            <div class="workout-icon"></div>
            <div class="workout-name">${workout.name || 'Séance sans nom'}</div>
            <div class="workout-description">${workout.description || 'Séance prédéfinie'}</div>
            <div class="workout-duration">
                <i class="far fa-clock"></i>
                ${workout.duration || 45} min • ${exerciseCount} exercices
            </div>
            <div class="workout-badge ${difficultyClass}">${difficulty}</div>
        `;
        
        container.appendChild(workoutCard);
    });
}

function startPredefinedWorkoutFromHome(workoutId) {
    const workout = window.predefinedWorkouts ? window.predefinedWorkouts[workoutId] : Workouts[workoutId];
    if (!workout) {
        showNotification('Séance non trouvée', 'error');
        return;
    }
    startPredefinedWorkout(workout);
}

function getWorkoutColor(type) {
    switch(type) {
        case 'fullbody': return '#6366F1';
        case 'push': return '#EF4444';
        case 'pull': return '#10B981';
        case 'legs': return '#F59E0B';
        case 'abs': return '#8B5CF6';
        default: return '#6366F1';
    }
}

function loadCustomWorkouts() {
    const container = document.getElementById('custom-workouts-list');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (customWorkouts.length === 0) {
        container.innerHTML = `
            <div class="card">
                <p style="text-align: center; color: var(--text-secondary); margin-bottom: 14px;">
                    Aucune séance personnalisée. Créez votre première séance !
                </p>
            </div>
        `;
        return;
    }
    
    customWorkouts.forEach((workout, index) => {
        const exerciseCount = workout.exercises.length;
        const workoutCard = document.createElement('div');
        workoutCard.className = 'workout-card';
        workoutCard.onclick = () => startCustomWorkout(workout);
        
        workoutCard.innerHTML = `
            <div class="workout-name">${workout.name}</div>
            <div class="workout-description">${workout.description || 'Séance personnalisée'}</div>
            <div class="workout-duration">
                <i class="far fa-clock"></i>
                ${exerciseCount} exercices
            </div>
            <div style="position: absolute; top: 15px; right: 15px; display: flex; gap: 6px;">
                <button class="action-btn" onclick="event.stopPropagation(); editCustomWorkout(${index})">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="action-btn" onclick="event.stopPropagation(); deleteCustomWorkout(${index})">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        
        container.appendChild(workoutCard);
    });
}

function highlightNewWorkout(workoutId) {
    setTimeout(() => {
        const workoutCards = document.querySelectorAll('.workout-card, .workout-card-luxury');
        workoutCards.forEach(card => {
            const workoutName = card.querySelector('.workout-name');
            if (workoutName && workoutName.textContent) {
                // Vérifier si cette carte correspond à la nouvelle séance
                const workoutText = workoutName.textContent.trim().toLowerCase();
                const workoutIdLower = workoutId.toString().toLowerCase();
                
                // Si on trouve un match par nom ou ID
                if (workoutText.includes(workoutIdLower) || 
                    card.dataset.workoutId === workoutId ||
                    card.textContent.toLowerCase().includes(workoutIdLower)) {
                    
                    // Ajouter une animation de surbrillance
                    card.style.animation = 'workoutButtonSuccess 0.8s ease-in-out';
                    card.style.boxShadow = '0 0 20px rgba(5, 150, 105, 0.4)';
                    card.style.border = '2px solid #10B981';
                    card.style.position = 'relative';
                    card.style.zIndex = '10';
                    
                    // Ajouter un badge "Nouveau" temporaire
                    const newBadge = document.createElement('div');
                    newBadge.className = 'new-workout-badge';
                    newBadge.textContent = 'NOUVEAU';
                    newBadge.style.position = 'absolute';
                    newBadge.style.top = '-8px';
                    newBadge.style.right = '-8px';
                    newBadge.style.background = 'linear-gradient(135deg, #DC2626, #EF4444)';
                    newBadge.style.color = 'white';
                    newBadge.style.fontSize = '10px';
                    newBadge.style.fontWeight = '800';
                    newBadge.style.padding = '4px 8px';
                    newBadge.style.borderRadius = '12px';
                    newBadge.style.zIndex = '20';
                    newBadge.style.animation = 'pulse 1.5s infinite';
                    
                    card.appendChild(newBadge);
                    
                    // Retirer l'effet après l'animation
                    setTimeout(() => {
                        card.style.animation = '';
                        card.style.boxShadow = '';
                        card.style.border = '';
                        if (newBadge.parentNode) {
                            newBadge.remove();
                        }
                    }, 3000);
                }
            }
        });
    }, 1200); // Délai pour laisser le temps à la page de charger
}

// Si la keyframe pulse n'existe pas, ajoutez-la
if (!document.querySelector('#pulse-keyframes')) {
    const style = document.createElement('style');
    style.id = 'pulse-keyframes';
    style.textContent = `
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
    `;
    document.head.appendChild(style);
}

function showCreateWorkoutModal(fromHeader = true) {
    // Stocker d'où on vient
    localStorage.setItem('workoutModalSource', fromHeader ? 'header' : 'workouts');
    localStorage.setItem('previousScreenBeforeWorkout', currentScreen || 'workouts-screen');
    
    console.log('Ouverture modal séance - Source:', fromHeader ? 'header' : 'workouts', 'Écran actuel:', currentScreen);
    
    // Ouvrir le modal
    showModal('create-workout-modal');
    resetCreateWorkoutModal();
}

function showExerciseSelectionForCreate() {
    // 1. RÉINITIALISER LE MODAL
    const modal = document.getElementById('select-exercise-modal');
    
    // 2. VIDER LA LISTE DES RÉSULTATS
    const listContainer = document.getElementById('exercise-selection-list');
    if (listContainer) {
        listContainer.innerHTML = '<div style="text-align: center; padding: 20px;">Chargement...</div>';
    }
    
    // 3. CONFIGURER LE FILTRE
    const muscleFilter = document.getElementById('exercise-filter');
    if (muscleFilter) {
        muscleFilter.innerHTML = '<option value="all">📋 Tous les groupes musculaires</option>';
        muscleGroups.forEach(muscle => {
            const option = document.createElement('option');
            option.value = muscle.id;
            option.textContent = `${muscle.image || '●'} ${muscle.name}`;
            muscleFilter.appendChild(option);
        });
        muscleFilter.value = 'all';
        
        // Réinitialiser l'écouteur d'événement
        muscleFilter.onchange = function() {
            filterExerciseSelectionByMuscle(this.value);
        };
    }
    
    // 4. DÉFINIR LE CONTEXTE
    modal.dataset.context = 'create';
    modal.dataset.source = 'workout-creation';
    
    // 5. CHARGER LES EXERCICES
    setTimeout(() => {
        loadExerciseSelection('all');
    }, 50);
    
    showModal('select-exercise-modal');
}

function showCustomExerciseModalForCreate() {
    showCustomExerciseModal();
    document.getElementById('custom-exercise-modal').dataset.context = 'create';
    // MODIFICATION
    document.getElementById('custom-exercise-modal').dataset.workoutContext = 'create';
}

// ==================== CHARGER LA LISTE DES EXERCICES ====================
function loadExerciseSelection(filter = 'all') {
    const container = document.getElementById('exercise-selection-list');
    if (!container) {
        console.error('Conteneur exercise-selection-list non trouvé');
        return;
    }
    
    container.innerHTML = '<div style="text-align: center; padding: 30px;"><i class="fas fa-spinner fa-spin" style="font-size: 24px;"></i><p style="margin-top: 10px;">Chargement des exercices...</p></div>';
    
    // Petit délai pour éviter les problèmes de rendu
    setTimeout(() => {
        // 1. RÉCUPÉRER TOUS LES EXERCICES
        let allExercises = getAllExercises();
        
        // 2. TRIER: FAVORIS EN PREMIER, PUIS PAR NOM
        allExercises.sort((a, b) => {
            if (a.favorite && !b.favorite) return -1;
            if (!a.favorite && b.favorite) return 1;
            return a.name.localeCompare(b.name);
        });
        
        // 3. APPLIQUER LE FILTRE
        let filteredExercises = allExercises;
        if (filter !== 'all') {
            filteredExercises = allExercises.filter(ex => ex.muscleGroup === filter);
        }
        
        // 4. VIDER LE CONTENEUR
        container.innerHTML = '';
        
        // 5. CAS: AUCUN EXERCICE
        if (filteredExercises.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px 20px;">
                    <div style="font-size: 48px; margin-bottom: 16px;">🏋️‍♂️</div>
                    <p style="font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">
                        Aucun exercice trouvé
                    </p>
                    <p style="font-size: var(--font-size-sm); color: var(--text-secondary); margin-bottom: 20px;">
                        ${filter !== 'all' ? 'Aucun exercice pour ce groupe musculaire' : 'Créez votre premier exercice'}
                    </p>
                    <button class="btn btn-success" onclick="showCustomExerciseModal()">
                        <i class="fas fa-plus"></i> Créer un exercice
                    </button>
                </div>
            `;
            return;
        }
        
        // 🔴 CORRECTION: AFFICHAGE SELON LE FILTRE
        if (filter === 'all') {
            // MODE "TOUS LES GROUPES" - AFFICHAGE SANS CATÉGORISATION
            container.innerHTML = '<div style="margin-bottom: 12px; font-size: var(--font-size-sm); color: var(--text-secondary); padding: 8px 12px; background: var(--card-bg); border-radius: var(--radius-sm); border: 1px solid var(--border);">📋 Tous les exercices • ' + filteredExercises.length + ' exercices</div>';
            
            // Afficher tous les exercices en une seule liste
            filteredExercises.forEach(exercise => {
                const muscle = muscleGroups.find(m => m.id === exercise.muscleGroup);
                const muscleName = muscle ? muscle.name : exercise.muscleGroup;
                const muscleColor = muscle ? muscle.color : '#6366F1';
                
                const exerciseItem = document.createElement('div');
                exerciseItem.className = 'exercise-selection-item';
                exerciseItem.style.cssText = `
                    display: flex;
                    align-items: center;
                    padding: 14px 16px;
                    background: var(--card-bg);
                    border: 1px solid var(--border);
                    border-radius: var(--radius);
                    margin-bottom: 8px;
                    cursor: pointer;
                    transition: all 0.2s ease;
                `;
                exerciseItem.onmouseover = () => {
                    exerciseItem.style.transform = 'translateY(-2px)';
                    exerciseItem.style.boxShadow = 'var(--shadow)';
                    exerciseItem.style.borderColor = muscleColor;
                };
                exerciseItem.onmouseout = () => {
                    exerciseItem.style.transform = 'translateY(0)';
                    exerciseItem.style.boxShadow = 'none';
                    exerciseItem.style.borderColor = 'var(--border)';
                };
                exerciseItem.onclick = () => addExerciseToWorkoutSelection(exercise.id);
                
                exerciseItem.innerHTML = `
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                            <span style="font-weight: 700; color: var(--text-primary);">${exercise.name}</span>
                            ${exercise.favorite ? '<span style="color: #F59E0B;"><i class="fas fa-star"></i></span>' : ''}
                            ${exercise.custom ? '<span style="font-size: 10px; padding: 2px 6px; background: var(--primary); color: white; border-radius: 10px;">Personnalisé</span>' : ''}
                        </div>
                        <div style="display: flex; gap: 12px; font-size: var(--font-size-xs); color: var(--text-secondary);">
                            <span style="display: flex; align-items: center; gap: 4px;">
                                <span style="color: ${muscleColor};">●</span> ${muscleName}
                            </span>
                            <span>• ${exercise.difficulty}</span>
                            ${exercise.category ? `<span>• ${exercise.category}</span>` : ''}
                        </div>
                    </div>
                    <div style="color: var(--text-secondary);">
                        <i class="fas fa-plus-circle" style="font-size: 20px; color: var(--primary);"></i>
                    </div>
                `;
                
                container.appendChild(exerciseItem);
            });
            
        } else {
            // MODE FILTRE PAR GROUPE - AFFICHAGE GROUPÉ
            // Grouper par muscle (mais un seul groupe puisque filtré)
            const muscle = muscleGroups.find(m => m.id === filter);
            const muscleName = muscle ? muscle.name : filter;
            const muscleColor = muscle ? muscle.color : '#6366F1';
            
            const header = document.createElement('div');
            header.style.cssText = `
                font-weight: 700;
                font-size: var(--font-size-base);
                color: ${muscleColor};
                margin: 0 0 15px 0;
                padding-bottom: 8px;
                border-bottom: 2px solid ${muscleColor}40;
                display: flex;
                align-items: center;
                gap: 8px;
            `;
            header.innerHTML = `
                <span style="color: ${muscleColor};">●</span>
                ${muscleName}
                <span style="font-size: var(--font-size-xs); color: var(--text-secondary); font-weight: normal;">
                    (${filteredExercises.length} exercice${filteredExercises.length > 1 ? 's' : ''})
                </span>
            `;
            container.appendChild(header);
            
            // Afficher les exercices de ce groupe
            filteredExercises.forEach(exercise => {
                const exerciseItem = document.createElement('div');
                exerciseItem.className = 'exercise-selection-item';
                exerciseItem.style.cssText = `
                    display: flex;
                    align-items: center;
                    padding: 14px 16px;
                    background: var(--card-bg);
                    border: 1px solid var(--border);
                    border-radius: var(--radius);
                    margin-bottom: 8px;
                    cursor: pointer;
                    transition: all 0.2s ease;
                `;
                exerciseItem.onmouseover = () => {
                    exerciseItem.style.transform = 'translateY(-2px)';
                    exerciseItem.style.boxShadow = 'var(--shadow)';
                    exerciseItem.style.borderColor = muscleColor;
                };
                exerciseItem.onmouseout = () => {
                    exerciseItem.style.transform = 'translateY(0)';
                    exerciseItem.style.boxShadow = 'none';
                    exerciseItem.style.borderColor = 'var(--border)';
                };
                exerciseItem.onclick = () => addExerciseToWorkoutSelection(exercise.id);
                
                exerciseItem.innerHTML = `
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                            <span style="font-weight: 700; color: var(--text-primary);">${exercise.name}</span>
                            ${exercise.favorite ? '<span style="color: #F59E0B;"><i class="fas fa-star"></i></span>' : ''}
                            ${exercise.custom ? '<span style="font-size: 10px; padding: 2px 6px; background: var(--primary); color: white; border-radius: 10px;">Personnalisé</span>' : ''}
                        </div>
                        <div style="display: flex; gap: 12px; font-size: var(--font-size-xs); color: var(--text-secondary);">
                            <span>${exercise.difficulty}</span>
                            ${exercise.category ? `<span>• ${exercise.category}</span>` : ''}
                        </div>
                    </div>
                    <div style="color: var(--text-secondary);">
                        <i class="fas fa-plus-circle" style="font-size: 20px; color: var(--primary);"></i>
                    </div>
                `;
                
                container.appendChild(exerciseItem);
            });
        }
        
    }, 50);
}

function filterExerciseSelection(searchTerm) {
    const filterValue = document.getElementById('exercise-filter').value;
    loadExerciseSelection(filterValue === 'all' ? 'all' : filterValue);
    
    // Filtrer également par recherche textuelle
    if (searchTerm) {
        const items = document.querySelectorAll('#exercise-selection-list .food-search-simple-item');
        items.forEach(item => {
            const text = item.textContent.toLowerCase();
            item.style.display = text.includes(searchTerm.toLowerCase()) ? 'block' : 'none';
        });
    }
}

function filterExerciseSelectionByMuscle(value) {
    loadExerciseSelection(value === 'all' ? 'all' : value);
}

function addExerciseToWorkoutSelection(exerciseId) {
    console.log('addExerciseToWorkoutSelection - ID:', exerciseId);
    
    // 1. RÉCUPÉRER LE CONTEXTE
    const modal = document.getElementById('select-exercise-modal');
    const context = modal.dataset.context || 'create';
    
    // 2. DÉTERMINER LE BON CONTENEUR
    let containerId = '';
    if (context === 'create') {
        containerId = 'workout-exercises-selection';
    } else if (context === 'edit') {
        containerId = 'edit-workout-exercises-selection';
    } else if (context === 'active-workout') {
        // AJOUT DIRECT À LA SÉANCE ACTIVE
        addExerciseToActiveWorkout(exerciseId);
        hideModal('select-exercise-modal');
        return;
    }
    
    const container = document.getElementById(containerId);
    if (!container) {
        console.error('Conteneur non trouvé:', containerId);
        return;
    }
    
    // 3. RECHERCHER L'EXERCICE AVEC FALLBACK
    let exercise = getAllExercises().find(ex => ex.id === exerciseId);
    
    // Si non trouvé par ID exact, chercher par nom (pour les exercices prédéfinis)
    if (!exercise) {
        console.warn('Exercice non trouvé par ID, recherche par correspondance...', exerciseId);
        // Essayer de trouver dans exercises (prédéfinis)
        exercise = exercises.find(ex => ex.id === exerciseId);
    }
    
    if (!exercise) {
        console.error('Exercice introuvable:', exerciseId);
        showNotification('Erreur: exercice non trouvé', 'error');
        return;
    }
    
    // 4. VÉRIFIER DOUBLON
    const existingExercises = Array.from(container.querySelectorAll('.meal-food-item'));
    const isDuplicate = existingExercises.some(item => item.dataset.exerciseId === exerciseId);
    
    if (isDuplicate) {
        showNotification('Cet exercice est déjà dans la séance', 'warning');
        return;
    }
    
    // 5. CRÉER L'ÉLÉMENT
    const exerciseElement = document.createElement('div');
    exerciseElement.className = 'meal-food-item';
    exerciseElement.dataset.exerciseId = exerciseId;
    
    const muscle = muscleGroups.find(m => m.id === exercise.muscleGroup);
    const muscleName = muscle ? muscle.name : exercise.muscleGroup;
    
    exerciseElement.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <div style="font-weight: 700; margin-bottom: 3px;">${exercise.name}</div>
                <div style="font-size: var(--font-size-xs); color: var(--text-secondary);">
                    <span style="color: ${muscle ? muscle.color : '#666'}">●</span>
                    ${muscleName} • ${exercise.difficulty}
                    ${exercise.custom ? ' (Personnalisé)' : ''}
                </div>
            </div>
            <div class="reorder-buttons">
                <button class="reorder-btn" onclick="moveExerciseUp(this)" title="Monter">
                    <i class="fas fa-chevron-up"></i>
                </button>
                <button class="reorder-btn" onclick="moveExerciseDown(this)" title="Descendre">
                    <i class="fas fa-chevron-down"></i>
                </button>
                <button class="reorder-btn" onclick="removeExerciseFromSelection(this)" title="Supprimer">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    `;
    
    container.appendChild(exerciseElement);
    
    // 6. ANIMATION DE CONFIRMATION
    exerciseElement.style.animation = 'fadeInUp 0.3s ease';
    setTimeout(() => {
        exerciseElement.style.animation = '';
    }, 300);
    
    hideModal('select-exercise-modal');
    showNotification(`✅ ${exercise.name} ajouté à la séance`);
}

// ==================== AJOUT DIRECT À LA SÉANCE ACTIVE ====================
function addExerciseToActiveWorkout(exerciseId) {
    console.log('addExerciseToActiveWorkout - ID:', exerciseId);
    
    if (!activeWorkout) {
        showNotification('Aucune séance active', 'error');
        return;
    }
    
    // 1. RECHERCHER L'EXERCICE
    let exercise = getAllExercises().find(ex => ex.id === exerciseId);
    if (!exercise) {
        exercise = exercises.find(ex => ex.id === exerciseId);
    }
    
    if (!exercise) {
        showNotification('Exercice non trouvé', 'error');
        return;
    }
    
    // 2. VÉRIFIER DOUBLON DANS LA SÉANCE ACTIVE
    const isDuplicate = activeWorkout.exercises.some(ex => 
        ex.name === exercise.name && ex.muscleGroup === exercise.muscleGroup
    );
    
    if (isDuplicate) {
        if (!confirm(`"${exercise.name}" est déjà dans la séance. Voulez-vous l'ajouter quand même ?`)) {
            return;
        }
    }
    
    // 3. CRÉER LE NOUVEL EXERCICE AVEC VALEURS PAR DÉFAUT
    const newExercise = {
        ...exercise,
        sets: Array(userProfile.defaultSets).fill().map((_, i) => ({
            number: i + 1,
            reps: userProfile.defaultReps,
            weight: userProfile.defaultWeight,
            completed: false
        })),
        customRest: userProfile.defaultRest,
        notes: '',
        collapsed: false,
        compactModeOverride: undefined
    };
    
    // 4. AJOUTER À LA SÉANCE
    activeWorkout.exercises.push(newExercise);
    
    // 5. METTRE À JOUR L'AFFICHAGE
    updateWorkoutDisplay();
    
    showNotification(`✅ ${exercise.name} ajouté à la séance`);
}


function moveExerciseUp(button) {
    const item = button.closest('.meal-food-item');
    const prevItem = item.previousElementSibling;
    if (prevItem) {
        item.parentNode.insertBefore(item, prevItem);
    }
}

function moveExerciseDown(button) {
    const item = button.closest('.meal-food-item');
    const nextItem = item.nextElementSibling;
    if (nextItem) {
        item.parentNode.insertBefore(nextItem, item);
    }
}

function removeExerciseFromSelection(button) {
    const item = button.closest('.meal-food-item');
    item.remove();
}

function saveCustomWorkout() {
    // Utiliser la nouvelle fonction pour plus de cohérence
    saveCustomWorkoutAndReturnToWorkouts();
}

async function saveCustomWorkoutAndReturnToWorkouts() {
    console.log('Début sauvegarde séance avec retour...');
    
    // 1. Récupérer les données
    const workoutData = getWorkoutFormData();
    
    // 2. Validation
    if (!workoutData.name || !workoutData.exercises || workoutData.exercises.length === 0) {
        showNotification('Nom et exercices requis', 'error');
        return;
    }
    
    // 3. État de chargement
    const saveBtn = document.getElementById('save-workout-button');
    const saveText = saveBtn?.querySelector('.save-workout-text');
    const loadingText = saveBtn?.querySelector('.save-workout-loading');
    
    if (saveText && loadingText) {
        saveText.style.display = 'none';
        loadingText.style.display = 'flex';
    }
    if (saveBtn) saveBtn.disabled = true;
    
    try {
        // 4. Sauvegarder
        const saved = await saveCustomWorkoutToStorage(workoutData);
        
        if (saved) {
            // 5. Animation de sortie
            const modal = document.getElementById('create-workout-modal');
            if (modal) modal.classList.add('modal-exit-to-workouts');
            
            // 6. Après animation, retourner aux Séances
            setTimeout(() => {
                hideModal('create-workout-modal');
                resetCreateWorkoutModal();
                
                // TOUJOURS retourner à la page Séances
                showScreen('workouts-screen');
                
                // Animation d'entrée
                const workoutsScreen = document.getElementById('workouts-screen');
                if (workoutsScreen) {
                    workoutsScreen.classList.add('workouts-screen-enter');
                    setTimeout(() => workoutsScreen.classList.remove('workouts-screen-enter'), 900);
                }
                
                // Actualiser la liste
                loadCustomWorkouts();
                
                // Notification
                showNotification('Séance créée avec succès !', 'success');
                
                // Nettoyer le storage
                localStorage.removeItem('workoutModalSource');
                localStorage.removeItem('previousScreenBeforeWorkout');
                
            }, 550);
        }
    } catch (error) {
        console.error('Erreur lors de la sauvegarde:', error);
        showNotification('Erreur de sauvegarde', 'error');
    } finally {
        // Réactiver le bouton
        if (saveBtn) {
            saveBtn.disabled = false;
            if (saveText && loadingText) {
                saveText.style.display = 'flex';
                loadingText.style.display = 'none';
            }
        }
    }
}

function getWorkoutFormData() {
    const name = document.getElementById('workout-name').value.trim();
    const exercises = [];
    
    document.querySelectorAll('#workout-exercises-selection .meal-food-item').forEach(item => {
        exercises.push(item.dataset.exerciseId);
    });
    
    return {
        name: name,
        exercises: exercises,
        description: 'Séance personnalisée',
        custom: true
    };
}

async function saveCustomWorkoutToStorage(workoutData) {
    return new Promise((resolve, reject) => {
        try {
            const newWorkout = {
                id: Date.now().toString(),
                name: workoutData.name,
                exercises: workoutData.exercises,
                description: workoutData.description || 'Séance personnalisée',
                custom: true
            };
            
            customWorkouts.push(newWorkout);
            saveToLocalStorage();
            
            // Après customWorkouts.push(newWorkout);
            setTimeout(() => highlightNewWorkout(newWorkout.id), 1200);
            
            resolve(true);
        } catch (error) {
            reject(error);
        }
    });
}

function resetCreateWorkoutModal() {
    document.getElementById('workout-name').value = '';
    document.getElementById('workout-exercises-selection').innerHTML = '';
}

function editCustomWorkout(index) {
    const workout = customWorkouts[index];
    if (!workout) return;
    
    document.getElementById('edit-workout-name').value = workout.name;
    document.getElementById('edit-workout-modal').dataset.workoutIndex = index;
    
    const container = document.getElementById('edit-workout-exercises-selection');
    container.innerHTML = '';
    
    workout.exercises.forEach(exerciseId => {
        const exercise = getAllExercises().find(ex => ex.id === exerciseId);
        if (exercise) {
            const exerciseElement = document.createElement('div');
            exerciseElement.className = 'meal-food-item';
            exerciseElement.dataset.exerciseId = exerciseId;
            
            exerciseElement.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: 700; margin-bottom: 3px;">${exercise.name}</div>
                        <div style="font-size: var(--font-size-xs); color: var(--text-secondary);">
                            ${exercise.muscleGroup} • ${exercise.difficulty}
                        </div>
                    </div>
                    <div class="reorder-buttons">
                        <button class="reorder-btn" onclick="moveExerciseUp(this)" title="Monter">↑</button>
                        <button class="reorder-btn" onclick="moveExerciseDown(this)" title="Descendre">↓</button>
                        <button class="reorder-btn" onclick="removeExerciseFromSelection(this)" title="Supprimer">×</button>
                    </div>
                </div>
            `;
            
            container.appendChild(exerciseElement);
        }
    });
    
    showModal('edit-workout-modal');
}

function showExerciseSelectionForEdit() {
    showExerciseSelectionForCreate();
    document.getElementById('select-exercise-modal').dataset.context = 'edit';
}

function showCustomExerciseModalForEdit() {
    showCustomExerciseModal();
    document.getElementById('custom-exercise-modal').dataset.context = 'edit';
}

function saveEditedWorkout() {
    const index = parseInt(document.getElementById('edit-workout-modal').dataset.workoutIndex);
    if (isNaN(index) || !customWorkouts[index]) return;
    
    const name = document.getElementById('edit-workout-name').value.trim();
    const exercises = [];
    
    document.querySelectorAll('#edit-workout-exercises-selection .meal-food-item').forEach(item => {
        exercises.push(item.dataset.exerciseId);
    });
    
    if (!name) {
        showNotification('Veuillez saisir un nom pour la séance', 'error');
        return;
    }
    
    if (exercises.length === 0) {
        showNotification('Veuillez ajouter au moins un exercice', 'error');
        return;
    }
    
    customWorkouts[index] = {
        ...customWorkouts[index],
        name: name,
        exercises: exercises
    };
    
    saveToLocalStorage();
    loadCustomWorkouts();
    hideModal('edit-workout-modal');
    showNotification('Séance modifiée avec succès !');
}

function duplicateWorkout() {
    const index = parseInt(document.getElementById('edit-workout-modal').dataset.workoutIndex);
    if (isNaN(index) || !customWorkouts[index]) return;
    
    const originalWorkout = customWorkouts[index];
    const duplicatedWorkout = {
        ...originalWorkout,
        id: Date.now().toString(),
        name: `${originalWorkout.name} (Copie)`
    };
    
    customWorkouts.push(duplicatedWorkout);
    saveToLocalStorage();
    loadCustomWorkouts();
    hideModal('edit-workout-modal');
    showNotification('Séance dupliquée avec succès !');
}

function deleteEditedWorkout() {
    const index = parseInt(document.getElementById('edit-workout-modal').dataset.workoutIndex);
    if (isNaN(index) || !customWorkouts[index]) return;
    
    if (confirm('Êtes-vous sûr de vouloir supprimer cette séance ?')) {
        customWorkouts.splice(index, 1);
        saveToLocalStorage();
        loadCustomWorkouts();
        hideModal('edit-workout-modal');
        showNotification('Séance supprimée avec succès !');
    }
}

function deleteCustomWorkout(index) {
    if (confirm('Êtes-vous sûr de vouloir supprimer cette séance ?')) {
        customWorkouts.splice(index, 1);
        saveToLocalStorage();
        loadCustomWorkouts();
        showNotification('Séance supprimée avec succès !');
    }
}

// ==================== GESTION DES SÉANCES ACTIVES ====================
function startPredefinedWorkout(workout) {
    // Extraire les IDs d'exercices du tableau workout.exercises
    const exerciseIds = workout.exercises.map(ex => ex.exerciseId);
    startWorkoutWithExercises(workout.name, exerciseIds);
}

function startCustomWorkout(workout) {
    startWorkoutWithExercises(workout.name, workout.exercises);
}

function startWorkoutWithExercises(workoutName, exerciseIds) {
    activeWorkout = {
        name: workoutName,
        exercises: [],
        startTime: new Date(),
        completedSets: 0,
        totalWeight: 0
    };
    
    // Chercher la séance complète dans Workouts pour avoir les détails (sets, reps, weight, rest)
    let workoutDetails = null;
    
    // Chercher dans les séances prédéfinies
    Object.values(Workouts).forEach(workout => {
        if (workout.name === workoutName) {
            workoutDetails = workout;
        }
    });
    
    exerciseIds.forEach(exerciseId => {
        const exercise = getAllExercises().find(ex => ex.id === exerciseId);
        if (exercise) {
            // Chercher les détails spécifiques de cet exercice dans la séance
            let exerciseDetails = null;
            if (workoutDetails && workoutDetails.exercises) {
                exerciseDetails = workoutDetails.exercises.find(ex => ex.exerciseId === exerciseId);
            }
            
            // Utiliser les valeurs de data.js si disponibles, sinon les valeurs par défaut du profil
            const defaultSets = exerciseDetails ? exerciseDetails.sets : userProfile.defaultSets;
            const defaultReps = exerciseDetails ? exerciseDetails.reps : userProfile.defaultReps;
            const defaultWeight = exerciseDetails ? exerciseDetails.weight : userProfile.defaultWeight;
            const defaultRest = exerciseDetails ? exerciseDetails.rest : userProfile.defaultRest;
            const notes = exerciseDetails ? exerciseDetails.notes : '';
            
            activeWorkout.exercises.push({
                ...exercise,
                sets: Array(defaultSets).fill().map((_, i) => ({
                    number: i + 1,
                    reps: defaultReps,  // Utilise les reps de data.js
                    weight: defaultWeight,  // Utilise le poids de data.js
                    completed: false
                })),
                customRest: defaultRest,  // Utilise le temps de repos de data.js
                notes: notes  // Utilise les notes de data.js
            });
        }
    });
    
    activeWorkoutStartTime = new Date();
    activeWorkoutTimer = setInterval(updateWorkoutTimer, 1000);
    updateWorkoutDisplay();
    showScreen('active-workout-screen');
}

function updateWorkoutTimer() {
    if (!activeWorkoutStartTime) return;
    
    const now = new Date();
    const diff = Math.floor((now - activeWorkoutStartTime) / 1000);
    
    const hours = Math.floor(diff / 3600);
    const minutes = Math.floor((diff % 3600) / 60);
    const seconds = diff % 60;
    
    document.getElementById('workout-timer').textContent = 
        `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

function updateWorkoutDisplay() {
    if (!activeWorkout) return;
    
    document.getElementById('active-workout-name').textContent = activeWorkout.name;
    document.getElementById('completed-sets').textContent = activeWorkout.completedSets;
    document.getElementById('total-weight').textContent = `${activeWorkout.totalWeight}kg`;
    
    const container = document.getElementById('workout-exercises-container');
    container.innerHTML = '';
    
// Dans la boucle forEach des exercices, trouver la partie qui génère le HTML
activeWorkout.exercises.forEach((exercise, exerciseIndex) => {
    const exerciseElement = document.createElement('div');
    exerciseElement.className = 'workout-exercise';
    
    // Vérifier si c'est le premier exercice d'un superset
    const isFirstInSuperset = exercise.supersetId && 
        (exerciseIndex === 0 || activeWorkout.exercises[exerciseIndex - 1].supersetId !== exercise.supersetId);
    
    // Vérifier si c'est le dernier exercice d'un superset
    const isLastInSuperset = exercise.supersetId && 
        (exerciseIndex === activeWorkout.exercises.length - 1 || 
         activeWorkout.exercises[exerciseIndex + 1].supersetId !== exercise.supersetId);
    
    // Appliquer des styles spéciaux pour les supersets
    if (exercise.supersetId) {
        exerciseElement.style.borderLeft = `4px solid ${exercise.supersetColor || '#8B5CF6'}`;
        exerciseElement.style.marginTop = isFirstInSuperset ? '5px' : '2px';
        exerciseElement.style.marginBottom = isLastInSuperset ? '15px' : '2px';
    }
    
// Dans la boucle forEach des exercices (~ligne 1680), modifiez le innerHTML :
exerciseElement.innerHTML = `
    <div class="exercise-header">
        <div class="exercise-title" onclick="toggleExerciseCollapse(${exerciseIndex})" style="cursor: pointer; ${exercise.collapsed ? 'color: #3B82F6;' : ''}">
    ${exercise.name}
    ${exercise.supersetId ? `<span class="superset-badge" style="background: ${exercise.supersetColor || '#8B5CF6'}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: bold; margin-left: 8px;">Superset ${exercise.supersetOrder}</span>` : ''}
</div>
    </div>
    
    <div style="display: flex; justify-content: center; flex-wrap: wrap; gap: 5px; margin: 10px 0; padding: 10px; background: var(--card-bg); border-radius: var(--radius-sm); border: 1px solid var(--border);">
        <button class="action-btn" onclick="moveExerciseUpInWorkout(${exerciseIndex})" title="Monter l'exercice">
            <i class="fas fa-arrow-up"></i>
        </button>
        <button class="action-btn" onclick="moveExerciseDownInWorkout(${exerciseIndex})" title="Descendre l'exercice">
            <i class="fas fa-arrow-down"></i>
        </button>
        <button class="action-btn" onclick="resetExerciseToDefaults(${exerciseIndex})" title="Réinitialiser valeurs">
            <i class="fas fa-undo"></i>
        </button>
        <button class="action-btn" onclick="showCustomRestModal(${exerciseIndex})" title="Temps de repos">
            <i class="fas fa-clock"></i>
        </button>
        <button class="action-btn" onclick="addSet(${exerciseIndex})" title="Ajouter une série">
            <i class="fas fa-plus"></i>
        </button>
        <button class="action-btn" onclick="removeSet(${exerciseIndex})" title="Supprimer une série">
            <i class="fas fa-minus"></i>
        </button>
        ${exercise.supersetId ? `
            <button class="action-btn" onclick="removeSuperset(${exerciseIndex})" title="Quitter le superset" style="background: ${exercise.supersetColor || '#8B5CF6'}; color: white;">
                <i class="fas fa-unlink"></i>
            </button>
        ` : `
            <button class="action-btn" onclick="showSupersetModal(${exerciseIndex})" title="Créer superset">
                <i class="fas fa-link"></i>
            </button>
        `}
        
<!-- BOUTON NOTES (NOUVEAU) -->

<button class="action-btn" onclick="showExerciseNotesModal(${exerciseIndex})" 
        title="Notes de l'exercice" 
        style="background: ${exercise.notes ? 'linear-gradient(135deg, #3B82F6, #1D4ED8)' : 'linear-gradient(135deg, #8B5CF6, #EC4899)'}; color: white;">
    <i class="fas fa-sticky-note"></i>
</button>

<!-- NOUVEAU BOUTON VIDÉO -->
        ${exercise.videoUrl ? `
            <button class="action-btn" onclick="window.open('${exercise.videoUrl}', '_blank')" 
                    title="Voir la vidéo de l'exercice" 
                    style="background: linear-gradient(135deg, #FF0000, #CC0000); color: white;">
                <i class="fas fa-play"></i>
            </button>
        ` : ''}

<!-- NOUVEAU BOUTON MODE -->
    <button class="action-btn" onclick="toggleExerciseCompactMode(${exerciseIndex})" 
            title="${exercise.compactModeOverride === true ? 'Mode compact forcé' : exercise.compactModeOverride === false ? 'Mode normal forcé' : 'Utilise le paramètre global'}" 
            style="background: ${exercise.compactModeOverride === true ? 'var(--primary)' : exercise.compactModeOverride === false ? 'var(--warning)' : 'var(--secondary)'}; color: white;">
        <i class="fas fa-${exercise.compactModeOverride === true ? 'mobile-alt' : exercise.compactModeOverride === false ? 'file-alt' : 'cog'}"></i>
    </button>

<button class="action-btn" onclick="removeExerciseFromWorkout(${exerciseIndex})" title="Supprimer l'exercice">
            <i class="fas fa-trash"></i>
        </button>
    </div>
    
    ${exercise.collapsed ? '' : `
        <div style="margin: 10px 0; padding: 10px; background: var(--card-bg); border-radius: var(--radius-sm); border: 1px solid var(--border);">
            <div style="font-size: var(--font-size-sm); color: var(--text-secondary); margin-bottom: 5px;">
                <i class="fas fa-clock"></i> Temps de repos: ${exercise.customRest || userProfile.defaultRest} secondes
                ${exercise.supersetId ? ` • <span style="color: ${exercise.supersetColor || '#8B5CF6'};"><i class="fas fa-link"></i> ${exercise.supersetName || 'Superset'}</span>` : ''}
            </div>
        </div>
        <div class="sets-container" id="sets-container-${exerciseIndex}">
            <!-- Séries générées dynamiquement -->
        </div>
    `}
`;
        
        container.appendChild(exerciseElement);
        
        const setsContainer = document.getElementById(`sets-container-${exerciseIndex}`);
        exercise.sets.forEach((set, setIndex) => {
            const setElement = createSetElement(exerciseIndex, setIndex, set);
if (setElement) setsContainer.appendChild(setElement);
            setsContainer.appendChild(setElement);
        });
    });
}

function createSetElement(exerciseIndex, setIndex, set) {
    const exercise = activeWorkout.exercises[exerciseIndex];
    const isCollapsed = activeWorkout.exercises[exerciseIndex]?.collapsed || false;
    
    if (isCollapsed) return '';
    
    // DÉTERMINER LE MODE D'AFFICHAGE POUR CET EXERCICE
    const useCompactMode = exercise.compactModeOverride !== undefined 
        ? exercise.compactModeOverride 
        : settings.compactMode;

    // NOUVELLE LOGIQUE: Vérifier si c'est une reprise de séance avec données historiques
    const isRedoWorkout = exercise.historicalSets && exercise.historicalSets.length > 0;
    const historicalSet = isRedoWorkout ? exercise.historicalSets[setIndex] : null;
    
    // Si c'est une reprise avec données historiques, utiliser les valeurs historiques
    if (isRedoWorkout && historicalSet) {
        set.reps = historicalSet.reps !== undefined ? historicalSet.reps : userProfile.defaultReps;
        set.weight = historicalSet.weight !== undefined ? historicalSet.weight : userProfile.defaultWeight;
    }
    
    // --- CORRECTION: Déterminer l'état du bouton mode ---
    let buttonIcon = '';
    let buttonTitle = '';
    let buttonColor = '';
    
    if (exercise.compactModeOverride !== undefined) {
        // Forçage explicite par l'utilisateur
        if (exercise.compactModeOverride === true) {
            buttonIcon = 'mobile-alt';
            buttonTitle = 'Mode compact forcé';
            buttonColor = 'var(--primary)';
        } else {
            buttonIcon = 'file-alt';
            buttonTitle = 'Mode normal forcé';
            buttonColor = 'var(--warning)';
        }
    } else {
        // Mode global - afficher l'ÉTAT ACTUEL du paramètre
        if (settings.compactMode === true) {
            buttonIcon = 'mobile-alt';
            buttonTitle = 'Mode compact (global)';
            buttonColor = 'var(--primary)';
        } else {
            buttonIcon = 'file-alt';
            buttonTitle = 'Mode normal (global)';
            buttonColor = 'var(--secondary)';
        }
    }
    // --- FIN CORRECTION ---
    
    // Mode compact
    if (useCompactMode) {
        const setElement = document.createElement('div');
        setElement.className = `set-item-compact ${set.completed ? 'completed' : ''}`;
        setElement.id = `set-${exerciseIndex}-${setIndex}`;
        setElement.style.minHeight = '60px';
        setElement.style.padding = '10px 12px';
        setElement.style.display = 'grid';
        setElement.style.gridTemplateColumns = '60px 1fr 1fr auto';
        setElement.style.gap = '8px';
        setElement.style.alignItems = 'center';
        setElement.style.transition = 'none';
        
        const repsValue = set.reps !== undefined ? set.reps : userProfile.defaultReps;
        const weightValue = set.weight !== undefined ? set.weight : userProfile.defaultWeight;
        
        let previousSetInfo = '';
        if (isRedoWorkout && historicalSet) {
            previousSetInfo = `
                <div class="previous-set-info-compact" style="grid-column: 1 / -1; font-size: 9px; color: var(--text-secondary); margin-top: 4px; padding-top: 4px; border-top: 1px dashed var(--border); font-style: italic;">
                    <i class="fas fa-history" style="margin-right: 4px;"></i>Série précédente (historique): ${historicalSet.reps} reps × ${historicalSet.weight}kg
                </div>
            `;
        } else if (setIndex > 0) {
            const prevSet = activeWorkout.exercises[exerciseIndex].sets[setIndex - 1];
            if (prevSet) {
                const prevReps = prevSet.reps !== undefined ? prevSet.reps : userProfile.defaultReps;
                const prevWeight = prevSet.weight !== undefined ? prevSet.weight : userProfile.defaultWeight;
                
                previousSetInfo = `
                    <div class="previous-set-info-compact" style="grid-column: 1 / -1; font-size: 9px; color: var(--text-secondary); margin-top: 4px; padding-top: 4px; border-top: 1px dashed var(--border); font-style: italic;">
                        <i class="fas fa-arrow-up" style="margin-right: 4px;"></i>Série précédente: ${prevReps} reps × ${prevWeight}kg
                    </div>
                `;
            }
        } else if (!isRedoWorkout) {
            const exerciseName = activeWorkout.exercises[exerciseIndex].name;
            const previousData = findPreviousExerciseData(exerciseName);
            if (previousData) {
                previousSetInfo = `
                    <div class="previous-set-info-compact" style="grid-column: 1 / -1; font-size: 9px; color: var(--text-secondary); margin-top: 4px; padding-top: 4px; border-top: 1px dashed var(--border); font-style: italic;">
                        <i class="fas fa-history" style="margin-right: 4px;"></i>Dernière performance: ${previousData.reps} reps × ${previousData.weight}kg
                    </div>
                `;
            }
        }
        
        const isSuperset = exercise.supersetId;
        let isLastInSuperset = false;
        
        if (isSuperset) {
            const supersetExercises = activeWorkout.exercises.filter(ex => ex.supersetId === exercise.supersetId);
            isLastInSuperset = exercise.supersetOrder === supersetExercises.length;
        }
        
        setElement.innerHTML = `
            <div style="font-weight: 800; color: ${set.completed ? 'white' : 'var(--text-primary)'}; font-size: var(--font-size-sm); text-align: center; min-width: 50px;">
                S${set.number}
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 3px;">
                <div style="font-size: 9px; color: ${set.completed ? 'rgba(255,255,255,0.9)' : 'var(--text-secondary)'}; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap;">
                    Reps
                </div>
                <input type="text" 
                       style="background: ${set.completed ? 'rgba(0,0,0,0.2)' : 'var(--card-bg)'}; 
                              color: ${set.completed ? 'white' : 'var(--text-primary)'}; 
                              border: 1px solid ${set.completed ? 'rgba(255,255,255,0.3)' : 'var(--border)'}; 
                              border-radius: var(--radius-sm); 
                              padding: 8px 6px; 
                              font-size: var(--font-size-base); 
                              text-align: center; 
                              width: 100%; 
                              font-weight: 700; 
                              height: 36px;" 
                       value="${repsValue}" 
                       oninput="updateSet(${exerciseIndex}, ${setIndex}, 'reps', this.value)" 
			onclick="this.select()"  // ✅ NOUVEAU
                       ${set.completed ? 'disabled' : ''}>
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 3px;">
                <div style="font-size: 9px; color: ${set.completed ? 'rgba(255,255,255,0.9)' : 'var(--text-secondary)'}; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap;">
                    Kg
                </div>
                <input type="number" 
                       style="background: ${set.completed ? 'rgba(0,0,0,0.2)' : 'var(--card-bg)'}; 
                              color: ${set.completed ? 'white' : 'var(--text-primary)'}; 
                              border: 1px solid ${set.completed ? 'rgba(255,255,255,0.3)' : 'var(--border)'}; 
                              border-radius: var(--radius-sm); 
                              padding: 8px 6px; 
                              font-size: var(--font-size-base); 
                              text-align: center; 
                              width: 100%; 
                              font-weight: 700; 
                              height: 36px;" 
                       value="${weightValue}" 
                       oninput="updateSet(${exerciseIndex}, ${setIndex}, 'weight', this.value)"
			onclick="this.select()"  // ✅ NOUVEAU 
                       ${set.completed ? 'disabled' : ''}>
            </div>
            
            <div style="display: flex; gap: 5px; align-items: center; min-width: 100px;">
                ${isSuperset ? (
                    isLastInSuperset ? 
                        `<button style="background: ${set.completed ? 'rgba(255,255,255,0.2)' : 'var(--card-bg)'}; 
                                border: 1px solid ${set.completed ? 'rgba(255,255,255,0.3)' : 'var(--border)'}; 
                                color: ${set.completed ? 'white' : 'var(--text-secondary)'}; 
                                width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: var(--font-size-sm);" 
                         onclick="completeSet(${exerciseIndex}, ${setIndex})" ${set.completed ? 'disabled style="opacity:0.5"' : ''}>
                            <i class="fas fa-running"></i>
                        </button>` : 
                        `<button style="background: var(--warning); color: white; width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: var(--font-size-sm);" 
                         onclick="showSupersetButtonWarning()" ${set.completed ? 'disabled style="opacity:0.5"' : ''}>
                            <i class="fas fa-exclamation-triangle"></i>
                        </button>`
                ) : (
                    `<button style="background: ${set.completed ? 'rgba(255,255,255,0.2)' : 'var(--card-bg)'}; 
                            border: 1px solid ${set.completed ? 'rgba(255,255,255,0.3)' : 'var(--border)'}; 
                            color: ${set.completed ? 'white' : 'var(--text-secondary)'}; 
                            width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: var(--font-size-sm);" 
                     onclick="completeSet(${exerciseIndex}, ${setIndex})" ${set.completed ? 'disabled style="opacity:0.5"' : ''}>
                        <i class="fas fa-check"></i>
                    </button>`
                )}
                <div style="width: 20px; height: 20px; border: 2px solid ${set.completed ? 'var(--success)' : 'var(--border)'}; 
                      border-radius: 4px; display: flex; justify-content: center; align-items: center; cursor: pointer; 
                      background: ${set.completed ? 'var(--success)' : 'var(--card-bg)'};" 
                     onclick="toggleSetCompletion(${exerciseIndex}, ${setIndex})">
                    <div style="color: white; font-size: 10px; font-weight: bold; ${set.completed ? 'opacity: 1' : 'opacity: 0'}">✓</div>
                </div>
            </div>
            
            ${previousSetInfo}
            
            ${isSuperset ? `
                <div style="grid-column: 1 / -1; font-size: 9px; color: #8B5CF6; margin: 5px 0; padding: 6px 8px; background: rgba(139, 92, 246, 0.1); border-radius: 6px; border-left: 2px solid #8B5CF6; font-weight: 600;">
                    <i class="fas fa-link"></i> Superset "${exercise.supersetName || 'Sans nom'}" • Exercice ${exercise.supersetOrder}
                </div>
            ` : ''}
        `;
        
        if (set.completed) {
            setElement.style.background = 'var(--success)';
            setElement.style.borderColor = 'var(--success)';
            setElement.style.color = 'white';
        }
        
        return setElement;
    }
    
    // MODE NON-COMPACT (code existant, non modifié)
    const setElement = document.createElement('div');
    setElement.className = `set-item ${set.completed ? 'completed' : ''}`;
    setElement.id = `set-${exerciseIndex}-${setIndex}`;
    
    const repsValue = set.reps !== undefined ? set.reps : userProfile.defaultReps;
    const weightValue = set.weight !== undefined ? set.weight : userProfile.defaultWeight;
    
    let previousSetInfo = '';
    if (isRedoWorkout && historicalSet) {
        previousSetInfo = `
            <div class="previous-set-info">
                <i class="fas fa-history"></i> Série précédente (historique): ${historicalSet.reps} reps × ${historicalSet.weight}kg
            </div>
        `;
    } else if (setIndex > 0) {
        const prevSet = activeWorkout.exercises[exerciseIndex].sets[setIndex-1];
        if (prevSet) {
            previousSetInfo = `
                <div class="previous-set-info">
                    <i class="fas fa-arrow-up"></i> Série précédente: ${prevSet.reps || userProfile.defaultReps} reps × ${prevSet.weight || userProfile.defaultWeight}kg
                </div>
            `;
        }
    } else if (!isRedoWorkout) {
        const exerciseName = activeWorkout.exercises[exerciseIndex].name;
        const previousData = findPreviousExerciseData(exerciseName);
        if (previousData) {
            previousSetInfo = `
                <div class="previous-set-info">
                    <i class="fas fa-history"></i> Dernière performance: ${previousData.reps} reps × ${previousData.weight}kg
                </div>
            `;
        }
    }
    
    const isSuperset = exercise.supersetId;
    const supersetInfo = isSuperset ? `
        <div class="superset-navigation-hint">
            <i class="fas fa-link"></i> Superset "${exercise.supersetName || 'Sans nom'}" • Exercice ${exercise.supersetOrder}
        </div>
    ` : '';
    
    setElement.innerHTML = `
        <div class="set-header">
            <div class="set-number">Série ${set.number}</div>
            <div class="set-controls">
                <button class="action-btn" onclick="completeSet(${exerciseIndex}, ${setIndex})" ${set.completed ? 'disabled' : ''}>
                    <i class="fas fa-check"></i> Terminer
                </button>
                <div class="checkbox ${set.completed ? 'checked' : ''}" onclick="toggleSetCompletion(${exerciseIndex}, ${setIndex})">
                    <div class="checkmark">✓</div>
                </div>
            </div>
        </div>
        
        <div class="set-inputs-grid">
            <div class="input-group">
                <div class="input-label">
                    <i class="fas fa-redo"></i> Répétitions
                </div>
                <input type="text" class="number-input" value="${repsValue}" 
                       oninput="updateSet(${exerciseIndex}, ${setIndex}, 'reps', this.value)" 
			onclick="this.select()"  // ✅ NOUVEAU
                       ${set.completed ? 'disabled' : ''}>
            </div>
            
            <div class="input-group">
                <div class="input-label">
                    <i class="fas fa-weight-hanging"></i> Poids (kg)
                </div>
                <input type="number" class="number-input" value="${weightValue}" 
                       oninput="updateSet(${exerciseIndex}, ${setIndex}, 'weight', this.value)" 
			onclick="this.select()"  // ✅ NOUVEAU
                       ${set.completed ? 'disabled' : ''}>
            </div>
        </div>
        
        ${supersetInfo}
        
        <div class="set-actions">
            <div class="set-status">
                <span style="font-size: var(--font-size-sm); color: ${set.completed ? 'rgba(255,255,255,0.8)' : 'var(--text-secondary)'};">
                    ${set.completed ? '<i class="fas fa-check-circle"></i> Terminée' : '<i class="far fa-clock"></i> En attente'}
                </span>
            </div>
            <button class="set-complete-btn ${set.completed ? 'completed' : ''}" onclick="completeSet(${exerciseIndex}, ${setIndex})" ${set.completed ? 'disabled' : ''}>
                <i class="fas fa-${set.completed ? 'check' : 'play'}"></i> ${set.completed ? 'Terminée' : 'Marquer comme terminée'}
            </button>
        </div>
        
        ${previousSetInfo}
    `;
    
    return setElement;
}

function findPreviousExerciseData(exerciseName) {
    if (!workoutHistory || workoutHistory.length === 0) {
        return null;
    }
    
    // Chercher la DERNIÈRE SÉANCE où cet exercice a été fait
    for (const session of workoutHistory) {
        for (const exercise of session.exercises) {
            if (exercise.name === exerciseName && exercise.sets && exercise.sets.length > 0) {
                // Calculer la MOYENNE des séries de la dernière séance
                let totalReps = 0;
                let totalWeight = 0;
                let setCount = 0;
                
                exercise.sets.forEach(set => {
                    const reps = parseInt(set.reps) || 0;
                    const weight = parseFloat(set.weight) || 0;
                    
                    if (reps > 0 && weight > 0) {
                        totalReps += reps;
                        totalWeight += weight;
                        setCount++;
                    }
                });
                
                if (setCount > 0) {
                    return {
                        reps: Math.round(totalReps / setCount),
                        weight: Math.round((totalWeight / setCount) * 10) / 10, // 1 décimale
                        sessionDate: session.date,
                        isAverage: true // Indiquer que c'est une moyenne
                    };
                }
            }
        }
    }
    
    return null;
}

function updateSet(exerciseIndex, setIndex, field, value) {
    if (!activeWorkout) return;
    
    // RÉPARATION: Nettoyer la valeur
    let cleanedValue = value;
    
    if (field === 'weight') {
        // Pour le poids: convertir en nombre, remplacer les virgules par des points
        cleanedValue = parseFloat(value.toString().replace(',', '.')) || 0;
    } else if (field === 'reps') {
        // Pour les reps: garder comme texte mais nettoyer
        cleanedValue = value.toString().trim();
        if (cleanedValue === '') {
            cleanedValue = userProfile.defaultReps;
        }
    }
    
    // Mettre à jour la valeur
    activeWorkout.exercises[exerciseIndex].sets[setIndex][field] = cleanedValue;
    
    // Recalculer le poids total
    recalculateTotalWeight();
}

function completeSet(exerciseIndex, setIndex) {
    if (!activeWorkout) return;
    
    const exercise = activeWorkout.exercises[exerciseIndex];
    const set = exercise.sets[setIndex];
    
    // RÉPARATION: S'assurer que les valeurs sont définies avant de compléter
    if (set.reps === undefined) {
        set.reps = userProfile.defaultReps;
    }
    if (set.weight === undefined) {
        set.weight = userProfile.defaultWeight;
    }
    
    // Vérifier si on est dans un superset
    if (exercise.supersetId) {
        const supersetExercises = activeWorkout.exercises.filter(ex => ex.supersetId === exercise.supersetId);
        const isLastExerciseInSuperset = exercise.supersetOrder === supersetExercises.length;
        
        if (!isLastExerciseInSuperset) {
            // Pas le dernier exercice du superset: empêcher d'utiliser le bouton Terminer
            showNotification('⚠️ Pour les supersets, utilisez la case ✓ pour passer au prochain exercice sans timer', 'warning');
            return; // Ne pas terminer la série
        }
        
        // C'est le dernier exercice d'un superset
        set.completed = true;
        activeWorkout.completedSets++;
        
        recalculateTotalWeight();
        
        // 🔴 CORRECTION: Forcer le mode d'affichage avant mise à jour
        const useCompactMode = exercise.compactModeOverride !== undefined 
            ? exercise.compactModeOverride 
            : settings.compactMode;
        exercise._tempDisplayMode = useCompactMode;
        
        updateSetDisplay(exerciseIndex, setIndex);
        
        // ALERTE SONORE ET VIBRATION POUR SÉRIE TERMINÉE
        playSetCompleteAlert();
        
        // Démarrer le timer pour le superset
        if (settings.autoTimer) {
            const restTime = exercise.customRest || userProfile.defaultRest;
            
            if (!document.getElementById('timer-container').classList.contains('active')) {
                currentTimerSeconds = restTime;
                updateTimerDisplay();
                document.getElementById('timer-container').classList.add('active');
                
                // Sauvegarder les informations du superset pour le timer
                currentSupersetExerciseIndex = exerciseIndex;
                currentSupersetSetIndex = setIndex;
                currentSupersetRoundInfo = {
                    supersetExercises: supersetExercises,
                    currentSetIndex: setIndex,
                    timerDuration: restTime
                };
                
                startTimer();
                showNotification(`Timer démarré (${restTime}s) - Repos avant prochain tour`, 'info');
            }
        }
        
        showNotification('Série terminée ! Timer démarré pour le superset');
        handleSupersetProgression(exerciseIndex, setIndex, 'complete');
        
    } else {
        // SÉANCE NORMALE (sans superset)
        set.completed = true;
        activeWorkout.completedSets++;
        
        recalculateTotalWeight();
        
        // 🔴 CORRECTION: Forcer le mode d'affichage avant mise à jour
        const useCompactMode = exercise.compactModeOverride !== undefined 
            ? exercise.compactModeOverride 
            : settings.compactMode;
        exercise._tempDisplayMode = useCompactMode;
        
        updateSetDisplay(exerciseIndex, setIndex);
        
        // ALERTE SONORE ET VIBRATION POUR SÉRIE TERMINÉE
        playSetCompleteAlert();
        
        // Gérer le timer automatique pour les séances normales
        if (settings.autoTimer) {
            const restTime = exercise.customRest || userProfile.defaultRest;
            
            if (!document.getElementById('timer-container').classList.contains('active')) {
                currentTimerSeconds = restTime;
                updateTimerDisplay();
                document.getElementById('timer-container').classList.add('active');
                startTimer();
            } else if (isTimerRunning) {
                if (currentTimerSeconds !== restTime) {
                    currentTimerSeconds = restTime;
                    updateTimerDisplay();
                    pauseTimer();
                    startTimer();
                    showNotification(`Timer ajusté à ${restTime} secondes`);
                }
            }
        }
        
        showNotification('Série terminée !');
    }
}

function toggleSetCompletion(exerciseIndex, setIndex) {
    if (!activeWorkout) return;
    
    const exercise = activeWorkout.exercises[exerciseIndex];
    const set = exercise.sets[setIndex];
    
    // RÉPARATION: S'assurer que les valeurs sont définies avant de basculer
    if (set.reps === undefined) {
        set.reps = userProfile.defaultReps;
    }
    if (set.weight === undefined) {
        set.weight = userProfile.defaultWeight;
    }
    
    // Vérifier si on est dans un superset
    if (exercise.supersetId) {
        // SUPERSET : ne permettre que de cocher (pas de décocher)
        if (set.completed) {
            showNotification('Dans un superset, une série cochée ne peut pas être décochée', 'warning');
            return;
        }
        
        set.completed = true;
        activeWorkout.completedSets++;
        
        recalculateTotalWeight();
        updateSetDisplay(exerciseIndex, setIndex);
        
        showNotification('Série cochée ✓ (sans timer)');
        handleSupersetProgression(exerciseIndex, setIndex, 'check');
        
    } else {
        // SÉANCE NORMALE : permettre de cocher/décocher
        set.completed = !set.completed;
        
        // Mettre à jour le compteur de séries complétées
        activeWorkout.completedSets += set.completed ? 1 : -1;
        
        // Recalculer le poids total
        recalculateTotalWeight();
        
        // 🔴 CORRECTION: Forcer le mode d'affichage avant mise à jour
        const useCompactMode = exercise.compactModeOverride !== undefined 
            ? exercise.compactModeOverride 
            : settings.compactMode;
        
        // Stocker temporairement pour updateSetDisplay
        exercise._tempDisplayMode = useCompactMode;
        
        // Mettre à jour l'affichage
        updateSetDisplay(exerciseIndex, setIndex);
        
        showNotification(set.completed ? 'Série cochée ✓' : 'Série décochée');
    }
}

function updateSetDisplay(exerciseIndex, setIndex) {
    const setElement = document.getElementById(`set-${exerciseIndex}-${setIndex}`);
    if (!setElement) return;
    
    const set = activeWorkout.exercises[exerciseIndex].sets[setIndex];
    const exercise = activeWorkout.exercises[exerciseIndex];
    
    // 🔴 CORRECTION: Déterminer le mode d'affichage
    const useCompactMode = exercise._tempDisplayMode !== undefined 
        ? exercise._tempDisplayMode 
        : (exercise.compactModeOverride !== undefined 
            ? exercise.compactModeOverride 
            : settings.compactMode);
    
    // Nettoyer la variable temporaire
    delete exercise._tempDisplayMode;
    
    const isSupersetActive = exercise.supersetId && !set.completed;
    
    // 🔴 CORRECTION: Appliquer la classe CSS selon le mode
    if (useCompactMode) {
        // Mode compact - fond vert complet
        setElement.className = `set-item-compact ${set.completed ? 'completed' : ''} ${isSupersetActive ? 'superset-active' : ''}`;
        if (set.completed) {
            setElement.style.background = 'var(--success)';
            setElement.style.borderColor = 'var(--success)';
            setElement.style.color = 'white';
        } else {
            setElement.style.background = '';
            setElement.style.borderColor = '';
            setElement.style.color = '';
        }
    } else {
        // Mode normal - seulement le contour vert
        setElement.className = `set-item ${set.completed ? 'completed' : ''} ${isSupersetActive ? 'superset-active' : ''}`;
        // Réinitialiser le fond (le CSS gère le contour)
        setElement.style.background = '';
        setElement.style.borderColor = '';
        setElement.style.color = '';
    }
    
    // Désactiver/activer les inputs
    const inputs = setElement.querySelectorAll('.number-input');
    inputs.forEach(input => {
        input.disabled = set.completed;
    });
    
    const completeButton = setElement.querySelector('.action-btn');
    if (completeButton) {
        completeButton.disabled = set.completed;
        completeButton.style.opacity = set.completed ? '0.5' : '1';
    }
    
    const checkbox = setElement.querySelector('.checkbox');
    if (checkbox) {
        checkbox.className = `checkbox ${set.completed ? 'checked' : ''}`;
    }
    
    // Mettre à jour les statistiques globales
    document.getElementById('completed-sets').textContent = activeWorkout.completedSets;
}

function recalculateTotalWeight() {
    if (!activeWorkout) return;
    
    let totalWeight = 0;
    activeWorkout.exercises.forEach(exercise => {
        exercise.sets.forEach(set => {
            if (set.completed) {
                // RÉPARATION: S'assurer que les valeurs sont définies
                const reps = parseInt(set.reps) || 0;
                const weight = parseFloat(set.weight) || 0;
                totalWeight += weight * reps;
            }
        });
    });
    
    activeWorkout.totalWeight = totalWeight;
    document.getElementById('total-weight').textContent = `${totalWeight}kg`;
}

function addSet(exerciseIndex) {
    if (!activeWorkout) return;
    
    const exercise = activeWorkout.exercises[exerciseIndex];
    const newSetNumber = exercise.sets.length + 1;
    
    exercise.sets.push({
        number: newSetNumber,
        reps: userProfile.defaultReps,
        weight: userProfile.defaultWeight,
        completed: false
    });
    
    updateWorkoutDisplay();
}

function removeSet(exerciseIndex) {
    if (!activeWorkout) return;
    
    const exercise = activeWorkout.exercises[exerciseIndex];
    if (exercise.sets.length <= 1) {
        showNotification('Un exercice doit avoir au moins une série', 'warning');
        return;
    }
    
    if (confirm(`Supprimer la dernière série de "${exercise.name}" ?`)) {
        // Soustraire si la dernière série était complétée
        if (exercise.sets[exercise.sets.length - 1].completed) {
            activeWorkout.completedSets--;
        }
        
        exercise.sets.pop();
        recalculateTotalWeight();
        updateWorkoutDisplay();
        showNotification('Dernière série supprimée');
    }
}

// Fonction d'avertissement pour le bouton Terminer dans les supersets
function showSupersetButtonWarning() {
    showNotification('⚠️ Dans un superset, utilisez la case ✓ pour passer au prochain exercice sans timer.<br>Le bouton "Terminer (avec timer)" est uniquement pour le DERNIER exercice du superset.', 'warning', 5000);
}

function removeExerciseFromWorkout(exerciseIndex) {
    if (!activeWorkout) return;
    
    if (confirm('Êtes-vous sûr de vouloir supprimer cet exercice de la séance ?')) {
        // Soustraire les séries complétées de cet exercice du compteur total
        const completedSetsInExercise = activeWorkout.exercises[exerciseIndex].sets.filter(set => set.completed).length;
        activeWorkout.completedSets -= completedSetsInExercise;
        
        // Supprimer l'exercice
        activeWorkout.exercises.splice(exerciseIndex, 1);
        
        // Si plus d'exercices, terminer la séance
        if (activeWorkout.exercises.length === 0) {
            completeWorkout();
            return;
        }
        
        // Recalculer le poids total
        recalculateTotalWeight();
        
        // Mettre à jour l'affichage
        updateWorkoutDisplay();
        
        showNotification('Exercice supprimé de la séance');
    }
}

function resetExerciseToDefaults(exerciseIndex) {
    if (!activeWorkout || !activeWorkout.exercises[exerciseIndex]) return;
    
    if (confirm('Réinitialiser toutes les séries de cet exercice aux valeurs par défaut ?')) {
        const exercise = activeWorkout.exercises[exerciseIndex];
        
        exercise.sets.forEach(set => {
            if (!set.completed) {
                set.reps = userProfile.defaultReps;
                set.weight = userProfile.defaultWeight;
            }
        });
        
        updateWorkoutDisplay();
        showNotification('Exercice réinitialisé aux valeurs par défaut');
    }
}

function moveExerciseUpInWorkout(index) {
    if (!activeWorkout || index <= 0) return;
    
    // Vérifier si l'exercice fait partie d'un superset
    const exercise = activeWorkout.exercises[index];
    const prevExercise = activeWorkout.exercises[index - 1];
    
    // Si les deux exercices font partie du même superset, on ne peut pas les séparer
    if (exercise.supersetId && prevExercise.supersetId && exercise.supersetId === prevExercise.supersetId) {
        showNotification('Impossible de séparer les exercices d\'un superset', 'warning');
        return;
    }
    
    // Si on essaye de déplacer un exercice hors de son superset
    if (exercise.supersetId && (!prevExercise.supersetId || prevExercise.supersetId !== exercise.supersetId)) {
        if (!confirm('Déplacer cet exercice hors de son superset ?')) {
            return;
        }
        // Retirer l'exercice du superset
        exercise.supersetId = null;
        exercise.supersetOrder = null;
        exercise.supersetName = null;
        exercise.supersetColor = null;
    }
    
    const temp = activeWorkout.exercises[index];
    activeWorkout.exercises[index] = activeWorkout.exercises[index - 1];
    activeWorkout.exercises[index - 1] = temp;
    
    // Mettre à jour l'ordre des supersets si nécessaire
    updateSupersetOrders();
    
    updateWorkoutDisplay();
    showNotification('Exercice déplacé vers le haut');
}

// Fonction pour mettre à jour l'ordre des exercices dans les supersets
function updateSupersetOrders() {
    // Pour chaque superset, réorganiser l'ordre
    const supersetGroups = {};
    
    activeWorkout.exercises.forEach((ex, idx) => {
        if (ex.supersetId) {
            if (!supersetGroups[ex.supersetId]) {
                supersetGroups[ex.supersetId] = [];
            }
            supersetGroups[ex.supersetId].push({ exercise: ex, index: idx });
        }
    });
    
    // Pour chaque superset, trier par position et mettre à jour l'ordre
    Object.keys(supersetGroups).forEach(supersetId => {
        const exercises = supersetGroups[supersetId];
        // Trier par position dans la séance
        exercises.sort((a, b) => a.index - b.index);
        
        // Mettre à jour l'ordre du superset
        exercises.forEach((item, order) => {
            item.exercise.supersetOrder = order + 1;
        });
    });
}

function moveExerciseDownInWorkout(index) {
    if (!activeWorkout || index >= activeWorkout.exercises.length - 1) return;
    
    // Vérifier si l'exercice fait partie d'un superset
    const exercise = activeWorkout.exercises[index];
    const nextExercise = activeWorkout.exercises[index + 1];
    
    // Si les deux exercices font partie du même superset, on ne peut pas les séparer
    if (exercise.supersetId && nextExercise.supersetId && exercise.supersetId === nextExercise.supersetId) {
        showNotification('Impossible de séparer les exercices d\'un superset', 'warning');
        return;
    }
    
    // Si on essaye de déplacer un exercice hors de son superset
    if (exercise.supersetId && (!nextExercise.supersetId || nextExercise.supersetId !== exercise.supersetId)) {
        if (!confirm('Déplacer cet exercice hors de son superset ?')) {
            return;
        }
        // Retirer l'exercice du superset
        exercise.supersetId = null;
        exercise.supersetOrder = null;
        exercise.supersetName = null;
        exercise.supersetColor = null;
    }
    
    const temp = activeWorkout.exercises[index];
    activeWorkout.exercises[index] = activeWorkout.exercises[index + 1];
    activeWorkout.exercises[index + 1] = temp;
    
    // Mettre à jour l'ordre des supersets si nécessaire
    updateSupersetOrders();
    
    updateWorkoutDisplay();
    showNotification('Exercice déplacé vers le bas');
}

// Fonction pour réduire/développer un exercice
function toggleExerciseCollapse(exerciseIndex) {
    if (!activeWorkout || !activeWorkout.exercises[exerciseIndex]) return;
    
    // Basculer l'état de compression pour cet exercice seulement
    activeWorkout.exercises[exerciseIndex].collapsed = !activeWorkout.exercises[exerciseIndex].collapsed;
    
    // Mettre à jour l'affichage correctement en utilisant l'ID spécifique
    const setsContainer = document.getElementById(`sets-container-${exerciseIndex}`);
    const exerciseElement = document.getElementById(`sets-container-${exerciseIndex}`)?.closest('.workout-exercise');
    
    if (setsContainer && exerciseElement) {
        if (activeWorkout.exercises[exerciseIndex].collapsed) {
            setsContainer.style.display = 'none';
            // Mettre à jour le titre
            const title = exerciseElement.querySelector('.exercise-title');
            if (title) {
                title.style.color = '#3B82F6';
                title.innerHTML = `${activeWorkout.exercises[exerciseIndex].name} <i class="fas fa-chevron-down" style="font-size: 12px; margin-left: 5px;"></i>`;
            }
        } else {
            setsContainer.style.display = 'block';
            // Mettre à jour le titre
            const title = exerciseElement.querySelector('.exercise-title');
            if (title) {
                title.style.color = 'var(--text-primary)';
                title.innerHTML = `${activeWorkout.exercises[exerciseIndex].name} <i class="fas fa-chevron-up" style="font-size: 12px; margin-left: 5px;"></i>`;
            }
        }
    }
    
    showNotification(activeWorkout.exercises[exerciseIndex].collapsed ? 'Exercice réduit' : 'Exercice développé');
}

// Fonction pour modifier le temps de repos d'un exercice
function showCustomRestModal(exerciseIndex) {
    const exercise = activeWorkout.exercises[exerciseIndex];
    if (!exercise) return;
    
    // Récupérer le temps actuel en secondes
    const currentSeconds = exercise.customRest || userProfile.defaultRest;
    const minutes = Math.floor(currentSeconds / 60);
    const seconds = currentSeconds % 60;
    
    // Générer les options pour les pickers - boucle infinie
    const minutesOptions = Array.from({length: 10}, (_, i) => i); // 0-9 minutes
    const secondsOptions = Array.from({length: 60}, (_, i) => i); // 0-59 secondes
    
    const modalContent = `
        <div class="input-group">
            <div class="input-label">⏱️ Temps de repos pour "${exercise.name}"</div>
            <div style="font-size: var(--font-size-xs); color: var(--text-secondary); margin-bottom: 10px;">
                <i class="fas fa-clock"></i> Valeur par défaut: ${userProfile.defaultRest}s 
                (${Math.floor(userProfile.defaultRest/60)}:${(userProfile.defaultRest%60).toString().padStart(2, '0')})
            </div>
        </div>
        
        <div style="margin: 15px 0; text-align: center; background: linear-gradient(135deg, rgba(99,102,241,0.1), rgba(129,140,248,0.05)); padding: 15px; border-radius: var(--radius); border: 1px solid rgba(99,102,241,0.15);">
            <div style="font-size: var(--font-size-2xl); font-weight: 900; color: var(--primary); margin-bottom: 5px; letter-spacing: 2px; text-shadow: 0 2px 8px rgba(99,102,241,0.2);">
                <span id="selected-time-display">${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}</span>
            </div>
            <div style="font-size: var(--font-size-xs); color: var(--text-secondary); font-weight: 600;">
                Total: <span id="total-seconds-display" style="color: var(--primary);">${currentSeconds}</span> secondes
            </div>
        </div>
        
        <div class="time-picker-container">
            <!-- Picker pour les minutes -->
            <div class="time-picker-column">
                <div class="picker-column-label">MINUTES</div>
                <div class="picker-wheel-3d" id="minutes-picker"></div>
            </div>
            
            <div style="align-self: center; font-size: var(--font-size-xl); font-weight: 900; color: var(--primary); margin: 0 3px; text-shadow: 0 1px 4px rgba(99,102,241,0.2);">
                :
            </div>
            
            <!-- Picker pour les secondes -->
            <div class="time-picker-column">
                <div class="picker-column-label">SECONDES</div>
                <div class="picker-wheel-3d" id="seconds-picker"></div>
            </div>
        </div>
        
        <div style="margin-top: 20px; display: flex; gap: 15px;">
            <button class="btn btn-success" onclick="saveCustomRestFromPicker(${exerciseIndex})" style="flex: 1; padding: 14px; font-weight: 900; font-size: var(--font-size-base);">
                <i class="fas fa-check-circle"></i> CONFIRMER
            </button>
        </div>
        
        <input type="hidden" id="selected-time-seconds" value="${currentSeconds}">
        
        <div style="margin-top: 15px; text-align: center; font-size: 10px; color: var(--text-secondary);">
            <i class="fas fa-info-circle"></i> Glissez, tournez la molette ou cliquez pour ajuster
        </div>
    `;
    
    // Créer un modal temporaire
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 320px; padding-bottom: 15px;">
            <div class="modal-header">
                <h3 class="modal-title">⏱️ Temps de repos</h3>
                <button class="modal-close" onclick="this.closest('.modal').remove()">×</button>
            </div>
            <div class="modal-body">
                ${modalContent}
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Initialiser les pickers après l'ajout du DOM
    setTimeout(() => {
        initializeTimePickers();
        
        // Mettre à jour l'affichage en continu
        const updateInterval = setInterval(() => {
            if (document.querySelector('.modal.active')) {
                updateTimeDisplay();
            } else {
                clearInterval(updateInterval);
            }
        }, 100);
    }, 100);
    
    // Sauvegarder l'index de l'exercice dans le modal
    modal.dataset.exerciseIndex = exerciseIndex;
}

// Fonction pour basculer le mode compact par exercice
function toggleExerciseCompactMode(exerciseIndex) {
    if (!activeWorkout || !activeWorkout.exercises[exerciseIndex]) return;
    
    const exercise = activeWorkout.exercises[exerciseIndex];
    
    // Cycle: undefined → true → false → undefined
    if (exercise.compactModeOverride === undefined) {
        // Étape 1: Forcer mode compact
        exercise.compactModeOverride = true;
        showNotification(`Mode compact forcé pour "${exercise.name}"`, 'info');
    } else if (exercise.compactModeOverride === true) {
        // Étape 2: Forcer mode non-compact
        exercise.compactModeOverride = false;
        showNotification(`Mode normal forcé pour "${exercise.name}"`, 'info');
    } else {
        // Étape 3: Revenir au paramètre global
        exercise.compactModeOverride = undefined;
        showNotification(`Mode global utilisé pour "${exercise.name}"`, 'info');
    }
    
    // Recharger l'affichage de l'exercice
    updateWorkoutDisplay();
}

// ==================== PICKER 3D AVANCÉ ====================
class Infinite3DPicker {
    constructor(pickerId, values, initialValue) {
        this.picker = document.getElementById(pickerId);
        this.values = values;
        this.itemHeight = 36; // Réduit de 48
        this.visibleItems = 5;
        this.currentIndex = values.indexOf(initialValue);
        this.position = 0;
        this.velocity = 0;
        this.isDragging = false;
        this.lastY = 0;
        this.lastTime = 0;
        this.animationId = null;
        this.items = []; // Cache pour les éléments DOM
        this.totalItems = this.values.length * 5; // OPTIMISATION: 5 copies au lieu de 10
        this.isInitialized = false;
        
        this.init();
    }
    
    init() {
        // Créer le contenu 3D
        const content = document.createElement('div');
        content.className = 'picker-wheel-content-3d';
        content.style.height = `${this.itemHeight * this.visibleItems}px`;
        
        // Créer beaucoup d'items pour l'effet infini
        const totalItems = this.values.length * 10;
        
        for (let i = 0; i < totalItems; i++) {
            const valueIndex = i % this.values.length;
            const item = document.createElement('div');
            item.className = 'picker-item-3d';
            item.dataset.value = this.values[valueIndex];
            item.dataset.index = valueIndex;
            item.textContent = this.values[valueIndex].toString().padStart(2, '0');
            item.style.transform = `translateY(${(i - Math.floor(totalItems/2)) * this.itemHeight}px)`;
            content.appendChild(item);
        }
        
        // Ajouter le highlight et glow
        const highlight = document.createElement('div');
        highlight.className = 'picker-highlight-3d';
        
        const glow = document.createElement('div');
        glow.className = 'picker-glow';
        
        this.picker.innerHTML = '';
        this.picker.appendChild(highlight);
        this.picker.appendChild(glow);
        this.picker.appendChild(content);
        
        this.content = content;
        this.items = content.querySelectorAll('.picker-item-3d');
        
        // Centrer sur la valeur initiale
        this.centerOnIndex(this.currentIndex + Math.floor(totalItems/2));
        
        // Événements
        this.setupEvents();
        
        // Animation continue
        this.animate();
    }
    
    setupEvents() {
        let startY, startTime;
        
        // Touch events
        this.picker.addEventListener('touchstart', (e) => {
            e.preventDefault();
            this.isDragging = true;
            startY = e.touches[0].clientY;
            startTime = Date.now();
            this.velocity = 0;
            this.lastY = startY;
            this.lastTime = startTime;
            cancelAnimationFrame(this.animationId);
        });
        
        this.picker.addEventListener('touchmove', (e) => {
            if (!this.isDragging) return;
            e.preventDefault();
            
            const currentY = e.touches[0].clientY;
            const currentTime = Date.now();
            const deltaY = currentY - this.lastY;
            const deltaTime = currentTime - this.lastTime;
            
            if (deltaTime > 0) {
                this.velocity = deltaY / deltaTime;
                this.position += deltaY;
                this.updateItems();
                
                this.lastY = currentY;
                this.lastTime = currentTime;
            }
        });
        
        this.picker.addEventListener('touchend', (e) => {
            e.preventDefault();
            this.isDragging = false;
            this.applyMomentum();
        });
        
        // Mouse events
        this.picker.addEventListener('mousedown', (e) => {
            e.preventDefault();
            this.isDragging = true;
            startY = e.clientY;
            startTime = Date.now();
            this.velocity = 0;
            this.lastY = startY;
            this.lastTime = startTime;
            cancelAnimationFrame(this.animationId);
        });
        
        document.addEventListener('mousemove', (e) => {
            if (!this.isDragging) return;
            e.preventDefault();
            
            const currentY = e.clientY;
            const currentTime = Date.now();
            const deltaY = currentY - this.lastY;
            const deltaTime = currentTime - this.lastTime;
            
            if (deltaTime > 0) {
                this.velocity = deltaY / deltaTime;
                this.position += deltaY;
                this.updateItems();
                
                this.lastY = currentY;
                this.lastTime = currentTime;
            }
        });
        
        document.addEventListener('mouseup', (e) => {
            if (!this.isDragging) return;
            this.isDragging = false;
            this.applyMomentum();
        });
        
        // Wheel events
        this.picker.addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 1 : -1;
            this.position += delta * this.itemHeight * 0.5;
            this.updateItems();
            this.applyMomentum();
        });
    }
    
    updateItems() {
        const centerOffset = this.itemHeight * this.visibleItems / 2;
        
        // OPTIMISATION: Utiliser requestAnimationFrame pour les mises à jour
        for (let i = 0; i < this.items.length; i++) {
            const item = this.items[i];
            const y = (i - Math.floor(this.items.length/2)) * this.itemHeight + this.position;
            const distanceFromCenter = Math.abs(y);
            const scale = Math.max(0.3, 1 - distanceFromCenter / (centerOffset * 2));
            const opacity = Math.max(0.1, 1 - distanceFromCenter / (centerOffset * 1.5));
            const rotation = (y / centerOffset) * 30;
            
            // OPTIMISATION: Appliquer les styles en une seule opération
            item.style.transform = `translateY(${y}px) rotateX(${rotation}deg) scale(${scale})`;
            item.style.opacity = opacity;
            item.style.zIndex = Math.round(100 - distanceFromCenter);
            
            // Gérer la sélection
            const isSelected = Math.abs(y) < this.itemHeight * 0.5;
            if (isSelected) {
                item.classList.add('selected');
                this.currentIndex = parseInt(item.dataset.index);
            } else {
                item.classList.remove('selected');
            }
        }
        
        // Normalisation infinie
        if (Math.abs(this.position) > this.itemHeight * this.values.length * 2) {
            this.position %= (this.itemHeight * this.values.length);
        }
        
        // Mettre à jour l'affichage
        if (typeof window.updateTimeDisplay === 'function') {
            window.updateTimeDisplay();
        }
    }
    
    applyMomentum() {
        if (Math.abs(this.velocity) < 0.1) {
            this.snapToNearest();
            return;
        }
        
        const friction = 0.95;
        const apply = () => {
            this.velocity *= friction;
            this.position += this.velocity * 16;
            this.updateItems();
            
            if (Math.abs(this.velocity) > 0.1) {
                this.animationId = requestAnimationFrame(apply);
            } else {
                this.snapToNearest();
            }
        };
        
        this.animationId = requestAnimationFrame(apply);
    }
    
    snapToNearest() {
        const targetPosition = -this.currentIndex * this.itemHeight;
        const startPosition = this.position;
        const distance = targetPosition - startPosition;
        const duration = 300;
        const startTime = Date.now();
        
        const animate = () => {
            const elapsed = Date.now() - startTime;
            const progress = Math.min(elapsed / duration, 1);
            const ease = 1 - Math.pow(1 - progress, 3);
            
            this.position = startPosition + (distance * ease);
            this.updateItems();
            
            if (progress < 1) {
                this.animationId = requestAnimationFrame(animate);
            }
        };
        
        this.animationId = requestAnimationFrame(animate);
    }
    
    centerOnIndex(index) {
        this.position = -index * this.itemHeight;
        this.updateItems();
    }
    
    getSelectedValue() {
        return this.values[this.currentIndex];
    }
    
    animate() {
        // Animation continue subtile
        if (!this.isDragging && Math.abs(this.velocity) < 0.01) {
            this.position += Math.sin(Date.now() * 0.001) * 0.1;
            this.updateItems();
        }
        requestAnimationFrame(() => this.animate());
    }
}

// Gestionnaires globaux
let minutesPicker, secondsPicker;

// MODIFIEZ cette fonction dans la classe Infinite3DPicker ou globalement
function initializeTimePickers() {
    // Récupérer la valeur du champ caché qui contient le bon temps
    const hiddenInput = document.getElementById('selected-time-seconds');
    const currentSeconds = hiddenInput ? parseInt(hiddenInput.value) : (exercise.customRest || userProfile.defaultRest);
    
    const currentMinutes = Math.floor(currentSeconds / 60);
    const currentSecondsRemainder = currentSeconds % 60;
    
    const minutes = Array.from({length: 10}, (_, i) => i); // 0-9 minutes
    const seconds = Array.from({length: 60}, (_, i) => i); // 0-59 secondes
    
    // Réinitialiser les pickers s'ils existent déjà
    if (minutesPicker && typeof minutesPicker.destroy === 'function') {
        minutesPicker.destroy();
    }
    if (secondsPicker && typeof secondsPicker.destroy === 'function') {
        secondsPicker.destroy();
    }
    
    // Initialiser avec les bonnes valeurs
    minutesPicker = new Infinite3DPicker('minutes-picker', minutes, currentMinutes);
    secondsPicker = new Infinite3DPicker('seconds-picker', seconds, currentSecondsRemainder);
}

function updateTimeDisplay() {
    if (!minutesPicker || !secondsPicker) return;
    
    const selectedMinutes = minutesPicker.getSelectedValue();
    const selectedSeconds = secondsPicker.getSelectedValue();
    const totalSeconds = (selectedMinutes * 60) + selectedSeconds;
    
    const timeDisplay = document.getElementById('selected-time-display');
    const secondsDisplay = document.getElementById('total-seconds-display');
    const hiddenInput = document.getElementById('selected-time-seconds');
    
    if (timeDisplay) {
        timeDisplay.textContent = 
            `${selectedMinutes.toString().padStart(2, '0')}:${selectedSeconds.toString().padStart(2, '0')}`;
    }
    
    if (secondsDisplay) {
        secondsDisplay.textContent = totalSeconds;
    }
    
    if (hiddenInput) {
        hiddenInput.value = totalSeconds;
    }
}

function saveCustomRestFromPicker(exerciseIndex) {
    const modal = document.querySelector('.modal.active');
    if (!modal) return;
    
    // Utiliser votre fonction qui marche
    const timeValues = getSelectedTimeValues();
    const totalSeconds = (timeValues.minutes * 60) + timeValues.seconds;
    
    // Validation
    if (totalSeconds < 15) {
        showNotification('Le temps de repos minimum est de 15 secondes', 'error');
        return;
    }
    
    if (totalSeconds > 600) {
        showNotification('Le temps de repos maximum est de 10 minutes', 'error');
        return;
    }
    
    // Mettre à jour l'exercice
    if (activeWorkout && activeWorkout.exercises[exerciseIndex]) {
        activeWorkout.exercises[exerciseIndex].customRest = totalSeconds;
    }
    
    // Fermer le modal
    modal.remove();
    
    // Mettre à jour l'affichage
    if (activeWorkout) {
        updateWorkoutDisplay();
    }
    
    // Notification
    const formattedTime = `${timeValues.minutes.toString().padStart(2, '0')}:${timeValues.seconds.toString().padStart(2, '0')}`;
    showNotification(`⏱️ Temps de repos défini à ${formattedTime} (${totalSeconds}s)`);
}

// REMPLACER la fonction getSelectedTimeValues() par cette nouvelle version :
function getSelectedTimeValues() {
    const minutesPicker = document.getElementById('minutes-picker');
    const secondsPicker = document.getElementById('seconds-picker');
    
    if (!minutesPicker || !secondsPicker) return { minutes: 0, seconds: 0 };
    
    let selectedMinutes = 0;
    let selectedSeconds = 0;
    
    // Chercher les items sélectionnés dans les nouveaux pickers 3D
    const minutesSelected = minutesPicker.querySelector('.picker-item-3d.selected');
    const secondsSelected = secondsPicker.querySelector('.picker-item-3d.selected');
    
    if (minutesSelected) {
        selectedMinutes = parseInt(minutesSelected.dataset.value) || 0;
    }
    
    if (secondsSelected) {
        selectedSeconds = parseInt(secondsSelected.dataset.value) || 0;
    }
    
    return { minutes: selectedMinutes, seconds: selectedSeconds };
}



// ET MODIFIER la fonction saveCustomRestFromPicker pour utiliser la bonne méthode :
function saveCustomRestFromPicker(exerciseIndex) {
    const modal = document.querySelector('.modal.active');
    if (!modal) return;
    
    // Récupérer les valeurs - utiliser la nouvelle méthode
    let timeValues;
    if (minutesPicker && secondsPicker && typeof minutesPicker.getSelectedValue === 'function') {
        // Si les pickers 3D sont disponibles
        timeValues = {
            minutes: minutesPicker.getSelectedValue() || 0,
            seconds: secondsPicker.getSelectedValue() || 0
        };
    } else {
        // Sinon utiliser la méthode par sélection CSS
        timeValues = getSelectedTimeValues();
    }
    
    const totalSeconds = (timeValues.minutes * 60) + timeValues.seconds;
    
    console.log('Temps sélectionné:', timeValues, 'Total secondes:', totalSeconds); // Debug
    
    // Validation
    if (totalSeconds < 15) {
        showNotification('Le temps de repos minimum est de 15 secondes', 'error');
        return;
    }
    
    if (totalSeconds > 600) { // 10 minutes max
        showNotification('Le temps de repos maximum est de 10 minutes', 'error');
        return;
    }
    
    // Mettre à jour l'exercice
    if (activeWorkout && activeWorkout.exercises[exerciseIndex]) {
        activeWorkout.exercises[exerciseIndex].customRest = totalSeconds;
    }
    
    // Fermer le modal
    modal.remove();
    
    // Mettre à jour l'affichage
    if (activeWorkout) {
        updateWorkoutDisplay();
    }
    
    // Notification avec format MM:SS
    const formattedTime = `${timeValues.minutes.toString().padStart(2, '0')}:${timeValues.seconds.toString().padStart(2, '0')}`;
    
    showNotification(`⏱️ Temps de repos défini à ${formattedTime} (${totalSeconds}s)`);
}

// Nouvelle fonction pour sauvegarder depuis le picker
function saveCustomRestFromPicker(exerciseIndex) {
    const modal = document.querySelector('.modal.active');
    if (!modal) return;
    
    // Récupérer les valeurs via la nouvelle fonction
    const timeValues = getSelectedTimeValues();
    const totalSeconds = (timeValues.minutes * 60) + timeValues.seconds;
    
    // Validation
    if (totalSeconds < 15) {
        showNotification('Le temps de repos minimum est de 15 secondes', 'error');
        return;
    }
    
    if (totalSeconds > 600) { // 10 minutes max
        showNotification('Le temps de repos maximum est de 10 minutes', 'error');
        return;
    }
    
    // Mettre à jour l'exercice
    if (activeWorkout && activeWorkout.exercises[exerciseIndex]) {
        activeWorkout.exercises[exerciseIndex].customRest = totalSeconds;
    }
    
    // Fermer le modal
    modal.remove();
    
    // Mettre à jour l'affichage
    if (activeWorkout) {
        updateWorkoutDisplay();
    }
    
    // Notification avec format MM:SS
    const formattedTime = `${timeValues.minutes.toString().padStart(2, '0')}:${timeValues.seconds.toString().padStart(2, '0')}`;
    
    showNotification(`Temps de repos défini à ${formattedTime} (${totalSeconds}s)`);
}

// Remplacer l'ancienne fonction saveCustomRest


// Fonction pour créer un superset
function showSupersetModal(exerciseIndex) {
    if (!activeWorkout) return;
    
    // Générer un nom de superset par défaut
    const existingSupersetCount = activeWorkout.exercises.filter(ex => ex.supersetId).length;
    const defaultSupersetName = `Superset ${Math.floor(existingSupersetCount / 2) + 1}`;
    
    // Dans le HTML généré pour le modal, ajouter une prévisualisation
let modalContent = `
    <div class="input-group">
        <div class="input-label">Nom du superset</div>
        <input type="text" class="number-input" id="superset-name-input" value="${defaultSupersetName}" placeholder="Nom du superset" oninput="updateSupersetPreview()">
    </div>
    <div class="input-group">
        <div class="input-label">⚠️ Les exercices seront regroupés automatiquement</div>
        <div style="font-size: var(--font-size-xs); color: var(--text-secondary); margin-top: 5px;">
            Le premier exercice sélectionné déterminera la position du groupe
        </div>
    </div>
    <div class="input-group">
        <div class="input-label">Prévisualisation de l'ordre :</div>
        <div id="superset-preview" style="font-size: var(--font-size-sm); color: var(--text-secondary); padding: 10px; background: var(--card-bg); border-radius: var(--radius-sm); margin: 10px 0; min-height: 50px;">
            Sélectionnez des exercices pour voir la prévisualisation...
        </div>
    </div>
    <div class="input-group">
        <div class="input-label">Sélectionnez les exercices pour le superset</div>
    </div>
    <div style="max-height: 300px; overflow-y: auto; margin: 15px 0;">
    `;
    
    activeWorkout.exercises.forEach((ex, idx) => {
        const isSelected = ex.supersetId === activeWorkout.exercises[exerciseIndex].supersetId && ex.supersetId;
        const supersetName = ex.supersetId ? `Superset: ${ex.supersetName || 'Sans nom'}` : 'Non lié';
        
        modalContent += `
            <div style="padding: 10px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px;">
                <div class="checkbox ${isSelected ? 'checked' : ''}" onclick="toggleSupersetSelection(this, ${idx})">
                    <div class="checkmark">✓</div>
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 700;">${ex.name}</div>
                    <div style="font-size: var(--font-size-xs); color: ${ex.supersetId ? '#8B5CF6' : 'var(--text-secondary)'};">
                        ${supersetName}
                    </div>
                </div>
            </div>
        `;
    });
    
    modalContent += `
        </div>
        <button class="btn btn-success" onclick="createSuperset(${exerciseIndex})" style="width: 100%;">
            Créer le superset
        </button>
        <button class="btn btn-danger" onclick="removeSuperset(${exerciseIndex})" style="width: 100%; margin-top: 10px;">
            Supprimer le superset
        </button>
    `;
    
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">🔗 Créer un superset</h3>
                <button class="modal-close" onclick="this.closest('.modal').remove()">×</button>
            </div>
            <div class="modal-body">
                ${modalContent}
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function toggleSupersetSelection(checkbox, exerciseIndex) {
    checkbox.classList.toggle('checked');
}

function createSuperset(startExerciseIndex) {
    const selectedExercises = [];
    const checkboxes = document.querySelectorAll('.modal.active .checkbox.checked');
    
    checkboxes.forEach((cb, idx) => {
        const onclickAttr = cb.getAttribute('onclick');
        if (onclickAttr) {
            const match = onclickAttr.match(/toggleSupersetSelection\(this, (\d+)\)/);
            if (match && match[1]) {
                const exerciseIndex = parseInt(match[1]);
                selectedExercises.push(exerciseIndex);
            }
        }
    });
    
    if (selectedExercises.length < 2) {
        showNotification('Sélectionnez au moins 2 exercices', 'error');
        return;
    }
    
    // Récupérer le nom du superset
    const supersetName = document.getElementById('superset-name-input').value || `Superset ${Date.now()}`;
    
    // Générer un ID unique pour le superset
    const supersetId = `superset_${Date.now()}`;
    
    // Trier les exercices sélectionnés par leur position actuelle
    selectedExercises.sort((a, b) => a - b);
    
    // Identifier l'exercice de départ (premier de la sélection)
    const firstExerciseIndex = selectedExercises[0];
    
    // Créer un tableau temporaire pour les exercices du superset
    const supersetExercises = [];
    
    // Extraire les exercices sélectionnés de leur position actuelle
    selectedExercises.forEach((index, order) => {
        const exercise = activeWorkout.exercises[index];
        exercise.supersetId = supersetId;
        exercise.supersetName = supersetName;
        exercise.supersetOrder = order + 1;
        exercise.supersetColor = getSupersetColor(order);
        supersetExercises.push(exercise);
    });
    
    // Retirer les exercices sélectionnés de leur position actuelle
    for (let i = selectedExercises.length - 1; i >= 0; i--) {
        activeWorkout.exercises.splice(selectedExercises[i], 1);
    }
    
    // Insérer tous les exercices du superset à la position du premier exercice
    activeWorkout.exercises.splice(firstExerciseIndex, 0, ...supersetExercises);
    
    // Réorganiser l'ordre du superset pour qu'il soit correct
    activeWorkout.exercises.forEach((ex, idx) => {
        if (ex.supersetId === supersetId) {
            ex.supersetOrder = supersetExercises.findIndex(e => e === ex) + 1;
        }
    });
    
        document.querySelector('.modal.active').remove();
    updateWorkoutDisplay();
    
    // Notification détaillée
    const firstExercise = activeWorkout.exercises[firstExerciseIndex];
    const exerciseNames = supersetExercises.map(ex => ex.name).join(', ');
    showNotification(
        `Superset "${supersetName}" créé !<br>` +
        `Exercices: ${exerciseNames}<br>` +
        `Position: après ${firstExerciseIndex > 0 ? activeWorkout.exercises[firstExerciseIndex - 1]?.name || 'début' : 'début de séance'}`,
        'success'
    );
    
    // Marquer visuellement les exercices en superset
    highlightSupersetExercises(supersetId);
}

// Fonction pour mettre à jour la prévisualisation du superset
function updateSupersetPreview() {
    const checkboxes = document.querySelectorAll('.modal.active .checkbox.checked');
    const selectedExercises = [];
    
    checkboxes.forEach((cb, idx) => {
        const onclickAttr = cb.getAttribute('onclick');
        if (onclickAttr) {
            const match = onclickAttr.match(/toggleSupersetSelection\(this, (\d+)\)/);
            if (match && match[1]) {
                const exerciseIndex = parseInt(match[1]);
                selectedExercises.push({
                    index: exerciseIndex,
                    name: activeWorkout.exercises[exerciseIndex].name,
                    element: cb
                });
            }
        }
    });
    
    const previewElement = document.getElementById('superset-preview');
    const supersetName = document.getElementById('superset-name-input')?.value || 'Superset';
    
    if (selectedExercises.length === 0) {
        previewElement.innerHTML = 'Sélectionnez des exercices pour voir la prévisualisation...';
        return;
    }
    
    // Trier par position actuelle
    selectedExercises.sort((a, b) => a.index - b.index);
    
    let previewHTML = `<strong>${supersetName}</strong> sera placé après :<br>`;
    
    // Trouver quelle position aura le superset (position du premier exercice sélectionné)
    const firstExerciseIndex = Math.min(...selectedExercises.map(e => e.index));
    const exercisesBefore = activeWorkout.exercises.slice(0, firstExerciseIndex);
    
    if (exercisesBefore.length > 0) {
        const lastBefore = exercisesBefore[exercisesBefore.length - 1];
        previewHTML += `→ <strong>${lastBefore.name}</strong><br>`;
    } else {
        previewHTML += `→ <strong>Début de la séance</strong><br>`;
    }
    
    previewHTML += `<br><strong>Ordre dans le superset :</strong><br>`;
    
    selectedExercises.forEach((ex, idx) => {
        previewHTML += `${idx + 1}. ${ex.name}<br>`;
    });
    
    // Montrer ce qui suivra
    const exercisesAfter = activeWorkout.exercises.slice(firstExerciseIndex + selectedExercises.length);
    if (exercisesAfter.length > 0) {
        const firstAfter = exercisesAfter[0];
        previewHTML += `<br><strong>Suivi par :</strong> ${firstAfter.name}`;
    }
    
    previewElement.innerHTML = previewHTML;
}

// Fonction pour mettre à jour la prévisualisation quand on clique sur une case
function toggleSupersetSelection(checkbox, exerciseIndex) {
    checkbox.classList.toggle('checked');
    // Mettre à jour la prévisualisation
    setTimeout(updateSupersetPreview, 10);
}

// Fonction pour générer une couleur pour le superset
function getSupersetColor(index) {
    const colors = ['#8B5CF6', '#EC4899', '#06B6D4', '#10B981', '#F59E0B'];
    return colors[index % colors.length];
}

// Fonction pour mettre en évidence les exercices d'un superset et les regrouper visuellement
function highlightSupersetExercises(supersetId) {
    // Trouver tous les exercices du superset
    const supersetExercises = activeWorkout.exercises.filter(ex => ex.supersetId === supersetId);
    const firstExerciseIndex = activeWorkout.exercises.findIndex(ex => ex.supersetId === supersetId);
    
    // Appliquer un style spécial pour regrouper visuellement
    supersetExercises.forEach((ex, idx) => {
        const exerciseIndex = activeWorkout.exercises.findIndex(e => e === ex);
        const exerciseElement = document.querySelector(`#workout-exercises-container .workout-exercise:nth-child(${exerciseIndex + 1})`);
        
        if (exerciseElement) {
            // Style de bordure pour montrer le regroupement
            exerciseElement.style.borderLeft = `4px solid ${ex.supersetColor || '#8B5CF6'}`;
            exerciseElement.style.marginTop = idx === 0 ? '10px' : '0';
            exerciseElement.style.marginBottom = idx === supersetExercises.length - 1 ? '20px' : '5px';
            exerciseElement.style.borderRadius = idx === 0 ? 'var(--radius) var(--radius) 0 0' : 
                                              idx === supersetExercises.length - 1 ? '0 0 var(--radius) var(--radius)' : '0';
            
            // Ajouter un badge superset avec le numéro d'ordre
            const titleElement = exerciseElement.querySelector('.exercise-title');
            if (titleElement) {
                // Supprimer les anciens badges
                const oldBadge = titleElement.querySelector('.superset-badge');
                if (oldBadge) oldBadge.remove();
                
                // Ajouter le nouveau badge avec numéro
                titleElement.innerHTML += ` <span class="superset-badge" style="background: ${ex.supersetColor || '#8B5CF6'}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: bold;">
                    Superset ${ex.supersetOrder}/${supersetExercises.length}
                </span>`;
            }
            
            // Ajouter une indication visuelle de regroupement
            if (idx === 0) {
                exerciseElement.style.boxShadow = 'var(--shadow-lg)';
            }
        }
    });
    
    // Ajouter un conteneur visuel autour du superset si possible
    setTimeout(() => {
        const supersetContainer = document.createElement('div');
        supersetContainer.className = 'superset-group';
        supersetContainer.style.border = `2px solid ${supersetExercises[0]?.supersetColor || '#8B5CF6'}`;
        supersetContainer.style.borderRadius = 'var(--radius)';
        supersetContainer.style.margin = '10px 0 20px 0';
        supersetContainer.style.padding = '5px';
        supersetContainer.style.background = 'rgba(139, 92, 246, 0.05)';
        
        // Déplacer les exercices dans le conteneur (approche simplifiée)
        supersetExercises.forEach((ex, idx) => {
            const exerciseIndex = activeWorkout.exercises.findIndex(e => e === ex);
            const exerciseElement = document.querySelector(`#workout-exercises-container .workout-exercise:nth-child(${exerciseIndex + 1})`);
            if (exerciseElement && idx === 0) {
                // Insérer le conteneur avant le premier exercice
                exerciseElement.parentNode.insertBefore(supersetContainer, exerciseElement);
                // Déplacer les exercices dans le conteneur
                supersetExercises.forEach((ex2, idx2) => {
                    const exElement = document.querySelector(`#workout-exercises-container .workout-exercise:nth-child(${exerciseIndex + 1 + idx2})`);
                    if (exElement) {
                        supersetContainer.appendChild(exElement.cloneNode(true));
                        exElement.remove();
                    }
                });
            }
        });
    }, 100);
}

// Fonction pour gérer la progression dans un superset
function handleSupersetProgression(exerciseIndex, setIndex, actionType) {
    const exercise = activeWorkout.exercises[exerciseIndex];
    if (!exercise || !exercise.supersetId) return;
    
    // Trouver tous les exercices du même superset
    const supersetExercises = activeWorkout.exercises.filter(ex => ex.supersetId === exercise.supersetId);
    const currentOrder = exercise.supersetOrder;
    
    // Si ce n'est pas le dernier exercice du superset
    if (currentOrder < supersetExercises.length) {
        // Aller au prochain exercice du superset
        
        const nextExercise = supersetExercises.find(ex => ex.supersetOrder === currentOrder + 1);
        if (nextExercise) {
            const nextExerciseIndex = activeWorkout.exercises.findIndex(ex => ex === nextExercise);
            
            // Trouver la série correspondante dans le prochain exercice
            const nextSetIndex = setIndex; // Même numéro de série
            
            // Mettre en évidence et défiler vers la série suivante
            setTimeout(() => {
                highlightAndScrollToSet(nextExerciseIndex, nextSetIndex);
                showNotification(`✓ Passé à l'exercice ${currentOrder + 1}/${supersetExercises.length}`);
            }, 300);
        }
    } else {
        // C'est le dernier exercice du superset
        
        if (actionType === 'complete') {
            // Bouton "Terminer (avec timer)" sur le DERNIER exercice
            // Le timer a déjà été démarré dans completeSet()
            // Après le repos, revenir au premier exercice, série suivante
            
            showNotification('Tour de superset terminé ! Timer démarré', 'success');
            
            // Mettre à jour les informations du superset pour le timer
            updateSupersetTimerInfo(exerciseIndex, setIndex);
            
            // Attendre la fin du timer pour passer à la série suivante
            // Utiliser currentTimerSeconds qui peut avoir été modifié par l'utilisateur
            const timerDuration = currentSupersetRoundInfo ? currentSupersetRoundInfo.timerDuration : (exercise.customRest || userProfile.defaultRest);
            setTimeout(() => {
                goToNextRoundFirstExercise(setIndex, supersetExercises);
            }, (timerDuration * 1000) + 500);
            
        } else if (actionType === 'check') {
            // Case à cocher sur le dernier exercice: revenir au premier SANS timer
            setTimeout(() => {
                goToNextRoundFirstExercise(setIndex, supersetExercises);
                showNotification('Tour complet! Retour au premier exercice (sans timer)');
            }, 300);
        }
    }
}

// Fonction pour aller à la série suivante du premier exercice
function goToNextRoundFirstExercise(currentSetIndex, supersetExercises) {
    const firstExercise = supersetExercises.find(ex => ex.supersetOrder === 1);
    if (!firstExercise) return;
    
    const firstExerciseIndex = activeWorkout.exercises.findIndex(ex => ex === firstExercise);
    const nextSetIndex = currentSetIndex + 1;
    
    // Vérifier si la série suivante existe
    if (nextSetIndex < firstExercise.sets.length) {
        highlightAndScrollToSet(firstExerciseIndex, nextSetIndex);
    } else {
        showNotification('✅ Superset terminé ! Toutes les séries sont complétées', 'success');
    }
}

// Fonction pour mettre en évidence et défiler vers une série
function highlightAndScrollToSet(exerciseIndex, setIndex) {
    const setElement = document.getElementById(`set-${exerciseIndex}-${setIndex}`);
    if (!setElement) return;
    
    // Mettre en évidence
    setElement.style.transform = 'scale(1.03)';
    setElement.style.boxShadow = '0 0 0 4px #8B5CF6, 0 8px 20px rgba(139, 92, 246, 0.4)';
    setElement.style.transition = 'all 0.4s ease';
    setElement.style.zIndex = '10';
    setElement.style.position = 'relative';
    
    // Ajouter une classe temporaire
    setElement.classList.add('superset-highlight');
    
    // Faire défiler l'exercice parent en vue
    const exerciseElement = setElement.closest('.workout-exercise');
    if (exerciseElement) {
        exerciseElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    
    // Retirer l'effet après 3 secondes
    setTimeout(() => {
        setElement.style.transform = '';
        setElement.style.boxShadow = '';
        setElement.style.zIndex = '';
        setElement.classList.remove('superset-highlight');
    }, 3000);
    
    // Mettre le focus sur l'input des répétitions
    setTimeout(() => {
        const repsInput = setElement.querySelector('input[type="text"]');
        if (repsInput && !repsInput.disabled) {
            repsInput.focus();
            repsInput.select();
        }
    }, 600);
}

// Fonction pour mettre en évidence la série suivante dans un superset
function highlightNextSetInSuperset(exerciseIndex, setIndex) {
    const setElement = document.getElementById(`set-${exerciseIndex}-${setIndex}`);
    if (setElement) {
        // Ajouter un effet visuel
        setElement.style.transform = 'scale(1.02)';
        setElement.style.boxShadow = '0 0 0 3px #8B5CF6';
        setElement.style.transition = 'all 0.3s ease';
        
        // Retirer l'effet après 3 secondes
        setTimeout(() => {
            setElement.style.transform = '';
            setElement.style.boxShadow = '';
        }, 3000);
    }
}

function removeSuperset(exerciseIndex) {
    const supersetId = activeWorkout.exercises[exerciseIndex].supersetId;
    if (!supersetId) {
        showNotification('Cet exercice ne fait pas partie d\'un superset', 'error');
        return;
    }
    
    if (confirm('Quitter ce superset ? Les exercices resteront groupés mais sans lien de superset.')) {
        // Retirer le superset de tous les exercices concernés
        activeWorkout.exercises.forEach(ex => {
            if (ex.supersetId === supersetId) {
                delete ex.supersetId;
                delete ex.supersetOrder;
                delete ex.supersetName;
                delete ex.supersetColor;
            }
        });
        
        // RÉPARATION: Mettre à jour aussi la structure supersets si elle existe
        if (activeWorkout.supersets && activeWorkout.supersets[supersetId]) {
            delete activeWorkout.supersets[supersetId];
        }
        
        updateWorkoutDisplay();
        showNotification(`Superset supprimé`);
    }
}

function addExerciseToWorkout() {
    showExerciseSelectionForCreate();
    document.getElementById('select-exercise-modal').dataset.context = 'active-workout';
    
    // Charger tous les exercices
    setTimeout(() => {
        const container = document.getElementById('exercise-selection-list');
        if (!container) return;
        
        container.innerHTML = '';
        
        let filteredExercises = getAllExercises();
        
        filteredExercises.forEach(exercise => {
            const muscle = muscleGroups.find(m => m.id === exercise.muscleGroup);
            const exerciseItem = document.createElement('div');
            exerciseItem.className = 'food-search-simple-item';
            exerciseItem.onclick = () => {
                if (activeWorkout) {
                    activeWorkout.exercises.push({
                        ...exercise,
                        sets: Array(userProfile.defaultSets).fill().map((_, i) => ({
                            number: i + 1,
                            reps: userProfile.defaultReps,
                            weight: userProfile.defaultWeight,
                            completed: false
                        }))
                    });
                    updateWorkoutDisplay();
                    hideModal('select-exercise-modal');
                    showNotification('Exercice ajouté à la séance !');
                }
            };
            
            exerciseItem.innerHTML = `
                <div class="food-search-simple-name">${exercise.name}</div>
                <div class="food-search-simple-details">
                    ${muscle ? muscle.name : exercise.muscleGroup} • ${exercise.difficulty}
                    ${exercise.custom ? ' (Personnalisé)' : ''}
                </div>
            `;
            
            container.appendChild(exerciseItem);
        });
    }, 100);
}

function addToWorkout(exerciseId) {
    const exercise = getAllExercises().find(ex => ex.id === exerciseId);
    if (!exercise) return;
    
    if (!activeWorkout) {
        // Créer une nouvelle séance avec cet exercice
        activeWorkout = {
            name: 'Séance rapide',
            exercises: [],
            startTime: new Date(),
            completedSets: 0,
            totalWeight: 0
        };
        
        activeWorkoutStartTime = new Date();
        activeWorkoutTimer = setInterval(updateWorkoutTimer, 1000);
        showScreen('active-workout-screen');
    }
    
    // Ajouter l'exercice à la séance active
    activeWorkout.exercises.push({
        ...exercise,
        sets: Array(userProfile.defaultSets).fill().map((_, i) => ({
            number: i + 1,
            reps: userProfile.defaultReps,
            weight: userProfile.defaultWeight,
            completed: false
        }))
    });
    
    updateWorkoutDisplay();
    showNotification('Exercice ajouté à la séance !');
}

function showSaveDataModal() {
    // 🔴 CORRECTION: Ajouter un indicateur visuel
    const modal = document.getElementById('save-data-modal');
    const messageEl = modal.querySelector('.save-data-message');
    if (messageEl) {
        messageEl.innerHTML = `
            <div style="text-align: center; padding: 10px;">
                <i class="fas fa-history" style="font-size: 24px; color: var(--primary); margin-bottom: 10px;"></i>
                <p>Votre séance sera sauvegardée et vous serez redirigé vers l'historique.</p>
            </div>
        `;
    }
    
    showModal('save-data-modal');
}

function saveWorkoutData(saveToHistory = true) {
    if (!activeWorkout) return;
    
    const endTime = new Date();
    const duration = Math.floor((endTime - activeWorkoutStartTime) / 1000);
    
    if (saveToHistory) {
        // SAUVEGARDE DES SUPERSETS POUR CETTE SÉANCE UNIQUEMENT
        const supersetInfo = {};
        
        // Collecter les supersets avec leur ORDRE ORIGINAL dans la séance
        activeWorkout.exercises.forEach((exercise, index) => {
            if (exercise.supersetId) {
                if (!supersetInfo[exercise.supersetId]) {
                    supersetInfo[exercise.supersetId] = {
                        id: exercise.supersetId,
                        name: exercise.supersetName || `Superset`,
                        color: exercise.supersetColor || '#8B5CF6',
                        exercises: [],
                        originalOrder: []
                    };
                }
                
                supersetInfo[exercise.supersetId].exercises.push({
                    originalIndex: index,
                    exerciseIndex: index,
                    name: exercise.name,
                    order: exercise.supersetOrder || 1,
                    notes: exercise.notes || ''
                });
                
                supersetInfo[exercise.supersetId].originalOrder.push(index);
            }
        });
        
        // Trier les supersets par leur premier exercice pour maintenir l'ordre
        const sortedSupersetInfo = Object.values(supersetInfo).sort((a, b) => {
            const firstA = Math.min(...a.originalOrder);
            const firstB = Math.min(...b.originalOrder);
            return firstA - firstB;
        });
        
        // Sauvegarder dans l'historique
        const historyEntry = {
            id: Date.now().toString(),
            name: activeWorkout.name,
            date: new Date().toISOString(),
            duration: duration,
            exercises: activeWorkout.exercises.map(exercise => ({
                name: exercise.name,
                muscleGroup: exercise.muscleGroup,
                sets: exercise.sets.filter(set => set.completed).map(set => ({
                    reps: set.reps,
                    weight: set.weight
                })),
                supersetId: exercise.supersetId,
                supersetName: exercise.supersetName,
                supersetColor: exercise.supersetColor,
                supersetOrder: exercise.supersetOrder,
                customRest: exercise.customRest || userProfile.defaultRest,
                notes: exercise.notes || '',
                compactModeOverride: exercise.compactModeOverride
            })),
            stats: {
                totalSets: activeWorkout.completedSets,
                totalWeight: activeWorkout.totalWeight,
                totalExercises: activeWorkout.exercises.length
            },
            supersets: sortedSupersetInfo
        };
        
        workoutHistory.unshift(historyEntry);
        saveToLocalStorage();
        showNotification('Séance sauvegardée dans l\'historique !');
    }
    
    // Fermer le modal
    hideModal('save-data-modal');
    
    // 🔴 CORRECTION: Rediriger vers l'historique AVANT de réinitialiser
    showScreen('history-screen');
    
    // Réinitialiser la séance active
    completeWorkout();
    
    // 🔴 CORRECTION: Forcer le chargement de l'historique
    setTimeout(() => {
        loadWorkoutHistory();
        // Activer l'onglet "Séances" dans l'historique
        showHistoryTab('workouts');
    }, 100);
}

function completeWorkoutWithoutSaving() {
    if (confirm('Êtes-vous sûr de vouloir abandonner cette séance sans la sauvegarder ?')) {
        completeWorkout();
        hideModal('save-data-modal');
        
        // 🔴 CORRECTION: Rediriger vers l'accueil (pas l'historique)
        showScreen('home-screen');
        showNotification('Séance abandonnée');
    }
}

function completeWorkout() {
    if (activeWorkoutTimer) {
        clearInterval(activeWorkoutTimer);
        activeWorkoutTimer = null;
    }
    
    activeWorkout = null;
    activeWorkoutStartTime = null;
    
    // 🔴 CORRECTION: NE PAS changer d'écran ici
    // La redirection est gérée par saveWorkoutData()
    // showScreen('home-screen'); ← À SUPPRIMER
}

function forceExitWorkout() {
    completeWorkout();
    hideModal('exit-confirm-modal');
}

// ==================== GESTION DU TIMER ====================
function startRestTimer() {
    // currentTimerSeconds est déjà défini par l'appelant (completeSet)
    updateTimerDisplay();
    document.getElementById('timer-container').classList.add('active');
    startTimer();
}

function toggleTimer() {
    if (isTimerRunning) {
        pauseTimer();
    } else {
        startTimer();
    }
}

function startTimer() {
    if (isTimerRunning) return;
    
    isTimerRunning = true;
    document.getElementById('timer-toggle-btn').textContent = 'Pause';
    
    // Bip de démarrage
    playSound('beep');
    vibrate([50]);
    
    const startTime = Date.now();
    const totalSeconds = currentTimerSeconds;
    
    // Si c'est un timer de superset, mettre à jour la durée dans les informations
    if (currentSupersetExerciseIndex !== null && currentSupersetSetIndex !== null && currentSupersetRoundInfo) {
        currentSupersetRoundInfo.timerDuration = totalSeconds;
    }
    
    timerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const remaining = totalSeconds - elapsed;
        
        // Bip d'avertissement à 10 secondes avant la fin
        if (remaining === 10) {
            playSound('beep');
            vibrate([100]);
        }
        
        // Bip d'avertissement à 5 secondes avant la fin
        if (remaining === 5) {
            playSound('beep');
            vibrate([100]);
        }
        
        // Bip d'avertissement à 3 secondes avant la fin
        if (remaining === 3) {
            playSound('beep');
            vibrate([100]);
        }
        
        // Bip d'avertissement à 2 secondes avant la fin
        if (remaining === 2) {
            playSound('beep');
            vibrate([100]);
        }
        
        // Bip d'avertissement à 1 seconde avant la fin
        if (remaining === 1) {
            playSound('beep');
            vibrate([100]);
        }
        
        if (remaining <= 0) {
            clearInterval(timerInterval);
            if (timerProgressInterval) {
                clearInterval(timerProgressInterval);
                timerProgressInterval = null;
            }
            currentTimerSeconds = 0;
            updateTimerDisplay();
            isTimerRunning = false;
            document.getElementById('timer-toggle-btn').textContent = 'Démarrer';
            
            // ALERTE SONORE ET VIBRATION À LA FIN DU TIMER
            playTimerEndAlert();
            
            // Gérer la fin du timer pour les supersets
            if (currentSupersetExerciseIndex !== null && currentSupersetSetIndex !== null && currentSupersetRoundInfo) {
                setTimeout(() => {
                    document.getElementById('timer-container').classList.remove('active');
                    // Exécuter la progression après la fin du timer
                    executeSupersetAfterTimer();
                }, 1000);
            } else {
                // Timer normal
                setTimeout(() => {
                    document.getElementById('timer-container').classList.remove('active');
                }, 2000);
            }
            
            // Message de notification
            showNotification('⏱️ Temps écoulé ! Bip et vibration activés.');
            
            updateTimerProgress(100);
        } else {
            currentTimerSeconds = remaining;
            updateTimerDisplay();
            
            // Mettre à jour la barre de progression
            const progress = ((totalSeconds - remaining) / totalSeconds) * 100;
            updateTimerProgress(progress);
        }
    }, 100);
    
    // Démarrer la barre de progression
    startProgressBar(totalSeconds);
}

// Fonction pour exécuter la progression superset après la fin du timer
// Fonction pour exécuter la progression superset après la fin du timer
function executeSupersetAfterTimer() {
    if (currentSupersetExerciseIndex === null || currentSupersetSetIndex === null || !currentSupersetRoundInfo) {
        return;
    }
    
    const { supersetExercises, currentSetIndex } = currentSupersetRoundInfo;
    
    // Aller à la série suivante du premier exercice
    goToNextRoundFirstExercise(currentSetIndex, supersetExercises);
    
    // Réinitialiser les variables
    currentSupersetExerciseIndex = null;
    currentSupersetSetIndex = null;
    currentSupersetRoundInfo = null;
}

// Fonction pour gérer la fermeture manuelle du timer pendant un superset
function handleManualTimerCloseDuringSuperset() {
    if (currentSupersetExerciseIndex === null || currentSupersetSetIndex === null || !currentSupersetRoundInfo) {
        return;
    }
    
    // Si le timer était en cours, considérer que l'utilisateur veut passer au tour suivant
    if (isTimerRunning) {
        executeSupersetAfterTimer();
        showNotification('Timer fermé - Passage au prochain tour du superset');
    }
}

// Fonction pour mettre à jour les informations du superset quand le timer est modifié
function updateSupersetTimerInfo(exerciseIndex, setIndex) {
    const exercise = activeWorkout.exercises[exerciseIndex];
    if (!exercise || !exercise.supersetId) return;
    
    const supersetExercises = activeWorkout.exercises.filter(ex => ex.supersetId === exercise.supersetId);
    
    // Sauvegarder les informations du superset pour le timer
    currentSupersetExerciseIndex = exerciseIndex;
    currentSupersetSetIndex = setIndex;
    currentSupersetRoundInfo = {
        supersetExercises: supersetExercises,
        currentSetIndex: setIndex,
        timerDuration: currentTimerSeconds
    };
}

function pauseTimer() {
    if (!isTimerRunning) return;
    
    clearInterval(timerInterval);
    if (timerProgressInterval) {
        clearInterval(timerProgressInterval);
        timerProgressInterval = null;
    }
    
    isTimerRunning = false;
    document.getElementById('timer-toggle-btn').textContent = 'Démarrer';
}

// Fonction pour vérifier si on doit exécuter la progression du superset
function checkSupersetProgressionOnTimerClose() {
    if (currentSupersetExerciseIndex !== null && currentSupersetSetIndex !== null && currentSupersetRoundInfo) {
        // Demander confirmation à l'utilisateur
        if (confirm('Fermer le timer maintenant déclenchera la progression au tour suivant du superset. Continuer ?')) {
            executeSupersetAfterTimer();
            return true;
        } else {
            // Annuler, réinitialiser simplement les variables
            currentSupersetExerciseIndex = null;
            currentSupersetSetIndex = null;
            currentSupersetRoundInfo = null;
            return false;
        }
    }
    return true;
}

function adjustTimer(seconds) {
    currentTimerSeconds = Math.max(5, currentTimerSeconds + seconds);
    updateTimerDisplay();
    
    // Si c'est un timer de superset, mettre à jour les informations sauvegardées
    if (currentSupersetExerciseIndex !== null && currentSupersetSetIndex !== null && currentSupersetRoundInfo) {
        // Sauvegarder les informations du superset pour la nouvelle durée
        currentSupersetRoundInfo.timerDuration = currentTimerSeconds;
    }
    
    // Réinitialiser la barre de progression
    if (isTimerRunning) {
        pauseTimer();
        startTimer();
    }
}

function updateTimerDisplay() {
    const minutes = Math.floor(currentTimerSeconds / 60);
    const seconds = currentTimerSeconds % 60;
    document.getElementById('timer-display').textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

function updateTimerProgress(percentage) {
    document.getElementById('timer-progress-bar').style.width = `${percentage}%`;
}

function startProgressBar(totalSeconds) {
    if (timerProgressInterval) {
        clearInterval(timerProgressInterval);
    }
    
    let progress = 0;
    const increment = 100 / totalSeconds;
    
    timerProgressInterval = setInterval(() => {
        if (!isTimerRunning) {
            clearInterval(timerProgressInterval);
            return;
        }
        
        progress += increment;
        if (progress > 100) progress = 100;
        
        updateTimerProgress(progress);
    }, 1000);
}

function hideTimer() {
    const wasTimerRunning = isTimerRunning;
    const wasSupersetTimer = (currentSupersetExerciseIndex !== null);
    
    document.getElementById('timer-container').classList.remove('active');
    pauseTimer();
    
    // Si c'était un timer de superset et qu'il était en cours
    if (wasSupersetTimer && wasTimerRunning) {
        // L'utilisateur a fermé le timer manuellement, exécuter la progression du superset
        setTimeout(() => {
            executeSupersetAfterTimer();
            showNotification('Timer fermé manuellement - Passage au tour suivant du superset');
        }, 300);
    }
    // Si c'était un timer de superset mais qu'il n'était pas en cours
    else if (wasSupersetTimer) {
        // Réinitialiser simplement les variables sans exécuter la progression
        currentSupersetExerciseIndex = null;
        currentSupersetSetIndex = null;
        currentSupersetRoundInfo = null;
    }
}

// Nouvelle fonction pour fermer le timer avec vérification des supersets
function closeTimerWithSupersetCheck() {
    const wasSupersetTimer = (currentSupersetExerciseIndex !== null);
    const wasTimerRunning = isTimerRunning;
    
    // Fermer le timer normalement
    hideTimer();
    
    // Si c'était un timer de superset en cours, demander confirmation
    if (wasSupersetTimer && wasTimerRunning) {
        // Afficher une notification d'information
        showNotification('Superset: progression au tour suivant déclenchée');
    }
}

// ==================== GESTION DE LA NUTRITION ====================
function updateDailyNutritionDisplay() {
    // 1. FORCER le recalcul avant affichage
    calculateDailyNutritionFromMeals();
    
    // 2. Récupérer les besoins nutritionnels CALCULÉS
    const calorieNeeds = userProfile.calorieNeeds || 2500;
    const proteinNeeds = userProfile.proteinNeeds || 150;
    const carbsNeeds = userProfile.carbsNeeds || 300;
    const fatNeeds = userProfile.fatNeeds || 70;
    
    // 3. Récupérer les consommations du jour
    const calories = dailyNutrition.calories || 0;
    const protein = dailyNutrition.protein || 0;
    const carbs = dailyNutrition.carbs || 0;
    const fat = dailyNutrition.fat || 0;
    
    // 4. Calculer les pourcentages d'atteinte
    const caloriesPercent = Math.min(100, Math.round((calories / calorieNeeds) * 100));
    const proteinPercent = Math.min(100, Math.round((protein / proteinNeeds) * 100));
    const carbsPercent = Math.min(100, Math.round((carbs / carbsNeeds) * 100));
    const fatPercent = Math.min(100, Math.round((fat / fatNeeds) * 100));
    
    // 5. Mettre à jour les valeurs avec formatage
    document.getElementById('daily-calories').textContent = `${calories.toLocaleString()}/${calorieNeeds.toLocaleString()} kcal`;
    document.getElementById('daily-protein').textContent = `${protein}g`;
    document.getElementById('daily-carbs').textContent = `${carbs}g`;
    document.getElementById('daily-fat').textContent = `${fat}g`;
    
    // 6. Mettre à jour les cibles
    document.getElementById('protein-target').textContent = `/${proteinNeeds}g`;
    document.getElementById('carbs-target').textContent = `/${carbsNeeds}g`;
    document.getElementById('fat-target').textContent = `/${fatNeeds}g`;
    
    // 7. Mettre à jour les barres de progression
document.getElementById('calories-progress').style.width = `${caloriesPercent}%`;
document.getElementById('protein-progress').style.width = `${proteinPercent}%`;
document.getElementById('carbs-progress').style.width = `${carbsPercent}%`;
document.getElementById('fat-progress').style.width = `${fatPercent}%`;

// 8. Mettre à jour les pourcentages d'affichage
document.getElementById('protein-percentage').textContent = `${proteinPercent}%`;
document.getElementById('carbs-percentage').textContent = `${carbsPercent}%`;
document.getElementById('fat-percentage').textContent = `${fatPercent}%`;
    
    // 9. Calculer les restants avec formatage intelligent
    const caloriesRemaining = calorieNeeds - calories;
    const proteinRemaining = proteinNeeds - protein;
    const carbsRemaining = carbsNeeds - carbs;
    const fatRemaining = fatNeeds - fat;
    
    // 10. Mettre à jour les affichages des restants
    const caloriesBalance = document.getElementById('calories-balance');
    if (caloriesBalance) {
        caloriesBalance.textContent = `${caloriesRemaining >= 0 ? '+' : ''}${caloriesRemaining.toLocaleString()} kcal ${caloriesRemaining >= 0 ? 'restantes' : 'en excès'}`;
        caloriesBalance.className = `calories-balance ${caloriesRemaining >= 0 ? 'positive' : 'negative'}`;
    }
    
    const proteinRemainingEl = document.getElementById('protein-remaining');
    if (proteinRemainingEl) {
        proteinRemainingEl.textContent = `${proteinRemaining >= 0 ? '+' : ''}${proteinRemaining}g ${proteinRemaining >= 0 ? 'restants' : 'en excès'}`;
        proteinRemainingEl.className = `macro-remaining ${proteinRemaining >= 0 ? 'positive' : 'negative'}`;
    }
    
    const carbsRemainingEl = document.getElementById('carbs-remaining');
    if (carbsRemainingEl) {
        carbsRemainingEl.textContent = `${carbsRemaining >= 0 ? '+' : ''}${carbsRemaining}g ${carbsRemaining >= 0 ? 'restants' : 'en excès'}`;
        carbsRemainingEl.className = `macro-remaining ${carbsRemaining >= 0 ? 'positive' : 'negative'}`;
    }
    
    const fatRemainingEl = document.getElementById('fat-remaining');
    if (fatRemainingEl) {
        fatRemainingEl.textContent = `${fatRemaining >= 0 ? '+' : ''}${fatRemaining}g ${fatRemaining >= 0 ? 'restants' : 'en excès'}`;
        fatRemainingEl.className = `macro-remaining ${fatRemaining >= 0 ? 'positive' : 'negative'}`;
    }
    
    // 11. Log de débogage
    console.log('🍽️ MISE À JOUR NUTRITION:', {
        besoins: `${calorieNeeds} kcal | P:${proteinNeeds}g | C:${carbsNeeds}g | L:${fatNeeds}g`,
        consommes: `${calories} kcal | P:${protein}g | C:${carbs}g | L:${fat}g`,
        pourcentages: `${caloriesPercent}% | P:${proteinPercent}% | C:${carbsPercent}% | L:${fatPercent}%`
    });
    
    // 12. Mettre à jour la liste des repas
    updateMealsList();
}

function loadDailyMeals() {
    // C'est un alias pour updateDailyNutritionDisplay()
    updateDailyNutritionDisplay();
    
    // Ajouter un effet visuel de rafraîchissement
    const mealsList = document.getElementById('meals-list');
    if (mealsList) {
        mealsList.style.opacity = '0.7';
        setTimeout(() => {
            mealsList.style.opacity = '1';
        }, 300);
    }
}

function updateMealsList() {
    const container = document.getElementById('meals-list');
    if (!container) return;
    
    container.innerHTML = '';
    
    const today = new Date().toISOString().split('T')[0];
    
    const todaysMeals = dailyNutrition.meals.filter(meal => {
        const mealDate = new Date(meal.date).toISOString().split('T')[0];
        return mealDate === today;
    });
    
    if (todaysMeals.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">🍽️</div>
                <p>Aucun repas aujourd'hui</p>
                <p style="font-size: var(--font-size-sm); margin-top: 6px;">Ajoutez votre premier repas !</p>
                <button class="btn-add-meal mt-4" onclick="showAddMealModal(false)">
                    <i class="fas fa-plus"></i> Ajouter un repas
                </button>
            </div>
        `;
        return;
    }
    
    todaysMeals.forEach((meal, index) => {
        const originalIndex = dailyNutrition.meals.findIndex(m => m.id === meal.id);
        
        const mealBox = document.createElement('div');
        mealBox.className = 'meal-item-improved';
        mealBox.dataset.mealId = String(meal.id); // ✅ FORCER STRING
        
        let mealCalories = 0, mealProtein = 0, mealCarbs = 0, mealFat = 0;
        
        meal.foods.forEach(foodItem => {
            const food = getAllFoods().find(f => f.id === foodItem.foodId);
            if (food) {
                const ratio = foodItem.quantity / food.quantity;
                mealCalories += food.calories * ratio;
                mealProtein += food.protein * ratio;
                mealCarbs += food.carbs * ratio;
                mealFat += food.fat * ratio;
            }
        });
        
        // ✅ CORRECTION CRITIQUE : UTILISER DES GUILLEMETS DOUBLES POUR L'ID
        const mealId = String(meal.id);
        
        mealBox.innerHTML = `
            <div class="meal-header-improved">
                <div class="meal-title-improved">${meal.name}</div>
                <div class="meal-type-badge-improved">${getMealTypeLabel(meal.type)}</div>
            </div>
            <div class="meal-calories-improved">
                ${meal.foods.length} aliment(s) • ${Math.round(mealCalories)} kcal
                <span style="font-size: var(--font-size-xs); color: var(--text-secondary); margin-left: 10px;">
                    ${new Date(meal.date).toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})}
                </span>
            </div>
            <div class="meal-macros-improved">
                <div class="meal-macro-improved protein-macro">
                    <div class="meal-macro-value-improved">${Math.round(mealProtein)}</div>
                    <div class="meal-macro-label-improved">Prot</div>
                </div>
                <div class="meal-macro-improved carbs-macro">
                    <div class="meal-macro-value-improved">${Math.round(mealCarbs)}</div>
                    <div class="meal-macro-label-improved">Gluc</div>
                </div>
                <div class="meal-macro-improved fat-macro">
                    <div class="meal-macro-value-improved">${Math.round(mealFat)}</div>
                    <div class="meal-macro-label-improved">Lip</div>
                </div>
                <div class="meal-macro-improved calories-macro">
                    <div class="meal-macro-value-improved">${Math.round(mealCalories)}</div>
                    <div class="meal-macro-label-improved">kcal</div>
                </div>
            </div>
            
            <div class="meal-actions-improved">
                <button class="action-btn" onclick='viewMealDetails("${mealId}")'>
                    <i class="fas fa-eye"></i> Détails
                </button>
                <button class="action-btn" onclick='editMeal("${mealId}")' style="background: var(--gradient-primary); color: white; border: none;">
                    <i class="fas fa-edit"></i> Modifier
                </button>
                <button class="action-btn" onclick='deleteMealById("${mealId}")' style="background: var(--gradient-danger); color: white; border: none;">
                    <i class="fas fa-trash"></i> Supprimer
                </button>
            </div>
            
            ${meal.notes ? `
                <div class="meal-notes">
                    <i class="fas fa-pencil-alt"></i> ${meal.notes}
                </div>
            ` : ''}
        `;
        
        container.appendChild(mealBox);
    });
    
    updateTodaysMealCount(todaysMeals.length);
}

// ==================== MODIFICATION D'UN REPAS PAR ID ====================
function editMeal(mealId) {
    console.log('editMeal appelé avec ID:', mealId, 'TYPE:', typeof mealId);
    
    // ✅ CONVERTIR EN STRING QUOI QU'IL ARRIVE
    mealId = String(mealId);
    console.log('editMeal après conversion:', mealId, 'TYPE:', typeof mealId);
    
    // 1. VÉRIFIER QUE mealId EST VALIDE
    if (!mealId) {
        console.error('ID de repas invalide');
        showNotification('Erreur: ID de repas invalide', 'error');
        return;
    }
    
    // 2. CHERCHER DANS dailyNutrition.meals
    let meal = dailyNutrition.meals.find(m => m.id === mealId);
    let mealIndex = dailyNutrition.meals.findIndex(m => m.id === mealId);
    
    // 3. SI PAS TROUVÉ, CHERCHER DANS nutritionHistory
    if (!meal) {
        console.log('Repas non trouvé dans daily, recherche dans history...');
        meal = nutritionHistory.find(m => m.id === mealId);
        
        // Si trouvé dans history, l'ajouter à daily pour modification
        if (meal) {
            console.log('Repas trouvé dans history, ajout à daily');
            dailyNutrition.meals.push({...meal});
            mealIndex = dailyNutrition.meals.length - 1;
            meal = dailyNutrition.meals[mealIndex];
        }
    }
    
    // 4. SI TOUJOURS PAS TROUVÉ → ERREUR
    if (!meal) {
        console.error('Repas non trouvé avec ID:', mealId);
        showNotification('Erreur: repas non trouvé', 'error');
        return;
    }
    
    console.log('Repas à éditer:', meal);
    
    // 5. GARANTIR QUE LE REPAS A UN ID
    if (!meal.id) {
        meal.id = mealId || `meal_${Date.now()}_${mealIndex}`;
        saveToLocalStorage();
    }
    
    // 6. Remplir le formulaire d'édition
    document.getElementById('edit-meal-name').value = meal.name || '';
    document.getElementById('edit-meal-type').value = meal.type || 'petit-dejeuner';
    document.getElementById('edit-meal-notes').value = meal.notes || '';
    
    // 7. Mettre à jour les boutons de type de repas
    const typeOptions = document.querySelectorAll('#edit-meal-type-options .meal-type-option');
    typeOptions.forEach(option => {
        option.classList.remove('active');
        const optionValue = option.getAttribute('data-value');
        if (optionValue === meal.type) {
            option.classList.add('active');
        }
    });
    
    // 8. Vider et remplir la liste des aliments
    const foodsList = document.getElementById('edit-meal-foods-list');
    foodsList.innerHTML = '';
    
    if (meal.foods && meal.foods.length > 0) {
        meal.foods.forEach(foodItem => {
            const food = getAllFoods().find(f => f.id === foodItem.foodId);
            if (food) {
                const foodElement = document.createElement('div');
                foodElement.className = 'meal-food-item';
                foodElement.dataset.foodId = foodItem.foodId;
                foodElement.dataset.quantity = foodItem.quantity;
                
                const ratio = foodItem.quantity / food.quantity;
                const calories = Math.round(food.calories * ratio);
                const protein = Math.round(food.protein * ratio);
                const carbs = Math.round(food.carbs * ratio);
                const fat = Math.round(food.fat * ratio);
                
                foodElement.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 700; margin-bottom: 3px;">${food.name}</div>
                            <div class="food-calories-display" style="font-size: var(--font-size-xs); color: var(--text-secondary);">
                                ${calories} kcal (P:${protein}g C:${carbs}g L:${fat}g)
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="number" class="quantity-input" value="${foodItem.quantity}" style="width: 70px;" 
                                   oninput="updateFoodQuantityAndCalories(this, '${food.id}')">
                            <button class="action-btn" onclick="removeFoodFromMeal(this)" title="Supprimer">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                foodsList.appendChild(foodElement);
            }
        });
    }
    
    // 9. Stocker l'ID du repas dans le modal
    document.getElementById('edit-meal-modal').dataset.mealId = meal.id;
    document.getElementById('edit-meal-modal').dataset.mealIndex = mealIndex;
    
    // 10. Ouvrir le modal
    showModal('edit-meal-modal');
}

// ==================== AFFICHAGE DES DÉTAILS D'UN REPAS ====================
function viewMealDetails(mealId) {
    console.log('viewMealDetails appelé avec ID:', mealId);
    
    // Chercher d'abord dans dailyNutrition.meals
    let meal = dailyNutrition.meals.find(m => m.id === mealId);
    
    // Si pas trouvé, chercher dans nutritionHistory
    if (!meal) {
        meal = nutritionHistory.find(m => m.id === mealId);
    }
    
    if (!meal) {
        console.error('Repas non trouvé avec ID:', mealId);
        showNotification('Erreur: repas non trouvé', 'error');
        return;
    }
    
    // Rediriger vers la fonction existante showMealDetail
    showMealDetail(mealId);
}


function updateTodaysMealCount(count) {
    const counterElement = document.getElementById('todays-meal-count');
    if (counterElement) {
        counterElement.textContent = `(${count} repas aujourd'hui)`;
    }
}


function editMealFromNutritionScreen(index) {
    console.log('editMealFromNutritionScreen appelé avec index:', index);
    
    // Vérifier que l'index est valide
    if (index < 0 || index >= dailyNutrition.meals.length) {
        console.error('Index invalide:', index);
        showNotification('Erreur: repas non trouvé', 'error');
        return;
    }
    
    const meal = dailyNutrition.meals[index];
    console.log('Repas à éditer:', meal);
    
    // Ouvrir directement le modal sans passer par editMeal si ça échoue
    try {
        editMeal(index);
        console.log('editMeal exécuté avec succès');
    } catch (error) {
        console.error('Erreur dans editMeal:', error);
        // Essayer d'ouvrir le modal quand même
    }
    
    // Ouvrir le modal
    const modal = document.getElementById('edit-meal-modal');
    if (modal) {
        modal.classList.add('active');
        console.log('Modal ouvert');
    } else {
        console.error('Modal edit-meal-modal non trouvé');
    }
}

function getMealTypeLabel(type) {
    switch(type) {
        case 'petit-dejeuner': return 'Petit-déjeuner';
        case 'dejeuner': return 'Déjeuner';
        case 'diner': return 'Dîner';
        case 'collation': return 'Collation';
        default: return type;
    }
}

function showAddMealModal(fromHeader = false) {
    console.log('Ouverture modal repas depuis:', currentScreen, 'header:', fromHeader);
    
    // Stocker la page courante
    let screenToRemember = currentScreen || 'nutrition-screen';
    
    // Si on vient du header et qu'on n'est pas déjà sur Nutrition
    // On force à retourner sur Nutrition après sauvegarde
    if (fromHeader && currentScreen !== 'nutrition-screen') {
        screenToRemember = 'nutrition-screen';
    }
    
    localStorage.setItem('previousScreen', screenToRemember);
    localStorage.setItem('mealModalSource', fromHeader ? 'header' : 'nutrition');
    
    showModal('add-meal-modal');
    
    // S'assurer que le bouton de sauvegarde est dans l'état initial
    setTimeout(() => {
        const saveButton = document.getElementById('save-meal-button');
        if (saveButton) {
            saveButton.disabled = false;
            const saveText = saveButton.querySelector('.save-button-text');
            const loadingText = saveButton.querySelector('.save-button-loading');
            if (saveText && loadingText) {
                saveText.style.display = 'flex';
                loadingText.style.display = 'none';
            }
        }
    }, 100);
}

function selectMealType(type) {
    document.getElementById('meal-type').value = type;
    
    // MODIFICATION: Meilleure détection
    document.querySelectorAll('.meal-type-option').forEach(option => {
        option.classList.remove('active');
        if (option.getAttribute('data-value') === type) {
            option.classList.add('active');
        }
    });
}

function selectEditMealType(type) {
    document.getElementById('edit-meal-type').value = type;
    
    document.querySelectorAll('#edit-meal-type-options .meal-type-option').forEach(option => {
        option.classList.remove('active');
        if (option.getAttribute('data-value') === type) {
            option.classList.add('active');
        }
    });
}


function showFoodSearchModalForMeal() {
    showModal('food-search-modal');
    
    setTimeout(() => {
        const searchInput = document.getElementById('food-search-input');
        const categorySelect = document.getElementById('food-search-category');
        
        if (searchInput) {
            searchInput.value = '';
        }
        
        if (categorySelect) {
            categorySelect.value = 'all';
            
            // SIMPLE : Forcer la couleur selon le mode
            if (settings.darkMode) {
                categorySelect.style.color = '#ffffff';
            } else {
                categorySelect.style.color = '#000000';
            }
            
            // Initialiser les options si nécessaire
            if (categorySelect.options.length <= 3) {
                const baseOptions = Array.from(categorySelect.options);
                categorySelect.innerHTML = '';
                
                baseOptions.forEach(option => {
                    categorySelect.appendChild(option);
                });
                
                const categories = [...new Set(getAllFoods().map(f => f.category))];
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                    categorySelect.appendChild(option);
                });
                
                categorySelect.value = 'all';
            }
            
            searchFoodsSimple('');
        }
    }, 50);
}

function searchFoodsSimple(searchTerm) {
    const container = document.getElementById('food-search-results-simple');
    const emptyState = document.getElementById('food-search-empty-simple');
    const categoryFilter = document.getElementById('food-search-category').value;
    
    if (!container) return;
    
    let filteredFoods = getAllFoods();
    
    // Filtrer par recherche textuelle
    if (searchTerm && searchTerm.trim() !== '') {
        filteredFoods = filteredFoods.filter(food => 
            food.name.toLowerCase().includes(searchTerm.toLowerCase())
        );
    }
    
    // Filtrer par catégorie
    if (categoryFilter !== 'all') {
        if (categoryFilter === 'halal') {
            filteredFoods = filteredFoods.filter(food => food.halal);
        } else if (categoryFilter === 'personnalisé') {
            filteredFoods = filteredFoods.filter(food => food.custom);
        } else {
            filteredFoods = filteredFoods.filter(food => food.category === categoryFilter);
        }
    }
    
    container.innerHTML = '';
    
    if (filteredFoods.length === 0) {
        emptyState.style.display = 'block';
        emptyState.innerHTML = `
            <div style="text-align: center; padding: 40px 20px;">
                <div style="font-size: 48px; margin-bottom: 16px;">🔍</div>
                <p style="font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">
                    Aucun aliment trouvé
                </p>
                <p style="font-size: var(--font-size-sm); color: var(--text-secondary);">
                    ${searchTerm ? 'Aucun résultat pour "' + searchTerm + '"' : 'Aucun aliment dans cette catégorie'}
                </p>
            </div>
        `;
        return;
    }
    
    emptyState.style.display = 'none';
    
    // Organiser les aliments par catégorie
    const foodsByCategory = {};
    
    filteredFoods.forEach(food => {
        if (!foodsByCategory[food.category]) {
            foodsByCategory[food.category] = [];
        }
        foodsByCategory[food.category].push(food);
    });
    
    // Si on a qu'une seule catégorie (ou "toutes les catégories"), on affiche sans en-têtes de catégorie
    const categories = Object.keys(foodsByCategory);
    const showCategoryHeaders = categories.length > 1 || categoryFilter !== 'all';
    
    // Afficher par catégorie ou directement
    Object.entries(foodsByCategory).forEach(([category, foods]) => {
        // Créer un en-tête de catégorie seulement si nécessaire
        if (showCategoryHeaders) {
            const categoryHeader = document.createElement('div');
            categoryHeader.className = 'food-category-header';
            categoryHeader.innerHTML = `
                <div style="font-weight: 700; font-size: var(--font-size-base); color: var(--text-primary); margin-bottom: 10px; padding: 10px 0; border-bottom: 2px solid var(--primary);">
                    ${category.charAt(0).toUpperCase() + category.slice(1)}
                    <span style="font-size: var(--font-size-xs); color: var(--text-secondary); margin-left: 8px;">
                        (${foods.length} ${foods.length > 1 ? 'aliments' : 'aliment'})
                    </span>
                </div>
            `;
            container.appendChild(categoryHeader);
        }
        
        // Afficher les aliments de cette catégorie
        foods.forEach(food => {
            const foodItem = document.createElement('div');
            foodItem.className = 'food-search-simple-item';
            foodItem.onclick = () => addFoodToMealFromSearch(food.id);
            
            foodItem.innerHTML = `
                <div class="food-search-simple-name">${food.name}</div>
                <div class="food-search-simple-details">
                    <span style="font-weight: 600; color: var(--primary);">
                        ${food.calories} kcal / ${food.quantity}g
                    </span>
                    ${food.halal ? '<span class="food-type-indicator food-type-halal">🕌 Halal</span>' : ''}
                    ${food.custom ? '<span class="food-type-indicator food-type-custom">🎨 Personnalisé</span>' : ''}
                    ${!food.halal && !food.custom ? '<span class="food-type-indicator food-type-default">Base</span>' : ''}
                </div>
            `;
            
            container.appendChild(foodItem);
        });
    });
}

// ==================== GESTION RECHERCHE ALIMENTS ====================
function handleFoodCategoryChange() {
    const searchInput = document.getElementById('food-search-input');
    const searchTerm = searchInput ? searchInput.value : '';
    searchFoodsSimple(searchTerm);
}

function handleFoodSearch() {
    const searchInput = document.getElementById('food-search-input');
    const searchTerm = searchInput ? searchInput.value : '';
    
    // Débouncer la recherche pour éviter trop d'appels
    clearTimeout(window.foodSearchTimeout);
    window.foodSearchTimeout = setTimeout(() => {
        searchFoodsSimple(searchTerm);
    }, 300);
}

function addFoodToMealFromSearch(foodId) {
    const food = getAllFoods().find(f => f.id === foodId);
    if (!food) return;
    
    // Déterminer dans quel modal nous sommes
    let listId = 'meal-foods-list';
    
    if (document.getElementById('edit-meal-modal').classList.contains('active')) {
        listId = 'edit-meal-foods-list';
    } else if (document.getElementById('add-meal-modal').classList.contains('active')) {
        listId = 'meal-foods-list';
    }
    
    // Créer un élément d'aliment
    const foodItem = document.createElement('div');
    foodItem.className = 'meal-food-item';
    foodItem.dataset.foodId = foodId;
    foodItem.dataset.quantity = food.quantity;
    
    foodItem.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <div style="font-weight: 700; margin-bottom: 3px;">${food.name}</div>
                <div style="font-size: var(--font-size-xs); color: var(--text-secondary);">
                    ${food.calories} kcal / ${food.quantity}g
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <input type="number" class="quantity-input" value="${food.quantity}" style="width: 70px;" oninput="updateFoodQuantity(this, '${foodId}')">
                <button class="action-btn" onclick="removeFoodFromMeal(this)" title="Supprimer">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;
    
    const list = document.getElementById(listId);
    if (list) {
        list.appendChild(foodItem);
        showNotification('Aliment ajouté au repas');
    }
    
    hideModal('food-search-modal');
}

function updateFoodQuantity(input, foodId) {
    const foodItem = input.closest('.meal-food-item');
    if (foodItem) {
        foodItem.dataset.quantity = input.value;
    }
}

// MODIFICATION: Fonction pour mettre à jour les calories quand on change la quantité
function updateFoodQuantityAndCalories(input, foodId) {
    const foodItem = input.closest('.meal-food-item');
    if (foodItem) {
        foodItem.dataset.quantity = input.value;
        
        // Calculer et afficher les nouvelles calories
        const food = getAllFoods().find(f => f.id === foodId);
        if (food) {
            const ratio = input.value / food.quantity;
            const calories = Math.round(food.calories * ratio);
            const protein = Math.round(food.protein * ratio);
            const carbs = Math.round(food.carbs * ratio);
            const fat = Math.round(food.fat * ratio);
            
            // Mettre à jour l'affichage si un élément d'affichage existe
            const display = foodItem.querySelector('.food-calories-display');
            if (display) {
                display.textContent = `${calories} kcal (P:${protein}g C:${carbs}g L:${fat}g)`;
            }
        }
    }
}


function removeFoodFromMeal(button) {
    const foodItem = button.closest('.meal-food-item');
    foodItem.remove();
}

function showAddFoodFromMeal(context) {
    showAddFoodModal();
    document.getElementById('add-food-modal').dataset.context = context;
    // MODIFICATION
    document.getElementById('add-food-modal').dataset.mealContext = context;
}

function saveMeal() {
    // Utiliser la nouvelle fonction pour plus de cohérence
    saveMealAndReturnToNutrition();
}

// ==================== SAUVEGARDE AVEC RETOUR À LA PAGE NUTRITION ====================

async function saveMealAndReturnToNutrition() {
    console.log('Début de la sauvegarde avec retour...');
    
    // 1. Récupérer les données du formulaire
    const mealData = getMealFormData();
    
    // 2. Validation basique
    if (!mealData.name || !mealData.foods || mealData.foods.length === 0) {
        showNotification('Veuillez remplir tous les champs obligatoires', 'error');
        return;
    }
    
    // 3. Afficher l'état de chargement
    const saveButton = document.getElementById('save-meal-button');
    const saveText = saveButton ? saveButton.querySelector('.save-button-text') : null;
    const loadingText = saveButton ? saveButton.querySelector('.save-button-loading') : null;
    
    if (saveText && loadingText) {
        saveText.style.display = 'none';
        loadingText.style.display = 'flex';
    }
    
    // 4. Désactiver le bouton pendant la sauvegarde
    if (saveButton) {
        saveButton.disabled = true;
    }
    
    try {
        // 5. Sauvegarder le repas
        const saved = await saveMealToStorage(mealData);
        
        if (saved) {
            // 6. Animation de fermeture du modal
            const modal = document.getElementById('add-meal-modal');
            if (modal) {
                modal.classList.add('nutrition-return-transition');
            }
            
            // 7. Attendre un peu pour l'animation
            setTimeout(() => {
                // 8. Fermer le modal
                hideModal('add-meal-modal');
                
                // 9. Réinitialiser le formulaire
                resetMealForm();
                
                // 10. DÉTERMINER OÙ RETOURNER
                let screenToReturn = 'nutrition-screen';
                const modalSource = localStorage.getItem('mealModalSource');
                const previousScreen = localStorage.getItem('previousScreen');
                
                // Logique de décision :
                if (modalSource === 'header') {
                    // Vient du header -> toujours Nutrition
                    screenToReturn = 'nutrition-screen';
                } else if (previousScreen === 'nutrition-screen') {
                    // Vient de Nutrition -> reste sur Nutrition
                    screenToReturn = 'nutrition-screen';
                } else if (previousScreen && previousScreen !== currentScreen) {
                    // Vient d'un autre écran -> y retourner
                    screenToReturn = previousScreen;
                }
                // Sinon : par défaut Nutrition
                
                // 11. Nettoyer le localStorage
                localStorage.removeItem('previousScreen');
                localStorage.removeItem('mealModalSource');
                
                // 12. Retourner à l'écran déterminé
                showScreen(screenToReturn);
                
                // 13. Animation d'entrée si on retourne sur Nutrition
                if (screenToReturn === 'nutrition-screen') {
                    const nutritionScreen = document.getElementById('nutrition-screen');
                    if (nutritionScreen) {
                        nutritionScreen.classList.add('nutrition-page-enter');
                        
                        setTimeout(() => {
                            nutritionScreen.classList.remove('nutrition-page-enter');
                        }, 800);
                    }
                }
                
                // 14. Actualiser l'affichage des repas
                updateDailyNutritionDisplay();
                
                // 15. Afficher une confirmation
                showNotification('Repas sauvegardé avec succès !', 'success');
                
            }, 500);
        }
        
    } catch (error) {
        console.error('Erreur lors de la sauvegarde du repas:', error);
        showNotification('Erreur lors de la sauvegarde', 'error');
        
    } finally {
        // 16. Réactiver le bouton
        if (saveButton) {
            saveButton.disabled = false;
            if (saveText && loadingText) {
                saveText.style.display = 'flex';
                loadingText.style.display = 'none';
            }
        }
    }
}

function getMealFormData() {
    // Récupérer les aliments du formulaire
    const foods = [];
    document.querySelectorAll('#meal-foods-list .meal-food-item').forEach(item => {
        foods.push({
            foodId: item.dataset.foodId,
            quantity: parseFloat(item.dataset.quantity) || 100
        });
    });
    
    return {
        name: document.getElementById('meal-name')?.value.trim() || '',
        type: document.getElementById('meal-type')?.value || 'petit-dejeuner',
        foods: foods,
        notes: document.getElementById('meal-notes')?.value.trim() || '',
        date: new Date().toISOString()
    };
}

async function saveMealToStorage(mealData) {
    return new Promise((resolve, reject) => {
        try {
            // ID unique pour les DEUX listes
            const mealId = Date.now().toString();
            
            const newMeal = {
                id: mealId, // MÊME ID pour les deux
                name: mealData.name,
                type: mealData.type,
                foods: mealData.foods,
                notes: mealData.notes,
                date: mealData.date
            };
            
            // Ajouter au journal du jour
            dailyNutrition.meals.push(newMeal);
            
            // Ajouter à l'historique AVEC LE MÊME ID
            nutritionHistory.push({...newMeal});
            
            // Recalculer les totaux
            calculateDailyNutritionFromMeals();
            
            // Sauvegarder
            saveToLocalStorage();
            
            // Rafraîchir l'historique si on est dessus
            if (currentScreen === 'history-screen') {
                setTimeout(refreshNutritionHistoryDisplay, 100);
            }
            
            resolve(true);
        } catch (error) {
            reject(error);
        }
    });
}

function resetMealForm() {
    document.getElementById('meal-name').value = '';
    document.getElementById('meal-type').value = 'petit-dejeuner';
    document.getElementById('meal-foods-list').innerHTML = '';
    document.getElementById('meal-notes').value = '';
    
    // Réinitialiser les boutons de type de repas
    document.querySelectorAll('.meal-type-option').forEach((option, index) => {
        option.classList.toggle('active', index === 0);
    });
}

// ANCIENNE fonction - À REMPLACER
function updateNutritionTotals() {
    calculateDailyNutritionFromMeals(); // Utiliser la nouvelle fonction
}

// OU mieux : SUPPRIMER updateNutritionTotals() et utiliser calculateDailyNutritionFromMeals() partout


function showFoodSearchModalForEdit() {
    showModal('food-search-modal');
    document.activeModal = 'edit-meal-modal';
    
    // CORRECTION : Réinitialiser le formulaire et lancer la recherche
    setTimeout(() => {
        const searchInput = document.getElementById('food-search-input');
        const categorySelect = document.getElementById('food-search-category');
        
        // Réinitialiser les champs
        if (searchInput) {
            searchInput.value = '';
            // AJOUTER CETTE LIGNE : Événement de recherche en temps réel
            searchInput.addEventListener('input', function() {
                clearTimeout(window.foodSearchTimeout);
                window.foodSearchTimeout = setTimeout(() => {
                    searchFoodsSimple(this.value);
                }, 300);
            });
        }
        
        if (categorySelect) {
            categorySelect.value = 'all';
            
            // AJOUTER CETTE LIGNE : Événement de changement de catégorie
            categorySelect.addEventListener('change', function() {
                const searchTerm = searchInput ? searchInput.value : '';
                searchFoodsSimple(searchTerm);
            });
            
            // Forcer l'affichage correct du select
            const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim();
            if (textColor) {
                categorySelect.style.color = textColor;
            }
            
            // Déclencher immédiatement la recherche avec "toutes les catégories"
            searchFoodsSimple('');
        }
    }, 50);
}

function saveEditedMeal() {
    // 1. RÉCUPÉRER L'ID (prioritaire) ou l'index (fallback)
    const mealId = document.getElementById('edit-meal-modal').dataset.mealId;
    const index = parseInt(document.getElementById('edit-meal-modal').dataset.mealIndex);
    
    let meal = null;
    let mealIndex = -1;
    
    // 2. CHERCHER PAR ID D'ABORD
    if (mealId) {
        mealIndex = dailyNutrition.meals.findIndex(m => m.id === mealId);
        if (mealIndex !== -1) {
            meal = dailyNutrition.meals[mealIndex];
        }
    }
    
    // 3. SI PAS TROUVÉ PAR ID, UTILISER L'INDEX
    if (!meal && !isNaN(index) && dailyNutrition.meals[index]) {
        meal = dailyNutrition.meals[index];
        mealIndex = index;
    }
    
    // 4. SI TOUJOURS PAS TROUVÉ → ERREUR
    if (!meal) {
        showNotification('Erreur: repas non trouvé', 'error');
        return;
    }
    
    const name = document.getElementById('edit-meal-name').value.trim();
    const type = document.getElementById('edit-meal-type').value;
    const notes = document.getElementById('edit-meal-notes').value.trim();
    
    if (!name) {
        showNotification('Veuillez saisir un nom pour le repas', 'error');
        return;
    }
    
    // Récupérer les aliments
    const foods = [];
    document.querySelectorAll('#edit-meal-foods-list .meal-food-item').forEach(item => {
        foods.push({
            foodId: item.dataset.foodId,
            quantity: parseFloat(item.dataset.quantity) || 100
        });
    });
    
    if (foods.length === 0) {
        showNotification('Veuillez ajouter au moins un aliment', 'error');
        return;
    }
    
    // CONSERVER l'ID
    const mealIdToSave = meal.id || `meal_${Date.now()}_${mealIndex}`;
    
    console.log('Sauvegarde repas modifié:', {
        index: mealIndex,
        id: mealIdToSave,
        name,
        type,
        foodsCount: foods.length
    });
    
    // Créer l'objet repas mis à jour
    const updatedMeal = {
        id: mealIdToSave,
        name: name,
        type: type,
        foods: foods,
        notes: notes,
        date: meal.date || new Date().toISOString()
    };
    
    // 1. Mettre à jour dans dailyNutrition.meals
    dailyNutrition.meals[mealIndex] = updatedMeal;
    
    // 2. Mettre à jour ou ajouter dans nutritionHistory
    const historyIndex = nutritionHistory.findIndex(m => m.id === mealIdToSave);
    if (historyIndex !== -1) {
        nutritionHistory[historyIndex] = {...updatedMeal};
    } else {
        nutritionHistory.push({...updatedMeal});
    }
    
    // 3. Recalculer les totaux nutritionnels
    calculateDailyNutritionFromMeals();
    
    // 4. Sauvegarder
    saveToLocalStorage();
    
    // 5. Mettre à jour l'affichage
    updateDailyNutritionDisplay();
    
    // 6. Rafraîchir l'historique
    if (currentScreen === 'history-screen') {
        refreshNutritionHistoryDisplay();
    }
    
    // 7. Réinitialiser et fermer
    resetEditMealForm();
    hideModal('edit-meal-modal');
    
    showNotification('Repas modifié avec succès !');
}

function editFoodQuantity(foodId, currentQuantity) {
    const food = getAllFoods().find(f => f.id === foodId);
    if (!food) return;
    
    const modalContent = document.getElementById('edit-food-quantity-content');
    modalContent.innerHTML = `
        <div class="input-group">
            <div class="input-label">Nom de l'aliment</div>
            <div style="padding: 10px; background: var(--card-bg); border-radius: var(--radius-sm); margin-bottom: 15px;">
                ${food.name}
            </div>
        </div>
        <div class="input-group">
            <div class="input-label">Quantité actuelle (g)</div>
            <input type="number" class="number-input" id="edit-quantity-value" value="${currentQuantity}" min="1" max="1000">
        </div>
        <div class="input-group">
            <div class="input-label">Calcul des valeurs</div>
            <div style="padding: 10px; background: var(--card-bg); border-radius: var(--radius-sm); margin-bottom: 15px;">
                <div>Calories: <span id="calc-calories">${Math.round(food.calories * (currentQuantity / food.quantity))}</span> kcal</div>
                <div>Protéines: <span id="calc-protein">${Math.round(food.protein * (currentQuantity / food.quantity))}</span>g</div>
                <div>Glucides: <span id="calc-carbs">${Math.round(food.carbs * (currentQuantity / food.quantity))}</span>g</div>
                <div>Lipides: <span id="calc-fat">${Math.round(food.fat * (currentQuantity / food.quantity))}</span>g</div>
            </div>
        </div>
        <button class="btn btn-success" onclick="updateFoodQuantityInEdit('${foodId}')" style="width: 100%; margin-top: 15px;">
            Mettre à jour
        </button>
    `;
    
    document.getElementById('edit-quantity-value').oninput = function() {
        const newQty = parseInt(this.value) || 0;
        const ratio = newQty / food.quantity;
        
        document.getElementById('calc-calories').textContent = Math.round(food.calories * ratio);
        document.getElementById('calc-protein').textContent = Math.round(food.protein * ratio);
        document.getElementById('calc-carbs').textContent = Math.round(food.carbs * ratio);
        document.getElementById('calc-fat').textContent = Math.round(food.fat * ratio);
    };
    
    document.getElementById('edit-food-quantity-modal').dataset.foodId = foodId;
    showModal('edit-food-quantity-modal');
}

function updateFoodQuantityInEdit(foodId) {
    const newQuantity = parseInt(document.getElementById('edit-quantity-value').value) || 100;
    const modalId = document.activeModal || 'edit-meal-modal';
    
    // Trouver l'élément d'aliment dans la liste d'édition
    const foodItem = document.querySelector(`#edit-meal-foods-list .meal-food-item[data-food-id="${foodId}"]`);
    if (foodItem) {
        foodItem.dataset.quantity = newQuantity;
        
        // Mettre à jour l'affichage des calories
        const food = getAllFoods().find(f => f.id === foodId);
        if (food) {
            const ratio = newQuantity / food.quantity;
            const calories = Math.round(food.calories * ratio);
            const protein = Math.round(food.protein * ratio);
            const carbs = Math.round(food.carbs * ratio);
            const fat = Math.round(food.fat * ratio);
            
            const display = foodItem.querySelector('.food-calories-display');
            if (display) {
                display.textContent = `${calories} kcal (P:${protein}g C:${carbs}g L:${fat}g)`;
            }
        }
        
        hideModal('edit-food-quantity-modal');
        showNotification('Quantité mise à jour');
    }
}

function resetEditMealForm() {
    document.getElementById('edit-meal-name').value = '';
    document.getElementById('edit-meal-type').value = 'petit-dejeuner';
    document.getElementById('edit-meal-foods-list').innerHTML = '';
    document.getElementById('edit-meal-notes').value = '';
    
    // Réinitialiser les boutons de type de repas
    document.querySelectorAll('#edit-meal-type-options .meal-type-option').forEach((option, index) => {
        option.classList.toggle('active', index === 0);
    });
}

function calculateDailyNutritionFromMeals() {
    // RÉINITIALISER les totaux à 0
    dailyNutrition.calories = 0;
    dailyNutrition.protein = 0;
    dailyNutrition.carbs = 0;
    dailyNutrition.fat = 0;
    
    // Obtenir la date d'aujourd'hui au format YYYY-MM-DD
    const today = new Date().toISOString().split('T')[0];
    
    // Filtrer uniquement les repas d'AUJOURD'HUI
    const todaysMeals = dailyNutrition.meals.filter(meal => {
        const mealDate = new Date(meal.date).toISOString().split('T')[0];
        return mealDate === today;
    });
    
    // Calculer les totaux UNIQUEMENT sur les repas d'aujourd'hui
    todaysMeals.forEach(meal => {
        meal.foods.forEach(foodItem => {
            const food = getAllFoods().find(f => f.id === foodItem.foodId);
            if (food) {
                const ratio = foodItem.quantity / food.quantity;
                dailyNutrition.calories += food.calories * ratio;
                dailyNutrition.protein += food.protein * ratio;
                dailyNutrition.carbs += food.carbs * ratio;
                dailyNutrition.fat += food.fat * ratio;
            }
        });
    });
    
    // Arrondir les valeurs
    dailyNutrition.calories = Math.round(dailyNutrition.calories);
    dailyNutrition.protein = Math.round(dailyNutrition.protein);
    dailyNutrition.carbs = Math.round(dailyNutrition.carbs);
    dailyNutrition.fat = Math.round(dailyNutrition.fat);
    
    console.log('Totaux recalculés pour aujourd\'hui:', {
        calories: dailyNutrition.calories,
        mealsCount: todaysMeals.length,
        totalMeals: dailyNutrition.meals.length
    });
}

function deleteMealFromAllSources(mealId) {
    if (!mealId) return false;
    
    let deletedFromDaily = false;
    let deletedFromHistory = false;
    
    // 1. Supprimer de dailyNutrition.meals
    const dailyIndex = dailyNutrition.meals.findIndex(m => m.id === mealId);
    if (dailyIndex !== -1) {
        dailyNutrition.meals.splice(dailyIndex, 1);
        deletedFromDaily = true;
    }
    
    // 2. Supprimer de nutritionHistory
    const historyIndex = nutritionHistory.findIndex(m => m.id === mealId);
    if (historyIndex !== -1) {
        nutritionHistory.splice(historyIndex, 1);
        deletedFromHistory = true;
    }
    
    // 3. Recalculer les totaux du jour
    if (deletedFromDaily) {
        calculateDailyNutritionFromMeals();
    }
    
    // 4. Sauvegarder
    saveToLocalStorage();
    
    console.log('Repas supprimé:', {
        mealId,
        fromDaily: deletedFromDaily,
        fromHistory: deletedFromHistory
    });
    
    return deletedFromDaily || deletedFromHistory;
}

// ==================== SUPPRESSION D'UN REPAS PAR ID ====================
function deleteMealById(mealId) {
    if (!mealId) {
        showNotification('Erreur: ID de repas invalide', 'error');
        return;
    }
    
    if (confirm('Êtes-vous sûr de vouloir supprimer ce repas ?')) {
        // Supprimer des DEUX sources
        const deleted = deleteMealFromAllSources(mealId);
        
        if (deleted) {
            // Mettre à jour l'affichage de la page Nutrition
            updateDailyNutritionDisplay();
            
            // Mettre à jour le compteur de repas
            updateTodaysMealCount();
            
            // RÉACTUALISER l'historique si on est sur la page Historique
            if (currentScreen === 'history-screen') {
                refreshNutritionHistoryDisplay();
            }
            
            showNotification('Repas supprimé avec succès !');
        } else {
            showNotification('Erreur lors de la suppression', 'error');
        }
    }
}

// Garder l'ancienne fonction pour compatibilité, mais rediriger
function deleteMeal(index) {
    const meal = dailyNutrition.meals[index];
    if (meal && meal.id) {
        deleteMealById(meal.id);
    } else {
        showNotification('Erreur: repas non trouvé', 'error');
    }
}

// MODIFICATION: Fonction pour voir le détail d'un repas du jour
function showMealDetailCurrent(index) {
    const meal = dailyNutrition.meals[index];
    if (!meal) return;
    
    // Vérifier que le repas a un ID
    if (!meal.id) {
        meal.id = `meal_${Date.now()}_${index}`;
        saveToLocalStorage();
    }

    // Calculer les totaux
    let mealCalories = 0;
    let mealProtein = 0;
    let mealCarbs = 0;
    let mealFat = 0;
    
    meal.foods.forEach(foodItem => {
        const food = getAllFoods().find(f => f.id === foodItem.foodId);
        if (food) {
            const ratio = foodItem.quantity / food.quantity;
            mealCalories += food.calories * ratio;
            mealProtein += food.protein * ratio;
            mealCarbs += food.carbs * ratio;
            mealFat += food.fat * ratio;
        }
    });
    
    let detailHTML = `
        <div class="history-detail-content">
            <div class="history-detail-header">
                <div>
                    <h4 style="margin: 0 0 5px 0; color: var(--text-primary);">${meal.name}</h4>
                    <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">
                        ${getMealTypeLabel(meal.type)} • ${meal.foods.length} aliments
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">Total</div>
                    <div style="font-weight: 700; color: var(--primary); font-size: var(--font-size-lg);">
                        ${Math.round(mealCalories)} kcal
                    </div>
                </div>
            </div>
            
            <div style="margin: 20px 0;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                    <div style="text-align: center; padding: 10px; background: var(--card-bg); border-radius: var(--radius-sm); border: 1px solid var(--border);">
                        <div style="font-size: var(--font-size-lg); font-weight: 900; color: var(--primary);">${Math.round(mealCalories)}</div>
                        <div style="font-size: var(--font-size-xs); color: var(--text-secondary);">CALORIES</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: var(--card-bg); border-radius: var(--radius-sm); border: 1px solid var(--border);">
                        <div style="font-size: var(--font-size-lg); font-weight: 900; color: #EF4444;">${Math.round(mealProtein)}g</div>
                        <div style="font-size: var(--font-size-xs); color: var(--text-secondary);">PROTÉINES</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: var(--card-bg); border-radius: var(--radius-sm); border: 1px solid var(--border);">
                        <div style="font-size: var(--font-size-lg); font-weight: 900; color: #10B981;">${Math.round(mealCarbs)}g</div>
                        <div style="font-size: var(--font-size-xs); color: var(--text-secondary);">GLUCIDES</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: var(--card-bg); border-radius: var(--radius-sm); border: 1px solid var(--border);">
                        <div style="font-size: var(--font-size-lg); font-weight: 900; color: #F59E0B;">${Math.round(mealFat)}g</div>
                        <div style="font-size: var(--font-size-xs); color: var(--text-secondary);">LIPIDES</div>
                    </div>
                </div>
                
                <h4 style="margin: 0 0 15px 0; color: var(--text-primary);">Aliments (${meal.foods.length})</h4>
                
                <!-- ✅ LISTE DES ALIMENTS - STRUCTURE PLATE (SIBLINGS) -->
                <div class="foods-list-container" style="display: flex; flex-direction: column; gap: 12px;">
    `;
    
    // ✅ BOUCLE CORRECTE - CHAQUE ALIMENT EST UN DIV FRÈRE
    meal.foods.forEach(foodItem => {
        const food = getAllFoods().find(f => f.id === foodItem.foodId);
        if (food) {
            const ratio = foodItem.quantity / food.quantity;
            const foodCalories = Math.round(food.calories * ratio);
            const foodProtein = Math.round(food.protein * ratio);
            const foodCarbs = Math.round(food.carbs * ratio);
            const foodFat = Math.round(food.fat * ratio);
            
            detailHTML += `
                <div class="food-detail-card" style="padding: 12px; background: var(--card-bg); border-radius: var(--radius-sm); border: 1px solid var(--border);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div style="font-weight: 700; color: var(--text-primary);">${food.name}</div>
                        <div style="font-size: var(--font-size-sm); color: var(--primary); font-weight: 600;">${foodItem.quantity}g</div>
                    </div>
                    <div style="display: flex; gap: 16px; font-size: var(--font-size-xs);">
                        <div style="color: #EF4444;">P: ${foodProtein}g</div>
                        <div style="color: #10B981;">C: ${foodCarbs}g</div>
                        <div style="color: #F59E0B;">L: ${foodFat}g</div>
                        <div style="color: var(--primary); font-weight: 600;">${foodCalories} kcal</div>
                    </div>
                </div>
            `;
        }
    });
    
    detailHTML += `</div>`; // Fermeture de foods-list-container
    
    if (meal.notes) {
        detailHTML += `
            <div style="margin-top: 20px; padding: 15px; background: var(--card-bg); border-radius: var(--radius-sm); border: 1px solid var(--border); border-left: 3px solid var(--primary);">
                <div style="font-weight: 700; color: var(--text-primary); margin-bottom: 8px;">
                    <i class="fas fa-pencil-alt"></i> Notes
                </div>
                <div style="color: var(--text-secondary); font-size: var(--font-size-sm); white-space: pre-wrap;">${meal.notes}</div>
            </div>
        `;
    }
    
    detailHTML += `
            </div>
        </div>
    `;
    
    document.getElementById('meal-detail-title').textContent = 'Détail du repas';
    document.getElementById('meal-detail-content').innerHTML = detailHTML;
    showModal('meal-detail-modal');
}


function addFoodToMeal(foodId) {
    const food = getAllFoods().find(f => f.id === foodId);
    if (!food) return;
    
    if (food.favorite) {
        // Si l'aliment est un favori, demander confirmation
        document.getElementById('favorite-food-modal').dataset.foodId = foodId;
        document.getElementById('favorite-food-message').textContent = 
            `"${food.name}" est dans vos favoris. Voulez-vous ajouter un repas avec cet aliment ?`;
        showModal('favorite-food-modal');
    } else {
        // Ajouter directement à un nouveau repas
        showAddMealModal();
        setTimeout(() => {
            addFoodToMealFromSearch(foodId);
        }, 300);
    }
}

function addFavoriteFoodToMeal() {
    const foodId = document.getElementById('favorite-food-modal').dataset.foodId;
    hideModal('favorite-food-modal');
    
    showAddMealModal();
    setTimeout(() => {
        addFoodToMealFromSearch(foodId);
    }, 300);
}

function updateFavoriteFoods() {
    const container = document.getElementById('favorite-foods-container');
    if (!container) return;
    
    const favoriteFoods = getAllFoods().filter(food => food.favorite).slice(0, 10);
    
    container.innerHTML = '';
    
    if (favoriteFoods.length === 0) {
        container.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 20px; color: var(--text-secondary);">
                <div style="font-size: 24px; margin-bottom: 10px;">⭐</div>
                <p>Aucun aliment favori</p>
                <p style="font-size: var(--font-size-sm); margin-top: 6px;">Marquez des aliments comme favoris pour les voir ici</p>
            </div>
        `;
        return;
    }
    
    favoriteFoods.forEach(food => {
        const foodItem = document.createElement('div');
        foodItem.className = 'favorite-food-item';
        foodItem.onclick = () => addFoodToMeal(food.id);
        
        foodItem.innerHTML = `
            <div class="favorite-food-name">${food.name}</div>
            <div class="favorite-food-calories">${food.calories} kcal</div>
        `;
        
        container.appendChild(foodItem);
    });
}

function refreshFavoriteFoods() {
    updateFavoriteFoods();
    showNotification('Favoris actualisés');
}
// MODIFICATION: Fonction pour les exercices favoris
function loadFavoriteExercises() {
    const container = document.getElementById('favorite-exercises-container');
    if (!container) return;
    
    const favoriteExercises = getAllExercises().filter(ex => ex.favorite).slice(0, 10);
    
    container.innerHTML = '';
    
    if (favoriteExercises.length === 0) {
        container.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 20px; color: var(--text-secondary);">
                <div style="font-size: 24px; margin-bottom: 10px;">⭐</div>
                <p>Aucun exercice favori</p>
                <p style="font-size: var(--font-size-sm); margin-top: 6px;">Marquez des exercices comme favoris pour les voir ici</p>
            </div>
        `;
        return;
    }
    
    favoriteExercises.forEach(exercise => {
        const muscle = muscleGroups.find(m => m.id === exercise.muscleGroup);
        const exerciseItem = document.createElement('div');
        exerciseItem.className = 'favorite-item-premium';
        exerciseItem.onclick = () => addToWorkout(exercise.id);
        
        exerciseItem.innerHTML = `
            <div class="favorite-item-name">${exercise.name}</div>
            <div class="favorite-item-muscle">${muscle ? muscle.name : exercise.muscleGroup}</div>
        `;
        
        container.appendChild(exerciseItem);
    });
}

function refreshFavoriteExercises() {
    loadFavoriteExercises();
    showNotification('Exercices favoris actualisés');
}

// ==================== GESTION DE L'HISTORIQUE ====================
function showHistoryTab(tab) {
    document.getElementById('workout-history-tab').classList.toggle('hidden', tab !== 'workouts');
    document.getElementById('nutrition-history-tab').classList.toggle('hidden', tab !== 'nutrition');
    
    document.querySelectorAll('#history-screen .history-tab').forEach((btn, index) => {
        btn.classList.toggle('active', (tab === 'workouts' && index === 0) || (tab === 'nutrition' && index === 1));
    });
    
    if (tab === 'workouts') {
        loadWorkoutHistory();
    } else if (tab === 'nutrition') {
        // loadNutritionHistory(); // ← SUPPRIMÉ
    }
}

function loadWorkoutHistory() {
    const container = document.getElementById('workout-history');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (workoutHistory.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">📊</div>
                <p>Aucune séance enregistrée</p>
                <p style="font-size: var(--font-size-sm); margin-top: 6px;">Terminez une séance pour la voir ici</p>
            </div>
        `;
        return;

    
    }
    
    workoutHistory.forEach((entry, index) => {
        const historyItem = document.createElement('div');
        historyItem.className = 'history-item-improved';
        
        const date = new Date(entry.date);
        const formattedDate = date.toLocaleDateString('fr-FR', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        const durationHours = Math.floor(entry.duration / 3600);
        const durationMinutes = Math.floor((entry.duration % 3600) / 60);
        const durationSeconds = entry.duration % 60;
        const formattedDuration = durationHours > 0 ? 
            `${durationHours}h ${durationMinutes.toString().padStart(2, '0')}min` : 
            `${durationMinutes}min ${durationSeconds.toString().padStart(2, '0')}s`;
        
        const totalReps = calculateTotalReps(entry);
        const totalPauseSeconds = calculateTotalPause(entry);
        const pauseMinutes = Math.floor(totalPauseSeconds / 60);
        const formattedPause = `${pauseMinutes}min`;
        
        historyItem.innerHTML = `
            <div class="history-item-improved-header">
                <div class="history-item-improved-title">${entry.name}</div>
                <div class="history-item-improved-date">${formattedDate}</div>
            </div>
            <div class="history-item-improved-stats">
                <div class="history-item-improved-stat">
                    <div class="history-item-improved-stat-value">${entry.stats.totalExercises}</div>
                    <div class="history-item-improved-stat-label">Exercices</div>
                </div>
                <div class="history-item-improved-stat">
                    <div class="history-item-improved-stat-value">${entry.stats.totalSets}</div>
                    <div class="history-item-improved-stat-label">Séries</div>
                </div>
                <div class="history-item-improved-stat">
                    <div class="history-item-improved-stat-value">${totalReps}</div>
                    <div class="history-item-improved-stat-label">Répétitions</div>
                </div>
                <div class="history-item-improved-stat">
                    <div class="history-item-improved-stat-value">${entry.stats.totalWeight}kg</div>
                    <div class="history-item-improved-stat-label">Poids</div>
                </div>
                <div class="history-item-improved-stat">
                    <div class="history-item-improved-stat-value">${formattedDuration}</div>
                    <div class="history-item-improved-stat-label">Durée</div>
                </div>
                <div class="history-item-improved-stat">
                    <div class="history-item-improved-stat-value">${formattedPause}</div>
                    <div class="history-item-improved-stat-label">Pause</div>
                </div>
            </div>
            <div class="history-item-improved-actions">
                <button class="action-btn" onclick="showWorkoutHistoryDetail(${index})">
                    <i class="fas fa-eye"></i> Détails
                </button>
                <button class="action-btn" onclick="redoWorkout(${index})">
                    <i class="fas fa-redo"></i> Refaire
                </button>
                <button class="action-btn" onclick="deleteWorkoutHistory(${index})">
                    <i class="fas fa-trash"></i> Supprimer
                </button>
            </div>
        `;
        
        container.appendChild(historyItem);
    });
}

function showWorkoutHistoryView(view) {
    document.getElementById('workout-history-list').classList.toggle('hidden', view !== 'list');
    document.getElementById('workout-history-evolution').classList.toggle('hidden', view !== 'evolution');
    document.getElementById('workout-history-exercises').classList.toggle('hidden', view !== 'exercises');
    
    document.querySelectorAll('.history-view-toggle-btn').forEach((btn, index) => {
        const views = ['list', 'evolution', 'exercises'];
        btn.classList.toggle('active', views[index] === view);
    });
    
    if (view === 'evolution') {
        loadEvolutionChart();
    } else if (view === 'exercises') {
        loadExercisesChart();
    }
}

// MODIFICATION: Graphique d'évolution
function loadEvolutionChart() {
    const container = document.getElementById('evolution-chart');
    if (!container) return;
    
    if (workoutHistory.length === 0) {
        container.innerHTML = `
            <div class="chart-placeholder">
                <div style="text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 10px;">📊</div>
                    <p>Aucune donnée à afficher</p>
                    <p style="font-size: var(--font-size-sm);">Terminez des séances pour voir votre évolution</p>
                </div>
            </div>
        `;
        return;
    }
    
    // Prendre les 10 dernières séances
    const recentWorkouts = workoutHistory.slice(0, 10).reverse();
    const dates = recentWorkouts.map(w => {
        const date = new Date(w.date);
        return date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' });
    });
    
    const weights = recentWorkouts.map(w => w.stats.totalWeight);
    const maxWeight = Math.max(...weights, 100);
    
    // Définir des couleurs pour les barres
const colors = [
    'linear-gradient(to top, #6366F1, #818CF8)',
    'linear-gradient(to top, #10B981, #34D399)',
    'linear-gradient(to top, #F59E0B, #FBBF24)',
    'linear-gradient(to top, #EF4444, #FCA5A5)',
    'linear-gradient(to top, #8B5CF6, #A78BFA)',
    'linear-gradient(to top, #06B6D4, #22D3EE)',
    'linear-gradient(to top, #EC4899, #F472B6)',
    'linear-gradient(to top, #84CC16, #A3E635)',
    'linear-gradient(to top, #F97316, #FB923C)',
    'linear-gradient(to top, #64748B, #94A3B8)'
];

        container.innerHTML = `
            <div style="height: 200px; display: flex; align-items: flex-end; gap: 8px; padding: 20px 15px; border-bottom: 1px solid var(--border); background: var(--card-bg); border-radius: var(--radius-sm); margin-bottom: 10px;">
                ${weights.map((weight, index) => `
                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center; height: 100%;">
                        <div style="width: 35px; height: ${(weight / maxWeight) * 100}%; 
                              background: ${colors[index % colors.length]}; 
                              border-radius: 6px 6px 0 0; position: relative; cursor: pointer;
                              box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: all 0.3s ease;
                              border: 2px solid rgba(255,255,255,0.3);" 
                             onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.25)'" 
                             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'"
                             title="${recentWorkouts[index].name}: ${weight}kg">
                            <div style="position: absolute; top: -35px; left: 50%; transform: translateX(-50%); 
                                  font-size: var(--font-size-sm); font-weight: 800; white-space: nowrap;
                                  background: var(--primary); color: white; padding: 4px 10px; border-radius: 12px; 
                                  border: 2px solid white; box-shadow: var(--shadow);">
                                ${weight}kg
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
            <div style="display: flex; justify-content: space-between; padding: 10px 15px; font-size: var(--font-size-sm); color: var(--text-primary); font-weight: 600; background: var(--card-bg); border-radius: var(--radius-sm);">
                ${dates.map(date => `<div style="transform: rotate(-45deg); transform-origin: left center; white-space: nowrap;">${date}</div>`).join('')}
            </div>
        `;
}

function loadExercisesChart() {
    const container = document.getElementById('exercises-chart');
    const listContainer = document.getElementById('exercises-detailed-list');
    if (!container || !listContainer) return;
    
    if (workoutHistory.length === 0) {
        container.innerHTML = `
            <div class="chart-placeholder">
                <div style="text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 10px;">🏋️‍♂️</div>
                    <p>Aucun exercice à analyser</p>
                </div>
            </div>
        `;
        listContainer.innerHTML = '';
        return;
    }
    
    // Analyser les exercices les plus fréquents
    const exerciseStats = {};
    
    workoutHistory.forEach(session => {
        session.exercises.forEach(exercise => {
            if (!exerciseStats[exercise.name]) {
                exerciseStats[exercise.name] = {
                    count: 0,
                    totalWeight: 0,
                    totalReps: 0,
                    maxWeight: 0,
                    avgWeight: 0,
                    muscleGroup: exercise.muscleGroup
                };
            }
            exerciseStats[exercise.name].count++;
            
            exercise.sets.forEach(set => {
                const weight = set.weight || 0;
                const reps = parseInt(set.reps) || 0;
                exerciseStats[exercise.name].totalWeight += weight * reps;
                exerciseStats[exercise.name].totalReps += reps;
                if (weight > exerciseStats[exercise.name].maxWeight) {
                    exerciseStats[exercise.name].maxWeight = weight;
                }
            });
            
            // Calculer la moyenne après chaque session
            if (exerciseStats[exercise.name].totalReps > 0) {
                exerciseStats[exercise.name].avgWeight = Math.round(exerciseStats[exercise.name].totalWeight / exerciseStats[exercise.name].totalReps);
            }
        });
    });
    
    const sortedExercises = Object.entries(exerciseStats)
        .sort(([, a], [, b]) => b.count - a.count)
        .slice(0, 8);
    
    const maxCount = Math.max(...sortedExercises.map(([, stats]) => stats.count), 1);
    
            container.innerHTML = `
        <div style="height: 200px; display: flex; align-items: flex-end; gap: 12px; padding: 20px 15px; border-bottom: 1px solid var(--border); background: var(--card-bg); border-radius: var(--radius-sm); margin-bottom: 10px;">
            ${sortedExercises.map(([name, stats], index) => `
                <div style="flex: 1; display: flex; flex-direction: column; align-items: center; height: 100%;">
                    <div style="width: 40px; height: ${(stats.count / maxCount) * 100}%; 
                          background: linear-gradient(to top, ${getMuscleColor(stats.muscleGroup)}, ${adjustColor(getMuscleColor(stats.muscleGroup), 40)}); 
                          border-radius: 8px 8px 0 0; position: relative; cursor: pointer;
                          box-shadow: 0 6px 16px rgba(0,0,0,0.2); transition: all 0.3s ease;
                          border: 3px solid rgba(255,255,255,0.4);" 
                         onmouseover="this.style.transform='translateY(-8px) scale(1.05)'; this.style.boxShadow='0 12px 24px rgba(0,0,0,0.3)'" 
                         onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 6px 16px rgba(0,0,0,0.2)'"
                         title="${name}: ${stats.count} séances">
                        <div style="position: absolute; top: -40px; left: 50%; transform: translateX(-50%); 
                              font-size: var(--font-size-sm); font-weight: 800; white-space: nowrap;
                              background: var(--card-bg); color: var(--text-primary); padding: 5px 12px; border-radius: 14px; 
                              border: 2px solid ${getMuscleColor(stats.muscleGroup)}; box-shadow: var(--shadow);">
                            ${stats.count}
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
        <div style="display: flex; justify-content: space-between; padding: 10px 15px; font-size: var(--font-size-sm); color: var(--text-primary); font-weight: 600; background: var(--card-bg); border-radius: var(--radius-sm);">
            ${sortedExercises.map(([name], index) => `<div style="text-align: center; width: 40px; overflow: hidden; text-overflow: ellipsis;" title="${name}">${index + 1}</div>`).join('')}
        </div>
    `;
    
    // Liste détaillée
    listContainer.innerHTML = `
        <div class="card" style="margin-top: 15px;">
            <h4 style="margin: 0 0 15px 0;">Exercices les plus réalisés</h4>
            ${sortedExercises.map(([name, stats]) => `
                <div style="padding: 10px; border-bottom: 1px solid var(--border);">
                    <div style="font-weight: 700; color: var(--text-primary);">${name}</div>
                    <div style="display: flex; flex-direction: column; gap: 8px; font-size: var(--font-size-sm); color: var(--text-secondary); margin-top: 5px;">
    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
        <span>${stats.count} séances</span>
        <span>${stats.totalReps} répétitions</span>
        <span>${stats.totalWeight}kg total</span>
    </div>
    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
        <span style="color: #EF4444;">Max: ${stats.maxWeight}kg</span>
        <span>Moy: ${stats.avgWeight}kg/rep</span>
    </div>
</div>
                </div>
            `).join('')}
        </div>
    `;
}

function getMuscleColor(muscleGroupId) {
    const muscle = muscleGroups.find(m => m.id === muscleGroupId);
    return muscle ? muscle.color : '#6366F1';
}


// ==================== AFFICHAGE DÉTAILLÉ D'UNE SÉANCE ====================
function showWorkoutHistoryDetail(index) {
    const entry = workoutHistory[index];
    if (!entry) return;
    
    const date = new Date(entry.date);
    const formattedDate = date.toLocaleDateString('fr-FR', {
        weekday: 'long',
        day: '2-digit',
        month: 'long',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
    
    const durationHours = Math.floor(entry.duration / 3600);
    const durationMinutes = Math.floor((entry.duration % 3600) / 60);
    const durationSeconds = entry.duration % 60;
    const formattedDuration = durationHours > 0 ? 
        `${durationHours}h ${durationMinutes.toString().padStart(2, '0')}min ${durationSeconds.toString().padStart(2, '0')}s` : 
        `${durationMinutes}min ${durationSeconds.toString().padStart(2, '0')}s`;
    
    let contentHTML = `
        <div class="history-detail-content">
            <div class="history-detail-header">
                <div>
                    <h4 style="margin: 0 0 5px 0; color: var(--text-primary);">${entry.name}</h4>
                    <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">${formattedDate}</div>
                </div>
            </div>
            
            <div style="margin: 20px 0;">
                <div class="history-stats-grid" style="margin-bottom: 20px;">
                    <div class="history-stat-exercice" style="padding: 10px; background: var(--card-bg); border-radius: var(--radius-sm); border: 1px solid var(--border);">
                        <div class="history-stat-value">${entry.stats.totalExercises} exercices</div>
                        <div class="history-stat-label">EXERCICES</div>
                    </div>
                    <div class="history-stat-series" style="text-align: center; padding: 10px; background: var(--card-bg); border-radius: var(--radius-sm); border: 1px solid var(--border);">
                        <div style="font-size: var(--font-size-lg); font-weight: 900; color: var(--primary);">${entry.stats.totalSets}</div>
                        <div style="font-size: var(--font-size-xs); color: var(--text-secondary);">SÉRIES</div>
                    </div>
                    <div class="history-stat-repetitions" style="text-align: center; padding: 10px; background: var(--card-bg); border-radius: var(--radius-sm); border: 1px solid var(--border);">
                        <div style="font-size: var(--font-size-lg); font-weight: 900; color: var(--primary);">${calculateTotalReps(entry)}</div>
                        <div style="font-size: var(--font-size-xs); color: var(--text-secondary);">RÉPÉTITIONS</div>
                    </div>
                    <div class="history-stat-poids" style="text-align: center; padding: 10px; background: var(--card-bg); border-radius: var(--radius-sm); border: 1px solid var(--border);">
                        <div style="font-size: var(--font-size-lg); font-weight: 900; color: var(--primary);">${entry.stats.totalWeight}</div>
                        <div style="font-size: var(--font-size-xs); color: var(--text-secondary);">KG TOTAL</div>
                    </div>
                    <div class="history-stat-duree" style="text-align: center; padding: 10px; background: var(--card-bg); border-radius: var(--radius-sm); border: 1px solid var(--border);">
                        <div style="font-size: var(--font-size-lg); font-weight: 900; color: var(--primary);">${formattedDuration}</div>
                        <div style="font-size: var(--font-size-xs); color: var(--text-secondary);">DURÉE</div>
                    </div>
                </div>
                
                ${entry.supersets && entry.supersets.length > 0 ? `
                    <div style="margin-bottom: 20px; padding: 15px; background: var(--card-bg); border-radius: var(--radius-sm); border: 1px solid var(--border);">
                        <div style="font-weight: 700; color: var(--text-primary); margin-bottom: 10px;">
                            <i class="fas fa-link"></i> Supersets (${entry.supersets.length})
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                            ${entry.supersets.map(superset => `
                                <div style="padding: 8px 12px; background: ${superset.color || '#8B5CF6'}; color: white; border-radius: var(--radius-sm); font-size: var(--font-size-sm); font-weight: 600;">
                                    ${superset.name} (${superset.exercises ? superset.exercises.length : 0} ex.)
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <h4 style="margin: 0 0 15px 0; color: var(--text-primary);">Exercices détaillés</h4>
    `;
    
    // Standalone exercises
    entry.exercises.forEach((exercise) => {
        const muscle = muscleGroups.find(m => m.id === exercise.muscleGroup);
        const muscleName = muscle ? muscle.name : exercise.muscleGroup;
        
        contentHTML += `
            <div class="history-detail-exercise">
                <div class="history-detail-exercise-name">${exercise.name}</div>
                <div style="font-size: var(--font-size-xs); color: var(--text-secondary); margin-bottom: 10px;">
                    <span style="color: ${muscle ? muscle.color : '#666'}">●</span> ${muscleName}
                </div>
                <div class="history-detail-sets">
        `;
        
        exercise.sets.forEach((set, setIndex) => {
            contentHTML += `
                <div class="history-detail-set" style="background: ${setIndex % 2 === 0 ? 'var(--card-bg)' : '#f0f9ff'}; border: 1px solid ${setIndex % 2 === 0 ? 'var(--border)' : '#bae6fd'};">
                    S${setIndex + 1}: ${set.reps} × ${set.weight}kg
                </div>
            `;
        });
        
        const totalReps = exercise.sets.reduce((sum, set) => sum + (parseInt(set.reps) || 0), 0);
        const totalWeight = exercise.sets.reduce((sum, set) => sum + (set.weight || 0) * (parseInt(set.reps) || 0), 0);
        
        let bestSet = { reps: 0, weight: 0, oneRM: 0, volume: 0 };
        exercise.sets.forEach(set => {
            const reps = parseInt(set.reps) || 0;
            const weight = parseFloat(set.weight) || 0;
            if (reps > 0 && weight > 0) {
                const oneRM = calculateOneRM(weight, reps);
                const volume = calculateVolume(weight, reps);
                if (oneRM > bestSet.oneRM) {
                    bestSet = { reps, weight, oneRM, volume };
                }
            }
        });

        contentHTML += `
                </div>
                <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px; font-size: var(--font-size-xs);">
                    <div style="padding: 4px 8px; background: var(--card-bg); border-radius: 10px; border: 1px solid var(--border);">
                        Total: ${totalReps} reps
                    </div>
                    <div style="padding: 4px 8px; background: var(--card-bg); border-radius: 10px; border: 1px solid var(--border);">
                        Poids: ${totalWeight}kg
                    </div>
                </div>
                
                ${bestSet.oneRM > 0 ? `
                <div style="display: flex; gap: 10px; margin-top: 8px; padding: 8px; background: linear-gradient(135deg, rgba(99,102,241,0.1), rgba(16,185,129,0.05)); border-radius: var(--radius-sm);">
                    <div style="flex: 1; text-align: center;">
                        <div style="font-size: 10px; color: var(--text-secondary);">1RM</div>
                        <div style="font-weight: 800; color: #6366F1; font-size: var(--font-size-sm);">${bestSet.oneRM} kg</div>
                        <div style="font-size: 9px; color: var(--text-secondary);">${bestSet.weight}kg × ${bestSet.reps}</div>
                    </div>
                    <div style="flex: 1; text-align: center;">
                        <div style="font-size: 10px; color: var(--text-secondary);">Volume</div>
                        <div style="font-weight: 800; color: #10B981; font-size: var(--font-size-sm);">${bestSet.volume} kg</div>
                        <div style="font-size: 9px; color: var(--text-secondary);">${bestSet.weight}kg × ${bestSet.reps}</div>
                    </div>
                </div>
                ` : ''}
                
                ${exercise.notes ? `
                    <div style="margin-top: 15px; padding: 12px; background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(236, 72, 153, 0.05)); border-radius: var(--radius-sm); border-left: 3px solid #8B5CF6;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <div style="width: 24px; height: 24px; background: linear-gradient(135deg, #8B5CF6, #EC4899); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px;">
                                <i class="fas fa-sticky-note"></i>
                            </div>
                            <div style="font-weight: 700; color: #8B5CF6;">Notes</div>
                        </div>
                        <div style="color: var(--text-primary); font-size: var(--font-size-sm); white-space: pre-wrap; line-height: 1.5; padding: 0 4px;">
                            ${exercise.notes}
                        </div>
                    </div>
                ` : ''}
                
            </div>
        `;
    });
    
// ==================== GRAPHIQUES DE PROGRESSION ====================
if (entry.exercises.length > 0) {
    contentHTML += `
        <div style="margin-top: 40px; margin-bottom: 20px;">
            <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px;">
                <h4 style="margin: 0; color: var(--text-primary); display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-chart-line" style="color: var(--primary);"></i>
                    Évolution des performances
                </h4>
                <div style="display: flex; gap: 8px; background: var(--card-bg); padding: 4px; border-radius: 24px; border: 1px solid var(--border); width: fit-content;">
                    <button id="chart-metric-btn-1rm-${index}" class="chart-metric-btn active" 
                            style="padding: 8px 16px; border-radius: 20px; border: none; background: var(--primary); color: white; font-size: var(--font-size-xs); font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s ease;"
                            onclick="toggleChartMetric('1RM', ${index})">
                        <i class="fas fa-dumbbell"></i> 1RM
                    </button>
                    <button id="chart-metric-btn-volume-${index}" class="chart-metric-btn"
                            style="padding: 8px 16px; border-radius: 20px; border: none; background: var(--card-bg); color: var(--text-secondary); font-size: var(--font-size-xs); font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s ease;"
                            onclick="toggleChartMetric('volume', ${index})">
                        <i class="fas fa-weight-hanging"></i> Volume
                    </button>
                </div>
            </div>
            <div id="charts-container-${index}" style="display: flex; flex-direction: column; gap: 20px;">
    `;
    
    entry.exercises.forEach((exercise, exIndex) => {
        contentHTML += `
            <div class="exercise-chart-card" 
                 style="background: var(--card-bg); border-radius: var(--radius); border: 1px solid var(--border); padding: 16px; box-shadow: var(--shadow-sm);">
                
                <!-- NOM DE L'EXERCICE EN ÉVIDENCE -->
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px; border-bottom: 1px solid var(--border); padding-bottom: 12px;">
                    <div style="width: 44px; height: 44px; background: linear-gradient(135deg, var(--primary), #818CF8); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px;">
                        <i class="fas fa-dumbbell"></i>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 800; color: var(--text-primary); font-size: var(--font-size-base); letter-spacing: 0.3px;">
                            ${exercise.name}
                        </div>
                        <div style="display: flex; gap: 16px; margin-top: 4px; font-size: var(--font-size-xs); color: var(--text-secondary);">
                            <span><i class="far fa-calendar-alt" style="margin-right: 4px;"></i> <span id="chart-stats-${index}-${exIndex}">Chargement...</span></span>
                        </div>
                    </div>
                </div>
                
                <!-- CONTENEUR DU GRAPHIQUE -->
                <div id="chart-${index}-${exIndex}" style="min-height: 140px; width: 100%;"></div>
            </div>
        `;
    });
    
    contentHTML += `
            </div>
        </div>
    `;
}
    
    contentHTML += `
            </div>
            
            <div class="history-detail-actions" style="margin-top: 30px; display: flex; gap: 12px;">
                <button class="btn btn-success" onclick="redoWorkout(${index})" style="flex: 1; padding: 14px; font-weight: 700;">
                    <i class="fas fa-redo"></i> Refaire
                </button>
                <button class="btn btn-danger" onclick="deleteWorkoutHistory(${index})" style="flex: 1; padding: 14px; font-weight: 700;">
                    <i class="fas fa-trash"></i> Supprimer
                </button>
            </div>
        </div>
    `;
    
    document.getElementById('history-detail-title').textContent = 'Détail de la séance';
    document.getElementById('history-detail-content').innerHTML = contentHTML;
    showModal('history-detail-modal');
    
    // Rendre les graphiques après l'affichage
    setTimeout(() => {
        entry.exercises.forEach((exercise, exIndex) => {
            const containerId = `chart-${index}-${exIndex}`;
            const statsSpan = document.getElementById(`chart-stats-${index}-${exIndex}`);
            
            const history = getExerciseHistory(exercise.name);
            if (history.length >= 2 && statsSpan) {
                statsSpan.innerHTML = `${history.length} séances`;
                renderExerciseCharts(exercise.name, containerId, 'oneRM');
            } else if (statsSpan) {
                statsSpan.innerHTML = 'Pas assez de données';
            }
        });
    }, 200);
}

// ==================== NOUVEAU SYSTÈME D'HISTORIQUE NUTRITIONNEL ====================

function loadNutritionHistoryData(period = 'day') {
    console.log('Chargement données période:', period);
    const containerId = `nutrition-history-${period}`;
    const container = document.getElementById(containerId);
    
    if (!container) {
        console.error('Container non trouvé:', containerId);
        return;
    }
    
    // Générer le HTML avec l'architecture UNIFIÉE
    container.innerHTML = generateNutritionHistoryHTML(period);
}

function generateNutritionHistoryHTML(period) {
    // Filtrer les données selon la période
    const filteredData = getNutritionDataForPeriod(period);
    
    if (filteredData.length === 0) {
        return `
            <div class="empty-state">
                <div class="empty-state-icon">🍽️</div>
                <p>Aucun historique nutritionnel pour cette période</p>
                <p style="font-size: var(--font-size-sm); margin-top: 6px;">Votre historique nutritionnel apparaîtra ici</p>
            </div>
        `;
    }
    
    let html = '';
    
    // Utiliser la MÊME structure pour toutes les périodes
    filteredData.forEach(item => {
        const calorieNeeds = userProfile.calorieNeeds || 2500;
        const calorieBalance = item.totalCalories - calorieNeeds;
        
        html += `
            <div class="nutrition-history-item">
                <div class="nutrition-history-header">
                    <div class="nutrition-history-title">${formatDateForPeriod(item.date, period)}</div>
                    <div class="nutrition-history-date">${item.mealCount} repas</div>
                </div>
                
                <div class="nutrition-history-totals">
                    <div class="nutrition-history-total">
                        <div class="nutrition-history-total-value">${Math.round(item.totalCalories)}</div>
                        <div class="nutrition-history-total-label">Calories</div>
                        <div class="history-calories-balance ${calorieBalance <= 0 ? 'positive' : 'negative'}">
                            ${calorieBalance >= 0 ? '+' : ''}${Math.round(calorieBalance)} kcal
                        </div>
                    </div>
                    <div class="nutrition-history-total">
                        <div class="nutrition-history-total-value protein">${Math.round(item.totalProtein)}g</div>
                        <div class="nutrition-history-total-label">Protéines</div>
                    </div>
                    <div class="nutrition-history-total">
                        <div class="nutrition-history-total-value carbs">${Math.round(item.totalCarbs)}g</div>
                        <div class="nutrition-history-total-label">Glucides</div>
                    </div>
                    <div class="nutrition-history-total">
                        <div class="nutrition-history-total-value fat">${Math.round(item.totalFat)}g</div>
                        <div class="nutrition-history-total-label">Lipides</div>
                    </div>
                </div>
                
                <div style="margin-top: 16px;">
                    ${item.meals.map(meal => {
                        const mealDate = new Date(meal.date);
                        return `
                        <div class="food-item-improved" style="margin-bottom: 10px; cursor: pointer;" onclick="showMealDetail('${meal.id}')">
                            <div class="food-item-improved-header">
                                <div class="food-item-improved-name">${meal.name}</div>
                                <div class="meal-type-badge">${getMealTypeLabel(meal.type)}</div>
                            </div>
                            <div class="food-item-improved-details">
                                <span>${meal.foods.length} aliments</span>
                                <span>${mealDate.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})}</span>
                            </div>
                            ${meal.notes ? `
                                <div style="font-size: var(--font-size-sm); color: var(--text-secondary); margin-top: 8px; font-style: italic;">
                                    "${meal.notes}"
                                </div>
                            ` : ''}
                        </div>
                    `}).join('')}
                </div>
            </div>
        `;
    });
    
    return html;
}

function getNutritionDataForPeriod(period) {
    const now = new Date();
    let filteredMeals = [...nutritionHistory];
    
    console.log('Total repas dans historique:', nutritionHistory.length);
    
    // Filtrer par période
    if (period === 'day') {
        const today = now.toISOString().split('T')[0];
        filteredMeals = nutritionHistory.filter(meal => {
            const mealDate = new Date(meal.date).toISOString().split('T')[0];
            return mealDate === today;
        });
        console.log('Repas aujourd\'hui:', filteredMeals.length);
    } else if (period === 'week') {
        const oneWeekAgo = new Date(now);
        oneWeekAgo.setDate(now.getDate() - 7);
        filteredMeals = nutritionHistory.filter(meal => {
            const mealDate = new Date(meal.date);
            return mealDate >= oneWeekAgo;
        });
        console.log('Repas dernière semaine:', filteredMeals.length);
    } else if (period === 'month') {
        const oneMonthAgo = new Date(now);
        oneMonthAgo.setMonth(now.getMonth() - 1);
        filteredMeals = nutritionHistory.filter(meal => {
            const mealDate = new Date(meal.date);
            return mealDate >= oneMonthAgo;
        });
        console.log('Repas dernier mois:', filteredMeals.length);
    }
    
    // Grouper par date selon la période
    const groupedData = {};
    
    filteredMeals.forEach(meal => {
        const mealDate = new Date(meal.date);
        let dateKey;
        
        if (period === 'day') {
            dateKey = mealDate.toLocaleDateString('fr-FR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        } else if (period === 'week') {
            // Grouper par semaine (lundi-dimanche)
            const weekStart = new Date(mealDate);
            weekStart.setDate(mealDate.getDate() - mealDate.getDay() + 1); // Lundi
            dateKey = `Semaine du ${weekStart.toLocaleDateString('fr-FR', {day: '2-digit', month: '2-digit'})}`;
        } else if (period === 'month') {
            // Grouper par mois
            dateKey = mealDate.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
        }
        
        if (!groupedData[dateKey]) {
            groupedData[dateKey] = {
                date: dateKey,
                meals: [],
                totalCalories: 0,
                totalProtein: 0,
                totalCarbs: 0,
                totalFat: 0,
                mealCount: 0
            };
        }
        
        // Calculer les macros de ce repas
        let mealCalories = 0;
        let mealProtein = 0;
        let mealCarbs = 0;
        let mealFat = 0;
        
        meal.foods.forEach(foodItem => {
            const food = getAllFoods().find(f => f.id === foodItem.foodId);
            if (food) {
                const ratio = foodItem.quantity / food.quantity;
                mealCalories += food.calories * ratio;
                mealProtein += food.protein * ratio;
                mealCarbs += food.carbs * ratio;
                mealFat += food.fat * ratio;
            }
        });
        
        groupedData[dateKey].meals.push({
            ...meal,
            calculatedCalories: Math.round(mealCalories),
            calculatedProtein: Math.round(mealProtein),
            calculatedCarbs: Math.round(mealCarbs),
            calculatedFat: Math.round(mealFat)
        });
        
        groupedData[dateKey].totalCalories += mealCalories;
        groupedData[dateKey].totalProtein += mealProtein;
        groupedData[dateKey].totalCarbs += mealCarbs;
        groupedData[dateKey].totalFat += mealFat;
        groupedData[dateKey].mealCount++;
    });
    
    // Convertir en tableau et trier
    const result = Object.values(groupedData).sort((a, b) => {
        // Essayer de parser la date pour le tri
        try {
            return new Date(b.date) - new Date(a.date);
        } catch (e) {
            // Si on ne peut pas parser, trier par ordre alphabétique inversé
            return b.date.localeCompare(a.date);
        }
    });
    
    console.log('Données groupées:', result.length, 'groupes');
    return result;
}

function formatDateForPeriod(dateStr, period) {
    if (period === 'day' || period === 'week') {
        return dateStr;
    } else if (period === 'month') {
        // Capitaliser la première lettre du mois
        return dateStr.charAt(0).toUpperCase() + dateStr.slice(1);
    }
    return dateStr;
}

function initializeNutritionHistory() {
    console.log('Initialisation historique nutritionnel...');
    
    // Initialiser les 3 périodes
    loadNutritionHistoryData('day');
    loadNutritionHistoryData('week');
    loadNutritionHistoryData('month');
    
    // S'assurer que le jour est actif par défaut
    document.querySelectorAll('.nutrition-period').forEach(el => {
        el.classList.remove('active');
        el.classList.add('hidden');
    });
    
    const dayElement = document.getElementById('nutrition-history-day');
    if (dayElement) {
        dayElement.classList.remove('hidden');
        dayElement.classList.add('active');
    }
    
    // Activer le bouton "Jour"
    document.querySelectorAll('.history-nav-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    const dayBtn = document.querySelector('.history-nav-btn[onclick*="day"]');
    if (dayBtn) {
        dayBtn.classList.add('active');
    }
    
    console.log('Historique nutritionnel initialisé');
}

// MODIFICATION: Fonction pour calculer le total des répétitions
function calculateTotalReps(workoutEntry) {
    let totalReps = 0;
    workoutEntry.exercises.forEach(exercise => {
        exercise.sets.forEach(set => {
            totalReps += parseInt(set.reps) || 0;
        });
    });
    return totalReps;
}

// ==================== CALCUL DU 1RM (1 REPETITION MAXIMUM) ====================
function calculateOneRM(weight, reps) {
    if (!weight || !reps || weight <= 0 || reps <= 0) return 0;
    
    // Formule d'Epley: 1RM = poids × (1 + répétitions/30)
    // Plus précise que Brzycki pour les répétitions < 10
    const oneRM = weight * (1 + parseInt(reps) / 30);
    
    // Arrondir à 1 décimale
    return Math.round(oneRM * 10) / 10;
}

// ==================== CALCUL DU VOLUME (POIDS × RÉPÉTITIONS) ====================
function calculateVolume(weight, reps) {
    if (!weight || !reps || weight <= 0 || reps <= 0) return 0;
    
    const volume = weight * parseInt(reps);
    return Math.round(volume);
}

// ==================== RÉCUPÉRER L'HISTORIQUE D'UN EXERCICE ====================
function getExerciseHistory(exerciseName) {
    if (!workoutHistory || workoutHistory.length === 0) return [];
    
    const history = [];
    
    // Parcourir toutes les séances de la plus ancienne à la plus récente
    const sortedHistory = [...workoutHistory].sort((a, b) => 
        new Date(a.date) - new Date(b.date)
    );
    
    sortedHistory.forEach((session, sessionIndex) => {
        // Chercher l'exercice dans cette séance
        const exercise = session.exercises.find(ex => 
            ex.name.toLowerCase() === exerciseName.toLowerCase()
        );
        
        if (exercise && exercise.sets && exercise.sets.length > 0) {
            // Trouver la MEILLEURE performance de cette séance
            let bestSet = { reps: 0, weight: 0, oneRM: 0, volume: 0 };
            
            exercise.sets.forEach(set => {
                const reps = parseInt(set.reps) || 0;
                const weight = parseFloat(set.weight) || 0;
                
                if (reps > 0 && weight > 0) {
                    const oneRM = calculateOneRM(weight, reps);
                    const volume = calculateVolume(weight, reps);
                    
                    // Priorité au 1RM pour déterminer la meilleure série
                    if (oneRM > bestSet.oneRM) {
                        bestSet = {
                            reps,
                            weight,
                            oneRM,
                            volume,
                            setIndex: set.number || 0
                        };
                    }
                }
            });
            
            if (bestSet.oneRM > 0) {
                history.push({
                    date: session.date,
                    sessionName: session.name,
                    sessionId: session.id,
                    sessionIndex: sessionIndex,
                    bestSet: bestSet,
                    totalSets: exercise.sets.length,
                    completedSets: exercise.sets.filter(s => s.completed !== false).length,
                    notes: exercise.notes || ''
                });
            }
        }
    });
    
    return history;
}

// ==================== CRÉER UN GRAPHIQUE SPARKLINE SVG ====================
function renderExerciseCharts(exerciseName, containerId, metric = 'oneRM') {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    // Récupérer l'historique
    const history = getExerciseHistory(exerciseName);
    
    if (history.length < 2) {
        container.innerHTML = `
            <div style="text-align: center; padding: 15px; color: var(--text-secondary);">
                <i class="fas fa-chart-line" style="font-size: 20px; margin-bottom: 5px; opacity: 0.5;"></i>
                <p style="font-size: var(--font-size-xs);">Pas assez de données (${history.length} séance)</p>
            </div>
        `;
        return;
    }
    
    // Préparer les données - ÉLIMINER LES DOUBLONS DE DATES
    const uniqueHistory = [];
    const seenDates = new Set();
    
    history.forEach(h => {
        const dateStr = new Date(h.date).toLocaleDateString('fr-FR');
        if (!seenDates.has(dateStr)) {
            seenDates.add(dateStr);
            uniqueHistory.push(h);
        }
    });
    
    const labels = uniqueHistory.map(h => {
        const date = new Date(h.date);
        return date.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' });
    });
    
    const values = uniqueHistory.map(h => 
        metric === 'oneRM' ? h.bestSet.oneRM : h.bestSet.volume
    );
    
    if (values.length < 2) {
        container.innerHTML = `
            <div style="text-align: center; padding: 15px; color: var(--text-secondary);">
                <i class="fas fa-chart-line" style="font-size: 20px; margin-bottom: 5px; opacity: 0.5;"></i>
                <p style="font-size: var(--font-size-xs);">Besoin de 2 séances avec des dates différentes</p>
            </div>
        `;
        return;
    }
    
    const maxValue = Math.max(...values) * 1.1;
    const minValue = Math.min(...values) * 0.9;
    const range = maxValue - minValue;
    
    // Dimensions RESPONSIVES
    const containerWidth = container.clientWidth || 280;
    const width = Math.min(containerWidth - 20, 300);
    const height = 70;
    const padding = 15;
    
    // Calculer les points
    const points = values.map((value, index) => {
        const x = padding + (index * (width - 2 * padding) / (values.length - 1));
        const y = height - padding - ((value - minValue) / range) * (height - 2 * padding);
        return { x, y };
    });
    
    // Construire le chemin
    let pathD = `M ${points[0].x} ${points[0].y}`;
    for (let i = 1; i < points.length; i++) {
        pathD += ` L ${points[i].x} ${points[i].y}`;
    }
    
    // Calculer progression
    const firstValue = values[0];
    const lastValue = values[values.length - 1];
    const progression = ((lastValue - firstValue) / firstValue * 100).toFixed(1);
    const progressionColor = progression >= 0 ? '#10B981' : '#EF4444';
    const progressionIcon = progression >= 0 ? '▲' : '▼';
    
    const metricUnit = metric === 'oneRM' ? 'kg' : 'kg';
    
    let svgHTML = '';
    svgHTML += '<div style="background: var(--card-bg); border-radius: var(--radius); padding: 12px;">';
    
    // Mini stats en haut
    svgHTML += '<div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 10px;">';
    svgHTML += '<span style="color: var(--text-secondary);">' + (metric === 'oneRM' ? '1RM max' : 'Volume max') + ': <strong>' + Math.max(...values) + metricUnit + '</strong></span>';
    svgHTML += '<span style="color: ' + progressionColor + ';">' + progressionIcon + ' ' + Math.abs(progression) + '%</span>';
    svgHTML += '</div>';
    
    // Graphique SVG
    svgHTML += '<svg width="' + width + '" height="' + height + '" style="display: block; margin: 0 auto; max-width: 100%;">';
    
    // Ligne de fond
    svgHTML += '<line x1="' + padding + '" y1="' + (height - padding) + '" x2="' + (width - padding) + '" y2="' + (height - padding) + '" ';
    svgHTML += 'stroke="var(--border)" stroke-width="1" stroke-dasharray="3 2"/>';
    
    // Courbe
    svgHTML += '<path d="' + pathD + '" fill="none" stroke="' + (metric === 'oneRM' ? '#6366F1' : '#10B981') + '" ';
    svgHTML += 'stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>';
    
    // Points
    for (let i = 0; i < points.length; i++) {
        svgHTML += '<circle cx="' + points[i].x.toFixed(1) + '" cy="' + points[i].y.toFixed(1) + '" r="3" ';
        svgHTML += 'fill="' + (metric === 'oneRM' ? '#6366F1' : '#10B981') + '" ';
        svgHTML += 'stroke="white" stroke-width="1.5">';
        svgHTML += '<title>' + labels[i] + ': ' + values[i] + metricUnit + '</title>';
        svgHTML += '</circle>';
    }
    
    svgHTML += '</svg>';
    
    // Légende compacte
    svgHTML += '<div style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 8px; color: var(--text-secondary);">';
    for (let i = 0; i < Math.min(labels.length, 4); i++) {
        svgHTML += '<div style="text-align: center;">' + labels[i] + '<br><strong>' + values[i] + '</strong></div>';
    }
    if (labels.length > 4) {
        svgHTML += '<div>...</div>';
    }
    svgHTML += '</div>';
    
    svgHTML += '</div>';
    
    container.innerHTML = svgHTML;
}

// ==================== BASCULER ENTRE 1RM ET VOLUME ====================
// ==================== BASCULER ENTRE 1RM ET VOLUME ====================
function toggleChartMetric(metric, sessionIndex) {
    // Mettre à jour les boutons
    const btn1RM = document.getElementById(`chart-metric-btn-1rm-${sessionIndex}`);
    const btnVolume = document.getElementById(`chart-metric-btn-volume-${sessionIndex}`);
    
    if (!btn1RM || !btnVolume) return;
    
    if (metric === '1RM') {
        btn1RM.style.background = 'var(--primary)';
        btn1RM.style.color = 'white';
        btnVolume.style.background = 'var(--card-bg)';
        btnVolume.style.color = 'var(--text-secondary)';
        btn1RM.classList.add('active');
        btnVolume.classList.remove('active');
    } else {
        btnVolume.style.background = 'var(--primary)';
        btnVolume.style.color = 'white';
        btn1RM.style.background = 'var(--card-bg)';
        btn1RM.style.color = 'var(--text-secondary)';
        btnVolume.classList.add('active');
        btn1RM.classList.remove('active');
    }
    
    // Re-rendre tous les graphiques avec la nouvelle métrique
    const session = workoutHistory[sessionIndex];
    if (session) {
        session.exercises.forEach((exercise, exIndex) => {
            const containerId = `chart-${sessionIndex}-${exIndex}`;
            const history = getExerciseHistory(exercise.name);
            if (history.length >= 2) {
                renderExerciseCharts(exercise.name, containerId, metric === '1RM' ? 'oneRM' : 'volume');
            }
        });
    }
}

function calculateTotalPause(workoutEntry) {
    // Estimation : 90 secondes de pause entre chaque série
    return workoutEntry.stats.totalSets * 90;
}

function redoWorkout(index) {
    const entry = workoutHistory[index];
    if (!entry) return;
    
    const workoutData = {
        name: entry.name,
        exercises: [],
        supersets: entry.supersets || []
    };
    
    // CORRECTION CRITIQUE: Restaurer l'ordre EXACT de la séance originale
    const exercisesByOriginalOrder = [];
    const exercisesBySuperset = {};
    
    // 1. Organiser tous les exercices avec leur position ORIGINALE
    entry.exercises.forEach((exercise, exIndex) => {
        const matchingExercise = getAllExercises().find(ex => 
            ex.name.toLowerCase() === exercise.name.toLowerCase()
        );
        
        if (matchingExercise) {
            const exerciseData = {
                ...exercise,
                matchingExercise: matchingExercise,
                historicalSets: exercise.sets || [],
                originalIndex: exIndex,
                notes: exercise.notes || '',
                customRest: exercise.customRest || userProfile.defaultRest
            };
            
            // Organiser par superset ou standalone
            if (exercise.supersetId) {
                if (!exercisesBySuperset[exercise.supersetId]) {
                    exercisesBySuperset[exercise.supersetId] = [];
                }
                exercisesBySuperset[exercise.supersetId].push(exerciseData);
            } else {
                // Exercice standalone - garder sa position exacte
                exercisesByOriginalOrder[exIndex] = exerciseData;
            }
        }
    });
    
    // 2. Si nous avons des supersets sauvegardés, les utiliser pour reconstruire l'ordre
    if (workoutData.supersets && workoutData.supersets.length > 0) {
        // Trier les supersets par leur PREMIER exercice dans l'ordre original
        const sortedSupersets = workoutData.supersets.sort((a, b) => {
            const firstA = a.exercises && a.exercises.length > 0 ? 
                Math.min(...a.exercises.map(e => e.exerciseIndex)) : Infinity;
            const firstB = b.exercises && b.exercises.length > 0 ? 
                Math.min(...b.exercises.map(e => e.exerciseIndex)) : Infinity;
            return firstA - firstB;
        });
        
        // 3. Reconstruire la séance EXACTEMENT comme elle était
        const reorderedExercises = [];
        
        // Pour chaque position dans la séance originale
        for (let i = 0; i < entry.exercises.length; i++) {
            // Vérifier si cette position est occupée par un exercice standalone
            if (exercisesByOriginalOrder[i]) {
                reorderedExercises.push(exercisesByOriginalOrder[i]);
            } else {
                // Sinon, vérifier si c'est la position d'un superset
                const supersetAtThisPosition = sortedSupersets.find(superset => {
                    return superset.exercises && superset.exercises.some(e => e.exerciseIndex === i);
                });
                
                if (supersetAtThisPosition && exercisesBySuperset[supersetAtThisPosition.id]) {
                    // Ajouter TOUS les exercices de ce superset
                    const supersetExercises = exercisesBySuperset[supersetAtThisPosition.id]
                        .sort((a, b) => (a.supersetOrder || 0) - (b.supersetOrder || 0));
                    
                    supersetExercises.forEach(ex => {
                        reorderedExercises.push(ex);
                    });
                    
                    // Avancer l'index pour sauter les autres exercices de ce superset
                    i += supersetExercises.length - 1;
                }
            }
        }
        
        workoutData.exercises = reorderedExercises;
    } else {
        // Sans supersets, garder simplement l'ordre original
        workoutData.exercises = exercisesByOriginalOrder.filter(ex => ex);
    }
    
    if (workoutData.exercises.length > 0) {
        // Démarrer la séance avec toutes les données historiques
        startRedoWorkout(workoutData);
        hideModal('history-detail-modal');
        showNotification('Séance reprise avec supersets et valeurs historiques');
    } else {
        showNotification('Impossible de retrouver les exercices de cette séance', 'error');
    }
}

// MODIFICATION: Fonction pour redémarrer une séance avec les dernières charges
function startRedoWorkout(workoutData) {
    activeWorkout = {
        name: workoutData.name,
        exercises: [],
        startTime: new Date(),
        completedSets: 0,
        totalWeight: 0,
        // RÉPARATION: Sauvegarder la structure complète des supersets
        supersets: workoutData.supersets || {}
    };
    
    // RÉPARATION: Créer un mapping pour organiser les exercices par superset
    const exercisesBySuperset = {};
    const standaloneExercises = [];
    
    workoutData.exercises.forEach(exercise => {
        // Créer les sets avec les valeurs historiques si disponibles
        const sets = [];
        const numSets = Math.max(userProfile.defaultSets, exercise.historicalSets?.length || 0);
        
        for (let i = 0; i < numSets; i++) {
            const historicalSet = exercise.historicalSets?.[i];
            
            // S'assurer que les valeurs ne soient jamais undefined
            let repsValue = userProfile.defaultReps;
            let weightValue = userProfile.defaultWeight;
            
            if (historicalSet) {
                repsValue = historicalSet.reps !== undefined ? historicalSet.reps : userProfile.defaultReps;
                weightValue = historicalSet.weight !== undefined ? historicalSet.weight : userProfile.defaultWeight;
            }
            
            sets.push({
                number: i + 1,
                reps: repsValue,
                weight: weightValue,
                completed: false,
                isHistorical: !!historicalSet
            });
        }
        
        // CORRECTION: Charger les notes de l'exercice
        const exerciseData = {
            ...exercise.matchingExercise,
    sets: sets,
    customRest: exercise.customRest || userProfile.defaultRest,
    // CORRECTION: Restaurer toutes les infos de superset
    supersetId: exercise.supersetId,
    supersetName: exercise.supersetName,
    supersetColor: exercise.supersetColor,
    supersetOrder: exercise.supersetOrder,
    supersetInfo: exercise.supersetInfo,
// Restaurer le mode compact si sauvegardé
compactModeOverride: exercise.compactModeOverride,
    // CORRECTION: Bien charger les notes sauvegardées
            notes: exercise.notes || '',  // Charger depuis les données de reprise
        // Garder les données historiques pour référence
            historicalSets: exercise.historicalSets || []
        };
        // Organiser les exercices par superset
        if (exercise.supersetId) {
            if (!exercisesBySuperset[exercise.supersetId]) {
                exercisesBySuperset[exercise.supersetId] = [];
            }
            exercisesBySuperset[exercise.supersetId].push(exerciseData);
        } else {
            standaloneExercises.push(exerciseData);
        }
    });
    
    // RÉPARATION: Reconstruire l'ordre correct des exercices
    const allExercises = [...standaloneExercises];
    

    // Ajouter les supersets dans l'ordre original
    if (workoutData.supersets && typeof workoutData.supersets === 'object') {
        Object.values(workoutData.supersets).forEach(superset => {
            if (exercisesBySuperset[superset.id]) {
                // Trier les exercices du superset par ordre
                const supersetExercises = exercisesBySuperset[superset.id];
                supersetExercises.sort((a, b) => {
                    // Utiliser l'ordre sauvegardé ou calculer l'ordre
                    const orderA = a.supersetOrder || 
                        superset.exercises.findIndex(e => e.name === a.name) + 1;
                    const orderB = b.supersetOrder || 
                        superset.exercises.findIndex(e => e.name === b.name) + 1;
                    return orderA - orderB;
                });
                
                // Mettre à jour l'ordre dans chaque exercice
                supersetExercises.forEach((ex, index) => {
                    ex.supersetOrder = index + 1;
                    ex.supersetName = superset.name;
                    ex.supersetColor = superset.color;
                });
                
                allExercises.push(...supersetExercises);
            }
        });
    }
    
    // Assigner les exercises organisés
    activeWorkout.exercises = allExercises;
    
    activeWorkoutStartTime = new Date();
    activeWorkoutTimer = setInterval(updateWorkoutTimer, 1000);
    updateWorkoutDisplay();
    showScreen('active-workout-screen');
}

// Fonction pour réorganiser les supersets dans une séance reprise
function reorganizeSupersetsInRedo() {
    if (!activeWorkout.supersets || Object.keys(activeWorkout.supersets).length === 0) return;
    
    const supersetExercises = [];
    const standaloneExercises = [];
    
    // Séparer les exercices en supersets et standalone
    activeWorkout.exercises.forEach(exercise => {
        if (exercise.supersetId) {
            supersetExercises.push(exercise);
        } else {
            standaloneExercises.push(exercise);
        }
    });
    
    // Regrouper les supersets par ID
    const supersetGroups = {};
    supersetExercises.forEach(exercise => {
        if (!supersetGroups[exercise.supersetId]) {
            supersetGroups[exercise.supersetId] = [];
        }
        supersetGroups[exercise.supersetId].push(exercise);
    });
    
    // Trier les exercices dans chaque superset par ordre
    Object.values(supersetGroups).forEach(group => {
        group.sort((a, b) => (a.supersetOrder || 0) - (b.supersetOrder || 0));
    });
    
    // Recréer la liste des exercices dans l'ordre correct
    const reorganizedExercises = [...standaloneExercises];
    
    // Ajouter les supersets groupés
    Object.values(supersetGroups).forEach(group => {
        reorganizedExercises.push(...group);
    });
    
    activeWorkout.exercises = reorganizedExercises;
}

function deleteWorkoutHistory(index) {
    if (confirm('Êtes-vous sûr de vouloir supprimer cette entrée de l\'historique ?')) {
        workoutHistory.splice(index, 1);
        saveToLocalStorage();
        loadWorkoutHistory();
        hideModal('history-detail-modal');
        showNotification('Entrée supprimée de l\'historique');
    }
}

function loadNutritionHistoryData(period = 'day') {
    const containerId = `nutrition-history-${period}`;
    const container = document.getElementById(containerId);
    
    if (!container) return;
    
    // Générer le HTML avec l'architecture UNIFIÉE
    container.innerHTML = generateNutritionHistoryHTML(period);
}

function generateNutritionHistoryHTML(period) {
    // Filtrer les données selon la période
    const filteredData = getNutritionDataForPeriod(period);
    
    if (filteredData.length === 0) {
        return `
            <div class="empty-state">
                <div class="empty-state-icon">🍽️</div>
                <p>Aucun historique nutritionnel pour cette période</p>
                <p style="font-size: var(--font-size-sm); margin-top: 6px;">Votre historique nutritionnel apparaîtra ici</p>
            </div>
        `;
    }
    
    let html = '';
    
    // Utiliser la MÊME structure pour toutes les périodes
    filteredData.forEach(item => {
        const calorieNeeds = userProfile.calorieNeeds || 2500;
        const calorieBalance = item.totalCalories - calorieNeeds;
        
        html += `
            <div class="nutrition-history-item">
                <div class="nutrition-history-header">
                    <div class="nutrition-history-title">${formatDateForPeriod(item.date, period)}</div>
                    <div class="nutrition-history-date">${item.mealCount} repas</div>
                </div>
                
                <div class="nutrition-history-totals">
                    <div class="nutrition-history-total">
                        <div class="nutrition-history-total-value">${Math.round(item.totalCalories)}</div>
                        <div class="nutrition-history-total-label">Calories</div>
                        <div class="history-calories-balance ${calorieBalance <= 0 ? 'positive' : 'negative'}">
                            ${calorieBalance >= 0 ? '+' : ''}${Math.round(calorieBalance)} kcal
                        </div>
                    </div>
                    <div class="nutrition-history-total">
                        <div class="nutrition-history-total-value protein">${Math.round(item.totalProtein)}g</div>
                        <div class="nutrition-history-total-label">Protéines</div>
                    </div>
                    <div class="nutrition-history-total">
                        <div class="nutrition-history-total-value carbs">${Math.round(item.totalCarbs)}g</div>
                        <div class="nutrition-history-total-label">Glucides</div>
                    </div>
                    <div class="nutrition-history-total">
                        <div class="nutrition-history-total-value fat">${Math.round(item.totalFat)}g</div>
                        <div class="nutrition-history-total-label">Lipides</div>
                    </div>
                </div>
                
                <div style="margin-top: 16px;">
                    ${item.meals.map(meal => {
                        const mealDate = new Date(meal.date);
                        return `
                        <div class="food-item-improved" style="margin-bottom: 10px; cursor: pointer;" onclick="showMealDetail('${meal.id}')">
                            <div class="food-item-improved-header">
                                <div class="food-item-improved-name">${meal.name}</div>
                                <div class="meal-type-badge">${getMealTypeLabel(meal.type)}</div>
                            </div>
                            <div class="food-item-improved-details">
                                <span>${meal.foods.length} aliments</span>
                                <span>${mealDate.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})}</span>
                            </div>
                            ${meal.notes ? `
                                <div style="font-size: var(--font-size-sm); color: var(--text-secondary); margin-top: 8px; font-style: italic;">
                                    "${meal.notes}"
                                </div>
                            ` : ''}
                        </div>
                    `}).join('')}
                </div>
            </div>
        `;
    });
    
    return html;
}

function getNutritionDataForPeriod(period) {
    const now = new Date();
    let filteredMeals = [...nutritionHistory];
    
    // Filtrer par période
    if (period === 'day') {
        const today = now.toISOString().split('T')[0];
        filteredMeals = nutritionHistory.filter(meal => {
            const mealDate = new Date(meal.date).toISOString().split('T')[0];
            return mealDate === today;
        });
    } else if (period === 'week') {
        const oneWeekAgo = new Date(now);
        oneWeekAgo.setDate(now.getDate() - 7);
        filteredMeals = nutritionHistory.filter(meal => {
            const mealDate = new Date(meal.date);
            return mealDate >= oneWeekAgo;
        });
    } else if (period === 'month') {
        const oneMonthAgo = new Date(now);
        oneMonthAgo.setMonth(now.getMonth() - 1);
        filteredMeals = nutritionHistory.filter(meal => {
            const mealDate = new Date(meal.date);
            return mealDate >= oneMonthAgo;
        });
    }
    
    // Grouper par date selon la période
    const groupedData = {};
    
    filteredMeals.forEach(meal => {
        const mealDate = new Date(meal.date);
        let dateKey;
        
        if (period === 'day') {
            dateKey = mealDate.toLocaleDateString('fr-FR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        } else if (period === 'week') {
            // Grouper par semaine (lundi-dimanche)
            const weekStart = new Date(mealDate);
            weekStart.setDate(mealDate.getDate() - mealDate.getDay() + 1); // Lundi
            dateKey = `Semaine du ${weekStart.toLocaleDateString('fr-FR', {day: '2-digit', month: '2-digit'})}`;
        } else if (period === 'month') {
            // Grouper par mois
            dateKey = mealDate.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
        }
        
        if (!groupedData[dateKey]) {
            groupedData[dateKey] = {
                date: dateKey,
                meals: [],
                totalCalories: 0,
                totalProtein: 0,
                totalCarbs: 0,
                totalFat: 0,
                mealCount: 0
            };
        }
        
        // Calculer les macros de ce repas
        let mealCalories = 0;
        let mealProtein = 0;
        let mealCarbs = 0;
        let mealFat = 0;
        
        meal.foods.forEach(foodItem => {
            const food = getAllFoods().find(f => f.id === foodItem.foodId);
            if (food) {
                const ratio = foodItem.quantity / food.quantity;
                mealCalories += food.calories * ratio;
                mealProtein += food.protein * ratio;
                mealCarbs += food.carbs * ratio;
                mealFat += food.fat * ratio;
            }
        });
        
        groupedData[dateKey].meals.push({
            ...meal,
            calculatedCalories: Math.round(mealCalories),
            calculatedProtein: Math.round(mealProtein),
            calculatedCarbs: Math.round(mealCarbs),
            calculatedFat: Math.round(mealFat)
        });
        
        groupedData[dateKey].totalCalories += mealCalories;
        groupedData[dateKey].totalProtein += mealProtein;
        groupedData[dateKey].totalCarbs += mealCarbs;
        groupedData[dateKey].totalFat += mealFat;
        groupedData[dateKey].mealCount++;
    });
    
    // Convertir en tableau et trier
    return Object.values(groupedData).sort((a, b) => {
        // Pour le tri : journée -> plus récent en premier
        // Pour semaine/mois : essayer de parser la date
        return new Date(b.date) - new Date(a.date);
    });
}

function formatDateForPeriod(dateStr, period) {
    if (period === 'day' || period === 'week') {
        return dateStr;
    } else if (period === 'month') {
        // Capitaliser la première lettre du mois
        return dateStr.charAt(0).toUpperCase() + dateStr.slice(1);
    }
    return dateStr;
}

function showMealDetail(mealId) {
    // Chercher d'abord dans daily, puis dans history
    let meal = dailyNutrition.meals.find(m => m.id === mealId);
    if (!meal) {
        meal = nutritionHistory.find(m => m.id === mealId);
    }
    
    if (!meal) {
        showNotification('Repas non trouvé', 'error');
        return;
    }
    
    const date = new Date(meal.date);
    const formattedDate = date.toLocaleDateString('fr-FR', {
        weekday: 'long',
        day: '2-digit',
        month: 'long',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
    
    // Calculer les totaux du repas
    let mealCalories = 0, mealProtein = 0, mealCarbs = 0, mealFat = 0;
    
    meal.foods.forEach(foodItem => {
        const food = getAllFoods().find(f => f.id === foodItem.foodId);
        if (food) {
            const ratio = foodItem.quantity / food.quantity;
            mealCalories += food.calories * ratio;
            mealProtein += food.protein * ratio;
            mealCarbs += food.carbs * ratio;
            mealFat += food.fat * ratio;
        }
    });
    
    let contentHTML = `
        <div class="history-detail-content">
            <div class="history-detail-header">
                <div>
                    <h4 style="margin: 0 0 5px 0; color: var(--text-primary);">${meal.name}</h4>
                    <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">${formattedDate}</div>
                    <div style="font-size: var(--font-size-sm); color: var(--text-secondary); margin-top: 3px;">
                        ${getMealTypeLabel(meal.type)}
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">Total</div>
                    <div style="font-weight: 700; color: var(--primary); font-size: var(--font-size-lg);">
                        ${Math.round(mealCalories)} kcal
                    </div>
                </div>
            </div>
            
            <div style="margin: 20px 0;">
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px;">
                    <div style="text-align: center; padding: 10px; background: var(--card-bg); border-radius: var(--radius-sm); border: 1px solid var(--border);">
                        <div style="font-size: var(--font-size-lg); font-weight: 900; color: #EF4444;">${Math.round(mealProtein)}g</div>
                        <div style="font-size: var(--font-size-xs); color: var(--text-secondary);">PROTÉINES</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: var(--card-bg); border-radius: var(--radius-sm); border: 1px solid var(--border);">
                        <div style="font-size: var(--font-size-lg); font-weight: 900; color: #10B981;">${Math.round(mealCarbs)}g</div>
                        <div style="font-size: var(--font-size-xs); color: var(--text-secondary);">GLUCIDES</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: var(--card-bg); border-radius: var(--radius-sm); border: 1px solid var(--border);">
                        <div style="font-size: var(--font-size-lg); font-weight: 900; color: #F59E0B;">${Math.round(mealFat)}g</div>
                        <div style="font-size: var(--font-size-xs); color: var(--text-secondary);">LIPIDES</div>
                    </div>
                </div>
                
                <h4 style="margin: 0 0 15px 0; color: var(--text-primary);">Aliments (${meal.foods.length})</h4>
                
                <!-- ✅ LISTE DES ALIMENTS - STRUCTURE PLATE (SIBLINGS) -->
                <div class="foods-list-container" style="display: flex; flex-direction: column; gap: 12px;">
    `;
    
    meal.foods.forEach(foodItem => {
        const food = getAllFoods().find(f => f.id === foodItem.foodId);
        if (food) {
            const ratio = foodItem.quantity / food.quantity;
            const foodCalories = Math.round(food.calories * ratio);
            const foodProtein = Math.round(food.protein * ratio);
            const foodCarbs = Math.round(food.carbs * ratio);
            const foodFat = Math.round(food.fat * ratio);
            
            contentHTML += `
                <div class="food-detail-card" style="padding: 12px; background: var(--card-bg); border-radius: var(--radius-sm); border: 1px solid var(--border);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div style="font-weight: 700; color: var(--text-primary);">${food.name}</div>
                        <div style="font-size: var(--font-size-sm); color: var(--primary); font-weight: 600;">${foodItem.quantity}g</div>
                    </div>
                    <div style="display: flex; gap: 16px; font-size: var(--font-size-xs);">
                        <div style="color: #EF4444;">P: ${foodProtein}g</div>
                        <div style="color: #10B981;">C: ${foodCarbs}g</div>
                        <div style="color: #F59E0B;">L: ${foodFat}g</div>
                        <div style="color: var(--primary); font-weight: 600;">${foodCalories} kcal</div>
                    </div>
                </div>
            `;
        }
    });
    
    contentHTML += `</div>`; // Fermeture de foods-list-container
    
    if (meal.notes) {
        contentHTML += `
            <div style="margin-top: 20px; padding: 15px; background: var(--card-bg); border-radius: var(--radius-sm); border: 1px solid var(--border); border-left: 3px solid var(--primary);">
                <div style="font-weight: 700; color: var(--text-primary); margin-bottom: 8px;">
                    <i class="fas fa-pencil-alt"></i> Notes
                </div>
                <div style="color: var(--text-secondary); font-size: var(--font-size-sm); white-space: pre-wrap;">${meal.notes}</div>
            </div>
        `;
    }
    
    contentHTML += `
            </div>
            
            <div class="history-detail-actions">
                <button class="btn btn-danger" onclick="deleteMealHistory('${meal.id}')" style="flex: 1;">
                    <i class="fas fa-trash"></i> Supprimer
                </button>
            </div>
        </div>
    `;
    
    document.getElementById('meal-detail-title').textContent = 'Détail du repas';
    document.getElementById('meal-detail-content').innerHTML = contentHTML;
    showModal('meal-detail-modal');
}

function deleteMealHistory(mealId) {
    if (confirm('Êtes-vous sûr de vouloir supprimer ce repas de l\'historique ?')) {
        // Utiliser la même fonction pour garantir la cohérence
        const deleted = deleteMealFromAllSources(mealId);
        
        if (deleted) {
            // Fermer le modal de détail
            hideModal('meal-detail-modal');
            
            // Actualiser l'affichage de l'historique
            refreshNutritionHistoryDisplay();
            
            // Si on était sur la page Nutrition, mettre à jour aussi
            if (currentScreen === 'nutrition-screen') {
                updateDailyNutritionDisplay();
            }
            
            showNotification('Repas supprimé de l\'historique');
        }
    }
}

function refreshNutritionHistoryDisplay() {
    console.log('Rafraîchissement de l\'historique nutritionnel...');
    
    // Recharger les données pour toutes les périodes
    loadNutritionHistoryData('day');
    loadNutritionHistoryData('week');
    loadNutritionHistoryData('month');
    
    // Vérifier quelle période est active et la réafficher
    const activePeriods = document.querySelectorAll('.nutrition-period.active');
    if (activePeriods.length > 0) {
        const activePeriod = activePeriods[0];
        const periodId = activePeriod.id;
        const period = periodId.replace('nutrition-history-', '');
        
        // Forcer le rechargement de la période active
        loadNutritionHistoryData(period);
    }
    
    // Animation de rafraîchissement visuel
    const historyContainer = document.querySelector('#nutrition-history-tab');
    if (historyContainer) {
        historyContainer.style.opacity = '0.8';
        historyContainer.style.transition = 'opacity 0.3s ease';
        setTimeout(() => {
            historyContainer.style.opacity = '1';
        }, 300);
    }
}

function showNutritionHistoryView(period, eventElement = null) {
    console.log('Chargement période:', period, 'élément:', eventElement);
    
    // 1. Gérer les boutons actifs
    document.querySelectorAll('.history-nav-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // 2. Activer le bouton cliqué
    if (eventElement) {
        eventElement.classList.add('active');
    } else {
        // Fallback : trouver le bouton correspondant
        const periodBtn = document.querySelector(`.history-nav-btn[onclick*="${period}"]`);
        if (periodBtn) {
            periodBtn.classList.add('active');
        }
    }
    
    // 3. Cacher toutes les périodes
    document.querySelectorAll('.nutrition-period').forEach(el => {
        el.classList.remove('active');
        el.classList.add('hidden');
    });
    
    // 4. Afficher la période sélectionnée
    const periodElement = document.getElementById(`nutrition-history-${period}`);
    if (periodElement) {
        periodElement.classList.remove('hidden');
        periodElement.classList.add('active');
    } else {
        console.error('Élément non trouvé:', `nutrition-history-${period}`);
    }
    
    // 5. Charger les données pour cette période
    loadNutritionHistoryData(period);
}


function getMonthNumber(monthName) {
    const months = {
        'janvier': 0, 'février': 1, 'mars': 2, 'avril': 3,
        'mai': 4, 'juin': 5, 'juillet': 6, 'août': 7,
        'septembre': 8, 'octobre': 9, 'novembre': 10, 'décembre': 11
    };
    return months[monthName.toLowerCase()] || 0;
}

function showClearNutritionHistoryModal() {
    showModal('clear-nutrition-history-modal');
}

function clearAllNutritionHistory() {
    if (confirm('Êtes-vous vraiment sûr de vouloir supprimer TOUT l\'historique nutritionnel ? Cette action est irréversible.')) {
        nutritionHistory = [];
        saveToLocalStorage();
        // loadNutritionHistory(); // ← SUPPRIMÉ
        hideModal('clear-nutrition-history-modal');
        showNotification('Historique nutritionnel entièrement supprimé');
    }
}

// ==================== RECHERCHE AVANCÉE ====================
function showAdvancedSearchModal() {
    // Remplir les options des groupes musculaires
    const muscleOptions = document.getElementById('advanced-muscle-options');
    muscleOptions.innerHTML = '<div class="filter-selection-option selected" data-value="all">Tous</div>';
    muscleGroups.forEach(muscle => {
        const option = document.createElement('div');
        option.className = 'filter-selection-option';
        option.dataset.value = muscle.id;
        option.textContent = muscle.name;
        muscleOptions.appendChild(option);
    });
    
    // Remplir les options d'équipement
    const equipmentOptions = document.getElementById('advanced-equipment-options');
    const allEquipment = new Set();
    getAllExercises().forEach(ex => {
        if (ex.equipment) {
            ex.equipment.forEach(eq => allEquipment.add(eq));
        }
    });
    
    equipmentOptions.innerHTML = '<div class="filter-selection-option selected" data-value="all">Tous</div>';
    allEquipment.forEach(equipment => {
        const option = document.createElement('div');
        option.className = 'filter-selection-option';
        option.dataset.value = equipment;
        option.textContent = equipment;
        equipmentOptions.appendChild(option);
    });
    
    // Réinitialiser les sélections
    document.querySelectorAll('#advanced-search-modal .filter-selection-option').forEach(option => {
        option.classList.remove('selected');
    });

// MODIFICATION: S'assurer qu'on peut cliquer sur les options
document.querySelectorAll('#advanced-search-modal .filter-selection-option').forEach(option => {
    option.onclick = function() {
        // Désélectionner tous les autres dans le même groupe
        const parent = this.parentElement;
        parent.querySelectorAll('.filter-selection-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        // Sélectionner celui-ci
        this.classList.add('selected');
    };
});

    document.querySelectorAll('#advanced-search-modal .filter-selection-option[data-value="all"]').forEach(option => {
        option.classList.add('selected');
    });
    
    // Pré-sélectionner les filtres actifs
    Object.entries(advancedExerciseFilters).forEach(([key, value]) => {
        if (key === 'favorites') {
            const option = document.querySelector('#advanced-search-modal .filter-selection-option[data-value="favoris"]');
            if (option) option.classList.add('selected');
        } else if (key === 'muscleGroup' || key === 'category' || key === 'difficulty' || key === 'equipment') {
            const option = document.querySelector(`#advanced-search-modal .filter-selection-option[data-value="${value}"]`);
            if (option) {
                option.classList.add('selected');
                // Désélectionner "Tous" dans ce groupe
                const allOption = option.parentElement.querySelector('.filter-selection-option[data-value="all"]');
                if (allOption) allOption.classList.remove('selected');
            }
        }
    });
    
    showModal('advanced-search-modal');
}

function applyAdvancedFilters() {
    // Collecter les filtres sélectionnés
    const filters = {};
    
    // Groupe musculaire
    const selectedMuscle = document.querySelector('#advanced-muscle-options .filter-selection-option.selected');
    if (selectedMuscle && selectedMuscle.dataset.value !== 'all') {
        filters.muscleGroup = selectedMuscle.dataset.value;
    }
    
    // Catégorie
    const selectedCategory = document.querySelector('#advanced-category-options .filter-selection-option.selected');
    if (selectedCategory && selectedCategory.dataset.value !== 'all') {
        filters.category = selectedCategory.dataset.value;
    }
    
    // Difficulté
    const selectedDifficulty = document.querySelector('#advanced-difficulty-options .filter-selection-option.selected');
    if (selectedDifficulty && selectedDifficulty.dataset.value !== 'all') {
        filters.difficulty = selectedDifficulty.dataset.value;
    }
    
    // Équipement
    const selectedEquipment = document.querySelector('#advanced-equipment-options .filter-selection-option.selected');
    if (selectedEquipment && selectedEquipment.dataset.value !== 'all') {
        filters.equipment = selectedEquipment.dataset.value;
    }
    
    // Filtres spéciaux
    const selectedSpecial = document.querySelector('#advanced-search-modal .filter-selection-option[data-value="personnalisé"].selected');
    if (selectedSpecial) {
        filters.custom = true;
    }
    
    const selectedFavorites = document.querySelector('#advanced-search-modal .filter-selection-option[data-value="favoris"].selected');
    if (selectedFavorites) {
        filters.favorites = true;
    }
    
    advancedExerciseFilters = filters;
    hideModal('advanced-search-modal');
    loadExercises();
    updateAdvancedSearchDisplay();
    showNotification('Filtres appliqués');
}

function applyAdvancedExerciseFilters(exercises) {
    if (Object.keys(advancedExerciseFilters).length === 0) {
        return exercises;
    }
    
    return exercises.filter(exercise => {
        // Filtre par groupe musculaire
        if (advancedExerciseFilters.muscleGroup && exercise.muscleGroup !== advancedExerciseFilters.muscleGroup) {
            return false;
        }
        
        // Filtre par catégorie
        if (advancedExerciseFilters.category && exercise.category !== advancedExerciseFilters.category) {
            return false;
        }
        
        // Filtre par difficulté
        if (advancedExerciseFilters.difficulty && exercise.difficulty !== advancedExerciseFilters.difficulty) {
            return false;
        }
        
        // Filtre par équipement
        if (advancedExerciseFilters.equipment && (!exercise.equipment || !exercise.equipment.includes(advancedExerciseFilters.equipment))) {
            return false;
        }
        
        // Filtre par favoris
        if (advancedExerciseFilters.favorites && !exercise.favorite) {
            return false;
        }
        
        return true;
    });
}

function resetAdvancedFilters() {
    advancedExerciseFilters = {};
    document.querySelectorAll('#advanced-search-modal .filter-selection-option').forEach(option => {
        option.classList.remove('selected');
    });
    document.querySelectorAll('#advanced-search-modal .filter-selection-option[data-value="all"]').forEach(option => {
        option.classList.add('selected');
    });
    
    hideModal('advanced-search-modal');
    loadExercises();
    updateAdvancedSearchDisplay();
    showNotification('Filtres réinitialisés');
}

function updateAdvancedSearchDisplay() {
    const displayContainer = document.getElementById('advanced-search-display-exercises');
    const filtersContainer = document.getElementById('advanced-search-active-filters');
    
    if (Object.keys(advancedExerciseFilters).length === 0) {
        displayContainer.style.display = 'none';
        return;
    }
    
    displayContainer.style.display = 'block';
    filtersContainer.innerHTML = '';
    
    if (advancedExerciseFilters.muscleGroup) {
        const muscle = muscleGroups.find(m => m.id === advancedExerciseFilters.muscleGroup);
        addFilterBadge(filtersContainer, muscle ? muscle.name : advancedExerciseFilters.muscleGroup, 'muscleGroup');
    }
    
    if (advancedExerciseFilters.category) {
        addFilterBadge(filtersContainer, advancedExerciseFilters.category, 'category');
    }
    
    if (advancedExerciseFilters.difficulty) {
        addFilterBadge(filtersContainer, advancedExerciseFilters.difficulty, 'difficulty');
    }
    
    if (advancedExerciseFilters.equipment) {
        addFilterBadge(filtersContainer, advancedExerciseFilters.equipment, 'equipment');
    }
    
    if (advancedExerciseFilters.favorites) {
        addFilterBadge(filtersContainer, 'Favoris uniquement', 'favorites');
    }
}

function addFilterBadge(container, label, type) {
    const badge = document.createElement('div');
    badge.className = 'selected-filter';
    badge.innerHTML = `
        ${label}
        <button class="selected-filter-remove" onclick="removeAdvancedFilter('${type}')">×</button>
    `;
    container.appendChild(badge);
}

function removeAdvancedFilter(type) {
    if (advancedExerciseFilters[type]) {
        delete advancedExerciseFilters[type];
        loadExercises();
        updateAdvancedSearchDisplay();
        showNotification('Filtre supprimé');
    }
}

function clearSearchFilters() {
    advancedExerciseFilters = {};
    loadExercises();
    updateAdvancedSearchDisplay();
    showNotification('Tous les filtres ont été effacés');
}

// RECHERCHE AVANCÉE ALIMENTS
function showAdvancedSearchModalFood() {
    // Remplir les options des catégories
    const categoryOptions = document.getElementById('advanced-food-category-options');
    const categories = [...new Set(getAllFoods().map(f => f.category))];
    
    categoryOptions.innerHTML = '<div class="filter-selection-option selected" data-value="all">Toutes</div>';
    categories.forEach(category => {
        const option = document.createElement('div');
        option.className = 'filter-selection-option';
        option.dataset.value = category;
        option.textContent = category.charAt(0).toUpperCase() + category.slice(1);
        categoryOptions.appendChild(option);
    });
    
    // Réinitialiser les sélections
    document.querySelectorAll('#advanced-search-modal-food .filter-selection-option').forEach(option => {
        option.classList.remove('selected');
    });

    // CORRECTION : Ajouter les gestionnaires d'événements AU BON MODAL
    document.querySelectorAll('#advanced-search-modal-food .filter-selection-option').forEach(option => {
        option.onclick = function() {
            // Désélectionner tous les autres dans le même groupe
            const parent = this.parentElement;
            parent.querySelectorAll('.filter-selection-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            // Sélectionner celui-ci
            this.classList.add('selected');
        };
    });
    
    document.querySelectorAll('#advanced-search-modal-food .filter-selection-option[data-value="all"]').forEach(option => {
        option.classList.add('selected');
    });
    
    // Réinitialiser les champs de saisie
    document.getElementById('advanced-calories-filter').value = '';
    document.getElementById('advanced-protein-filter').value = '';
    document.getElementById('advanced-food-name-filter').value = '';
    
    // Pré-sélectionner les filtres actifs
    Object.entries(advancedFoodFilters).forEach(([key, value]) => {
        if (key === 'custom' || key === 'halal' || key === 'favorite') {
            const option = document.querySelector(`#advanced-search-modal-food .filter-selection-option[data-value="${key === 'favorite' ? 'favoris' : key}"]`);
            if (option) {
                option.classList.add('selected');
                // Désélectionner "Tous" dans ce groupe
                const allOption = option.parentElement.querySelector('.filter-selection-option[data-value="all"]');
                if (allOption) allOption.classList.remove('selected');
            }
        } else if (key === 'category') {
            const option = document.querySelector(`#advanced-food-category-options .filter-selection-option[data-value="${value}"]`);
            if (option) {
                option.classList.add('selected');
                // Désélectionner "Tous" dans ce groupe
                const allOption = option.parentElement.querySelector('.filter-selection-option[data-value="all"]');
                if (allOption) allOption.classList.remove('selected');
            }
        } else if (key === 'maxCalories') {
            document.getElementById('advanced-calories-filter').value = value;
        } else if (key === 'minProtein') {
            document.getElementById('advanced-protein-filter').value = value;
        } else if (key === 'name') {
            document.getElementById('advanced-food-name-filter').value = value;
        }
    });
    
    showModal('advanced-search-modal-food');
}

function applyAdvancedFiltersFood() {
    // Collecter les filtres sélectionnés
    const filters = {};
    
    // Catégorie
    const selectedCategory = document.querySelector('#advanced-food-category-options .filter-selection-option.selected');
    if (selectedCategory && selectedCategory.dataset.value !== 'all') {
        filters.category = selectedCategory.dataset.value;
    }
    
    // Filtres spéciaux - Gestion multiple
    document.querySelectorAll('#advanced-search-modal-food .filter-selection-option.selected').forEach(option => {
        const value = option.dataset.value;
        if (value === 'personnalisé') {
            filters.custom = true;
        } else if (value === 'halal') {
            filters.halal = true;
        } else if (value === 'favoris') {
            filters.favorite = true;
        }
    });
    
    // Calories max
    const caloriesFilter = document.getElementById('advanced-calories-filter').value;
    if (caloriesFilter) {
        filters.maxCalories = parseInt(caloriesFilter);
    }
    
    // Protéines min
    const proteinFilter = document.getElementById('advanced-protein-filter').value;
    if (proteinFilter) {
        filters.minProtein = parseInt(proteinFilter);
    }
    
    // Recherche par nom
    const nameFilter = document.getElementById('advanced-food-name-filter').value;
    if (nameFilter) {
        filters.name = nameFilter;
    }
    
    advancedFoodFilters = filters;
    hideModal('advanced-search-modal-food');
    loadFoods();
    updateAdvancedSearchDisplayFood();
    showNotification('Filtres appliqués');
}

function applyAdvancedFoodFilters(foods) {
    if (Object.keys(advancedFoodFilters).length === 0) {
        return foods;
    }
    
    return foods.filter(food => {
        // Filtre par catégorie
        if (advancedFoodFilters.category && food.category !== advancedFoodFilters.category) {
            return false;
        }
        
        // Filtre par personnalisé
        if (advancedFoodFilters.custom && !food.custom) {
            return false;
        }
        
        // Filtre par halal
        if (advancedFoodFilters.halal && !food.halal) {
            return false;
        }
        
        // Filtre par favoris
        if (advancedFoodFilters.favorite && !food.favorite) {
            return false;
        }
        
        // Filtre par calories max
        if (advancedFoodFilters.maxCalories && food.calories > advancedFoodFilters.maxCalories) {
            return false;
        }
        
        // Filtre par protéines min
        if (advancedFoodFilters.minProtein && food.protein < advancedFoodFilters.minProtein) {
            return false;
        }
        
        // Filtre par nom
        if (advancedFoodFilters.name && !food.name.toLowerCase().includes(advancedFoodFilters.name.toLowerCase())) {
            return false;
        }
        
        return true;
    });
}

function resetAdvancedFiltersFood() {
    advancedFoodFilters = {};
    document.querySelectorAll('#advanced-search-modal-food .filter-selection-option').forEach(option => {
        option.classList.remove('selected');
    });
    document.querySelectorAll('#advanced-search-modal-food .filter-selection-option[data-value="all"]').forEach(option => {
        option.classList.add('selected');
    });
    
    document.getElementById('advanced-calories-filter').value = '';
    document.getElementById('advanced-protein-filter').value = '';
    document.getElementById('advanced-food-name-filter').value = '';
    
    hideModal('advanced-search-modal-food');
    loadFoods();
    updateAdvancedSearchDisplayFood();
    showNotification('Filtres réinitialisés');
}

function updateAdvancedSearchDisplayFood() {
    const displayContainer = document.getElementById('advanced-search-display-foods');
    const filtersContainer = document.getElementById('advanced-search-active-filters-food');
    
    if (Object.keys(advancedFoodFilters).length === 0) {
        displayContainer.style.display = 'none';
        return;
    }
    
    displayContainer.style.display = 'block';
    filtersContainer.innerHTML = '';
    
    if (advancedFoodFilters.category) {
        addFoodFilterBadge(filtersContainer, advancedFoodFilters.category, 'category');
    }
    
    if (advancedFoodFilters.custom) {
        addFoodFilterBadge(filtersContainer, 'Personnalisé', 'custom');
    }
    
    if (advancedFoodFilters.halal) {
        addFoodFilterBadge(filtersContainer, 'Halal', 'halal');
    }
    
    if (advancedFoodFilters.favorite) {
        addFoodFilterBadge(filtersContainer, 'Favoris', 'favorite');
    }
    
    if (advancedFoodFilters.maxCalories) {
        addFoodFilterBadge(filtersContainer, `Max ${advancedFoodFilters.maxCalories} kcal`, 'maxCalories');
    }
    
    if (advancedFoodFilters.minProtein) {
        addFoodFilterBadge(filtersContainer, `Min ${advancedFoodFilters.minProtein}g protéines`, 'minProtein');
    }
    
    if (advancedFoodFilters.name) {
        addFoodFilterBadge(filtersContainer, `Nom: ${advancedFoodFilters.name}`, 'name');
    }
}

function addFoodFilterBadge(container, label, type) {
    const badge = document.createElement('div');
    badge.className = 'selected-filter';
    badge.innerHTML = `
        ${label}
        <button class="selected-filter-remove" onclick="removeAdvancedFilterFood('${type}')">×</button>
    `;
    container.appendChild(badge);
}

function removeAdvancedFilterFood(type) {
    if (advancedFoodFilters[type]) {
        delete advancedFoodFilters[type];
        loadFoods();
        updateAdvancedSearchDisplayFood();
        showNotification('Filtre supprimé');
    }
}

function clearSearchFiltersFood() {
    advancedFoodFilters = {};
    loadFoods();
    updateAdvancedSearchDisplayFood();
    showNotification('Tous les filtres ont été effacés');
}

// ==================== IMPORT/EXPORT ====================
function exportData() {
    const data = {
        userProfile: userProfile,
        customExercises: customExercises,
        customFoods: customFoods,
        customWorkouts: customWorkouts,
        workoutHistory: workoutHistory,
        nutritionHistory: nutritionHistory,
        dailyNutrition: dailyNutrition,
        exportDate: new Date().toISOString(),
        version: '1.0'
    };
    
    const dataStr = JSON.stringify(data, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    
    const exportFileDefaultName = `fitfuel-backup-${new Date().toISOString().slice(0, 10)}.json`;
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
    
    showNotification('Données exportées avec succès !');
}

function importData() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                
                if (!confirm(`Voulez-vous importer ${data.customExercises?.length || 0} exercices, ${data.customFoods?.length || 0} aliments, ${data.customWorkouts?.length || 0} séances, ${data.workoutHistory?.length || 0} séances d'historique et ${data.nutritionHistory?.length || 0} repas d'historique ? Les données existantes seront remplacées.`)) {
                    return;
                }
                
                // Importer les données
                if (data.userProfile) userProfile = data.userProfile;
                if (data.customExercises) customExercises = data.customExercises;
                if (data.customFoods) customFoods = data.customFoods;
                if (data.customWorkouts) customWorkouts = data.customWorkouts;
                if (data.workoutHistory) workoutHistory = data.workoutHistory;
                if (data.nutritionHistory) nutritionHistory = data.nutritionHistory;
                if (data.dailyNutrition) dailyNutrition = data.dailyNutrition;
                
                saveToLocalStorage();
                
                // Recharger l'interface
                initApp();
                showNotification('Données importées avec succès !');
                
            } catch (error) {
                showNotification('Erreur lors de l\'importation du fichier', 'error');
                console.error('Erreur d\'importation:', error);
            }
        };
        reader.readAsText(file);
    };
    
    input.click();
}

// ==================== PROGRAMMES RECOMMANDÉS ====================
function updateRecommendedPrograms() {
    const container = document.getElementById('recommended-programs');
    if (!container) return;
    
    container.innerHTML = '';
    
    const basePrograms = [
        { 
            id: 'fullbody_beginner',
            name: 'Débutant Complet', 
            description: '3 séances/semaine pour commencer', 
            duration: '4 semaines', 
            type: 'fullbody',
            icon: '',
            color: '#1761FD'
        },
        { 
            id: 'push_day',
            name: 'Push Day', 
            description: 'Pectoraux, Épaules, Triceps', 
            duration: '12 semaines', 
            type: 'push',
            icon: '',
            color: '#1761FD'
        },
        { 
            id: 'pull_day',
            name: 'Pull Day', 
            description: 'Dos, Biceps, Arrière épaules', 
            duration: '8 semaines', 
            type: 'pull',
            icon: '',
            color: '#1761FD'
        },
        { 
            id: 'legs_day',
            name: 'Legs Day', 
            description: 'Jambes complètes', 
            duration: '12 semaines', 
            type: 'legs',
            icon: '',
            color: '#1761FD'
        }
    ];
    
    basePrograms.forEach(program => {
        const programElement = document.createElement('div');
        programElement.className = 'program-card';
        programElement.style.cursor = 'pointer';
        programElement.onclick = () => startPredefinedWorkoutFromHome(program.id);
        
        programElement.innerHTML = `
            <h4>${program.name}</h4>
            <p>${program.description}</p>
            <div class="program-duration">
                <i class="far fa-clock"></i>
                ${program.duration}
            </div>
        `;
        
        container.appendChild(programElement);
    });
}

function startRecommendedProgram(program) {
    showNotification(`Programme "${program.name}" démarré !`, 'success');
    if (program.type === 'fullbody') {
        startWorkout('fullbody_beginner');
    } else {
        const workoutName = `Programme: ${program.name}`;
        const defaultExercises = ['squat', 'bench_press', 'pull_up', 'shoulder_press'];
        startWorkoutWithExercises(workoutName, defaultExercises);
    }
}

function showProgramDetail(program) {
    showNotification(`Programme "${program.name}" - Fonctionnalité en développement`, 'info');
}

// ==================== PARAMÈTRES ====================
function showSettingsModal() {
    // FERMER le modal des notes s'il est ouvert
    hideModal('exercise-notes-modal');
    
    // Charger les paramètres actuels
    document.getElementById('sounds-toggle').checked = settings.sounds;
    document.getElementById('vibrations-toggle').checked = settings.vibrations;
    document.getElementById('keep-screen-on-toggle').checked = settings.keepScreenOn;
    document.getElementById('auto-timer-toggle').checked = settings.autoTimer;
    document.getElementById('dark-mode-toggle').checked = settings.darkMode;
    
    // S'assurer d'utiliser showModal pour une gestion correcte du z-index
    showModal('settings-modal');
    
    // Notification pour debug
    console.log('Settings modal ouvert');
}

function toggleSounds(checked) {
    settings.sounds = checked;
    saveToLocalStorage();
    showNotification(checked ? 'Sons activés' : 'Sons désactivés');
}

function toggleVibrations(checked) {
    settings.vibrations = checked;
    saveToLocalStorage();
    showNotification(checked ? 'Vibrations activées' : 'Vibrations désactivées');
}

// Puis ajoutez la fonction de test :
function testAudioVibration() {
    if (settings.sounds) {
        playSound('timer_end');
        showNotification('Test audio : vous devriez entendre un bip');
    }
    
    if (settings.vibrations) {
        vibrate([200, 100, 200]);
        showNotification('Test vibration : votre téléphone devrait vibrer');
    }
    
    if (!settings.sounds && !settings.vibrations) {
        showNotification('Activez les sons ou vibrations d\'abord', 'warning');
    }
}

function toggleKeepScreenOn(checked) {
    settings.keepScreenOn = checked;
    saveToLocalStorage();
    
    if (checked && activeWorkout) {
        showNotification('Fonctionnalité expérimentale activée');
    } else if (checked) {
        showNotification('Écran toujours actif activé');
    }
}

function toggleAutoTimer(checked) {
    settings.autoTimer = checked;
    saveToLocalStorage();
    showNotification(checked ? 'Timer automatique activé' : 'Timer automatique désactivé');
}

function toggleCompactMode(checked) {
    settings.compactMode = checked;
    saveToLocalStorage();
    
    // Ne mettre à jour que les exercices qui utilisent le paramètre global
    if (activeWorkout) {
        activeWorkout.exercises.forEach((exercise, index) => {
            if (exercise.compactModeOverride === undefined) {
                // Cet exercice utilise le paramètre global, on peut le mettre à jour
                // L'affichage sera mis à jour lors du prochain updateWorkoutDisplay()
            }
        });
        updateWorkoutDisplay();
    }
    
    showNotification(checked ? 'Mode compact activé' : 'Mode compact désactivé');
}

// ==================== GESTION DES NOTES D'EXERCICE ====================

function showExerciseNotesModal(exerciseIndex) {
    console.log('showExerciseNotesModal appelé avec index:', exerciseIndex);
    
    if (!activeWorkout) {
        console.error('Aucune séance active!');
        return;
    }
    
    if (!activeWorkout.exercises[exerciseIndex]) {
        console.error('Exercice non trouvé à l\'index:', exerciseIndex);
        return;
    }
    
    const exercise = activeWorkout.exercises[exerciseIndex];
    console.log('Exercice trouvé:', exercise.name);
    
    // Vérifier si les éléments HTML existent
    const nameElement = document.getElementById('notes-exercise-name');
    const detailsElement = document.getElementById('notes-exercise-details');
    const textareaElement = document.getElementById('exercise-notes-text');
    
    if (!nameElement) console.error('Élément notes-exercise-name non trouvé!');
    if (!detailsElement) console.error('Élément notes-exercise-details non trouvé!');
    if (!textareaElement) console.error('Élément exercise-notes-text non trouvé!');
    
    // Mettre à jour les informations de l'exercice
    if (nameElement) nameElement.textContent = exercise.name;
    
    const muscle = muscleGroups.find(m => m.id === exercise.muscleGroup);
    const muscleName = muscle ? muscle.name : exercise.muscleGroup;
    
    if (detailsElement) {
        detailsElement.innerHTML = `
            <div>${muscleName} • ${exercise.difficulty}</div>
            ${exercise.supersetId ? `<div style="color: ${exercise.supersetColor || '#8B5CF6'};">Superset "${exercise.supersetName || 'Sans nom'}"</div>` : ''}
        `;
    }
    
    // Charger les notes existantes
    if (textareaElement) {
        textareaElement.value = exercise.notes || '';
        updateNotesCharCount();
    }
    
    // Vérifier si le modal existe
    const notesModal = document.getElementById('exercise-notes-modal');
    if (!notesModal) {
        console.error('Modal exercise-notes-modal non trouvé dans le DOM!');
        showNotification('Erreur: Modal des notes non trouvé', 'error');
        return;
    }
    
    // Sauvegarder l'index de l'exercice
    notesModal.dataset.exerciseIndex = exerciseIndex;
    
    console.log('Tentative d\'ouverture du modal...');
    
    // ESSAYER plusieurs méthodes pour ouvrir le modal:
    
    // Méthode 1: Utiliser showModal
    showModal('exercise-notes-modal');
    
    // Méthode 2: Forcer l'affichage (au cas où)
    setTimeout(() => {
        const modal = document.getElementById('exercise-notes-modal');
        if (modal) {
            console.log('Modal après showModal:', modal.classList);
            
            // Si toujours pas ouvert, forcer
            if (!modal.classList.contains('active')) {
                console.log('Forcer l\'ouverture du modal...');
                modal.style.display = 'flex';
                modal.style.opacity = '1';
                modal.style.visibility = 'visible';
                modal.style.zIndex = '9999';
            }
        }
    }, 100);
    
    console.log('Fonction showExerciseNotesModal terminée');
}

function autoSaveNotes() {
    const exerciseIndex = parseInt(document.getElementById('exercise-notes-modal').dataset.exerciseIndex);
    if (isNaN(exerciseIndex) || !activeWorkout || !activeWorkout.exercises[exerciseIndex]) return;
    
    const notes = document.getElementById('exercise-notes-text').value;
    activeWorkout.exercises[exerciseIndex].notes = notes;
    
    // Mettre à jour le compteur de caractères
    updateNotesCharCount();
}

function updateNotesCharCount() {
    const textarea = document.getElementById('exercise-notes-text');
    const charCount = textarea.value.length;
    document.getElementById('notes-char-count').textContent = charCount;
    
    // Changer la couleur si on approche de la limite
    if (charCount > 450) {
        document.getElementById('notes-char-count').style.color = '#EF4444';
    } else if (charCount > 400) {
        document.getElementById('notes-char-count').style.color = '#F59E0B';
    } else {
        document.getElementById('notes-char-count').style.color = 'var(--text-secondary)';
    }
}

function saveExerciseNotes() {
    const exerciseIndex = parseInt(document.getElementById('exercise-notes-modal').dataset.exerciseIndex);
    if (isNaN(exerciseIndex) || !activeWorkout || !activeWorkout.exercises[exerciseIndex]) return;
    
    const notes = document.getElementById('exercise-notes-text').value;
    activeWorkout.exercises[exerciseIndex].notes = notes;
    
    hideModal('exercise-notes-modal');
    showNotification('📝 Notes enregistrées pour cet exercice');
}

function clearExerciseNotes() {
    if (confirm('Voulez-vous vraiment effacer toutes les notes de cet exercice ?')) {
        const exerciseIndex = parseInt(document.getElementById('exercise-notes-modal').dataset.exerciseIndex);
        if (!isNaN(exerciseIndex) && activeWorkout && activeWorkout.exercises[exerciseIndex]) {
            activeWorkout.exercises[exerciseIndex].notes = '';
            document.getElementById('exercise-notes-text').value = '';
            updateNotesCharCount();
            showNotification('Notes effacées');
        }
    }
}

// ==================== INITIALISATION ====================
document.addEventListener('DOMContentLoaded', function() {
    initApp();
    
// Gestionnaire pour les boutons Modifier des repas (délégation d'événements)
document.addEventListener('click', function(e) {
    // Vérifier si le clic est sur un bouton Modifier de repas
    const editButton = e.target.closest('.edit-meal-btn');
    if (editButton) {
        const index = parseInt(editButton.getAttribute('data-meal-index'));
        if (!isNaN(index)) {
            console.log('Bouton Modifier cliqué, index:', index);
            editMealFromNutritionScreen(index);
        }
    }
});

    // Ajouter un gestionnaire pour empêcher le rechargement accidentel
    window.addEventListener('beforeunload', function(e) {
        if (activeWorkout) {
            e.preventDefault();
            e.returnValue = 'Vous avez une séance en cours. Voulez-vous vraiment quitter ?';
        }
    });
});

// ==================== FONCTIONS UTILITAIRES ====================
function resetFoodForm() {
    document.getElementById('food-name').value = '';
    document.getElementById('food-quantity').value = '100';
    document.getElementById('food-calories').value = '';
    document.getElementById('food-protein').value = '';
    document.getElementById('food-carbs').value = '';
    document.getElementById('food-fat').value = '';
    document.getElementById('food-category').value = 'viande';
    document.getElementById('food-halal').classList.remove('checked');
    document.getElementById('food-favorite').classList.remove('checked');
}

function resetFoodEditModal() {
    // Cette fonction peut être étendue si nécessaire
}

// ==================== LOADING INDICATOR ====================
function showLoading() {
    document.getElementById('loading-indicator').classList.add('active');
}

function hideLoading() {
    document.getElementById('loading-indicator').classList.remove('active');
}

// Initialisation automatique du thème au chargement
window.onload = function() {
    checkAndApplyTheme();
};

// Gestionnaire global pour les boutons dans les modals de repas
document.addEventListener('click', function(e) {
    const target = e.target;
    
    // Bouton "Rechercher" dans les modals de repas
    if (target.closest('.btn') && target.closest('.btn').textContent.includes('Rechercher')) {
        const modal = target.closest('.modal');
        if (modal && modal.id === 'add-meal-modal') {
            showFoodSearchModalForMeal();
            e.preventDefault();
            e.stopPropagation();
        } else if (modal && modal.id === 'edit-meal-modal') {
            showFoodSearchModalForEdit();
            e.preventDefault();
            e.stopPropagation();
        }
    }
    
    // Bouton "Nouvel aliment" dans les modals de repas
    if (target.closest('.btn') && target.closest('.btn').textContent.includes('Nouvel aliment')) {
        const modal = target.closest('.modal');
        if (modal && modal.id === 'add-meal-modal') {
            showAddFoodFromMeal('add');
            e.preventDefault();
            e.stopPropagation();
        } else if (modal && modal.id === 'edit-meal-modal') {
            showAddFoodFromMeal('edit');
            e.preventDefault();
            e.stopPropagation();
        }
    }
});

// Gestionnaire pour les boutons Modifier des repas
document.addEventListener('click', function(e) {
    const editButton = e.target.closest('.edit-meal-btn');
    if (editButton) {
        const index = parseInt(editButton.getAttribute('data-meal-index'));
        if (!isNaN(index)) {
            editMealFromNutritionScreen(index);
        }
    }
});

// ==================== GESTION DES THÈMES ====================
function showThemeSelection() {
    // NE PAS fermer le modal des paramètres
    // hideModal('settings-modal');
    
    // Mettre à jour la sélection actuelle
    document.querySelectorAll('.theme-option').forEach(option => {
        option.classList.remove('selected');
        if (option.dataset.theme === currentTheme) {
            option.classList.add('selected');
        }
    });
    
    showModal('theme-selection-modal');
}

function selectTheme(themeName) {
    currentTheme = themeName;
    
    // Appliquer le thème immédiatement
    checkAndApplyTheme();
    
    // Sauvegarder
    saveToLocalStorage();
    
    // Mettre à jour la sélection visuelle
    document.querySelectorAll('.theme-option').forEach(option => {
        option.classList.remove('selected');
        if (option.dataset.theme === themeName) {
            option.classList.add('selected');
        }
    });
    
    // Afficher une notification
    const themeNames = {
        'default': 'Par défaut',
        'blue': 'Bleu',
        'green': 'Vert',
        'purple': 'Violet',
        'red': 'Rouge',
        'sunset': 'Soleil'
    };
    
    showNotification(`Thème "${themeNames[themeName]}" appliqué !`);
    
    // Fermer le modal des thèmes et revenir aux paramètres
    setTimeout(() => {
        hideModal('theme-selection-modal');
        // Le modal des paramètres reste ouvert en arrière-plan
    }, 800);
}

// Modifier la fonction toggleDarkModeSetting pour prendre en compte les thèmes
function toggleDarkModeSetting(checked) {
    settings.darkMode = checked;
    checkAndApplyTheme();
    saveToLocalStorage();
    showNotification(settings.darkMode ? 'Mode sombre activé' : 'Mode clair activé');


// ==================== CORRECTION POUR FILTER-SELECT ====================
function updateSelectDisplay() {
    setTimeout(() => {
        const selects = document.querySelectorAll('.filter-select, select:not(.no-style)');
        selects.forEach(select => {
            // Éviter de surcharger les selects déjà stylisés
            if (select.classList.contains('no-style')) return;
            
            // Appliquer les styles selon le mode
            if (settings.darkMode) {
                select.style.color = '#ffffff';
                select.style.backgroundColor = '#1e293b';
                select.style.borderColor = '#334155';
                select.style.backgroundImage = `url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23ffffff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E")`;
            } else {
                select.style.color = '#000000';
                select.style.backgroundColor = '#ffffff';
                select.style.borderColor = '#e2e8f0';
                select.style.backgroundImage = `url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23000000' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E")`;
            }
            
            // Styles communs
            select.style.backgroundRepeat = 'no-repeat';
            select.style.backgroundPosition = 'right 12px center';
            select.style.backgroundSize = '16px';
            select.style.paddingRight = '40px';
            select.style.appearance = 'none';
            select.style.WebkitAppearance = 'none';
            select.style.MozAppearance = 'none';
            select.style.borderWidth = '1px';
            select.style.borderStyle = 'solid';
            select.style.borderRadius = '12px';
            select.style.padding = '12px 40px 12px 16px';
            select.style.fontSize = '15px';
            select.style.fontWeight = '500';
            select.style.cursor = 'pointer';
            select.style.transition = 'all 0.2s ease';
            select.style.boxShadow = settings.darkMode ? '0 2px 4px rgba(0,0,0,0.2)' : '0 2px 4px rgba(0,0,0,0.05)';
        });
    }, 50);
}

// ==================== RAFRAÎCHIR LES SELECTS APRÈS CHANGEMENT DE THÈME ====================
function refreshSelectsAfterThemeChange() {
    // Utiliser la même fonction pour éviter la duplication
    updateSelectDisplay();
}

// ==================== INITIALISATION AU CHARGEMENT ====================
// Remplacer l'ancien event listener par celui-ci
document.addEventListener('DOMContentLoaded', function() {
    // Attendre que settings soit chargé
    setTimeout(() => {
        if (typeof updateSelectDisplay === 'function') {
            updateSelectDisplay();
        }
    }, 500);
});

// ==================== FONCTION POUR FORCER LA MISE À JOUR ====================
function forceUpdateSelects() {
    // Utile après des changements dynamiques du DOM
    if (typeof updateSelectDisplay === 'function') {
        updateSelectDisplay();
    }
}
}
</script>
</body>
</html>